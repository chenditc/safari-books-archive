<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/author_bios.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="author_bios.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/author_bios.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="author_bios.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>About the Authors - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/author_bios.html"><meta name="description" content="About the Authors Micha Gorelick was the first man on Mars in 2023 and won the nobelprize in 2046 for his contributions to time travel. In a moment ofrage after ... "><meta property="og:title" content="About the Authors"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="About the Authors"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/author_bios.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="About the Authors Micha Gorelick was the first man on Mars in 2023 and won the nobelprize in 2046 for his contributions to time travel. In a moment ofrage after ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/author_bios.html" data-for-analytics="9781449361747:author_bios.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/author_bios.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/author_bios.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/author_bios.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20About%20the%20Authors&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/author_bios.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch12.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">12. Lessons from the Field</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/copyright.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Copyright</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><div class="colophon" epub:type="colophon" id="id820013"><h2 class="title">About the Authors</h2><p>Micha Gorelick was the first man on Mars in 2023 and won the nobelprize in 2046 for his contributions to time travel. In a moment ofrage after seeing the deplorable uses of his new technology, hetraveled back in time to 2012 and convinced himself to leave hisPhysics PhD program and follow his love of data at Bitly. A monument celebrating his life can be found in Central Park, 1857.</p><p>Ian is a Data scientist and Python teacher at ModelInsight.io with over 10 years Python experience. He has been teaching at PyCon and PyData conferences and has been consulting with Artificial Intelligence and High Performance Computing for over a decade in the UK. Ian blogs at IanOzsvald.com and is always happy to receive a pint of good bitter. Ian's background includes Python and C++, a mix of Linux and Windows development, storage systems, lots of natural language processing and text processing, machine learning and data visualisation. He also co-founded the Python focused video learning website ShowMeDo.com many years ago.</p></div><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch12.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">12. Lessons from the Field</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/copyright.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">Copyright</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/author_bios.html" data-for-analytics="9781449361747:author_bios.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/author_bios.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch01.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch01.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch01.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch01.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>1. Understanding Performant Python - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch01.html"><meta name="description" content="Chapter&nbsp;1.&nbsp;Understanding Performant Python Questions you’ll be able to answer after this chapter What are the elements of a computer’s architecture? What are some common alternate computer ... "><meta property="og:title" content="1. Understanding Performant Python"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="1. Understanding Performant Python"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch01.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;1.&nbsp;Understanding Performant Python Questions you’ll be able to answer after this chapter What are the elements of a computer’s architecture? What are some common alternate computer ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch01.html" data-for-analytics="9781449361747:ch01.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch01.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch01.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch01.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%201.%20Understanding%20Performant%20Python&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch01.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/pr01.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Preface</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch02.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">2. Profiling to find bottlenecks</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="understanding_performant_python"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;1.&nbsp;Understanding Performant Python</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
What are the elements of a computer’s architecture?
</li><li class="listitem">
What are some common alternate computer architectures?
</li><li class="listitem">
How does Python abstract the underlying computer architecture?
</li><li class="listitem">
What are some of the hurdles to making performant Python code?
</li><li class="listitem">
What are the different types of performance problems?
</li></ul></div></div><p>Programming computers can be thought of as moving bits of data and transforming
them in special ways in order to achieve a particular result.  However, these
actions have a time cost.  Consequently, high performance programming can be
thought of as the act of minimizing these operations by either reducing the
overhead (ie: writing more efficient code) or by changing the way that we do
these operations in order to make each one more meaningful (ie: finding a more
suitable algorithm).</p><p>Let’s focus on reducing the overhead in code in order to gain more insight into
the actual hardware on which we are moving these bits.  This may seem like a
futile exercise since Python works quite hard to abstract away direct
interactions with the hardware.  However, by understanding both the best way
that bits can be moved in the real hardware and the ways that Python’s
abstractions force your bits to move we can make progress toward writing high
performance programs in Python.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_fundamental_computer_system">Fundamental Computer System</h2></div></div></div><p>The underlying components that make up a computer can be simplified into three
basic parts—the computing units, the memory units and the connections between
them.  In addition, each of these units has different properties that we can use
to understand them.  The computational unit has the property of how many
computations it can do per second, the memory unit has the properties of how much
data it can hold and how fast we can read and write to it, and finally the
connections have the property of how fast they can move data from one place to
the other.</p><p>Using these building blocks we can talk about a standard workstation at multiple
levels of sophistication.  For example, the standard workstation can be thought
of as having a central processing unit (CPU) as the computational unit,
connected to both the random access memory (RAM) and the hard drive as two
separate memory units (each having different capacities and read/write speeds)
and finally a bus that acts as the connections between all of these parts.
However, we can also go into more detail and see that the CPU itself has several
memory units in it, the L1, L2 and sometimes even the L3 and L4 cache, which
have small capacities but very fast speeds (from several kilobytes to a dozen
megabytes).  These extra memory units are connected to the CPU with a special
bus called the backside bus.  Furthermore, new computer architectures generally
come with new configurations (for example, Intel’s Nehalem CPU’s replaced the
frontside bus with the Intel QuickPath Interconnect and restructured many
connections).  Finally, in both of these approximations of a workstation we have
neglected the network connection, which is effectively a very slow connection to
potentially many other computing and memory units!</p><p>To help untangle these various intricacies, let’s go over a brief description of
these fundamental blocks.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_computing_units">Computing Units</h3></div></div></div><p>The computing unit of a computer is the centerpiece of its usefulness—it
provides the ability to transform any bits it receives into other bits or to
change the state of the current process.  CPU’s are the most commonly used
computing unit, however graphics processing units (GPUs), which were typically
used to speed up computer graphics but are not becoming more applicable for
numerical applications, are gaining popularity due to their intrinsically
parallel nature which allows many calculations to happen simultaneously.
Regardless of its type, computing units take in a series of bits, for example
bits representing numbers, and outputs another set of bits, for example
representing the sum of those numbers.  In addition to the basic arithmetic
operations on integers and real numbers and bitwise operations on binary
numbers, some computing units also provide very specialized operations, such as
the “fused multiply add” operation which takes in three numbers, <code class="literal">A,B,C</code>, and
returns the value <code class="literal">A*B + C</code>.</p><p>The main properties of interest in a computing unit are the number of operations
it can do in one cycle and how many cycles it can do in one second.  The first
value is measured by its Instructions Per Cycle (IPC), while the latter value
is measured by its clock speed.  These two measures are always competing with
each other when new computing units are being made.  For example the Intel Core
series has a very high IPC but a lower clock speed, while the Pentium 4 chip has
the reverse.  GPU’s, on the other hand, have a very high IPC and clock speed,
however suffer from other problems which we will outline later.</p><p>Furthermore, while increasing clock speed almost immediately speeds up all
programs running on that computational unit (because they are able to do more
calculations per second), having higher IPC’s can also drastically effect
computing by changing the level of vectorization that is possible.
Vectorization is when a CPU is provided with multiple pieces of data at a time
and is able to operate on all of them at once.  This sort of CPU instruction is
known as SIMD (Single Instruction, Multiple Data).</p><p>In general, computing units have been advancing quite slowly in the past years
(see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#FIG-performant-historical-clock">Figure&nbsp;1-1</a>).  Clock speeds and IPC have both been
stagnant because of the physical limitations of making transistors smaller and
smaller.  As a result, chip manufactures have been relying on other methods to
gain more speed, including hyperthreading, more clever out-of-order execution
and multi-core architectures.</p><p>Hyperthreading presents a virtual second CPU to the host operating system and
clever hardware logic tries to interleave two threads of instructions into the
execution units on a single CPU. When successful gains of up to 30% over a
single thread can be achieved. Typically this works well when the units of work
across both threads use different types of execution unit - e.g. one performs
floating point operations and the other performs integer operations.</p><p>Out-of-order execution enables a compiler to spot that some parts of a linear
program sequence do not depend on the results of a previous piece of work -
therefore both pieces of work could potentially occur in any order or at the
same time. As long as sequential results are presented at the right time, the
program continues to execute correctly, even though pieces of work are computed
out of their programmed order. This enables instructions to execute when others
might be blocked (e.g. waiting for a memory access), allowing greater overall
utilisation of the available resources.</p><p>Finally, and most important for the higher-level programmer, is the prevalence
of multi-core architectures.  These architectures include multiple CPU units
within the same unit which increases the total capability without running into
barriers in making each individual unit faster.  This is why it is currently
hard to find any machine with less than two cores—in this case the computer
has two physical computing units which are connected to each other.  While this
increases the total number of operations that can be done per second, it
introduces intricacies in fully utilizing both computing units at the same time.</p><p>Simply adding more cores to a CPU does not always speed up a program’s execution
time.  This is because of something known as Amdahl’s law.  Simply stated,
Amdahl’s law says that if a program designed to run on multiple cores has some
routines that must run on one core, this will be the bottleneck for the final
speedup by allocating more cores.</p><p>For example, if we had a survey we wanted 100 people to fill out, and that
survey took 1 minute to complete, we could complete this task in 100 minutes if
we had one person asking the questions (this person goes to participant 1, asks
the questions, waits for the responses, then moves to participant 2).  This
method of having one person asking the questions and waiting for responses is
similar to a serial process.  In serial processes, we have operations being
satisfied one at a time, each one waiting for the previous operation to
complete.</p><p>However, we could perform the survey in parallel if we had two people asking the
questions which would let us finish the process in only 50 minutes.  This can be
done because each individual person asking the questions does not need to know
anything about the other people asking questions.  As a result, the task can be
easily split up without having any dependency between the question askers.</p><p>The speedup of adding more people asking the questions will give us speedups
until we have 100 people asking questions.  At this point, the process would
take 1 minute and is simply limited by the time it takes the participant to
answer questions.  Adding more people asking questions cannot gain any further
speedups because these extra people will have no tasks to perform—all the
participants are already being asked questions!  At this point, the only way to
reduce the overall time to run the survey is to reduce the amount of time it
takes for an individual survey, the serial portion of the problem, to complete.
Similarly with CPU’s, we can add more cores that can perform various chunks of
the computation as necessary until we reach a point where the bottleneck is a
specific core finishing its task.  In other words, the bottleneck in any
parallel calculation is always the smaller serial tasks that are being spread
out.</p><p>Furthermore, a major hurdle with utilizing multiple cores in Python is Python’s
use of a Global Interpreter Lock (or GIL).  The GIL makes sure that a Python
process can only run one instruction at a time, regardless of the number of
cores it is currently using.  This means that even though some Python code has
access to multiple cores at a time, only one core is running a Python
instruction at any given time.  Using the previous example of a survey, this
would mean that even if we had 100 question askers, only one could ask a
question and listen to a response at a time.  This effectively removes any sort
of benefit from having multiple question askers! While this may seem like quite
a hurdle, especially if the current trend in computing is to have multiple
computing units rather than having faster ones, this problem can be avoided by
using other standard library tools like <code class="literal">multiprocessing</code> or technologies such
as <code class="literal">numexpr</code>, <code class="literal">cython</code> or distributed models of computing.</p><div class="figure"><a id="FIG-performant-historical-clock"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/processor_clock.png" alt="Historical CPU Clock Speed" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/processor_clock.png"></div></div><div class="figure-title">Figure&nbsp;1-1.&nbsp;Clock speed of CPU’s over time (Data from <a class="ulink" href="http://cpudb.stanford.edu/" target="_top">CPU DB</a>)</div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_memory_units">Memory Units</h3></div></div></div><p>Memory units in computers are used to store bits.  This could be bits
representing variables in your program, or bits representing the pixels of an
image.  In this way, the abstraction of a memory unit applies to the registers
in your motherboard as well as your RAM and hard drive.  The one major
difference between all of these types of memory units is the speed at which they
can read/write data.  To make things more complicated, the read/write speed is
heavily dependent on the way that data is being read.</p><p>For example, most memory units perform much better when they read one large
chunk of data as opposed to many small chunks (this is referred to as sequential
read versus random data).  If data in these memory units are thought of like pages
in a large book, this means that most memory units have better read/write speeds
when going through the book page by page rather than constantly flipping from
one random page to another.  While this fact is generally true across all memory
units, the amount that this affects each type is drastically different.</p><p>In addition to the read/write speeds, memory units also have latency which can
be characterized as the time it takes the device to find the data that is being
used.  For a spinning hard drive, this latency can be high because the disk
needs to physically spin up to speed and the read head must move to the right
position.  On the other hand, for RAM this can be quite small because everything
is solid state. Below is a short description of the various memory units that
are commonly found inside a standard workstation in order of read/write speeds,</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Spinning Hard Drive - Long term storage that persists even when the computer
  is shut down.  Generally has slow read/write speeds because the disk must be
  physically spun and moved.  Degraded performance with random access patterns
  but very large capacity (terabyte range)
</li><li class="listitem">
Solid State Hard Drive - Similar to a spinning hard drive however with faster
  read/write speeds but smaller capacity (gigabyte range)
</li><li class="listitem">
RAM - Used to store application code and data (such as any variables being
  used).  It has fast read/write characteristics and performs well with random
  access patterns, however is generally limited in capacity (gigabyte range)
</li><li class="listitem">
L1/L2 Cache - Extremely fast read/write write speeds. Data going to the CPU
  <span class="emphasis"><em>must</em></span> go through here. Very small capacity (kilobyte range)
</li></ul></div><div class="figure"><a id="FIG-performant-memory-units"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/memory_types.png" alt="Memory Characteristics" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/memory_types.png"></div></div><div class="figure-title">Figure&nbsp;1-2.&nbsp;Characteristic values for different types of memory units (values from Febuary, 2014)</div></div><p>A very immediate trend can be seen in the above list that read/write speeds and
capacity are inversely proportional—as we try to increase speed capacity gets
reduced.  Because of this, many systems implement a tiered approach to memory:
data starts in its full state in the hard drive, part of it moves to the RAM
then a much smaller subset to the L1/L2 cache.  This method of tiering enables
programs to keep memory in different places depending on access speed
requirements.  When trying to optimize the memory patterns of a program, we are
simply optimizing which data is placed where, how it is laid out (in order to
increase the number of sequential reads) and how many times it is moved between
the various locations.  In addition, methods such as asynchronous I/O and
preemptive caching provide ways to make sure that data is always where it needs
to be without having to waste computing time—most of these processes can
happen independently while other calculations are being performed!</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="understanding_pp_communication">Communications Layers</h3></div></div></div><p>Finally, let’s look at how all of these fundamental blocks communicate with
each other.  There are many different modes of communication, but they are all
variants on a thing called a bus.</p><p>The frontside bus, for example, is the connection between the ram and the L1/L2
cache.  Here, we move data that is ready to be transformed by the processor into
the staging ground to get ready for calculation and move finished calculations
out.  On the other hand, there are other buses such as the external bus which acts as
the main route from hardware devices (such as hard drives and networking cards)
to the CPU and system memory.  This bus is generally slower than the frontside.</p><p>In fact, many of the benefits to the L1/L2 cache come from the fact that they
are on a faster bus.  By being able to queue up data necessary for computation
in large chunks on a slow bus (from RAM to cache) then having it available at
very fast speeds from the backside bus (from cache to CPU), the CPU is able to
do more calculations without waiting such a long time.</p><p>Similarly, many of the drawbacks of using a GPU come from the bus it is
connected on: since the GPU is generally a peripheral device, it communicates
through the PCI bus which is much slower than the frontside bus.  As a result,
getting data in and out of the GPU can be quite a taxing operation.  In this
way, the advent of heterogeneous computing, or computing blocks that have both a
CPU and a GPU on the frontside bus, aim at reducing the data transfer cost and
making GPU computing more of an available option, even when a lot of data must
be transferred.</p><p>In addition to the communications blocks within the computer, the network can be
thought of as yet another communication block.  This block, however, is much
more pliable that the ones discussed previously; a network device can be
connected to a memory device, such as a network attached storage (NAS), or
another computing block, as in a computing node in a cluster.  However, network
communications are generally much slower than the other types of communications
than were mentioned before.  While the frontside bus can transfer dozens of
gigabits per second, the network is limited to the order of several dozen
megabits.</p><p>It is clear then that the main property of a bus is its speed: how much data
can it move in a given amount of time.  This property is given by combining
several quantities: how much data can be moved in one transfer (bus width) and
how many transfers it can do per second (bus frequency).  It is important to
note that the data moved in one transfer is always sequential: a chunk of data
is read off of the memory and moved to a different place.  Thus, the speed of a
bus is broken up into these two quantities because individually they can affect
different aspects of computation: a large bus width can help vectorized code (or
any code that sequentially reads through memory) by being able to move all the
relevant data in one transfer.</p><p>On the other hand, having a small bus width but a very high frequency of
transfers can help code that must do many reads from random parts of memory.
Interestingly, one of the ways that these properties are changed by computer
designers is by the physical layout of the motherboard: when chips are placed
closed to one another, the length of the physical wires joining them is smaller
and can allow for faster transfer speeds.  In addition, the number of wires
themselves dictate the width of the bus (giving real physical meaning to the
term!).</p><div class="figure"><a id="FIG-performant-connection-speed"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/speeds_of_common_interfaces.png" alt="Connection Speeds" width="1000" height="1000" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/speeds_of_common_interfaces.png"></div></div><div class="figure-title">Figure&nbsp;1-3.&nbsp;Connection speeds of various common interfaces (Made by <a class="ulink" href="http://en.wikipedia.org/wiki/File:Speeds_of_common_interfaces.svg" target="_top">Leadbuffalo</a>, [CC BY-SA 3.0])</div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_putting_the_fundamental_elements_together">Putting the Fundamental Elements Together</h2></div></div></div><p>Understanding the basic components of a computer is not enough to fully
understand the problems of performance programming.  The interplay of all of
these components and how they work together to solve a problem introduces the
extra levels of complexity that are necessary.  In this section, we will try to
explore some toy problems and understand how the ideal solution would work and
how Python approaches it.</p><p>A warning: this section may seem bleak—most of the remarks seem to say that
Python is natively incapable of dealing with the problems of performance.  This
is untrue for two reasons.  Firstly, in all of these “components of performant
computing” we have neglected one very important component: the developer.  What
native Python may lack in performance it gets back right away with speed of
development.  Furthermore, throughout the book we will introduce modules and
philosophies that can help mitigate many of the problems described below with
relative ease.  With both of these two aspects combined, we will keep the fast
development mindset of Python while removing many of the performance constraints.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="understanding-performance-idealized-computing">Idealized computing vs Python VM</h3></div></div></div><p>In order to better understand the components of performance programming, let us
look at a simple code sample that checks if a number is prime:</p><pre class="programlisting"><code class="kn">import</code> <code class="nn">math</code>
<code class="k">def</code> <code class="nf">check_prime</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
    <code class="n">sqrt_number</code> <code class="o">=</code> <code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">number</code><code class="p">)</code>
    <code class="n">number_float</code> <code class="o">=</code> <code class="nb">float</code><code class="p">(</code><code class="n">number</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="nb">int</code><code class="p">(</code><code class="n">sqrt_number</code><code class="p">)</code><code class="o">+</code><code class="mi">1</code><code class="p">):</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">number_float</code> <code class="o">/</code> <code class="n">i</code><code class="p">)</code><code class="o">.</code><code class="n">is_integer</code><code class="p">():</code>
            <code class="k">return</code> <code class="bp">False</code>
    <code class="k">return</code> <code class="bp">True</code>

<code class="k">print</code> <code class="s">"check_prime(10000000) = "</code><code class="p">,</code> <code class="n">check_prime</code><code class="p">(</code><code class="mi">10000000</code><code class="p">)</code> <code class="c"># False</code>
<code class="k">print</code> <code class="s">"check_prime(10000019) = "</code><code class="p">,</code> <code class="n">check_prime</code><code class="p">(</code><code class="mi">10000019</code><code class="p">)</code> <code class="c"># True</code></pre><p>Let’s analyse this code using our abstract model of computation and then draw
comparisons to what happens when Python runs this code.  As with any
abstraction, we will neglect many of the subtleties in both the idealized
computer and in the way that Python runs the code.  However, this is generally a
good exercise to perform before solving a problem: think about the general
components of the algorithm and what would be the best way for the computing
components to come together in order to find a solution.  By understanding this
ideal situation and having knowledge of what is actually happening under the
hood in Python, we can iteratively bring our Python code closer to the optimal
code.</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title" id="_idealized_computing">Idealized Computing</h4></div></div></div><p>When the code starts, we have the value of <code class="literal">number</code> stored in RAM.  In order to
calculate <code class="literal">sqrt_number</code> and <code class="literal">number_float</code>, we need to send that value over to
the CPU.  Ideally, we could send the value once, it would get stored inside the
CPU’s L1/L2 cache, the CPU would do the calculations and then send the values
back to the RAM to get stored.  This scenario is ideal because we have minimized
the number of reads of the value <code class="literal">number</code> from RAM, instead opting for reads
from the L1/L2 cache which is much faster. Furthermore, we have minimized the
number of data transfers through the frontside-bus, opting for communications
through the faster backside bus instead (which connects the various caches to
the CPU).  This theme of keeping data where it is needed, and moving it as
little as possible, is very important when it comes to optimization.  The
concept of “heavy data” refers to the fact that data is heavy and it takes time
and effort to move it around, which is something we would like to avoid.</p><p>For the loop in the code, rather than sending one value of <code class="literal">i</code> at a time to the
CPU, we would like to send it both <code class="literal">number_float</code> and <span class="strong"><strong>several</strong></span> values of <code class="literal">i</code> to
check at the same time.  This is possible because the CPU vectorizes operations
with no additional time cost, meaning it can do multiple, independent,
computations at the same time.  In order to do this, <code class="literal">number_float</code> is sent to
the CPU cache, in addition to as many values of <code class="literal">i</code> as the cache can hold.  For
each of the <code class="literal">number_float</code>/<code class="literal">i</code> pairs, we divide them and check if it is a whole
number, then send a signal back as to whether one of the values was indeed an
integer.  If so, the function ends, if not we repeat.  In this way, we only need
to communicate back one result for many values of <code class="literal">i</code>, rather than depending on
the slow bus for every value.  This takes advantage of a CPU’s ability to
vectorize a calculation, or do one instruction on multiple data in one clock
cycle.</p><p>This concept of vectorization is similar to the code below:</p><pre class="programlisting"><code class="kn">import</code> <code class="nn">math</code>
<code class="k">def</code> <code class="nf">check_prime</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
    <code class="n">sqrt_number</code> <code class="o">=</code> <code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">number</code><code class="p">)</code>
    <code class="n">number_float</code> <code class="o">=</code> <code class="nb">float</code><code class="p">(</code><code class="n">number</code><code class="p">)</code>
    <code class="n">numbers</code> <code class="o">=</code> <code class="nb">range</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="nb">int</code><code class="p">(</code><code class="n">sqrt_number</code><code class="p">)</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">numbers</code><code class="p">),</code> <code class="mi">5</code><code class="p">):</code>
        <code class="n">result</code> <code class="o">=</code> <code class="p">(</code><code class="n">number_float</code> <code class="o">/</code> <code class="n">numbers</code><code class="p">[</code><code class="n">i</code><code class="p">:(</code><code class="n">i</code><code class="o">+</code><code class="mi">5</code><code class="p">)])</code><code class="o">.</code><code class="n">is_integer</code><code class="p">()</code> <code class="c">#not valid Python</code>
        <code class="k">if</code> <code class="nb">any</code><code class="p">(</code><code class="n">result</code><code class="p">):</code>
            <code class="k">return</code> <code class="bp">False</code>
    <code class="k">return</code> <code class="bp">True</code></pre><p>Here, we setup the processing such that the division and the checking for
integers is done on a set of 5 values of <code class="literal">i</code> at a time.  If properly vectorized,
the CPU can do this line in one step as opposed to doing a separate calculation
for every <code class="literal">i</code>.  Ideally, the <code class="literal">any(result)</code> operation would also happen in the
CPU without having to transfer the results back to RAM.  We will talk more
about vectorization, how it works and when it benefits your code in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a></p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title" id="_python_8217_s_virtualized_machine">Python’s Virtualized Machine</h4></div></div></div><p>The Python interpreter does a lot of work to try to abstract away the underlying
computing elements that are being used.  At no point does a programmer need to
worry about allocating memory for arrays, how to arrange that memory or in what
sequence it is being sent to the CPU.  This is a benefit of Python since it lets
you focus on the algorithms that are being implemented, however it comes at a
huge performance cost.</p><p>It is important to realize that at its core, Python is indeed running a set of
very optimized instructions.  The trick, however, is getting Python to perform
them in the correct sequence in order to achieve better performance.  For
example, it is quite easy to see that, in the example below, <code class="literal">search_fast</code> will
run faster than <code class="literal">search_slow</code> simply because it skips through unnecessary
computations from not terminating the loop early even though both solutions have
runtime <code class="literal">O(N)</code>.  Similarly, identifying slow regions of code through profiling
and finding more efficient ways of doing the same calculations is similar to
finding these useless operations and removing them; the end result is the same
but the number of computations and data transfers is reduced drastically.</p><pre class="programlisting"><code class="k">def</code> <code class="nf">search_fast</code><code class="p">(</code><code class="n">haystack</code><code class="p">,</code> <code class="n">needle</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">item</code> <code class="ow">in</code> <code class="n">haystack</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">item</code> <code class="o">==</code> <code class="n">needle</code><code class="p">:</code>
            <code class="k">return</code> <code class="bp">True</code>
    <code class="k">return</code> <code class="bp">False</code>

<code class="k">def</code> <code class="nf">search_slow</code><code class="p">(</code><code class="n">haystack</code><code class="p">,</code> <code class="n">needle</code><code class="p">):</code>
    <code class="n">return_value</code> <code class="o">=</code> <code class="bp">False</code>
    <code class="k">for</code> <code class="n">item</code> <code class="ow">in</code> <code class="n">haystack</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">item</code> <code class="o">==</code> <code class="n">needle</code><code class="p">:</code>
            <code class="n">return_value</code> <code class="o">=</code> <code class="bp">True</code>
    <code class="k">return</code> <code class="n">return_value</code></pre><p>One of the impacts of this abstraction layer is that vectorization is not
immediately achievable.  The previous prime number routine will run one
iteration of the loop per value of <code class="literal">i</code> instead of combining several iterations.
However, looking at the abstracted vectorization example we see that it is not
valid Python code since we cannot divide a float by a list.  External libraries
such as <code class="literal">numpy</code> will help with this situation by adding the ability to do
vectorized mathematical operations.</p><p>Furthermore, Python’s abstraction hurts any optimizations regarding keeping the
L1/L2 cache filled with the relevant data for the next computation.  This comes
from many factors, first being that Python objects are not laid out in the most
optimal way in memory.  This is a consequence of Python being a garbage
collected language—memory is automatically allocated and freed when needed.
This creates memory fragmentation that can hurt the transfers to the CPU caches.
In addition, at no point is there an opportunity to change the layout of a data
structure directly in memory which means that one transfer on the bus may not
contain all the relevant information for a computation even though it may have
all fit within the bus width.</p><p>A second, and more fundamental problem comes from Python’s dynamic types and it
not being compiled.  As many C programmers have learned throughout the years:
the compiler is often smarter than you are.  When compiling code that is
static, the compiler can do many tricks to change the way things are laid out
and how the CPU will run certain instructions in order to optimize them.
Python, however, is not compiled and, to make matters worse, has dynamic types
which means that inferring any possible opportunities for optimizations
algorithmically is drastically harder since code functionality can be changed
during runtime.  There are many ways to mitigate this problem, foremost being
<code class="literal">cython</code> which allows Python code to be compiled and allows the user to create
“hints” to the compiler as to how dynamic the code actually is.</p><p>Finally, the previously mentioned GIL can hurt performance if trying to
parallelize this code.  For example, let’s assume we change the code to use
multiple CPU cores such that each core gets a chunk of the numbers from <code class="literal">1</code> to
<code class="literal">sqrtN</code>.  Each core can do its calculation for its chunk of numbers and then,
when they are all done, they can compare their calculations.  This seems like a
good situation since, although we lose the early termination of the loop, we
can reduce the number of checks each core has to do by the number of cores we
are using (ie: if we had <code class="literal">M</code> cores, each core would have to do <code class="literal">sqrtN / M</code>
checks).  However, because of the GIL only one core can be used at a time.  This
means that we would effectively be running the same code as the unparallelled
version however we no longer have early termination.  This problem can be
avoided by using multiple processes (with the <code class="literal">multiprocessing</code> module) instead
of multiple threads, or by using cython or foreign functions.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_so_why_use_python">So Why Use Python?</h2></div></div></div><p>Python is highly expressive and easy to learn - new programmers quickly discover
that they can do quite a lot in a short space of time. Many Python libraries
wrap tools written in other languages to make it easy to call other systems, for
example the scikit-learn machine learning system wraps LIBLINEAR and LIBSVM
(both of which are written in C) and the <code class="literal">numpy</code> library includes BLAS and other
C and Fortran libraries.  As a result, python code that properly utilizes these
modules can indeed be as fast as comparable C code.</p><p>Python is described as “Batteries Included” as many important and stable
libraries are built-in:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
unicode and bytes - unicode and bytes are baked into the core language
</li><li class="listitem">
arrays - memory efficient arrays for primitive types
</li><li class="listitem">
math - basic mathematical operations including some simple statistics
</li><li class="listitem">
sqlite3 - wrapper around the prevalent SQL file-based storage engine sqlite3
</li><li class="listitem">
collections - wide variety of objects include a deque, counter and dictionary variants
</li></ul></div><p>Outside of the core language there are a huge variety of libraries:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
numpy - numerical Python library, a bedrock library for anything to do with matrices
</li><li class="listitem">
scipy - very large collection of trusted scientific libraries, often wrapping highly respected C and Fortran libraries
</li><li class="listitem">
pandas - library for data analysis, similar to R’s data frames or an Excel spreadsheet, built on scipy and numpy
</li><li class="listitem">
scikit-learn - rapidly turning in to the default machine learning library, built on scipy
</li><li class="listitem">
biopython - bioinformatics library, similar to bioperl
</li><li class="listitem">
storage system bindings including Redis, MongoDB, hdf5 and SQL systems
</li><li class="listitem">
Django, Pyramid, Flask, Bottle for web development
</li><li class="listitem">
OpenCV bindings - bindings to the OpenCV computer vision framework
</li><li class="listitem">
API bindings to websites including Google, Twitter, LinkedIn
</li><li class="listitem">
tornado - easy bindings for concurrency
</li></ul></div><p>A large selection of managed environments and shells are available to fit
various deployment scenarios:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
The Standard distribution - available at <a class="ulink" href="http://python.org/" target="_top">http://python.org</a>
</li><li class="listitem">
Enthought’s EPD and Canopy - very mature and capable environment
</li><li class="listitem">
Continuum’s Anaconda - scientifically focused environment
</li><li class="listitem">
Sage - Matlab-like environment including IDE
</li><li class="listitem">
Python(x,y)
</li><li class="listitem">
IPython - Interactive Python shell, heavily used by scientists and developers
</li><li class="listitem">
IPython Notebook - Browser-based frontend to IPython, heavily used for teaching and demonstrations
</li><li class="listitem">
BPython - Interactive Python shell
</li></ul></div><p>One of Python’s main strengths is that it enables fast prototyping on an idea.
Due to the wide variety of supporting libraries it is easy to test if an idea is
feasible, even though the first implementation might be rather flaky.</p><p>If you want to make your mathematical routines faster then look to <code class="literal">numpy</code>. If
you want to experiment with machine learning then try <code class="literal">scikit-learn</code>. If you are
cleaning and manipulating data then <code class="literal">pandas</code> is a good choice.</p><p>In general, it is sensible to raise the question “if our system runs faster -
will we as a team run slower in the long-run?”. It is always possible to squeeze
more performance out of a system if enough man-hours are invested, this might
lead to brittle and poorly-understood optimizations that ultimately trip the
team up.</p><p>One example might be the introduction of Cython (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython">Cython</a>), a
compiler-based approach to annotating Python code with C-like types so the
transformed code can be compiled using a C compiler. While the speed gains can
be impressive (often achieving C-like speeds with relatively little effort), the
cost of supporting this code will increase. In particular it might be harder to
support this new module as team members will need a certain maturity in their
programming ability to understand some of the trade-offs that have occurred when
leaving the Python virtual machine that introduced the performance increase.</p></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/pr01.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">Preface</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch02.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">2. Profiling to find bottlenecks</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch01.html" data-for-analytics="9781449361747:ch01.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#">Reset</a>
</div>
</div></body></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch02.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch02.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch02.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch02.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>2. Profiling to find bottlenecks - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch02.html"><meta name="description" content="Chapter&nbsp;2.&nbsp;Profiling to find bottlenecks Questions you’ll be able to answer after this chapter How can we identify speed and RAM bottlnecks in our code? How do we ... "><meta property="og:title" content="2. Profiling to find bottlenecks"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="2. Profiling to find bottlenecks"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch02.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;2.&nbsp;Profiling to find bottlenecks Questions you’ll be able to answer after this chapter How can we identify speed and RAM bottlnecks in our code? How do we ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch02.html" data-for-analytics="9781449361747:ch02.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch02.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch02.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch02.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%202.%20Profiling%20to%20find%20bottlenecks&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch02.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch01.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">1. Understanding Performant Python</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch03.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">3. Lists and Tuples</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-profiling"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;2.&nbsp;Profiling to find bottlenecks</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
How can we identify speed and RAM bottlnecks in our code?
</li><li class="listitem">
How do we profile CPU and memory usage?
</li><li class="listitem">
What depth of profiling should we use?
</li><li class="listitem">
How can we profile a long-running application?
</li><li class="listitem">
What’s happening under the hood with CPython?
</li><li class="listitem">
How do we keep our code correct whilst tuning performance?
</li></ul></div></div><p>Profiling lets us find bottlenecks so we can do the least amount of work to get the biggest practical performance gain. Often we’d like huge gains in speed and resource usage with little work, practically you’ll aim for your code to run “fast enough” and “lean enough” to fit your needs. Profiling will let you make the most pragmatic decisions for the least overall effort.</p><p>Any measurable resource can be profiled (not just the CPU!) - in this chapter we look at both CPU time and memory usage. You could apply similar techniques to measure network bandwidth and disk I/O too.</p><p>If a program is running too slowly or using too much RAM then you’ll want to fix whichever parts of your code are responsible. You could of course skip profiling and fix what you believe might be the problem - <span class="emphasis"><em>be wary</em></span> as you’ll often end up fixing the wrong thing. Rather than using your intuition it is far more sensible to first profile having defined a hypothesis, before making changes to the structure of your code.</p><p>A good habit for a programmer is laziness. By profiling first you can quickly identify the bottlenecks that need to be solved and then you can solve just enough of these to achieve the performance you need. If you avoid profiling and jump to optimization then it is quite likely that you’ll do more work in the long-run. Always be driven by the results of profiling.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_profiling_efficiently">Profiling efficiently</h2></div></div></div><p>The first aim of profiling is to test a representative system to identify what’s slow (or using too much RAM, disk I/O or network I/O). Profiling typically adds an overhead (10* to 100* slowdowns can be typical) and you still want your code to be used as similarly to a real world situation as possible. Extract a test case and isolate the piece of the system that you need to test, preferably it’ll have been written to be in its own set of modules already.</p><p>The basic techniques that are introduced first in this chapter include the <code class="literal">%timeit</code> magic in IPython, <code class="literal">time.time()</code> and a timing decorator. You can use these techniques to understand the behavior of statements and functions.</p><p>We will cover <code class="literal">cProfile</code> (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-cprofile">Using the cProfile module</a>) to show you how to use this built-in tool to understand which functions in your code take the longest to run. This will give you a high level view of the problem so you can direct your attention to the critical functions.</p><p>Next we’ll look at <code class="literal">line_profiler</code> (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-line-profiler">line_profiler for line-by-line measurements</a>) which will profile your chosen functions on a line-by-line basis. The result will include a count of the number of times each line is called and the percentage of time spent on each line. This is exactly the information you need to understand what’s running slowly and why.</p><p>Armed with the results of <code class="literal">line_profiler</code> you’ll have the information you need to move on to using a compiler (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html">Chapter&nbsp;7</a>).</p><p><code class="literal">perf stat</code> is later introduced in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_perf_python_memory">Example&nbsp;6-8</a>, there you’ll learn how to understand the number of instructions that are ultimately executed on a CPU and how efficiently the CPU’s caches are utilized. This allows for advanced-level tuning of matrix operations. You should read this when you’re done with this chapter.</p><p>After <code class="literal">line_profiler</code> we show you <code class="literal">heapy</code> (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-heapy">Inspecting objects on the heap with heapy</a>) which can track all of the objects inside Python’s memory - this is great for hunting strange memory-leaks. If you’re working with long-running systems then <code class="literal">dowser</code> (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-dowser">Dowser for live graphing of instantiated variables</a>) will interest you - you can introspect live objects in a long-running process via a web-browser interface.</p><p>To understand why your RAM usage is high we’ll show you <code class="literal">memory_profiler</code> (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#memory_profiler">memory_profiler for diagnosing memory usage</a>). It is particularly useful to chart RAM usage over time on a labelled chart to explain to colleagues why certain functions use more RAM than expected.</p><div class="note"><h3 class="title">Note</h3><p>Whatever approach you take to profile your code, you must remember to have adequate unit test coverage in your code. Unit tests help you to avoid silly mistakes and help to keep your results reproducible. Avoid them at your peril.</p><p><span class="strong"><strong>Always</strong></span> profile your code before compiling or re-writing your algorithm, you need evidence to determine the most efficient ways to make your code run faster.</p></div><p>Finally we’ll give you an introduction to the Python bytecode inside CPython (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-dis">The dis module to examine CPython bytecode</a>) so you can understand what’s happening “under the hood”. In particular having an understanding of how Python’s stack based virtual machine operates will help you to understand why certain coding styles run more slowly than others.</p><p>Before the end we review how to integrate unit tests whilst profiling (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-unit-testing">Unit testing during optimization to maintain correctness</a>) to preserve the correctness of your code whilst you make it run more efficiently.</p><p>We’ll finish with a discussion of profiling strategies (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-strategies">Strategies to profile your code successfully</a>) so you can reliably profile your code and gather the correct data to test your hypotheses. Here you’ll learn about how dynamic CPU frequency scaling and features like TurboBoost can skew your profiling results and how they can be disabled.</p><p>To walk through all of these steps we need an easy-to-analyze function. The next section introduces the Julia Set - it is a CPU-bound function that’s a little hungry for RAM, it also exhibits non-linear behavior (so we can’t easily predict the outcomes) which means we need to profile it at run-time rather than analyze it off-line.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_introducing_the_julia_set">Introducing the Julia Set</h2></div></div></div><p>The Julia Set <sup>[<a id="id314061" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#ftn.id314061" class="footnote totri-footnote">4</a>]</sup> is an interesting CPU-bound problem for us to begin with, it is a fractal sequence that generates a complex output image. It is named after Gaston Julia.</p><p>The code that follows is a little longer than a version you might write yourself, it has a CPU-bound component and a very explicit set of inputs. This configuration allows us to profile both the CPU usage and the RAM usage so we understand which parts of our code are consuming two of our scarce computing resources. This implementation is <span class="emphasis"><em>deliberately</em></span> sub-optimal so we can identify memory-consuming operations and slow statements. Later in this chapter we fix a slow logic statement and a memory-consuming statement and then in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html">Chapter&nbsp;7</a> we significantly speed-up the overall execution time of this function.</p><p>We will analyse a block of code that produces both a false greyscale plot (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-example">Figure&nbsp;2-1</a>) and a pure greyscale variant of the Julia Set (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-example-greyscale">Figure&nbsp;2-3</a>), at the complex point <code class="literal">c=-0.62772-0.42193j</code>. A Julia Set is produced by calculating each pixel in isolation, this is an “embarrassingly parallel problem” as no data is shared between points.</p><p>If we chose a different <code class="literal">c</code> then we’d get a different image. The location we have chosen has regions that are quick to calculate and others that are slow to calculate, this is useful for our analysis.</p><p>The problem is interesting because each pixel is calculated by applying a loop that could be applied an indeterminate number of times. On each iteration we test to see if this coordinate’s value escapes towards infinity or if it seems to be held by an attractor. Coordinates that cause few iterations are colored darkly, a high number of iterations are colored white. White regions are more complex to calculate and so take longer to generate.</p><div class="figure"><a id="FIG-julia-example"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_example_image.png" alt="Julia set at -0.62772-0.42193i" width="1000" height="1000" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_example_image.png"></div></div><div class="figure-title">Figure&nbsp;2-1.&nbsp;Julia Set plot with a false greyscale to highlight detail.</div></div><p>We define a set of <code class="literal">z</code> coordinates that we’ll test. The function that we calculate squares the complex number <code class="literal">z</code> and adds <code class="literal">c</code>:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0201.png" alt="" width="129" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0201.png"></span></p><p>We iterate on this function whilst testing to see if the escape condition holds using <code class="literal">abs</code>. If the escape function is <code class="literal">False</code> then we break out of the loop and record the number of iterations we performed at this coordinate. If the escape function is never <code class="literal">False</code> then we stop after <code class="literal">maxiter</code> iterations. We will later turn this <code class="literal">z</code>’s result into a coloured pixel representing this complex location.</p><p>In pseudocode it might look like:</p><pre class="programlisting"><code class="k">for</code> <code class="n">z</code> <code class="ow">in</code> <code class="n">coordinates</code><code class="p">:</code>
    <code class="k">for</code> <code class="n">iteration</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">maxiter</code><code class="p">):</code>  <code class="c"># limited iterations per point</code>
        <code class="k">if</code> <code class="nb">abs</code><code class="p">(</code><code class="n">z</code><code class="p">)</code> <code class="o">&lt;</code> <code class="mf">2.0</code><code class="p">:</code>  <code class="c"># has the escape condition been broken?</code>
            <code class="n">z</code> <code class="o">=</code> <code class="n">z</code><code class="o">*</code><code class="n">z</code> <code class="o">+</code> <code class="n">c</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">break</code>
    <code class="c"># store the iteration count for each z and draw later</code></pre><p>To explain this function, let’s try two coordinates.</p><p>Let us use the co-ordinate that we draw in the top-left corner of the plot at <code class="literal">-1.8-1.8j</code>. We must test <code class="literal">abs(z) &lt; 2</code> before we can try the update rule:</p><pre class="programlisting"><code class="n">z</code> <code class="o">=</code> <code class="o">-</code><code class="mf">1.8</code><code class="o">-</code><code class="mf">1.8j</code>
<code class="k">print</code> <code class="nb">abs</code><code class="p">(</code><code class="n">z</code><code class="p">)</code></pre><pre class="screen">2.54558441227</pre><p>We can see that for the top-left co-ordinate the <code class="literal">abs(z)</code> test will be <code class="literal">False</code> on the 0th iteration, so we do not perform the update rule. The <code class="literal">output</code> value for this co-ordinate is <code class="literal">0</code>.</p><p>Now let’s jump to the center of the plot at <code class="literal">z=0+0j</code> and try a few iterations:</p><pre class="programlisting"><code class="n">c</code> <code class="o">=</code> <code class="o">-</code><code class="mf">0.62772</code><code class="o">-</code><code class="mf">0.42193j</code>
<code class="n">z</code> <code class="o">=</code> <code class="mi">0</code><code class="o">+</code><code class="mi">0j</code>
<code class="k">for</code> <code class="n">n</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">9</code><code class="p">):</code>
    <code class="n">z</code> <code class="o">=</code> <code class="n">z</code><code class="o">*</code><code class="n">z</code> <code class="o">+</code> <code class="n">c</code>
    <code class="k">print</code> <code class="s">"{}: z={:33}, abs(z)={:0.2f}, c={}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">n</code><code class="p">,</code> <code class="n">z</code><code class="p">,</code> <code class="nb">abs</code><code class="p">(</code><code class="n">z</code><code class="p">),</code> <code class="n">c</code><code class="p">)</code></pre><pre class="screen">0: z=              (-0.62772-0.42193j), abs(z)=0.76, c=(-0.62772-0.42193j)
1: z=    (-0.4117125265+0.1077777992j), abs(z)=0.43, c=(-0.62772-0.42193j)
2: z=(-0.469828849523-0.510676940018j), abs(z)=0.69, c=(-0.62772-0.42193j)
3: z=(-0.667771789222+0.057931518414j), abs(z)=0.67, c=(-0.62772-0.42193j)
4: z=(-0.185156898345-0.499300067407j), abs(z)=0.53, c=(-0.62772-0.42193j)
5: z=(-0.842737480308-0.237032296351j), abs(z)=0.88, c=(-0.62772-0.42193j)
6: z=(0.026302151203-0.0224179996428j), abs(z)=0.03, c=(-0.62772-0.42193j)
7: z= (-0.62753076355-0.423109283233j), abs(z)=0.76, c=(-0.62772-0.42193j)
8: z=(-0.412946606356+0.109098183144j), abs(z)=0.43, c=(-0.62772-0.42193j)</pre><p>We can see that each update to <code class="literal">z</code> for these first iterations leaves it with a value where <code class="literal">abs(z) &lt; 2</code> is <code class="literal">True</code>. For this co-ordinate we can iterate 300 times and still the test will be True. We cannot tell how many iterations we must perform before the condition becomes <code class="literal">False</code> (and possibly this is an infinite sequence) so the maximum iteration (<code class="literal">maxiter</code>) break clause will stop us iterating potentially forever.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-non-convergence">Figure&nbsp;2-2</a> we see the first 50 iterations of the above sequence. For <code class="literal">0+0j</code> (solid line with circle markers) the sequence appears to repeat every 8th iteration but each sequence of 7 calculations has a minor deviation to the previous sequence - we can’t tell if this point will iterate forever within the boundary condition or for a long time or maybe for just a few more iterations. The dashed <code class="literal">cutoff</code> line shows the boundary at <code class="literal">+2</code>.</p><div class="figure"><a id="FIG-julia-non-convergence"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_nonconvergence.png" alt="julia non convergence" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_nonconvergence.png"></div></div><div class="figure-title">Figure&nbsp;2-2.&nbsp;Two co-ordinate examples evolving for the Julia set.</div></div><p>For <code class="literal">-0.82+0j</code> (the dashed line with diamond markers) we can see that after the 9th update the absolute result has exceeded the <code class="literal">+2</code> cutoff and we’d stop updating this value.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_calculating_the_full_julia_set">Calculating the full Julia Set</h2></div></div></div><p>Below we break down the code that generates the Julia Set, we’ll analyse it in various ways throughout this chapter. As shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-juliaset-intro1">Example&nbsp;2-1</a> at the start of our module we import the <code class="literal">time</code> module for our first profiling approach and define some coordinate constants.</p><div class="example"><a id="profiling-juliaset-intro1"></a><div class="example-title">Example&nbsp;2-1.&nbsp;Defining global constants for the co-ordinate space</div><div class="example-contents"><pre class="screen">"""Julia set generator without optional PIL-based image drawing"""
import time

# area of complex space to investigate
x1, x2, y1, y2 = -1.8, 1.8, -1.8, 1.8
c_real, c_imag = -0.62772, -.42193</pre></div></div><p>To generate the plot we create two lists of input data - the first is <code class="literal">zs</code> (complex z co-ordinates), the second is <code class="literal">cs</code> (a complex initial condition). Neither list varies and we could optimise <code class="literal">cs</code> to a single <code class="literal">c</code> value as a constant. The rationale for building two input lists is that we have some reasonable-looking data to profile when we profile RAM usage later in this chapter.</p><p>To build the <code class="literal">zs</code> and <code class="literal">cs</code> lists we need to know the coordinates for each <code class="literal">z</code>, in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-juliaset-intro2">Example&nbsp;2-2</a> we build this up using <code class="literal">xcoord</code> and <code class="literal">ycoord</code> and a specified <code class="literal">x_step</code> and <code class="literal">y_step</code>. The somewhat verbose nature of this setup is useful when porting the code to other tools (e.g. to <code class="literal">numpy</code>) and to other Python environments as it helps to have everything <span class="emphasis"><em>very</em></span> clearly defined for debugging.</p><div class="example"><a id="profiling-juliaset-intro2"></a><div class="example-title">Example&nbsp;2-2.&nbsp;Code to establish the co-ordinate lists as inputs to our calculation function</div><div class="example-contents"><pre class="screen">def calc_pure_python(desired_width, max_iterations):
    """Create a list of complex co-ordinates (zs) and complex
    parameters (cs), build Julia set and display"""
    x_step = (float(x2 - x1) / float(desired_width))
    y_step = (float(y1 - y2) / float(desired_width))
    x = []
    y = []
    ycoord = y2
    while ycoord &gt; y1:
        y.append(ycoord)
        ycoord += y_step
    xcoord = x1
    while xcoord &lt; x2:
        x.append(xcoord)
        xcoord += x_step
    # build a list of co-ordinates and the initial condition for each cell.
    # Note that our initial condition is a constant and could easily be removed,
    # we use it to simulate a real-world scenario with several inputs to our function
    zs = []
    cs = []
    for ycoord in y:
        for xcoord in x:
            zs.append(complex(xcoord, ycoord))
            cs.append(complex(c_real, c_imag))

    print "Length of x:", len(x)
    print "Total elements:", len(zs)
    start_time = time.time()
    output = calculate_z_serial_purepython(max_iterations, zs, cs)
    end_time = time.time()
    secs = end_time - start_time
    print calculate_z_serial_purepython.func_name + " took", secs, "seconds"

    # this sum is expected for 1000^2 grid with 300 iterations
    # it catches minor errors we might introduce when we're
    # working on a fixed set of inputs
    assert sum(output) == 33219980</pre></div></div><p>Having built the <code class="literal">zs</code> and <code class="literal">cs</code> lists we output some information about the size of the lists and calculate the <code class="literal">output</code> list  via <code class="literal">calculate_z_serial_purepython</code>. Finally we <code class="literal">sum</code> the contents of <code class="literal">output</code> and <code class="literal">assert</code> that it matches the expected output value. Ian uses it here to confirm that no errors creep into the book.</p><p>As the code is deterministic we can verify that the function works as we expect by summing all the calculated values. This is useful as a sanity check because when we make changes to numerical code it is <span class="emphasis"><em>very</em></span> sensible to check that we haven’t broken the algorithm. Ideally we would use unit tests and we’d test more than one configuration of the problem.</p><p>Next in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-juliaset-intro3">Example&nbsp;2-3</a> we define the <code class="literal">calculate_z_serial_purepython</code> function, it expands on the algorithm we discussed above. Notably we also define an <code class="literal">output</code> list at the start which has the same length as the input <code class="literal">zs</code> and <code class="literal">cs</code> lists. You may also wonder why we’re using <code class="literal">range</code> rather than <code class="literal">xrange</code> - this is so in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#memory_profiler">memory_profiler for diagnosing memory usage</a> we can show how wasteful <code class="literal">range</code> can be!</p><div class="example"><a id="profiling-juliaset-intro3"></a><div class="example-title">Example&nbsp;2-3.&nbsp;Our CPU-bound calculation function</div><div class="example-contents"><pre class="screen">def calculate_z_serial_purepython(maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while abs(z) &lt; 2 and n &lt; maxiter:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>Now we call the calculation routine in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-juliaset-intro4">Example&nbsp;2-4</a>, by wrapping it in a <code class="literal">__main__</code> check we can safely import the module without starting the calculations for some of the profiling methods. Note that here we’re not showing the method used to plot the output.</p><div class="example"><a id="profiling-juliaset-intro4"></a><div class="example-title">Example&nbsp;2-4.&nbsp;<span class="emphasis"><em>main</em></span> for our code</div><div class="example-contents"><pre class="screen">if __name__ == "__main__":
    # Calculate the Julia set using a pure Python solution with
    # reasonable defaults for a laptop
    calc_pure_python(desired_width=1000, max_iterations=300)</pre></div></div><p>Once we run the code we see some output about the complexity of the problem:</p><pre class="programlisting"><code class="c"># running the above produces:</code>
<code class="n">Length</code> <code class="n">of</code> <code class="n">x</code><code class="p">:</code> <code class="mi">1000</code>
<code class="n">Total</code> <code class="n">elements</code><code class="p">:</code> <code class="mi">1000000</code>
<code class="n">calculate_z_serial_purepython</code> <code class="n">took</code> <code class="mf">12.3479790688</code> <code class="n">seconds</code></pre><p>In the false-color plot (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-example">Figure&nbsp;2-1</a>) the high-contrast color changes give us an idea of where the cost function is slow-changing or fast-changing. Here in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-example-greyscale">Figure&nbsp;2-3</a> we have a linear color map, black is quick to calculate and white is expensive to calculate.</p><div class="figure"><a id="FIG-julia-example-greyscale"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_example_greyscale.png" alt="Julia set at -0.62772-0.42193i" width="1000" height="1000" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_example_greyscale.png"></div></div><div class="figure-title">Figure&nbsp;2-3.&nbsp;Julia plot example using a pure greyscale.</div></div><p>By showing two representations of the same data we can see that lots of detail is lost in the linear mapping. Sometimes it can be useful to have various representations in mind when investigating the cost of a function.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_simple_approaches_to_timing_print_and_a_decorator">Simple approaches to timing - print and a decorator</h2></div></div></div><p>At the end of the code example above we see the output that is generated by several <code class="literal">print</code> statements. On Ian’s laptop this code takes approximately 12 seconds to run using CPython 2.7. It is useful to note that there is always some variation in execution time. You must observe the normal variation when you’re timing your code or you might incorrectly attribute an improvement in your code simply to a random variation in execution time.</p><p>Your computer will be running other tasks such as accessing the network, disk or RAM and these factors can cause variations in the execution time of your program.</p><p>Ian’s laptop is a Dell E6420 with an Intel Core I7-2720QM CPU (2.20GHz, 6MB cache, Quad Core) and 8GB of RAM running Ubuntu 13.10.</p><p>In <code class="literal">calc_pure_python</code> we can see several <code class="literal">print</code> statements. This is the simplest way to measure the execution time of a piece of code <span class="emphasis"><em>inside</em></span> a function. It is a very basic approach, despite being quick and dirty it can be very useful when you’re first looking at a piece of code.</p><p>Using <code class="literal">print</code> statements is commonplace when debugging and profiling code. It quickly becomes unmanageable but is useful for short investigations. Try to tidy them up when you’re done with them or they will clutter your <code class="literal">stdout</code>.</p><p>A slightly cleaner approach is to use a <code class="literal">decorator</code> - here we add 1 line of code above the function that we care about. Our <code class="literal">decorator</code> can be very simple and just replicate the effect of the <code class="literal">print</code> statements. Later we can make it more advanced.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-juliaset-timefn">Example&nbsp;2-5</a> we define a new function <code class="literal">timefn</code> which takes a function as an argument, the inner function <code class="literal">measure_time</code> takes <code class="literal">*args</code> (a variable number of positional arguments) and <code class="literal">**kwargs</code> (a variable number of key/value arguments) and passes them through to <code class="literal">fn</code> for execution. Around the execution of <code class="literal">fn</code> we capture <code class="literal">time.time()</code> and then <code class="literal">print</code> the result along with <code class="literal">fn.func_name</code>. The overhead of using this decorator is small but if you’re calling <code class="literal">fn</code> millions of times the overhead might become noticeable.</p><p>We use <code class="literal">@wraps(fn)</code> to expose the function name and docstring to the caller of the decorated function (otherwise we would see the function name and docstring for the decorator, not the function it decorates).</p><div class="example"><a id="profiling-juliaset-timefn"></a><div class="example-title">Example&nbsp;2-5.&nbsp;Defining a decorator to automate timing measurements</div><div class="example-contents"><pre class="screen">from functools import wraps

def timefn(fn):
    @wraps(fn)
    def measure_time(*args, **kwargs):
        t1 = time.time()
        result = fn(*args, **kwargs)
        t2 = time.time()
        print ("@timefn:" + fn.func_name + " took " + str(t2 - t1) + " seconds")
        return result
    return measure_time


@timefn
def calculate_z_serial_purepython(maxiter, zs, cs):
    ...</pre></div></div><p>When we run the above version (we keep the <code class="literal">print</code> statements from before) we can see that the execution time in the decorated version is very slightly quicker than the call from <code class="literal">calc_pure_python</code>, this is due to the overhead of calling a function (the difference is very tiny).</p><pre class="programlisting"><code class="n">Length</code> <code class="n">of</code> <code class="n">x</code><code class="p">:</code> <code class="mi">1000</code>
<code class="n">Total</code> <code class="n">elements</code><code class="p">:</code> <code class="mi">1000000</code>
<code class="nd">@timefn</code><code class="p">:</code><code class="n">calculate_z_serial_purepython</code> <code class="n">took</code> <code class="mf">12.2218790054</code> <code class="n">seconds</code>
<code class="n">calculate_z_serial_purepython</code> <code class="n">took</code> <code class="mf">12.2219250043</code> <code class="n">seconds</code></pre><div class="note"><h3 class="title">Note</h3><p>The addition of profiling information will inevitably slow your code down, some profiling options are very informative and induce a heavy speed penalty. The trade between profiling detail and speed will be something you have to consider.</p></div><p>We can use the <code class="literal">timeit</code> module as another way to get a coarse measurement of the execution speed of our function. More typically you would use this when timing different types of simple expressions as you experiment with ways to solve a problem. Here we can use it to time the execution time for our CPU-bound function.</p><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>Note that the <code class="literal">timeit</code> module temporarily disables the garbage collector, this might impact the speed you’ll see with real-world operations if the garbage collector would normally be invoked by your operation. See the Python documentation for help on this <sup>[<a id="id322178" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#ftn.id322178" class="footnote totri-footnote">5</a>]</sup>.</p></div><p>From the command line you can run <code class="literal">timeit</code> using:</p><p><code class="literal">$ python -m timeit -n 5 -r 5 -s "import julia1"
   "julia1.calc_pure_python(
   desired_width=1000,
   max_iterations=300)"</code></p><p>and note that you have to import the module as a setup step using <code class="literal">-s</code> as <code class="literal">calc_pure_python</code> is inside that module. <code class="literal">timeit</code> has some sensible defaults for short sections of code, for longer-running functions it can be sensible to specify the number of loops which are averaged (<code class="literal">-n 5</code>) and a number of repetitions of the loops (<code class="literal">-r 5</code>). The best result of all the repetitions is given as the answer, each result is an average of the loops in that test.</p><p>By default if I run <code class="literal">timeit</code> without specifying <code class="literal">-n</code> and <code class="literal">-r</code> then it runs 10 loops with 5 repetitions and this takes 6 minutes, so overriding the defaults can make sense if you want to get your results a little faster.</p><p>We’re only interested in the best case results as the average and worst case are probably a result of interference by other processes. Choosing the best of five repetitions of five averaged results should give us a fairly stable result. Try running the benchmark several times to check if you get varying results - you may need more repetitions to settle on a stable fastest-result time. There is no “correct” configuration - if you see a wide variation in your timing results then do more repetitions until your final result is stable.</p><pre class="programlisting"><code class="mi">5</code> <code class="n">loops</code><code class="p">,</code> <code class="n">best</code> <code class="n">of</code> <code class="mi">5</code><code class="p">:</code> <code class="mf">13.1</code> <code class="n">sec</code> <code class="n">per</code> <code class="n">loop</code></pre><p>The overall cost of calling <code class="literal">calc_pure_python</code> is 13.1 seconds (as the best case) whilst single calls to <code class="literal">calculate_z_serial_purepython</code> take 12.2 seconds as measured by the <code class="literal">@timefn</code> decorator. The difference is mainly the time taken to create the lists of <code class="literal">zs</code> and <code class="literal">cs</code>.</p><p>Inside <code class="literal">IPython</code> we can use the magic <code class="literal">%timeit</code> in the same way. If you are developing your code interactively in <code class="literal">IPython</code> and the functions are in the local namespace (probably because you’re using <code class="literal">%run</code>) then you can use:</p><pre class="programlisting"><code class="o">%</code><code class="n">timeit</code> <code class="n">calc_pure_python</code><code class="p">(</code><code class="n">desired_width</code><code class="o">=</code><code class="mi">1000</code><code class="p">,</code> <code class="n">max_iterations</code><code class="o">=</code><code class="mi">300</code><code class="p">)</code></pre><p>It is worth considering the variation in load that you get on a normal computer. Many background tasks are running (e.g. Dropbox, backups) that could impact the CPU and disk resources at random. Scripts in web pages can also cause unpredictable resource usage. <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-set-system-monitor-trimmed">Figure&nbsp;2-4</a> shows the single CPU being used at 100% for some of the timing steps above, the other cores on this machine are each lightly working on other tasks.</p><div class="figure"><a id="FIG-julia-set-system-monitor-trimmed"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 405; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_set_system_monitor_trimmed.png" alt="System Monitor (Ubuntu) showing background CPU usage during timings" width="883" height="254" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_set_system_monitor_trimmed.png"></div></div><div class="figure-title">Figure&nbsp;2-4.&nbsp;System Monitor on Ubuntu showing variation in background CPU usage whilst we time our function.</div></div><p>Occasionally the System Monitor shows spikes of activity on this machine, it is sensible to watch your System Monitor to check that nothing else is interfering with your critical resources (CPU, Disk, Network).</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_simple_timing_using_the_unix_time_command">Simple timing using the Unix time command</h2></div></div></div><p>We can step outside of Python for a moment to use a standard system utility on Unix-like systems. The following will record various views on the execution time of your program and it won’t care about the internal structure of your code. Note that we specifically use <code class="literal">/usr/bin/time</code> rather than <code class="literal">time</code> so we get the system’s <code class="literal">time</code> and not the simpler (and less useful) version built into our shell.</p><p>If you try <code class="literal">time --verbose</code> and you get an error, you’re probably looking at the shell’s built-in <code class="literal">time</code> command and not the system command.</p><pre class="programlisting"><code class="err">$</code> <code class="o">/</code><code class="n">usr</code><code class="o">/</code><code class="nb">bin</code><code class="o">/</code><code class="n">time</code> <code class="o">-</code><code class="n">p</code> <code class="n">python</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code>
<code class="n">Length</code> <code class="n">of</code> <code class="n">x</code><code class="p">:</code> <code class="mi">1000</code>
<code class="n">Total</code> <code class="n">elements</code><code class="p">:</code> <code class="mi">1000000</code>
<code class="n">calculate_z_serial_purepython</code> <code class="n">took</code> <code class="mf">12.7298331261</code> <code class="n">seconds</code>
<code class="n">real</code> <code class="mf">13.46</code>
<code class="n">user</code> <code class="mf">13.40</code>
<code class="n">sys</code> <code class="mf">0.04</code></pre><p>Using the <code class="literal">-p</code> portability flag we get three results:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">real</code> records the wall-clock or elapsed time
</li><li class="listitem">
<code class="literal">user</code> records the amount of time the CPU spent on your task outside of kernel functions
</li><li class="listitem">
<code class="literal">sys</code> records the time spent in kernel-level functions
</li></ul></div><p>By adding <code class="literal">user</code> and <code class="literal">sys</code> you get a sense of how much time was spent in the CPU. The difference between this and <code class="literal">real</code> might tell you about the amount of time waiting for I/O, it might also suggest that your system is busy running other tasks that are distorting your measurements.</p><p><code class="literal">time</code> is useful because it isn’t specific to Python. It includes the time taken starting the <code class="literal">python</code> executable which might be significant if you start lots of fresh processes (rather than having a long-running single process). If you often have short-running scripts where the start-up time is a significant part of the overall runtime then <code class="literal">time</code> can be a more useful measure.</p><p>We can add the <code class="literal">--verbose</code> flag to get even more output:</p><pre class="programlisting"><code class="err">$</code> <code class="o">/</code><code class="n">usr</code><code class="o">/</code><code class="nb">bin</code><code class="o">/</code><code class="n">time</code> <code class="o">--</code><code class="n">verbose</code> <code class="n">python</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code>
<code class="n">Length</code> <code class="n">of</code> <code class="n">x</code><code class="p">:</code> <code class="mi">1000</code>
<code class="n">Total</code> <code class="n">elements</code><code class="p">:</code> <code class="mi">1000000</code>
<code class="n">calculate_z_serial_purepython</code> <code class="n">took</code> <code class="mf">12.3145110607</code> <code class="n">seconds</code>
        <code class="n">Command</code> <code class="n">being</code> <code class="n">timed</code><code class="p">:</code> <code class="s">"python julia1_nopil.py"</code>
        <code class="n">User</code> <code class="n">time</code> <code class="p">(</code><code class="n">seconds</code><code class="p">):</code> <code class="mf">13.46</code>
        <code class="n">System</code> <code class="n">time</code> <code class="p">(</code><code class="n">seconds</code><code class="p">):</code> <code class="mf">0.05</code>
        <code class="n">Percent</code> <code class="n">of</code> <code class="n">CPU</code> <code class="n">this</code> <code class="n">job</code> <code class="n">got</code><code class="p">:</code> <code class="mi">99</code><code class="o">%</code>
        <code class="n">Elapsed</code> <code class="p">(</code><code class="n">wall</code> <code class="n">clock</code><code class="p">)</code> <code class="n">time</code> <code class="p">(</code><code class="n">h</code><code class="p">:</code><code class="n">mm</code><code class="p">:</code><code class="n">ss</code> <code class="ow">or</code> <code class="n">m</code><code class="p">:</code><code class="n">ss</code><code class="p">):</code> <code class="mi">0</code><code class="p">:</code><code class="mf">13.53</code>
        <code class="n">Average</code> <code class="n">shared</code> <code class="n">text</code> <code class="n">size</code> <code class="p">(</code><code class="n">kbytes</code><code class="p">):</code> <code class="mi">0</code>
        <code class="n">Average</code> <code class="n">unshared</code> <code class="n">data</code> <code class="n">size</code> <code class="p">(</code><code class="n">kbytes</code><code class="p">):</code> <code class="mi">0</code>
        <code class="n">Average</code> <code class="n">stack</code> <code class="n">size</code> <code class="p">(</code><code class="n">kbytes</code><code class="p">):</code> <code class="mi">0</code>
        <code class="n">Average</code> <code class="n">total</code> <code class="n">size</code> <code class="p">(</code><code class="n">kbytes</code><code class="p">):</code> <code class="mi">0</code>
        <code class="n">Maximum</code> <code class="n">resident</code> <code class="nb">set</code> <code class="n">size</code> <code class="p">(</code><code class="n">kbytes</code><code class="p">):</code> <code class="mi">131952</code>
        <code class="n">Average</code> <code class="n">resident</code> <code class="nb">set</code> <code class="n">size</code> <code class="p">(</code><code class="n">kbytes</code><code class="p">):</code> <code class="mi">0</code>
        <code class="n">Major</code> <code class="p">(</code><code class="n">requiring</code> <code class="n">I</code><code class="o">/</code><code class="n">O</code><code class="p">)</code> <code class="n">page</code> <code class="n">faults</code><code class="p">:</code> <code class="mi">0</code>
        <code class="n">Minor</code> <code class="p">(</code><code class="n">reclaiming</code> <code class="n">a</code> <code class="n">frame</code><code class="p">)</code> <code class="n">page</code> <code class="n">faults</code><code class="p">:</code> <code class="mi">58974</code>
        <code class="n">Voluntary</code> <code class="n">context</code> <code class="n">switches</code><code class="p">:</code> <code class="mi">3</code>
        <code class="n">Involuntary</code> <code class="n">context</code> <code class="n">switches</code><code class="p">:</code> <code class="mi">26</code>
        <code class="n">Swaps</code><code class="p">:</code> <code class="mi">0</code>
        <code class="n">File</code> <code class="n">system</code> <code class="n">inputs</code><code class="p">:</code> <code class="mi">0</code>
        <code class="n">File</code> <code class="n">system</code> <code class="n">outputs</code><code class="p">:</code> <code class="mi">1968</code>
        <code class="n">Socket</code> <code class="n">messages</code> <code class="n">sent</code><code class="p">:</code> <code class="mi">0</code>
        <code class="n">Socket</code> <code class="n">messages</code> <code class="n">received</code><code class="p">:</code> <code class="mi">0</code>
        <code class="n">Signals</code> <code class="n">delivered</code><code class="p">:</code> <code class="mi">0</code>
        <code class="n">Page</code> <code class="n">size</code> <code class="p">(</code><code class="nb">bytes</code><code class="p">):</code> <code class="mi">4096</code>
        <code class="n">Exit</code> <code class="n">status</code><code class="p">:</code> <code class="mi">0</code></pre><p>Probably the most useful indicator above is <code class="literal">Major (requiring I/O) page faults</code> as this indicates whether the operating system is having to load pages of data from the disk because it no longer resides in RAM. This will cause a speed penalty.</p><p>In our example the code and data requirement is small so no page faults occur. If you have a memory-bound process, or several programs that use variable and large amounts of RAM, you might find that this gives you a clue as to which program is slowed down by disk accesses at the operating system level because parts of it have been swapped out of RAM to disk.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="profiling-cprofile">Using the cProfile module</h2></div></div></div><p><code class="literal">cProfile</code> is a built-in profiling tool in the standard library. It hooks into the virtual machine in CPython to measure the time taken running every function that it sees. This introduces a greater overhead and you get more information as a result. Sometimes the additional information can lead to surprising insights into your code.</p><p><code class="literal">cProfile</code> is one of three profilers in the standard library (the others are <code class="literal">hotshot</code> and <code class="literal">profile</code>). <code class="literal">hotshot</code> is experimental code, <code class="literal">profile</code> is the original pure-Python profiler. <code class="literal">cProfile</code> has the same interface as <code class="literal">profile</code>, is supported and is the default profiling tool. If you’re curious about the history of these libraries see Armin Rigo’s request to include <code class="literal">cProfile</code> in the standard library from 2005 <sup>[<a id="id312621" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#ftn.id312621" class="footnote totri-footnote">6</a>]</sup>.</p><p>A good practice when profiling is to generate a <span class="emphasis"><em>hypothesis</em></span> about the speed of parts of your code before you profile it. Ian likes to print out the code snippet in question and to annotate it. Forming a hypothesis ahead of time means you can measure how wrong you are (you will get it wrong!) and improve your intuition about certain coding styles.</p><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>You should never avoid profiling in favor of a gut instinct (we warn you - you <span class="emphasis"><em>will</em></span> get it wrong!). It is definitely worth forming a hypothesis ahead of profiling to help you learn to spot possible slow choices in your code and always back up your choices with evidence.</p></div><p>Always be driven by results that you have measured and always start with some quick-and-dirty profiling to make sure you’re addressing the right area. There’s nothing more humbling than cleverly optimizing a section of code only to realise (hours or days later) that you’d missed the slowest part of the process and haven’t really addressed the underlying problem at all.</p><p>Our hypothesis: We know that <code class="literal">calculate_z_serial_purepython</code> is likely to be the slowest part of the code. In that function we do a lot of dereferencing and make many calls to basic arithmetic operators and the <code class="literal">abs</code> function. These will probably show up as consumers of CPU resources.</p><p>Below we’ll use the <code class="literal">cProfile</code> module to run a variant of the code. The output is spartan but helps us figure out where to analyse further.</p><p>The <code class="literal">-s cumulative</code> flag tells <code class="literal">cProfile</code> to sort by cumulative time spent inside each function - this gives us a view into the slowest parts of a section of code. The <code class="literal">cProfile</code> output is written to screen directly after our usual <code class="literal">print</code> results.</p><pre class="programlisting"><code class="err">$</code> <code class="n">python</code> <code class="o">-</code><code class="n">m</code> <code class="n">cProfile</code> <code class="o">-</code><code class="n">s</code> <code class="n">cumulative</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code>
<code class="o">...</code>
         <code class="mi">36221992</code> <code class="n">function</code> <code class="n">calls</code> <code class="ow">in</code> <code class="mf">19.664</code> <code class="n">seconds</code>

   <code class="n">Ordered</code> <code class="n">by</code><code class="p">:</code> <code class="n">cumulative</code> <code class="n">time</code>

   <code class="n">ncalls</code>  <code class="n">tottime</code>  <code class="n">percall</code>  <code class="n">cumtime</code>  <code class="n">percall</code> <code class="n">filename</code><code class="p">:</code><code class="n">lineno</code><code class="p">(</code><code class="n">function</code><code class="p">)</code>
        <code class="mi">1</code>    <code class="mf">0.034</code>    <code class="mf">0.034</code>   <code class="mf">19.664</code>   <code class="mf">19.664</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">1</code><code class="p">(</code><code class="o">&lt;</code><code class="n">module</code><code class="o">&gt;</code><code class="p">)</code>
        <code class="mi">1</code>    <code class="mf">0.843</code>    <code class="mf">0.843</code>   <code class="mf">19.630</code>   <code class="mf">19.630</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>
        <code class="mi">1</code>   <code class="mf">14.121</code>   <code class="mf">14.121</code>   <code class="mf">18.627</code>   <code class="mf">18.627</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">9</code>
                                              <code class="p">(</code><code class="n">calculate_z_serial_purepython</code><code class="p">)</code>
 <code class="mi">34219980</code>    <code class="mf">4.487</code>    <code class="mf">0.000</code>    <code class="mf">4.487</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="nb">abs</code><code class="p">}</code>
  <code class="mi">2002000</code>    <code class="mf">0.150</code>    <code class="mf">0.000</code>    <code class="mf">0.150</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="n">method</code> <code class="s">'append'</code> <code class="n">of</code> <code class="s">'list'</code> <code class="n">objects</code><code class="p">}</code>
        <code class="mi">1</code>    <code class="mf">0.019</code>    <code class="mf">0.019</code>    <code class="mf">0.019</code>    <code class="mf">0.019</code> <code class="p">{</code><code class="nb">range</code><code class="p">}</code>
        <code class="mi">1</code>    <code class="mf">0.010</code>    <code class="mf">0.010</code>    <code class="mf">0.010</code>    <code class="mf">0.010</code> <code class="p">{</code><code class="nb">sum</code><code class="p">}</code>
        <code class="mi">2</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">}</code>
        <code class="mi">4</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="nb">len</code><code class="p">}</code>
        <code class="mi">1</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="n">method</code> <code class="s">'disable'</code> <code class="n">of</code>
                                               <code class="s">'_lsprof.Profiler'</code> <code class="n">objects</code><code class="p">}</code></pre><p>Sorting by cumulative time gives us an idea about where the majority of execution time is spent. The above result shows us that 36221992 function calls occurred in just over 19 seconds (this time includes the overhead of using <code class="literal">cProfile</code>). Previously our code took around 13 seconds to execute - we’ve just added a 5 second penalty by measuring how long each function takes to execute.</p><p>We can see that the entry point to the code <code class="literal">julia1_cprofile.py</code> on line 1 takes a total of 19 seconds, this is just the <code class="literal">__main__</code> call to <code class="literal">calc_pure_python</code>. <code class="literal">ncalls</code> is 1, this line is only executed once.</p><p>Inside <code class="literal">calc_pure_python</code> the call to <code class="literal">calculate_z_serial_purepython</code> consumes 18.6 seconds, both functions are only called once. We can derive that approximately 1 second is spent on lines of code inside <code class="literal">calc_pure_python</code> separate to calling the CPU intensive <code class="literal">calculate_z_serial_purepython</code> function. We can’t derive <span class="emphasis"><em>which</em></span> lines however take the time inside the function using <code class="literal">cProfile</code>.</p><p>Inside <code class="literal">calculate_z_serial_purepython</code> the time spent on lines of code (without calling other functions) is 14.1 seconds. This function makes 34,219,980 calls to <code class="literal">abs</code> which take a total of 4.4 seconds along with some other calls which do not cost much time.</p><p>What about the <code class="literal">{abs}</code> call? This line is measuring the individual calls to the <code class="literal">abs</code> function inside <code class="literal">calculate_z_serial_purepython</code>. Whilst the per-call cost is negligible (it is recorded as 0.000 seconds) the total time for 34,219,980 calls is 4.4 seconds. We couldn’t predict in advance exactly how many calls would be made to <code class="literal">abs</code> as the Julia function has non-predictable dynamics (that’s why it is so interesting to look at).</p><p>At best we could have said that it will be called a minimum of 1,000,000 times as we’re calculating <code class="literal">1000*1000</code> pixels. At most it would be 300,000,000 as we calculate 1,000,000 pixels with a maximum of 300 iterations. 34 million calls is roughly 10% of the worst case.</p><p>If we looked at the original greyscale image and in our mind’s eye we squashed the white parts together and into a corner, we can estimate that the expensive white region accounts for roughly 10% of the rest of the image.</p><p>The next line in the profiled output <code class="literal">{method 'append' of 'list' objects}</code> details the creation of 2,002,000 list items.</p><div class="tip"><h3 class="title">Tip</h3><p>Why 2,002,000 items? Before you read below think about how many list items are being constructed.</p></div><p>This creation of the 2,002,000 items is occurring in <code class="literal">calc_pure_python</code> during the setup phase.</p><p>The <code class="literal">zs</code> and <code class="literal">cs</code> will be <code class="literal">1000*1000</code> items each and these are built from a list of 1,000 <code class="literal">x</code> and 1,000 <code class="literal">y</code> co-ordinates, in total this is 2,002,000 calls to append.</p><p>It is important to note that this <code class="literal">cProfile</code> output is not ordered by parent functions, it is summarising the expense of all functions in the executed block of code. Figuring out what is happening on a line-by-line basis is very hard with <code class="literal">cProfile</code> as we only get profile information for the function calls themselves, not each line within the function.</p><p>Inside <code class="literal">calculate_z_serial_purepython</code> we can now account for <code class="literal">{abs}</code> and <code class="literal">{range}</code> and in total these two functions cost approximately 4.5 seconds. We know that <code class="literal">calculate_z_serial_purepython</code> costs 18.6 seconds.</p><p>The final line of the profiling output refers to <code class="literal">lsprof</code> - this is the original name of the tool that evolved into <code class="literal">cProfile</code> and can be ignored.</p><p>To get some more control over the results of <code class="literal">cProfile</code> we can write a statistics file and then analyse it in Python:</p><p><code class="literal">$ python -m cProfile -o profile.stats julia1.py</code></p><p>We can load this into Python with the following, it’ll give us the same cumulative time report as before:</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">pstats</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">p</code> <code class="o">=</code> <code class="n">pstats</code><code class="o">.</code><code class="n">Stats</code><code class="p">(</code><code class="s">"profile.stats"</code><code class="p">)</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">p</code><code class="o">.</code><code class="n">sort_stats</code><code class="p">(</code><code class="s">"cumulative"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="o">&lt;</code><code class="n">pstats</code><code class="o">.</code><code class="n">Stats</code> <code class="n">instance</code> <code class="n">at</code> <code class="mh">0x177dcf8</code><code class="o">&gt;</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="n">p</code><code class="o">.</code><code class="n">print_stats</code><code class="p">()</code>
<code class="n">Tue</code> <code class="n">Jan</code>  <code class="mi">7</code> <code class="mi">21</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mi">56</code> <code class="mi">2014</code>    <code class="n">profile</code><code class="o">.</code><code class="n">stats</code>

         <code class="mi">36221992</code> <code class="n">function</code> <code class="n">calls</code> <code class="ow">in</code> <code class="mf">19.983</code> <code class="n">seconds</code>

   <code class="n">Ordered</code> <code class="n">by</code><code class="p">:</code> <code class="n">cumulative</code> <code class="n">time</code>

   <code class="n">ncalls</code>  <code class="n">tottime</code>  <code class="n">percall</code>  <code class="n">cumtime</code>  <code class="n">percall</code> <code class="n">filename</code><code class="p">:</code><code class="n">lineno</code><code class="p">(</code><code class="n">function</code><code class="p">)</code>
        <code class="mi">1</code>    <code class="mf">0.033</code>    <code class="mf">0.033</code>   <code class="mf">19.983</code>   <code class="mf">19.983</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">1</code><code class="p">(</code><code class="o">&lt;</code><code class="n">module</code><code class="o">&gt;</code><code class="p">)</code>
        <code class="mi">1</code>    <code class="mf">0.846</code>    <code class="mf">0.846</code>   <code class="mf">19.950</code>   <code class="mf">19.950</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>
        <code class="mi">1</code>   <code class="mf">13.585</code>   <code class="mf">13.585</code>   <code class="mf">18.944</code>   <code class="mf">18.944</code> <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">9</code><code class="p">(</code><code class="n">calculate_z_serial_purepython</code><code class="p">)</code>
 <code class="mi">34219980</code>    <code class="mf">5.340</code>    <code class="mf">0.000</code>    <code class="mf">5.340</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="nb">abs</code><code class="p">}</code>
  <code class="mi">2002000</code>    <code class="mf">0.150</code>    <code class="mf">0.000</code>    <code class="mf">0.150</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="n">method</code> <code class="s">'append'</code> <code class="n">of</code> <code class="s">'list'</code> <code class="n">objects</code><code class="p">}</code>
        <code class="mi">1</code>    <code class="mf">0.019</code>    <code class="mf">0.019</code>    <code class="mf">0.019</code>    <code class="mf">0.019</code> <code class="p">{</code><code class="nb">range</code><code class="p">}</code>
        <code class="mi">1</code>    <code class="mf">0.010</code>    <code class="mf">0.010</code>    <code class="mf">0.010</code>    <code class="mf">0.010</code> <code class="p">{</code><code class="nb">sum</code><code class="p">}</code>
        <code class="mi">2</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">}</code>
        <code class="mi">4</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="nb">len</code><code class="p">}</code>
        <code class="mi">1</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code> <code class="p">{</code><code class="n">method</code> <code class="s">'disable'</code> <code class="n">of</code>
                                               <code class="s">'_lsprof.Profiler'</code> <code class="n">objects</code><code class="p">}</code></pre><p>To trace which functions we’re profiling we can print the caller information. In the following two listings we can see that <code class="literal">calculate_z_serial_purepython</code> is the most expensive function and it is called from one place. If it was called from many places, these listings might help us narrow down the location of the most expensive parents:</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">5</code><code class="p">]:</code> <code class="n">p</code><code class="o">.</code><code class="n">print_callers</code><code class="p">()</code>
   <code class="n">Ordered</code> <code class="n">by</code><code class="p">:</code> <code class="n">cumulative</code> <code class="n">time</code>

<code class="n">Function</code>                                <code class="n">was</code> <code class="n">called</code> <code class="n">by</code><code class="o">...</code>
                                                 <code class="n">ncalls</code>  <code class="n">tottime</code>  <code class="n">cumtime</code>
<code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">1</code><code class="p">(</code><code class="o">&lt;</code><code class="n">module</code><code class="o">&gt;</code><code class="p">)</code>                   <code class="o">&lt;-</code>
<code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>          <code class="o">&lt;-</code>       <code class="mi">1</code>    <code class="mf">0.846</code>   <code class="mf">19.950</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">1</code><code class="p">(</code><code class="o">&lt;</code><code class="n">module</code><code class="o">&gt;</code><code class="p">)</code>
<code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">9</code><code class="p">(</code><code class="n">calculate_z_serial_purepython</code><code class="p">)</code>  <code class="o">&lt;-</code>       <code class="mi">1</code>   <code class="mf">13.585</code>   <code class="mf">18.944</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>
<code class="p">{</code><code class="nb">abs</code><code class="p">}</code>                                         <code class="o">&lt;-</code> <code class="mi">34219980</code>    <code class="mf">5.340</code>    <code class="mf">5.340</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">9</code><code class="p">(</code><code class="n">calculate_</code><code class="o">...</code><code class="n">_purepython</code><code class="p">)</code>
<code class="p">{</code><code class="n">method</code> <code class="s">'append'</code> <code class="n">of</code> <code class="s">'list'</code> <code class="n">objects</code><code class="p">}</code>           <code class="o">&lt;-</code> <code class="mi">2002000</code>    <code class="mf">0.150</code>    <code class="mf">0.150</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>
<code class="p">{</code><code class="nb">range</code><code class="p">}</code>                                       <code class="o">&lt;-</code>       <code class="mi">1</code>    <code class="mf">0.019</code>    <code class="mf">0.019</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">9</code><code class="p">(</code><code class="n">calculate_</code><code class="o">...</code><code class="n">_purepython</code><code class="p">)</code>
<code class="p">{</code><code class="nb">sum</code><code class="p">}</code>                                         <code class="o">&lt;-</code>       <code class="mi">1</code>    <code class="mf">0.010</code>    <code class="mf">0.010</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>
<code class="p">{</code><code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">}</code>                                   <code class="o">&lt;-</code>       <code class="mi">2</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>
<code class="p">{</code><code class="nb">len</code><code class="p">}</code>                                         <code class="o">&lt;-</code>       <code class="mi">2</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">9</code><code class="p">(</code><code class="n">calculate_</code><code class="o">...</code><code class="n">_purepython</code><code class="p">)</code>
                                                       <code class="mi">2</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>
                                                  <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>
<code class="p">{</code><code class="n">method</code> <code class="s">'disable'</code> <code class="n">of</code> <code class="s">'_lsprof.Profiler'</code> <code class="n">objects</code><code class="p">}</code>  <code class="o">&lt;-</code></pre><p>We can flip this around the other way to show which functions call other functions:</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">6</code><code class="p">]:</code> <code class="n">p</code><code class="o">.</code><code class="n">print_callees</code><code class="p">()</code>
   <code class="n">Ordered</code> <code class="n">by</code><code class="p">:</code> <code class="n">cumulative</code> <code class="n">time</code>

<code class="n">Function</code>                                          <code class="n">called</code><code class="o">...</code>
                                                      <code class="n">ncalls</code>  <code class="n">tottime</code>  <code class="n">cumtime</code>
<code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">1</code><code class="p">(</code><code class="o">&lt;</code><code class="n">module</code><code class="o">&gt;</code><code class="p">)</code>                       <code class="o">-&gt;</code>       <code class="mi">1</code>    <code class="mf">0.846</code>   <code class="mf">19.950</code>
                                                      <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>
<code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">23</code><code class="p">(</code><code class="n">calc_pure_python</code><code class="p">)</code>              <code class="o">-&gt;</code>       <code class="mi">1</code>   <code class="mf">13.585</code>   <code class="mf">18.944</code>
                                                      <code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">9</code><code class="p">(</code><code class="n">calculate_</code><code class="o">...</code><code class="n">_purepython</code><code class="p">)</code>
                                                           <code class="mi">2</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>
                                                      <code class="p">{</code><code class="nb">len</code><code class="p">}</code>
                                                     <code class="mi">2002000</code>    <code class="mf">0.150</code>    <code class="mf">0.150</code>
                                                      <code class="p">{</code><code class="n">method</code> <code class="s">'append'</code> <code class="n">of</code> <code class="s">'list'</code> <code class="n">objects</code><code class="p">}</code>
                                                           <code class="mi">1</code>    <code class="mf">0.010</code>    <code class="mf">0.010</code>
                                                      <code class="p">{</code><code class="nb">sum</code><code class="p">}</code>
                                                           <code class="mi">2</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>
                                                      <code class="p">{</code><code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">}</code>
<code class="n">julia1_nopil</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">9</code><code class="p">(</code><code class="n">calculate_z_serial_purepython</code><code class="p">)</code>  <code class="o">-&gt;</code> <code class="mi">34219980</code>    <code class="mf">5.340</code>    <code class="mf">5.340</code>
                                                      <code class="p">{</code><code class="nb">abs</code><code class="p">}</code>
                                                           <code class="mi">2</code>    <code class="mf">0.000</code>    <code class="mf">0.000</code>
                                                      <code class="p">{</code><code class="nb">len</code><code class="p">}</code>
                                                           <code class="mi">1</code>    <code class="mf">0.019</code>    <code class="mf">0.019</code>
                                                      <code class="p">{</code><code class="nb">range</code><code class="p">}</code>
<code class="p">{</code><code class="nb">abs</code><code class="p">}</code>                                             <code class="o">-&gt;</code>
<code class="p">{</code><code class="n">method</code> <code class="s">'append'</code> <code class="n">of</code> <code class="s">'list'</code> <code class="n">objects</code><code class="p">}</code>               <code class="o">-&gt;</code>
<code class="p">{</code><code class="nb">range</code><code class="p">}</code>                                           <code class="o">-&gt;</code>
<code class="p">{</code><code class="nb">sum</code><code class="p">}</code>                                             <code class="o">-&gt;</code>
<code class="p">{</code><code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">}</code>                                       <code class="o">-&gt;</code>
<code class="p">{</code><code class="nb">len</code><code class="p">}</code>                                             <code class="o">-&gt;</code>
<code class="p">{</code><code class="n">method</code> <code class="s">'disable'</code> <code class="n">of</code> <code class="s">'_lsprof.Profiler'</code> <code class="n">objects</code><code class="p">}</code>  <code class="o">-&gt;</code></pre><p><code class="literal">cProfile</code> is rather verbose and you need a side screen to see it without lots of word-wrap. Since it is built-in it is a convenient tool for quickly identifying bottlenecks. Tools like <code class="literal">line_profiler</code>, <code class="literal">heapy</code> and <code class="literal">memory_profiler</code> which we discuss later in this chapter will then help you to drill-down to the specific lines that you should pay attention to.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_runsnakerun_to_visualise_cprofile_output">runsnakerun to visualise cProfile output</h2></div></div></div><p><code class="literal">runsnake</code> is a visualisation tool for the profile statistics created by <code class="literal">cProfile</code> - you can quickly get a sense of which functions are most expensive just by looking at the diagram that’s generated.</p><p>Use <code class="literal">runsnake</code> to get a high level understanding of a <code class="literal">cProfile</code> statistics file especially when you’re investigating a new and large code-base, it’ll give you a feel for the areas that you should focus on. It might also reveal areas that you hadn’t realized would be expensive so it might highlight some quick wins for you to focus on.</p><p>You can also use it when discussing the slow areas of code in a team as it is easy to discuss the results.</p><p>Installation: <code class="literal">pip install runsnake</code></p><p>Note that it requires <code class="literal">wxPython</code> and this can be a pain to install into a <code class="literal">virtualenv</code>. Ian has resorted to installing this globally on more than one occasion just to analyse a profile file, rather than to try to get it running in a <code class="literal">virtualenv</code>.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-set-runsnakerun">Figure&nbsp;2-5</a> we have the visual plot of the previous <code class="literal">cProfile</code> data. The visual inspection should make it easier to quickly understand that <code class="literal">calculate_z_serial_purepython</code> takes the majority of the time and that only a part of the execution time is due to calling other functions (the only one that is significant is <code class="literal">abs</code>). Visually you can see that there’s little point investing time in the setup routine as the vast majority of the execution time is in the calculation routine.</p><div class="figure"><a id="FIG-julia-set-runsnakerun"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 459; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_set_runsnakerun.png" alt="RunSnakeRun" width="1000" height="681" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_set_runsnakerun.png"></div></div><div class="figure-title">Figure&nbsp;2-5.&nbsp;RunSnakeRun visualising a cProfile profile file.</div></div><p>With <code class="literal">runsnake</code> you can click into functions and drill into complex nested calls. When discussing the reasons for slow execution in a piece of code in a team this tool is invaluable.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="profiling-line-profiler">line_profiler for line-by-line measurements</h2></div></div></div><p>In Ian’s opinion Robert Kern’s line_profiler is the strongest tool for identifying the cause of CPU-bound problems in Python code. It works by profiling individual functions on a line-by-line basis so you should start with <code class="literal">cProfile</code> and use the high-level view to guide which functions to profile with <code class="literal">line_profiler</code>.</p><p>It is worthwhile printing and annotating versions of the output from this tool as you modify your code so you have a record of changes (successful or not) that you can quickly refer to. Don’t rely on your memory when you’re working on line-by-line changes.</p><p>Installation: <code class="literal">pip install line_profiler</code></p><p>A decorator (<code class="literal">@profile</code>) is used to mark the chosen function. The <code class="literal">kernprof.py</code> script is used to execute your code, the CPU time and other statistics for each line of the chosen function are recorded.</p><div class="note"><h3 class="title">Note</h3><p>The requirement to modify the source code is a minor annoyance as the addition of a decorator will break your unit tests unless you make a dummy decorator - see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#no_op_profile_decorator">No-op @profile decorator</a> later in this chapter.</p></div><p>The arguments are <code class="literal">-l</code> for line-by-line (rather than function level) profiling and <code class="literal">-v</code> for a verbose output. Without <code class="literal">-v</code> you receive an <code class="literal">.lprof</code> output which you can later analyse with the <code class="literal">line_profiler</code> module. Below in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-kernprof-run1">Example&nbsp;2-6</a> we’ll do a full run on our CPU-bound function.</p><div class="example"><a id="profiling-kernprof-run1"></a><div class="example-title">Example&nbsp;2-6.&nbsp;Running kernprof with line-by-line output on a decorated function to record the CPU cost of each line’s execution</div><div class="example-contents"><pre class="screen">$ kernprof.py -l -v julia1_lineprofiler.py
...
Wrote profile results to julia1_lineprofiler.py.lprof
Timer unit: 1e-06 s

File: julia1_lineprofiler.py
Function: calculate_z_serial_purepython at line 9
Total time: 100.81 s

Line #      Hits   Per Hit   % Time  Line Contents
==================================================
     9                               @profile
    10                               def calculate_z_serial_purepython(maxiter, zs, cs):
    11                                   """Calculate output list using
                                         Julia update rule"""
    12         1    6870.0      0.0      output = [0] * len(zs)
    13   1000001       0.8      0.8      for i in range(len(zs)):
    14   1000000       0.8      0.8          n = 0
    15   1000000       0.8      0.8          z = zs[i]
    16   1000000       0.8      0.8          c = cs[i]
    17  34219980       1.1     36.2          while abs(z) &lt; 2 and n &lt; maxiter:
    18  33219980       1.0     32.6              z = z * z + c
    19  33219980       0.8     27.2              n += 1
    20   1000000       0.9      0.9          output[i] = n
    21         1       4.0      0.0      return output</pre></div></div><p>Introducing <code class="literal">kernprof.py</code> adds a substational time cost to the run time. In the above example <code class="literal">calculate_z_serial_purepython</code> takes 100 seconds, this is up from 13 seconds using simple <code class="literal">print</code> statements and 19 seconds using <code class="literal">cProfile</code>. The gain is that we get a line-by-line breakdown of where the time is spent inside the function.</p><p>The <code class="literal">% Time</code> column is the most helpful - we can see that 36% of the time is spent on the <code class="literal">while</code> testing. We don’t know whether the first statement (<code class="literal">abs(z) &lt; 2</code>) is more expensive than the second (<code class="literal">n &lt; maxiter</code>). Inside the loop we see that the update to <code class="literal">z</code> is also fairly expensive. Even <code class="literal">n += 1</code> is expensive! Python’s dynamic lookup machinery is at work for every loop even though we’re using the same types for each variable in each loop - this is where compiling and type specialization (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html">Chapter&nbsp;7</a>) give us a massive win. The creation of the <code class="literal">output</code> list and the updates on line 20 are relatively cheap compared to the cost of the <code class="literal">while</code> loop.</p><p>The obvious way to further analyse the <code class="literal">while</code> statement is to break it up. Whilst there has been some discussion in the Python community around the idea of re-writing the <code class="literal">pyc</code> files with more detailed information for multi-part single line statements, we are unaware of any production tools that offer a more fine-grained analysis than <code class="literal">line_profiler</code>.</p><p>Below in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-kernprof-run2">Example&nbsp;2-7</a> we break the <code class="literal">while</code> logic into several statements. This additional complexity will increase the run time of the function as we have more lines of code to execute and it <span class="emphasis"><em>might</em></span> help us to understand the costs incurred in this part of the code.</p><div class="tip"><h3 class="title">Tip</h3><p><span class="emphasis"><em>Before you look at the code</em></span> - do you think we’ll learn about the costs of the fundamental operations this way? Might other factors complicate the analysis?</p></div><div class="example"><a id="profiling-kernprof-run2"></a><div class="example-title">Example&nbsp;2-7.&nbsp;Breaking the compound while statement into individual statements to record the cost of each part of the original parts</div><div class="example-contents"><pre class="screen">$ kernprof.py -l -v julia1_lineprofiler2.py
...
Wrote profile results to julia1_lineprofiler2.py.lprof
Timer unit: 1e-06 s

File: julia1_lineprofiler2.py
Function: calculate_z_serial_purepython at line 9
Total time: 184.739 s

Line #      Hits    Per Hit   % Time  Line Contents
===================================================
     9                                @profile
    10                                def calculate_z_serial_purepython(maxiter, zs, cs):
    11                                    """Calculate output list using
                                          Julia update rule"""
    12         1     6831.0      0.0      output = [0] * len(zs)
    13   1000001        0.8      0.4      for i in range(len(zs)):
    14   1000000        0.8      0.4          n = 0
    15   1000000        0.9      0.5          z = zs[i]
    16   1000000        0.8      0.4          c = cs[i]
    17  34219980        0.8     14.9          while True:
    18  34219980        1.0     19.0              not_yet_escaped = abs(z) &lt; 2
    19  34219980        0.8     15.5              iterations_left = n &lt; maxiter
    20  34219980        0.8     15.1              if not_yet_escaped
                                                      and iterations_left:
    21  33219980        1.0     17.5                  z = z * z + c
    22  33219980        0.9     15.3                  n += 1
    23                                            else:
    24   1000000        0.8      0.4                  break
    25   1000000        0.9      0.5          output[i] = n
    26         1        5.0      0.0      return output</pre></div></div><p>This version takes 184 seconds to execute whilst the previous version took 100 seconds. Other factors <span class="emphasis"><em>did</em></span> complicate the analysis. In this case having extra statements that have to be executed 34,219,980 times each slows down the code. If we hadn’t used <code class="literal">kernprof.py</code> to investigate the line-by-line effect of this change we might have drawn other conclusions about the reason for the slowdown as we’d have lacked the necessary evidence.</p><p>At this point it makes sense to step back to the earlier <code class="literal">timeit</code> technique to test the cost of individual expressions.</p><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="n">z</code> <code class="o">=</code> <code class="mi">0</code><code class="o">+</code><code class="mi">0j</code>  <code class="c"># a point in the middle of our image</code>
<code class="o">&gt;&gt;&gt;</code> <code class="o">%</code><code class="n">timeit</code> <code class="nb">abs</code><code class="p">(</code><code class="n">z</code><code class="p">)</code> <code class="o">&lt;</code> <code class="mi">2</code>  <code class="c"># tested inside IPython</code></pre><pre class="screen">10000000 loops, best of 3: 119 ns per loop</pre><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="n">n</code> <code class="o">=</code> <code class="mi">1</code>
<code class="o">&gt;&gt;&gt;</code> <code class="n">maxiter</code> <code class="o">=</code> <code class="mi">300</code>
<code class="o">&gt;&gt;&gt;%</code><code class="n">timeit</code> <code class="n">n</code> <code class="o">&lt;</code> <code class="n">maxiter</code></pre><pre class="screen">10000000 loops, best of 3: 77 ns per loop</pre><p>From this simple analysis it looks as though the logic test on <code class="literal">n</code> is almost two times faster than the call to <code class="literal">abs</code>. Since the order of evaluation for Python statements is both left-to-right and opportunistic it makes sense to put the cheapest test on the left side of the equation. On every 1 in 301 tests for each co-ordinate the <code class="literal">n &lt; maxiter</code> test will be <code class="literal">False</code> so Python wouldn’t need to evaluate the other side of the <code class="literal">and</code> operator.</p><p>We never know whether <code class="literal">abs(z) &lt; 2</code> will be false until we evaluate it and our earlier observations for this region of the complex plane suggest it is <code class="literal">True</code> around 10% of the time for all 300 iterations. If we wanted to have a strong understanding of the time complexity of this part of the code it would make sense to continue the numerical analysis. In this situation however we want an easy check to see if we can get a quick win.</p><p>We can form a new hypothesis stating “by swapping the order of the operators in the <code class="literal">while</code> statement we will achieve a reliable speed-up”. We <span class="emphasis"><em>can</em></span> test this hypothesis using <code class="literal">kernprof.py</code> but the additional overheads of profiling this way might add too much noise. Instead we can use an earlier version of the code, running a test comparing these two versions with <code class="literal">while abs(z) &lt; 2 and n &lt; maxiter:</code> against <code class="literal">while n &lt; maxiter and abs(z) &lt; 2:</code>.</p><p>The result was a fairly stable improvement of approximately 0.4 seconds. This result is obviously minor and is very problem specific, using a more suitable approach to solve this problem (e.g. swapping to use Cython or PyPy - see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html">Chapter&nbsp;7</a>) would yield greater gains.</p><p>We can be confident in our result because:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
we stated a hypothesis that was easy to test
</li><li class="listitem">
we changed our code so that only the hypothesis would be tested (never test two things at once!)
</li><li class="listitem">
we gathered enough evidence to support our conclusion
</li></ul></div><p>For completeness we can run a final <code class="literal">kernprof.py</code> on the two main functions including our optimization to confirm that we have a complete picture of the overall complexity of our code:</p><div class="example"><a id="profiling-kernprof-run3"></a><div class="example-title">Example&nbsp;2-8.&nbsp;Swapping the order of the compound while statement to make the test fractionally faster</div><div class="example-contents"><pre class="screen">$ kernprof.py -l -v julia1_lineprofiler3.py
...
Wrote profile results to julia1_lineprofiler3.py.lprof
Timer unit: 1e-06 s

File: julia1_lineprofiler3.py
Function: calculate_z_serial_purepython at line 9
Total time: 99.7097 s

Line #      Hits   Per Hit   % Time  Line Contents
==================================================
     9                               @profile
    10                               def calculate_z_serial_purepython(maxiter,
                                                                       zs, cs):
    11                                   """Calculate output list using
                                         Julia update rule"""
    12         1    6831.0      0.0      output = [0] * len(zs)
    13   1000001       0.8      0.8      for i in range(len(zs)):
    14   1000000       0.8      0.8          n = 0
    15   1000000       0.9      0.9          z = zs[i]
    16   1000000       0.8      0.8          c = cs[i]
    17  34219980       1.0     35.9          while n &lt; maxiter and abs(z) &lt; 2:
    18  33219980       1.0     32.0              z = z * z + c
    19  33219980       0.8     27.9              n += 1
    20   1000000       0.9      0.9          output[i] = n
    21         1       5.0      0.0      return output</pre></div></div><p>Having swapped the two components of the <code class="literal">while</code> test on line 17 in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-kernprof-run3">Example&nbsp;2-8</a> we see a modest improvement from 36.1% of the execution time to 35.9% (this result was stable over repeated runs).</p><div class="example"><a id="profiling-kernprof-run4"></a><div class="example-title">Example&nbsp;2-9.&nbsp;Testing the line-by-line costs of the setup routine</div><div class="example-contents"><pre class="screen">File: julia1_lineprofiler3.py
Function: calc_pure_python at line 24
Total time: 195.218 s

Line #      Hits   Per Hit   % Time  Line Contents
==================================================
    24                               @profile
    25                               def calc_pure_python(draw_output,
                                                          desired_width, max_iterations):
...
    44         1       1.0      0.0      zs = []
    45         1       1.0      0.0      cs = []
    46      1001       1.1      0.0      for ycoord in y:
    47   1001000       1.1      0.5          for xcoord in x:
    48   1000000       1.5      0.8              zs.append(
                                                        complex(xcoord, ycoord))
    49   1000000       1.6      0.8              cs.append(
                                                        complex(c_real, c_imag))
    50
    51         1      51.0      0.0      print "Length of x:", len(x)
    52         1      11.0      0.0      print "Total elements:", len(zs)
    53         1       6.0      0.0      start_time = time.time()
    54         1  191031307.0     97.9   output =
                                           calculate_z_serial_purepython
                                           (max_iterations, zs, cs)
    55         1       4.0      0.0      end_time = time.time()
    56         1       2.0      0.0      secs = end_time - start_time
    57         1      58.0      0.0      print calculate_z_serial_purepython
                                           .func_name + " took", secs, "seconds"
    58
                                         # this sum is expected for 1000^2 grid with 300 iterations
    59         1    9799.0      0.0      assert sum(output) == 33219980</pre></div></div><p>As expected in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-kernprof-run4">Example&nbsp;2-9</a> <code class="literal">calculate_z_serial_purepython</code> takes most (97%) of the time of its parent function. The <code class="literal">list</code> creation steps are minor in comparison.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="memory_profiler">memory_profiler for diagnosing memory usage</h2></div></div></div><p>Just as Robert Kern’s <code class="literal">line_profiler</code> package measures CPU usage, the <code class="literal">memory_profiler</code> module by Fabian Pedregosa and Philippe Gervais measures memory usage on a line-by-line basis. By understanding the memory usage characteristics of your code you could ask yourself two questions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Could we use <span class="emphasis"><em>less</em></span> RAM by re-writing this function to work more efficiently?
</li><li class="listitem">
Could we use <span class="emphasis"><em>more</em></span> RAM and save CPU cycles by caching?
</li></ul></div><p><code class="literal">memory_profiler</code> operates in a very similar way to <code class="literal">line_profiler</code> but runs far more slowly. If you install the <code class="literal">psutil</code> package (optional but recommended) then <code class="literal">memory_profiler</code> will run faster. Memory profiling may easily make your code run 10 to 100 times slower. In practice you will probably use <code class="literal">memory_profiler</code> occasionally and <code class="literal">line_profiler</code> (for CPU profiling) more frequently.</p><p>Installation: <code class="literal">pip install memory_profiler</code> (and optionally <code class="literal">pip install psutil</code>)</p><p>As mentioned above the implementation of <code class="literal">memory_profiler</code> is not as performant as the implementation of <code class="literal">line_profiler</code>, it may make sense to run your tests on a smaller problem which completes in a useful amount of time. Overnight runs might be sensible for validation but you need quick and reasonable iterations to diagnose problems and hypothesise solutions.</p><div class="note"><h3 class="title">Note</h3><p>The requirement to modify the source code is a minor annoyance as the addition of a decorator will break your unit tests unless you make a dummy decorator - see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#no_op_profile_decorator">No-op @profile decorator</a> later in this chapter.</p></div><p>The code in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-memoryprofiler1">Example&nbsp;2-10</a> uses the full 1000x1000 grid, the statistics took about 1.5 hours to collect on Ian’s laptop. When dealing with memory allocation you must be aware that the situation is not as clear-cut as it is with CPU usage.</p><p>Generally it is more efficient to over-allocate memory to a process into a local pool which can be used at leisure as memory allocation operations are relatively expensive. Garbage collection is not instant and so objects may be unavailable but still in the garbage collection pool for some time.</p><p>The outcome of this is that it is hard to really understand what is happening with memory usage and release inside a Python program as a line of code may not allocate a deterministic amount of memory <span class="emphasis"><em>as observed from outside the process</em></span>. Observing the gross trend over a set of lines is likely to lead to better insight than observing the behaviour of just one line.</p><p>Inside <code class="literal">calculate_z_serial_purepython</code> on line 12 below we see that the allocation of 1,000,000 items causes approximately 7MB of RAM to be added to this process. This does not mean that the <code class="literal">output</code> list is definitely 7MB in size, just that the process grew by approximately 7MB during the internal allocation of the list.  On line 13 we see that the process grew by approximately a further 32MB inside the loop, this can be attributed to the call to <code class="literal">range</code>. RAM tracking is further discussed in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-1e8-same-items">Example&nbsp;11-1</a>, the difference between 7MB and 32MB is due to the contents of the two lists.</p><p>In the parent process on line 46 we see that the allocation of the <code class="literal">zs</code> and <code class="literal">cs</code> lists consumes approximately 79MB. Again it is worth noting that this is not necessarily the true size of the arrays, just the size that the process grew by once these lists had been created.</p><div class="example"><a id="profiling-memoryprofiler1"></a><div class="example-title">Example&nbsp;2-10.&nbsp;memory_profiler’s result on both of our main functions showing an unexpected memory use in <code class="literal">calculate_z_serial_purepython</code></div><div class="example-contents"><pre class="screen">$ python -m memory_profiler julia1_memoryprofiler.py
...
Line #    Mem usage    Increment   Line Contents
================================================
     9   89.934 MiB    0.000 MiB   @profile
    10                             def calculate_z_serial_purepython(maxiter, zs, cs):
    11                                 """Calculate output list using...
    12   97.566 MiB    7.633 MiB       output = [0] * len(zs)
    13  130.215 MiB   32.648 MiB       for i in range(len(zs)):
    14  130.215 MiB    0.000 MiB           n = 0
    15  130.215 MiB    0.000 MiB           z = zs[i]
    16  130.215 MiB    0.000 MiB           c = cs[i]
    17  130.215 MiB    0.000 MiB           while n &lt; maxiter and abs(z) &lt; 2:
    18  130.215 MiB    0.000 MiB               z = z * z + c
    19  130.215 MiB    0.000 MiB               n += 1
    20  130.215 MiB    0.000 MiB           output[i] = n
    21  122.582 MiB   -7.633 MiB       return output

Line #    Mem usage    Increment   Line Contents
================================================
    24   10.574 MiB -112.008 MiB   @profile
    25                             def calc_pure_python(draw_output,
                                                        desired_width,
                                                        max_iterations):
    26                                 """Create a list of complex ...
    27   10.574 MiB    0.000 MiB       x_step = (float(x2 - x1) / ...
    28   10.574 MiB    0.000 MiB       y_step = (float(y1 - y2) / ...
    29   10.574 MiB    0.000 MiB       x = []
    30   10.574 MiB    0.000 MiB       y = []
    31   10.574 MiB    0.000 MiB       ycoord = y2
    32   10.574 MiB    0.000 MiB       while ycoord &gt; y1:
    33   10.574 MiB    0.000 MiB           y.append(ycoord)
    34   10.574 MiB    0.000 MiB           ycoord += y_step
    35   10.574 MiB    0.000 MiB       xcoord = x1
    36   10.582 MiB    0.008 MiB       while xcoord &lt; x2:
    37   10.582 MiB    0.000 MiB           x.append(xcoord)
    38   10.582 MiB    0.000 MiB           xcoord += x_step
    ...
    44   10.582 MiB    0.000 MiB       zs = []
    45   10.582 MiB    0.000 MiB       cs = []
    46   89.926 MiB   79.344 MiB       for ycoord in y:
    47   89.926 MiB    0.000 MiB           for xcoord in x:
    48   89.926 MiB    0.000 MiB               zs.append(complex(xcoord, ycoord))
    49   89.926 MiB    0.000 MiB               cs.append(complex(c_real, c_imag))
    50
    51   89.934 MiB    0.008 MiB       print "Length of x:", len(x)
    52   89.934 MiB    0.000 MiB       print "Total elements:", len(zs)
    53   89.934 MiB    0.000 MiB       start_time = time.time()
    54                                 output = calculate_z_serial...
    55  122.582 MiB   32.648 MiB       end_time = time.time()
    ...</pre></div></div><p>Another way to visualise the change in memory use is to sample over time and plot the result. <code class="literal">memory_profiler</code> has a utility called <code class="literal">mprof</code>, it is used once to sample the memory usage and a second time to visualise the samples. It samples by time and not by line so it barely impacts the run-time of the code.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-memoryprofiler-mprof">Figure&nbsp;2-6</a> is created using <code class="literal">mprof run julia1_memoryprofiler.py</code>, this writes a statistics file which  is then visualised using <code class="literal">mprof plot</code>.</p><p>Our two functions are bracketed, this shows where in time they are entered and we can see the growth in RAM as they run. Inside <code class="literal">calculate_z_serial_purepython</code> we can see the steady increase in RAM usage throughout the execution of the function, this is caused by all the small objects (<code class="literal">int</code> and <code class="literal">float</code> types) that are created.</p><div class="figure"><a id="FIG-julia-memoryprofiler-mprof"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_memoryprofiler_mprof.png" alt="memory_profiler report using mprof" width="1000" height="532" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_memoryprofiler_mprof.png"></div></div><div class="figure-title">Figure&nbsp;2-6.&nbsp;memory_profiler report using mprof.</div></div><p>In addition to observing the behaviour at the function level we can add labels using a context manager. The following snippet in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-memoryprofiler2">Example&nbsp;2-11</a> is used to generate the graph in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-memoryprofiler-mprof-labels">Figure&nbsp;2-7</a>. The <code class="literal">time.sleep(1)</code> is an artificial addition to make the graph easier to understand. We can see the <code class="literal">create_output_list</code> label, it occurs momentarily after <code class="literal">calculate_z_serial_purepython</code> and the process has been allocated more RAM. We then pause for a second to make the graph clearer.</p><p>After the label <code class="literal">create_range_of_zs</code> we see a large and quick increase in RAM usage, in the modified code below you can see this label when we create the <code class="literal">iterations</code> list. Rather than using <code class="literal">xrange</code> instead we’ve used <code class="literal">range</code> - the diagram should make it clear that a large list of 1,000,000 elements is instantiated just for the purposes of generating an index and that this is an inefficient approach that will not scale to larger list sizes (we will run out of RAM!). The allocation of the memory used to hold this list will itself take a small amount of time which contributes nothing useful to this function.</p><div class="note"><h3 class="title">Note</h3><p>In Python 3 the behavior of <code class="literal">range</code> changes - it works like <code class="literal">xrange</code> from Python 2. <code class="literal">xrange</code> is deprecated in Python 3 and the <code class="literal">2to3</code> conversion tool takes care of this change automatically.</p></div><div class="example"><a id="profiling-memoryprofiler2"></a><div class="example-title">Example&nbsp;2-11.&nbsp;Using a context manager to add labels to the mprof graph</div><div class="example-contents"><pre class="screen">@profile
def calculate_z_serial_purepython(maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    with profile.timestamp("create_output_list"):
        output = [0] * len(zs)
    time.sleep(1)
    with profile.timestamp("create_range_of_zs"):
        iterations = range(len(zs))
        with profile.timestamp("calculate_output"):
            for i in iterations:
                n = 0
                z = zs[i]
                c = cs[i]
                while n &lt; maxiter and abs(z) &lt; 2:
                    z = z * z + c
                    n += 1
                output[i] = n
    return output</pre></div></div><p>In the <code class="literal">calculate_output</code> block which runs for most of the graph we see a very slow, linear increase in RAM usage, this will be from all of the temporary numbers used in the inner loops. Using the labels really helps us to understand at a fine-grained level where memory is being consumed.</p><div class="figure"><a id="FIG-julia-memoryprofiler-mprof-labels"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_memoryprofiler2_mprof.png" alt="memory_profiler report using mprof with labels" width="1000" height="532" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_memoryprofiler2_mprof.png"></div></div><div class="figure-title">Figure&nbsp;2-7.&nbsp;memory_profiler report using mprof with labels.</div></div><p>Finally we could change the <code class="literal">range</code> call into an <code class="literal">xrange</code> and in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-memoryprofiler2-xrange-mprof-labels">Figure&nbsp;2-8</a> we see the corresponding decrease in RAM usage in our inner loop.</p><div class="figure"><a id="FIG-julia-memoryprofiler2-xrange-mprof-labels"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_memoryprofiler2_xrange_mprof.png" alt="memory_profiler with xrange using mprof with labels" width="1000" height="532" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_memoryprofiler2_xrange_mprof.png"></div></div><div class="figure-title">Figure&nbsp;2-8.&nbsp;memory_profiler report using mprof with labels.</div></div><p>If we want to measure the RAM used by several statements we can use the IPython magic <code class="literal">%memit</code>, it works just like <code class="literal">%timeit</code>. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html">Chapter&nbsp;11</a> we look at using <code class="literal">%memit</code> to measure the memory cost of lists and discuss various ways of using RAM more efficiently.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="profiling-heapy">Inspecting objects on the heap with heapy</h2></div></div></div><p>The Guppy project has a heap inspection tool, it lets us look at the number and size of each object on Python’s heap. Looking inside the interpreter and understanding what’s held in memory is extremely useful in rare but difficult debugging sessions where you really need to know how many objects are in use and whether they get garbage collected at appropriate times. If you have a difficult memory leak (probably because references to your objects remain hidden in a complex system) then this is the tool that’ll get you to the root of the problem.</p><p>If you’re reviewing your code to see if it is generating as many objects as you predict then this tool is very useful - the results might surprise you and that could lead to new optimization opportunities.</p><p>Installation: <code class="literal">pip install guppy</code></p><p>The listing in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-heapy1">Example&nbsp;2-12</a> is a slightly modified version of the Julia code, the heap object <code class="literal">hpy</code> is included in <code class="literal">calc_pure_python</code> and we print out the state of the heap at three places.</p><div class="example"><a id="profiling-heapy1"></a><div class="example-title">Example&nbsp;2-12.&nbsp;Using heapy to see how object counts evolve during the run of our code</div><div class="example-contents"><pre class="screen">def calc_pure_python(draw_output, desired_width, max_iterations):
    ...
    while xcoord &lt; x2:
        x.append(xcoord)
        xcoord += x_step

    from guppy import hpy; hp = hpy()
    print "heapy after creating y and x lists of floats"
    h = hp.heap()
    print h
    print

    zs = []
    cs = []
    for ycoord in y:
        for xcoord in x:
            zs.append(complex(xcoord, ycoord))
            cs.append(complex(c_real, c_imag))

    print "heapy after creating zs and cs using complex numbers"
    h = hp.heap()
    print h
    print

    print "Length of x:", len(x)
    print "Total elements:", len(zs)
    start_time = time.time()
    output = calculate_z_serial_purepython(max_iterations, zs, cs)
    end_time = time.time()
    secs = end_time - start_time
    print calculate_z_serial_purepython.func_name + " took", secs, "seconds"

    print
    print "heapy after calling calculate_z_serial_purepython"
    h = hp.heap()
    print h
    print</pre></div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-heapy2">Example&nbsp;2-13</a> shows that after creating the <code class="literal">zs</code> and <code class="literal">cs</code> lists the memory use is more interesting as it has grown by approximately 80MB due to 2,000,000 <code class="literal">complex</code> objects consuming 64,000,000 bytes. These complex numbers represent the majority of the memory usage at this stage. If you wanted to optimize the memory usage in this program then this result would be revealing - we can see both how many objects are being stored and their overall size.</p><div class="example"><a id="profiling-heapy2"></a><div class="example-title">Example&nbsp;2-13.&nbsp;Looking at the output of heapy to see how our object counts increase at each major stage of our code’s execution</div><div class="example-contents"><pre class="screen">guppy $ python julia1_guppy.py
heapy after creating y and x lists of floats
Partition of a set of 27293 objects. Total size = 3416032 bytes.
 Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
     0  10960  40  1050376  31   1050376  31 str
     1   5768  21   465016  14   1515392  44 tuple
     2    199   1   210856   6   1726248  51 dict of type
     3     72   0   206784   6   1933032  57 dict of module
     4   1592   6   203776   6   2136808  63 types.CodeType
     5    313   1   201304   6   2338112  68 dict (no owner)
     6   1557   6   186840   5   2524952  74 function
     7    199   1   177008   5   2701960  79 type
     8    124   0   135328   4   2837288  83 dict of class
     9   1045   4    83600   2   2920888  86 __builtin__.wrapper_descriptor
&lt;91 more rows. Type e.g. '_.more' to view.&gt;

heapy after creating zs and cs using complex numbers
Partition of a set of 2027301 objects. Total size = 83671256 bytes.
 Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
     0 2000000  99 64000000  76  64000000  76 complex
     1    185   0 16295368  19  80295368  96 list
     2  10962   1  1050504   1  81345872  97 str
     3   5767   0   464952   1  81810824  98 tuple
     4    199   0   210856   0  82021680  98 dict of type
     5     72   0   206784   0  82228464  98 dict of module
     6   1592   0   203776   0  82432240  99 types.CodeType
     7    319   0   202984   0  82635224  99 dict (no owner)
     8   1556   0   186720   0  82821944  99 function
     9    199   0   177008   0  82998952  99 type
&lt;92 more rows. Type e.g. '_.more' to view.&gt;

Length of x: 1000
Total elements: 1000000
calculate_z_serial_purepython took 13.2436609268 seconds

heapy after calling calculate_z_serial_purepython
Partition of a set of 2127696 objects. Total size = 94207376 bytes.
 Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
     0 2000000  94 64000000  68  64000000  68 complex
     1    186   0 24421904  26  88421904  94 list
     2 100965   5  2423160   3  90845064  96 int
     3  10962   1  1050504   1  91895568  98 str
     4   5767   0   464952   0  92360520  98 tuple
     5    199   0   210856   0  92571376  98 dict of type
     6     72   0   206784   0  92778160  98 dict of module
     7   1592   0   203776   0  92981936  99 types.CodeType
     8    319   0   202984   0  93184920  99 dict (no owner)
     9   1556   0   186720   0  93371640  99 function
&lt;92 more rows. Type e.g. '_.more' to view.&gt;</pre></div></div><p>In the third section after calculating the Julia result we have used 94MB. In addition to the complex numbers we now have a large collection of integers in addition to more items stored in lists.</p><p><code class="literal">hpy.setrelheap()</code> could be used to create a check-point of the memory configuration so subsequent calls to <code class="literal">hpy.heap()</code> will generate a delta from this check-point. This way you can avoid seeing the internals of Python and prior memory setup before the point of the program that you’re analysing.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="profiling-dowser">Dowser for live graphing of instantiated variables</h2></div></div></div><p>Rober Brewer’s <code class="literal">dowser</code> hooks into the namespace of the running code and provides a real-time view of instantiated variables via a CherryPy interface in a web-browser. Each object that is being tracked has an associated sparkline graphic so you can watch to see if the quantities of certain objects are growing. This is useful for debugging long-running processes.</p><p>If you have a long-running process and you expect different memory behavior to occur depending on the actions you take in the application (e.g. with a web server you might upload data or cause complex queries to run) you can confirm this interactively, there’s an example in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-dowser-sparklines">Figure&nbsp;2-9</a>.</p><div class="figure"><a id="FIG-julia-dowser-sparklines"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 135; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_dowser_sparklines.png" alt="sparklines in dowser" width="265" height="254" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_dowser_sparklines.png"></div></div><div class="figure-title">Figure&nbsp;2-9.&nbsp;Several sparklines shown through CherryPy with <code class="literal">dowser</code>.</div></div><p>To use it we add a convenience function, shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-dowser1">Example&nbsp;2-14</a>, to the Julia code which can start the CherryPy server.</p><div class="example"><a id="profiling-dowser1"></a><div class="example-title">Example&nbsp;2-14.&nbsp;Helper function to start <code class="literal">dowser</code> in your application</div><div class="example-contents"><pre class="screen">def launch_memory_usage_server(port=8080):
    import cherrypy
    import dowser

    cherrypy.tree.mount(dowser.Root())
    cherrypy.config.update({
        'environment': 'embedded',
        'server.socket_port': port
    })

    cherrypy.engine.start()</pre></div></div><p>Before we begin our intensive calculations we launch the CherryPy server, shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-dowser2">Example&nbsp;2-15</a>. Once we have completed our calculations we can keep the console open using the <code class="literal">sleep</code>, this leaves the CherryPy process running so we can continue to introspect the state of namespace.</p><div class="example"><a id="profiling-dowser2"></a><div class="example-title">Example&nbsp;2-15.&nbsp;Launching dowser at an appropriate point in our application which will launch a webserver</div><div class="example-contents"><pre class="screen"> ...
        for xcoord in x:
            zs.append(complex(xcoord, ycoord))
            cs.append(complex(c_real, c_imag))

    launch_memory_usage_server()

...
    output = calculate_z_serial_purepython(max_iterations, zs, cs)
...
    print "now waiting..."
    while True:
        time.sleep(1)</pre></div></div><p>By following the <code class="literal">TRACE</code> links in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#FIG-julia-dowser-1000000-lists">Figure&nbsp;2-10</a> we can view the contents of each <code class="literal">list</code> object. We could further drill down into each <code class="literal">list</code>, this is like using an interactive debugger in an IDE but you can do this on a deployed server <span class="emphasis"><em>without</em></span> an IDE.</p><div class="figure"><a id="FIG-julia-dowser-1000000-lists"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 405; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/julia_dowser_1000000_lists.png" alt="1000000 items in a list" width="641" height="203" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/julia_dowser_1000000_lists.png"></div></div><div class="figure-title">Figure&nbsp;2-10.&nbsp;1,000,000 items in a list with <code class="literal">dowser</code>.</div></div><div class="note"><h3 class="title">Note</h3><p>We prefer to extract blocks of code that can be profiled in controlled conditions. Sometimes this isn’t practical and sometimes you just need simpler diagnostics - watching a live trace of a running process can be a perfect half-way house to gather the necessary evidence without doing lots of engineering.</p></div><p>So far we’ve reviewed various ways to measure the cost of Python code (both for CPU and RAM usage). We haven’t yet looked at the underlying bytecode used by the virtual machine, understanding what’s happening “under the hood” helps to build a mental model of what’s happening in slow functions and it’ll help when you come to compile your code. Let’s introduce some bytecode.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="profiling-dis">The dis module to examine CPython bytecode</h2></div></div></div><p>The <code class="literal">dis</code> module lets us inspect the underlying bytecode that we run inside the stack based CPython virtual machine. Having an understanding of what’s happening in the virtual machine that runs your higher level Python code will help you to understand why some styles of coding are faster than others. It will also help when you come to use a tool like Cython which steps outside of Python and generates C code.</p><p>The <code class="literal">dis</code> module is built-in. You can pass it code or a module and it will print out a disassembly. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-dis1">Example&nbsp;2-16</a> we disassemble the outer loop of our CPU-bound function.</p><div class="tip"><h3 class="title">Tip</h3><p>You should try to disassemble one of your own functions and attempt to <span class="emphasis"><em>exactly</em></span> follow how the disassembled code matches to the disassembled output. Can you match the following <code class="literal">dis</code> output to the original function?</p></div><div class="example"><a id="profiling-dis1"></a><div class="example-title">Example&nbsp;2-16.&nbsp;Using the built-in <code class="literal">dis</code> to understand the underlying stack-based virtual machine that runs our Python code</div><div class="example-contents"><pre class="screen">In [1]: import dis
In [2]: import julia1_nopil

In [3]: dis.dis(julia1_nopil.calculate_z_serial_purepython)
 11           0 LOAD_CONST               1 (0)
              3 BUILD_LIST               1
              6 LOAD_GLOBAL              0 (len)
              9 LOAD_FAST                1 (zs)
             12 CALL_FUNCTION            1
             15 BINARY_MULTIPLY
             16 STORE_FAST               3 (output)

 12          19 SETUP_LOOP             123 (to 145)
             22 LOAD_GLOBAL              1 (range)
             25 LOAD_GLOBAL              0 (len)
             28 LOAD_FAST                1 (zs)
             31 CALL_FUNCTION            1
             34 CALL_FUNCTION            1
             37 GET_ITER
        &gt;&gt;   38 FOR_ITER               103 (to 144)
             41 STORE_FAST               4 (i)

 13          44 LOAD_CONST               1 (0)
             47 STORE_FAST               5 (n)

# ...
# We'll snip the rest of the inner loop for brevity!
# ...

 19     &gt;&gt;  131 LOAD_FAST                5 (n)
            134 LOAD_FAST                3 (output)
            137 LOAD_FAST                4 (i)
            140 STORE_SUBSCR
            141 JUMP_ABSOLUTE           38
        &gt;&gt;  144 POP_BLOCK

 20     &gt;&gt;  145 LOAD_FAST                3 (output)
            148 RETURN_VALUE</pre></div></div><p>The output of the above code is fairly straightforward, if terse. The first column contains line numbers that relate to our original file. The second column contains several <code class="literal">&gt;&gt;</code> symbols, these are the destinations for jump points elsewhere in the code. The third column is the operation address along with the operation name. The fourth column contains the parameters for the operation. The fifth column contains annotations to help line up the bytecodes with the original Python parameters.</p><p>Refer back to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-juliaset-intro3">Example&nbsp;2-3</a> to match the bytecode to the corresponding Python code. The bytecode starts by putting the constant value 0 onto the stack and then it builds a single element list. Next it searches the namespaces to find the <code class="literal">len</code> function, puts it on the stack, searches the namespaces again to find <code class="literal">zs</code> and then puts that onto the stack. On line 12 it calls the <code class="literal">len</code> function from the stack which consumes the <code class="literal">zs</code> reference in the stack, then it applies a binary multiply to the last two arguments (the length of <code class="literal">zs</code> and the single element list) and stores the result in <code class="literal">output</code>. That’s the first line of our Python function now dealt with. Follow the next block of bytecode to understand the behavior of the second line of Python code (the outer <code class="literal">for</code> loop).</p><div class="tip"><h3 class="title">Tip</h3><p>The jump points <code class="literal">&gt;&gt;</code> match to instructions like <code class="literal">JUMP_ABSOLUTE</code> and <code class="literal">POP_JUMP_IF_FALSE</code>. Go through your own disassembled function and match the jump points to the jump instructions.</p></div><p>Having introduced bytecode we can now ask - what’s the bytecode and time cost of writing an function out explicitly versus using built-ins to perform the same task?</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_different_approaches_different_complexity">Different approaches, different complexity</h3></div></div></div><div class="blockquote"><blockquote class="blockquote"><p>…
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you’re Dutch.
…</p><div class="attribution"><p>—<span class="attribution">
Tim Peters and The Zen of Python
</span></p></div></blockquote></div><p>There will be various ways to express your idea using Python. Generally there should be one sensible way to express your idea but if you came from an older version of Python or another programming language then you may have other methods in mind. Some of these ways of expressing an idea may be slower than others.</p><p>You probably care more about readability than speed for most of your code so your team can code quickly, without being puzzled by performant but opaque code. Some times you will want performance, without sacrificing readability. Some speed testing might be what you need.</p><p>Take a look at the following two code snippets in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-dis2">Example&nbsp;2-17</a>, they both do the same job but the first will generate a lot of additional Python bytecode which will cause more overhead.</p><div class="example"><a id="profiling-dis2"></a><div class="example-title">Example&nbsp;2-17.&nbsp;A naive and a more efficient way to solve the same summation problem</div><div class="example-contents"><pre class="screen">def fn_expressive(upper = 1000000):
    total = 0
    for n in xrange(upper):
        total += n
    return total

def fn_terse(upper = 1000000):
    return sum(xrange(upper))

print "Functions return the same result:", fn_expressive() == fn_terse()</pre><pre class="screen">Functions return the same result:
True</pre></div></div><p>Both function calculate the sum of a range of integers. A simple rule of thumb (but one which you <span class="emphasis"><em>must</em></span> backup using profiling!) is that more lines of bytecode will execute more slowly than fewer equivalent lines of bytecode. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-dis3">Example&nbsp;2-18</a> we can use IPython’s <code class="literal">%timeit</code> magic function to measure the best execution time from a set of runs.</p><div class="example"><a id="profiling-dis3"></a><div class="example-title">Example&nbsp;2-18.&nbsp;Using <code class="literal">%timeit</code> to test our hypothesis that using built-in functions should be faster than writing our own functions</div><div class="example-contents"><pre class="screen">%timeit fn_expressive()
%timeit fn_terse()

10 loops, best of 3: 42 ms per loop
100 loops, best of 3: 12.3 ms per loop</pre></div></div><p>If we use the <code class="literal">dis</code> module to investigate the code for each function in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-dis4">Example&nbsp;2-19</a> we can see that the Virtual Machine has 17 lines to execute with the more expressive function and only 6 to execute with the very readable but more terse second function:</p><div class="example"><a id="profiling-dis4"></a><div class="example-title">Example&nbsp;2-19.&nbsp;Using <code class="literal">dis</code> to view the number of bytecode instructions involved in our two functions</div><div class="example-contents"><pre class="screen">import dis
print fn_expressive.func_name
dis.dis(fn_expressive)

fn_expressive
  2           0 LOAD_CONST               1 (0)
              3 STORE_FAST               1 (total)

  3           6 SETUP_LOOP              30 (to 39)
              9 LOAD_GLOBAL              0 (xrange)
             12 LOAD_FAST                0 (upper)
             15 CALL_FUNCTION            1
             18 GET_ITER
        &gt;&gt;   19 FOR_ITER                16 (to 38)
             22 STORE_FAST               2 (n)

  4          25 LOAD_FAST                1 (total)
             28 LOAD_FAST                2 (n)
             31 INPLACE_ADD
             32 STORE_FAST               1 (total)
             35 JUMP_ABSOLUTE           19
        &gt;&gt;   38 POP_BLOCK

  5     &gt;&gt;   39 LOAD_FAST                1 (total)
             42 RETURN_VALUE

print fn_terse.func_name
dis.dis(fn_terse)

fn_terse
  8           0 LOAD_GLOBAL              0 (sum)
              3 LOAD_GLOBAL              1 (xrange)
              6 LOAD_FAST                0 (upper)
              9 CALL_FUNCTION            1
             12 CALL_FUNCTION            1
             15 RETURN_VALUE</pre></div></div><p>The difference between the two code blocks is striking. Inside <code class="literal">fn_expressive()</code> we maintain two local variables and iterate over a list using a <code class="literal">for</code> statement. The <code class="literal">for</code> loop will be checking to see if a <code class="literal">StopIteration</code> exception has been raised on each loop. Each iteration applies the <code class="literal">total.__add__</code> function which will check the type of the second variable (<code class="literal">n</code>) on each iteration. These checks all add a little expense.</p><p>Inside <code class="literal">fn_terse()</code> we call out to an optimized C list comprehension function which knows how to generate the final result without creating intermediate Python objects. This is much faster, although each iteration must still check for the types of the object that are being added together (in a later chapters we look at ways of fixing the type so we don’t need to check it on each iteration).</p><p>As noted above you <span class="emphasis"><em>must</em></span> profile your code, if you just rely on this heuristic then you will inevitably write slower code at some point. It is definitely worth learning if Python has a shorter and still readable way to solve your problem, it is more likely to be easily read by another programmer and it will <span class="emphasis"><em>probably</em></span> run faster.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="profiling-unit-testing">Unit testing during optimization to maintain correctness</h2></div></div></div><p>If you aren’t already unit-testing your code then you are probably hurting your longer-term productivity. Ian (blushing) is embarrassed to note that once he spent a day optimising his code, having disabled unit-tests because they were inconvenient, only to discover that his significant speed-up result was due to breaking a part of the algorithm he was improving. You do not need to make this mistake even once.</p><p>In addition to unit-testing you should also strongly consider <code class="literal">coverage.py</code>. It checks to see which lines of code are exercised by your tests and identifies the sections that have no coverage. This quickly lets you figure out whether you’re testing the code that you’re about to optimize, such that any mistakes that might creep in during the optimisation process are quickly caught.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="no_op_profile_decorator">No-op @profile decorator</h3></div></div></div><p>Your unit-tests will fail with a <code class="literal">NameError</code> exception if your code uses <code class="literal">@profile</code> from the <code class="literal">line_profiler</code> or <code class="literal">memory_profiler</code>. The reason is that the unit-test framework will not be injecting the <code class="literal">profile</code> decorator into the local namespace. The no-op decorator below solves this problem, it is easiest to add it to the block of code that you’re testing and to remove it when done.</p><p>With the no-op decorator you can run your tests without modifying the code that you’re testing. This means you can run your tests after every profile-led optimization you make so you’ll never be caught out by a bad optimization step.</p><p>Let’s say we have the following trivial <code class="literal">ex.py</code> module in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-noop1">Example&nbsp;2-20</a>, it has a test (for <code class="literal">nosetests</code>) and a function that we’ve been profiling with either the <code class="literal">line_profiler</code> or <code class="literal">memory_profiler</code>:</p><div class="example"><a id="profiling-noop1"></a><div class="example-title">Example&nbsp;2-20.&nbsp;Simple function and test case where we wish to use <code class="literal">@profile</code></div><div class="example-contents"><pre class="screen"># ex.py
import unittest

@profile
def some_fn(nbr):
    return nbr * 2


class TestCase(unittest.TestCase):
    def test(self):
        result = some_fn(2)
        self.assertEquals(result, 4)</pre></div></div><p>If we run <code class="literal">nosetests</code> on our code we’ll have a <code class="literal">NameError</code>:</p><pre class="programlisting"><code class="err">$</code> <code class="n">nosetests</code> <code class="n">ex</code><code class="o">.</code><code class="n">py</code>
<code class="n">E</code>
<code class="o">======================================================================</code>
<code class="n">ERROR</code><code class="p">:</code> <code class="n">Failure</code><code class="p">:</code> <code class="ne">NameError</code> <code class="p">(</code><code class="n">name</code> <code class="s">'profile'</code> <code class="ow">is</code> <code class="ow">not</code> <code class="n">defined</code><code class="p">)</code>
<code class="o">...</code>
<code class="ne">NameError</code><code class="p">:</code> <code class="n">name</code> <code class="s">'profile'</code> <code class="ow">is</code> <code class="ow">not</code> <code class="n">defined</code>

<code class="n">Ran</code> <code class="mi">1</code> <code class="n">test</code> <code class="ow">in</code> <code class="mf">0.001</code><code class="n">s</code>

<code class="n">FAILED</code> <code class="p">(</code><code class="n">errors</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code></pre><p>The solution is to add a no-op decorator at the start of <code class="literal">ex.py</code> (you can remove it once you’re done with profiling). If the <code class="literal">profile</code> decorator is not found in one of the namespaces (because <code class="literal">line_profiler</code> or <code class="literal">memory_profiler</code> are not being used) then the no-op version we’ve written is added. If <code class="literal">line_profiler</code> or <code class="literal">memory_profiler</code> have injected the new function into the namespace then our no-op version is ignored.</p><p>For <code class="literal">line_profiler</code> we can add the code in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-noop2">Example&nbsp;2-21</a>.</p><div class="example"><a id="profiling-noop2"></a><div class="example-title">Example&nbsp;2-21.&nbsp;<code class="literal">line_profiler</code> fix to add a no-op <code class="literal">@profile</code> decorator to the namespace whilst unit-testing</div><div class="example-contents"><pre class="screen"># for line_profiler
if '__builtin__' not in dir() or not hasattr(__builtin__, 'profile'):
    def profile(func):
        def inner(*args, **kwargs):
            return func(*args, **kwargs)
        return inner</pre></div></div><p>The <code class="literal">__builtin__</code> test is for <code class="literal">nosetests</code>, the <code class="literal">hasattr</code> test is for identifying when the <code class="literal">profile</code> decorator has been injected into the namespace.</p><pre class="programlisting"><code class="err">$</code> <code class="n">kernprof</code><code class="o">.</code><code class="n">py</code> <code class="o">-</code><code class="n">v</code> <code class="o">-</code><code class="n">l</code> <code class="n">ex</code><code class="o">.</code><code class="n">py</code>
<code class="n">Line</code> <code class="c">#      Hits         Time  Per %%HTMLit   % Time  Line Contents</code>
<code class="o">==============================================================</code>
    <code class="mi">11</code>                                           <code class="nd">@profile</code>
    <code class="mi">12</code>                                           <code class="k">def</code> <code class="nf">some_fn</code><code class="p">(</code><code class="n">nbr</code><code class="p">):</code>
    <code class="mi">13</code>         <code class="mi">1</code>            <code class="mi">3</code>      <code class="mf">3.0</code>    <code class="mf">100.0</code>      <code class="k">return</code> <code class="n">nbr</code> <code class="o">*</code> <code class="mi">2</code>


<code class="err">$</code> <code class="n">nosetests</code> <code class="n">ex</code><code class="o">.</code><code class="n">py</code>
<code class="o">.</code>
<code class="n">Ran</code> <code class="mi">1</code> <code class="n">test</code> <code class="ow">in</code> <code class="mf">0.000</code><code class="n">s</code></pre><p>For <code class="literal">memory_profiler</code> we use the code in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-noop3">Example&nbsp;2-22</a>.</p><div class="example"><a id="profiling-noop3"></a><div class="example-title">Example&nbsp;2-22.&nbsp;<code class="literal">memory_profiler</code> fix to add a no-op <code class="literal">@profile</code> decorator to the namespace whilst unit-testing</div><div class="example-contents"><pre class="screen"># for memory_profiler
if 'profile' not in dir():
    def profile(func):
        def inner(*args, **kwargs):
            return func(*args, **kwargs)
        return inner</pre></div></div><p>We’d expect it to generate output like this:</p><pre class="programlisting"> <code class="err">$</code> <code class="n">python</code> <code class="o">-</code><code class="n">m</code> <code class="n">memory_profiler</code> <code class="n">ex</code><code class="o">.</code><code class="n">py</code>
<code class="o">...</code>
<code class="n">Line</code> <code class="c">#    Mem usage    Increment   Line Contents</code>
<code class="o">================================================</code>
    <code class="mi">11</code>   <code class="mf">10.809</code> <code class="n">MiB</code>    <code class="mf">0.000</code> <code class="n">MiB</code>   <code class="nd">@profile</code>
    <code class="mi">12</code>                             <code class="k">def</code> <code class="nf">some_fn</code><code class="p">(</code><code class="n">nbr</code><code class="p">):</code>
    <code class="mi">13</code>   <code class="mf">10.809</code> <code class="n">MiB</code>    <code class="mf">0.000</code> <code class="n">MiB</code>       <code class="k">return</code> <code class="n">nbr</code> <code class="o">*</code> <code class="mi">2</code>


<code class="err">$</code> <code class="n">nosetests</code> <code class="n">ex</code><code class="o">.</code><code class="n">py</code>
<code class="o">.</code>
<code class="n">Ran</code> <code class="mi">1</code> <code class="n">test</code> <code class="ow">in</code> <code class="mf">0.000</code><code class="n">s</code></pre><p>You can save yourself a few minutes by avoiding the use of these decorators but once you’ve lost hours making a false optimization which breaks your code, you’ll want to integrate this into your workflow.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="profiling-strategies">Strategies to profile your code successfully</h2></div></div></div><p>Profiling requires some time and concentration. You will stand a better chance of understanding your code if you separate the section you want to test from the main body of your code. By separating it you can unit-test the code to preserve correctness and you can pass in realistic fabricated data to exercise the inefficiencies you want to address.</p><p>Do remember to disable any BIOS-based accelerators, they will only confuse your results. On Ian’s laptop the Intel TurboBoost feature can temporarily accelerate a CPU above its normal maximum speed if it is cool enough. This means that a cool CPU may run the same block of code faster than a hot CPU. Your Operating System may also control the clock speed - a laptop on battery power is likely to more aggressively control CPU speed than a laptop on mains power. To create a more stable benchmarking configuration we:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
disable TurboBoost in the BIOS
</li><li class="listitem">
disable the Operating System’s ability to override the BIOS’ SpeedStep in the BIOS
</li><li class="listitem">
only used mains power (never battery power)
</li><li class="listitem">
disabled background tools like backups and Dropbox whilst running experiments
</li><li class="listitem">
run the experiments many times to obtain a stable measurement
</li><li class="listitem">
possibly drop to run-level 1 (Unix) so that no other tasks are running
</li><li class="listitem">
reboot and rerun the experiments to double-confirm the results
</li></ul></div><p>Try to hypothesise the expected behaviour of your code and then validate (or disprove!) the hypothesis with the result of a profiling step. Your choices will not change (you can only use the profiled results to drive your decisions) but your intuitive understanding of the code will improve and this will pay off in future projects as you are more likely to make performant decisions. Of course you will verify these performant decisions by profiling as you go.</p><p>Do not skimp on the preparation. If you try to performance test code deep inside a larger project without separating it from the larger project then you are likely to witness side effects which will side-track your efforts. It is likely to be harder to unit-test a larger project when you’re making fine-grained changes and this may further hamper your efforts. Side effects could include other threads and processes impacting CPU, memory, network and disk activity which will skew your results.</p><p>For web servers investigate <code class="literal">dowser</code> and <code class="literal">dozer</code>, you can use these to visualise in real-time the behavior of objects in the namespace. Definitely consider separating the code you want to test out of the main web application if possible, it will make profiling significantly easier.</p><p>Make sure your unit-tests exercise all the code paths in the code that you’re analysing. Anything you don’t test but is used in your benchmarking may cause subtle errors that will slow down your progress. Use <code class="literal">coverage.py</code> to confirm that your tests are covering all the code paths.</p><p>Unit-testing a complicated section of code that generates a large numerical output may be difficult. Do not be afraid to output a text file of results to run through <code class="literal">diff</code> or to use a <code class="literal">pickled</code> object. For numeric optimization problems Ian likes to create long text files of floating point numbers and to use <code class="literal">diff</code> - minor rounding errors show up immediately and can be rare in the output.</p><p>If your code might be subject to numerical rounding issues due to subtle changes then you are better off with a large output that can be used for a before-and-after comparison. One cause of rounding errors is the difference in floating point precision between CPU registers and main memory. Running your code through a different code path can cause subtle rounding errors which might later confound you - it is better to be aware of this as soon as they occur.</p><p>Obviously it makes sense to use a source code control tool whilst you a profiling and optimizing. Branching is cheap and it will preserve your sanity.</p><p>Having looked at profiling techniques you should have all the tools you need to identify bottlenecks around CPU and RAM usage in your code. Next we’ll look at how Python implements the most common containers so you can make sensible decisions about representing larger collections of data.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id314061"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#id314061" class="simpara totri-footnote">4</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Julia_set" target="_top">http://en.wikipedia.org/wiki/Julia_set</a></p></div><div class="footnote" id="ftn.id322178"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#id322178" class="simpara totri-footnote">5</a>] </sup><a class="ulink" href="http://docs.python.org/2/library/timeit.html" target="_top">http://docs.python.org/2/library/timeit.html</a></p></div><div class="footnote" id="ftn.id312621"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#id312621" class="simpara totri-footnote">6</a>] </sup><a class="ulink" href="https://mail.python.org/pipermail/python-dev/2005-November/058212.html" target="_top">https://mail.python.org/pipermail/python-dev/2005-November/058212.html</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch01.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">1. Understanding Performant Python</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch03.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">3. Lists and Tuples</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch02.html" data-for-analytics="9781449361747:ch02.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    <div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#">Reset</a>
</div>
</div>
    
  

<div class="annotator-notice"></div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch03.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch03.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch03.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch03.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>3. Lists and Tuples - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch03.html"><meta name="description" content="Chapter&nbsp;3.&nbsp;Lists and Tuples Questions you’ll be able to answer after this chapter What are lists and tuples good for? What is the complexity for a lookup in ... "><meta property="og:title" content="3. Lists and Tuples"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="3. Lists and Tuples"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch03.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;3.&nbsp;Lists and Tuples Questions you’ll be able to answer after this chapter What are lists and tuples good for? What is the complexity for a lookup in ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch03.html" data-for-analytics="9781449361747:ch03.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch03.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch03.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch03.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%203.%20Lists%20and%20Tuples&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch03.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch02.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">2. Profiling to find bottlenecks</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch04.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">4. Dictionaries and Sets</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-lists-tuples"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;3.&nbsp;Lists and Tuples</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
What are lists and tuples good for?
</li><li class="listitem">
What is the complexity for a lookup in a list/tuple?
</li><li class="listitem">
How is that complexity achieved?
</li><li class="listitem">
What are the differences between lists and tuples?
</li><li class="listitem">
How does list append work?
</li><li class="listitem">
When should I use which one?
</li></ul></div></div><p>One of the most important things in writing efficient programs is understanding
the guarantees of the data structures you use.  In fact, a large part of
performant programming is understanding what questions you are trying to ask of
your data and picking a data structure that can answer these questions quickly.
In this chapter, we will talk about the kinds of questions that lists and tuples
can answer quickly, and how they do it.</p><p>Lists and tuples are a class of data structures called “arrays”.  Arrays are
simply a flat list of data with some intrinsic ordering.  This a priori
knowledge of the ordering is important: by knowing that data in our array is
at a specific position, we can retrieve it in <code class="literal">O(1)</code>!  In addition, arrays can
be implemented in multiple ways which demarcates another line between lists and
tuples: lists are dynamic arrays while tuples are static arrays.</p><p>Let’s unpack these previous statements a bit.  System memory on a computer can
be thought of as a series of numbered buckets, each capable of holding a number.
These numbers can be used to represent any variable we care about (integers,
floats, strings or other data structures) since they are simply references to
where the data is located in memory.<sup>[<a id="id459511" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#ftn.id459511" epub:type="noteref" class="footnote totri-footnote">7</a>]</sup></p><div class="figure"><a id="FIG-array-allocation"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 405; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/array_allocation.png" alt="Array Allocation" width="748" height="599" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/array_allocation.png"></div></div><div class="figure-title">Figure&nbsp;3-1.&nbsp;Example of system memory layout for an array of size 6.  Note that in python lists also store how large they are so, of the 6 allocated blocks only 5 are usable because the first element is the length.</div></div><p>When we want to create an array (and thus a list or tuple), we first have to
allocate a block of system memory.  This involves going to the
kernel [Link to Come], the operating system’s subprocess, and requesting the use
of N <span class="strong"><strong>consecutive</strong></span> buckets.  In order to look up any specific element in our
list, we simply need to know which element we want and remember which bucket our
data started in.  Since all of the data will occupy the same amount of space
(one “bucket” or, more specifically, one integer sized pointer to the actual
data), we don’t need to know anything about the type of data that is being
stored to do this calculation.  This will result in a structure similar to that
in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#FIG-array-allocation">Figure&nbsp;3-1</a>.</p><div class="tip"><h3 class="title">Tip</h3><p>If you knew where in memory your list of N elements started, how would <span class="strong"><strong>you</strong></span>
find an arbitrary element in the list?</p></div><p>If, for example, we needed to retrieve the first element in our array, we simply
go to the first bucket in our sequence, <code class="literal">M</code>, and read out the value inside it.
If, on the other hand, we needed the 5th element in our array, we simply need to
go to the <code class="literal">M+5</code> ‘th bucket and read its content.  In general, if we wanted to
retrieve element <code class="literal">i</code> from our array, we go to bucket <code class="literal">M+i</code>.  So, by having our
data stored in consecutive buckets, and having knowledge of the ordering of our
data, we can locate our data by knowing which bucket to look at in 1 step (or
<code class="literal">O(1)</code>) regardless of how big our array is (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#list_lookup_timing">Example&nbsp;3-1</a>).</p><div class="example"><a id="list_lookup_timing"></a><div class="example-title">Example&nbsp;3-1.&nbsp;Timings for list lookups for lists of different sizes</div><div class="example-contents"><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="o">%%</code><code class="n">timeit</code> <code class="n">l</code> <code class="o">=</code> <code class="nb">range</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>
<code class="go">        ...: l[5]</code>
<code class="go">        ...:</code>
<code class="go">10000000 loops, best of 3: 75.5 ns per loop</code>
<code class="go">&gt;&gt;&gt;</code>
<code class="gp">&gt;&gt;&gt; </code><code class="o">%%</code><code class="n">timeit</code> <code class="n">l</code> <code class="o">=</code> <code class="nb">range</code><code class="p">(</code><code class="mi">10000000</code><code class="p">)</code>
<code class="go">        ...: l[100000]</code>
<code class="go">        ...:</code>
<code class="go">10000000 loops, best of 3: 76.3 ns per loop</code></pre></div></div><p>What if we were given an array with an unknown order and wanted to retrieve an
particular element.  If the ordering were known, we could simply lookup that
particular value.  However, in this case, we must do a <code class="literal">search</code> operation.  The
most basic approach to this problem is called a “linear search” where we iterate
over every element in the array and check if it is the value we want, as seen in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#list_linear_search">Example&nbsp;3-2</a>.</p><div class="example"><a id="list_linear_search"></a><div class="example-title">Example&nbsp;3-2.&nbsp;Example of a linear search through a list</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">linear_search</code><code class="p">(</code><code class="n">needle</code><code class="p">,</code> <code class="n">array</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">i</code><code class="p">,</code> <code class="n">item</code> <code class="ow">in</code> <code class="nb">enumerate</code><code class="p">(</code><code class="n">array</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">item</code> <code class="o">==</code> <code class="n">needle</code><code class="p">:</code>
            <code class="k">return</code> <code class="n">i</code>
    <code class="k">return</code> <code class="o">-</code><code class="mi">1</code></pre></div></div><p>This algorithm has a worst-case performance of O(N).  This case occurs when we
search for something that isn’t in the array.  In order to know that the element
we are searching isn’t in the array, we must first check it with every other
element and we will reach the final <code class="literal">return -1</code> statement.  In fact, this
algorithm is exactly the algorithm that <code class="literal">list.index()</code>.</p><p>The only way to increase this speed is by having some other understanding of how
the data is placed in memory, or the arrangement of the buckets of data
we are holding.  For example, <a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_how_work">hash tables</a>, which are a
fundamental data structure powering <a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html">dictionaries</a> and
<a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html">sets</a>, solve this problem in <code class="literal">O(1)</code> by disregarding
any intrinsic ordering to the data and instead ascribing another, more peculiar,
organization.  Alternatively, if your data is sorted in a way where every item
is larger (or smaller) than it’s neighbor to the left (or right) then
specialized search algorithms can be used which can bring your lookup time down
to <code class="literal">O(log(n))</code>.  This may seem like an impossible step to take from the constant
time lookups before, but sometimes it is the best option (especially since
search algorithms are more flexible and allow you to define searches in creative
ways).</p><div class="tip"><h3 class="title">Search Problem</h3><p>Given the following data, write an algorithm to find the index of the value
<code class="literal">61</code>:</p><p><code class="literal">[9, 18, 18, 19, 29, 42, 56, 61, 88, 95]</code></p><p>Since you know the data is ordered, how can you do this faster?</p><p><span class="emphasis"><em>Hint</em></span>: If you split the array in half, you know all the values on the left are
smaller than the smallest element in the right set.  You can use this!</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_a_more_efficient_search">A more efficient search</h2></div></div></div><p>As alluded to before, we can achieve better search performance if we first
sort our data so that all elements to the left of a particular item are smaller
than it (or larger).  The comparison is done through the <code class="literal">__eq__</code> and <code class="literal">__lt__</code>
magic function of the object and can be user defined if using custom objects.</p><div class="note"><h3 class="title">Note</h3><p>Without the <code class="literal">__eq__</code> and <code class="literal">__lt__</code> methods, a custom object will only compare to
objects of the same type and the comparison will be done using the instance’s
placement in memory.</p></div><p>The two elements necessary are the sorting algorithm and then the searching
algorithm.  Python lists have a built in sorting algorithm that uses Tim Sort.
Tim Sort can sort through a list in <code class="literal">O(n)</code> in the best case (and <code class="literal">O(n logn)</code> in
the worst case).  It achieves this performance by utilizing multiple types of
sorting algorithms and using heuristics to guess which algorithm will perform the
best given the data (more specifically, it hybridizes insertion and merge sort
algorithms).</p><p>Once a list has been sorted, we can use a binary search algorithm
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#list_binary_search">Example&nbsp;3-3</a>) to find our desired element, which has an average case
complexity of <code class="literal">O(logn)</code>.  It achieves this by first looking at the middle of the
list and comparing this value with the desired value.  If this midpoint’s value
is less than our desired value, then we consider the left half of the list and
continue halving the list like this until the value is found.  As a result, we
do not need to read all values in the list as was necessary for the
<a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#list_linear_search">linear search</a> and instead only read a small subset of
them.</p><div class="example"><a id="list_binary_search"></a><div class="example-title">Example&nbsp;3-3.&nbsp;Efficient searching through a sorted list—binary search</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">binary_search</code><code class="p">(</code><code class="n">needle</code><code class="p">,</code> <code class="n">haystack</code><code class="p">):</code>
    <code class="n">imin</code><code class="p">,</code> <code class="n">imax</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">haystack</code><code class="p">)</code>
    <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">imin</code> <code class="o">&gt;=</code> <code class="n">imax</code><code class="p">:</code>
            <code class="k">return</code> <code class="o">-</code><code class="mi">1</code>
        <code class="n">midpoint</code> <code class="o">=</code> <code class="p">(</code><code class="n">imin</code> <code class="o">+</code> <code class="n">imax</code><code class="p">)</code> <code class="o">//</code> <code class="mi">2</code>
        <code class="k">if</code> <code class="n">haystack</code><code class="p">[</code><code class="n">midpoint</code><code class="p">]</code> <code class="o">&gt;</code> <code class="n">needle</code><code class="p">:</code>
            <code class="n">imax</code> <code class="o">=</code> <code class="n">midpoint</code>
        <code class="k">elif</code> <code class="n">haystack</code><code class="p">[</code><code class="n">midpoint</code><code class="p">]</code> <code class="o">&lt;</code> <code class="n">needle</code><code class="p">:</code>
            <code class="n">imin</code> <code class="o">=</code> <code class="n">midpoint</code><code class="o">+</code><code class="mi">1</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">return</code> <code class="n">midpoint</code></pre></div></div><p>This method allows us to find elements in a list without resorting to the
potentially heavy weight solution of a dictionary.  Especially when the list of
data that is being operated on is intrinsically sorted, it is more efficient to
simply do a binary search on the list to find an object (and get the <code class="literal">O(logn)</code>
complexity of the search) rather than converting your data to a dictionary and
then doing a lookup on it (although a dictionary lookup takes <code class="literal">O(1)</code>, converting
to a dictionary takes <code class="literal">O(n)</code> and a dictionary’s restriction of no repeating keys
may be undesirable).</p><p>In addition, the <code class="literal">bisect</code> module simplifies much of this process by giving easy
methods to add elements into a list while maintaining its sorting, in addition
to finding elements using a heavily optimized binary search.  This is done by
providing alternative functions to <code class="literal">append</code> that, instead of adding the new
element to the end of the list, adds the element into the correct sorted
placement.  With the list always being sorted, we can easily find the elements
we are looking for (examples of this can be found in the documentation for
the bisect module <sup>[<a id="id342432" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#ftn.id342432" class="footnote totri-footnote">8</a>]</sup>).  In
addition, we can use bisect to find the closest element to what we are looking
for very quickly (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#list_bisect_example">Example&nbsp;3-4</a>).  This can be extremely useful when
comparing two datasets that are similar but do not have exactly the same
results.</p><div class="example"><a id="list_bisect_example"></a><div class="example-title">Example&nbsp;3-4.&nbsp;Finding close values in a list with the <code class="literal">bisect</code> module</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">bisect</code>
<code class="kn">import</code> <code class="nn">random</code>

<code class="k">def</code> <code class="nf">find_closest</code><code class="p">(</code><code class="n">haystack</code><code class="p">,</code> <code class="n">needle</code><code class="p">):</code>
    <code class="c"># bisect.bisect_left will return the first value in the haystack that is greater</code>
    <code class="c"># than or equal to the needle</code>
    <code class="n">i</code> <code class="o">=</code> <code class="n">bisect</code><code class="o">.</code><code class="n">bisect_left</code><code class="p">(</code><code class="n">haystack</code><code class="p">,</code> <code class="n">needle</code><code class="p">)</code>
    <code class="k">if</code> <code class="n">i</code> <code class="o">==</code> <code class="nb">len</code><code class="p">(</code><code class="n">haystack</code><code class="p">):</code>
        <code class="k">return</code> <code class="n">i</code> <code class="o">-</code> <code class="mi">1</code>
    <code class="k">elif</code> <code class="n">haystack</code><code class="p">[</code><code class="n">i</code><code class="p">]</code> <code class="o">==</code> <code class="n">needle</code><code class="p">:</code>
        <code class="k">return</code> <code class="n">i</code>
    <code class="k">elif</code> <code class="n">i</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>
        <code class="n">j</code> <code class="o">=</code> <code class="n">i</code> <code class="o">-</code> <code class="mi">1</code>
        <code class="c"># since we know value is larger than needle (and vice versa for the</code>
        <code class="c"># value at j), we don't need to use absolute values here</code>
        <code class="k">if</code> <code class="n">haystack</code><code class="p">[</code><code class="n">i</code><code class="p">]</code> <code class="o">-</code> <code class="n">needle</code> <code class="o">&gt;</code> <code class="n">needle</code> <code class="o">-</code> <code class="n">haystack</code><code class="p">[</code><code class="n">j</code><code class="p">]:</code>
            <code class="k">return</code> <code class="n">j</code>
    <code class="k">return</code> <code class="n">i</code>

<code class="n">important_numbers</code> <code class="o">=</code> <code class="p">[]</code>
<code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">10</code><code class="p">):</code>
    <code class="n">new_number</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1000</code><code class="p">)</code>
    <code class="n">bisect</code><code class="o">.</code><code class="n">insort</code><code class="p">(</code><code class="n">important_numbers</code><code class="p">,</code> <code class="n">new_number</code><code class="p">)</code>

<code class="c"># important_numbers will be already in order because we inserted new elements</code>
<code class="c"># with bisect.insort</code>
<code class="k">print</code> <code class="n">important_numbers</code>

<code class="n">closest_index</code> <code class="o">=</code> <code class="n">find_closest</code><code class="p">(</code><code class="n">important_numbers</code><code class="p">,</code> <code class="o">-</code><code class="mi">250</code><code class="p">)</code>
<code class="k">print</code> <code class="s">"Closest value to -250: "</code><code class="p">,</code> <code class="n">important_numbers</code><code class="p">[</code><code class="n">closest_index</code><code class="p">]</code>

<code class="n">closest_index</code> <code class="o">=</code> <code class="n">find_closest</code><code class="p">(</code><code class="n">important_numbers</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>
<code class="k">print</code> <code class="s">"Closest value to 500: "</code><code class="p">,</code> <code class="n">important_numbers</code><code class="p">[</code><code class="n">closest_index</code><code class="p">]</code>

<code class="n">closest_index</code> <code class="o">=</code> <code class="n">find_closest</code><code class="p">(</code><code class="n">important_numbers</code><code class="p">,</code> <code class="mi">1100</code><code class="p">)</code>
<code class="k">print</code> <code class="s">"Closest value to 1100: "</code><code class="p">,</code> <code class="n">important_numbers</code><code class="p">[</code><code class="n">closest_index</code><code class="p">]</code></pre></div></div><p>In general this touches on a fundamental rule of writing efficient code: pick
the right data structure and stick with it!  Although there may be more
efficient data structures for particular operations, the cost of the conversion
to that data structure may defeat any efficiency boost.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_lists_vs_tuples">Lists vs Tuples</h2></div></div></div><p>If lists and tuples both use the same underlying data structure, what are the
differences between the two?  Summarized, the main differences are:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Lists are a type of array called “dynamic arrays” and as a result are mutable
    and allow for resizing the number of elements that can be held
</li><li class="listitem">
Tuples are a type of array called “static arrays” which makes them immutable
    and the data within them cannot be changed or resized once they have been
    created
</li><li class="listitem">
Tuples have some caching of memory which means that we don’t need to talk to
    the kernel to reserve memory every time we want to use one.
</li></ol></div><p>These differences instill the philosophical difference between the two: tuples
are for describing multiple properties of one unchanging thing and lists can be
used to store collections of data about completely disparate objects.  For
example, the parts of a telephone number are perfect for a tuple: they won’t change and
if they do they represent a new object or a different phone number.  Similarly,
the coefficients of a polynomial fit a tuple since different coefficients
represent a different polynomial.  On the other hand, the names of the people
currently reading this book are better suited for a list: the data is constantly
changing both in content and in size but is still always representing the same
idea.</p><p>It is important to note that both lists and tuples can take mixed types.  This
can, as we will see, introduce quite some overhead and reduce some potential
optimizations.  These overheads can be removed if we also force all the data in
our list to be of the same type.  In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a> we will talk about
reducing both the memory and computational overhead by using <code class="literal">numpy</code>. In
addition, other packages such as <code class="literal">blist</code> and <code class="literal">array</code> can also reduce these
overheads for other, non-numerical, situations.  This alludes to a major point
in performant programming that we will touch on in later chapters: abstract code
will be much slower than code specifically designed to solve a particular
problem.</p><p>In addition, the immutability of a tuple, opposed to a list which can be resized
and changed, makes them a very lightweight data structure.  This means that there
isn’t much overhead in memory when storing them and operations with them are
quite straightforward.  With lists, as we will learn, their
mutability [Link to Come] comes at a price of extra memory needed to store
them and extra computations necessary when using them.</p><div class="tip"><h3 class="title">Tip</h3><p><span class="strong"><strong>What type would you use?</strong></span>
For the following example datasets, would you use a tuple or a list?</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
First 20 prime numbers
</li><li class="listitem">
Names of programming languages
</li><li class="listitem">
A person’s age, weight and height
</li><li class="listitem">
A person’s birthday and birthplace
</li><li class="listitem">
The result of a particular game of pool
</li><li class="listitem">
The results of a continuing series of pool games
</li></ol></div><p>Solution:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<code class="literal">tuple</code> since the data is static and will not change
</li><li class="listitem">
<code class="literal">list</code> since this dataset is constantly growing
</li><li class="listitem">
<code class="literal">list</code> since the values will need to be updated
</li><li class="listitem">
<code class="literal">tuple</code> since that information is static and will not change
</li><li class="listitem">
<code class="literal">tuple</code> since the data is static
</li><li class="listitem">
<code class="literal">list</code> since more games will be played (In fact, we could use a list of tuples since each individual game’s metadata will not change, but we will need to add more of them as more games are played).
</li></ol></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="list_as_dynamic_arrays">Lists as dynamic arrays</h3></div></div></div><p>Once we create a list, we are free to change its contents as needed,</p><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">numbers</code> <code class="o">=</code> <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">6</code><code class="p">]</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">numbers</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code> <code class="o">=</code> <code class="mi">2</code><code class="o">*</code><code class="n">numbers</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>  <code class="c"># </code><a id="CO1-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
<code class="gp">&gt;&gt;&gt; </code><code class="n">numbers</code>
<code class="go">[5, 8, 10, 3, 2, 6]</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#CO1-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
As described before, this operation is <code class="literal">O(1)</code> because we can find the data
stored within the 0th and 2nd elements immediately.
</p></dd></dl></div><p>In addition, we can append new data to a list and grow it’s size:</p><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="nb">len</code><code class="p">(</code><code class="n">numbers</code><code class="p">)</code>
<code class="go">6</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">numbers</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="mi">42</code><code class="p">)</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">numbers</code>
<code class="go">[5, 8, 10, 3, 2, 6, 42]</code>
<code class="gp">&gt;&gt;&gt; </code><code class="nb">len</code><code class="p">(</code><code class="n">numbers</code><code class="p">)</code>
<code class="go">7</code></pre><p>This is possible because dynamic arrays support a <code class="literal">resize</code> operation which
increases the capacity of the array.  When a list is of size <code class="literal">N</code> is first
appended to, python must create a new list that is big enough to hold the
original <code class="literal">N</code> items in addition to the extra one that is being appended.
However, instead of allocating <code class="literal">N+1</code> items, <code class="literal">M</code> items are actually allocated
where <code class="literal">M&gt;N</code> in order to provide extra headroom for future appends.  Then, the
data from the old list is copied to the new list and the old list is destroyed.
The philosophy is that one append is probably the beginning of many appends and
by requesting extra space we can reduce the number of times this allocation must
happen and the total number of memory copies that are necessary.  This is quite
important since memory copies can be quite expensive, especially when list sizes
start growing.  Figure <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#FIG-list-overallocation">Figure&nbsp;3-2</a> shows what this
overallocation looks like in python2.7.  The formula dictating this growth is:</p><div class="example"><a id="eq_list_M"></a><div class="example-title">Example&nbsp;3-5.&nbsp;List overallocation equation in py2.7</div><div class="example-contents"><pre class="programlisting"><code class="n">M</code> <code class="o">=</code> <code class="p">(</code><code class="n">N</code> <code class="o">&gt;&gt;</code> <code class="mi">3</code><code class="p">)</code> <code class="o">+</code> <code class="p">(</code><code class="n">N</code> <code class="o">&lt;</code> <code class="mi">9</code> <code class="err">?</code> <code class="mi">3</code> <code class="p">:</code> <code class="mi">6</code><code class="p">)</code></pre><div class="informaltable"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"><col class="col_8"><col class="col_9"><col class="col_10"></colgroup><tbody><tr><td style="border-bottom: 0.5pt solid ; "><p><span class="strong"><strong>N</strong></span></p></td><td style="border-bottom: 0.5pt solid ; "><p>0</p></td><td style="border-bottom: 0.5pt solid ; "><p>1-4</p></td><td style="border-bottom: 0.5pt solid ; "><p>5-8</p></td><td style="border-bottom: 0.5pt solid ; "><p>9-16</p></td><td style="border-bottom: 0.5pt solid ; "><p>17-25</p></td><td style="border-bottom: 0.5pt solid ; "><p>26-35</p></td><td style="border-bottom: 0.5pt solid ; "><p>36-46</p></td><td style="border-bottom: 0.5pt solid ; "><p>…</p></td><td style="border-bottom: 0.5pt solid ; "><p>991-1120</p></td></tr><tr><td><p><span class="strong"><strong>M</strong></span></p></td><td><p>0</p></td><td><p>4</p></td><td><p>8</p></td><td><p>16</p></td><td><p>25</p></td><td><p>35</p></td><td><p>46</p></td><td><p>…</p></td><td><p>1120</p></td></tr></tbody></table></div></div></div><div class="figure"><a id="FIG-list-overallocation"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/list_overallocation.png" alt="scaledheight=50%" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/list_overallocation.png"></div></div><div class="figure-title">Figure&nbsp;3-2.&nbsp;This graph shows how many extra elements are being allocated to a list of a particular size</div></div><p>As we append data, we utilize the extra space and increase the effective size of
the list, N.  As a result, N grows as we append new data until N == M.  At this
point, there is no extra space to insert new data into and we must create a
<span class="emphasis"><em>new</em></span> list with more extra space.  This new list has extra headroom as given by
<a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#eq_list_M">the equation above</a> and we copy the old data into the new space.</p><p>This sequence of events is shown visually in Figure <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#FIG-list-append">Figure&nbsp;3-3</a>
below.  The figure follows the various operations being performed on list <code class="literal">l</code>
in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#code_list_resize">Example&nbsp;3-6</a>.</p><div class="example"><a id="code_list_resize"></a><div class="example-title">Example&nbsp;3-6.&nbsp;Resizing of a list</div><div class="example-contents"><pre class="programlisting"><code class="n">l</code> <code class="o">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">]</code>
<code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">7</code><code class="p">):</code>
    <code class="n">l</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">i</code><code class="p">)</code></pre></div></div><div class="figure"><a id="FIG-list-append"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 135; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/list_resize.png" alt="Example of how a list is mutated on multiple appends" width="313" height="849" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/list_resize.png"></div></div><div class="figure-title">Figure&nbsp;3-3.&nbsp;Example of how a list is mutated on multiple appends</div></div><div class="note"><h3 class="title">Note</h3><p>This extra allocation happens on the first <span class="strong"><strong>append</strong></span>.  When a list is
directly created, as in the example above, only the number of elements needed
are allocated.</p></div><p>While the amount of extra headroom allocated is generally quite small, it can
add up.  This effect becomes especially pronounced when maintaining many small
lists or when keeping a particularly large list.  If we are storing 1,000,000
lists, each containing 10 elements, we would suppose that 10,000,000 elements
worth of memory is being used.  In actuality, however, up to 16,000,000
elements could have been allocated if the <code class="literal">append</code> operator was used to
construct the list.  Similarly, for a large list of 100,000,000 elements, we
actually have 112,500,007 elements allocated!</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="tuples_as_static_arrays">Tuples as static arrays</h3></div></div></div><p>Tuples are fixed and immutable.  This means that once a tuple is created, unlike
lists, it cannot be modified or resized.</p><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">t</code> <code class="o">=</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">)</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">t</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">=</code> <code class="mi">5</code>
<code class="gt">Traceback (most recent call last):</code>
  File <code class="nb">"&lt;stdin&gt;"</code>, line <code class="m">1</code>, in <code class="n">&lt;module&gt;</code>
<code class="gr">TypeError</code>: <code class="n">'tuple' object does not support item assignment</code></pre><p>However, although they don’t support resizing, we can concatenate two tuples
together and form a new tuple.  The operation is similar to the resize operation
on lists, however we do not allocate any extra space for the resulting tuple.</p><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">t1</code> <code class="o">=</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">)</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">t2</code> <code class="o">=</code> <code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">)</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">t1</code> <code class="o">+</code> <code class="n">t2</code>
<code class="go">(1, 2, 3, 4, 5, 6, 7, 8)</code></pre><p>If we consider this to be comparable to the <code class="literal">append</code> operation on lists, we see
that it performs in <code class="literal">O(N)</code> as opposed to the <code class="literal">O(1)</code> speed of lists.  This is
because the allocate/copy operations must happen each time we add something new
to the tuple, as opposed to only when our extra headroom ran out for lists.  As
a result of this, there is no in place append-like operation; addition of two
tuples always returns a new tuple that is in a new location in memory.</p><p>Not storing the extra headroom for resizing has the advantage of using less
resources.  A list of size 100,000,000 created with any append operations
actually uses 112,500,007 elements worth of memory while a tuple holding the
same data will only ever use exactly 100,000,000 elements of memory.  This makes
tuples lightweight and preferable when data becomes static.</p><p>Furthermore, even if we created a list <span class="emphasis"><em>without</em></span> append (and thus we don’t have
the extra headroom introduced by an append operation), it is <span class="strong"><strong>still</strong></span> larger in
memory compared to a tuple with the same data.  This is because lists have to
keep track of more information about it’s current state in order to efficiently
resize.  While this extra information is quite small (the equivalent of one
extra element), it can add up if several million lists are in use.</p><p>Another benefit of the static nature of tuples is something python does in the
background: resource caching.  Python is garbage collected, which means that
when a variable isn’t used anymore python frees the use of the memory back to
the operating system for use in other applications (or other variables).</p><p>For tuples of sizes 1-20, when they are no longer used the space isn’t
immediately given back to the system but rather saved for future use.  This
makes it so that when a new tuple of that size is needed in the future we don’t
need to communicate with the operating system to find a region in memory to put
the data since we have a reserve of free memory already.</p><p>While this may seem like a small benefit, it is one of the fantastic things
about tuples: they can be created easily and quickly since communications with
the operating system can cost your program quite a bit of time.
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#code_tuple_vs_list_init">Example&nbsp;3-7</a> shows that instantiating a list can be 5.1x slower
than instantiating a tuple which can add up quite quickly if this is done in a
fast loop!</p><div class="example"><a id="code_tuple_vs_list_init"></a><div class="example-title">Example&nbsp;3-7.&nbsp;Instantiation timings for lists versus tuples</div><div class="example-contents"><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="o">%</code><code class="n">timeit</code> <code class="n">l</code> <code class="o">=</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">,</code><code class="mi">9</code><code class="p">]</code>
<code class="go">1000000 loops, best of 3: 285 ns per loop</code>
<code class="gp">&gt;&gt;&gt; </code><code class="o">%</code><code class="n">timeit</code> <code class="n">t</code> <code class="o">=</code> <code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">,</code><code class="mi">9</code><code class="p">)</code>
<code class="go">10000000 loops, best of 3: 55.7 ns per loop</code></pre></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_wrap_up">Wrap Up</h2></div></div></div><p>Lists and tuples are fast and low overhead objects to use when your data already
has an intrinsic ordering to it.  This intrinsic ordering allows you to
sidestep the search problem in these structures, if the ordering is known
beforehand then lookups are <code class="literal">O(1)</code> instead of needing an expensive <code class="literal">O(N)</code> linear
search.  While lists can be resized, care needs to be taken to properly
understand how much overallocation is happening to ensure that the dataset can
still fit in memory.  On the other hand, tuples can be created quickly and
without the added overhead of lists, at the cost of not being modifiable.</p><p>In the next chapter, we go over the computational properties of dictionaries
that solve the search/lookup problems with un-ordered data at the cost of
overhead.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" epub:type="footnote" id="ftn.id459511"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#id459511" class="simpara totri-footnote">7</a>] </sup>In 64 bit computers, having 12KB
of memory gives you 725 buckets and 52Gb of memory gives you 3,250,000,000
buckets!</p></div><div class="footnote" id="ftn.id342432"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#id342432" class="simpara totri-footnote">8</a>] </sup><a class="ulink" href="https://docs.python.org/2/library/bisect.html" target="_top">https://docs.python.org/2/library/bisect.html</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch02.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">2. Profiling to find bottlenecks</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch04.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">4. Dictionaries and Sets</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch03.html" data-for-analytics="9781449361747:ch03.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    <div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#">Reset</a>
</div>
</div>
    
  

<div class="annotator-notice"></div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch04.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch04.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch04.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch04.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>4. Dictionaries and Sets - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch04.html"><meta name="description" content="Chapter&nbsp;4.&nbsp;Dictionaries and Sets Questions you’ll be able to answer after this chapter What are dictionaries and sets good for? How are dictionaries and sets the same? What ... "><meta property="og:title" content="4. Dictionaries and Sets"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="4. Dictionaries and Sets"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch04.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;4.&nbsp;Dictionaries and Sets Questions you’ll be able to answer after this chapter What are dictionaries and sets good for? How are dictionaries and sets the same? What ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch04.html" data-for-analytics="9781449361747:ch04.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch04.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch04.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch04.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%204.%20Dictionaries%20and%20Sets&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch04.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch03.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">3. Lists and Tuples</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch05.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">5. Iterators and Generators</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="section-dictionary-sets"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;4.&nbsp;Dictionaries and Sets</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
What are dictionaries and sets good for?
</li><li class="listitem">
How are dictionaries and sets the same?
</li><li class="listitem">
What is the overhead when using a dictionary?
</li><li class="listitem">
How can I optimize the performance of a dictionary?
</li><li class="listitem">
How does Python use dictionaries to keep track of namespaces?
</li></ul></div></div><p>Sets and dictionaries are ideal data structures to be used when your data has no
intrinsic order, but does have a unique object that can be used to reference it
(the reference object is normally a string, but can be any <span class="emphasis"><em>hashable</em></span> type).
This reference object is called the “key” while the data is the “value”.
Furthermore, dictionaries and sets are almost identical except that sets do not
actually contain data, they are simply a collection of unique keys.  As the name
implies, this is very useful for doing set operations.</p><div class="note"><h3 class="title"><a id="note-hashable-type"></a>Note</h3><p>A hashable type is one that implements both the <code class="literal">__hash__</code> magic function and
either <code class="literal">__eq__</code> or <code class="literal">__cmp__</code>.  All native types in python already implement
these and any user classes have default values.  See
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#SEC-dict-set-hash-and-entropy">Hash functions and Entropy</a> for more details.</p></div><p>While before we were restricted to, at best, <code class="literal">O(log n)</code> lookup time on
lists/tuples with no intrinsic order (through a search operation), dictionaries
and sets give us <code class="literal">O(1)</code> lookups based on the arbitrary index.  In addition, like
lists/tuples, dictionaries and sets have <code class="literal">O(1)</code> insertion time <sup>[<a id="id341283" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#ftn.id341283" epub:type="noteref" class="footnote totri-footnote">9</a>]</sup>.  As we will see later (in the
<a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_how_work">next section</a>), this sort of speed is accomplished through
the use of an open address hash table as the underlying data structure.</p><p>However, there is a cost in using dictionaries.  First, they generally take up a
larger footprint in memory.  Also, although the complexity for
insertions/lookups is <code class="literal">O(1)</code>, this depends greatly on the hashing function that
is in use.  If the hash function is slow to evaluate, then any operations on
dictionaries or sets will be similarly slow.</p><p>Let’s look at an example.  Say we want to store contact information for everyone
in the phonebook.  We would like to store this in a form that will make it
simple to answer the question “What is John Doe’s phone number?” in the future.
With lists, we would store the phone numbers and names sequentially and scan
through the entire list to find the phone number we required as shown in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_phonebook_list">Example&nbsp;4-1</a>.</p><div class="example"><a id="dict_set_phonebook_list"></a><div class="example-title">Example&nbsp;4-1.&nbsp;Phonebook lookup with a list</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">find_phonenumber</code><code class="p">(</code><code class="n">phonebook</code><code class="p">,</code> <code class="n">name</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">n</code><code class="p">,</code> <code class="n">p</code> <code class="ow">in</code> <code class="n">phonebook</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">n</code> <code class="o">==</code> <code class="n">name</code><code class="p">:</code>
            <code class="k">return</code> <code class="n">p</code>
    <code class="k">return</code> <code class="bp">None</code>

<code class="n">phonebook</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">(</code><code class="s">"John Doe"</code><code class="p">,</code> <code class="s">"555-555-5555"</code><code class="p">),</code>
    <code class="p">(</code><code class="s">"Albert Einstein"</code><code class="p">,</code> <code class="s">"212-555-5555"</code><code class="p">),</code>
<code class="p">]</code>
<code class="k">print</code> <code class="s">"John Doe's phone number is"</code><code class="p">,</code> <code class="n">find_phonenumber</code><code class="p">(</code><code class="n">phonebook</code><code class="p">,</code> <code class="s">"John Doe"</code><code class="p">)</code></pre></div></div><div class="note"><h3 class="title">Note</h3><p>This could also be done by sorting the list and using the <code class="literal">bisect</code> module in
order to get <code class="literal">O(log n)</code> performance.</p></div><p>With a dictionary, however, we can simply have the “index” be the names and the
“values” be the phone numbers as shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_phonebook_dict">Example&nbsp;4-2</a>.  This
allows us to simply lookup the value we need and get a direct reference to it
instead of having to read every value in our dataset.</p><div class="example"><a id="dict_set_phonebook_dict"></a><div class="example-title">Example&nbsp;4-2.&nbsp;Phonebook lookup with a dictionary</div><div class="example-contents"><pre class="programlisting"><code class="n">phonebook</code> <code class="o">=</code> <code class="p">{</code>
    <code class="s">"John Doe"</code><code class="p">:</code> <code class="s">"555-555-5555"</code><code class="p">,</code>
    <code class="s">"Albert Einstein"</code> <code class="p">:</code> <code class="s">"212-555-5555"</code><code class="p">,</code>
<code class="p">}</code>
<code class="k">print</code> <code class="s">"John Doe's phone number is"</code><code class="p">,</code> <code class="n">phonebook</code><code class="p">[</code><code class="s">"John Doe"</code><code class="p">]</code></pre></div></div><p>For large phonebooks, the difference between the <code class="literal">O(1)</code> lookup of the dictionary
and the <code class="literal">O(n)</code> time for linear search over the list (or, at best, the <code class="literal">O(log n)</code>
with the bisect module) is quite substantial.</p><div class="tip"><h3 class="title">Tip</h3><p>Create a script that times the performance of the list-bisect method vs a
dictionary for finding a number in a phonebook.  How does the timing scale as
the size of the phonebook grows?</p></div><p>If, on the other hand, we wanted to answer the question “How many unique first
names are there in my phonebook” we could use the power of sets.  Recall that
sets are simply a collection of <span class="strong"><strong>unique</strong></span> keys, which is exactly a property we
would like to enforce in our data.  This is in stark difference to a list
approach where that property needs to be enforced separately from the
data structure by comparing all names with all other names.  Below is a
comparison of both approaches:</p><div class="example"><a id="alt_dup_layout"></a><div class="example-title">Example&nbsp;4-3.&nbsp;Finding unique names with lists and sets</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">list_unique_names</code><code class="p">(</code><code class="n">phonebook</code><code class="p">):</code>
    <code class="n">unique_names</code> <code class="o">=</code> <code class="p">[]</code>
    <code class="k">for</code> <code class="n">name</code><code class="p">,</code> <code class="n">phonenumber</code> <code class="ow">in</code> <code class="n">phonebook</code><code class="p">:</code>             <code class="c"># </code><a id="CO2-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
        <code class="n">first_name</code><code class="p">,</code> <code class="n">last_name</code> <code class="o">=</code> <code class="n">name</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s">" "</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
        <code class="k">for</code> <code class="n">unique</code> <code class="ow">in</code> <code class="n">unique_names</code><code class="p">:</code>                 <code class="c"># </code><a id="CO2-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
            <code class="k">if</code> <code class="n">unique</code> <code class="o">==</code> <code class="n">first_name</code><code class="p">:</code>
                <code class="k">break</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="n">unique_names</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">first_name</code><code class="p">)</code>
    <code class="k">return</code> <code class="nb">len</code><code class="p">(</code><code class="n">unique_names</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">set_unique_names</code><code class="p">(</code><code class="n">phonebook</code><code class="p">):</code>
    <code class="n">unique_names</code> <code class="o">=</code> <code class="nb">set</code><code class="p">()</code>
    <code class="k">for</code> <code class="n">name</code><code class="p">,</code> <code class="n">phonenumber</code> <code class="ow">in</code> <code class="n">phonebook</code><code class="p">:</code>             <code class="c"># </code><a id="CO2-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">
        <code class="n">first_name</code><code class="p">,</code> <code class="n">last_name</code> <code class="o">=</code> <code class="n">name</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s">" "</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
        <code class="n">unique_names</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">first_name</code><code class="p">)</code>                <code class="c"># </code><a id="CO2-4"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png">
    <code class="k">return</code> <code class="nb">len</code><code class="p">(</code><code class="n">unique_names</code><code class="p">)</code>

<code class="n">phonebook</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">(</code><code class="s">"John Doe"</code><code class="p">,</code> <code class="s">"555-555-5555"</code><code class="p">),</code>
    <code class="p">(</code><code class="s">"Albert Einstein"</code><code class="p">,</code> <code class="s">"212-555-5555"</code><code class="p">),</code>
    <code class="p">(</code><code class="s">"John Murphey"</code><code class="p">,</code> <code class="s">"202-555-5555"</code><code class="p">),</code>
    <code class="p">(</code><code class="s">"Albert Rutherford"</code><code class="p">,</code> <code class="s">"647-555-5555"</code><code class="p">),</code>
    <code class="p">(</code><code class="s">"Elaine Bodian"</code><code class="p">,</code> <code class="s">"301-555-5555"</code><code class="p">),</code>
<code class="p">]</code>

<code class="k">print</code> <code class="s">"Number of unique names from set method:"</code><code class="p">,</code> <code class="n">set_unique_names</code><code class="p">(</code><code class="n">phonebook</code><code class="p">)</code>
<code class="k">print</code> <code class="s">"Number of unique names from list method:"</code><code class="p">,</code> <code class="n">list_unique_names</code><code class="p">(</code><code class="n">phonebook</code><code class="p">)</code></pre></div></div><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#CO2-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#CO2-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
We must go over all items in our phonebook and thus this loop costs <code class="literal">O(n)</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#CO2-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
Here we must check the current name with all unique names we have already seen.  If it is a new unique name, we must search the entire list.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#CO2-4"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></a> </dt><dd><p>
For the set method, instead of iterating over all unique names we have already seen, we can simply add the current name to our set of unique names.  This is because sets guarantee uniqueness over the keys it contains.  Furthermore, this operation costs <code class="literal">O(1)</code>.
</p></dd></dl></div><p>The list algorithm’s inner loop iterates over <code class="literal">unique_names</code>, which starts out
as empty and then grows, in the worst case, when all names are unique, to be the
size of <code class="literal">phonebook</code>.  This can be seen as performing a
<a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html#list_linear_search">linear search</a> for each name in the phonebook over a list
that is constantly growing.  Thus, the complete algorithms performs as <code class="literal">O(n log
n)</code> since the outer loop contributes the <code class="literal">O(n)</code> factor, while the inner loop
contributes the <code class="literal">O(log n)</code> factor.</p><p>On the other hand, the set algorithm has no inner loop; the <code class="literal">set.add</code> operation
is an <code class="literal">O(1)</code> process which completes in a fixed number of operations regardless
of how large the phonebook is (there are some minor caveats to this which we
will cover while discussing the implementation of dictionaries and sets).  Thus,
the only non-constant contribution to the complexity of this algorithm is the
loop over the phonebook, making this algorithm perform in <code class="literal">O(n)</code>.</p><p>When timing these two algorithms using a phonebook with 10,000 entries and 7,422
unique first names, we see how drastic the difference between <code class="literal">O(n)</code> and <code class="literal">O(n
log n)</code> can be.</p><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="o">%</code><code class="n">timeit</code> <code class="n">list_unique_names</code><code class="p">(</code><code class="n">large_phonebook</code><code class="p">)</code>
<code class="go">1 loops, best of 3: 2.56 s per loop</code>

<code class="gp">&gt;&gt;&gt; </code><code class="o">%</code><code class="n">timeit</code> <code class="n">set_unique_names</code><code class="p">(</code><code class="n">large_phonebook</code><code class="p">)</code>
<code class="go">100 loops, best of 3: 9.57 ms per loop</code></pre><p>In other words, the set algorithm gave us a 267x speedup!  In addition, as the
size of the phonebook grows the speed gains increase (we get a 557x speedup
with a phonebook with 100,000 entries and 15,574 unique first names).</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="dict_set_how_work">How do dictionaries and sets work?</h2></div></div></div><p>Dictionaries and sets use a hash table in order to achieve its <code class="literal">O(1)</code> lookup
and insertions.  This efficiency is a result of a very clever usage of
hash functions [Link to Come] in order to create list-like indexes
for data.  By turning the data’s key into something that can be used like a list
index, we can get the same the same performance as a list.  In addition, instead
of having to refer to data by a numerical index, which itself implies some
ordering to the data, we can refer to it by this arbitrary key.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_inserting_and_retrieving">Inserting and Retrieving</h3></div></div></div><p>In order to create a hash table from scratch, we start with some allocated
memory, similar to what we started with for arrays.  For an array, if we wanted
to insert data, we simply find the smallest unused bucket and insert our data
there (and resize if necessary). For hash tables, we must first figure out the
placement of the data in this contiguous chunk of memory.</p><p>The placement of the new data is contingent on two properties of the data you
are inserting: the hashed value of the key and how the value compares to other
objects.  This is because when we insert data, first the key is hashed and
masked so that it turns into an effective index in an array.<sup>[<a id="id502563" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#ftn.id502563" epub:type="noteref" class="footnote">10</a>]</sup>  The mask makes sure that the hash value,
which can take the value of any integer, fits within the allocated number of
buckets.  So, if we have allocated 8 blocks of memory and our hash value is
28975, we consider the bucket at index <code class="literal">28975 &amp; 0b111 = 7</code>.  If, however, our
dictionary has grown to have 256 items then the mask becomes <code class="literal">0b11111111</code>.  Now
we must check if this bucket is already in use.  If it is empty, we can insert
the key and the value into this block of memory.  We store the key so that we
can make sure we are retrieving the correct value on lookups.  If it is in use
and the value of the bucket is equal to the value we wish to insert (a
comparison done with the <code class="literal">cmp</code> builtin), then the key/value pair is already in
the hash table and we can return.  However, if the values don’t match then we
must find a new place to put the data.</p><p>In order to find a new index, we compute a new index using a simple linear
function, a method called probing.  In addition, python’s probing mechanism adds
a contribution from higher order bits of the original hash (recall that for a
table of length 8 we only considered the last 3 bits of the hash for the initial
index through the use of a mask value of <code class="literal">mask = 0b111 = bin(8 - 1)</code>).  Using
these higher order bits gives each hash a different sequence of next possible
hashes, which helps to avoid future collisions.  There is a lot of freedom when
picking the algorithm to generate a new index, however it is quite important
that the scheme visits every possible index in order to evenly distribute the
data in the table.  How well distributed the data is throughout the hash table
is called the “load factor” and is related to the
<a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#SEC-dict-set-hash-and-entropy">entropy</a> of the hash function.  The following
pseudo-code illustrates the calculation of hash indexes used in cpython2.7:</p><div class="example"><a id="dict_set_index_sequence"></a><div class="example-title">Example&nbsp;4-4.&nbsp;Dictionary lookup sequence</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">index_sequence</code><code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="n">mask</code><code class="o">=</code><code class="mi">0</code><code class="n">b111</code><code class="p">,</code> <code class="n">PERTURB_SHIFT</code><code class="o">=</code><code class="mi">5</code><code class="p">):</code>
    <code class="n">perturb</code> <code class="o">=</code> <code class="nb">hash</code><code class="p">(</code><code class="n">key</code><code class="p">)</code> <a id="CO3-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">i</code> <code class="o">=</code> <code class="n">perturb</code> <code class="o">&amp;</code> <code class="n">mask</code>
    <code class="k">yield</code> <code class="n">i</code>
    <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>
        <code class="n">i</code> <code class="o">=</code> <code class="p">((</code><code class="n">i</code> <code class="o">&lt;&lt;</code> <code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="n">i</code> <code class="o">+</code> <code class="n">perturb</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
        <code class="n">perturb</code> <code class="o">&gt;&gt;=</code> <code class="n">PERTURB_SHIFT</code>
        <code class="k">yield</code> <code class="n">i</code> <code class="o">&amp;</code> <code class="n">mask</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#CO3-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
<code class="literal">hash</code> returns an integer while the actual C code in CPython uses an unsigned integer.  Because of this, the above pseudocode doesn’t 100% replicate the behaviour in CPython, however it is a good approximation.
</p></dd></dl></div></div></div><p>This probing is a modification of the naive method of “linear probing”.  In
linear probing, we simply yield the values <code class="literal">i = (5*i + 1) &amp; mask</code> where <code class="literal">i</code> is
initialized to the hash value of the key and the value <code class="literal">5</code> is unimportant
<sup>[<a id="id505567" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#ftn.id505567" epub:type="noteref" class="footnote">11</a>]</sup>.  An important thing
to note is that linear probing only deals with the several bytes of the hash and
disregards the rest (ie: for a dictionary with 8 elements, we only look at the
last 3 bits).  This means that if two item’s hash have the same last 3 binary
digits, we will not only have a collision, but the sequence of probed indexes
will be the same.  The perturbed scheme that python uses will start taking into
consideration more bits from the items hash in order to resolve this problem.</p><p>A similar procedure is done when we are performing lookups on a specific key:
the given key is transformed into an index and that index is looked at.  If the
key in that index matches (recall that we also store the original key when doing
insert operations), then we can return that value.  If it doesn’t, we keep
creating new indexes using the same scheme as above until we either find the
data or hit an empty bucket.  If we hit an empty bucket, we can conclude that
the data does not exist in the table.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#FIG-hash-set-theory-example1">Figure&nbsp;4-1</a>, illustrates the process of adding some data
into a hash table.  Here, we chose the hashing function to be simply the ascii
value of the first letter of the key using Python’s <code class="literal">ord</code> function which returns
an integer ordinal for a single character string.  As we’ll see later in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#SEC-dict-set-hash-and-entropy">Hash functions and Entropy</a>, python provides hashing functions for most of
its types so it is normally not necessary to provide one yourself except in
extreme situations.  Insertion of the key “Barcelona” causes a collision and a
new index is calculated using the scheme the scheme in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_index_sequence">Example&nbsp;4-4</a>.  This dictionary can also be created in python
using the following code:</p><div class="example"><a id="dict_set_naive_dict"></a><div class="example-title">Example&nbsp;4-5.&nbsp;Custom hashing function</div><div class="example-contents"><pre class="programlisting"><code class="k">class</code> <code class="nc">City</code><code class="p">(</code><code class="nb">str</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__hash__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="nb">ord</code><code class="p">(</code><code class="bp">self</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code>

<code class="c"># We create a dictionary where we assign arbitrary values to cities.</code>
<code class="n">data</code> <code class="o">=</code>  <code class="p">{</code>
    <code class="n">City</code><code class="p">(</code><code class="s">"Rome"</code><code class="p">):</code> <code class="mi">4</code><code class="p">,</code>
    <code class="n">City</code><code class="p">(</code><code class="s">"San Francisco"</code><code class="p">):</code> <code class="mi">3</code><code class="p">,</code>
    <code class="n">City</code><code class="p">(</code><code class="s">"New York"</code><code class="p">):</code> <code class="mi">5</code><code class="p">,</code>
    <code class="n">City</code><code class="p">(</code><code class="s">"Barcelona"</code><code class="p">):</code> <code class="mi">2</code><code class="p">,</code>
<code class="p">}</code></pre></div></div><p>In this case “Barcelona” and “Rome” cause the hash collision
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#FIG-hash-set-theory-example1">Figure&nbsp;4-1</a> shows the outcome of this insertion).  We see
this because for a dictionary with 4 elements we have a mask value of <code class="literal">0b111</code>.
As a result, “Barcelona” will try to use index <code class="literal">ord("B") &amp; 0b111 = 66 &amp; 0b111 =
0b1000010 &amp; 0b111 = 0b010 = 2</code>. Similarly “Rome” will try to use the index
<code class="literal">ord("R") &amp; 0b111 = 82 &amp; 0b111 = 0b1010010 &amp; 0b111 = 0b010 = 2</code>.</p><div class="tip"><h3 class="title">Dictionary Mechanics</h3><p><span class="title"><strong>Finding an element</strong></span>.&nbsp;Using the dictionary created in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_naive_dict">Example&nbsp;4-5</a>, what would a lookup
on the key “Johannesburg” look like?  What indices would be checked?</p><p><span class="title"><strong>Deleting an element</strong></span>.&nbsp;Using the dictionary created in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_naive_dict">Example&nbsp;4-5</a>, how would you
handle the deletion of the key “Rome”?  How would subsequent lookups for the key
“Rome” or “Barcelona” be handled?</p><p><a id="question-dict-set-collision"></a><span class="title"><strong>Hash Collisions</strong></span>.&nbsp;Considering the dictionary created in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_naive_dict">Example&nbsp;4-5</a>, how many hash
collisions could you expect if 500 cities, all starting with an upper-case
letter, were added into a hash table?  How about 1000 cities?  Can you think of
a way of lowering this number?</p><p><span class="title"><strong>Discussion</strong></span>.&nbsp;For 500 cities there would be approximately 474 dictionary elements which
collided with a previous value (500 - 26) with each hash having 500 / 26 = 19.2
cities associated with it.  For 1000 cities, 974 elements would collide and each
hash would have 1000 / 26 = 38.4 cities associated with it.  This is because the
hash is simply based on the numerical value of the first letter which can only
take a value from A-Z allowing for only 26 independent hash values.  This means
that a lookup in this table could require as many as 38 subsequent lookups to
find the correct value.  In order to fix this, we must increase the number of
possible hash values by considering other aspects of the city in the hash.  The
default hash function on a string considers every character in order to maximize
the number of possible values.  See <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#SEC-dict-set-hash-and-entropy">Hash functions and Entropy</a> for more
explanation.</p></div><div class="figure"><a id="FIG-hash-set-theory-example1"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/hash-set-theory-example1.png.jpg" alt="scaledheight=50%" width="509" height="490" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/hash-set-theory-example1.png.jpg"></div></div><div class="figure-title">Figure&nbsp;4-1.&nbsp;The resulting hash table from inserting with collisions</div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_deletion">Deletion</h3></div></div></div><p>When a value is deleted from a hash table, we cannot simply write a “Null” to
that bucket of memory.  This is because we have used Nulls as a sentinel value
while probing for hash collisions.  As a result, we must write a special value
which signifies that the bucket is empty, but there still may be values after it
to consider when resolving a hash collision.  These empty slots can be written to
in the future and are removed when the hash table is resized.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_resizing">Resizing</h3></div></div></div><p>As more items are inserted into the hash table, the table itself must be resized
to accommodate it.  It can be shown that a table that is 2/3 full or less will
have optimal space savings while still have a good bound on the number of
collisions to expect.  Thus, when a table reaches this critical point it is
grown.  In order to do this, a larger table is allocated (ie: more buckets in
memory reserved), the mask is adjusted to fit the new table and all elements of
the old table are reinserted into the new one.  This requires re-computing
indexes since the changed mask will change the resulting index.  As a result,
resizing large hash tables can be quite expensive!  However, since we only do
this resizing operation when the table is too small, as opposed to on every
insert, the amortized cost of an insert is still <code class="literal">O(1)</code>.</p><p>By default, the smallest size of a dictionary or set is 8 (that is, if you are
only storying 3 values, python will still allocate 8 elements).  On resize, the
number of buckets increases by 4x until we reach 50,000 elements, after which
the size is increased by 2x.  This gives the following possible sizes,</p><pre class="screen">16, 64, 256, 1024, 4096, 16384, 65536, 131072, 262144, ...</pre><p>It is important to note that resizing can happen to make a hash table larger OR
smaller.  That is, if sufficiently many elements of a hash table are deleted,
the table can be scaled down in size.  This is because the consideration for the
table being 2/3rds full uses the total of inserted and deleted entries since the
last resize.  However, resizing <span class="strong"><strong>only happens during an insert</strong></span>.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="SEC-dict-set-hash-and-entropy">Hash functions and Entropy</h3></div></div></div><p>Objects in python are generally hashable since they already have builtin
<code class="literal">__hash__</code> and <code class="literal">__cmp__</code> functions associated with them.  For numerical types
(<code class="literal">int</code> and <code class="literal">float</code>), the hash is simply based on the bit value of the number
they represent.  Tuples and strings have a hash value that is based on their
contents.  Lists, on the other hand, do not support hashing because their value
can change.  Since their values can change, so could the hash that represents
the list which would change the relative placement of that key in the hash
table.
<sup>[<a id="id494320" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#ftn.id494320" class="footnote">12</a>]</sup></p><p>In addition, user defined classes also have default hash and comparison
functions.  The default <code class="literal">__hash__</code> function simply returns the objects placement
in memory as given by the builtin <code class="literal">id</code> function.  Similarly, the <code class="literal">__cmp__</code>
operator compares the numerical value of the object’s placement in memory.</p><p>This is generally acceptable since two instances of a class are generally
different and should not collide in a hash table.  However, in some cases we
would like to use <code class="literal">set</code> or <code class="literal">dict</code> objects to disambiguate between items.  Take
the following class definition,</p><pre class="programlisting"><code class="k">class</code> <code class="nc">Point</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">x</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">y</code> <code class="o">=</code> <code class="n">x</code><code class="p">,</code> <code class="n">y</code></pre><p>If we were to instantiate multiple <code class="literal">Point</code> objects, with the same values for <code class="literal">x</code>
and <code class="literal">y</code>, they would all be independent objects in memory and thus have different
placements in memory which would give them all different hash values.  This
means that putting them all into a <code class="literal">set</code> would result in all of them having
individual entries.</p><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">p1</code> <code class="o">=</code> <code class="n">Point</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">p2</code> <code class="o">=</code> <code class="n">Point</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code>
<code class="gp">&gt;&gt;&gt; </code><code class="nb">set</code><code class="p">([</code><code class="n">p1</code><code class="p">,</code> <code class="n">p2</code><code class="p">])</code>
<code class="go">set([&lt;__main__.Point at 0x1099bfc90&gt;, &lt;__main__.Point at 0x1099bfbd0&gt;])</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">Point</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code> <code class="ow">in</code> <code class="nb">set</code><code class="p">([</code><code class="n">p1</code><code class="p">,</code> <code class="n">p2</code><code class="p">])</code>
<code class="go">False</code></pre><p>This can be remedied by forming a custom hash function that is based on the
actual contents of the object as opposed to the objects placement in memory.
The hash function can be arbitrary as long as it constantly gives the same
result for the same object.  Furthermore, there are considerations regarding
the entropy of the hashing function which we will discuss later.  The following
redefinition of the <code class="literal">Point</code> class will yield the results we expect,</p><pre class="programlisting"><code class="k">class</code> <code class="nc">Point</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">x</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">y</code> <code class="o">=</code> <code class="n">x</code><code class="p">,</code> <code class="n">y</code>

    <code class="k">def</code> <code class="nf">__hash__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="nb">hash</code><code class="p">((</code><code class="bp">self</code><code class="o">.</code><code class="n">x</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">y</code><code class="p">))</code>

    <code class="k">def</code> <code class="nf">__eq__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">other</code><code class="p">):</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">x</code> <code class="o">==</code> <code class="n">other</code><code class="o">.</code><code class="n">x</code> <code class="ow">and</code> <code class="bp">self</code><code class="o">.</code><code class="n">y</code> <code class="o">==</code> <code class="n">other</code><code class="o">.</code><code class="n">y</code></pre><p>Which allows us to create entries in a set or dictionary indexed by the
properties of the <code class="literal">Point</code> object as opposed to the memory address of the
instantiated object,</p><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">p1</code> <code class="o">=</code> <code class="n">Point</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">p2</code> <code class="o">=</code> <code class="n">Point</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code>
<code class="gp">&gt;&gt;&gt; </code><code class="nb">set</code><code class="p">([</code><code class="n">p1</code><code class="p">,</code> <code class="n">p2</code><code class="p">])</code>
<code class="go">set([&lt;__main__.Point at 0x109b95910&gt;])</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">Point</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code> <code class="ow">in</code> <code class="nb">set</code><code class="p">([</code><code class="n">p1</code><code class="p">,</code> <code class="n">p2</code><code class="p">])</code>
<code class="go">True</code></pre><p>As alluded to in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#question-dict-set-collision">Hash Collisions</a>, a custom selected hash
function should be careful to evenly distribute hash values in order to avoid
collisions.  Having many collisions will degrade the performance of a
hash-table: if most keys have collisions then we need to constantly “probe” the
other values, effectively walking a potentially large portion of the dictionary
in order to find the key in question.  In the worst case, when all keys in a
dictionary collide, the performance of lookups in the dictionary is <code class="literal">O(N)</code> and
thus the same as if we were searching through a list.</p><p>If we know a priori that we are storing 5000 values into a dictionary and we need
to create a hashing function for the object we wish to use as a key, we must be
aware that the dictionary is sized 16384 and thus only the last 14 bits of our
hash are being used to create an index (for a hash table of this size, the mask
is <code class="literal">bin(16384-1) = 0b11111111111111</code>).</p><p>This idea of “how well distributed is my hash function” is called the entropy of
the hash function.  Entropy, defined as <span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0401.png" alt="" width="224" height="26" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0401.png"></span> where <code class="literal">p(i)</code> is the probability that the hash function
gives hash i.  It is maximized when every hash value has equal probability of
being chosen.  A hash function that maximises this entropy is called an ideal
hash function since it guarantees the minimal number of collisions.</p><p>For an infinitely large dictionary, the hash function used for integers is
ideal.  This is because the hash value for an integer is simply the integer
itself!  For an infinitely large dictionary, the mask value is infinite and thus
we consider all bits in the hash value.  Thus, given any two numbers I can
guarantee that their hash values will not be the same.</p><p>However, if we made this dictionary finite then we can no longer have this
guarantee.  For example, for a dictionary with 4 elements, the mask we use is
<code class="literal">0b111</code>.  Thus, the hash value for the number 5 is <code class="literal">5 &amp; 0b111 = 5</code> and the hash
value for 501 is <code class="literal">501 &amp; 0b111 = 5</code>, and thus their entries will collide.</p><p>There is no single best hash function to use when using a finite dictionary.
However, knowing a priori what range of values will be used and how large the
dictionary will be gives helps in making a good selection.  For example, if we
are storing all 676 combinations of two lower-case letters as keys in a
dictionary (<span class="emphasis"><em>aa</em></span>, <span class="emphasis"><em>ab</em></span>, <span class="emphasis"><em>ac</em></span>, etc.) then a good hashing function would be,</p><div class="example"><a id="example_dict_set_twoletter_hash_function"></a><div class="example-title">Example&nbsp;4-6.&nbsp;Optimal 2-letter hashing function</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">twoletter_hash</code><code class="p">(</code><code class="n">key</code><code class="p">):</code>
    <code class="n">offset</code> <code class="o">=</code> <code class="nb">ord</code><code class="p">(</code><code class="s">'a'</code><code class="p">)</code>
    <code class="n">k1</code><code class="p">,</code> <code class="n">k2</code> <code class="o">=</code> <code class="n">key</code>
    <code class="k">return</code> <code class="p">(</code><code class="nb">ord</code><code class="p">(</code><code class="n">k2</code><code class="p">)</code> <code class="o">-</code> <code class="n">offset</code><code class="p">)</code> <code class="o">+</code> <code class="mi">26</code> <code class="o">*</code> <code class="p">(</code><code class="nb">ord</code><code class="p">(</code><code class="n">k1</code><code class="p">)</code> <code class="o">-</code> <code class="n">offset</code><code class="p">)</code></pre></div></div><p>which gives no hash collisions for any combination of two lower-case letters
considering a mask of <code class="literal">0b1111111111</code> (a dictionary of 676 values will be held
in a hash-table of length 1024 which has a mask of <code class="literal">bin(1024-1) =
0b1111111111</code>).</p><p>We can see very explicitly below the ramifications of having a bad hashing
function for a user-defined class where the cost of a bad hash function (in
fact, it is the worst-possible hash function!) is a 21.8x slowdown of lookups.</p><div class="example"><a id="example_dict_set_twoletter_hash_objects"></a><div class="example-title">Example&nbsp;4-7.&nbsp;Timing differences between good and bad hashing functions</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">string</code>
<code class="kn">import</code> <code class="nn">timeit</code>

<code class="k">class</code> <code class="nc">BadHash</code><code class="p">(</code><code class="nb">str</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__hash__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="mi">42</code>

<code class="k">class</code> <code class="nc">GoodHash</code><code class="p">(</code><code class="nb">str</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__hash__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="sd">"""</code>
<code class="sd">        This is a slightly optimized version of twoletter_hash</code>
<code class="sd">        """</code>
        <code class="k">return</code> <code class="nb">ord</code><code class="p">(</code><code class="bp">self</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code> <code class="o">+</code> <code class="mi">26</code> <code class="o">*</code> <code class="nb">ord</code><code class="p">(</code><code class="bp">self</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code> <code class="o">-</code> <code class="mi">2619</code>

<code class="n">baddict</code> <code class="o">=</code> <code class="nb">set</code><code class="p">()</code>
<code class="n">gooddict</code> <code class="o">=</code> <code class="nb">set</code><code class="p">()</code>
<code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">:</code>
    <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">:</code>
        <code class="n">key</code> <code class="o">=</code> <code class="n">i</code> <code class="o">+</code> <code class="n">j</code>
        <code class="n">baddict</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">BadHash</code><code class="p">(</code><code class="n">key</code><code class="p">))</code>
        <code class="n">gooddict</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">GoodHash</code><code class="p">(</code><code class="n">key</code><code class="p">))</code>

<code class="n">badtime</code> <code class="o">=</code> <code class="n">timeit</code><code class="o">.</code><code class="n">repeat</code><code class="p">(</code>
    <code class="s">"key in baddict"</code><code class="p">,</code>
    <code class="n">setup</code> <code class="o">=</code> <code class="s">"from __main__ import baddict, BadHash; key = BadHash('zz')"</code><code class="p">,</code>
    <code class="n">repeat</code> <code class="o">=</code> <code class="mi">3</code><code class="p">,</code>
    <code class="n">number</code> <code class="o">=</code> <code class="mi">1000000</code><code class="p">,</code>
<code class="p">)</code>
<code class="n">goodtime</code> <code class="o">=</code> <code class="n">timeit</code><code class="o">.</code><code class="n">repeat</code><code class="p">(</code>
    <code class="s">"key in gooddict"</code><code class="p">,</code>
    <code class="n">setup</code> <code class="o">=</code> <code class="s">"from __main__ import gooddict, GoodHash; key = GoodHash('zz')"</code><code class="p">,</code>
    <code class="n">repeat</code> <code class="o">=</code> <code class="mi">3</code><code class="p">,</code>
    <code class="n">number</code> <code class="o">=</code> <code class="mi">1000000</code><code class="p">,</code>
<code class="p">)</code>

<code class="k">print</code> <code class="s">"Min lookup time for baddict: "</code><code class="p">,</code> <code class="nb">min</code><code class="p">(</code><code class="n">badtime</code><code class="p">)</code>
<code class="k">print</code> <code class="s">"Min lookup time for gooddict: "</code><code class="p">,</code> <code class="nb">min</code><code class="p">(</code><code class="n">goodtime</code><code class="p">)</code>

<code class="c"># Results:</code>
<code class="c">#   Min lookup time for baddict:  16.3375990391</code>
<code class="c">#   Min lookup time for gooddict:  0.748275995255</code></pre></div></div><div class="tip"><h3 class="title">Hashing Functions</h3><p>Show that for an infinite dictionary (and thus an infinite mask), using an
integer’s value as its hash gives no collisions.</p><p>Show that the hashing function given in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#example_dict_set_twoletter_hash_function">Example&nbsp;4-6</a> is ideal for a hash table of size
1024.  Why is it not ideal for smaller hash tables?</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="dict_namespace">Dictionaries and Namespaces</h2></div></div></div><p>Doing a lookup on a dictionary is fast however unnecessarily doing it will slow
down your code, just as any extraneous lines will.  One way this surfaces itself
is in Python’s namespace management which heavily uses dictionaries to do its
lookups.</p><p>Whenever a variable, function or module is being invoked in Python, there is a
hierarchy where these objects are looked for.  First, Python looks inside of the
<code class="literal">locals()</code> array which has entries for all local variables.  Python works hard
to make local variable lookups fast and this is the only part of the chain that
doesn’t require a dictionary lookup.  If it doesn’t exist there, then the
<code class="literal">globals()</code> dictionary is searched.  Finally, if we don’t find it there, the
<code class="literal">__builtin__</code> object is searched.  It is important to note that while <code class="literal">locals()</code>
and <code class="literal">globals()</code> are explicitly dictionaries, while <code class="literal">__builtin__</code> is technically
a module object, when searching <code class="literal">__builtin__</code> for a given property we are just
doing a dictionary lookup inside of <span class="emphasis"><em>its</em></span> <code class="literal">locals()</code> map (this is the case for
all module object and class objects!).</p><p>To make this clearer, let’s look at a simple example of calling functions
that are defined in different scopes (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_namespace_code">Example&nbsp;4-8</a>).  We can
disassemble the functions with the <code class="literal">dis</code> module (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_namespace_dis">Example&nbsp;4-9</a>) to
get a better understanding of how these namespace lookups are happening.</p><div class="example"><a id="dict_set_namespace_code"></a><div class="example-title">Example&nbsp;4-8.&nbsp;Namespace lookups</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">math</code>
<code class="kn">from</code> <code class="nn">math</code> <code class="kn">import</code> <code class="n">sin</code>

<code class="k">def</code> <code class="nf">test1</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit test1(123456)</code>
<code class="sd">    1000000 loops, best of 3: 381 ns per loop</code>
<code class="sd">    """</code>
    <code class="k">return</code> <code class="n">math</code><code class="o">.</code><code class="n">sin</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">test2</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit test2(123456)</code>
<code class="sd">    1000000 loops, best of 3: 311 ns per loop</code>
<code class="sd">    """</code>
    <code class="k">return</code> <code class="n">sin</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">test3</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">sin</code><code class="o">=</code><code class="n">math</code><code class="o">.</code><code class="n">sin</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit test3(123456)</code>
<code class="sd">    1000000 loops, best of 3: 306 ns per loop</code>
<code class="sd">    """</code>
    <code class="k">return</code> <code class="n">sin</code><code class="p">(</code><code class="n">x</code><code class="p">)</code></pre></div></div><div class="example"><a id="dict_set_namespace_dis"></a><div class="example-title">Example&nbsp;4-9.&nbsp;Namespace lookups disassembled</div><div class="example-contents"><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="n">dis</code><code class="o">.</code><code class="n">dis</code><code class="p">(</code><code class="n">test1</code><code class="p">)</code>
  <code class="mi">9</code>           <code class="mi">0</code> <code class="n">LOAD_GLOBAL</code>              <code class="mi">0</code> <code class="p">(</code><code class="n">math</code><code class="p">)</code>  <code class="o">//</code> <code class="n">Dictionary</code> <code class="n">Lookup</code>
              <code class="mi">3</code> <code class="n">LOAD_ATTR</code>                <code class="mi">1</code> <code class="p">(</code><code class="n">sin</code><code class="p">)</code>   <code class="o">//</code> <code class="n">Dictionary</code> <code class="n">Lookup</code>
              <code class="mi">6</code> <code class="n">LOAD_FAST</code>                <code class="mi">0</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code>     <code class="o">//</code> <code class="n">Local</code> <code class="n">Lookup</code>
              <code class="mi">9</code> <code class="n">CALL_FUNCTION</code>            <code class="mi">1</code>
             <code class="mi">12</code> <code class="n">RETURN_VALUE</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">dis</code><code class="o">.</code><code class="n">dis</code><code class="p">(</code><code class="n">test2</code><code class="p">)</code>
 <code class="mi">15</code>           <code class="mi">0</code> <code class="n">LOAD_GLOBAL</code>              <code class="mi">0</code> <code class="p">(</code><code class="n">sin</code><code class="p">)</code>  <code class="o">//</code> <code class="n">Dictionary</code> <code class="n">Lookup</code>
              <code class="mi">3</code> <code class="n">LOAD_FAST</code>                <code class="mi">0</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code>    <code class="o">//</code> <code class="n">Local</code> <code class="n">Lookup</code>
              <code class="mi">6</code> <code class="n">CALL_FUNCTION</code>            <code class="mi">1</code>
              <code class="mi">9</code> <code class="n">RETURN_VALUE</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">dis</code><code class="o">.</code><code class="n">dis</code><code class="p">(</code><code class="n">test3</code><code class="p">)</code>
 <code class="mi">21</code>           <code class="mi">0</code> <code class="n">LOAD_FAST</code>                <code class="mi">1</code> <code class="p">(</code><code class="n">sin</code><code class="p">)</code>  <code class="o">//</code> <code class="n">Local</code> <code class="n">Lookup</code>
              <code class="mi">3</code> <code class="n">LOAD_FAST</code>                <code class="mi">0</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code>    <code class="o">//</code> <code class="n">Local</code> <code class="n">Lookup</code>
              <code class="mi">6</code> <code class="n">CALL_FUNCTION</code>            <code class="mi">1</code>
              <code class="mi">9</code> <code class="n">RETURN_VALUE</code></pre></div></div><p>The first function, <code class="literal">test1</code>, makes the call to sin by explicitly looking at the
math library.  This is also evident in the byte code that is produced, first a
reference to the <code class="literal">math</code> module must be loaded, then we do an attribute lookup on
this module until we finally have a reference to the sin function.  This is done
through 2 dictionary lookups, one to find the math module and one to find the
sin function within the module.</p><p>On the other hand, <code class="literal">test2</code> explicitly imports the sin function from the math
module, then the function is directly accessible within the global namespace.
This means we can avoid the lookup of the math module and the subsequent
attribute lookup.  However, we still must find the sin function within the
global namespace.  This is yet another reason to be explicit about what
functions you are importing from a module.  This practice not only makes code
more readable because the reader knows exactly what functionality is required
from external sources, but it also speeds up code!</p><p>Finally, <code class="literal">test3</code> defines the sin function as a keyword argument with its
default value being a reference to the sin function within the math module.
While we still do need to find a reference to this function within the module,
it only must happen when the <code class="literal">test3</code> function is first defined.  After this, the
reference to the sin function is stored within the function definition as a
local variable in the form of a default keyword argument.  As mentioned before,
local variables do not need a dictionary lookup to be found, they are stored in
a very slim array which has very fast lookup times.  Because of this, finding
the function is quite fast!</p><p>While these effects are an interesting result of the way namespaces in python
are managed, <code class="literal">test3</code> is definitely not “Pythonic”.  Luckily, these extra
dictionary lookups only start to degrade performance when they are called a lot
(in the innermost block of a very fast loop such as in the Julia set example).
With this in mind, a more readable solution would be to set a local variable
with the global reference before the loop is started.  This still means we must
do the global lookup once whenever the function is called however all the calls
to that function in the loop will be made faster.  This speaks to the fact that
even minute slowdowns in code can be amplified if that code is being run
millions of times.  Even though a dictionary lookup may only take a several
hundred nanoseconds, if we are looping millions of times over this lookup it can
quickly add up.  In fact, looking at <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#dict_set_namespace_timings">Example&nbsp;4-10</a>  we see a
9.4% speedup simply by making the <code class="literal">sin</code> function local a tight loop which calls
it.</p><div class="example"><a id="dict_set_namespace_timings"></a><div class="example-title">Example&nbsp;4-10.&nbsp;Effects of slow namespace lookups in loops</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">math</code> <code class="kn">import</code> <code class="n">sin</code>

<code class="k">def</code> <code class="nf">tight_loop_slow</code><code class="p">(</code><code class="n">iterations</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit tight_loop_slow(10000000)</code>
<code class="sd">    1 loops, best of 3: 2.21 s per loop</code>
<code class="sd">    """</code>
    <code class="n">result</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">iterations</code><code class="p">):</code>
        <code class="c"># this call to sin requires a global lookup</code>
        <code class="n">result</code> <code class="o">+=</code> <code class="n">sin</code><code class="p">(</code><code class="n">i</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">tight_loop_fast</code><code class="p">(</code><code class="n">iterations</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit tight_loop_fast(10000000)</code>
<code class="sd">    1 loops, best of 3: 2.02 s per loop</code>
<code class="sd">    """</code>
    <code class="n">result</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="n">local_sin</code> <code class="o">=</code> <code class="n">sin</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">iterations</code><code class="p">):</code>
        <code class="c"># this call to local_sin requires a local lookup</code>
        <code class="n">result</code> <code class="o">+=</code> <code class="n">local_sin</code><code class="p">(</code><code class="n">i</code><code class="p">)</code></pre></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_wrap_up_2">Wrap Up</h2></div></div></div><p>Dictionaries and sets provide a fantastic way to store data that can be indexed
by a key.  The way this key is used, through the hashing function, can greatly
effect the resulting performance of the data structure.  Furthermore,
understanding how dictionaries work not only gives you a better understanding of
how to organize your data, but also how to organize your code since dictionaries
are a very intrinsic part of python’s internal functionality.</p><p>In the next chapter, we will explore generators which allows us to provide data
to code in any dynamic order we want and without necessarily storing it in
memory beforehand.  This let’s us side-step many of the possible hurdles when
using any of python’s intrinsic data structures.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" epub:type="footnote" id="ftn.id341283"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#id341283" class="simpara totri-footnote">9</a>] </sup>As we
will discuss in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#SEC-dict-set-hash-and-entropy">Hash functions and Entropy</a>, dictionaries and sets are
very dependant on their hash function.  If the hash function for a particular
data type is not <code class="literal">O(1)</code>, any dictionary or set containing that type will no
longer have its <code class="literal">O(1)</code> guarentee</p></div><div class="footnote" epub:type="footnote" id="ftn.id502563"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#id502563" class="simpara">10</a>] </sup>A mask is
a binary number that truncates the value of a number.  So, <code class="literal">0b1111101 &amp; 0b111 =
0b101 = 5</code> represents the operation of <code class="literal">0b111</code> masking the number <code class="literal">0b1111101</code>. This
operation can also be thought of as taking a certain number of the
least-significant digits of a number</p></div><div class="footnote" epub:type="footnote" id="ftn.id505567"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#id505567" class="simpara">11</a>] </sup>The value of <code class="literal">5</code> comes from the properties of a linear congruential
generator (LCG) which is used in generating random numbers</p></div><div class="footnote" id="ftn.id494320"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#id494320" class="simpara">12</a>] </sup>More information about this at
<a class="ulink" href="http://wiki.python.org/moin/DictionaryKeys" target="_top">http://wiki.python.org/moin/DictionaryKeys</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch03.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">3. Lists and Tuples</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch05.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">5. Iterators and Generators</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch04.html" data-for-analytics="9781449361747:ch04.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch05.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch05.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch05.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch05.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>5. Iterators and Generators - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch05.html"><meta name="description" content="Chapter&nbsp;5.&nbsp;Iterators and Generators Questions you’ll be able to answer after this chapter How do generators same memory? When is the best time to use a generator? How ... "><meta property="og:title" content="5. Iterators and Generators"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="5. Iterators and Generators"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch05.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;5.&nbsp;Iterators and Generators Questions you’ll be able to answer after this chapter How do generators same memory? When is the best time to use a generator? How ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch05.html" data-for-analytics="9781449361747:ch05.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch05.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch05.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch05.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%205.%20Iterators%20and%20Generators&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch05.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch04.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">4. Dictionaries and Sets</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch06.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">6. Matrix and Vector Computation</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="section-iterators-generators"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;5.&nbsp;Iterators and Generators</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
How do generators same memory?
</li><li class="listitem">
When is the best time to use a generator?
</li><li class="listitem">
How can I use itertools to create complex generator work flows?
</li><li class="listitem">
When is lazy evaluation beneficial?  When is it not?
</li></ul></div></div><p>When many people start learning Python from another language, they are taken
aback by the difference in for loop notation.  That is to say, instead of
writing,</p><pre class="programlisting"><code class="cp"># Other Languages</code>
<code class="k">for</code> <code class="p">(</code><code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">N</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">do_work</code><code class="p">(</code><code class="n">i</code><code class="p">);</code>
<code class="p">}</code>

<code class="cp"># Python</code>
<code class="k">for</code> <code class="n">i</code> <code class="n">in</code> <code class="n">range</code><code class="p">(</code><code class="n">N</code><code class="p">)</code><code class="o">:</code>
    <code class="n">do_work</code><code class="p">(</code><code class="n">i</code><code class="p">)</code></pre><p>They are instead introduced to a new functions called <code class="literal">range</code> or <code class="literal">xrange</code>.
These two functions provide more insight to the paradigm of programming of using
generators.  In order to fully understand generators, let us first make simple
implementations of the <code class="literal">range</code> and <code class="literal">xrange</code> functions,</p><pre class="programlisting"><code class="k">def</code> <code class="nf">range</code><code class="p">(</code><code class="n">start</code><code class="p">,</code> <code class="n">stop</code><code class="p">,</code> <code class="n">step</code><code class="o">=</code><code class="mi">1</code><code class="p">):</code>
    <code class="n">numbers</code> <code class="o">=</code> <code class="p">[]</code>
    <code class="k">while</code> <code class="n">start</code> <code class="o">&lt;</code> <code class="n">stop</code><code class="p">:</code>
        <code class="n">numbers</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">start</code><code class="p">)</code>
        <code class="n">start</code> <code class="o">+=</code> <code class="n">step</code>
    <code class="k">return</code> <code class="n">numbers</code>

<code class="k">def</code> <code class="nf">xrange</code><code class="p">(</code><code class="n">start</code><code class="p">,</code> <code class="n">stop</code><code class="p">,</code> <code class="n">step</code><code class="o">=</code><code class="mi">1</code><code class="p">):</code>
    <code class="k">while</code> <code class="n">start</code> <code class="o">&lt;</code> <code class="n">stop</code><code class="p">:</code>
        <code class="k">yield</code> <code class="n">start</code> <code class="c">#</code><a id="CO4-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
        <code class="n">start</code> <code class="o">+=</code> <code class="n">step</code>

<code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">10</code><code class="p">):</code>
    <code class="k">pass</code>

<code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">10</code><code class="p">):</code>
    <code class="k">pass</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#CO4-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
This function will <code class="literal">yield</code> many values instead of returning one value.  This turns this regular looking function into a generator that can be repeatedly polled for the next available value.
</p></dd></dl></div><p>A first thing to note is that the <code class="literal">range</code> implementation must pre-create the
list of all numbers within the range.  So, if the range is from 1 to 10,000, the
function will do 10,000 appends to the <code class="literal">numbers</code> list (which, as we discussed
before, has overhead associated with it), and then returns it.  On the other
hand, the generator is able to “return” many values.  Every time the code gets
to the <code class="literal">yield</code>, the function emits its value, and when another value is
requested the function resumes running (maintaining its previous state) and
emits new values.  When the function reaches its end, a <code class="literal">StopIteration</code>
exception is thrown indicating that the given generator has no more values.  As
a result, even though both functions must, in the end, do the same number of
calculations, the <code class="literal">range</code> version of the loop above uses 10x more memory (or
`N`x more memory if we are ranging from 1 to N).</p><p>With this code in mind, we can decompose the <code class="literal">for</code> loops that use our
implementations of <code class="literal">range</code> and <code class="literal">xrange</code>.  In Python, <code class="literal">for</code> loops require that
the object we are looping over supports iteration.  This means that we must be
able to create an iterator out of the object we are requesting we loop over.  To
create an iterator from almost any object, we can simply use Python’s builtin
<code class="literal">iter</code> function.  This function, for lists, tuples, dictionaries and sets,
returns an iterator over the items of keys in the object.  For more complex
objects, <code class="literal">iter</code> returns the result of the <code class="literal">__iter__</code> property of the object.
Since <code class="literal">xrange</code> already returns an iterator, calling <code class="literal">iter</code> on it is a trivial
operation and it simply returns the original object (so <code class="literal">type(xrange(1,10)) ==
type(iter(xrange(1,10)))</code>).  However, since <code class="literal">range</code> returns a list, we must
create a new object, a list iterator, that will iterate over all values in the
list.  Once an iterator is created, we simply call the <code class="literal">next()</code> function on it,
retrieving new values until a <code class="literal">StopIteration</code> exception is thrown.  This gives
us a good de-constructed view of <code class="literal">for</code> loops given in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#iter_py_for">Example&nbsp;5-1</a>.</p><div class="example"><a id="iter_py_for"></a><div class="example-title">Example&nbsp;5-1.&nbsp;Python <code class="literal">for</code> loop deconstructed</div><div class="example-contents"><pre class="programlisting"><code class="c"># The python loop</code>
<code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">object</code><code class="p">:</code>
    <code class="n">do_work</code><code class="p">(</code><code class="n">i</code><code class="p">)</code>

<code class="c"># Is equivalent to</code>
<code class="n">object_iterator</code> <code class="o">=</code> <code class="nb">iter</code><code class="p">(</code><code class="nb">object</code><code class="p">)</code>
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>
    <code class="k">try</code><code class="p">:</code>
        <code class="n">i</code> <code class="o">=</code> <code class="n">object_iterator</code><code class="o">.</code><code class="n">next</code><code class="p">()</code>
        <code class="n">do_work</code><code class="p">(</code><code class="n">i</code><code class="p">)</code>
    <code class="k">except</code> <code class="ne">StopIteration</code><code class="p">:</code>
        <code class="k">break</code></pre></div></div><p>The <code class="literal">for</code> loop code shows that we are doing extra work calling <code class="literal">iter</code> when using
<code class="literal">range</code> instead of <code class="literal">xrange</code>.  When using <code class="literal">xrange</code>, we create a generator which
is trivially transformed into an iterator (since it is already an iterator!),
however for <code class="literal">range</code> we need to allocate a new list, pre-compute its values, and
then we still must create an iterator!</p><p>More importantly, pre-computing the <code class="literal">range</code> list requires allocating enough
space for the full dataset and setting each element to the correct value, even
though we only ever require one value at a time.  This makes the list allocation
also useless.  In fact, it may even make the loop unrunnable because <code class="literal">range</code>
would be trying to allocate more memory than is available (<code class="literal">range(100,000,000)</code>
would create a list 3.1GB large!).  By timing the results, we can see this very
explicitly,</p><pre class="programlisting"><code class="k">def</code> <code class="nf">test_range</code><code class="p">():</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit test_range()</code>
<code class="sd">    1 loops, best of 3: 446 ms per loop</code>
<code class="sd">    """</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">10000000</code><code class="p">):</code>
        <code class="k">pass</code>

<code class="k">def</code> <code class="nf">test_xrange</code><code class="p">():</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit test_xrange()</code>
<code class="sd">    1 loops, best of 3: 276 ms per loop</code>
<code class="sd">    """</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">10000000</code><code class="p">):</code>
        <code class="k">pass</code></pre><p>This may seem like a trivial enough problem to solve—simply replace all
<code class="literal">range</code> calls with <code class="literal">xrange</code>, however the problem is a lot deeper.  Let’s say we
had a long list of numbers, and we wanted to know how many of them are divisible
by 3.  This could look like,</p><pre class="programlisting"><code class="n">divisible_by_three</code> <code class="o">=</code> <code class="nb">len</code><code class="p">([</code><code class="n">n</code> <code class="k">for</code> <code class="n">n</code> <code class="ow">in</code> <code class="n">list_of_numbers</code> <code class="k">if</code> <code class="n">n</code> <code class="o">%</code> <code class="mi">3</code> <code class="o">==</code> <code class="mi">0</code><code class="p">])</code></pre><p>However, this suffers from the same problem as <code class="literal">range</code> does.  Since we are doing
list comprehension we are pre-generating the list of numbers divisible by three,
only to do a calculation on it and forget that list.  If this list of numbers
divisible by three was quite large, this could mean allocating a lot of memory,
potentially more than is available, for almost no reason.</p><p>Recall that we can have list comprehension by having a statement of the form
<code class="literal">[&lt;value&gt; for &lt;item&gt; in &lt;sequence&gt; if &lt;condition&gt;]</code>.  This will create a list of
all the <code class="literal">&lt;value&gt;</code> items.  Alternatively, we can use similar syntax to create a
generator of the <code class="literal">&lt;value&gt;</code> items instead of a list by doing <code class="literal">(&lt;value&gt; for &lt;item&gt;
in &lt;sequence&gt; if &lt;condition&gt;)</code>.</p><p>Using this subtle difference between list comprehension and generator
comprehension, we can optimize the above code for <code class="literal">divisible_by_three</code>.
However, generators do not have a length property.  As a result, we will have to
be a bit clever,</p><pre class="programlisting"><code class="n">divisible_by_three</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">((</code><code class="mi">1</code> <code class="k">for</code> <code class="n">n</code> <code class="ow">in</code> <code class="n">list_of_numbers</code> <code class="k">if</code> <code class="n">n</code> <code class="o">%</code> <code class="mi">3</code> <code class="o">==</code> <code class="mi">0</code><code class="p">))</code></pre><p>Here, we have a generator that emits a value of <code class="literal">1</code> whenever it encounters a
number divisible by 3, and nothing otherwise.  By summing all elements in this
generator we are essentially doing the same as the list comprehension version.
The timing performance of the two versions of this code are almost equivalent,
however the memory impact of the generator version is far less than that of the
list comprehension.  Furthermore, we are able to simply transform the list
version into a generator because each element of the list only cared about its
current value—either the number is divisible by 3 or it is not, it doesn’t
matter where its placement is in the list of numbers or what the previous/next
values are.  More complex functions can also be transformed into generators, but
depending on their reliance on state, this can become a difficult thing to do.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="iterators_inf">Iterators for Infinite Series</h2></div></div></div><p>Since we only need to store some version of a state and emit only the current
value, generators are ideal for infinite series.  The Fibonacci series is a
great example—it is an infinite series with 2 state variables (the two last
Fibonacci numbers).</p><pre class="programlisting"><code class="k">def</code> <code class="nf">fibonacci</code><code class="p">():</code>
    <code class="n">i</code><code class="p">,</code> <code class="n">j</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code>
    <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>
        <code class="k">yield</code> <code class="n">j</code>
        <code class="n">i</code><code class="p">,</code> <code class="n">j</code> <code class="o">=</code> <code class="n">j</code><code class="p">,</code> <code class="n">i</code> <code class="o">+</code> <code class="n">j</code></pre><p>We see here that although <code class="literal">j</code> is the value being emitted, we keep track of <code class="literal">i</code>
as well since this holds the state of the Fibonacci series.  The amount of state
necessary for a calculation is quite important for generators because it
translates into the actual memory footprint of the object.  This makes it so
that if we had a function that uses a lot of state and outputs a very small
amount of data, it may be better to have this function pre-compute the list of
data rather than have a generator for it.</p><p>One reason why generators aren’t used as much as they could be, is that a lot of
the logic within them can be encapsulated in your logic code.  This means that
generators are really a way of organizing your code and having smarter loops.
For example, we could answer the question “how many Fibonacci numbers below 5000
are odd” in multiple ways,</p><pre class="programlisting"><code class="k">def</code> <code class="nf">fibonacci_naive</code><code class="p">():</code>
    <code class="n">i</code><code class="p">,</code> <code class="n">j</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code>
    <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">while</code> <code class="n">j</code> <code class="o">&lt;=</code> <code class="mi">5000</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">j</code> <code class="o">%</code> <code class="mi">2</code><code class="p">:</code>
            <code class="n">count</code> <code class="o">+=</code> <code class="mi">1</code>
        <code class="n">i</code><code class="p">,</code> <code class="n">j</code> <code class="o">=</code> <code class="n">j</code><code class="p">,</code> <code class="n">i</code> <code class="o">+</code> <code class="n">j</code>
    <code class="k">return</code> <code class="n">count</code>

<code class="k">def</code> <code class="nf">fibonacci_generator</code><code class="p">():</code>
    <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">f</code> <code class="ow">in</code> <code class="n">fibonacci</code><code class="p">():</code>
        <code class="k">if</code> <code class="n">f</code> <code class="o">&gt;</code> <code class="mi">5000</code><code class="p">:</code>
            <code class="k">break</code>
        <code class="k">if</code> <code class="n">f</code> <code class="o">%</code> <code class="mi">2</code><code class="p">:</code>
            <code class="n">count</code> <code class="o">+=</code> <code class="mi">1</code>
    <code class="k">return</code> <code class="n">count</code>

<code class="kn">from</code> <code class="nn">itertools</code> <code class="kn">import</code> <code class="n">islice</code>
<code class="k">def</code> <code class="nf">fibonacci_succinct</code><code class="p">():</code>
    <code class="n">is_odd</code> <code class="o">=</code> <code class="k">lambda</code> <code class="n">x</code> <code class="p">:</code> <code class="n">x</code> <code class="o">%</code> <code class="mi">2</code>
    <code class="n">first_5000</code> <code class="o">=</code> <code class="n">islice</code><code class="p">(</code><code class="n">fibonacci</code><code class="p">(),</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">5000</code><code class="p">)</code>
    <code class="k">return</code> <code class="nb">sum</code><code class="p">(</code><code class="mi">1</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="n">first_5000</code> <code class="k">if</code> <code class="n">is_odd</code><code class="p">(</code><code class="n">x</code><code class="p">))</code></pre><p>All of these methods have similar runtime properties (namely they all have the
same memory footprint and the same performance), however the
<code class="literal">fibonacci_genarator</code> function benefits from several things.  Firstly, it is
much more verbose than <code class="literal">fibonacci_succinct</code> which means it will be easy for
another developer to debug and understand.  This function mainly stands as a
warning for the next section where we cover some common work flows using
itertools—while the module greatly simplifies many simple actions with
iterators, it can also quickly make Python code very un-Pythonic.  Conversely,
<code class="literal">fibonacci_naive</code> is doing multiple things at a time which hides the actual
calculation it is doing!  While it is obvious in the generator function we are
iterating over the Fibonacci numbers, we are not over encumbered by the actual
calculation.  Lastly, <code class="literal">fibonacci_generator</code> is more generalizable.  This
function could be renamed <code class="literal">num_odd_under_5000</code> and take in the generator by
argument and thus work over any series.</p><p>One last benefit of the <code class="literal">fibonacci_generator</code> function is that it supports the
notion that in computation there are two phases: generating data and
transforming data.  This function is very clearly a transformation on data while
the <code class="literal">fibonacci</code> function generates it.  This clear demarcation adds extra
clarity and extra functionality by being able to move a transformative function
to work on a new set of data, or adding new transformations onto existing data.
This paradigm has always been important when creating complex programs, however
generators facilitate this clearly by making generators responsible for creating
the data, and normal functions responsible for acting on the generated data.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_lazy_generator_evaluation">Lazy Generator Evaluation</h2></div></div></div><p>As touched on before, the way we get the memory benefits with a generator is by
forcing us only to deal with the current value of interest.  At any point in our
calculation with a generator, we only have the current value and cannot
reference any other items in the sequence (algorithms that perform this way are
generally called “single pass” or “online”).  This can make generators sometimes
more difficult to use, however there are many modules and functions that can
help.</p><p>The main library of interest is <code class="literal">itertools</code> in the standard library.  It
supplies generator versions of Python’s builtin functions <code class="literal">map</code>, <code class="literal">reduce</code>,
<code class="literal">filter</code> and <code class="literal">zip</code> (called <code class="literal">imap</code>, <code class="literal">ireduce</code>, <code class="literal">filter</code> and <code class="literal">izip</code> in itertools)
in addition to many other useful functions.  Of particular note are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">islice</code>—allows slicing a potentially infinite generator
</li><li class="listitem">
<code class="literal">chain</code>—chain together multiple generators
</li><li class="listitem">
<code class="literal">takewhile</code>—adds a condition that will end a generator
</li><li class="listitem">
<code class="literal">cycle</code>—make a finite generator infinite by constantly repeating it
</li></ul></div><p>Let’s build up an example of using generators in order to analyse a large
dataset.  Let’s say we had an analysis routine going over temporal data, one
piece of data per second for the last 20 years—631,152,000 data points!  The
data is stored in a file, one second per line, and we cannot load the entire
data-set into memory.  If we wanted to do some simple anomaly detection, we
could use generators and never allocate any lists!</p><p>The problem will be, given a datafile of the form “timestamp, value”, find days
with a value 3 sigma away from that day’s mean.  We start by writing the code
that will read the file, line by line, and output that line’s value as python
objects.  We will also create a <code class="literal">read_fake_data</code> generator to generate fake data
we can test our algorithms with.  For this function we still take the argument
<code class="literal">filename</code> so as to have the same function signature as <code class="literal">read_data</code>, however we
will simply disregard it.  These two functions are indeed lazily evaluated—we only read the next line in the file, or generate new fake data, when the
<code class="literal">next()</code> property on the generator is called.</p><div class="example"><a id="iter_read_data"></a><div class="example-title">Example&nbsp;5-2.&nbsp;Lazily reading data</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">random</code> <code class="kn">import</code> <code class="n">normalvariate</code><code class="p">,</code> <code class="n">rand</code>
<code class="kn">from</code> <code class="nn">itertools</code> <code class="kn">import</code> <code class="n">count</code>

<code class="k">def</code> <code class="nf">read_data</code><code class="p">(</code><code class="n">filename</code><code class="p">):</code>
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">filename</code><code class="p">)</code> <code class="k">as</code> <code class="n">fd</code><code class="p">:</code>
        <code class="k">for</code> <code class="n">line</code> <code class="ow">in</code> <code class="n">fd</code><code class="p">:</code>
            <code class="n">data</code> <code class="o">=</code> <code class="n">line</code><code class="o">.</code><code class="n">strip</code><code class="p">()</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s">','</code><code class="p">)</code>
            <code class="k">yield</code> <code class="nb">map</code><code class="p">(</code><code class="nb">int</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">read_fake_data</code><code class="p">(</code><code class="n">filename</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="n">count</code><code class="p">():</code>
        <code class="n">sigma</code> <code class="o">=</code> <code class="n">rand</code><code class="p">()</code> <code class="o">*</code> <code class="mi">10</code>
        <code class="k">yield</code> <code class="p">(</code><code class="n">i</code><code class="p">,</code> <code class="n">normalvariate</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="n">sigma</code><code class="p">))</code></pre></div></div><p>Now, we can use the <code class="literal">groupby</code> function in <code class="literal">itertools</code> to group together
timestamps that occur on the same day.  This function works by taking in a
sequence of items and a key used to group these items.  The output is a
generator which produces tuples whose items are the key for the group and a
generator for the items in the group.  As our key function, we will create a
lambda function that returns a <code class="literal">date</code> object.  These date objects are equal when
they occur on the same day, which will group them by day!  This “key” function
could be anything—we could group our data by hour, by year, or by some
property in the actual value.  The only limitation is that groups will only be
formed for data that is sequential.  So, if we had the input be <code class="literal">A A A A B B A
A</code> and had <code class="literal">groupby</code> group by the letter, we would get three groups, <code class="literal">(A, [A, A,
A, A]), (B, [B, B]), (A, [A, A])</code>.</p><div class="example"><a id="iter_day_grouper"></a><div class="example-title">Example&nbsp;5-3.&nbsp;Grouping our data</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">date</code>
<code class="kn">from</code> <code class="nn">itertools</code> <code class="kn">import</code> <code class="n">groupby</code>

<code class="k">def</code> <code class="nf">day_grouper</code><code class="p">(</code><code class="n">iterable</code><code class="p">):</code>
    <code class="n">key</code> <code class="o">=</code> <code class="k">lambda</code> <code class="p">(</code><code class="n">timestamp</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code> <code class="p">:</code> <code class="n">date</code><code class="o">.</code><code class="n">fromtimestamp</code><code class="p">(</code><code class="n">timestamp</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">groupby</code><code class="p">(</code><code class="n">iterable</code><code class="p">,</code> <code class="n">key</code><code class="p">)</code></pre></div></div><p>Now to do the actual anomaly detection.  We will do this by iterating through a
day’s values and keeping track of the mean and maximum values.  The mean will be
calculated using an online mean and standard deviation algorithm <sup>[<a id="id616352" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#ftn.id616352" class="footnote">13</a>]</sup>.  The maximum is
kept because it is the best candidate for being anomalous—if the max is 3
sigma larger than the mean then we will will return the <code class="literal">date</code> object
representing the day we just analysed.  Otherwise, we will return <code class="literal">False</code> for
posterity, however we could equally have just ended the function (and implicitly
returned <code class="literal">None</code>).  We output these values because this <code class="literal">check_anomaly</code> function
is defined as a data filter—a function that returns a value that evaluates to
<code class="literal">True</code> for data that should be kept and a value that evaluates to <code class="literal">False</code> if a
value should be disregarded.  This will allow us to filter through the original
dataset and only keep days which pass our condition.</p><div class="example"><a id="iter_anomaly"></a><div class="example-title">Example&nbsp;5-4.&nbsp;Generator based anomaly detection</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">math</code>

<code class="k">def</code> <code class="nf">check_anomaly</code><code class="p">((</code><code class="n">day</code><code class="p">,</code> <code class="n">day_data</code><code class="p">)):</code>
    <code class="c"># We find the mean, standard deviation and maximum values for the day.</code>
    <code class="c"># Using a single pass mean/standard deviation algorithm allows us to only</code>
    <code class="c"># read through the day's data once.</code>
    <code class="n">n</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="n">mean</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="n">M2</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="n">max_value</code> <code class="o">=</code> <code class="bp">None</code>
    <code class="k">for</code> <code class="n">timestamp</code><code class="p">,</code> <code class="n">value</code> <code class="ow">in</code> <code class="n">day_data</code><code class="p">:</code>
        <code class="n">n</code> <code class="o">+=</code> <code class="mi">1</code>
        <code class="n">delta</code> <code class="o">=</code> <code class="n">value</code> <code class="o">-</code> <code class="n">mean</code>
        <code class="n">mean</code> <code class="o">=</code> <code class="n">mean</code> <code class="o">+</code> <code class="n">delta</code><code class="o">/</code><code class="n">n</code>
        <code class="n">M2</code> <code class="o">+=</code> <code class="n">delta</code><code class="o">*</code><code class="p">(</code><code class="n">value</code> <code class="o">-</code> <code class="n">mean</code><code class="p">)</code>
        <code class="n">max_value</code> <code class="o">=</code> <code class="nb">max</code><code class="p">(</code><code class="n">max_value</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code>
    <code class="n">variance</code> <code class="o">=</code> <code class="n">M2</code><code class="o">/</code><code class="p">(</code><code class="n">n</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code>
    <code class="n">standard_deviation</code> <code class="o">=</code> <code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">variance</code><code class="p">)</code>

    <code class="c"># Here is the actual check of whether that day's data is anomalous.  If it</code>
    <code class="c"># is, we return the value of the day, otherwise we return false</code>
    <code class="k">if</code> <code class="n">max_value</code> <code class="o">&gt;</code> <code class="n">mean</code> <code class="o">+</code> <code class="mi">3</code> <code class="o">*</code> <code class="n">standard_deviation</code><code class="p">:</code>
        <code class="k">return</code> <code class="n">day</code>
    <code class="k">return</code> <code class="bp">False</code></pre></div></div><p>One aspect of this function which may seem strange is the extra parenthesis in
the parameter definition.  This is not a typo but a result of this function
taking input from the <code class="literal">groupby</code> generator.  Recall that <code class="literal">groupby</code> returns a
tuple, each one of which will become the parameters to this <code class="literal">check_anomaly</code>
function.  As a result, we must do tuple expansion in order to properly extract
the group key and the group data.  Since we are using <code class="literal">ifilter</code>, another way of
dealing with this instead of having the tuple expansion inside the function
definition is to define <code class="literal">istarfilter</code> which is similar to what <code class="literal">istarmap</code> does
to <code class="literal">imap</code> (see the <code class="literal">itertools</code> documentation for more information).</p><p>Finally, we can put together the chain of generators to get the days that had
anomalous data,</p><div class="example"><a id="iter_chaining_generators"></a><div class="example-title">Example&nbsp;5-5.&nbsp;Chaining together our generators</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">itertools</code> <code class="kn">import</code> <code class="n">ifilter</code><code class="p">,</code> <code class="n">imap</code>

<code class="n">data</code> <code class="o">=</code> <code class="n">read_data</code><code class="p">(</code><code class="n">data_filename</code><code class="p">)</code>
<code class="n">data_day</code> <code class="o">=</code> <code class="n">day_grouper</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
<code class="n">anomalous_dates</code> <code class="o">=</code> <code class="n">ifilter</code><code class="p">(</code><code class="bp">None</code><code class="p">,</code> <code class="n">imap</code><code class="p">(</code><code class="n">check_anomaly</code><code class="p">,</code> <code class="n">data_day</code><code class="p">))</code> <code class="c">#</code><a id="CO5-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">

<code class="n">first_anomalous_date</code><code class="p">,</code> <code class="n">first_anomalous_data</code> <code class="o">=</code> <code class="n">anomalous_dates</code><code class="o">.</code><code class="n">next</code><code class="p">()</code>
<code class="k">print</code> <code class="s">"The first anomalous date is: "</code><code class="p">,</code> <code class="n">first_anomalous_date</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#CO5-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
<code class="literal">ifilter</code> will remove any elements which do not satisfy the given filter.  By default (sending <code class="literal">None</code> to the first parameter triggers this), <code class="literal">ifilter</code> will filter out any elements that evaluate to <code class="literal">False</code>.  This makes it so we don’t include any days that <code class="literal">check_anomaly</code> didn’t think were anomalous.
</p></dd></dl></div></div></div><p>This method very simply allows us to get the list of days that are anomalous
without having to load the entire dataset.  One thing to note is that the above
code does not actually do any calculation, it simply sets up the pipeline to do
the calculation.  The file will never be read until we do
<code class="literal">anomalous_dates.next()</code> or somehow iterate on the <code class="literal">anomalous_dates</code> generator.
In fact, we only ever do the analysis when a new value is requested from
<code class="literal">anomalous_dates</code>.  So, if our full dataset has 5 anomalous dates, but in our
code we retrieve one and then stop requesting new values, the file will only be
read up to the point where this day’s data appears.  This is called lazy
evaluation—only the calculations that are explicitly requested are performed
which can drastically reduce overall runtime if there is a early termination
condition.</p><p>Another nicety about organizing analysis this way is it easily allows us to do
more expansive calculations without having to rework large parts of code.  For
example, if we wanted to have a moving window of one day instead of chunking up
by days, we can simply write a new <code class="literal">day_grouper</code> that does so and use it instead,</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>

<code class="k">def</code> <code class="nf">rolling_window_grouper</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">window_size</code><code class="o">=</code><code class="mi">3600</code><code class="p">):</code>
    <code class="n">window</code> <code class="o">=</code> <code class="nb">tuple</code><code class="p">(</code><code class="n">islice</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="n">window_size</code><code class="p">))</code>
    <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>
        <code class="n">current_datetime</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">fromtimestamp</code><code class="p">(</code><code class="n">window</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">0</code><code class="p">])</code>
        <code class="k">yield</code> <code class="p">(</code><code class="n">current_datetime</code><code class="p">,</code> <code class="n">window</code><code class="p">)</code>
        <code class="n">window</code> <code class="o">=</code> <code class="n">window</code><code class="p">[</code><code class="mi">1</code><code class="p">:]</code> <code class="o">+</code> <code class="p">(</code><code class="n">data</code><code class="o">.</code><code class="n">next</code><code class="p">(),)</code></pre><p>Now, we simply replace the call to <code class="literal">day_grouper</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#iter_chaining_generators">Example&nbsp;5-5</a>
with a call to <code class="literal">rolling_window_grouper</code> and we get the desired result.  In this
version we also see very explicitly the memory guarantee of this and the
previous method—it will store only the window’s worth of data as state (in
both cases one day or 3600 data points).  This can be changed by opening the
file multiple time and using this to point to the parts of the data we like (or
using the <code class="literal">linecache</code> module), however this is only necessary if this
sub-sampling of the dataset still doesn’t fit in memory.</p><p>A final note, in the <code class="literal">rolling_window_grouper</code> function, we perform many <code class="literal">pop</code>
and <code class="literal">append</code> operations on the list <code class="literal">window</code>.  This can be greatly optimized by
using the <code class="literal">deque</code> object in the <code class="literal">collections</code> module.  This object gives us
<code class="literal">O(1)</code> removals and appends from the beginning or end of a list (while normal
lists have <code class="literal">O(1)</code> for appends or removals from the end of the list and <code class="literal">O(N)</code>
for the same operations on the beginning of the list).  Using the <code class="literal">deque</code>
object, we can append the new data to the right (or end) of the list and
<code class="literal">deque.popleft()</code> to delete the leftmost (or beginning) of the list without
having to allocate more space or perform long <code class="literal">O(N)</code> operations.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_wrap_up_3">Wrap Up</h2></div></div></div><p>By formulating our anomaly finding algorithm as iterators, we are able to
process much more data than could fit into memory.  Not only are we able to
process more data than can fit in RAM, but we also are able to do it faster than
if we had used lists since we were able to avoid all the costly <code class="literal">append</code>
operations.</p><p>Since iterators are a primitive type in Python, this should always be a go-to
method when trying to reduce the memory footprint of an application.  The
benefits are that results are lazily evaluated, so you only ever process the
data you need, and memory is saved since we don’t store previous results unless
explicitly required to.  In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html">Chapter&nbsp;11</a>, we will talk about other
methods that can be used for more specific problems and hopefully teach new ways
of looking at problems when RAM is an issue.</p><p>Another benefit of thinking about solving problems using iterators is it
prepares your code to be used on multiple CPU’s or multiple computers, as we
will see in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html">Chapter&nbsp;9</a> and <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html">Chapter&nbsp;10</a>.  As we discussed in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#iterators_inf">Iterators for Infinite Series</a>, when working with iterators you must always think about the
various states that are necessary for your algorithm to work.  Once you figure
out how to package the state necessary for the algorithm to run, it doesn’t
matter where it runs.  We can see this sort of paradigm, for example, with the
<code class="literal">multiprocessing</code> and <code class="literal">ipython</code> modules both using a <code class="literal">map</code> like function to
launch parallel tasks.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id616352"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#id616352" class="simpara">13</a>] </sup>We
use Knuth’s online mean algorithm.  This lets us calculate the mean and the
first moment (in this case, the standard deviation) using a single temporary
variable.  We could also calculate further moments by modifying the equations
slightly and adding more state variables (one per moment). More information can
be found at <a class="ulink" href="http://www.johndcook.com/standard_deviation.html" target="_top">http://www.johndcook.com/standard_deviation.html</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch04.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">4. Dictionaries and Sets</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch06.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">6. Matrix and Vector Computation</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch05.html" data-for-analytics="9781449361747:ch05.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch05.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch06.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch06.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch06.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch06.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>6. Matrix and Vector Computation - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch06.html"><meta name="description" content="Chapter&nbsp;6.&nbsp;Matrix and Vector Computation Questions you’ll be able to answer after this chapter What are the bottlenecks in vector calculations? What tools can I use to see ... "><meta property="og:title" content="6. Matrix and Vector Computation"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="6. Matrix and Vector Computation"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch06.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;6.&nbsp;Matrix and Vector Computation Questions you’ll be able to answer after this chapter What are the bottlenecks in vector calculations? What tools can I use to see ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch06.html" data-for-analytics="9781449361747:ch06.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch06.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch06.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch06.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%206.%20Matrix%20and%20Vector%20Computation&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch06.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch05.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">5. Iterators and Generators</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch07.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">7. Compiling to C</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="matrix_computation"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;6.&nbsp;Matrix and Vector Computation</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
What are the bottlenecks in vector calculations?
</li><li class="listitem">
What tools can I use to see how efficiently the CPU is doing my calculations?
</li><li class="listitem">
Why is <code class="literal">numpy</code> better at numerical calulations than pure python?
</li><li class="listitem">
What is a <code class="literal">cache-miss</code>?  What is a <code class="literal">page-fault</code>?
</li><li class="listitem">
How can I track the memory allocations in my code?
</li></ul></div></div><p>Regardless of what problem you are trying to solve on a computer, you will
encounter vector computation at some point.  Vector calculations are integral to
how a computer works and how it tries to speed up runtimes of programs down at
the silicon level—the only thing the computer knows how to do is operate on
number and knowing how to do multiple of those calculations at once will speed
up your program.</p><p>In this chapter, we try to unwrap some of the complexities of this problem by
focusing on a relatively simple mathematical problem, solving the diffusion
equation, and understanding what is happening at the CPU level.  By
understanding how different python code effects the CPU and how to effectively
probe these things, we can learn how to understand other problems as well.</p><p>We will start by introducing the problem and coming up with a quick solution
using pure python.  After identifying some memory issues and trying to fix them
using pure python we will introduce numpy and identify how and why it speeds up
our code.  Then we will start doing some algorithmic changes and specialize our
code to solve the problem at hand.  By removing some of the generality of the
libraries we are using we are able to yet again gain more speed.  Finally, we
introduce some extra modules that will help facilitate this sort of process out
in the field and also explore a cautionary tale about optimizing before
profiling.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="matrix_intro">Introduction to the Problem</h2></div></div></div><div class="note"><h3 class="title">Note</h3><p>The following section is meant to give a deeper understanding of the equations
we will be solving throughout the chapter.  It is not strictly necessary to
understand this section in order to approach the rest of the chapter.  If you
wish to skip this section, make sure to look at the algorithm at
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_algo1">Example&nbsp;6-1</a> and <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_algo2">Example&nbsp;6-2</a> to understand the code we will be
optimizing.</p><p>On the other hand, if you read this section and want even more explanation, read
chapter 17 of “Numerical Recipes (3rd ed.)” by Press et al..</p></div><p>In order to explore matrix and vector computation in this chapter, we will
repeatedly use the example of diffusion in fluids.  Diffusion is one of the
mechanisms that moves fluids and tries to make it be uniformly mixed.</p><p>In this section we will explore the mathematics behind the diffusion equation.
This may seem complicated, but don’t worry!  We will quickly simplify this to
make it more understandable.  Also, it is important to note that while having a
basic understanding of the final equation we are solving will be useful while
reading this chapter, it is not completely necessary; the subsequent chapters
will focus mainly on various formulations of the code, not the equation.
However, having an understanding of the equations helps gain intuition about
ways of optimizing our code.  This is true in general—understanding the
motivation behind your code and the intricacies of the algorithm will help you
gain an intuition about methods of optimization.</p><p>One simple example of diffusion is dye in water: if you put several drops of dye
into water at room temperature it will slowly move out until it fully mixes
with the water.  Since we are not stirring the water, nor is it warm enough to
create convection currents, diffusion will be the main process mixing the two
liquids.  When solving these equations numerically, we pick what we want the
initial conditions to look like and are able to evolve the initial condition
forward in time to see what it will look like at a later time (see
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_diffusion_image">Figure&nbsp;6-2</a>).</p><p>All this being said, the most important thing to know about diffusion for our
purposes is its formulation.  Stated as a partial differential equation in 1
dimension it is written as,</p><div class="equation"><a id="id664466"></a><div class="equation-title">Equation&nbsp;6-1.&nbsp;Diffusion Equation</div><div class="equation-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/eq_0601.png" alt="Diffusion Equation" width="624" height="130" data-mfp-src="/library/view/high-performance-python/9781449361747/eq_0601.png"></div></div></div><p>In this formulation, <code class="literal">u</code> is the vector representing the quantities we are
diffusing.  For example, we could have a vector with values of 0 where there is
only water and 1 where there is only dye (and values in-between where there is
mixing).  In general, this will be a 2D or 3D matrix representing an actual area
or volume of fluid.  In this way, we could have <code class="literal">u</code> be a 3D matrix representing
the fluid in a glass and instead of simply doing the second derivative along the
<code class="literal">x</code> direction, we’d have to take it over all axes.  In addition, <code class="literal">D</code> is a
physical value that represents properties of the fluid we are simulating.  A
large value of <code class="literal">D</code> represents a fluid that can diffuse very easily.  For
simplicity, we will set <code class="literal">D = 1</code> for our code, but still include it in the
calculations.</p><div class="note"><h3 class="title">Note</h3><p>The diffusion equation is also called the heat equation.  In this case, <code class="literal">u</code>
represents the temperature of a region and <code class="literal">D</code> describes how well the material
conducts heat. Solving the equations tell us how the heat is being transfered.
So, instead of solving for how a couple drops of dye diffuses through water, we
would be solving for how the heat from several drops of hot water diffuses
through cold water.</p></div><p>What we will do is take the diffusion equation above, which is continuous in
space and time, and approximate it to discrete volumes and discrete times.  This
is done using Euler’s method.  Euler’s method simply take’s the derivative and
writes it as a difference, such that</p><div class="informalequation"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/eq_0602.png" alt="Diffusion Equation" width="807" height="110" data-mfp-src="/library/view/high-performance-python/9781449361747/eq_0602.png"></div></div><p>where dt is now a fixed number.  This fixed number represents the time step size,
or the resolution in time that we wish to solve this equation.  It can be
thought of as the frame rate of the movie we are trying to make.  As the
frame rate goes up (or dt goes down), we get a clearer picture of what happens.
In fact, as dt approaches zero, Euler’s approximation becomes exact.  We can thus
rewrite the above equation to figure out what <code class="literal">u(x, t+dt)</code> is given <code class="literal">u(x,t)</code>.
What this means for us is that we can start with some initial state (<code class="literal">u(x,0)</code>
representing the glass of water just as we add a drop of dye into it) and churn
through the above mechanisms to “evolve” that initial state and see what it will
look like at future times (<code class="literal">u(x,dt)</code>).  This type of problem is called an
“initial value problem” or “Cauchey Problem”.</p><p>Doing a similar trick for the derivative in <code class="literal">x</code> using the finite differences
approximation, we arrive at the final equation,</p><div class="informalequation"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/eq_0603.png" alt="Diffusion Equation" width="1738" height="125" data-mfp-src="/library/view/high-performance-python/9781449361747/eq_0603.png"></div></div><p>Here, similar to how <code class="literal">dt</code> represents the frame rate, <code class="literal">dx</code> represents the
resolution of the images—the smaller <code class="literal">dx</code> is the smaller a region every cell
in our matrix represents.  For simplicity, we will simply set <code class="literal">D = 1</code> and <code class="literal">dx =
1</code>.  These two values become very important when doing proper physical
simulations, however since we are simply solving the diffusion equation for
illustrative purposes they are not important to us.</p><p>Using this equation, we can solve almost any diffusion problem.  However, there
are some considerations we must make from this equation.  Firstly, we said
before that the spacial index in <code class="literal">u</code> (ie: the <code class="literal">x</code> parameter) will be represented
as the indices into a matrix.  What happens when we try to find the value at
<code class="literal">x-dx</code> when <code class="literal">x</code> is at the beginning of the matrix?  This problem is called the
boundary condition.  You can have fixed boundary conditions that say: any value
out of the bounds of my matrix will be set to 0 (or any other value).
Alternatively, you can have periodic boundary conditions that say that the
values will wrap around (ie: if your matrix has length N, the value at index -1
is the same as at N-1, and the value at N+1 is the same at index 1.  In order
words, if you are trying to access the value at index <code class="literal">i</code>, you will get the
value at index <code class="literal">(i%N)</code>).</p><p>Another consideration is how we are going to store the multiple time components
of <code class="literal">u</code>.  We could have one matrix for every time value we do our calculation
for.  At minimum, it seems that we will need two matrices; one matrix for the
current state of the fluid and one for the next state of the fluid.  As we’ll
see, there are very drastic performance considerations for this particular
question.</p><p>So, what does it look like to solve this problem in practice?  Below is some
pseudo code to illustrate the way we can use this equation to solve the problem</p><div class="example"><a id="matrix_algo1"></a><div class="example-title">Example&nbsp;6-1.&nbsp;Psudocode for Matrix Initialization for 1D Diffusion</div><div class="example-contents"><pre class="programlisting"><code class="c"># Create the initial conditions</code>
<code class="n">u</code> <code class="o">=</code> <code class="n">vector</code> <code class="n">of</code> <code class="n">length</code> <code class="n">N</code>
<code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">N</code><code class="p">):</code>
    <code class="n">u</code> <code class="o">=</code> <code class="mi">0</code> <code class="k">if</code> <code class="n">there</code> <code class="ow">is</code> <code class="n">water</code><code class="p">,</code> <code class="mi">1</code> <code class="k">if</code> <code class="n">there</code> <code class="ow">is</code> <code class="n">dye</code>

<code class="c"># Evolve the initial conditions</code>
<code class="n">D</code> <code class="o">=</code> <code class="mi">1</code>
<code class="n">t</code> <code class="o">=</code> <code class="mi">0</code>
<code class="n">dt</code> <code class="o">=</code> <code class="mf">0.0001</code>
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>
    <code class="k">print</code> <code class="s">"Current time is: </code><code class="si">%f</code><code class="s">"</code> <code class="o">%</code> <code class="n">t</code>
    <code class="n">unew</code> <code class="o">=</code> <code class="n">vector</code> <code class="n">of</code> <code class="n">size</code> <code class="n">N</code>

    <code class="c"># update step for every cell</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">N</code><code class="p">):</code>
        <code class="n">unew</code><code class="p">[</code><code class="n">i</code><code class="p">]</code> <code class="o">=</code> <code class="n">u</code><code class="p">[</code><code class="n">i</code><code class="p">]</code> <code class="o">+</code> <code class="n">dt</code> <code class="o">*</code> <code class="p">(</code><code class="n">u</code><code class="p">[(</code><code class="n">i</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">N</code><code class="p">]</code> <code class="o">+</code> <code class="n">u</code><code class="p">[(</code><code class="n">i</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">N</code><code class="p">]</code> <code class="o">-</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">u</code><code class="p">[</code><code class="n">i</code><code class="p">])</code>
    <code class="c"># move the updated solution into u</code>
    <code class="n">u</code> <code class="o">=</code> <code class="n">unew</code>

    <code class="n">visualize</code><code class="p">(</code><code class="n">u</code><code class="p">)</code></pre></div></div><p>This code will take some initial condition of the dye in water and tell us what
the system looks like at every 0.0001 second interval in the future.  The
results of this can be seen in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_diffusion_1d_image">Figure&nbsp;6-1</a> where we evolve a
very concentrated drop of dye (represented by the top-hat function) into the
future.  We can see how far into the future, the dye becomes well mixed to the
point where everywhere has a similar concentration of the dye.</p><div class="figure"><a id="matrix_diffusion_1d_image"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/diffusion_1d.png" alt="Example of 1D diffusion" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/diffusion_1d.png"></div></div><div class="figure-title">Figure&nbsp;6-1.&nbsp;Example of 1D diffusion</div></div><p>For the purposes of this chapter, we will be solving the 2D version of the above
equation.  All this means is that instead of operating over a vector (or in
other words, a matrix with one index), we will be operating over a 2D matrix.
The only change to the equations (and thus the subsequent code), is that we must
now also take the second derivative in the <code class="literal">y</code> direction.  This simply means
that the original equation we are working with becomes,</p><div class="equation"><a id="id342116"></a><div class="equation-title">Equation&nbsp;6-2.&nbsp;Numerical diffusion equation in 2D</div><div class="equation-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/eq_0604.png" alt="Numerical diffusion equation in 2D" width="1193" height="142" data-mfp-src="/library/view/high-performance-python/9781449361747/eq_0604.png"></div></div></div><p>Which translates to the following pseudo code using the same methods we used
before,</p><div class="example"><a id="matrix_algo2"></a><div class="example-title">Example&nbsp;6-2.&nbsp;Algorithm for Calculating 2D Diffusion</div><div class="example-contents"><pre class="programlisting"><code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">N</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">M</code><code class="p">):</code>
        <code class="n">unew</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">=</code> <code class="n">u</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">dt</code> <code class="o">*</code> <code class="p">(</code>                       \
            <code class="p">(</code><code class="n">u</code><code class="p">[(</code><code class="n">i</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">N</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">u</code><code class="p">[(</code><code class="n">i</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">N</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">-</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">u</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">])</code> <code class="o">+</code> \ <code class="c"># d^2 u / dx^2</code>
            <code class="p">(</code><code class="n">u</code><code class="p">[</code><code class="n">i</code><code class="p">][(</code><code class="n">j</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">M</code><code class="p">]</code> <code class="o">+</code> <code class="n">u</code><code class="p">[</code><code class="n">j</code><code class="p">][(</code><code class="n">j</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">M</code><code class="p">]</code> <code class="o">-</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">u</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">])</code>   \ <code class="c"># d^2 u / dy^2</code>
        <code class="p">)</code></pre></div></div><p>We can put all of this together and write the full python 2D diffusion code
which we will use as the basis for our benchmarks for the rest of this chapter.
While the code looks more complicated, the results are similar to that of the 1D
diffusion (as can be seen in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_diffusion_image">Figure&nbsp;6-2</a>).</p><div class="figure"><a id="matrix_diffusion_image"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/diffusion.png.jpg" alt="Example of diffusion for two sets of initial conditions" width="714" height="1000" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/diffusion.png.jpg"></div></div><div class="figure-title">Figure&nbsp;6-2.&nbsp;Example of diffusion for two sets of initial conditions</div></div><div class="note"><h3 class="title">Note</h3><p>Resources for this section:
- <a class="ulink" href="http://en.wikipedia.org/wiki/Diffusion_equation" target="_top">http://en.wikipedia.org/wiki/Diffusion_equation</a>
- <a class="ulink" href="http://pauli.uni-muenster.de/tp/fileadmin/lehre/NumMethoden/WS0910/ScriptPDE/Heat.pdf" target="_top">http://pauli.uni-muenster.de/tp/fileadmin/lehre/NumMethoden/WS0910/ScriptPDE/Heat.pdf</a></p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_aren_8217_t_python_lists_good_enough">Aren’t python lists good enough?</h2></div></div></div><p>Let’s take python code from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_algo1">Example&nbsp;6-1</a> with the 2D extension  and break it
up into chunks so that we can better analyse its runtime performance.  The
first step is to write out the evolution function that takes in the matrix and
returns its evolved state,</p><div class="example"><a id="matrix_pure_python"></a><div class="example-title">Example&nbsp;6-3.&nbsp;Pure Python 2D Diffusion</div><div class="example-contents"><pre class="programlisting"><code class="n">grid_shape</code> <code class="o">=</code> <code class="p">(</code><code class="mi">1024</code><code class="p">,</code> <code class="mi">1024</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mf">1.0</code><code class="p">):</code>
    <code class="n">xmax</code><code class="p">,</code> <code class="n">ymax</code> <code class="o">=</code> <code class="n">grid_shape</code>
    <code class="n">new_grid</code> <code class="o">=</code> <code class="p">[[</code><code class="mf">0.0</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">ymax</code><code class="p">)]</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">xmax</code><code class="p">)]</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">xmax</code><code class="p">):</code>
        <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">ymax</code><code class="p">):</code>
            <code class="n">grid_xx</code> <code class="o">=</code> <code class="n">grid</code><code class="p">[(</code><code class="n">i</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">xmax</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">grid</code><code class="p">[(</code><code class="n">i</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">xmax</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">-</code> <code class="mf">2.0</code> <code class="o">*</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code>
            <code class="n">grid_yy</code> <code class="o">=</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][(</code><code class="n">j</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">ymax</code><code class="p">]</code> <code class="o">+</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][(</code><code class="n">j</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">ymax</code><code class="p">]</code> <code class="o">-</code> <code class="mf">2.0</code> <code class="o">*</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code>
            <code class="n">new_grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">=</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">D</code> <code class="o">*</code> <code class="p">(</code><code class="n">grid_xx</code> <code class="o">+</code> <code class="n">grid_yy</code><code class="p">)</code> <code class="o">*</code> <code class="n">dt</code>
    <code class="k">return</code> <code class="n">grid</code></pre></div></div><div class="note"><h3 class="title">Note</h3><p>Instead of preallocating the <code class="literal">new_grid</code> list, we could have built it up in the
for loop by using appends.  While this is noticeably faster than what we have
written, the conclusions we draw are still applicable.  We chose this method
because it is more illustrative.</p></div><p>The global variable <code class="literal">grid_shape</code> designates how big of a region we be simulating
and, as explained in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_intro">Introduction to the Problem</a>, we are using periodic boundary conditions
(which is why we use modulo for the indices).  In order to actually use this
code, we must initialize a grid and call <code class="literal">evolve</code> on it.  The following code is
a very generic initialization procedure and will be reused throughout the
chapter (its performance characteristics will not be analysed since it must only
run once, as opposed to the <code class="literal">evolve</code> function, which is called repeatedly).</p><div class="example"><a id="matrix_pure_python_run"></a><div class="example-title">Example&nbsp;6-4.&nbsp;Pure Python 2D Diffusion Initialization</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="c"># setting up initial conditions </code><a id="CO6-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">grid</code> <code class="o">=</code> <code class="p">[[</code><code class="mf">0.0</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">1</code><code class="p">])]</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">])]</code>

    <code class="n">block_low</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="o">.</code><code class="mi">4</code><code class="p">)</code>
    <code class="n">block_high</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="o">.</code><code class="mi">5</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">block_low</code><code class="p">,</code> <code class="n">block_high</code><code class="p">):</code>
        <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">block_low</code><code class="p">,</code> <code class="n">block_high</code><code class="p">):</code>
            <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">=</code> <code class="mf">0.005</code>

    <code class="c"># Evolve the initial conditions</code>
    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">grid</code> <code class="o">=</code> <code class="n">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="mf">0.1</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code> <code class="o">-</code> <code class="n">start</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#CO6-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
The initial conditions used here are the same as the square example in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_diffusion_image">Figure&nbsp;6-2</a>.
</p></dd></dl></div></div></div><p>The values for <code class="literal">dt</code> and grid elements have been chosen to be sufficiently small
so that the algorithm is stable.  See “Numerical Recipes” for a more in-depth
treatment of this algorithm’s convergence characteristics.</p><div class="example"><a id="matrix_pure_python_lineprof"></a><div class="example-title">Example&nbsp;6-5.&nbsp;Pure Python 2D Diffusion Profiling</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>kernprof.py -lv diffusion_python.py
Wrote profile results to diffusion_python.py.lprof
Timer unit: 1e-06 s

File: diffusion_python.py
Function: evolve at line 8
Total <code class="nb">time</code>: 16.1398 s

Line <code class="c">#      Hits         Time  Per Hit   % Time  Line Contents</code>
<code class="o">==============================================================</code>
     8                                           @profile
     9                                           def evolve<code class="o">(</code>grid, dt, <code class="nv">D</code><code class="o">=</code>1.0<code class="o">)</code>:
    10        10           39      3.9      0.0      xmax, <code class="nv">ymax</code> <code class="o">=</code> grid_shape
    11   2626570      2159628      0.8     13.4      <code class="nv">new_grid</code> <code class="o">=</code> <code class="o">[[</code>0.0 <code class="k">for </code>x in xrange<code class="o">(</code>ymax<code class="o">)]</code> <code class="k">for </code>x in xrange<code class="o">(</code>xmax<code class="o">)]</code>
    12      5130         4167      0.8      0.0      <code class="k">for </code>i in xrange<code class="o">(</code>xmax<code class="o">)</code>:
    13   2626560      2126592      0.8     13.2          <code class="k">for </code>j in xrange<code class="o">(</code>ymax<code class="o">)</code>:
    14   2621440      4259164      1.6     26.4              <code class="nv">grid_xx</code> <code class="o">=</code> grid<code class="o">[(</code>i+1<code class="o">)</code>%xmax<code class="o">][</code>j<code class="o">]</code> + grid<code class="o">[(</code>i-1<code class="o">)</code>%xmax<code class="o">][</code>j<code class="o">]</code> - 2.0 * grid<code class="o">[</code>i<code class="o">][</code>j<code class="o">]</code>
    15   2621440      4196964      1.6     26.0              <code class="nv">grid_yy</code> <code class="o">=</code> grid<code class="o">[</code>i<code class="o">][(</code>j+1<code class="o">)</code>%ymax<code class="o">]</code> + grid<code class="o">[</code>i<code class="o">][(</code>j-1<code class="o">)</code>%ymax<code class="o">]</code> - 2.0 * grid<code class="o">[</code>i<code class="o">][</code>j<code class="o">]</code>
    16   2621440      3393273      1.3     21.0              new_grid<code class="o">[</code>i<code class="o">][</code>j<code class="o">]</code> <code class="o">=</code> grid<code class="o">[</code>i<code class="o">][</code>j<code class="o">]</code> + D * <code class="o">(</code>grid_xx + grid_yy<code class="o">)</code> * dt
    17        10           10      1.0      0.0      <code class="k">return </code>grid</pre></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_problems_with_allocating_too_much">Problems with allocating too much</h3></div></div></div><p>By using <code class="literal">line_prof</code> on the pure python evolution function, we can start to
unravel what is contributing to a possibly slow runtime.  Looking at the
profiler output at <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_lineprof">Example&nbsp;6-5</a>, we see that most of the
time spent in the function is spent doing the derivative calculation and
updating the grid.  This is what we want since this is a purely CPU bound
problem—any time spent not solving the CPU bound problem is low hanging fruit
for optimization.</p><p>However, we are also spending 20% of our time allocating the <code class="literal">new_grid</code> list.
This is a waste because the properties of <code class="literal">new_grid</code> do not change—no matter
what values we send to <code class="literal">evolve</code>, the <code class="literal">new_grid</code> list will always be the same
shape and size and contain the same values.  A simple optimization would be to
allocate this list once and simply reuse this.  This sort of optimization is
similar to moving repetitive code outside of a fast loop,</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">math</code> <code class="kn">import</code> <code class="n">sin</code>

<code class="k">def</code> <code class="nf">loop_slow</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit loop_slow(int(1e4))</code>
<code class="sd">    100 loops, best of 3: 2.67 ms per loop</code>
<code class="sd">    """</code>
    <code class="n">result</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">result</code> <code class="o">+=</code> <code class="n">i</code> <code class="o">*</code> <code class="n">sin</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">)</code> <code class="c">#</code><a id="CO7-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="k">return</code> <code class="n">result</code>

<code class="k">def</code> <code class="nf">loop_fast</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; %timeit loop_fast(int(1e4))</code>
<code class="sd">    1000 loops, best of 3: 1.38 ms per loop</code>
<code class="sd">    """</code>
    <code class="n">result</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="n">factor</code> <code class="o">=</code> <code class="n">sin</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">result</code> <code class="o">+=</code> <code class="n">i</code> <code class="o">*</code> <code class="n">factor</code>
    <code class="k">return</code> <code class="n">result</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#CO7-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
The value of <code class="literal">sin(num_iterations)</code> doesn’t change throughout the loop so there is no use recalculating it every time.
</p></dd></dl></div><p>We can do a similar transformation to our diffusion code.  In this case, we
would want to instantiate <code class="literal">new_grid</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_run">Example&nbsp;6-4</a> and send
it in to our evolve function.  The evolution function will do the same as it
does now, read the <code class="literal">grid</code> list and write to the <code class="literal">new_grid</code> list.  Then, we can
simply swap <code class="literal">new_grid</code> with <code class="literal">grid</code> and continue again.</p><div class="example"><a id="matrix_pure_python_memory"></a><div class="example-title">Example&nbsp;6-6.&nbsp;Pure Python 2D Diffusion after reducing memory allocations</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">out</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mf">1.0</code><code class="p">):</code>
    <code class="n">xmax</code><code class="p">,</code> <code class="n">ymax</code> <code class="o">=</code> <code class="n">grid_shape</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">xmax</code><code class="p">):</code>
        <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">ymax</code><code class="p">):</code>
            <code class="n">grid_xx</code> <code class="o">=</code> <code class="n">grid</code><code class="p">[(</code><code class="n">i</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">xmax</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">grid</code><code class="p">[(</code><code class="n">i</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">xmax</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">-</code> <code class="mf">2.0</code> <code class="o">*</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code>
            <code class="n">grid_yy</code> <code class="o">=</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][(</code><code class="n">j</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">ymax</code><code class="p">]</code> <code class="o">+</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][(</code><code class="n">j</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="o">%</code><code class="n">ymax</code><code class="p">]</code> <code class="o">-</code> <code class="mf">2.0</code> <code class="o">*</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code>
            <code class="n">out</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">=</code> <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">D</code> <code class="o">*</code> <code class="p">(</code><code class="n">grid_xx</code> <code class="o">+</code> <code class="n">grid_yy</code><code class="p">)</code> <code class="o">*</code> <code class="n">dt</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="c"># setting up initial conditions</code>
    <code class="n">scratch</code> <code class="o">=</code> <code class="p">[[</code><code class="mf">0.0</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">1</code><code class="p">])]</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">])]</code>
    <code class="n">grid</code> <code class="o">=</code> <code class="p">[[</code><code class="mf">0.0</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">1</code><code class="p">])]</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">])]</code>

    <code class="n">block_low</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="o">.</code><code class="mi">4</code><code class="p">)</code>
    <code class="n">block_high</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="o">.</code><code class="mi">5</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">block_low</code><code class="p">,</code> <code class="n">block_high</code><code class="p">):</code>
        <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">block_low</code><code class="p">,</code> <code class="n">block_high</code><code class="p">):</code>
            <code class="n">grid</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">=</code> <code class="mf">0.005</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="mf">0.1</code><code class="p">,</code> <code class="n">scratch</code><code class="p">)</code>
        <code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code> <code class="o">=</code> <code class="n">scratch</code><code class="p">,</code> <code class="n">grid</code>
    <code class="k">return</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code> <code class="o">-</code> <code class="n">start</code></pre></div></div><p>We can see from the line profile of the modified version of the code at
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_mem_lineprof">Example&nbsp;6-7</a> that this small change has given us a
21% speedup.  This conclusion is very much similar to the conclusion made during
the discussion on <code class="literal">append</code> operations on lists: memory allocations are not cheap.
Every time we request memory in order to store a variable or a list, python must
take its time to talk to the operating system in order to allocate the new
space, and then we must iterate over the newly allocated space to initialize it
to some value.  Whenever possible, reusing space that has already been allocated
will give performance speedups.  However, be careful when implementing these
changes.  While the speedups can be substantial, as always, profile to make sure
you are achieving the results you want and are not simply polluting your
code base.</p><div class="example"><a id="matrix_pure_python_mem_lineprof"></a><div class="example-title">Example&nbsp;6-7.&nbsp;Line Profiling Python Diffusion after reducing allocations</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>kernprof.py -lv diffusion_python_memory.py
Wrote profile results to diffusion_python_memory.py.lprof
Timer unit: 1e-06 s

File: diffusion_python_memory.py
Function: evolve at line 8
Total <code class="nb">time</code>: 13.3209 s

Line <code class="c">#      Hits         Time  Per Hit   % Time  Line Contents</code>
<code class="o">==============================================================</code>
     8                                           @profile
     9                                           def evolve<code class="o">(</code>grid, dt, out, <code class="nv">D</code><code class="o">=</code>1.0<code class="o">)</code>:
    10        10           15      1.5      0.0      xmax, <code class="nv">ymax</code> <code class="o">=</code> grid_shape
    11      5130         3853      0.8      0.0      <code class="k">for </code>i in xrange<code class="o">(</code>xmax<code class="o">)</code>:
    12   2626560      1942976      0.7     14.6          <code class="k">for </code>j in xrange<code class="o">(</code>ymax<code class="o">)</code>:
    13   2621440      4059998      1.5     30.5              <code class="nv">grid_xx</code> <code class="o">=</code> grid<code class="o">[(</code>i+1<code class="o">)</code>%xmax<code class="o">][</code>j<code class="o">]</code>
                                                                       + grid<code class="o">[(</code>i-1<code class="o">)</code>%xmax<code class="o">][</code>j<code class="o">]</code>
                                                                       - 2.0 * grid<code class="o">[</code>i<code class="o">][</code>j<code class="o">]</code>
    14   2621440      4038560      1.5     30.3              <code class="nv">grid_yy</code> <code class="o">=</code> grid<code class="o">[</code>i<code class="o">][(</code>j+1<code class="o">)</code>%ymax<code class="o">]</code>
                                                                       + grid<code class="o">[</code>i<code class="o">][(</code>j-1<code class="o">)</code>%ymax<code class="o">]</code>
                                                                       - 2.0 * grid<code class="o">[</code>i<code class="o">][</code>j<code class="o">]</code>
    15   2621440      3275454      1.2     24.6              out<code class="o">[</code>i<code class="o">][</code>j<code class="o">]</code> <code class="o">=</code> grid<code class="o">[</code>i<code class="o">][</code>j<code class="o">]</code> + D
                                                                         * <code class="o">(</code>grid_xx + grid_yy<code class="o">)</code>
                                                                         * dt</pre></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="matrix_memory_fragmentation">Memory Fragmentation</h2></div></div></div><p>The python code we wrote at <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_memory">Example&nbsp;6-6</a> still has a problem
that is at the heart of using python for these sorts of vectorized operations:
python doesn’t natively support vectorization.  This happens because of two
things: python lists store pointers to the actual data and python bytecode is
not optimized for vectorization so for loops cannot predict when using
vectorization would be beneficial.</p><p>The fact that python lists store pointers means that instead of actually holding
the data we care about, lists store a location where the data can actually be
found.  For most uses, this is good because it allows us to store whatever type
of data we like inside of a list.  However, when it comes to vector and matrix
operations this is a source for a lot of performance degradation.</p><p>The degradation occurs because every time we want to fetch an element from the
<code class="literal">grid</code> matrix, we must do multiple lookups.  For example, doing <code class="literal">grid[5][2]</code>
requires us to first do a list lookup for index 5 on the list <code class="literal">grid</code>.  This will
return a pointer to where the data at that location is stored.  Then, we do
another list lookup on this returned object for the element at index 2.  Once we
have this reference, we have the location where the actual data is stored.</p><p>The overhead for one such lookup is not big and can be, in most cases,
disregarded.  However, if the data we wanted was located in one contiguous block
in memory we could move ALL of the data in one operation instead of needing 2
operations for each element.  This is one of the major points with data
fragmentation: when your data is fragmented you must move each piece over
individually instead of moving the entire block over.  This means you are
invoking more memory transfer overhead and you are forcing the CPU to wait while
data is being transfered.  We will see with <code class="literal">perf</code> just how important this is
when looking at the <code class="literal">cache-misses</code>.</p><p>This problem of getting the right data to the CPU when it is needed is related
to the “Von Neumann bottleneck”.  This refers to the fact that there is a
limited bandwidth between the memory and the CPU as a result of the tiered
memory architecture which modern computers use.  If we could move data
infinitely fast, we would not need any cache since the CPU could retrieve any
data it needed instantly.  This would be a state where the bottleneck is
non-existent.</p><p>In order to deal with this, we pre-fetch data from the RAM and fill smaller but
faster CPU caches with the data so that hopefully, when the CPU needs a piece of
data, it will be located in a location that can be read from quickly.  While
this is a severely idealized way of looking at the architecture, we can still
see some of the problems with it—how do we know what data will be needed in
the future?  The CPU does a good job with a mechanisms called branch prediction
and pipelining which try to predict the next instruction and load the relevant
memory into cache while still working on the current instruction.  However, the
best way to minimize the effects of the bottleneck is to be smart about how we
allocate our memory and how we do our calculations over our data.</p><p>Probing how well memory is being moved to the CPU can be quite hard, however in
Linux the <code class="literal">perf</code> tool can be used to get amazing amounts of insight regarding
how the CPU is dealing with the program being run.  For example, we can run
<code class="literal">perf</code> on the pure python code from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_memory">Example&nbsp;6-6</a> and see
just how efficiently the CPU is running our code,</p><div class="example"><a id="matrix_perf_python_memory"></a><div class="example-title">Example&nbsp;6-8.&nbsp;Performance Counters for pure python 2D Diffusion with reduced memory allocations</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>perf stat -e cycles,stalled-cycles-frontend,stalled-cycles-backend,instructions,<code class="se">\</code>
    cache-references,cache-misses,branches,branch-misses,task-clock,faults,minor-faults,<code class="se">\</code>
    cs,migrations -r 3 python diffusion_python_memory.py

 Performance counter stats <code class="k">for</code> <code class="s1">'python diffusion_python_memory.py'</code> <code class="o">(</code>3 runs<code class="o">)</code>:

   329,155,359,015 cycles                    <code class="c">#    3.477 GHz                      ( +-  0.47% )</code>
    76,800,457,550 stalled-cycles-frontend   <code class="c">#   23.33% frontend cycles idle     ( +-  1.75% )</code>
    46,556,100,820 stalled-cycles-backend    <code class="c">#   14.14% backend  cycles idle     ( +-  0.77% )</code>
   598,135,111,009 instructions              <code class="c">#    1.82  insns per cycle</code>
                                             <code class="c">#    0.13  stalled cycles per insn  ( +-  0.00% )</code>
        35,497,196 cache-references          <code class="c">#    0.375 M/sec                    ( +-  0.94% )</code>
        10,716,972 cache-misses              <code class="c">#   30.191 % of all cache refs      ( +- 15.51% )</code>
   133,881,241,254 branches                  <code class="c"># 1414.067 M/sec                    ( +-  0.00% )</code>
     2,891,093,384 branch-misses             <code class="c">#    2.16% of all branches          ( +-  0.12% )</code>
      94678.127621 task-clock                <code class="c">#    0.999 CPUs utilized            ( +-  0.48% )</code>
             5,439 page-faults               <code class="c">#    0.057 K/sec                    ( +-  0.01% )</code>
             5,439 minor-faults              <code class="c">#    0.057 K/sec                    ( +-  0.01% )</code>
               125 context-switches          <code class="c">#    0.001 K/sec                    ( +-  2.55% )</code>
                 6 CPU-migrations            <code class="c">#    0.000 K/sec                    ( +- 16.67% )</code>

      94.749389121 seconds <code class="nb">time </code>elapsed                                          <code class="o">(</code> +-  0.48% <code class="o">)</code></pre></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_understanding_literal_perf_literal">Understanding <code class="literal">perf</code></h3></div></div></div><p>Let’s take a second to understand the various performance metrics that <code class="literal">perf</code> is
giving us and their connection to our code.  The <code class="literal">task-clock</code> metric tells us
how many clock cycles our task took.  This is different than the total runtime
because if our program took 1 second to run but used 2 CPUs then the task-clock
would be <code class="literal">1000</code> (<code class="literal">task-clock</code> is generally in milliseconds).  Conveniently,
<code class="literal">perf</code> does the calculation for us and tells us, next to this metric, how many
CPU’s were utilized.  This number isn’t exactly 1 because there were periods
where the process relied on other subsystems to do instructions for it (for
example when memory is allocated).</p><p><code class="literal">context-switches</code> and <code class="literal">CPU-migrations</code> tells us about how the program was moved
around on the motherboard.  When a <code class="literal">context-switch</code> happens, the program’s
execution is halted and another program is allowed to run instead.  This is a
<span class="emphasis"><em>very</em></span> time intensive task and is something we would like to minimize as much as
possible.  However, we don’t have too much control of when this happens.  The
kernel delegates when programs are allowed to be switched out, however we can do
things to disincentives the kernel from moving <span class="emphasis"><em>our</em></span> program.  In general, the
kernel suspends a program when it is doing IO (such as reading from memory, disk
or the network).  As we’ll see in later chapters, we can use async routines to
make sure that our program still uses the CPU even when waiting for IO, which
will let us keep running without being context-switched.  In addition, we could
set the <code class="literal">nice</code> value of our program in order to give our program priority and
stop the kernel from context switching it.  Similarly, <code class="literal">CPU-migrations</code> happen
when the program is halted and resumed on a different CPU than it was on before
in order to have all CPUs have the same utilization.  This can be seen as an
especially bad context-switch since not only is our program being temporarily
halted, but we lose whatever data we had in the L1 cache (recall that each CPU
has its own L1 cache).</p><p>A <code class="literal">page-fault</code> is part of the modern Unix memory allocation scheme.  When memory
is allocated, the kernel doesn’t do much except give the program a reference to
memory.  However, later, when the memory is first used, the operating system
throws a <code class="literal">minor page-fault</code> interrupt which pauses the program that is being run
and properly allocated the memory.  This is called a lazy allocation system.
While this method is quite an optimization over previous memory allocation
systems, minor page faults are quite an expensive operation since most of the
operations are done outside the scope of the program you are running.  There is
also a <code class="literal">major page-fault</code> which happens when the program requests data from a
device (disk, network, etc) that hasn’t been read yet.  These are even more
expensive operations since not only do they interrupt your program but they also
involve reading from whichever device the data lives on.  This sort of page
fault does not generally effect CPU-bound work however it will be a source of
pain for any program which does disk or network read/writes.</p><p>Once we have data in memory and we reference it, the data makes its way through
the various tiers of memory (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#understanding_pp_communication">Communications Layers</a> for a
discussion of this).  Whenever we reference data which is in our cache, the
<code class="literal">cache-references</code> metric increases.  If we did not have this data already in
cache and need to fetch it from RAM, this counts as a <code class="literal">cache-miss</code>.  We won’t
get a cache miss if we are reading data we have recently read (so that the data
is still in the cache) or data that is located <span class="emphasis"><em>near</em></span> data we have recently read
in memory since chunks of data are sent from RAM into the cache.  Cache misses
can be a source for slowdowns when it comes to CPU bound work since not only do
we need to wait to fetch the data from RAM but we also interrupt the flow of our
execution pipeline (more on this in a second).  We will be discussing how to
reduce this by optimizing the layout of data in memory later in this chapter.</p><p><code class="literal">instructions</code> tells us how many instructions our code is issuing to the CPU.
Because of pipelining, these instructions can be run several at a time which is
what the <code class="literal">insns per cycle</code> annotation tells us.  To get a better handle on this
pipelining, <code class="literal">stalled-cycles-fontend</code> and <code class="literal">stalled-cycles-backend</code> tells us how
many cycles our program was waiting around for the frontend or backend of the
pipeline to be filled.  This can happen because of a cache-miss where, a
miss-predicted branch or resource conflict. The front end of the pipeline is
responsible for fetching the next instruction from memory and decoding it into a
valid operation while the back end is responsible for actually running the
operation.  With pipelining the CPU is able to run the current operation while
fetching and preparing the next one.</p><p>A <code class="literal">branch</code> is a time in the code where the execution flow changes.  Think of an
<code class="literal">if..then</code> statement—depending on the result of the conditional we will
either be executing one section of code or another.  This is essentially a
branch in the execution of the code—the next instruction in the program could
be one of two things.  In order to optimize this, especially with regards to the
pipeline, the CPU tries to guess which direction the branch will take and
pre-load the relevant instructions.  When this prediction is incorrect, we will
get some stalled-cycles and a <code class="literal">branch-miss</code>.  Branch misses can be quite
confusing and result in many strange effects (for example some loops will run
substantially faster on sorted lists than unsorted lists simply because there will
be less branch misses).</p><div class="note"><h3 class="title">Note</h3><p>If you would like a more thorough explanation of what is going on at the CPU
level with the various performance metrics, Gurpur M. Prabhu has a fantastic
tutorial called “Computer Architecture Tutorial” at
<a class="ulink" href="http://www.cs.iastate.edu/~prabhu/Tutorial/title.html" target="_top">http://www.cs.iastate.edu/~prabhu/Tutorial/title.html</a>. It deals with the
problems at a very low level which gives a good understanding of what is going
on under the hood when you run code.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_making_decisions_with_literal_perf_literal_s_output">Making decisions with <code class="literal">perf</code>’s output</h3></div></div></div><p>With all this in mind, the performance metrics in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_perf_python_memory">Example&nbsp;6-8</a>
are telling us that while running our code, the CPU had to reference the L1/L2
cache 35,497,196 times.  Of those references, 10,716,972 (or 30.191%) were requests
for data that weren’t in memory at the time and had to be retrieved.  From this
data we can see other things as well.  For example, we can see that each CPU
cycle we are able to perform 1.82 instructions which tells us the total speed
boost from pipelining, out of order execution and hyperthreading (or any
other CPU feature that lets you run more than one instruction per clock cycle).</p><p>Fragmentation not only increases the number of memory transfers to the CPU, but
since you don’t have multiple pieces of data ready in the CPU cache when a
calculation is requested, you cannot vectorize the calculations.  As explained
in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#understanding_pp_communication">Communications Layers</a>, vectorization of computations (or having
the CPU do multiple computations at a time) can only occur if we can fill the
CPU cache with all the relevant data.  Since the bus can only move contiguous
chunks of memory, this would only be possible if the grid data is stored
sequential in RAM.  Since the list stores pointers to data instead of the actual
data, the actual values in the grid are scattered throughout memory and cannot
be copied at once.</p><p>This problem can be alleviated by using the <code class="literal">array</code> module instead of lists.
These objects store data sequentially in memory so that a slice of the array
actually represents a continuous range in memory.  However this doesn’t
completely fix the problem, now we have data that is stored sequentially in
memory but python still does not know how to vectorize our loops.  What we would
like is any loop that does arithmetic on our array one element at a time to work
on chunks of data, but as mentioned before there is no such bytecode
optimization in python (partly due to the extremely dynamic nature of the
language).</p><p>Furthermore, because of implementation details, using the <code class="literal">array</code> type when
creating lists of data that must be iterated on is actually <span class="emphasis"><em>slower</em></span> than simply
creating a <code class="literal">list</code>.  This is because the <code class="literal">array</code> object stores a very low level
representation of the numbers it stores and this must be converted into a
python-compatible version before being returned to the user.  This extra
overhead happens every time you index an <code class="literal">array</code> type.  That implementation
decision has made the <code class="literal">array</code> object less suitable for math and more suitable
for storing fixed-type data in a more efficiently in memory.</p><div class="note"><h3 class="title">Note</h3><p>Why doesn’t having the data we want sequentially in memory automatically give us
vectorization?  Well, if we were to look at the raw machine code that our CPU is
running, multiplying two arrays of numbers by each other in a vectorized way
versus a non-vectorized way use different parts of the CPU and thus different
instructions.  In order for python to properly utilize this, we must have a
module that was created to use those special instructions.</p></div><p>Luckily, the <code class="literal">numpy</code> package has all of the features we need—it stores data
in contiguous chunks of memory and supports vectorized operations on its data.
As a result, any arithmetic we do on numpy arrays happens in chunks without us
having to explicitly loop over each element.  Not only does this make it much
easier to do matrix arithmetic this way, but it is also faster.</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">array</code> <code class="kn">import</code> <code class="n">array</code>
<code class="kn">import</code> <code class="nn">numpy</code>

<code class="k">def</code> <code class="nf">norm_square_list</code><code class="p">(</code><code class="n">vector</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; vector = range(1000000)</code>
<code class="sd">    &gt;&gt;&gt; %timeit norm_square_list(vector_list)</code>
<code class="sd">    1000 loops, best of 3: 1.16 ms per loop</code>
<code class="sd">    """</code>
    <code class="n">norm</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">v</code> <code class="ow">in</code> <code class="n">vector</code><code class="p">:</code>
        <code class="n">norm</code> <code class="o">+=</code> <code class="n">v</code><code class="o">*</code><code class="n">v</code>
    <code class="k">return</code> <code class="n">norm</code>

<code class="k">def</code> <code class="nf">norm_square_list_comprehension</code><code class="p">(</code><code class="n">vector</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; vector = range(1000000)</code>
<code class="sd">    &gt;&gt;&gt; %timeit norm_square_list(vector_list)</code>
<code class="sd">    1000 loops, best of 3: 913 µs per loop</code>
<code class="sd">    """</code>
    <code class="k">return</code> <code class="nb">sum</code><code class="p">([</code><code class="n">v</code><code class="o">*</code><code class="n">v</code> <code class="k">for</code> <code class="n">v</code> <code class="ow">in</code> <code class="n">vector</code><code class="p">])</code>

<code class="k">def</code> <code class="nf">norm_square_array</code><code class="p">(</code><code class="n">vector</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; vector = array('l', range(1000000))</code>
<code class="sd">    &gt;&gt;&gt; %timeit norm_square_array(vector_array)</code>
<code class="sd">    1000 loops, best of 3: 1.44 ms per loop</code>
<code class="sd">    """</code>
    <code class="n">norm</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">v</code> <code class="ow">in</code> <code class="n">vector</code><code class="p">:</code>
        <code class="n">norm</code> <code class="o">+=</code> <code class="n">v</code><code class="o">*</code><code class="n">v</code>
    <code class="k">return</code> <code class="n">norm</code>

<code class="k">def</code> <code class="nf">norm_square_numpy</code><code class="p">(</code><code class="n">vector</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; vector = numpy.arange(1000000)</code>
<code class="sd">    &gt;&gt;&gt; %timeit norm_square_numpy(vector_numpy)</code>
<code class="sd">    10000 loops, best of 3: 30.9 µs per loop</code>
<code class="sd">    """</code>
    <code class="k">return</code> <code class="n">numpy</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">vector</code> <code class="o">*</code> <code class="n">vector</code><code class="p">)</code> <code class="c"># </code><a id="CO8-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">

<code class="k">def</code> <code class="nf">norm_square_numpy_dot</code><code class="p">(</code><code class="n">vector</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    &gt;&gt;&gt; vector = numpy.arange(1000000)</code>
<code class="sd">    &gt;&gt;&gt; %timeit norm_square_numpy_dot(vector_numpy)</code>
<code class="sd">    10000 loops, best of 3: 21.8 µs per loop</code>
<code class="sd">    """</code>
    <code class="k">return</code> <code class="n">numpy</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">vector</code><code class="p">,</code> <code class="n">vector</code><code class="p">)</code> <code class="c"># </code><a id="CO8-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#CO8-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
This creates two implied loops over <code class="literal">vector</code>, one to do the multiplication and one to do the sum.  These loops are similar to the loops from <code class="literal">norm_square_list_comprehension</code>, however are executed using numpy’s optimized numerical code.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#CO8-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
This is the prefered way of doing vector norms in numpy.  The less efficient <code class="literal">norm_square_numpy</code> code is provided for illustration.
</p></dd></dl></div><p>The simpler numpy code runs 37.54x faster than <code class="literal">norm_square_list</code> and 29.5x
faster than the “optimized” python list comprehension.  The difference in speed
between the pure python looping method and the list comprehension method shows
the benefit of doing more calculation behind the scenes rather than explicitly
doing it in your python code.  By performing calculations using python’s already
built machinery we get the speed of the native C code that python is built on.
This is also partly the same reasoning behind why we have such a drastic speed
up in the numpy code: instead of using the very generalized list structure we
have a very finely tuned and specially built object for dealing with arrays of
numbers.</p><p>In addition to lighter and more specialized machinery, the numpy object also
gives us memory locality and vectorized operations, which are incredibly
important when dealing with numerical computations.  The CPU is exceedingly fast
and most of the time simply getting it the data it needs faster is the best way
to optimize code quickly.  Running each function using the <code class="literal">perf</code> tool above
shows that the <code class="literal">array</code> and pure python functions take ~100,000,000,000
instructions while the <code class="literal">numpy</code> version take ~3,000,000,000 instructions.  In
addition, the <code class="literal">array</code> and pure python have ~80% cache misses while <code class="literal">numpy</code> has
\~55%.</p><div class="figure"><a id="matrix_norm_squared_figure"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 432; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/norm_squared.png" alt="Runtimes for the various norm squared routines with vectors of different lenghts" width="800" height="600" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/norm_squared.png"></div></div><div class="figure-title">Figure&nbsp;6-3.&nbsp;Runtimes for the various norm squared routines with vectors of different lenghts</div></div><p>In the above <code class="literal">norm_square_numpy</code> code, when doing <code class="literal">vector*vector</code>, there is an
<span class="emphasis"><em>implied</em></span> loop which numpy will take care of.  The implied loop is the same loop
we have explicitly written out in the other examples: loop over all items in
<code class="literal">vector</code> and multiply that item by itself.  However, since we tell numpy to do
this instead of explicitly writing it out in python code, it can take advantage
of all the optimizations it wants.  In the background, numpy has very optimized
C code that has been specifically made to take advantage of any vectorization
the CPU has enabled.  In addition, numpy arrays are represented sequentially in
memory as low level numerical types which gives them the same space requirements
as the <code class="literal">array</code> module.</p><p>As an extra bonus, we can reformulate the problem as a dot product, which numpy
supports.  This gives us a single operation to calculate the value we want, as
opposed to first taking the product of the two vectors and then summing them.
As you can see in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_norm_squared_figure">Figure&nbsp;6-3</a>, this operation,
<code class="literal">norm_numpy_dot</code> outperforms all the others by quite a substantial margin thanks
to the specialization of the function and since we don’t need to store the
intermediate value of <code class="literal">vector*vector</code> as we did in <code class="literal">norm_numpy</code>.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_enter_numpy">Enter numpy</h2></div></div></div><p>Using what we learned before about numpy, we can easily adapt the pure python
code to be vectorized.  The only new functionality we must introduce is numpy’s
<code class="literal">roll</code> function.  This function does the same thing as our modulo-index trick,
however it does so for an entire numpy array.  In essence, it vectorizes this
re-indexing.</p><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">],</code> <code class="mi">1</code><code class="p">)</code>
<code class="go">array([4, 1, 2, 3])</code>

<code class="gp">&gt;&gt;&gt; </code><code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">([[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">],[</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">]],</code> <code class="mi">1</code><code class="p">,</code> <code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code>
<code class="go">array([[3, 1, 2],</code>
<code class="go">       [6, 4, 5]])</code></pre><p>The <code class="literal">roll</code> function creates a new numpy array which can be thought of as both
good and bad.  The downside is that we are taking time to allocate new space
which then needs to be filled with the appropriate data.  On the other hand,
once we have created this new rolled array we are able to vectorize operations
on it quite quickly and not suffer from cache misses from the CPU cache.  This
can substantially effect speed of the actual calculation we must do on the grid.
Later in this chapter, we will rewrite this so that we get the same benefit
without having to constantly allocate more memory.</p><p>With this additional function we can re-write the python diffusion code from
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_memory">Example&nbsp;6-6</a> using much simplified, vectorized, numpy
arrays.  In addition, we break up the calculation of the derivatives, <code class="literal">grid_xx</code>
and <code class="literal">grid_yy</code> into a separate function.</p><div class="example"><a id="matrix_numpy_naive"></a><div class="example-title">Example&nbsp;6-9.&nbsp;Initial numpy diffusion</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>

<code class="n">grid_shape</code> <code class="o">=</code> <code class="p">(</code><code class="mi">1024</code><code class="p">,</code> <code class="mi">1024</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> <code class="o">+</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> <code class="o">+</code> \
           <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code> <code class="o">+</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code> <code class="o">-</code> <code class="mi">4</code> <code class="o">*</code> <code class="n">grid</code>

<code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mi">1</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">grid</code> <code class="o">+</code> <code class="n">dt</code> <code class="o">*</code> <code class="n">D</code> <code class="o">*</code> <code class="n">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="n">grid</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">)</code>

    <code class="n">block_low</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="o">.</code><code class="mi">4</code><code class="p">)</code>
    <code class="n">block_high</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="o">.</code><code class="mi">5</code><code class="p">)</code>
    <code class="n">grid</code><code class="p">[</code><code class="n">block_low</code><code class="p">:</code><code class="n">block_high</code><code class="p">,</code> <code class="n">block_low</code><code class="p">:</code><code class="n">block_high</code><code class="p">]</code> <code class="o">=</code> <code class="mf">0.005</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">grid</code> <code class="o">=</code> <code class="n">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="mf">0.1</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code> <code class="o">-</code> <code class="n">start</code></pre></div></div><p>Immediately we see that the above code is much shorter.  This is generally a
good indication of performance since we are doing a lot of the heavy lifting
outside of the python interpreter and hopefully inside of a module specially
built for performance solving a particular problem (however this should always
be tested).  One of the assumptions here is that numpy is using better memory
management in order to give the CPU the data it needs faster.  However, since
whether or not this happens relies on the actual implementation of numpy, let’s
profile the above code and see whether our hypothesis is correct.</p><div class="example"><a id="matrix_perf_numpy"></a><div class="example-title">Example&nbsp;6-10.&nbsp;Performance Counters for numpy 2D Diffusion</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>perf stat -e cycles,stalled-cycles-frontend,stalled-cycles-backend,instructions,<code class="se">\</code>
    cache-references,cache-misses,branches,branch-misses,task-clock,faults,minor-faults,<code class="se">\</code>
    cs,migrations -r 3 python diffusion_numpy.py

 Performance counter stats <code class="k">for</code> <code class="s1">'python diffusion_numpy.py'</code> <code class="o">(</code>3 runs<code class="o">)</code>:

    10,194,811,718 cycles                    <code class="c">#    3.332 GHz                      ( +-  0.35% )</code>
     4,435,850,419 stalled-cycles-frontend   <code class="c">#   43.51% frontend cycles idle     ( +-  0.86% )</code>
     2,055,861,567 stalled-cycles-backend    <code class="c">#   20.17% backend  cycles idle     ( +-  0.89% )</code>
    15,165,151,844 instructions              <code class="c">#    1.49  insns per cycle</code>
                                             <code class="c">#    0.29  stalled cycles per insn  ( +-  0.01% )</code>
       346,798,311 cache-references          <code class="c">#  113.362 M/sec                    ( +-  0.06% )</code>
           519,793 cache-misses              <code class="c">#    0.150 % of all cache refs      ( +- 10.23% )</code>
     3,506,887,927 branches                  <code class="c"># 1146.334 M/sec                    ( +-  0.01% )</code>
         3,681,441 branch-misses             <code class="c">#    0.10% of all branches          ( +-  0.47% )</code>
       3059.219862 task-clock                <code class="c">#    0.999 CPUs utilized            ( +-  3.13% )</code>
           751,707 page-faults               <code class="c">#    0.246 M/sec</code>
           751,707 minor-faults              <code class="c">#    0.246 M/sec</code>
                 8 context-switches          <code class="c">#    0.003 K/sec                    ( +-  7.22% )</code>
                 1 CPU-migrations            <code class="c">#    0.000 K/sec                    ( +- 57.74% )</code>

       3.061883218 seconds <code class="nb">time </code>elapsed                                          <code class="o">(</code> +-  3.13% <code class="o">)</code></pre></div></div><p>This shows that the simple change to numpy has given us a 40x speedup over
the pure python implementation with reduced memory allocations
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_perf_python_memory">Example&nbsp;6-8</a>).  How was this achieved?</p><p>First of all, we can thank the vectorization that numpy gives.  Although the
numpy version seems to be running less instructions per cycle, each of the
instructions is able to do much more work.  That is to say, one vectorized
instruction can multiply 4 (or more) numbers in an array together instead of
having to do 4 independent multiplication instructions.  Overall this results in
less total instructions necessary to solve the same problem.</p><p>There are also several other factors that contribute to the numpy version having
less absolute number of instructions needed to solve the diffusion problem.  One
of them has to do with the full python API being available when running the pure
python version, but not necessarily there for the numpy version (for example,
the pure python grids could be appended to, but not the numpy version).  Even
though we weren’t explicitly using this functionality, there is overhead in
providing a system where they <span class="emphasis"><em>could</em></span> be available.  Since numpy can make the
assumption that the data being stored is always going to be numbers, everything
regarding the arrays can be optimized for operations over numbers.  We will
continue on the track of removing necessary functionality in favor of
performance when we talk about cython in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython">Cython</a> where it is even
possible to remove list bounds checking to speed up list lookups.</p><p>Normally the number of instructions doesn’t necissarily correlate to performance
because the program with less instructions may not issue them efficiently or
they may be slow instructions.  However, we see that in addition to reducing the
number of instructions, the numpy version has also reduced a large inefficency,
cache misses (0.15% cache misses instead of 30.2%).  As explained in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_memory_fragmentation">Memory Fragmentation</a>, cache misses slow down computations because the
CPU must wait for data to be retrieved from slower memory instead of having it
immediately available in its cache.  In fact, memory fragmentation is such a
dominant effect that if we disable vectorization
<sup>[<a id="matrix_numpy_novec" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#ftn.matrix_numpy_novec" epub:type="noteref" class="footnote">14</a>]</sup>
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_perf_numpy_novec">Example&nbsp;6-11</a>) in numpy but keep everything else we still see a
sizable speed increase compared to the pure python version.</p><div class="example"><a id="matrix_perf_numpy_novec"></a><div class="example-title">Example&nbsp;6-11.&nbsp;Performance Counters for numpy 2D Diffusion without Vectorization</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>perf stat -e cycles,stalled-cycles-frontend,stalled-cycles-backend,instructions,<code class="se">\</code>
    cache-references,cache-misses,branches,branch-misses,task-clock,faults,minor-faults,<code class="se">\</code>
    cs,migrations -r 3 python diffusion_numpy.py

 Performance counter stats <code class="k">for</code> <code class="s1">'python diffusion_numpy.py'</code> <code class="o">(</code>3 runs<code class="o">)</code>:

    48,923,515,604 cycles                    <code class="c">#    3.413 GHz                      ( +-  0.07% )</code>
    24,901,979,501 stalled-cycles-frontend   <code class="c">#   50.90% frontend cycles idle     ( +-  0.10% )</code>
     6,585,982,510 stalled-cycles-backend    <code class="c">#   13.46% backend  cycles idle     ( +-  0.08% )</code>
    53,208,756,117 instructions              <code class="c">#    1.09  insns per cycle</code>
                                             <code class="c">#    0.47  stalled cycles per insn  ( +-  0.00% )</code>
        83,436,665 cache-references          <code class="c">#    5.821 M/sec                    ( +-  0.26% )</code>
         1,211,229 cache-misses              <code class="c">#    1.452 % of all cache refs      ( +-  9.55% )</code>
     4,428,225,111 branches                  <code class="c">#  308.926 M/sec                    ( +-  0.01% )</code>
         3,716,789 branch-misses             <code class="c">#    0.08% of all branches          ( +-  0.21% )</code>
      14334.244888 task-clock                <code class="c">#    0.999 CPUs utilized            ( +-  0.99% )</code>
           751,185 page-faults               <code class="c">#    0.052 M/sec                    ( +-  0.00% )</code>
           751,185 minor-faults              <code class="c">#    0.052 M/sec                    ( +-  0.00% )</code>
                24 context-switches          <code class="c">#    0.002 K/sec                    ( +-  2.41% )</code>
                 5 CPU-migrations            <code class="c">#    0.000 K/sec                    ( +- 16.54% )</code>

      14.345794896 seconds <code class="nb">time </code>elapsed                                          <code class="o">(</code> +-  0.99% <code class="o">)</code></pre></div></div><p>This shows us that the dominant effect in our 40x speedup when introducing
numpy is not the vectorized instruction set but rather the memory locality and
memory fragmentation.  In fact, we can see from the above experiment that
vectorization gives us a \~6x speedup.<sup>[<a id="matrix_cpu_warning" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#ftn.matrix_cpu_warning" epub:type="noteref" class="footnote">15</a>]</sup></p><p>This realization that memory issues are the dominant effect in slowing down our
code doesn’t come as too much of a shock.  Computers are very well designed to
exactly the calculation we are requesting them to do with the problem—multiply and add numbers together.  The bottleneck is in getting those numbers
to the CPU fast enough to see it do the calculations as fast as it can.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_memory_allocations_and_in_place_operations">Memory Allocations and In-place Operations</h3></div></div></div><p>In order to optimize the memory dominated effects, let us try using the same
method we used in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_memory">Example&nbsp;6-6</a> in order to reduce the number of
allocations we make in our numpy code.  Allocations are quite a bit worse than
the cache misses we discussed previously.  Instead of simply having to find the
right data in RAM when it is not found in cache, an allocation also must make a
request to the operating system for an available chunk of data and then reserve
it.  The request to the operating system is quite a lot more overhead than
simply filling a cache—while filling a cache miss is a hardware routine that
is optimized on the motherboard, allocating memory  requires talking to another
process, the kernel, in order to complete.</p><p>In order to remove the allocations in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_naive">Example&nbsp;6-9</a> we will
pre-allocate some scratch space at the beginning of the code and then only use
in-place operations.  In-place operations, such as <code class="literal">+=</code>, <code class="literal">*=</code>, etc., reuse one
of the inputs as its output.  This means that we don’t need to allocate space
in order to store the result of the calculation.</p><p>To show this explicitly, we will look at how the <code class="literal">id</code> of a numpy array changes
as we perform operations on it.  The <code class="literal">id</code> is a good way of tracking this for
numpy arrays since the id has to do with what section of memory is being
reference.  If two numpy arrays have the same id then they are referencing the
same section of memory <sup>[<a id="id609491" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#ftn.id609491" epub:type="noteref" class="footnote">16</a>]</sup>.</p><div class="example"><a id="matrix_numpy_inplace_example1"></a><div class="example-title">Example&nbsp;6-12.&nbsp;In-place operations reducing memory allocations</div><div class="example-contents"><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">array1</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">((</code><code class="mi">10</code><code class="p">,</code><code class="mi">10</code><code class="p">))</code>
<code class="gp">&gt;&gt;&gt; </code><code class="n">array2</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">((</code><code class="mi">10</code><code class="p">,</code><code class="mi">10</code><code class="p">))</code>
<code class="gp">&gt;&gt;&gt; </code><code class="nb">id</code><code class="p">(</code><code class="n">array1</code><code class="p">)</code>
<code class="go">140199765947424  # </code><a id="CO9-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
<code class="gp">&gt;&gt;&gt; </code><code class="n">array1</code> <code class="o">+=</code> <code class="n">array2</code>
<code class="gp">&gt;&gt;&gt; </code><code class="nb">id</code><code class="p">(</code><code class="n">array1</code><code class="p">)</code>
<code class="go">140199765947424  # </code><a id="CO9-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
<code class="gp">&gt;&gt;&gt; </code><code class="n">array1</code> <code class="o">=</code> <code class="n">array1</code> <code class="o">+</code> <code class="n">array2</code>
<code class="gp">&gt;&gt;&gt; </code><code class="nb">id</code><code class="p">(</code><code class="n">array1</code><code class="p">)</code>
<code class="go">140199765969792  # </code><a id="CO9-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#CO9-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#CO9-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
These two ID’s are the same since we are doing an in-place operation.  This means that the memory address of <code class="literal">array1</code> does not change, we are simply changing the data contained within it.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#CO9-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
Here, the memory address has change.  When doing <code class="literal">array1 + array2</code>, a new memory address is allocated and filled with the result of the computation.  This does have benefits however, for when the original data needs to be preserved (ie: <code class="literal">array3 = array1 + array2</code> allows you to keep using <code class="literal">array1</code> and <code class="literal">array2</code>, while in-place operations destroy some of the original data).
</p></dd></dl></div></div></div><p>Furthermore, we see an expected slowdown from the non-in-place operation.  For
small numpy arrays, this overhead can be as large as 50% of the total
computation time.  For larger computations, the speedup is more in the single
percent region, this still represents a lot of time if this is happening
millions of times.</p><div class="example"><a id="matrix_numpy_inplace_benchmark"></a><div class="example-title">Example&nbsp;6-13.&nbsp;In-place operations reducing memory allocations</div><div class="example-contents"><pre class="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="o">%%</code><code class="n">timeit</code> <code class="n">array1</code><code class="p">,</code> <code class="n">array2</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">((</code><code class="mi">10</code><code class="p">,</code><code class="mi">10</code><code class="p">)),</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">((</code><code class="mi">10</code><code class="p">,</code><code class="mi">10</code><code class="p">))</code>
<code class="gp">... </code><code class="n">array1</code> <code class="o">=</code> <code class="n">array1</code> <code class="o">+</code> <code class="n">array2</code>
<code class="gp">...</code>
<code class="go">100000 loops, best of 3: 3.03 us per loop</code>

<code class="gp">&gt;&gt;&gt; </code><code class="o">%%</code><code class="n">timeit</code> <code class="n">array1</code><code class="p">,</code> <code class="n">array2</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">((</code><code class="mi">10</code><code class="p">,</code><code class="mi">10</code><code class="p">)),</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">((</code><code class="mi">10</code><code class="p">,</code><code class="mi">10</code><code class="p">))</code>
<code class="gp">... </code><code class="n">array1</code> <code class="o">+=</code> <code class="n">array2</code>
<code class="gp">...</code>
<code class="go">100000 loops, best of 3: 2.42 us per loop</code></pre></div></div><p>The downside is that rewriting our code from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_naive">Example&nbsp;6-9</a> to use
in place operations is not very complicated, but it does make the resulting code
a bit harder to read.  In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a> we can see the results of
this refactoring.  We instantiate <code class="literal">grid</code> and <code class="literal">scratch</code> vectors and we constantly
swap them with each other.  <code class="literal">grid</code> is the current information we know about the
system and, after running <code class="literal">evolve</code>, <code class="literal">scratch</code> contains the updated information.</p><div class="example"><a id="matrix_numpy_memory1"></a><div class="example-title">Example&nbsp;6-14.&nbsp;Making most numpy operations inplace</div><div class="example-contents"><pre class="programlisting"><code class="k">def</code> <code class="nf">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">):</code>
    <code class="n">np</code><code class="o">.</code><code class="n">copyto</code><code class="p">(</code><code class="n">out</code><code class="p">,</code> <code class="n">grid</code><code class="p">)</code>
    <code class="n">out</code> <code class="o">*=</code> <code class="o">-</code><code class="mi">4</code>
    <code class="n">out</code> <code class="o">+=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
    <code class="n">out</code> <code class="o">+=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
    <code class="n">out</code> <code class="o">+=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
    <code class="n">out</code> <code class="o">+=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">out</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mi">1</code><code class="p">):</code>
    <code class="n">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">)</code>
    <code class="n">out</code> <code class="o">*=</code> <code class="n">D</code> <code class="o">*</code> <code class="n">dt</code>
    <code class="n">out</code> <code class="o">+=</code> <code class="n">grid</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="n">scratch</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">)</code>
    <code class="n">grid</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">)</code>

    <code class="n">block_low</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="o">.</code><code class="mi">4</code><code class="p">)</code>
    <code class="n">block_high</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="o">.</code><code class="mi">5</code><code class="p">)</code>
    <code class="n">grid</code><code class="p">[</code><code class="n">block_low</code><code class="p">:</code><code class="n">block_high</code><code class="p">,</code> <code class="n">block_low</code><code class="p">:</code><code class="n">block_high</code><code class="p">]</code> <code class="o">=</code> <code class="mf">0.005</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="mf">0.1</code><code class="p">,</code> <code class="n">scratch</code><code class="p">)</code>
        <code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code> <code class="o">=</code> <code class="n">scratch</code><code class="p">,</code> <code class="n">grid</code>        <code class="c"># </code><a id="CO10-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="k">return</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code> <code class="o">-</code> <code class="n">start</code></pre></div></div><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#CO10-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Since the output of <code class="literal">evolve</code> gets stored in the output vector <code class="literal">scratch</code>, we must swap these two variables so that, for the next iteration of the loop, <code class="literal">grid</code> has the most updated information.  This swap operation is quite cheap because only the references to the data are changed, not the data itself.
</p></dd></dl></div><p>It is important to remember that since we want each operation to be in place,
whenever we do a vector operation we must have it be on its own line.  This can
make something as simple as <code class="literal">A = A*B + C</code> become quite convoluted.  Since
Python has a heavy emphasis on readability, we should make sure that the changes
we have made give us sufficient speedups to be justified.</p><div class="example"><a id="matrix_numpy_memory1_perf"></a><div class="example-title">Example&nbsp;6-15.&nbsp;Performance metrics for numpy with inplace memory operations</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>perf stat -e cycles,stalled-cycles-frontend,stalled-cycles-backend,instructions,<code class="se">\</code>
    cache-references,cache-misses,branches,branch-misses,task-clock,faults,minor-faults,<code class="se">\</code>
    cs,migrations -r 3 python diffusion_numpy_memory.py

 Performance counter stats <code class="k">for</code> <code class="s1">'python diffusion_numpy_memory.py'</code> <code class="o">(</code>3 runs<code class="o">)</code>:

     7,864,072,570 cycles                    <code class="c">#    3.330 GHz                      ( +-  0.02% )</code>
     3,055,151,931 stalled-cycles-frontend   <code class="c">#   38.85% frontend cycles idle     ( +-  0.05% )</code>
     1,368,235,506 stalled-cycles-backend    <code class="c">#   17.40% backend  cycles idle     ( +-  0.09% )</code>
    13,257,488,848 instructions              <code class="c">#    1.69  insns per cycle</code>
                                             <code class="c">#    0.23  stalled cycles per insn  ( +-  0.00% )</code>
       239,195,407 cache-references          <code class="c">#  101.291 M/sec                    ( +-  0.03% )</code>
         2,886,525 cache-misses              <code class="c">#    1.207 % of all cache refs      ( +-  0.56% )</code>
     3,166,506,861 branches                  <code class="c"># 1340.903 M/sec                    ( +-  0.00% )</code>
         3,204,960 branch-misses             <code class="c">#    0.10% of all branches          ( +-  0.28% )</code>
       2361.473922 task-clock                <code class="c">#    0.999 CPUs utilized            ( +-  4.69% )</code>
             6,527 page-faults               <code class="c">#    0.003 M/sec                    ( +-  0.01% )</code>
             6,527 minor-faults              <code class="c">#    0.003 M/sec                    ( +-  0.01% )</code>
                 6 context-switches          <code class="c">#    0.003 K/sec                    ( +- 10.53% )</code>
                 2 CPU-migrations            <code class="c">#    0.001 K/sec                    ( +- 79.54% )</code>

       2.363727876 seconds <code class="nb">time </code>elapsed                                          <code class="o">(</code> +-  4.68% <code class="o">)</code></pre></div></div><p>Comparing the performance metrics from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1_perf">Example&nbsp;6-15</a> and
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_perf_numpy">Example&nbsp;6-10</a>, we see that removing the spurious allocations sped up our
code 29%.  This comes partly from a reduction in the number of cache misses,
but mostly from a reduction in page faults.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="matrix_selective_optimizations">Selective optimizations: finding what needs to be fixed</h3></div></div></div><p>Looking at the code from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a>, it seems like we have
addressed most of the issues at hand: we have reduced CPU burden by using numpy
and we have reduced the number of allocations necessary to solve the problem.
However, there is always more investigation.  If we do a line profile on that
code (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory_lineprof">Example&nbsp;6-16</a>), we see that the majority of our work is
done within the <code class="literal">laplace</code> function.  In fact, 93% of time <code class="literal">evolve</code> takes to run
is spent in <code class="literal">laplace</code>.</p><div class="example"><a id="matrix_numpy_memory_lineprof"></a><div class="example-title">Example&nbsp;6-16.&nbsp;Line profiling shows that <code class="literal">laplace</code> is taking too much time</div><div class="example-contents"><pre class="programlisting"><code class="n">Wrote</code> <code class="n">profile</code> <code class="n">results</code> <code class="n">to</code> <code class="n">diffusion_numpy_memory</code><code class="o">.</code><code class="n">py</code><code class="o">.</code><code class="n">lprof</code>
<code class="n">Timer</code> <code class="n">unit</code><code class="p">:</code> <code class="mf">1e-06</code> <code class="n">s</code>

<code class="n">File</code><code class="p">:</code> <code class="n">diffusion_numpy_memory</code><code class="o">.</code><code class="n">py</code>
<code class="n">Function</code><code class="p">:</code> <code class="n">laplacian</code> <code class="n">at</code> <code class="n">line</code> <code class="mi">8</code>
<code class="n">Total</code> <code class="n">time</code><code class="p">:</code> <code class="mf">3.67347</code> <code class="n">s</code>

<code class="n">Line</code> <code class="c">#      Hits         Time  Per Hit   % Time  Line Contents</code>
<code class="o">==============================================================</code>
     <code class="mi">8</code>                                           <code class="nd">@profile</code>
     <code class="mi">9</code>                                           <code class="k">def</code> <code class="nf">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">):</code>
    <code class="mi">10</code>       <code class="mi">500</code>       <code class="mi">162009</code>    <code class="mf">324.0</code>      <code class="mf">4.4</code>      <code class="n">np</code><code class="o">.</code><code class="n">copyto</code><code class="p">(</code><code class="n">out</code><code class="p">,</code> <code class="n">grid</code><code class="p">)</code>
    <code class="mi">11</code>       <code class="mi">500</code>       <code class="mi">111044</code>    <code class="mf">222.1</code>      <code class="mf">3.0</code>      <code class="n">out</code> <code class="o">*=</code> <code class="o">-</code><code class="mi">4</code>
    <code class="mi">12</code>       <code class="mi">500</code>       <code class="mi">464810</code>    <code class="mf">929.6</code>     <code class="mf">12.7</code>      <code class="n">out</code> <code class="o">+=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
    <code class="mi">13</code>       <code class="mi">500</code>       <code class="mi">432518</code>    <code class="mf">865.0</code>     <code class="mf">11.8</code>      <code class="n">out</code> <code class="o">+=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
    <code class="mi">14</code>       <code class="mi">500</code>      <code class="mi">1261692</code>   <code class="mf">2523.4</code>     <code class="mf">34.3</code>      <code class="n">out</code> <code class="o">+=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
    <code class="mi">15</code>       <code class="mi">500</code>      <code class="mi">1241398</code>   <code class="mf">2482.8</code>     <code class="mf">33.8</code>      <code class="n">out</code> <code class="o">+=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>

<code class="n">File</code><code class="p">:</code> <code class="n">diffusion_numpy_memory</code><code class="o">.</code><code class="n">py</code>
<code class="n">Function</code><code class="p">:</code> <code class="n">evolve</code> <code class="n">at</code> <code class="n">line</code> <code class="mi">17</code>
<code class="n">Total</code> <code class="n">time</code><code class="p">:</code> <code class="mf">3.97768</code> <code class="n">s</code>

<code class="n">Line</code> <code class="c">#      Hits         Time  Per Hit   % Time  Line Contents</code>
<code class="o">==============================================================</code>
    <code class="mi">17</code>                                           <code class="nd">@profile</code>
    <code class="mi">18</code>                                           <code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">out</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mi">1</code><code class="p">):</code>
    <code class="mi">19</code>       <code class="mi">500</code>      <code class="mi">3691674</code>   <code class="mf">7383.3</code>     <code class="mf">92.8</code>      <code class="n">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">)</code>
    <code class="mi">20</code>       <code class="mi">500</code>       <code class="mi">111687</code>    <code class="mf">223.4</code>      <code class="mf">2.8</code>      <code class="n">out</code> <code class="o">*=</code> <code class="n">D</code> <code class="o">*</code> <code class="n">dt</code>
    <code class="mi">21</code>       <code class="mi">500</code>       <code class="mi">174320</code>    <code class="mf">348.6</code>      <code class="mf">4.4</code>      <code class="n">out</code> <code class="o">+=</code> <code class="n">grid</code></pre></div></div><p>There could be many reasons why <code class="literal">laplace</code> is so slow, however there are two main
high level issue to consider.  First, it looks like the calls <code class="literal">np.roll</code> are
allocating new vectors (this can be verified by looking at the documentation for
the function).  This means that even though we removed 7 memory allocations in
our previous refactoring, there are still 4 outstanding allocations.
Furthermore, <code class="literal">np.roll</code> is a very generalized function that has a lot of code to
deal with special cases.  Since we know exactly what we want to do (move just
the first column of data to be the last in every dimension), we can re-write
this function to eliminate most of the spurious code.  We could even merge the
<code class="literal">np.roll</code> logic with the add operation that happens with the rolled data to make
a very specialized <code class="literal">roll_add</code> function that does exactly what we want with the
least number of allocations and extra logic.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory2">Example&nbsp;6-17</a> shows what this refactoring would look like.  All we
need to do is create our new <code class="literal">roll_add</code> function and have <code class="literal">laplacian</code> use it.
Since numpy supports fancy indexing, implementing such a function is just a
matter of not jumbling up the indices.  However, as stated before, while this
code may be more performant it is much less readable.</p><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>Notice the extra work that has gone into having an informative docstring for the
function in addition to full tests.  Whenever taking a route similar to this
one, it is important to maintain the readability of the code and these steps go
a long way to making sure your code is always doing what it was intended to do
and that future programmers can modify your code and know what things do and
when things are not working.</p></div><div class="example"><a id="matrix_numpy_memory2"></a><div class="example-title">Example&nbsp;6-17.&nbsp;Creating our own roll function</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>

<code class="k">def</code> <code class="nf">roll_add</code><code class="p">(</code><code class="n">rollee</code><code class="p">,</code> <code class="n">shift</code><code class="p">,</code> <code class="n">axis</code><code class="p">,</code> <code class="n">out</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    Given a matrix, rollee, and an output matrix, out, this function will</code>
<code class="sd">    perform the calculation:</code>

<code class="sd">        &gt;&gt;&gt; out += np.roll(rollee, shift, axis=axis)</code>

<code class="sd">    This is done with the following assumptions:</code>
<code class="sd">        * rollee is 2D</code>
<code class="sd">        * shift will only ever be +1 or -1</code>
<code class="sd">        * axis will only ever be 0 or 1 (also implied by the first assumption)</code>

<code class="sd">    Using these assumptions, we are able to speed up this function by avoiding</code>
<code class="sd">    extra machinery that numpy uses to generalize the `roll` function and also</code>
<code class="sd">    by making this operation intrinsically in-place.</code>
<code class="sd">    """</code>
    <code class="k">if</code> <code class="n">shift</code> <code class="o">==</code> <code class="mi">1</code> <code class="ow">and</code> <code class="n">axis</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
        <code class="n">out</code><code class="p">[</code><code class="mi">1</code><code class="p">:,</code> <code class="p">:]</code> <code class="o">+=</code> <code class="n">rollee</code><code class="p">[:</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="p">:]</code>
        <code class="n">out</code><code class="p">[</code><code class="mi">0</code> <code class="p">,</code> <code class="p">:]</code> <code class="o">+=</code> <code class="n">rollee</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code>  <code class="p">:]</code>
    <code class="k">elif</code> <code class="n">shift</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code> <code class="ow">and</code> <code class="n">axis</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
        <code class="n">out</code><code class="p">[:</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="p">:]</code> <code class="o">+=</code> <code class="n">rollee</code><code class="p">[</code><code class="mi">1</code><code class="p">:,</code> <code class="p">:]</code>
        <code class="n">out</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code> <code class="p">,</code> <code class="p">:]</code> <code class="o">+=</code> <code class="n">rollee</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code>  <code class="p">:]</code>
    <code class="k">elif</code> <code class="n">shift</code> <code class="o">==</code> <code class="mi">1</code> <code class="ow">and</code> <code class="n">axis</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>
        <code class="n">out</code><code class="p">[:,</code> <code class="mi">1</code><code class="p">:]</code> <code class="o">+=</code> <code class="n">rollee</code><code class="p">[:,</code> <code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>
        <code class="n">out</code><code class="p">[:,</code> <code class="mi">0</code> <code class="p">]</code> <code class="o">+=</code> <code class="n">rollee</code><code class="p">[:,</code>  <code class="o">-</code><code class="mi">1</code><code class="p">]</code>
    <code class="k">elif</code> <code class="n">shift</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code> <code class="ow">and</code> <code class="n">axis</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>
        <code class="n">out</code><code class="p">[:,</code> <code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code> <code class="o">+=</code> <code class="n">rollee</code><code class="p">[:,</code> <code class="mi">1</code><code class="p">:]</code>
        <code class="n">out</code><code class="p">[:,</code>  <code class="o">-</code><code class="mi">1</code><code class="p">]</code> <code class="o">+=</code> <code class="n">rollee</code><code class="p">[:,</code>  <code class="mi">0</code><code class="p">]</code>

<code class="k">def</code> <code class="nf">test_roll_add</code><code class="p">():</code>
    <code class="n">rollee</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">asarray</code><code class="p">([[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">],[</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]])</code>
    <code class="k">for</code> <code class="n">shift</code> <code class="ow">in</code> <code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">):</code>
        <code class="k">for</code> <code class="n">axis</code> <code class="ow">in</code> <code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">):</code>
            <code class="n">out</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">asarray</code><code class="p">([[</code><code class="mi">6</code><code class="p">,</code><code class="mi">3</code><code class="p">],[</code><code class="mi">9</code><code class="p">,</code><code class="mi">2</code><code class="p">]])</code>
            <code class="n">expected_result</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">roll</code><code class="p">(</code><code class="n">rollee</code><code class="p">,</code> <code class="n">shift</code><code class="p">,</code> <code class="n">axis</code><code class="o">=</code><code class="n">axis</code><code class="p">)</code> <code class="o">+</code> <code class="n">out</code>
            <code class="n">roll_add</code><code class="p">(</code><code class="n">rollee</code><code class="p">,</code> <code class="n">shift</code><code class="p">,</code> <code class="n">axis</code><code class="p">,</code> <code class="n">out</code><code class="p">)</code>
            <code class="k">assert</code> <code class="n">np</code><code class="o">.</code><code class="n">all</code><code class="p">(</code><code class="n">expected_result</code> <code class="o">==</code> <code class="n">out</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">):</code>
    <code class="n">np</code><code class="o">.</code><code class="n">copyto</code><code class="p">(</code><code class="n">out</code><code class="p">,</code> <code class="n">grid</code><code class="p">)</code>
    <code class="n">out</code> <code class="o">*=</code> <code class="o">-</code><code class="mi">4</code>
    <code class="n">roll_add</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="n">out</code><code class="p">)</code>
    <code class="n">roll_add</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="n">out</code><code class="p">)</code>
    <code class="n">roll_add</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="n">out</code><code class="p">)</code>
    <code class="n">roll_add</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="n">out</code><code class="p">)</code></pre></div></div><p>If we look at the performance counters in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory2_perf">Example&nbsp;6-18</a> for this
re-write, we see that it is considerably faster than <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a>
(70% faster) however most of the counters are about the same.  The number of
page faults went down, but not by 70%.  Similarly, cache-misses and
cache-references went down, but not enough to account for the entire speedup.
One of the most important metrics here is the <code class="literal">instructions</code> metric.</p><p>The <code class="literal">instructions</code> metric counts how many CPU instructions had to be issued to
run the program.  In other words, how many things the CPU had to do.  Somehow,
the change to the customized <code class="literal">roll_add</code> function reduced the total number of
instructions necessary by about 2.86x.  This is because instead of having to rely
on the entire machinery of numpy to roll our matrix, we are able to create
shorter and simpler machinery that can take advantages of assumptions on our
data (namely that our data is 2 dimensional and we will only ever be rolling by
1).  This theme of trimming out unnecessary machinery in both numpy and python
in general will continue in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython">Cython</a>.</p><div class="example"><a id="matrix_numpy_memory2_perf"></a><div class="example-title">Example&nbsp;6-18.&nbsp;Performance metrics for numpy with inplace memory operations and custom laplace function</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>perf stat -e cycles,stalled-cycles-frontend,stalled-cycles-backend,instructions,<code class="se">\</code>
    cache-references,cache-misses,branches,branch-misses,task-clock,faults,minor-faults,<code class="se">\</code>
    cs,migrations -r 3 python diffusion_numpy_memory2.py

 Performance counter stats <code class="k">for</code> <code class="s1">'python diffusion_numpy_memory2.py'</code> <code class="o">(</code>3 runs<code class="o">)</code>:

     4,303,799,244 cycles                    <code class="c">#    3.108 GHz                      ( +-  0.32% )</code>
     2,814,678,053 stalled-cycles-frontend   <code class="c">#   65.40% frontend cycles idle     ( +-  0.49% )</code>
     1,635,172,736 stalled-cycles-backend    <code class="c">#   37.99% backend  cycles idle     ( +-  0.63% )</code>
     4,631,882,411 instructions              <code class="c">#    1.08  insns per cycle</code>
                                             <code class="c">#    0.61  stalled cycles per insn  ( +-  0.00% )</code>
       272,151,957 cache-references          <code class="c">#  196.563 M/sec                    ( +-  0.57% )</code>
         2,835,948 cache-misses              <code class="c">#    1.042 % of all cache refs      ( +-  2.45% )</code>
       621,565,054 branches                  <code class="c">#  448.928 M/sec                    ( +-  0.01% )</code>
         2,905,879 branch-misses             <code class="c">#    0.47% of all branches          ( +-  0.63% )</code>
       1384.555494 task-clock                <code class="c">#    0.999 CPUs utilized            ( +-  7.82% )</code>
             5,559 page-faults               <code class="c">#    0.004 M/sec                    ( +-  0.01% )</code>
             5,559 minor-faults              <code class="c">#    0.004 M/sec                    ( +-  0.01% )</code>
                 6 context-switches          <code class="c">#    0.004 K/sec                    ( +- 19.25% )</code>
                 3 CPU-migrations            <code class="c">#    0.002 K/sec                    ( +- 85.44% )</code>

       1.386148918 seconds <code class="nb">time </code>elapsed                                          <code class="o">(</code> +-  7.83% <code class="o">)</code></pre></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_numexpr_making_inplace_operations_faster_and_easier">numexpr: making inplace operations faster and easier</h2></div></div></div><p>One downfall of numpy’s optimization of vector operations is that it only occurs
on one operation at a time.  That is to say, when doing the operation <code class="literal">A*B + C</code>
with numpy vectors, first the entire <code class="literal">A*B</code> operation completes, the data is
stored in a temporary vector, then this new vector is added with <code class="literal">C</code>.  The
in-place version of the diffusion code in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a> shows this
quite explicitly.</p><p>However, there are many modules that can help with this.  <code class="literal">numexpr</code> is a module
that can take an entire vector expression and compile it into very efficient
code that is optimized to minimize cache misses and temporary space used.  In
addition the expressions can utilize multiple CPU cores (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html">Chapter&nbsp;9</a>
for more information) and specialized instructions for Intel chips to maximize
the speedup.</p><p>It is very easy to change code to use <code class="literal">numexpr</code>: all it takes are expressions
written as strings with references to local variables.  The expression is
compiled behind the scenes (and cached so that calls to the same expression
don’t incur the same cost of compilation) and run using optimized code.
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_numexpr">Example&nbsp;6-19</a> shows the simplicity of changing the <code class="literal">evolve</code> function
to use <code class="literal">numexpr</code>.  In that case, we chose to use the <code class="literal">out</code> parameter of the
<code class="literal">evaluate</code> function so that <code class="literal">numexpr</code> doesn’t allocate a new vector to return
the result of the calculation to.</p><div class="example"><a id="matrix_numpy_numexpr"></a><div class="example-title">Example&nbsp;6-19.&nbsp;Using numexpr to further optimize large matrix operations</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">numexpr</code> <code class="kn">import</code> <code class="n">evaluate</code>

<code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">scratch</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mi">1</code><code class="p">):</code>
    <code class="n">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code><code class="p">)</code>
    <code class="n">evaluate</code><code class="p">(</code><code class="s">"scratch*D*dt+grid"</code><code class="p">,</code> <code class="n">out</code><code class="o">=</code><code class="n">scratch</code><code class="p">)</code></pre></div></div><p>An important feature of <code class="literal">numexpr</code> is its consideration of CPU caches.  It
specifically moves data around so that the various CPU caches have the correct
data in order to minimize cache misses.  When we run <code class="literal">perf</code> on the updated code
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_numexpr_perf">Example&nbsp;6-20</a>), we see a speedup.  However, if we look at the
performance on a smaller, 512x512, grid (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_figure_all_perf">Figure&nbsp;6-4</a>) we see a
~15% decrease in speed.  Why is this?</p><div class="example"><a id="matrix_numpy_numexpr_perf"></a><div class="example-title">Example&nbsp;6-20.&nbsp;Performance metrics for numpy with inplace memory operations, custom laplace function and numexpr</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>perf stat -e cycles,stalled-cycles-frontend,stalled-cycles-backend,instructions,<code class="se">\</code>
    cache-references,cache-misses,branches,branch-misses,task-clock,faults,minor-faults,<code class="se">\</code>
    cs,migrations -r 3 python diffusion_numpy_memory2_numexpr.py

 Performance counter stats <code class="k">for</code> <code class="s1">'python diffusion_numpy_memory2_numexpr.py'</code> <code class="o">(</code>3 runs<code class="o">)</code>:

     5,940,414,581 cycles                    <code class="c">#    1.447 GHz                      ( +-  0.48% )</code>
     3,706,635,857 stalled-cycles-frontend   <code class="c">#   62.40% frontend cycles idle     ( +-  0.73% )</code>
     2,321,606,960 stalled-cycles-backend    <code class="c">#   39.08% backend  cycles idle     ( +-  0.93% )</code>
     6,909,546,082 instructions              <code class="c">#    1.16  insns per cycle</code>
                                             <code class="c">#    0.54  stalled cycles per insn  ( +-  0.01% )</code>
       261,136,786 cache-references          <code class="c">#   63.628 M/sec                    ( +-  0.64% )</code>
        11,623,783 cache-misses              <code class="c">#    4.451 % of all cache refs      ( +-  8.54% )</code>
       627,319,686 branches                  <code class="c">#  152.851 M/sec                    ( +-  0.03% )</code>
         8,443,876 branch-misses             <code class="c">#    1.35% of all branches          ( +-  3.24% )</code>
       4104.127507 task-clock                <code class="c">#    1.364 CPUs utilized            ( +-  4.04% )</code>
             9,786 page-faults               <code class="c">#    0.002 M/sec                    ( +-  0.01% )</code>
             9,786 minor-faults              <code class="c">#    0.002 M/sec                    ( +-  0.01% )</code>
             8,701 context-switches          <code class="c">#    0.002 M/sec                    ( +-  1.11% )</code>
                60 CPU-migrations            <code class="c">#    0.015 K/sec                    ( +- 15.26% )</code>

       3.009811418 seconds <code class="nb">time </code>elapsed                                          <code class="o">(</code> +-  3.86% <code class="o">)</code></pre></div></div><p>Much of the extra machinery we are bringing into our program with ‘numexpr`
deals with cache considerations.  When our grid size is small and all the data
we need for our calculation fits in cache, this extra machinery simply adds
extra instructions that don’t help performance.  In addition, compiling the
vector operation that we encoded as a string adds a large overhead.  When the
total runtime of the program is small, this overhead can be quite noticeable.
However, as we increase the grid size, we should expect to see <code class="literal">numexpr</code> better
utilize our cache than native numpy.  In addition, <code class="literal">numexpr</code> utilizes multiple
cores to do its calculation and tried so saturate each of the cores’ cache.
When the size of the grid is small, the extra overhead of managing the multiple
cores overwhelms any possible increase in speed.</p><p>The particular computer we are running the code on has a 20480 KB cache (Intel®
Xeon® E5-2680).  Since we are operating on two arrays, one for input and one for
output, we can easily do the calculation for the size of the grid that will fill
up our cache.  The number of grid elements we can store in total is <code class="literal">20480KB /
64bit = 2,560,000</code>.  Since we have two grids, this number is split between two
objects (so each one can be at most <code class="literal">2,560,000 / 2 = 1,280,000</code> elements.
Finally, taking the square root of this number gives us the size of the grid
that uses that many grid elements.  All in all, this means that approximately
two 2D arrays of size 1131x1131 would fill up the cache
(<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0605.png" alt="" width="300" height="26" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0605.png"></span>).  In practice however, we do
not get to fill up the cache ourselves (other programs will fill up parts of the
cache), so realistically we can probably fit two 800x800 vectors.  Looking at
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_table_all_perf">Table&nbsp;6-1</a> we see that when the grid size jumps from 512x512 to
1024x1024, the <code class="literal">numexpr</code> code starts to outperform pure numpy.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_a_cautionary_tale_verify_optimizations_scipy">A Cautionary Tale: Verify “optimizations” (scipy)</h2></div></div></div><p>An important thing to take away from this chapter is the approach we took to
every optimization: profile to the code to get a sense of what is going on, come
up with a possible solution to fix slow parts, profile to make sure the fix
actually worked.  Although this sounds straight forward, things can get
complicated quickly as we saw with how the performance of <code class="literal">numexpr</code> depended
greatly on the size of the grid we are considering.</p><p>However, this doesn’t always work as expected.  While writing the code for this
chapter, this author saw that the <code class="literal">laplacian</code> function was the slowest routine
and hypothesised that the <code class="literal">scipy</code> routine would be considerably faster.  This
thinking came from the fact that laplacians are a common operation in image
analysis and probably have a very optimized library to speed up the calls.
Scipy has an image submodule, so we must be in luck!</p><div class="example"><a id="matrix_numpy_scipy"></a><div class="example-title">Example&nbsp;6-21.&nbsp;Using scipy’s laplace filter</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">scipy.ndimage.filters</code> <code class="kn">import</code> <code class="n">laplace</code>

<code class="k">def</code> <code class="nf">laplacian</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">):</code>
    <code class="n">laplace</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">,</code> <code class="n">mode</code><code class="o">=</code><code class="s">'wrap'</code><code class="p">)</code></pre></div></div><p>The implementation was quite simple (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_scipy">Example&nbsp;6-21</a>) and required little
thought about the intricacies of implementing the periodic boundary conditions
(or “wrap” condition as scipy calls it).  Ease of implementation is quite
important and definitely won this method some points before considering
performance.  However once we benchmark the scipy code we get the revelation:
this method has no substantial speedup compared to the code it was based off of
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a>).  In fact, as we increase the grid size, this method
starts performing worse (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_figure_all_perf">Figure&nbsp;6-4</a>).</p><div class="example"><a id="matrix_numpy_scipy_perf"></a><div class="example-title">Example&nbsp;6-22.&nbsp;Performance Metrics for diffusion with scipy’s laplace function</div><div class="example-contents"><pre class="programlisting"><code class="nv">$ </code>perf stat -e cycles,stalled-cycles-frontend,stalled-cycles-backend,instructions,<code class="se">\</code>
    cache-references,cache-misses,branches,branch-misses,task-clock,faults,minor-faults,<code class="se">\</code>
    cs,migrations -r 3 python diffusion_scipy.py

 Performance counter stats <code class="k">for</code> <code class="s1">'python diffusion_scipy.py'</code> <code class="o">(</code>3 runs<code class="o">)</code>:

     6,573,168,470 cycles                    <code class="c">#    2.929 GHz                      ( +-  0.11% )</code>
     3,574,258,872 stalled-cycles-frontend   <code class="c">#   54.38% frontend cycles idle     ( +-  0.21% )</code>
     2,357,614,687 stalled-cycles-backend    <code class="c">#   35.87% backend  cycles idle     ( +-  0.26% )</code>
     9,850,025,585 instructions              <code class="c">#    1.50  insns per cycle</code>
                                             <code class="c">#    0.36  stalled cycles per insn  ( +-  0.01% )</code>
       415,930,123 cache-references          <code class="c">#  185.361 M/sec                    ( +-  0.24% )</code>
         3,188,390 cache-misses              <code class="c">#    0.767 % of all cache refs      ( +-  1.75% )</code>
     1,608,887,891 branches                  <code class="c">#  717.006 M/sec                    ( +-  0.01% )</code>
         4,017,205 branch-misses             <code class="c">#    0.25% of all branches          ( +-  0.40% )</code>
       2243.897843 task-clock                <code class="c">#    0.994 CPUs utilized            ( +-  9.26% )</code>
             7,319 page-faults               <code class="c">#    0.003 M/sec</code>
             7,319 minor-faults              <code class="c">#    0.003 M/sec                    ( +-  0.00% )</code>
                12 context-switches          <code class="c">#    0.005 K/sec                    ( +- 52.20% )</code>
                 1 CPU-migrations            <code class="c">#    0.000 K/sec                    ( +- 57.74% )</code>

       2.258396667 seconds <code class="nb">time </code>elapsed                                          <code class="o">(</code> +-  9.67% <code class="o">)</code></pre></div></div><p>Comparing the performance metrics of the scipy version of the code with that of
our custom laplacian function (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory2_perf">Example&nbsp;6-18</a>), we can start to
get some indication as to why we aren’t getting the speedup we were expecting
from this re-write.</p><p>The metrics that stand out the most are <code class="literal">page-faults</code> and <code class="literal">instructions</code>.  All
of these values are substantially large for the scipy version.  The increase
<code class="literal">page-faults</code> shows us that while the scipy laplacian function has support for
in place operations, it is still allocating a lot of memory.  In fact, the number
of page faults in the scipy version is larger than our first rewrite of the
numpy code (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1_perf">Example&nbsp;6-15</a>).</p><p>Most importantly however is the <code class="literal">instructions</code> metric.  This shows us that the
scipy code is requesting the CPU does over double the amount of work than our
custom laplacian code.  Even though these instructions are more optimized (as we
can see with the higher <code class="literal">insns per cycle</code> which says how many instructions the
CPU can do in one clock cycle) the extra optimization doesn’t win out over the
sheer number of added instructions.  This could be in part due to the fact that
the scipy code is written very generally so that it can process all sorts of
inputs with different boundary conditions which requires extra code and thus
more instructions.  We can see this in fact by the high number of <code class="literal">branches</code>
that the scipy code requires.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_wrap_up_4">Wrap Up</h2></div></div></div><p>Looking back on our optimizations there seems to be two main routes we took:
reducing the time to get data to the CPU and reducing the amount of work that
the CPU had to do.  <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_figure_all_perf">Figure&nbsp;6-4</a> shows how all of these methods
compared to each other and we can see the three bands of performance that
correspond to these two methods:  the lower band coming from our pure python
implementation, the middle band coming from our reduction of allocations and the
third band coming from reducing the work done by our process.</p><div class="figure"><a id="matrix_figure_all_perf"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 432; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/matrix_method_speed.png" alt="Summary of speedups from the methods attempted in this chapter" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/matrix_method_speed.png"></div></div><div class="figure-title">Figure&nbsp;6-4.&nbsp;Summary of speedups from the methods attempted in this chapter</div></div><p>Some things to take away from this is that you should always take care of any
administrative things the code must do during initialization.  This would
involve allocating memory, or reading configuration from a file, or even
pre computing some values that will be needed throughout the lifetime of the
program.  This is important for two reasons—first you are reducing the total
number of times this must happen by doing it once beforehand and knowing that
you can use those resources without too much penalty in the future.  Secondly,
you are not disrupting the flow of the program and allowing it to pipeline more
efficiently and keep the caches filled with more pertinent data.</p><p>We also learned more about the importance of data locality and how important
simply getting data to the CPU is.  CPU caches can be quite complicated and
often times it is best to allow the various mechanisms designed to optimize them
take care of the issue.  However, understanding what is happening and doing all
that is possible to optimize how memory is taken care of can make all the
difference.  For example, by understanding how caches work we are able to
understand that the decrease in performance that leads to a saturated speedup no
matter the grid size in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_figure_all_perf">Figure&nbsp;6-4</a> can probably be attributed to
the L3 cache being filled up by our grid.  This means that we start not
benefiting from the tiered memory approach to solving the Von Neumann
bottleneck.</p><p>Another important lesson is the use of external libraries.  Python is fantastic
for its fast development, ease of use and readability which allows you to write
and debug code faster, but to tune performance down to the CPU external
libraries are essential.  These external libraries can be extremely fast,
because they can be written in lower level languages, but still since they
interface with python you can also still write code fast.</p><p>Finally, we learned the importance of benchmarking everything and forming
hypothesis about performance before running the experiment.  By forming a
hypothesis before running the benchmark we are able to form conditions to tell
us whether our optimization actually worked.  Was this change able to speedup
runtime?  Did it reduce the number of allocations?  Are the number of cache
misses lower?  Optimizations can be an art at times because of the vast
complexity of computer systems so having a quantitative probe into what is
actually happening can help enormously.</p><p>Lastly, we realize how much of an art this sort of optimization can be.  As a
result, a lot of care must be taken care of to make sure that the optimizations
generalize to different computers (the assumptions and benchmarks you do may be
dependant on the architecture of the computer you are running on, how the
modules you are using were compiled, etc).  In addition, when making these
optimizations it is incredibly important to consider other developers and how
the changes will effect the readability of your code.  For example, in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory2">Example&nbsp;6-17</a> we realized that it would take a potentially vague
solution so care was taken to make sure that the code was fully documented and
tested to not only help us, but also help other people in the team.</p><div class="table"><a id="matrix_table_all_perf"></a><div class="table-title">Table&nbsp;6-1.&nbsp;Performance of all schemes for various dataset sizes</div><div class="table-contents"><table style="width: 40%; border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"><col class="col_8"><col class="col_9"><col class="col_10"><col class="col_11"><col class="col_12"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Method                                                </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " colspan="2">256x256          </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " colspan="2"> 512x512         </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " colspan="2"> 1024x1024       </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " colspan="2"> 2048x2048       </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " colspan="2"> 4096x4096         </td><td style="border-bottom: 0.5pt solid ; ">&nbsp;</td></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>runtime</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>speedup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>runtime</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>speedup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>runtime</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>speedup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>runtime</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>speedup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>runtime</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>speedup</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_run">python</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2.32s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.00x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>9.49s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.00x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>39.00s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.00x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>155.02s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.00x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>617.35s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.00x</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_pure_python_memory">python+memory</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2.56s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.90x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>10.26s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.93x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>40.87s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.95x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>162.88s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.95x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>650.26s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.95x</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_naive">numpy</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.07s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>32.33x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.28s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>33.56x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1.61s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>24.25x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>11.28s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>13.74x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>45.47s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>13.58x</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">numpy+memory</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.05s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>42.63x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.22s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>42.75x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1.05s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>37.13x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>6.95s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>22.30x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>28.14s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>21.94x</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory2">numpy+memory+laplace</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.03s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>77.98x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.12s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>78.91x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.53s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>73.90x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2.68s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>57.90x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>10.57s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>58.43x</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_numexpr">numpy+memory+laplace+numexpr</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.04s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>65.01x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.13s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>74.27x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.50s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>78.27x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2.42s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>64.18x</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>9.54s</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>64.75x</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><a class="link" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_scipy">numpy+memory+scipy</a></p></td><td style="border-right: 0.5pt solid ; "><p>0.05s</p></td><td style="border-right: 0.5pt solid ; "><p>42.43x</p></td><td style="border-right: 0.5pt solid ; "><p>0.19s</p></td><td style="border-right: 0.5pt solid ; "><p>51.28x</p></td><td style="border-right: 0.5pt solid ; "><p>1.22s</p></td><td style="border-right: 0.5pt solid ; "><p>32.09x</p></td><td style="border-right: 0.5pt solid ; "><p>6.06s</p></td><td style="border-right: 0.5pt solid ; "><p>25.58x</p></td><td style="border-right: 0.5pt solid ; "><p>30.31s</p></td><td style="border-right: 0.5pt solid ; "><p>20.37x</p></td><td><p></p></td></tr></tbody></table></div></div><p>In the next chapter we will talk about how to create your
own external modules that can be finely tuned to solve specific problems with
much greater efficiencies.  This allows us to follow the rapid prototyping
method of making our programs—first solve the problem with slow code,
identify the elements which are slow, find ways to make those elements faster.
By profiling often and only trying to optimize sections of code we <span class="emphasis"><em>know</em></span> are
slow, we can save ourselves time while still making our programs run as fast as
possible.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" epub:type="footnote" id="ftn.matrix_numpy_novec"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_novec" class="simpara">14</a>] </sup>This is done by compiling numpy with the <code class="literal">-O0</code> flag.  For this experiment we built numpy 1.8.0 with: <code class="literal">$ OPT='-O0' FOPT='-O0'
BLAS=None LAPACK=None ATLAS=None python setup.py build</code></p></div><div class="footnote" epub:type="footnote" id="ftn.matrix_cpu_warning"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_cpu_warning" class="simpara">15</a>] </sup>This is very contingent on what CPU is being used.</p></div><div class="footnote" epub:type="footnote" id="ftn.id609491"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#id609491" class="simpara">16</a>] </sup>This is not strictly true since two numpy
arrays can reference the same section of memory but use different striding
information in order to represent the same data in different ways.  These two
numpy arrays will have different id’s.  There are many subtleties to the id
structure of numpy arrays which are out of scope of this discussion.</p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch05.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">5. Iterators and Generators</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch07.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">7. Compiling to C</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch06.html" data-for-analytics="9781449361747:ch06.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

<div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#">Reset</a>
</div>
</div>


    

    
    
  

<div class="annotator-notice"></div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch07.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch07.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch07.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch07.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>7. Compiling to C - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch07.html"><meta name="description" content="Chapter&nbsp;7.&nbsp;Compiling to C Questions you’ll be able to answer after this chapter How can I have my python code run as lower level code? What is the ... "><meta property="og:title" content="7. Compiling to C"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="7. Compiling to C"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;7.&nbsp;Compiling to C Questions you’ll be able to answer after this chapter How can I have my python code run as lower level code? What is the ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch07.html" data-for-analytics="9781449361747:ch07.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%207.%20Compiling%20to%20C&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch06.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">6. Matrix and Vector Computation</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch08.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">8. Concurrency</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-compiling"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;7.&nbsp;Compiling to C</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
How can I have my python code run as lower level code?
</li><li class="listitem">
What is the difference between a JIT and a compiler?
</li><li class="listitem">
What tasks are compiled python code faster at than native python?
</li><li class="listitem">
Why do type annotations speed up compiled python code?
</li><li class="listitem">
How can I write modules for python using C or Fortran?
</li><li class="listitem">
How can I use libraries from C or Fortran in python?
</li></ul></div></div><p>The easiest way to get your code to run faster is to make it do less work.
Assuming you’ve already chosen good algorithms and you’ve reduced the amount of
data you’re processing the easiest way to execute fewer instructions is to
compile your code down to machine code.</p><p>Python offers a number of options including pure C-based compiling approaches
like Cython, ShedSkin and Pythran, LLVM-based compiling via Numba and the
replacement virtual machine PyPy which includes a built-in Just In Time
compiler. You need to balance the requirements of code adaptability and team
velocity when deciding which route to take.</p><p>Each of these tools add a new dependency to your tool-chain and additionally Cython requires you to write in a new language type (a hybrid of Python with C) which means you need a new skill. Cython’s new language may hurt your team’s velocity as team members without knowledge of C may have trouble supporting this code, in practice this is probably a small concern as you’ll only use Cython in well-chosen small regions of your code.</p><p>It it worth noting that by performing CPU and memory profiling on your code you’ll probably start thinking about higher-level algorithmic optimizations that you might apply. These algorithmic changes could help avoid doing unnecessary work (e.g. additional logic to avoid computations or caching to avoid re-calculation) - Python’s expressivity helps you to spot these algorithmic opportunities. Radim Řehůřek discusses how a Python implementation can beat a pure C implementation in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-radim">Making deep learning fly with RadimRehurek.com</a>.</p><p>In this chapter we’ll review:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Cython - this is the most commonly used tool for compiling to C covering both <code class="literal">numpy</code> and normal Python code, it requires some knowledge of C
</li><li class="listitem">
Shed Skin - an automatic Python to C converter for non-<code class="literal">numpy</code> code
</li><li class="listitem">
Numba - a new compiler specialized to <code class="literal">numpy</code> code
</li><li class="listitem">
Pythran - a new compiler for both <code class="literal">numpy</code> and non-<code class="literal">numpy</code> code
</li><li class="listitem">
PyPy - a stable Just in Time compiler for non-<code class="literal">numpy</code> code that is a replacement for the normal Python executable
</li></ul></div><p>Later in this chapter Micha looks at Foreign Function Interfaces allowing C code to be compiled into extension modules for Python. Python’s native API is used along with <code class="literal">ctypes</code> and <code class="literal">CFFI</code> (from the authors of PyPy), along with the <code class="literal">f2py</code> Fortran-to-Python converter.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_what_sort_of_speed_gains_are_possible">What sort of speed gains are possible?</h2></div></div></div><p>Gains of an order or magnitude or more are quite possible if your problem yields
to a compiled approach. Here we look at various ways to achieve 1-2 orders of
magnitude speed-up on a single core along with using multiple cores through
OpenMP.</p><p>Python code that tends to run faster after compiling is probably mathematical
and it probably has lots of loops that repeat the same operations many times. Inside these loops you’re probably making lots of temporary objects.</p><p>Code that calls out to external libraries (e.g. regular expressions, string
operations, calls to database libraries) is unlikely to show any speed-up after
compiling. Programs that are I/O bound are also unlikely to show significant speed-ups.</p><p>If your Python code focuses on calling vectorized <code class="literal">numpy</code> routines then it may not run any faster after compilation - it’ll only run faster if the code being compiled is mainly Python (and probably if it is mainly looping). In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a> we look at <code class="literal">numpy</code> operations, there aren’t many intermediate objects so compiling wouldn’t help.</p><p>Overall it is very unlikely that your compiled code will run any faster than a hand-crafted C routine but it is also unlikely to run much slower. It is quite possible that the generated C code from your Python will run as fast as a hand-written C routine unless the C coder has particularly good knowledge of ways to tune the C code to the target machine’s architecture.</p><p>For math-focused code it is possible that a hand-coded Fortran routine will beat an equivalent C routine but again this probably requires expert-level knowledge. Overall a compiled result (probably using Cython, Pythran or Shed Skin) will be as close to a hand-coded-in-C result as most programmers will need.</p><p>Keep the diagram in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-diminishing-returns">Figure&nbsp;7-1</a> in mind when you profile and work on your algorithm. A small amount of work understanding your code through profiling should enable you to make smarter choices at an algorithmic level. After this some focused work with a compiler or JIT should buy you an additional speed-up. After this it is probably possible to keep tweaking your algorithm but don’t be surprised to see increasingly small improvements coming from increasingly large amounts of work on your part. Know when additional effort probably isn’t useful.</p><div class="figure"><a id="FIG-04b-diminishing-returns"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 432; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_diminishing_returns.png" alt="" width="1000" height="730" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_diminishing_returns.png"></div></div><div class="figure-title">Figure&nbsp;7-1.&nbsp;Some effort profiling and compiling brings a lot of reward, continued effort tends to pay increasingly less.</div></div><p>If you’re dealing with Python code and the batteries included libraries, without
<code class="literal">numpy</code>, then Cython, ShedSkin and PyPy are your main choices. If you’re working
with <code class="literal">numpy</code> then Cython, Numba and Pythran are the right choices. These tools
all support Python 2.7, some support Python 3.2+.</p><p>Some of the following examples require a little understanding of C compilers and
C code. If you lack this knowledge then you should learn a little C and compile
a working C program before diving in too deeply.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="jit_vs_compiler">JITs vs Compilers</h2></div></div></div><p>The tools we’ll look at roughly split into two sets - compiling ahead of time
(Cython, ShedSkin, Pythran) and compiling Just In Time (Numba, PyPy).</p><p>By compiling ahead of time you create a static library that’s specialized to
your machine. If you download <code class="literal">numpy</code>, <code class="literal">scipy</code> or <code class="literal">scikit-learn</code> then it’ll
either compile parts of the library using Cython on your machine (or you’ll use
a pre-built compiled library if you’re using a distribution like Continuum’s
Anaconda). By compiling ahead of use you’ll have a library that can instantly be
used to work on solving your problem.</p><p>By compiling Just In Time you don’t have to do much (if any) work up-front, you
let the compiler step in to compile just the right parts of the code at the time
of use. This means you have a “cold start” problem - if most of your program
could be compiled and currently none of it is, as soon as you start running your
code it’ll run very slowly whilst it compiles. If this happens every time you
run a script and you run the script many times, this cost can become
significant. PyPy suffers from this so you may not want to use it for short but
frequently running scripts.</p><p>The current state of affairs shows us that compiling ahead of time buys us the
best speed-ups and often this requires the most manual effort. Just In Time
compiling offers some impressive speed-ups with very little manual intervention.
You’ll have to consider these trade-offs when choosing the right technology for
your problem.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_why_does_type_information_help_the_code_run_faster">Why does type information help the code run faster?</h2></div></div></div><p>Python is dynamically typed - a variable could refer to an object of any type,
and any line of code could change the type of the object that is referred to.
This makes it difficult for the virtual machine to opimize how the code is
executed at the machine code level as it doesn’t know which fundamental datatype
will be used for future operations. By keeping the code generic it will run more
slowly.</p><p>In the following example <code class="literal">v</code> is either a floating point number or a pair of
floating point numbers that represent a <code class="literal">complex</code> number, this could occur in
the same loop at different points of time or in related serial sections of code:</p><pre class="programlisting"><code class="n">v</code> <code class="o">=</code> <code class="o">-</code><code class="mf">1.0</code>
<code class="k">print</code> <code class="nb">type</code><code class="p">(</code><code class="n">v</code><code class="p">),</code> <code class="nb">abs</code><code class="p">(</code><code class="n">v</code><code class="p">)</code></pre><pre class="screen">&lt;type 'float'&gt; 1.0</pre><pre class="programlisting"><code class="n">v</code> <code class="o">=</code> <code class="mi">1</code><code class="o">-</code><code class="mi">1j</code>
<code class="k">print</code> <code class="nb">type</code><code class="p">(</code><code class="n">v</code><code class="p">),</code> <code class="nb">abs</code><code class="p">(</code><code class="n">v</code><code class="p">)</code></pre><pre class="screen">&lt;type 'complex'&gt; 1.41421356237</pre><p>The <code class="literal">abs</code> function works differently depending on the underlying datatype. <code class="literal">abs</code>
for an integer or a floating point number simply results in turning a negative
    value into a positive value. <code class="literal">abs</code> for a complex number involves taking the
    square root of the sum of the squared components:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0701.png" alt="" width="264" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0701.png"></span></p><p>The machine code for the <code class="literal">complex</code> example involves more instructions and will
take longer to run. Before calling <code class="literal">abs</code> on a variable Python first has to
lookup the type of the variable and then decide which version of a function to
call - this overhead adds up when you make a lot of repeated calls.</p><p>Inside Python every fundamental object like an integer will be wrapped up in a
higher level Python object (e.g. an <code class="literal">int</code> for an integer). The higher level
object has extra functions like <code class="literal">__hash__</code> to assist with storage and <code class="literal">__str__</code>
for printing.</p><p>Inside a section of code that is CPU bound it is often the case that the types
of variables do not change. This gives us an opportunity for static compilation
and faster code execution.</p><p>If all we want are a lot of intermediate mathematical operations then we don’t
need the higher level functions, we may not need the machinery for reference
counting either. We can drop down to the machine code level and do our
calculations quickly using machine code and bytes, rather than manipulating the
higher level Python objects which involves greater overhead. To do this we
determine the types of our objects ahead of time so we can generate the correct
C code.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_using_a_c_compiler">Using a C compiler</h2></div></div></div><p>In the following examples I’ll use <code class="literal">gcc</code> and <code class="literal">g++</code> from the GNU C Compiler
toolset. You could use an alternative compiler (e.g. Intel’s <code class="literal">icc</code> or
Microsoft’s <code class="literal">cl</code>) if you configure your environment correctly. Cython uses
<code class="literal">gcc</code>, Shed Skin uses <code class="literal">g++</code>.</p><p><code class="literal">gcc</code> is a very good choice for most platforms, it is well supported and quite
advanced. It is often possible to squeeze out more performance using a tuned
compiler (e.g. Intel’s <code class="literal">icc</code> may produce faster code than <code class="literal">gcc</code> on Intel
devices), the cost is that you have to gain some more domain knowledge and learn
how to tune the flags on the alternative compiler.</p><p>C and C++ are often used for static compilation rather than other languages like
Fortran due to their ubiquity and the wide range of supporting libraries. The
compiler and the converter (Cython etc. are the converters in this case) have an
opportunity to study the annotated code to determine if static optimization
steps (like inlining functions and unrolling loops) can be applied. Aggressive
analysis of the intermediate abstract syntax tree (performed by Pythran, Numba
and PyPy) provides opportunities for combining knowledge of Python’s way of
expressing things to inform the underlying compiler how best to take advantage
of the patterns that have been seen.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_reviewing_the_julia_set_example">Reviewing the Julia Set example</h2></div></div></div><p>Back in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html">Chapter&nbsp;2</a> we profiled the Julia set generator.
This code uses integers and complex numbers to produce an output image. The
calculation of the image is CPU-bound.</p><p>The main cost in the code was the CPU-bound nature of the inner loop which
calculates the <code class="literal">output</code> list, this list can be drawn as a square pixel array
where each value represents the cost to generate that pixel.</p><p>The code for the inner function is shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-review-julia">Example&nbsp;7-1</a>:</p><div class="example"><a id="compiling-review-julia"></a><div class="example-title">Example&nbsp;7-1.&nbsp;Reviewing the Julia function’s CPU-bound code</div><div class="example-contents"><pre class="screen">def calculate_z_serial_purepython(maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and abs(z) &lt; 2:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>On Ian’s laptop the original Julia set calculation on a <code class="literal">1000*1000</code> grid with
<code class="literal">maxiter=300</code> takes approximately 11 seconds using a pure Python implemention
running on CPython 2.7.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="compiling-cython">Cython</h2></div></div></div><p>Cython <sup>[<a id="id620693" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id620693" class="footnote">17</a>]</sup> is a compiler that converts type-annotated
Python into a compiled extension module, the type annotations are C-like. This
extension can be imported as a regular Python module using <code class="literal">import</code>. Getting
started is simple, it does have a learning curve that must be climbed with each
additional level of complexity and optimization. For Ian this is the tool of
choice for turning calculation-bound functions into faster code - due to its
wide usage, its maturity and because of its OpenMP support.</p><p>With the OpenMP standard it is possible to convert parallel problems into
multiprocessing-aware modules which run on multiple CPUs on one machine. The
threads are hidden from your Python code, they operate via the generated C code.</p><p>Cython (announed 2007) is a fork of Pyrex (announced 2002) which expands the
capabilities beyond the original aims of Pyrex. Libraries that use Cython
include scipy, scikit-learn, lxml and zmq.</p><p>Cython can be used via a <code class="literal">setup.py</code> script to compile a module, it can also be
used interactively in IPython via a <span class="emphasis"><em>magic</em></span> command. Typically the types are
annotated by the developer although some automated annotation is possible.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_compiling_a_pure_python_version_using_cython">Compiling a pure-Python version using Cython</h3></div></div></div><p>The easy way to begin writing a compiled extension module involves three files.
Using our Julia set as an example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
the calling Python code (the bulk of our Julia code from before)
</li><li class="listitem">
the function to be compiled in a new <code class="literal">.pyx</code> file
</li><li class="listitem">
a <code class="literal">setup.py</code> file which contains the instructions for calling Cython to make
  the extension module
</li></ul></div><p>Using the above approach the <code class="literal">setup.py</code> script is called to use Cython to
compile the <code class="literal">.pyx</code> file into a compiled module. One Unix-like systems the
compiled module will probably be a <code class="literal">.so</code> file, on Windows it should be a <code class="literal">.pyd</code>
(DLL-like Python library).</p><p>For the Julia example we’ll use:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">julia1.py</code> to build the input lists and call the calculation function
</li><li class="listitem">
<code class="literal">cythonfn.pyx</code> containing the CPU-bound function which we can annotate
</li><li class="listitem">
<code class="literal">setup.py</code> containing the build instructions
</li></ul></div><p>The result of running <code class="literal">setup.py</code> is a module which can be imported. In  our
<code class="literal">julia1.py</code> script in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-import">Example&nbsp;7-2</a>  we only need to make some tiny changes to <code class="literal">import</code> the new
module and call our function.</p><div class="example"><a id="compiling-cython-import"></a><div class="example-title">Example&nbsp;7-2.&nbsp;Importing the newly compiled module into our main code</div><div class="example-contents"><pre class="screen">...
import calculate  # as defined in setup.py
...
def calc_pure_python(desired_width, max_iterations):
    #...
    start_time = time.time()
    output = calculate.calculate_z(max_iterations, zs, cs)
    end_time = time.time()
    secs = end_time - start_time
    print "Took", secs, "seconds"
...</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-pure-python">Example&nbsp;7-3</a> we will start with a pure Python version without type annotations.</p><div class="example"><a id="compiling-cython-pure-python"></a><div class="example-title">Example&nbsp;7-3.&nbsp;Unmodified pure-Python code in cythonfn.pyx (renamed from .py) for Cython’s setup.py</div><div class="example-contents"><pre class="screen"># cythonfn.pyx
def calculate_z(maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and abs(z) &lt; 2:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>The <code class="literal">setup.py</code> script shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-setup">Example&nbsp;7-4</a> is short, it defines how to convert <code class="literal">cythonfn.pyx</code> into
<code class="literal">calculate.so</code>.</p><div class="example"><a id="compiling-cython-setup"></a><div class="example-title">Example&nbsp;7-4.&nbsp;setup.py which converts cythonfn.pyx into C code for compilation by Cython</div><div class="example-contents"><pre class="screen">from distutils.core import setup
from distutils.extension import Extension
from Cython.Distutils import build_ext

setup(
        cmdclass = {'build_ext': build_ext},
        ext_modules = [Extension("calculate", ["cythonfn.pyx"])]
        )</pre></div></div><p>When we run the <code class="literal">setup.py</code> script in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-setup-build">Example&nbsp;7-5</a> with the argument <code class="literal">build_ext</code> Cython will look
for <code class="literal">cythonfn.pyx</code> and build <code class="literal">calculate.so</code>.</p><div class="note"><h3 class="title">Note</h3><p>Remember that this is a manual step - if you update your <code class="literal">.pyx</code> or <code class="literal">setup.py</code> and forget to re-run the build command, you won’t have an updated <code class="literal">.so</code> module to import. If you’re unsure whether you compiled the code then check the timestamp for the <code class="literal">.so</code> file. If in doubt - delete the generated C files and the <code class="literal">.so</code> file and build them again.</p></div><div class="example"><a id="compiling-cython-setup-build"></a><div class="example-title">Example&nbsp;7-5.&nbsp;Running setup.py to build a new compiled module</div><div class="example-contents"><pre class="screen">$ python setup.py build_ext --inplace
running build_ext
cythoning cythonfn.pyx to cythonfn.c
building 'calculate' extension
gcc -pthread -fno-strict-aliasing -DNDEBUG -g -fwrapv -O2 -Wall
    -Wstrict-prototypes -fPIC -I/usr/include/python2.7 -c cythonfn.c
    -o build/temp.linux-x86_64-2.7/cythonfn.o
gcc -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,
    -Bsymbolic-functions -Wl,-z,
    relro build/temp.linux-x86_64-2.7/cythonfn.o -o calculate.so</pre></div></div><p>The <code class="literal">--inplace</code> argument tells Cython to build the compiled module into the
current directory rather than into a separate <code class="literal">build</code> directory. After the build
has completed we’ll have the intermediate <code class="literal">cythonfn.c</code> which is rather hard to
read along with <code class="literal">calculate.so</code>.</p><p>Now when the <code class="literal">julia1.py</code> code is run the compiled module is imported and the
Julia set is calculated on Ian’s laptop in 8.9 seconds rather than the more
usual 11 seconds. This is a small improvement for very little effort.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_cython_annotations_to_analyse_a_block_of_code">Cython annotations to analyse a block of code</h3></div></div></div><p>The above example shows that we can quickly build a compiled module. For tight
loops and mathematical operations this alone often leads to a speed-up.
Obviously we should not opimize blindly - we need to know what is slow so we can
decide where to focus our efforts.</p><p>Cython has an annotation option that will output an HTML file which we can view
in a browser. To generate the annotation we use <code class="literal">$ cython -a cythonfn.pyx</code> and
the output file <code class="literal">cythonfn.html</code> is generated. Viewed in a browser we see
something like the following in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-1">Figure&nbsp;7-2</a>.</p><div class="figure"><a id="FIG-04b-cython-lists-1"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_1.png" alt="" width="558" height="266" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_1.png"></div></div><div class="figure-title">Figure&nbsp;7-2.&nbsp;Colored Cython output of unannotated function.</div></div><p>Each line can be expanded with a double click to show the generated C code. More yellow
means “more calls into the Python virtual machine” whilst more white means “more non-Python C code”.
The goal is to remove as many of the yellow lines as possible and to end up with
as much white as possible.</p><p>Although “more yellow lines” means more calls into the virtual machine, this won’t necessarily cause your code to run slower. Each call into the VM has a cost, the cost will only be significant if the calls occur inside large loops. Calls outside of large loops (e.g. the line used to create <code class="literal">output</code> at the start of the function) are not expensive relative to the cost of the inner calculation loop. Don’t waste your time on the lines that don’t cause a slow-down.</p><p>The lines with the most calls back into the Python virtual machine (the “most yellow”) are lines 4 and 8. From our previous profiling work we know that line 8 is likely to be called over 30 million times so that’s a great candidate to focus on.</p><p>Lines 9, 10 and 11 are almost as yellow, we also know they’re inside the tight inner loop. In total they’ll be responsible for the bulk of the execution time of this function - we need to focus on these first. Refer back to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-line-profiler">line_profiler for line-by-line measurements</a> if you need to remind yourself of how much time is spent in this section.</p><p>Lines 6 and 7 are less yellow, since they’re called 1 million times they’ll have a much smaller effect on the final speed so we can focus on them later. Since they are <code class="literal">list</code> objects there’s actually nothing we can do to speed up their access except in a future section (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-and-numpy">Cython and numpy</a>) replace the <code class="literal">list</code> objects with <code class="literal">numpy</code> arrays which will buy a small speed advantage.</p><p>To understand the yellow regions you can expand each line with a double-click.
In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-1-expanded">Figure&nbsp;7-3</a> we can see that to create the <code class="literal">output</code> list we iterate over
the length of <code class="literal">zs</code> building new Python objects which are reference-counted by
the Python virtual machine. Even those these calls are expensive they won’t really affect the execution time of this function.</p><div class="figure"><a id="FIG-04b-cython-lists-1-expanded"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_1_expanded.png" alt="" width="1000" height="440" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_1_expanded.png"></div></div><div class="figure-title">Figure&nbsp;7-3.&nbsp;C code behind a line of Python code.</div></div><p>To improve the execution time of our function we need to start declaring the types of objects that are involved in the expensive inner-loops. These loops can then make fewer of the relatively expensive calls back into the Python virtual machine, saving us time.</p><p>In general the lines that probably cost the most CPU time are those:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Inside tight inner-loops
</li><li class="listitem">
Dereferencing <code class="literal">list</code>, <code class="literal">array</code> or <code class="literal">np.array</code> items
</li><li class="listitem">
Performing mathematical operations
</li></ul></div><div class="note"><h3 class="title">Note</h3><p>If you don’t know which lines are most frequently executed then use a profiling tool - <code class="literal">line_profiler</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-line-profiler">line_profiler for line-by-line measurements</a> would be the most appropriate. You’ll learn which lines are exectuted most frequencly and which lines cost the most inside the Python virtual machine so you’ll have clear evidence of which lines you need to focus on to get the best speed gain.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_adding_some_type_annotations">Adding some type annotations</h3></div></div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-1">Figure&nbsp;7-2</a> showed that almost every line of our function is calling back into the
Python virtual machine. All of our numeric work is also calling back into Python
as we are using the higher level Python objects. We need to convert these into
local C objects and then after doing our numerical coding we need to convert the
result back to a Python object.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-primitive-types">Example&nbsp;7-6</a> we can add some primitive types using the <code class="literal">cdef</code> syntax.</p><div class="note"><h3 class="title">Note</h3><p>It is important to note that these types will only be understood by Cython and
<span class="emphasis"><em>not</em></span> by Python. Cython uses these types to convert the Python code to C objects
which do not have to call back into the Python stack, so the operations run at a
faster speed but with a loss of flexibility and a loss of development speed.</p></div><p>The types we add are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">int</code> for a signed integer
</li><li class="listitem">
<code class="literal">unsigned int</code> for an integer that can only be positive
</li><li class="listitem">
<code class="literal">double complex</code> for double-precision complex numbers
</li></ul></div><p>The <code class="literal">cdef</code> keyword lets us declare variables inside the function body, these must be
declared at the top of the function as that’s a requirement from the C language specification.</p><div class="example"><a id="compiling-cython-primitive-types"></a><div class="example-title">Example&nbsp;7-6.&nbsp;Adding primitive C types to start making our compiled function run faster by doing more work in C and less via the Python virtual machine</div><div class="example-contents"><pre class="screen">def calculate_z(int maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    cdef unsigned int i, n
    cdef double complex z, c
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and abs(z) &lt; 2:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><div class="note"><h3 class="title">Note</h3><p>When adding Cython annotations you’re adding non-Python code to the <code class="literal">.pyx</code> file, this means you lose the interactive nature of developing Python in the interpreter. For those of you familiar with coding in C we go back to the code-compile-run-debug cycle.</p></div><p>You might wonder if we could add a type annotation to the lists that we pass in.
We can use the <code class="literal">list</code> keyword but practically this has no effect for this
example. The <code class="literal">list</code> objects still have to be interrogated at the Python level to
pull out their contents and this is very slow.</p><p>The act of giving types to some of the primitive objects is reflected in the
following annotated output in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-2">Figure&nbsp;7-4</a>. Critically lines 11 and 12 - two of our most frequently called lines - have now turned from yellow to white indicating that they no longer call back to the Python virtual machine. We can anticipate a great speed-up compared to the previous version.</p><p>Line 10 is called over 30 million times so we’ll still want to focus on it.</p><div class="figure"><a id="FIG-04b-cython-lists-2"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_2.png" alt="" width="552" height="293" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_2.png"></div></div><div class="figure-title">Figure&nbsp;7-4.&nbsp;Our first type annotations.</div></div><p>After compiling this version takes 4.3 seconds to complete. With only a few
changes to the function we are running at twice the speed of the original Python
version.</p><p>It is important to note that the reason we are gaining speed is because more of
the frequently-performed operations are being pushed down to the C level - in
this case the updates to <code class="literal">z</code> and <code class="literal">n</code>. This means that the C compiler can
optimize how the lower level functions are operating on the bytes that represent
these variables, without calling into the relatively slow Python virtual
machine.</p><p>We can see in the previous Cython figure that the <code class="literal">while</code> loop is still somewhat
expensive (it is yellow). The expensive call is in to Python for the <code class="literal">abs</code>
function for the complex <code class="literal">z</code>. Cython does not provide a native <code class="literal">abs</code> for complex
numbers, instead we can provide our own local expansion.</p><p>As noted before <code class="literal">abs</code> for a complex number involves taking the square root of
the sum of the squares of the real and imaginary components. In our test we want
to see if the square root of the result is less than 2. Rather than take the
square root we can instead square the other side of the comparison, so we turn
<code class="literal">&lt; 2</code> into <code class="literal">&lt; 4</code>. This avoids us having to calculate the square root as the
final part of the <code class="literal">abs</code> function.</p><p>In essence we started with:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0702.png" alt="" width="232" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0702.png"></span></p><p>and we have simplified the operation to:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0703.png" alt="" width="213" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0703.png"></span></p><p>If we retained the <code class="literal">sqrt</code> operation in the following code we still see an
improvement in execution speed. One of the secrets to optimizing code is to make
it do as little work as possible. Removing a relatively expensive operation by
considering the ultimate aim of a function means that the C compiler can focus
on what it is good at, rather than trying to intuit the programmer’s ultimate
needs.</p><p>Writing equivalent but more specialized code to solve the same problem is known as <span class="emphasis"><em>strength reduction</em></span>. You trade worse flexibility (and possibly worse readability) for faster execution.</p><p>This mathematical unwinding leads to the next example in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-expanding-abs">Example&nbsp;7-7</a> where we have replaced the
relatively expensive <code class="literal">abs</code> function with a simplified line of expanded
mathematics.</p><div class="example"><a id="augmentingwithtypes-cython-expanding-abs"></a><div class="example-title">Example&nbsp;7-7.&nbsp;Expanding the abs function using Cython</div><div class="example-contents"><pre class="screen">def calculate_z(int maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    cdef unsigned int i, n
    cdef double complex z, c
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and (z.real * z.real + z.imag * z.imag) &lt; 4:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>By annotating the code we see a small improvement in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-4">Figure&nbsp;7-5</a>
for the cost of the <code class="literal">while</code> statement on line 10. Now it involves fewer calls into the Python virtual machine. It isn’t immediately obvious how much of a speed gain we’ll get but we know that this line is called over 30 million times so we anticipate a good improvement.</p><div class="figure"><a id="FIG-04b-cython-lists-4"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 270; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_4.png" alt="" width="553" height="293" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_4.png"></div></div><div class="figure-title">Figure&nbsp;7-5.&nbsp;Expanded math to get a final win.</div></div><p>This change has a dramatic effect - by reducing the number of Python calls in
the innermost loop we greatly reduce the calculation time of the function. This new version completes in just 0.25 seconds,
an amazing speed-up on the original version by approximately 40 times.</p><p>For a final possible improvement on this piece of code we can disable bounds
checking for each dereference in the list. The goal of the bounds checking is to
ensure that the program does not access data outside of the allocated array - in
C it is easy to access out of the bounds of an arrray and this will give
unexpected results (and probably a Segmentation Fault!).</p><p>By default Cython protects the developer from accidentally addressing outside of
the list’s limits. This protection costs a little bit of CPU time, it occurs in
the outer loop of our function so in total in won’t account for much time. It is
normally safe to disable bounds checking unless you are performing your own
calculations for array addressing in which case you will have to be careful to
stay within the bounds of the list.</p><p>Cython has a set of flags that can be expressed in various ways, the easiest is
to add them as single line comments at the start of the <code class="literal">.pyx</code> file. It is also
possible to use a decorator or compile-time flag to change these settings. To
disable bounds checking we add a directive for Cython inside as comment at the
start of the <code class="literal">.pyx</code> file:</p><pre class="programlisting"><code class="c">#cython: boundscheck=False</code>
<code class="k">def</code> <code class="nf">calculate_z</code><code class="p">(</code><code class="nb">int</code> <code class="n">maxiter</code><code class="p">,</code> <code class="n">zs</code><code class="p">,</code> <code class="n">cs</code><code class="p">):</code></pre><p>As noted above the bounds checking will only save a little bit of time as it
occurs in the outer loop, not in the inner loop which is more expensive. For
this example it doesn’t save us any more time.</p><div class="note"><h3 class="title">Note</h3><p>Try disabling bounds checking and wrap-around checking if your CPU-bound code is in a loop that is dereferencing items frequently.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_shed_skin">Shed Skin</h2></div></div></div><p>Shed Skin <sup>[<a id="id645371" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id645371" class="footnote">18</a>]</sup> is an experimental
Python to C++ compiler that works with Python 2.4-2.7. It uses type inference to
<span class="emphasis"><em>automatically</em></span> inspect a Python program to annotate the types used for each
variable, this annotated code is then translated into C code for compilation
with a standard compiler like <code class="literal">g++</code>. The automatic introspection is a very
interesting feature of Shed Skin, the user only has to provide an example of how
to call the function with the right kind of data and Shed Skin will figure the
rest out.</p><p>The benefit of type inference is that the programmer does not need to explicitly
specify types by hand. The cost is that the analyzer has to be able to infer
types for every variable in the program, in the current version up to thousands
of lines of Python can be automatically converted into C. It uses the Boehm
mark-sweep garbage collector to dynamically manage memory. The Boehm GC is also
used in Mono and GNU Compiler for Java. One negative for Shed Skin is that it
uses external implementations for the standard libraries. Anything that has not
been implemented (which includes <code class="literal">numpy</code>) will not be supported.</p><p>The project has over 75 examples including many math-focused pure Python modules
and even a fully working Commodore 64 emulator. Each run significantly faster
after being compiled with Shed Skin compared to running them natively in
CPython.</p><p>Shed Skin can build stand-alone executables that don’t depend on an installed
Python installation or extension modules for use with <code class="literal">import</code> in regular Python
code.</p><p>Compiled modules manage their own memory. This means that memory from a Python
process is copied in and results are copied back - there is no explicit sharing
of memory. For large blocks of memory (e.g. a large matrix) the cost of
performing the copy may be significant, we look at this briefly towards the end
of this section.</p><p>Shed Skin provides a similar set of benefits to PyPy (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-pypy">PyPy</a>). As such PyPy might be easier to use as it doesn’t require any compilation steps. The way that Shed Skin automatically adds type annotations might be interesting to some users and the generated C may be easier to read than Cython’s generated C if you intend to modify the resulting C code. I strongly suspect that the automatic type introspection code will be of interest to other compiler writers in the community.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_building_an_extension_module">Building an extension module</h3></div></div></div><p>For this example we will build an extension module, we can <code class="literal">import</code> the
generated module just as we did with the Cython examples. We could also compile
this module into a stand-alone executable.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-shedskin-external-module">Example&nbsp;7-8</a> we have a code example in a separate module, it contains normal Python
code - note that it is not annotated in any way. Also note that we have added a
<code class="literal">__main__</code> test, this makes this module self-contained for type analysis. Shed
Skin can use this <code class="literal">__main__</code> block to infer the types that are passed into
<code class="literal">calculate_z</code> and from there infer the types used inside the CPU-bound function.</p><div class="example"><a id="compiling-shedskin-external-module"></a><div class="example-title">Example&nbsp;7-8.&nbsp;Moving our CPU-bound function to a separate module (as we did with Cython) to allow Shed Skin’s automatic type inference system to run. Note the addition of a <span class="emphasis"><em>main</em></span> block which provides example arguments that the type inferencer will use.</div><div class="example-contents"><pre class="screen"># shedskinfn.py
def calculate_z(maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and abs(z) &lt; 2:
            z = z * z + c
            n += 1
        output[i] = n
    return output


if __name__ == "__main__":
    # make a trivial example using the correct types to enable type inference
    # call the function so ShedSkin can analyze the types
    output = calculate_z(1, [0j], [0j])</pre></div></div><p>We can import this module in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-shedskin-import">Example&nbsp;7-9</a> both before it has been compiled and after in the usual way. Since the code isn’t modified (unlike with Cython) we can call the original Python module before compilation. You won’t get a speed improvement if you haven’t compiled your code but you can debug in a lightweight way using the normal Python tools.</p><div class="example"><a id="compiling-shedskin-import"></a><div class="example-title">Example&nbsp;7-9.&nbsp;Importing the external module to allow Shed Skin to compile just that module</div><div class="example-contents"><pre class="screen">...
import shedskinfn
...
def calc_pure_python(desired_width, max_iterations):
    #...
    start_time = time.time()
    output = shedskinfn.calculate_z(max_iterations, zs, cs)
    end_time = time.time()
    secs = end_time - start_time
    print "Took", secs, "seconds"
...</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-shedskin-annotations">Example&nbsp;7-10</a> we can ask Shed Skin to provide an annotated output of its analysis using
<code class="literal">shedskin -ann shedskinfn.py</code> and it generates <code class="literal">shedskinfn.ss.py</code>. We only need
to “seed” the analysis with the dummy <code class="literal">__main__</code> function if we’re compiling an
extension module:</p><div class="example"><a id="compiling-shedskin-annotations"></a><div class="example-title">Example&nbsp;7-10.&nbsp;Examining the annotated output from Shed Skin to see which types it has inferred</div><div class="example-contents"><pre class="screen"># shedskinfn.ss.py
def calculate_z(maxiter, zs, cs):        # maxiter: [int],
                                         # zs: [list(complex)],
                                         # cs: [list(complex)]
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)               # [list(int)]
    for i in range(len(zs)):             # [__iter(int)]
        n = 0                            # [int]
        z = zs[i]                        # [complex]
        c = cs[i]                        # [complex]
        while n &lt; maxiter and abs(z) &lt; 2: # [complex]
            z = z * z + c                # [complex]
            n += 1                       # [int]
        output[i] = n                    # [int]
    return output                        # [list(int)]


if __name__ == "__main__":               # []
    # make a trivial example using the correct types to enable type inference
    # call the function so ShedSkin can analyze the types
    output = calculate_z(1, [0j], [0j])  # [list(int)]</pre></div></div><p>The <code class="literal">__main__</code> types are analysed and then inside
<code class="literal">calculate_z</code> variables like <code class="literal">z</code> and <code class="literal">c</code> can be inferred from the objects they
interact with.</p><p>We compile this module using <code class="literal">shedskin --extmod shedskinfn.py</code>. The following
are generated:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">shedskinfn.hpp</code> C++ header file
</li><li class="listitem">
<code class="literal">shedskinfn.cpp</code> C++ source file
</li><li class="listitem">
<code class="literal">Makefile</code>
</li></ul></div><p>By running <code class="literal">make</code> we generate <code class="literal">shedskinfn.so</code>. We can use this in Python with
<code class="literal">import shedskinfn</code>. The execution time for <code class="literal">julia1.py</code> using <code class="literal">shedskinfn.so</code> is
0.4s - this is a huge win compared to the uncompiled version for doing very
little work.</p><p>We can also expand the <code class="literal">abs</code> function as we did with Cython in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-expanding-abs">Example&nbsp;7-7</a>. After running this version (with
just the one <code class="literal">abs</code> line being modified) and using some additional flags
<code class="literal">--nobounds --nowrap</code> we get a final execution time of 0.3 seconds. This is
slightly slower (by 0.05 seconds) than the Cython version but <span class="emphasis"><em>we didn’t have to
specify all that type information</em></span>. This makes experimenting with Shed Skin very
easy. PyPy runs the same version of the code at a similar speed.</p><p>Just because Cython, PyPy and Shed Skin share similar run-times on this example does not mean that this is a general result. To get the best speed-ups for your project you must investigate these different tools and run your own experiments.</p><p>Shed Skin allows you to specify extra compile-time flags like <code class="literal">-ffast-math</code> or
<code class="literal">-O3</code> and you can add Profile Guided Optimization in two passes (one to gather
execution statistics, a second to optimize the generated code in light of those
statistics) to try to make additional speed improvements. Profile Guided
Optimization didn’t make the Julia example run any faster, in practice I never
use PGO as the gains seem to be rare.</p><p>You should note that by default integers are 32 bits, if you want larger ranges
with a 64 bit integer then specify the <code class="literal">--long</code> flag. You should also avoid
allocating small objects (e.g. new tuples) inside tight inner loops as the
garbage collector doesn’t handle these as efficiently as it could.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_the_cost_of_the_memory_copies">The cost of the memory copies</h3></div></div></div><p>In our example Shed Skin copies Python <code class="literal">list</code> objects into the Shed Skin
environment by flattening the data into basic C types, it then converts the
result from the C function back into a Python <code class="literal">list</code> at the end of executing the
function. These conversions and copies take time. Might this account for the
missing 0.05 seconds that we noted in the previous result?</p><p>We can modify our <code class="literal">shedskinfn.py</code> file to remove the actual work, just so we can
calculate the cost of copying data into and out of the function via Shed Skin.
The variant of <code class="literal">calculate_z</code> below is all we need.</p><pre class="programlisting"><code class="k">def</code> <code class="nf">calculate_z</code><code class="p">(</code><code class="n">maxiter</code><code class="p">,</code> <code class="n">zs</code><code class="p">,</code> <code class="n">cs</code><code class="p">):</code>
    <code class="sd">"""Calculate output list using Julia update rule"""</code>
    <code class="n">output</code> <code class="o">=</code> <code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="nb">len</code><code class="p">(</code><code class="n">zs</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">output</code></pre><p>When we execute <code class="literal">julia1.py</code> using the above skeleton function the execution time
is approximately 0.05s (and obviously it does not calculate the correct
result!). This time is the cost of copying 2,000,000 complex numbers into
<code class="literal">calculate_z</code> and the cost of copying 1,000,000 integers out again. In essence
Shed Skin and Cython are generating the same machine code, the execution speed
difference comes down to Shed Skin running in a separate memory space which
requiress and overhead for copying data across. On the flip side - with Shed
Skin you don’t have to do the up-front annotation work which offers quite a time
saving.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_cython_and_numpy">Cython and numpy</h2></div></div></div><p><a id="compiling-cython-and-numpy"></a>List objects (for background see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html">Chapter&nbsp;3</a>) have an overhead for each dereference as the objects they reference
can occur anywhere in memory, rather than in contiguous blocks of RAM. Array
objects store primitive types in contiguous blocks of RAM which enables faster
addressing.</p><p>Python has the <code class="literal">array</code> module which offers 1D storage for basic primitives
(including integers, floating point numbers, characters and unicode strings).
Numpy’s <code class="literal">numpy.array</code> module allows multidimensional storage and a wider range
of primitive types including complex numbers.</p><p>When iterating over an array object in a predictable fashion the compiler can be
instructed to avoid asking Python to calculate the appropriate address and
instead to move to the next primitive item in sequence directly by its memory
address. Since the data is laid out in a contiguous block it is trivial to
calculate the address of the next item in C using an offset, rather than asking
CPython to calculate the same result which would involve a slow call back into
the virtual machine.</p><p>You should note that if you run the followin <code class="literal">numpy</code> version <span class="emphasis"><em>without</em></span> any
Cython annotations (i.e. just run it as a plain Python script) it’ll take about
71 seconds to run - far in excess of the plain Python <code class="literal">list</code> version which costs
around 11 seconds. The slowdown is because of the overhead of dereferencing
individual elements in the <code class="literal">numpy</code> lists - it was never designed to be used this
way, even though to a beginer this might feel like the intuitive way of handling
operations. By compiling the code this overhead is removed.</p><p>Cython has two special syntax forms for this. Older version of Cython had a
special access type for Numpy arrays, more recently the generalised buffer
interface protocol has been introduced through the <code class="literal">memoryview</code> - this allows
the same low level access to any object that implements the buffer interface
including Numpy arrays and Python arrays.</p><p>An added bonus of the buffer interface is that blocks of memory can easily be
shared with other C libraries, without any need to convert them from Python
objects into another form.</p><p>The following code block in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-numpy">Example&nbsp;7-11</a> looks a little
like the original implemenation except that we have added <code class="literal">memoryview</code>
annotations. The function’s second argument is <code class="literal">double complex[:] zs</code> which
means we have a double precision complex object using the buffer protocol
(specified using <code class="literal">[]</code>), which contains a 1 dimensional data block (specified by
the single colon <code class="literal">:</code>).</p><div class="example"><a id="augmentingwithtypes-cython-numpy"></a><div class="example-title">Example&nbsp;7-11.&nbsp;Annotated numpy version of the Julia calculation function</div><div class="example-contents"><pre class="screen"># cython_np.pyx
import numpy as np
cimport numpy as np

def calculate_z(int maxiter, double complex[:] zs, double complex[:] cs):
    """Calculate output list using Julia update rule"""
    cdef unsigned int i, n
    cdef double complex z, c
    cdef int[:] output = np.empty(len(zs), dtype=np.int32)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and (z.real * z.real + z.imag * z.imag) &lt; 4:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>In addition to specifying the input arguments using the buffer annotation syntax
we also annotate the <code class="literal">output</code> variable, assigning a 1D numpy <code class="literal">array</code> to it via
<code class="literal">empty</code>. The call to <code class="literal">empty</code> will allocate a block of memory but will not
initialize the memory with sane values, so it could contain anything. We will
overwrite the contents of this array in the inner loop so we don’t need to
re-assign it with a default value. This is slightly faster than allocating and
setting the contents of the array with a default value.</p><p>I’ve also expanded the call to <code class="literal">abs</code> using the faster, more explicit math
version. This version runs in 0.23 seconds, this is a slightly faster result
than the original Cythonized version of the pure Python Julia example in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-expanding-abs">Example&nbsp;7-7</a>. The pure Python version has an
overhead every time it dereferences a Python <code class="literal">complex</code> object - but these
dereferences occur in the outer loop and so don’t account for much of the
execution time. After the outer loop we make native versions of these variables
and they operate at “C speed”. The inner loop for both this <code class="literal">numpy</code> example and
the former pure Python example are doing the same work on the same data - so the
time difference is accounted for by the outer loop dereferences and the creation
of the <code class="literal">output</code> arrays.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="compiling-cython-omp">Parallelizing the solution with OpenMP on One Machine</h3></div></div></div><p>As a final step in the evolution of this version of the code let us look at the
use of the OpenMP C++ extensions to parallelize our embarrassingly parallel
problem. If your problem fits this pattern then you can quickly take advantage
of multiple cores in your computer.</p><p>OpenMP (Open Multi-Processing) is a well defined cross platform API that
supports parallel execution and memory sharing for C, C++ and Fortran. It is
built into most modern C compilers and if the C code is written appropriately
then the parallelization occurs at the compiler level, so it comes with
relatively little effort to the developer through Cython.</p><p>With Cython OpenMP can be added using the <code class="literal">prange</code> (parallel range) operator and
adding the <code class="literal">-fopenmp</code> compiler directive to <code class="literal">setup.py</code>. Work in a <code class="literal">prange</code> loop
can be performed in parallel because we disable the Global Interpreter Lock
(GIL).</p><p>A modified version of the code with <code class="literal">prange</code> support is shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-omp1">Example&nbsp;7-12</a>.
<code class="literal">with nogil:</code> specifies the block where the GIL is disabled, inside this block we use <code class="literal">prange</code> to enable an OpenMP parallel <code class="literal">for</code> loop to independently calculate each <code class="literal">i</code>.</p><p>When disabling the GIL we must <span class="emphasis"><em>not</em></span> operate on regular Python objects (e.g.
lists), we must only operate on primitive objects and objects that support the
memoryview interface. If we operated on normal Python objects in parallel then
we would have to solve the associated memory management problems that the GIL
deliberately avoids. Cython does not prevent us from manipulating Python objects
and only pain and confusion can result if you do this!</p><div class="example"><a id="augmentingwithtypes-cython-omp1"></a><div class="example-title">Example&nbsp;7-12.&nbsp;Adding prange to enable parallelization using OpenMP</div><div class="example-contents"><pre class="screen"># cython_np.pyx
from cython.parallel import prange
import numpy as np
cimport numpy as np

def calculate_z(int maxiter, double complex[:] zs, double complex[:] cs):
    """Calculate output list using Julia update rule"""
    cdef unsigned int i, length
    cdef double complex z, c
    cdef int[:] output = np.empty(len(zs), dtype=np.int32)
    length = len(zs)
    with nogil:
        for i in prange(length, schedule="guided"):
            z = zs[i]
            c = cs[i]
            output[i] = 0
            while output[i] &lt; maxiter and (z.real * z.real + z.imag * z.imag) &lt; 4:
                z = z * z + c
                output[i] += 1
    return output</pre></div></div><p>To compile <code class="literal">cython_np.pyx</code> we have to modify the <code class="literal">setup.py</code> script as shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-openmp-setup">Example&nbsp;7-13</a>. We tell it
to inform the C compiler to use <code class="literal">-fopenmp</code> as an argument during compilation to
enable OpenMP and to link with the OpenMP libraries.</p><div class="example"><a id="compiling-cython-openmp-setup"></a><div class="example-title">Example&nbsp;7-13.&nbsp;Adding OpenMP compiler and linker flags to setup.py for Cython</div><div class="example-contents"><pre class="screen">#setup.py
from distutils.core import setup
from distutils.extension import Extension
from Cython.Distutils import build_ext

setup(
        cmdclass = {'build_ext': build_ext},
        ext_modules = [Extension("calculate",
                                 ["cython_np.pyx"],
                                  extra_compile_args=['-fopenmp'],
                                  extra_link_args=['-fopenmp'])]
        )</pre></div></div><p>With Cython’s <code class="literal">prange</code> we can choose different scheduling approaches. With
<code class="literal">static</code> the workload is distributed evenly across the available CPUs. Some of
our calculation regions are expensive in time, some are cheap.  If we ask Cython
to schedule the work chunks equally using <code class="literal">static</code> across the CPUs then the
results for some regions will complete faster than others and that thread will
then sit idle.</p><p>Both the <code class="literal">dynamic</code> and <code class="literal">guided</code> schedule options attempt to mitigate this
problem by allocating work in smaller chunks dynamically during run-time so that
the CPUs are more evenly distributed when the workload’s calculation time is
variable. For your code the correct choice will vary depending on the nature of
your workload.</p><p>By introducing OpenMPand using <code class="literal">schedule="guided"</code> our execution time drops to
approximately 0.07s - the <code class="literal">guided</code> schedule will dynamically assign work so
fewer threads will wait for new work.</p><p>We could also have disabled the bounds checking for this example using <code class="literal">#cython:
boundscheck=False</code> but it doesn’t improve our run-time.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_numba">Numba</h2></div></div></div><p>Numba <sup>[<a id="id351851" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id351851" class="footnote">19</a>]</sup> from Continuum Analytics is a Just In
Time compiler that specializes <code class="literal">numpy</code> code via the LLVM compiler (<span class="emphasis"><em>not</em></span> via
<code class="literal">g++</code> as used by our other examples) at <span class="emphasis"><em>run time</em></span>. It doesn’t require a
pre-compilation pass so when you run it against new code it compiles each annotated function
for your hardware. The beauty is that you provide a
    decorator telling it which functions to focus on and then you let the JIT
    take over, it aims to run on all standard <code class="literal">numpy</code> code.</p><p>It is a younger project (I’m using v0.13) and the API can change a little with
each release, so consider it to be more useful in a research environment at
present. If you use <code class="literal">numpy</code> arrays and have non-vectorized code that iterates
over many items then Numba should give you a quick and very painless win.</p><p>One pain that is involved when using Numba is the tool-chain - it uses LLVM and
this has many dependencies. I recommend that you use Continuum’s Anaconda
distribution as everything is provided, getting Numba installed in a fresh
environment can otherwise be a very time-consuming task.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-numba1">Example&nbsp;7-14</a> shows the addition of the <code class="literal">@jit()</code> decorator to
the core Julia function. This is all that’s required, the fact that <code class="literal">numba</code> has
been imported means that the LLVM machinery kicks in at execution time to
compile this function behind the scenes.</p><p>If the <code class="literal">@jit()</code> decorator is removed then this is just the <code class="literal">numpy</code> version of
the Julia demo running with Python 2.7 and it takes 71 seconds. By adding the
<code class="literal">@jit()</code> decorator the execution time drops to 0.3 seconds. This is very close
to the result we achieved with Cython but without all of the annotation effort.</p><p>If I run the same function a second time in the same Python session then it runs even faster - there’s no need to compile the target function on the second pass if the argument types are the same so the overall execution speed is faster. On the second run the Numba result is equivalent to the Cython with <code class="literal">numpy</code> result we obtained before (so it came out as fast as Cython for very little work!). PyPy has the same warm-up requirement.</p><div class="example"><a id="augmentingwithtypes-numba1"></a><div class="example-title">Example&nbsp;7-14.&nbsp;Applying the jit decorator to a function</div><div class="example-contents"><pre class="screen">from numba import jit
...
@jit()
def calculate_z_serial_purepython(maxiter, zs, cs, output):</pre></div></div><p>When debugging with Numba it is useful to note that you can ask Numba to show
the type of the variable that it is dealing with inside a compiled function, in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-numba2">Example&nbsp;7-15</a> we can see that <code class="literal">zs</code> is recognised by the JIT as
a complex array.</p><div class="example"><a id="augmentingwithtypes-numba2"></a><div class="example-title">Example&nbsp;7-15.&nbsp;Debugging inferred types</div><div class="example-contents"><pre class="screen">print("zs has type:", numba.typeof(zs))
# array(complex128, 1d, C))</pre></div></div><p>Numba supports other forms of introspection such as <code class="literal">inspect_types</code> which lets you review the compiled code to see where type information has been inferred. If types have been missed then you can refine how the function is expressed to help Numba spot more type inference opportunities.</p><p>Numba’s premium version NumbaPro <sup>[<a id="id351999" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id351999" class="footnote">20</a>]</sup>
has experimental support of a <code class="literal">prange</code>
parallelization operator using OpenMP. Experimental GPU support is also available. This project aims to make it trivial to
convert slower looping Python code using <code class="literal">numpy</code> into very fast code that could
run on a CPU or a GPU, it is one to watch.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_pythran">Pythran</h2></div></div></div><p>Pythran <sup>[<a id="id352019" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352019" class="footnote">21</a>]</sup> is a Python to C++ compiler
for a subset of Python which includes partial <code class="literal">numpy</code> support. It acts a little
like Numba and Cython - you annotate a function’s arguments and then it takes
over with further type annotation and code specialization. It takes advantage of
vectorization possibilities and of OpenMP based parallelization possibilities.
It runs using Python 2.7 only.</p><p>One very interesting feature of Pythran is that it will attempt to automatically
spot parallelization opportunities, e.g. if you’re using a <code class="literal">map</code>, and to turn
this into parallel code without requiring extra effort from you. You can also
specify parallel sections using <code class="literal">pragma omp</code> directives, in this respect it
feels very similar to Cython’s OpenMP support.</p><p>Behind the scenes Pythran will take both normal Python and <code class="literal">numpy</code> code and
attempt to aggressively compile them into very fast C++ - even faster than the
results of Cython. You should note that this project is young and you may
encounter bugs, you should also note that the development team are very friendly
and tend to fix bugs in a matter of hours.</p><p>Remind yourself about the diffusion equation in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_naive">Example&nbsp;6-9</a>. I’ve extracted the calculation part of the
routine to a separate module so it can be compiled into a binary library. A nice
feature of Pythran is that we <span class="emphasis"><em>do not make Python-incompatible code</em></span>, think back
to Cython and how we had to create <code class="literal">.pyx</code> files with annotated Python that
couldn’t be run by Python directly. With Pythran we add 1 line comments that the
Pythran compiler can spot. This means that if we delete the generated <code class="literal">.so</code>
compiled module we can just run our code using Python alone - this is great for
debugging.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-pythran">Example&nbsp;7-16</a> you can see Micha’s heat equation example.
The <code class="literal">evolve</code> function has a 1 line comment (since it is a comment if you run
this without Pythran then Python will just ignore the comment), the comment
annotates the type information for the function. When Pythran runs it sees that
comment and propagates the type information (much as we saw with Shed Skin)
through each related function.</p><div class="example"><a id="augmentingwithtypes-pythran"></a><div class="example-title">Example&nbsp;7-16.&nbsp;Adding a 1 line comment to annotate the entry point to evolve()</div><div class="example-contents"><pre class="screen">import numpy as np
def laplacian(grid):
    return np.roll(grid, +1, 0) +
                   np.roll(grid, -1, 0) +
                   np.roll(grid, +1, 1) +
                   np.roll(grid, -1, 1) - 4 * grid

#pythran export evolve(float64[][], float)
def evolve(grid, dt, D=1):
    return grid + dt * D * laplacian(grid)</pre></div></div><p>We can compile this module using <code class="literal">pythran diffusion_numpy.py</code> and it will output
<code class="literal">diffusion_numpy.so</code>. From a test function we can import this new module and
call <code class="literal">evolve</code>. On my laptop <span class="emphasis"><em>without</em></span> Pythran this function executes on a
<code class="literal">(8192, 8192)</code> grid in 3.8 seconds. With Pythran this drops to 1.5 seconds. If
Pythran supports the functions that you need then it can offer some very
impressive performance gains for very little work.</p><p>The reason for the speed-up
is that Pythran has its own version of the <code class="literal">roll</code> function which has less
functionality - it therefore compiles to less complex code which might run faster. This also means it is less
flexible that the <code class="literal">numpy</code> version (Pythran’s authors note that it only
implements parts of <code class="literal">numpy</code>), but when it works it can outperform the results of the other tools we’ve seen.</p><p>By applying the same technique to the Julia expanded-math example, just by
adding the 1 line annotation to <code class="literal">calculate_z</code> the execution time drops to 0.29
seconds, this is a little slower than the Cython output. By adding a 1 line
OpenMP declaration in front of the outer loop the execution time drops to 0.1
seconds which is not far off of Cython’s best OpenMP output. The annotated code
can be seen in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-pythran2">Example&nbsp;7-17</a>.</p><div class="example"><a id="augmentingwithtypes-pythran2"></a><div class="example-title">Example&nbsp;7-17.&nbsp;Annotating calculate_z for Pythran with OpenMP support</div><div class="example-contents"><pre class="screen">#pythran export calculate_z(int, complex[], complex[], int[])
def calculate_z(maxiter, zs, cs, output):
    #omp parallel for schedule(guided)
    for i in range(len(zs)):</pre></div></div><p>The technologies so far all involve using a compiler in addition to the normal
CPython interpreter. Let’s now look at PyPy which provides an entirely new
interpreter.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="compiling-pypy">PyPy</h2></div></div></div><p>PyPy <sup>[<a id="id352187" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352187" class="footnote">22</a>]</sup> is an alternative implementation of the Python
language which includes a tracing Just In Time compiler, it is compatible with Python
2.7 and an experimental Python 3.2 version is available.</p><p>PyPy is a drop-in
replacement for CPython and offers all the built-in modules. The project
comprises the RPython Translation Toolchain which is used to build PyPy (and
could be used to build other interpreters). The Just In Time compiler in PyPy is
very effective and good speed-ups can occur for little or no work on your part. See
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-marko">PyPy for successful web and data processing systems</a> for a large PyPy deployment success story.</p><p>PyPy runs my pure-Python Julia demo without any modifications, with CPython it
takes 11 seconds and with PyPy it takes 0.3 seconds. This means that PyPy
achieves a result that’s very close to the Cython example in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-expanding-abs">Example&nbsp;7-7</a> without <span class="emphasis"><em>any effort at all</em></span> -
that’s pretty impressive! As noted in the Numba section if the calculations are run again <span class="emphasis"><em>in the same session</em></span> then the second (and subsequent) runs are faster than the first as they are already compiled.</p><p>The fact that PyPy supports all the built-in modules is interesting - this means
that <code class="literal">multiprocessing</code> works as it does in CPython. If you have a problem that
runs with the batteries included modules and can run in parallel with
<code class="literal">multiprocessing</code> then expect that all the speed gains you might hope to get will be
available.</p><p>PyPy’s speed has evolved over time, the following chart in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-speed-pypy-org">Figure&nbsp;7-6</a> from <code class="literal">speed.pypy.org</code> will give you an idea about its maturity. These speed tests reflect a wide range of use cases, not just mathematical operations. It is clear that PyPy offers a faster experience than CPython.</p><div class="figure"><a id="FIG-speed-pypy-org"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 432; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/compiling_speed_pypy_org.png" alt="" width="1000" height="665" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/compiling_speed_pypy_org.png"></div></div><div class="figure-title">Figure&nbsp;7-6.&nbsp;Each new version of PyPy offers speed improvements</div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_garbage_collection_differences">Garbage Collection differences</h3></div></div></div><p>PyPy uses a different type of garbage collector to CPython and this can cause some non-obvious behavior changes to your code. CPython uses Reference Counting, PyPy using a modified Mark and Sweep approach, the Mark and Sweep approach may clean up an unused object much later. Both are correct implementations of the Python specification, you just have to be aware that some code modifications might be required.</p><p>Some coding approaches seen in CPython depend on the behavior of the Reference Counter - particularly the flushing of files if they’re opened and written to without an explicit file close. With PyPy the same code will run but the updates to the file might get flushed to disk later when the garbage collector next runs. An alternative form that works in both PyPy and Python is to use a context manager using <code class="literal">with</code> to open and automatically close files. The CPython Differences <sup>[<a id="id352373" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352373" class="footnote">23</a>]</sup> pages lists the details and implementation details for the Garbage Collector <sup>[<a id="id352311" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352311" class="footnote">24</a>]</sup> are also available.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_running_pypy_and_installing_modules">Running PyPy and installing modules</h3></div></div></div><p>If you’ve never run an alternative Python interpreter you might benefit from a
short example. I’ll assume you’ve downloaded and extracted PyPy, you’ll now have
a folder structure containing a <code class="literal">bin</code> directory. Run it as shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-pypy-run">Example&nbsp;7-18</a> to start PyPy:</p><div class="example"><a id="compiling-pypy-run"></a><div class="example-title">Example&nbsp;7-18.&nbsp;Running PyPy to see that it implements Python 2.7.3</div><div class="example-contents"><pre class="screen">$ ./bin/pypy
Python 2.7.3 (84efb3ba05f1, Feb 18 2014, 23:00:21)
[PyPy 2.3.0-alpha0 with GCC 4.6.3] on linux2
Type "help", "copyright", "credits" or "license" for more information.
And now for something completely different: ``&lt;arigato&gt; (not thread-safe, but
well, nothing is)''</pre></div></div><p>Note that PyPy 2.3 runs as Python 2.7.3 (build number 84efb3ba05f1), I’m using a
nightly build. Now we need to setup <code class="literal">pip</code> and we’ll want to install <code class="literal">ipython</code>
(note that IPython starts with the same Python 2.7.3 build as we’ve just seen). The steps shown in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-pypy-pip">Example&nbsp;7-19</a> are the same as you might have performed with CPython if you’ve installed <code class="literal">pip</code> without the help
of an existing distribution or package manager.</p><div class="example"><a id="compiling-pypy-pip"></a><div class="example-title">Example&nbsp;7-19.&nbsp;Installing pip for PyPy to install third party modules like IPython</div><div class="example-contents"><pre class="screen">$ mkdir sources  # make a local download directory
$ cd sources
# fetch distribute and pip
$ curl -O http://python-distribute.org/distribute_setup.py
$ curl -O https://raw.github.com/pypa/pip/master/contrib/get-pip.py
# now run the setup files for these using pypy
$ ../bin/pypy ./distribute_setup.py
...
$ ../bin/pypy get-pip.py
...
$ ../bin/pip install ipython
...
$ ../bin/ipython
Python 2.7.3 (84efb3ba05f1, Feb 18 2014, 23:00:21)
Type "copyright", "credits" or "license" for more information.

IPython 2.0.0 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython's features.
%quickref -&gt; Quick reference.
help      -&gt; Python's own help system.
object?   -&gt; Details about 'object', use 'object??' for extra details.</pre></div></div><p>Note that PyPy does <span class="emphasis"><em>not</em></span> support projects like <code class="literal">numpy</code> in a usable way (there
is a bridge layer via <code class="literal">cpyext</code>
<sup>[<a id="id352430" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352430" class="footnote">25</a>]</sup> but it is too
slow to be useful with <code class="literal">numpy</code>), so don’t go looking for strong <code class="literal">numpy</code> support
with PyPy. PyPy does have an experimental port of <code class="literal">numpy</code> known as “numpypy”
(I’ve noted some installation instructions
<sup>[<a id="id352450" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352450" class="footnote">26</a>]</sup>)
but it doesn’t offer any useful speed advantages at present (during 2014
this may change
<sup>[<a id="id352476" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352476" class="footnote">27</a>]</sup>).</p><p>If you need other packages then anything that is pure-Python will <span class="emphasis"><em>probably</em></span>
install, anything that relies on C extension libraries <span class="emphasis"><em>probably</em></span> won’t work in
a useful way. PyPy doesn’t have a reference counting garbage collector and
anything that is compiled for CPython will use library calls that support
CPython’s garbage collector. PyPy has a workaround but it adds a lot of
overhead, in practice it isn’t useful to try to force older extension libraries
to work with PyPy directly. The PyPy advice is to try to remove any C extension
code if possible (it might just be there to make the Python code go fast - and
that’s now PyPy’s job). The PyPy wiki maintains a list of compatible modules
<sup>[<a id="id352470" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352470" class="footnote">28</a>]</sup>.</p><p>Another downside of PyPy is that it can use a lot of RAM - each release is
better in this repsect but in practice it may use more RAM than CPython. RAM is
fairly cheap - it makes sense to try to trade it for enhanced performance. Some
users have also reported <span class="emphasis"><em>lower</em></span> RAM usage when using PyPy. As ever - perform an
experiment using representative data if this is important to you.</p><p>PyPy is bound by the Global Interpreter Lock but the team are working on a
project called Software Transactional Memory
<sup>[<a id="id352506" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352506" class="footnote">29</a>]</sup> to attempt
to remove the need for the GIL. STM is a little like database transactions, it
is a concurrency control mechanism that applies to memory access - it can roll
back changes if conflicting operations occur to the same memory space. The goal
of STM integration is to enable highly concurrent systems to have a form on
concurrency control, losing some efficiency on operations but gaining programmer
productivity by not forcing the user to handle all aspects of concurrent access
control.</p><p>For profiling the recommended tools are <code class="literal">jitviewer</code>
<sup>[<a id="id352520" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352520" class="footnote">30</a>]</sup> and <code class="literal">logparser</code>
<sup>[<a id="id352492" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352492" class="footnote">31</a>]</sup>.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_when_to_use_each_technology">When to use each technology</h2></div></div></div><p>If you’re working on a numeric project then each of these technologies
could be useful to you. The table in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#table_compiler_summary">Table&nbsp;7-1</a> summarises the main options.</p><div class="table"><a id="table_compiler_summary"></a><div class="table-title">Table&nbsp;7-1.&nbsp;Summary of Compiler and JIT options</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">                          </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Cython</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">PyPy</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Numba</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Shed Skin</td><td style="border-bottom: 0.5pt solid ; ">Pythran</td></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Mature</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Widespread</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>numpy support</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p>Y</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Non-breaking code changes</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-bottom: 0.5pt solid ; "><p>Y</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Needs C knowledge</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p>Supports OpenMP</p></td><td style="border-right: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; "><p></p></td><td><p>Y</p></td></tr></tbody></table></div></div><p>Pythran probably offers the best gains on <code class="literal">numpy</code> problems for the least effort if your problem fits into the restricted scope of the supported functions. It also offers some easy OpenMP parallelization options. It is a relatively young project.</p><p>Numba may offer quick wins for little effort but it too has limitations that might stop it working well on your code. It is a relatively young project.</p><p>Cython probably offers the best results for the widest set of problems but it does require more effort and has
an additional “support tax” due to its use of the mix of Python with C annotations.</p><p>PyPy is a strong option if you’re not using <code class="literal">numpy</code> or other hard-to-port C extensions.</p><p>Shed Skin may be useful if you want to compile to C and you’re not using <code class="literal">numpy</code> or other external libraries.</p><p>If you’re deploying a production tool then you probably want to stick with well understood tools - Cython should be your main choice, you may want to see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-radim">Making deep learning fly with RadimRehurek.com</a>. PyPy is also being used in production settings, see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-marko">PyPy for successful web and data processing systems</a>.</p><p>If you’re working with light numeric requirements then note that Cython’s buffer
interface accepts <code class="literal">array.array</code> matrices - this is an easy way to pass a block
of data to Cython for fast numeric processing without having to add <code class="literal">numpy</code> as a
project dependency.</p><p>Overall Pythran and Numba are young but very promising projects, Cython is very
mature. PyPy is regarded as being fairly mature now and should definitely be
evaluated for long running processes.</p><p>In a class run by Ian in 2014 a capable student implemented a C version of the Julia algorithm and was disappointed to see it execute more slowly than their Cython version. It transpired that they were using 32 bit floats on a 64 bit machine, these run more slowly than 64 bit doubles on a 64 bit machine. The student, despite being a good C programmer, didn’t know that this could involve a speed cost. The student changed their code and the C version, despite being significantly shorter than the auto-generated Cython version, ran at roughly the same speed. The act of writing the raw C version, comparing its speed and figuring out how to fix it took longer than using Cython in the first place.</p><p>This is just an anecdote, I’m not suggesting that Cython will generate the best code and a competent C programmer can probably figure out how to make their code run faster than the version generated by Cython. It is worth noting that the assumption that hand-written C will be faster than converted Python is not a safe assumption. You must always benchmark and make decisions using evidence. C compilers are pretty good at converting code into fairly efficient machine code and Python is pretty good at letting you express your problem in an easy to understand language - combine these two powers sensibly.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_other_upcoming_projects">Other upcoming projects</h3></div></div></div><p>The PyData compilers <sup>[<a id="id354259" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354259" class="footnote">32</a>]</sup> page lists a set of
high performance and compiler tools. Theano
<sup>[<a id="id354270" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354270" class="footnote">33</a>]</sup> is a higher level language
allowing the expression of mathematical operators on multi-dimensional arrays,
it has tight integration with <code class="literal">numpy</code> and can export compiled code for CPUs and
GPUs. Interestingly it has found favour with the deep-learning AI community.
Parakeet <sup>[<a id="id354351" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354351" class="footnote">34</a>]</sup> focuses on compiling
operations involving dense <code class="literal">numpy</code> arrays using a subset of Python, it too
supports GPUs.</p><p>PyViennaCL <sup>[<a id="id354325" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354325" class="footnote">35</a>]</sup> is a
Python binding to the ViennaCL numerical computation and linear algebra library,
it supports GPUs and CPUs using <code class="literal">numpy</code>. ViennaCL is written in C++ and
generates code for CUDA, OpenCL and OpenMP. It supports dense and sparse linear
algebra operations, BLAS and solvers.</p><p>Nuitka <sup>[<a id="id354292" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354292" class="footnote">36</a>]</sup> is a Python compiler
that aims to be an alternative to the usual CPython interpreter with the option
of creating compiled executables. It supports all of Python 2.7 though in my
testing didn’t produce any noticeable speed gains for my plain Python numerical
tests.</p><p>Pyston <sup>[<a id="id354368" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354368" class="footnote">37</a>]</sup> is the latest entrant to the
field, it uses the LLVM compiler and is being supported by Dropbox. It may
suffer from the same issue that PyPy faces with a lack of support for extension
modules but there are project plans to try to address this. Without addressing
this issue it is unlikely that <code class="literal">numpy</code> support would be practical.</p><p>In our community we’re rather blessed with a wide array of compilation options.
Whilst they all have trade-offs they also offer a lot of power so that complex
projects can take advantage of the full power of CPUs and multi-core
architectures.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_a_note_on_graphics_processing_units_gpus">A note on Graphics Processing Units (GPUs)</h3></div></div></div><p>GPUs are a sexy technology at the moment and we’re choosing to delay covering them until at least the next edition. The field is rapidly changing, it is quite likely that anything we say now will have changed by the time you read it. Critically it isn’t just that the lines of code you write might have to change but you might have to substantially change how you go about solving your problem as architectures evolve.</p><p>Ian worked on a physics problem using the NVIDIA GTX 480 GPU for a year using Python and PyCUDA. By the end of a year the full power of the GPU was harnessed and the system ran fully 25* faster than the same function on a quad-core machine. The quad-core variant was written in C with a parallel library, the GPU variant was mostly expressed in CUDA’s C wrapped in pyCUDA for data handling. Shortly after this the GTX 5xx series of GPUs were launched and many of the optimizations that applied to the 4xx series changed. Roughly a year’s worth of work ultimately was abandoned in favor of an easier to maintain C solution running on CPUs.</p><p>This is an isolated example but it highlights the danger of writing low-level CUDA (or OpenCL) code. Libraries that sit on top of GPUs and offer a higher-level functionality are far more likely to be generally usable (e.g. libraries that offer image analysis or video transcoding interfaces) and we’d urge you to consider these rather than looking at coding for GPUs directly.</p><p>Projects that aim to manage GPUs for you include Numba, Parakeet and Theano.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_a_wish_for_a_future_compiler_project">A wish for a future compiler project</h3></div></div></div><p>Amongst the current compiler options we have some strong technology components.
Personally I’d like to see Shed Skin’s annotation engine become generalized so
that it could work with other tools - for example making an output that’s Cython
compatible to smooth the learning curve to starting with Cython
(particularly when using <code class="literal">numpy</code>). Cython is mature and integrates tightly into
Python and <code class="literal">numpy</code> and more people would use it if the learning curve and
support requirement wasn’t quite so tricky.</p><p>A longer-term wish would be to see some sort of Numba and PyPy-like solution which offers JIT behavior on both regular Python code and <code class="literal">numpy</code> code. No one solution offers this at present, a tool that solves this problem would be a strong contender to replace the regular CPython interpreter that we all currently use, without requiring the developer to modify their code.</p><p>Friendly competition and a large marketplace for new ideas make our ecosystem a
rich place indeed.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_foreign_function_interfaces">Foreign function interfaces</h2></div></div></div><p>Sometimes the automatic solutions just don’t cut it and you need to write some
custom C or FORTRAN code yourself.  This could be because the compilation
methods don’t find some potential optimizations or because you can take
advantage of libraries or language features that aren’t availible in python.  In
all of these cases, you’ll need to use foreign function interfaces which give
you access to code writen and compiled in another language.</p><p>For the rest of this chapter, we will attempt to use an external library to
solve the 2D diffusion equation in the same way we did in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a> <sup>[<a id="id354465" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354465" epub:type="noteref" class="footnote">38</a>]</sup>.  The code for this library, <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#c_diffusion_2d">Example&nbsp;7-20</a>, could be
representative of a library you installed, or some code that you have written.
In this way, these methods serve as great ways to take small parts of your code
and move them to another language in order to do very targeted language-based
optimizations.</p><div class="example"><a id="c_diffusion_2d"></a><div class="example-title">Example&nbsp;7-20.&nbsp;Sample C code for solving the 2D diffusion problem</div><div class="example-contents"><pre class="programlisting"><code class="kt">void</code> <code class="nf">evolve</code><code class="p">(</code><code class="kt">double</code> <code class="n">in</code><code class="p">[][</code><code class="mi">512</code><code class="p">],</code> <code class="kt">double</code> <code class="n">out</code><code class="p">[][</code><code class="mi">512</code><code class="p">],</code> <code class="kt">double</code> <code class="n">D</code><code class="p">,</code> <code class="kt">double</code> <code class="n">dt</code><code class="p">)</code> <code class="p">{</code>
    <code class="kt">int</code> <code class="n">i</code><code class="p">,</code> <code class="n">j</code><code class="p">;</code>
    <code class="kt">double</code> <code class="n">laplacian</code><code class="p">;</code>
    <code class="k">for</code> <code class="p">(</code><code class="n">i</code><code class="o">=</code><code class="mi">1</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">511</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">for</code> <code class="p">(</code><code class="n">j</code><code class="o">=</code><code class="mi">1</code><code class="p">;</code> <code class="n">j</code><code class="o">&lt;</code><code class="mi">511</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
            <code class="n">laplacian</code> <code class="o">=</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="o">+</code><code class="mi">1</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="o">-</code><code class="mi">1</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="o">+</code><code class="mi">1</code><code class="p">]</code> <code class="o">+</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code> <code class="o">-</code> <code class="mi">4</code> <code class="o">*</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">];</code>
            <code class="n">out</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">=</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">D</code> <code class="o">*</code> <code class="n">dt</code> <code class="o">*</code> <code class="n">laplacian</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div></div><p>In order to use the above code, we must compile it into a shared module which
creates a <code class="literal">.so</code> file.  This can be done using <code class="literal">gcc</code> (or any other C compiler) by
following the steps below.  We can place this final shared library file anywhere
that is accessible to our python code, however standard *NIX orginazion stores
shared libraries in <code class="literal">/usr/lib</code> and <code class="literal">/usr/local/lib</code>.</p><pre class="programlisting"><code class="nv">$ </code>gcc -O3 -std<code class="o">=</code>gnu99 -c diffusion.c
<code class="nv">$ </code>gcc -shared -o diffusion.so diffusion.o</pre><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_ctypes">ctypes</h3></div></div></div><p>The most basic foreign function interface in cpython <sup>[<a id="id355197" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id355197" epub:type="noteref" class="footnote">39</a>]</sup> is through the <code class="literal">ctypes</code> module.  The simplicity
of this module can be quite inhibitive at times—you are in charge of doing
everything and it can take quite a while to make sure that you have everything in
order.</p><div class="example"><a id="id355230"></a><div class="example-title">Example&nbsp;7-21.&nbsp;ctypes 2D Diffusion code</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">ctypes</code>

<code class="n">grid_shape</code> <code class="o">=</code> <code class="p">(</code><code class="mi">512</code><code class="p">,</code> <code class="mi">512</code><code class="p">)</code>
<code class="n">_diffusion</code> <code class="o">=</code> <code class="n">ctypes</code><code class="o">.</code><code class="n">CDLL</code><code class="p">(</code><code class="s">"../diffusion.so"</code><code class="p">)</code> <code class="c"># </code><a id="CO11-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">

<code class="c"># Create references to the C types that we will need to simplify future code</code>
<code class="n">TYPE_INT</code> <code class="o">=</code> <code class="n">ctypes</code><code class="o">.</code><code class="n">c_int</code>
<code class="n">TYPE_DOUBLE</code> <code class="o">=</code> <code class="n">ctypes</code><code class="o">.</code><code class="n">c_double</code>
<code class="n">TYPE_DOUBLE_SS</code> <code class="o">=</code> <code class="n">ctypes</code><code class="o">.</code><code class="n">POINTER</code><code class="p">(</code><code class="n">ctypes</code><code class="o">.</code><code class="n">POINTER</code><code class="p">(</code><code class="n">ctypes</code><code class="o">.</code><code class="n">c_double</code><code class="p">))</code>

<code class="c"># Initialize the signature of the evolve function to:</code>
<code class="c"># void evolve(int, int, double**, double**, double, double)</code>
<code class="n">_diffusion</code><code class="o">.</code><code class="n">evolve</code><code class="o">.</code><code class="n">argtypes</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">TYPE_INT</code><code class="p">,</code>
    <code class="n">TYPE_INT</code><code class="p">,</code>
    <code class="n">TYPE_DOUBLE_SS</code><code class="p">,</code>
    <code class="n">TYPE_DOUBLE_SS</code><code class="p">,</code>
    <code class="n">TYPE_DOUBLE</code><code class="p">,</code>
    <code class="n">TYPE_DOUBLE</code><code class="p">,</code>
<code class="p">]</code>
<code class="n">_diffusion</code><code class="o">.</code><code class="n">evolve</code><code class="o">.</code><code class="n">restype</code> <code class="o">=</code> <code class="bp">None</code>

<code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mf">1.0</code><code class="p">):</code>
    <code class="c"># First we convert the python types into the relevant C types</code>
    <code class="n">cX</code> <code class="o">=</code> <code class="n">TYPE_INT</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code>
    <code class="n">cY</code> <code class="o">=</code> <code class="n">TYPE_INT</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>
    <code class="n">cdt</code> <code class="o">=</code> <code class="n">TYPE_DOUBLE</code><code class="p">(</code><code class="n">dt</code><code class="p">)</code>
    <code class="n">cD</code> <code class="o">=</code> <code class="n">TYPE_DOUBLE</code><code class="p">(</code><code class="n">D</code><code class="p">)</code>
    <code class="n">pointer_grid</code> <code class="o">=</code> <code class="n">grid</code><code class="o">.</code><code class="n">ctypes</code><code class="o">.</code><code class="n">data_as</code><code class="p">(</code><code class="n">TYPE_DOUBLE_SS</code><code class="p">)</code> <code class="c"># </code><a id="CO11-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">pointer_out</code> <code class="o">=</code> <code class="n">out</code><code class="o">.</code><code class="n">ctypes</code><code class="o">.</code><code class="n">data_as</code><code class="p">(</code><code class="n">TYPE_DOUBLE_SS</code><code class="p">)</code>

    <code class="c"># Now we can call the function</code>
    <code class="n">_diffusion</code><code class="o">.</code><code class="n">evolve</code><code class="p">(</code><code class="n">cX</code><code class="p">,</code> <code class="n">cY</code><code class="p">,</code> <code class="n">pointer_grid</code><code class="p">,</code> <code class="n">pointer_out</code><code class="p">,</code> <code class="n">cD</code><code class="p">,</code> <code class="n">cdt</code><code class="p">)</code> <code class="c"># </code><a id="CO11-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO11-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
This is similar to importing the <code class="literal">diffusion.so</code> library
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO11-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
<code class="literal">grid</code> and <code class="literal">out</code> are both numpy arrays
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO11-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
We finally have all the setup necessary and can call the C function directly
</p></dd></dl></div></div></div><p>This first thing that we do is “import” our shared library.  This is done with
the <code class="literal">ctypes.CDLL</code> call.  In this line we can specify any shared library that
python can access (for example, the <code class="literal">ctypes-opencv</code> module loads the <code class="literal">libcv.so</code>
library).  From this, we get a <code class="literal">_diffusion</code> object that contains all the members
that the shared library contains.  In this example, <code class="literal">diffusion.so</code> only contains
one function, <code class="literal">evolve</code>, which is not a property of the object.  If
<code class="literal">diffusion.so</code> had many functions and properties, we could access them all
through the <code class="literal">_diffusion</code> object.</p><p>However, even thought the <code class="literal">_diffusion</code> object has the evolve function available
within it, it doesn’t know how to use it.  C is statically typed and the
function has a very specific signature.  In order to properly work with the
<code class="literal">evolve</code> function, we must explicitly set the input argument types and the
return type.  This can become quite tedious when developing libraries in tandem
with the python interface, or when dealing with a quickly changing library.
Furthermore, since <code class="literal">ctypes</code> can’t check if you have given it the correct types,
if you make a mistake then your code may silently fail or segfault!</p><p>Furthermore, in addition to setting the arguments and return type of the
function object, we also need to convert any data we care to use with it (which
is called “casting”).  Every argument we send to the function must be carefully
casted into a native C type.  Sometimes this can get quite tricky since
python is very relaxed about it’s variable types.  For example, if I had <code class="literal">num1 =
1e5</code> I would have to know that this is a python <code class="literal">float</code> and thus I should use a
<code class="literal">ctype.c_float</code>.  On the other hand, for <code class="literal">num2 = 1e300</code> I would have to use
<code class="literal">ctype.c_double</code> because it would overflow a standard C <code class="literal">float</code>.</p><p>That being said, <code class="literal">numpy</code> provides a <code class="literal">.ctypes</code> property to it’s arrays which
makes it easily compatible with <code class="literal">ctypes</code>.  If <code class="literal">numpy</code> wouldn’t provide this
functionality, we would have had to initialize a ctypes array of the correct
time and then find the location of our original data and have our new ctypes
object point there.</p><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>Unless the object you are turning into a <code class="literal">ctype</code> object implements a buffer
(such as the <code class="literal">array</code> module, <code class="literal">numpy</code> arrays, <code class="literal">cStringIO</code>, etc), your data will
be copied into the new object.  In the case of casting an <code class="literal">int</code> of <code class="literal">float</code>, this
doesn’t mean much for the performance of your code.  However, if you are casting
a very long python list, this can incur quite a penalty!  These are cases where
using the <code class="literal">array</code> module, a <code class="literal">numpy</code> array or even building up your own buffered
object using the <code class="literal">struct</code> module would help!  This does, however, hurt
readability of your code since these objects are generally less flexible than
their native python counterparts.</p></div><p>This can get even more complicated if you have to send the library a complicated
data structure.  For example, if your library expect a C stype structure
representing a point in space with the properties <code class="literal">x</code> and <code class="literal">y</code>, you would have to
define,</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">ctypes</code> <code class="kn">import</code> <code class="n">Structure</code>
<code class="k">class</code> <code class="nc">cPoint</code><code class="p">(</code><code class="n">Structure</code><code class="p">):</code>
    <code class="n">_fields_</code> <code class="o">=</code> <code class="p">(</code><code class="s">"x"</code><code class="p">,</code> <code class="n">c_int</code><code class="p">),</code> <code class="p">(</code><code class="s">"y"</code><code class="p">,</code> <code class="n">c_int</code><code class="p">)</code></pre><p>At which point you could start creating C-compatible object by initializing a
cPoint object (ie: <code class="literal">point = cPoint(10, 5)</code>).  This isn’t a terrible amount of
work but it can become tedious and results in some fragile code.  What happens
if a new version of the library is released that slightly changes the structure?
This will make your quite very hard to maintain and generally results in very
stagnant code where the developers simply decide never to upgrade the underlying
libraries that are being used.</p><p>For these reason, using the <code class="literal">ctypes</code> module is great if you already have a good
understanding of C and want to be able to tune every aspect of the interface.
It has great portability since it is part of the standard library and if your
task is simple then it provides simple solutions.  Just be careful since the
complexity of ctype-like solutions quickly becomes unmanageable.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_cffi">CFFI</h3></div></div></div><p>Realizing that <code class="literal">ctypes</code> can be quite cumbersome to use at times, <code class="literal">cffi</code> attempts
to simplify many of the standard operations that programmers use.  It does this
by having an internal C parser which can understand function and structure
definitions.</p><p>As a result, we can simply write the C code which defines the structure of the
library we wish to use, and then <code class="literal">cffi</code> will do all the heavy work for us:
import in the module and make sure we specify the correct types to the resulting
functions.  In fact, this work can be almost trivial if the source for the
library is available since the header files (the files ending in <code class="literal">.h</code>) will
include all the relevant definitions we need.</p><div class="example"><a id="id633217"></a><div class="example-title">Example&nbsp;7-22.&nbsp;cffi 2D Diffusion code</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">cffi</code> <code class="kn">import</code> <code class="n">FFI</code>

<code class="n">ffi</code> <code class="o">=</code> <code class="n">FFI</code><code class="p">()</code>
<code class="n">ffi</code><code class="o">.</code><code class="n">cdef</code><code class="p">(</code><code class="s">r''' void evolve(int Nx, int Ny, double **in, double **out, double D, double dt); '''</code><code class="p">)</code> <code class="c">#</code><a id="CO12-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
<code class="n">lib</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">dlopen</code><code class="p">(</code><code class="s">"../diffusion.so"</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">out</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mf">1.0</code><code class="p">):</code>
    <code class="n">X</code><code class="p">,</code> <code class="n">Y</code> <code class="o">=</code> <code class="n">grid_shape</code>
    <code class="n">pointer_grid</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="s">'double**'</code><code class="p">,</code> <code class="n">grid</code><code class="o">.</code><code class="n">ctypes</code><code class="o">.</code><code class="n">data</code><code class="p">)</code> <code class="c">#</code><a id="CO12-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">pointer_out</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="s">'double**'</code><code class="p">,</code> <code class="n">out</code><code class="o">.</code><code class="n">ctypes</code><code class="o">.</code><code class="n">data</code><code class="p">)</code>
    <code class="n">lib</code><code class="o">.</code><code class="n">evolve</code><code class="p">(</code><code class="n">X</code><code class="p">,</code> <code class="n">Y</code><code class="p">,</code> <code class="n">pointer_grid</code><code class="p">,</code> <code class="n">pointer_out</code><code class="p">,</code> <code class="n">D</code><code class="p">,</code> <code class="n">dt</code><code class="p">)</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO12-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
The contents of this definition can normally be acquired from the manual of the library that you are using or by looking at the libraries header files.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO12-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
While we still need to cast non-native python objects for use with our C module, the syntax is very familiar to those with experience in C
</p></dd></dl></div></div></div><p>In the above code we can think of the <code class="literal">cffi</code> initialization as being two
stepped.  First, we create a <code class="literal">FFI</code> object and give it all the global C
declarations we need.  This can include data types in addition to function
signatures.  Then, we can import a shared library using <code class="literal">dlopen</code> into it’s own
name space that is a child name space of <code class="literal">FFI</code>.  As a result, we could have
loaded up two libraries with the same <code class="literal">evolve</code> function into variables <code class="literal">lib1</code>
and <code class="literal">lib2</code> and use them independently (which is fantastic for debugging and
profiling!).</p><p>In addition to simply importing a shared C library, <code class="literal">cffi</code> allows you to simply
write C code and have it be just-in-time compiled using the <code class="literal">verify</code> function.
This has many immediate benefits—you can easily re-write small portions of
your code to be in C without invoking the large machinery of a separate C
library.  Alternatively, if there is a library you wish to use, however it
requires some glue code in C to have the interface work perfectly, you can
simply in line it into your <code class="literal">cffi</code> code to have everything be in a centralized
location.  In addition, since the code is being just-in-time compiled, you can
specify specific compile instructions to every chunk of code you need to
compile.  Note however that this compilation has a one-time penalty every time
the <code class="literal">verify</code> function is run to actually perform the compilation.</p><div class="example"><a id="id647926"></a><div class="example-title">Example&nbsp;7-23.&nbsp;cffi with inline 2D Diffusion code</div><div class="example-contents"><pre class="programlisting"><code class="n">ffi</code> <code class="o">=</code> <code class="n">FFI</code><code class="p">()</code>
<code class="n">ffi</code><code class="o">.</code><code class="n">cdef</code><code class="p">(</code><code class="s">r'''void evolve(int Nx, int Ny, double **in, double **out, double D, double dt);'''</code><code class="p">)</code>
<code class="n">lib</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">verify</code><code class="p">(</code><code class="s">r'''</code>
<code class="s">void evolve(int Nx, int Ny, double in[][Ny], double out[][Ny], double D, double dt) {</code>
<code class="s">    int i, j;</code>
<code class="s">    double laplacian;</code>
<code class="s">    for (i=1; i&lt;Nx-1; i++) {</code>
<code class="s">        for (j=1; j&lt;Ny-1; j++) {</code>
<code class="s">            laplacian = in[i+1][j] + in[i-1][j] + in[i][j+1] + in[i][j-1] - 4 * in[i][j];</code>
<code class="s">            out[i][j] = in[i][j] + D * dt * laplacian;</code>
<code class="s">        }</code>
<code class="s">    }</code>
<code class="s">}</code>
<code class="s">'''</code><code class="p">,</code> <code class="n">extra_compile_args</code><code class="o">=</code><code class="p">[</code><code class="s">"-O3"</code><code class="p">,])</code> <code class="c"># </code><a id="CO13-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO13-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Since we are just-in-time compiling this code, we can also provide relevant compilation flags
</p></dd></dl></div></div></div><p>Another benefit of the <code class="literal">verify</code> functionality is how it plays very nicely with
complicated <code class="literal">cdef</code> statements.  For example, if we were using a library with a
very complicated structure, but only wanted to use a part of it we could use
the partial struct definition.  This happens when you add a <code class="literal">...</code> in the struct
definition in <code class="literal">ffi.cdef</code> and the <code class="literal">#include</code> the relevant header file in a later
<code class="literal">verify</code>.</p><p>For example, if we were working with a library with header <code class="literal">complicated.h</code> which
included a structure that looked like,</p><pre class="programlisting"><code class="k">struct</code> <code class="n">Point</code> <code class="p">{</code>
    <code class="kt">double</code> <code class="n">x</code><code class="p">;</code>
    <code class="kt">double</code> <code class="n">y</code><code class="p">;</code>
    <code class="kt">bool</code> <code class="n">isActive</code><code class="p">;</code>
    <code class="kt">char</code> <code class="o">*</code><code class="n">id</code><code class="p">;</code>
    <code class="kt">int</code> <code class="n">num_times_visited</code><code class="p">;</code>
<code class="p">}</code></pre><p>If we only cared about the <code class="literal">x</code> and <code class="literal">y</code> properties, we could write some simple
<code class="literal">cffi</code> code that only ares about those values,</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">cffi</code> <code class="kn">import</code> <code class="n">FFI</code>

<code class="n">ffi</code> <code class="o">=</code> <code class="n">FFI</code><code class="p">()</code>
<code class="n">ffi</code><code class="o">.</code><code class="n">cdef</code><code class="p">(</code><code class="s">r"""</code>
<code class="s">    struct Point {</code>
<code class="s">        double x;</code>
<code class="s">        double y;</code>
<code class="s">        ...;</code>
<code class="s">    };</code>
<code class="s">    struct Point do_calculation();</code>
<code class="s">"""</code><code class="p">)</code>
<code class="n">lib</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">verify</code><code class="p">(</code><code class="s">r"""</code>
<code class="s">    #include &lt;complicated.h&gt;</code>
<code class="s">"""</code><code class="p">)</code></pre><p>We can now run the <code class="literal">do_calculation</code> function from the <code class="literal">complicated.h</code> library
and get returned to us a <code class="literal">Point</code> object with it’s <code class="literal">x</code> and <code class="literal">y</code> properties
accessible.  This is amazing for portability since this code will run just fine
on systems with a different implementation of <code class="literal">Point</code> or when new versions of
<code class="literal">complicated.h</code> comes out, as long as they all have the <code class="literal">x</code> and <code class="literal">y</code> properties.</p><p>All of these niceties really make <code class="literal">cffi</code> an amazing tool to have when working
with C code in python.  It is much simpler than <code class="literal">ctypes</code> while still giving you
the same amount of fine grained control you may want when working directly with
a foreign function interface.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_f2py">f2py</h3></div></div></div><p>For many scientific applications, Fortran is still the golden standard. While
it’s days of being a general purpose language are over it still has many
niceties which make vector operations easy to write and quite quick!  In
addition, there are many performance math libraries written in Fortran ( LAPACK
<sup>[<a id="id648494" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id648494" class="footnote">40</a>]</sup>, BLAS
<sup>[<a id="id648537" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id648537" class="footnote">41</a>]</sup>, etc.) and being able to still use them
in your performance python code may be critical.</p><p>For such situations, <code class="literal">f2py</code> <sup>[<a id="id648511" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id648511" class="footnote">42</a>]</sup>
provides a dead simple way of importing Fortran code into python.  This module
is able to be so simple because of the explicitness of types in Fortran.  Since
the types can be easily parsed and understood, <code class="literal">f2py</code> can easily make a CPython
module that uses the native foreign function support within C to use the Fortran
code.  This means that when you are using <code class="literal">f2py</code>, you are actually
auto-generating a C module which knows how to use the Fortran code!  As a
result, a lot of the confusion which is inherent in the <code class="literal">ctypes</code> and <code class="literal">cffi</code>
solutions simply don’t exist.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#f2py_diffusion">Example&nbsp;7-24</a> we can see some simple <code class="literal">f2py</code> compatible code for solving
the diffusion equation.  In fact, all native Fortran code is <code class="literal">f2py</code> compatible,
however the annotations to the function arguments (the statements prefaced by
<code class="literal">!f2py</code>) simplify the resulting python module and make for a more easy to use
interface.  The annotations implicitly tell <code class="literal">f2py</code> whether we intend for an argument
to be only an output, only an input, to be something we want to modify inplace
or hidden completely.  The hidden type is particularly useful for the sizes of
vectors: while Fortran may need those numbers explicitly, our python code
already has this information on hand.  When we set the type as “hidden”, <code class="literal">f2py</code>
can automatically fill those values for us, essentially keeping them hidden from
us in the final python interface.</p><div class="example"><a id="f2py_diffusion"></a><div class="example-title">Example&nbsp;7-24.&nbsp;Fortran 2D Diffusion code with <code class="literal">f2py</code> annotations</div><div class="example-contents"><pre class="programlisting"><code class="k">SUBROUTINE </code><code class="nv">evolve</code><code class="p">(</code><code class="nv">grid</code><code class="p">,</code> <code class="nv">scratch</code><code class="p">,</code> <code class="nv">D</code><code class="p">,</code> <code class="nv">dt</code><code class="p">,</code> <code class="nv">N</code><code class="p">,</code> <code class="nv">M</code><code class="p">)</code>
    <code class="c">!f2py threadsafe</code>
    <code class="c">!f2py intent(in) grid</code>
    <code class="c">!f2py intent(inplace) scratch</code>
    <code class="c">!f2py intent(in) D</code>
    <code class="c">!f2py intent(in) dt</code>
    <code class="c">!f2py intent(hide) N</code>
    <code class="c">!f2py intent(hide) M</code>
    <code class="kt">INTEGER</code> <code class="kd">::</code> <code class="nv">N</code><code class="p">,</code> <code class="nv">M</code>
    <code class="kt">DOUBLE PRECISION</code><code class="p">,</code> <code class="k">DIMENSION</code><code class="p">(</code><code class="nv">N</code><code class="p">,</code><code class="nv">M</code><code class="p">)</code> <code class="kd">::</code> <code class="nv">grid</code><code class="p">,</code> <code class="nv">scratch</code>
    <code class="kt">DOUBLE PRECISION</code><code class="p">,</code> <code class="k">DIMENSION</code><code class="p">(</code><code class="nv">N</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code> <code class="nv">M</code><code class="o">-</code><code class="mi">2</code><code class="p">)</code> <code class="kd">::</code> <code class="nv">laplacian</code>
    <code class="kt">DOUBLE PRECISION</code> <code class="kd">::</code> <code class="nv">D</code><code class="p">,</code> <code class="nv">dt</code>

    <code class="nv">laplacian</code> <code class="o">=</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">3</code><code class="p">:</code><code class="nv">N</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">+</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">1</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">+</code> <code class="p">&amp;</code>
                <code class="nv">grid</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">3</code><code class="p">:</code><code class="nv">M</code><code class="p">)</code> <code class="o">+</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">2</code><code class="p">)</code> <code class="o">-</code> <code class="mi">4</code> <code class="o">*</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code>
    <code class="nv">scratch</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">=</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">+</code> <code class="nv">D</code> <code class="o">*</code> <code class="nv">dt</code> <code class="o">*</code> <code class="nv">laplacian</code>
<code class="k">END SUBROUTINE </code><code class="nv">evolve</code></pre></div></div><p>In order to build the code into a python module we run the following
command.  This will create a <code class="literal">diffusion.so</code> file which can be imported directly
into python.</p><pre class="programlisting"><code class="nv">$ </code>f2py -c -m diffusion --fcompiler<code class="o">=</code>gfortran --opt<code class="o">=</code><code class="s1">'-O3'</code> diffusion.f90</pre><p>If we play around with the resulting module interactively, we can see the
niceties which <code class="literal">f2py</code> has given us thanks to our annotations and its ability to
parse the Fortran code.</p><pre class="programlisting"><code class="go">In [1]: import diffusion</code>

<code class="go">In [2]: diffusion?</code>
<code class="go">Type:        module</code>
<code class="go">String form: &lt;module 'diffusion' from 'diffusion.so'&gt;</code>
<code class="go">File:        /Users/micha/projects/high_performance_python/notebooks/examples/compilation/f2py/diffusion.so</code>
<code class="go">Docstring:</code>
<code class="go">This module 'diffusion' is auto-generated with f2py (version:2).</code>
<code class="go">Functions:</code>
<code class="go">  evolve(grid,scratch,d,dt)</code>
<code class="go">.</code>

<code class="go">In [3]: diffusion.evolve?</code>
<code class="go">Type:        fortran</code>
<code class="go">String form: &lt;fortran object&gt;</code>
<code class="go">Docstring:</code>
<code class="go">evolve(grid,scratch,d,dt)</code>

<code class="go">Wrapper for ``evolve``.</code>

<code class="go">Parameters</code>
<code class="go">grid : input rank-2 array('d') with bounds (n,m)</code>
<code class="go">scratch :  rank-2 array('d') with bounds (n,m)</code>
<code class="go">d : input float</code>
<code class="go">dt : input float</code></pre><p>The code above shows that the result from the <code class="literal">f2py</code> generation is automatically
documented and the interface is quite simplified.  For example, instead of us
having to extract the sizes of the vectors, <code class="literal">f2py</code> has figured out how to
automatically find this information and simply hides it in the resulting
interface.  Infact, the resulting <code class="literal">evolve</code> function looks exactly the same in
its signature as the pure python version we wrote in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a>.</p><p>The only thing we must be careful of is the ordering of the numpy arrays in
memory.  Since most of what we do with numpy and python focuses on code derived
from C, we always use the C convention for ordering data in memory (called
row-major ordering).  Fortran uses a different convention (column-major
ordering) which we must make sure our vectors abide by.  These orderings simply
state whether, for a 2D array, columns or rows are contiguous in memory.
<sup>[<a id="id649677" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id649677" class="footnote">43</a>]</sup>.  Luckily, this simply means we
specify the <code class="literal">order='F'</code> parameter to numpy when declaring our vectors.</p><div class="note"><h3 class="title">Note</h3><p>The difference between row-major ordering and column-major ordering means that
the matrix <code class="literal">[[1, 2], [3, 4]]</code> gets stored in memory as <code class="literal">[1, 2, 3, 4]' for
row-major ordering and `[1, 3, 2, 4]</code> for column-major ordering.  The difference
is simply convention and doesn’t have any real implications to performance when
used
properly.</p></div><p>This results in the following code to use our Fortran subroutine.  This code
looks exactly the same as what we used in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a> except for
the import from the <code class="literal">f2py</code> derived library and the explicit Fortran ordering of
our data.</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">diffusion</code> <code class="kn">import</code> <code class="n">evolve</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="n">scratch</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">double</code><code class="p">,</code> <code class="n">order</code><code class="o">=</code><code class="s">'F'</code><code class="p">)</code> <code class="c">#</code><a id="CO14-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">grid</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">double</code><code class="p">,</code> <code class="n">order</code><code class="o">=</code><code class="s">'F'</code><code class="p">)</code>

    <code class="o">...</code> <code class="n">standard</code> <code class="n">initialization</code> <code class="o">...</code>

    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mf">0.1</code><code class="p">)</code>
        <code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code> <code class="o">=</code> <code class="n">scratch</code><code class="p">,</code> <code class="n">grid</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO14-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
FORTRAN orders numbers differently in memory so we must remember to set our numpy arrays to use that standard
</p></dd></dl></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_cpython_module">cpython module</h3></div></div></div><p>Finally, we can always go right down to the cpython API level and write a
cpython module.  This requires us to write code in the same way that cpython is
developed and take care of all of the interactions between our code and
implementation of cpython.</p><p>This has the advantage that it is incredibly portable given the python version.
We don’t require any external modules or libraries, just a C compiler and
python!  However, this doesn’t necessarily scale well to new versions of python.
For example, cpython modules written for python 2.7 will take some work to work
with python 3.</p><p>However, that portability comes at a big cost—you are responsible for every
aspect of the interface between your python code and the module.  This can make
even the simplest tasks take dozens of lines of code simply.  For example, to
interface the diffusion library from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#c_diffusion_2d">Example&nbsp;7-20</a>, we must write 28 lines
of code simply to read the arguments to a function and parse them
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling_cpython_module">Example&nbsp;7-25</a>).</p><p>This does mean that you have incredible fine grained control over what is
happening.  This goes all the way down to being able to manually change the
reference counts for python’s garbage collection (which can be the cause of a
lot of pain when creating cpython modules that deal with native python types).
Because of this, the resulting code tends to be minutely faster than other
interface methods.</p><p>All in all, this method should be left as a last resort.  While it is quite
informative to write a cpython module, the resulting code is not as reusable or
maintainable than other potential methods.  Making subtle changes in the module
can often requite completely reworking the module.  In fact, we include the
module code and the required <code class="literal">setup.py</code> to compile it
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling_cpython_module_setup">Example&nbsp;7-26</a>) as a cautionary tale.</p><div class="example"><a id="compiling_cpython_module"></a><div class="example-title">Example&nbsp;7-25.&nbsp;CPython module to interface to the 2D diffusion library</div><div class="example-contents"><pre class="programlisting"><code class="c1">// python_interface.c</code>
<code class="c1">// - cpython module interface for diffusion.c</code>
<code class="cp">#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION</code>

<code class="cp">#include &lt;Python.h&gt;</code>
<code class="cp">#include &lt;numpy/arrayobject.h&gt;</code>
<code class="cp">#include "diffusion.h"</code>

<code class="cm">/* Docstrings */</code>
<code class="k">static</code> <code class="kt">char</code> <code class="n">module_docstring</code><code class="p">[]</code> <code class="o">=</code>
    <code class="s">"Provides optimized method to solve the diffusion equation"</code><code class="p">;</code>
<code class="k">static</code> <code class="kt">char</code> <code class="n">cdiffusion_evolve_docstring</code><code class="p">[]</code> <code class="o">=</code>
    <code class="s">"Evolve a 2D grid using the diffusion equation"</code><code class="p">;</code>

<code class="n">PyArrayObject</code><code class="o">*</code> <code class="nf">py_evolve</code><code class="p">(</code><code class="n">PyObject</code><code class="o">*</code> <code class="n">self</code><code class="p">,</code> <code class="n">PyObject</code><code class="o">*</code> <code class="n">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">PyArrayObject</code><code class="o">*</code> <code class="n">data</code><code class="p">;</code>
    <code class="n">PyArrayObject</code><code class="o">*</code> <code class="n">scratch</code><code class="p">;</code>
    <code class="kt">double</code> <code class="n">dt</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mf">1.0</code><code class="p">;</code>

    <code class="cm">/* The "evolve" function will have the signature:</code>
<code class="cm">     *     evolve(data, scratch, dt, D=1)</code>
<code class="cm">     */</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">PyArg_ParseTuple</code><code class="p">(</code><code class="n">args</code><code class="p">,</code> <code class="s">"OOd|d"</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">data</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">scratch</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">dt</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">D</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code> <code class="s">"Invalid arguments"</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="cm">/* Make sure that the numpy arrays are contiguous in memory */</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">PyArray_Check</code><code class="p">(</code><code class="n">data</code><code class="p">)</code> <code class="o">||</code> <code class="o">!</code><code class="n">PyArray_ISCONTIGUOUS</code><code class="p">(</code><code class="n">data</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"data is not a contiguous array."</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">PyArray_Check</code><code class="p">(</code><code class="n">scratch</code><code class="p">)</code> <code class="o">||</code> <code class="o">!</code><code class="n">PyArray_ISCONTIGUOUS</code><code class="p">(</code><code class="n">scratch</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"scratch is not a contiguous array."</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="cm">/* Make sure that grid and scratch are of the same type and have the same</code>
<code class="cm">     * dimensions</code>
<code class="cm">     */</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">PyArray_TYPE</code><code class="p">(</code><code class="n">data</code><code class="p">)</code> <code class="o">!=</code> <code class="n">PyArray_TYPE</code><code class="p">(</code><code class="n">scratch</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"scratch and data should have same type."</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">PyArray_NDIM</code><code class="p">(</code><code class="n">data</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"data should be two dimensional"</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">PyArray_NDIM</code><code class="p">(</code><code class="n">scratch</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"scratch should be two dimensional"</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">((</code><code class="n">PyArray_DIM</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code class="mi">0</code><code class="p">)</code> <code class="o">!=</code> <code class="n">PyArrayDim</code><code class="p">(</code><code class="n">scratch</code><code class="p">,</code><code class="mi">0</code><code class="p">))</code> <code class="o">||</code>
        <code class="p">(</code><code class="n">PyArray_DIM</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code> <code class="o">!=</code> <code class="n">PyArrayDim</code><code class="p">(</code><code class="n">scratch</code><code class="p">,</code><code class="mi">1</code><code class="p">)))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"data and scratch must have the same dimensions"</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="cm">/* Fetch the size of the grid we are working with */</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">N</code> <code class="o">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="n">PyArray_DIM</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">M</code> <code class="o">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="n">PyArray_DIM</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

    <code class="n">evolve</code><code class="p">(</code>
        <code class="n">N</code><code class="p">,</code>
        <code class="n">M</code><code class="p">,</code>
        <code class="n">PyArray_DATA</code><code class="p">(</code><code class="n">data</code><code class="p">),</code>
        <code class="n">PyArray_DATA</code><code class="p">(</code><code class="n">scratch</code><code class="p">),</code>
        <code class="n">D</code><code class="p">,</code>
        <code class="n">dt</code>
    <code class="p">);</code>

    <code class="n">Py_XINCREF</code><code class="p">(</code><code class="n">scratch</code><code class="p">);</code>
    <code class="k">return</code> <code class="n">scratch</code><code class="p">;</code>
<code class="p">}</code>

<code class="cm">/* Module specification */</code>
<code class="k">static</code> <code class="n">PyMethodDef</code> <code class="n">module_methods</code><code class="p">[]</code> <code class="o">=</code> <code class="p">{</code>
<code class="cm">/* { python method name , C function , argument types , docstring                   } */</code>
   <code class="p">{</code> <code class="s">"evolve"</code>           <code class="p">,</code> <code class="n">py_evolve</code>  <code class="p">,</code> <code class="n">METH_VARARGS</code>   <code class="p">,</code> <code class="n">cdiffusion_evolve_docstring</code> <code class="p">}</code>    <code class="p">,</code>
   <code class="p">{</code> <code class="nb">NULL</code>               <code class="p">,</code> <code class="nb">NULL</code>       <code class="p">,</code> <code class="mi">0</code>              <code class="p">,</code> <code class="nb">NULL</code>                        <code class="p">}</code>
<code class="p">};</code>

<code class="cm">/* Initialize the module */</code>
<code class="n">PyMODINIT_FUNC</code> <code class="nf">initcdiffusion</code><code class="p">(</code><code class="kt">void</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">PyObject</code> <code class="o">*</code><code class="n">m</code> <code class="o">=</code> <code class="n">Py_InitModule3</code><code class="p">(</code><code class="s">"cdiffusion"</code><code class="p">,</code> <code class="n">module_methods</code><code class="p">,</code> <code class="n">module_docstring</code><code class="p">);</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">m</code> <code class="o">==</code> <code class="nb">NULL</code><code class="p">)</code>
        <code class="k">return</code><code class="p">;</code>

    <code class="cm">/* Load `numpy` functionality. */</code>
    <code class="n">import_array</code><code class="p">();</code>
<code class="p">}</code></pre></div></div><p>In order to build the above code, we need to create a <code class="literal">setup.py</code> script which
uses the <code class="literal">distutils</code> module to figure out how to build the code such that it is
python compatible.  In addition to the standard <code class="literal">distutils</code> module, <code class="literal">numpy</code>
provides it’s own module to help with adding <code class="literal">numpy</code> integration in your cpython
modules.</p><div class="example"><a id="compiling_cpython_module_setup"></a><div class="example-title">Example&nbsp;7-26.&nbsp;Setup file for the cpython module diffusion interface</div><div class="example-contents"><pre class="programlisting"><code class="sd">"""</code>
<code class="sd">setup.py for cpython diffusion module.  The extention can be built by running</code>

<code class="sd">    $ python setup.py build_ext --inplace</code>

<code class="sd">which will create the "cdiffusion.so" file which can be directly imported into</code>
<code class="sd">python</code>
<code class="sd">"""</code>

<code class="kn">from</code> <code class="nn">distutils.core</code> <code class="kn">import</code> <code class="n">setup</code><code class="p">,</code> <code class="n">Extension</code>
<code class="kn">import</code> <code class="nn">numpy.distutils.misc_util</code>

<code class="n">__version__</code> <code class="o">=</code> <code class="s">"0.1"</code>

<code class="n">cdiffusion</code> <code class="o">=</code> <code class="n">Extension</code><code class="p">(</code>
    <code class="s">'cdiffusion'</code><code class="p">,</code>
    <code class="n">sources</code> <code class="o">=</code> <code class="p">[</code><code class="s">'cdiffusion/cdiffusion.c'</code><code class="p">,</code> <code class="s">'cdiffusion/python_interface.c'</code><code class="p">],</code>
    <code class="n">extra_compile_args</code> <code class="o">=</code> <code class="p">[</code><code class="s">"-O3"</code><code class="p">,</code> <code class="s">"-std=c99"</code><code class="p">,</code> <code class="s">"-Wall"</code><code class="p">,</code> <code class="s">"-p"</code><code class="p">,</code> <code class="s">"-pg"</code><code class="p">,</code> <code class="p">],</code>
    <code class="n">extra_link_args</code> <code class="o">=</code> <code class="p">[</code><code class="s">"-lc"</code><code class="p">],</code>
<code class="p">)</code>

<code class="n">setup</code> <code class="p">(</code>
    <code class="n">name</code> <code class="o">=</code> <code class="s">'diffusion'</code><code class="p">,</code>
    <code class="n">version</code> <code class="o">=</code> <code class="n">__version__</code><code class="p">,</code>
    <code class="n">ext_modules</code> <code class="o">=</code> <code class="p">[</code><code class="n">cdiffusion</code><code class="p">,],</code>
    <code class="n">packages</code> <code class="o">=</code> <code class="p">[</code><code class="s">"diffusion"</code><code class="p">,</code> <code class="p">],</code>
    <code class="n">include_dirs</code> <code class="o">=</code> <code class="n">numpy</code><code class="o">.</code><code class="n">distutils</code><code class="o">.</code><code class="n">misc_util</code><code class="o">.</code><code class="n">get_numpy_include_dirs</code><code class="p">(),</code>
<code class="p">)</code></pre></div></div><p>The result from this is a <code class="literal">cdiffusion.so</code> file which can be imported directly
from python and used quite easily.  Since we had complete control over the
signature of the resulting function and exactly how our C code interacted with
the library, we were able to (with some hard work) create an module which is
easy to use.</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">cdiffusion</code> <code class="kn">import</code> <code class="n">evolve</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="n">scratch</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">double</code><code class="p">)</code>
    <code class="n">grid</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">double</code><code class="p">)</code>

    <code class="o">...</code> <code class="n">standard</code> <code class="n">initialization</code> <code class="o">...</code>

    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mf">0.1</code><code class="p">)</code>
        <code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code> <code class="o">=</code> <code class="n">scratch</code><code class="p">,</code> <code class="n">grid</code></pre></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_wrap_up_5">Wrap Up</h2></div></div></div><p>The various strategies introduced in this chapter allow you to specialize your
code to different amounts in order to reduce the number of instructions the CPU
must execute and increase the efficiency of our programs.  Sometimes this can be
done algorithmically, however many times it must be done manually
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#jit_vs_compiler">JITs vs Compilers</a>).  Furthermore, sometimes these methods must be employed
simply to use libraries that have already been written in other languages.
Regardless of the motivation, Python allows us to benefit from the speedups that
other languages can offer on some problems, while still maintaining the
verbosity and flexibility for other problems.</p><p>It is important to note though that these optimizations are done in order to
optimize the efficiency of CPU instructions only.  Sometimes, if you have IO
bound processes coupled to a CPU bound problem, simply compiling your code will
not provide any reasonable speedups.  For these problems, we must rethink how we
are solving the problem and potentially use parallelism to run different tasks
at the same time.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id620693"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id620693" class="simpara">17</a>] </sup><a class="ulink" href="http://cython.org/" target="_top">http://cython.org/</a></p></div><div class="footnote" id="ftn.id645371"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id645371" class="simpara">18</a>] </sup><a class="ulink" href="http://code.google.com/p/shedskin/" target="_top">http://code.google.com/p/shedskin/</a></p></div><div class="footnote" id="ftn.id351851"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id351851" class="simpara">19</a>] </sup><a class="ulink" href="http://numba.pydata.org/" target="_top">http://numba.pydata.org/</a></p></div><div class="footnote" id="ftn.id351999"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id351999" class="simpara">20</a>] </sup><a class="ulink" href="http://docs.continuum.io/numbapro/" target="_top">http://docs.continuum.io/numbapro/</a></p></div><div class="footnote" id="ftn.id352019"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352019" class="simpara">21</a>] </sup><a class="ulink" href="http://pythonhosted.org/pythran/" target="_top">http://pythonhosted.org/pythran/</a></p></div><div class="footnote" id="ftn.id352187"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352187" class="simpara">22</a>] </sup><a class="ulink" href="http://pypy.org/" target="_top">http://pypy.org/</a></p></div><div class="footnote" id="ftn.id352373"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352373" class="simpara">23</a>] </sup><a class="ulink" href="http://pypy.readthedocs.org/en/latest/cpython_differences.html" target="_top">http://pypy.readthedocs.org/en/latest/cpython_differences.html</a></p></div><div class="footnote" id="ftn.id352311"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352311" class="simpara">24</a>] </sup><a class="ulink" href="http://pypy.readthedocs.org/en/latest/garbage_collection.html" target="_top">http://pypy.readthedocs.org/en/latest/garbage_collection.html</a></p></div><div class="footnote" id="ftn.id352430"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352430" class="simpara">25</a>] </sup><a class="ulink" href="https://bitbucket.org/pypy/compatibility/wiki/c-api" target="_top">https://bitbucket.org/pypy/compatibility/wiki/c-api</a></p></div><div class="footnote" id="ftn.id352450"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352450" class="simpara">26</a>] </sup><a class="ulink" href="http://ianozsvald.com/2014/01/14/installing-the-numpy-module-in-pypy/" target="_top">http://ianozsvald.com/2014/01/14/installing-the-numpy-module-in-pypy/</a></p></div><div class="footnote" id="ftn.id352476"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352476" class="simpara">27</a>] </sup><a class="ulink" href="https://mail.python.org/pipermail/pypy-dev/2014-February/012232.html" target="_top">https://mail.python.org/pipermail/pypy-dev/2014-February/012232.html</a></p></div><div class="footnote" id="ftn.id352470"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352470" class="simpara">28</a>] </sup><a class="ulink" href="https://bitbucket.org/pypy/compatibility/wiki/Home" target="_top">https://bitbucket.org/pypy/compatibility/wiki/Home</a></p></div><div class="footnote" id="ftn.id352506"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352506" class="simpara">29</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Software_transactional_memory" target="_top">http://en.wikipedia.org/wiki/Software_transactional_memory</a></p></div><div class="footnote" id="ftn.id352520"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352520" class="simpara">30</a>] </sup><a class="ulink" href="https://bitbucket.org/pypy/jitviewer" target="_top">https://bitbucket.org/pypy/jitviewer</a></p></div><div class="footnote" id="ftn.id352492"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352492" class="simpara">31</a>] </sup><a class="ulink" href="http://morepypy.blogspot.co.uk/2009/11/hi-all-this-week-i-worked-on-improving.html" target="_top">http://morepypy.blogspot.co.uk/2009/11/hi-all-this-week-i-worked-on-improving.html</a></p></div><div class="footnote" id="ftn.id354259"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354259" class="simpara">32</a>] </sup><a class="ulink" href="http://compilers.pydata.org/" target="_top">http://compilers.pydata.org/</a></p></div><div class="footnote" id="ftn.id354270"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354270" class="simpara">33</a>] </sup><a class="ulink" href="http://deeplearning.net/software/theano/" target="_top">http://deeplearning.net/software/theano/</a></p></div><div class="footnote" id="ftn.id354351"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354351" class="simpara">34</a>] </sup><a class="ulink" href="http://www.parakeetpython.com/" target="_top">http://www.parakeetpython.com/</a></p></div><div class="footnote" id="ftn.id354325"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354325" class="simpara">35</a>] </sup><a class="ulink" href="http://viennacl.sourceforge.net/pyviennacl.html" target="_top">http://viennacl.sourceforge.net/pyviennacl.html</a></p></div><div class="footnote" id="ftn.id354292"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354292" class="simpara">36</a>] </sup><a class="ulink" href="http://nuitka.net/pages/overview.html" target="_top">http://nuitka.net/pages/overview.html</a></p></div><div class="footnote" id="ftn.id354368"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354368" class="simpara">37</a>] </sup><a class="ulink" href="https://github.com/dropbox/pyston" target="_top">https://github.com/dropbox/pyston</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id354465"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354465" class="simpara">38</a>] </sup>For simplicity we will not implement the
boundary conditions</p></div><div class="footnote" epub:type="footnote" id="ftn.id355197"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id355197" class="simpara">39</a>] </sup>This is very
cpython dependant.  Other version of python may have their own version of ctypes
which may work very differently</p></div><div class="footnote" id="ftn.id648494"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id648494" class="simpara">40</a>] </sup><a class="ulink" href="http://www.netlib.org/lapack/" target="_top">http://www.netlib.org/lapack/</a></p></div><div class="footnote" id="ftn.id648537"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id648537" class="simpara">41</a>] </sup><a class="ulink" href="http://www.netlib.org/blas/" target="_top">http://www.netlib.org/blas/</a></p></div><div class="footnote" id="ftn.id648511"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id648511" class="simpara">42</a>] </sup><a class="ulink" href="http://docs.scipy.org/doc/numpy-dev/f2py/" target="_top">http://docs.scipy.org/doc/numpy-dev/f2py/</a></p></div><div class="footnote" id="ftn.id649677"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id649677" class="simpara">43</a>] </sup>For more information, see
<a class="ulink" href="http://en.wikipedia.org/wiki/Row-major_order" target="_top">http://en.wikipedia.org/wiki/Row-major_order</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch06.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">6. Matrix and Vector Computation</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch08.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">8. Concurrency</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch07.html" data-for-analytics="9781449361747:ch07.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch08.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch08.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch08.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch08.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>8. Concurrency - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch08.html"><meta name="description" content="Chapter&nbsp;8.&nbsp;Concurrency Questions you’ll be able to answer after this chapter What is concurrency and how is it helpful? What is the difference between concurrency and parallelism? Which ... "><meta property="og:title" content="8. Concurrency"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="8. Concurrency"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;8.&nbsp;Concurrency Questions you’ll be able to answer after this chapter What is concurrency and how is it helpful? What is the difference between concurrency and parallelism? Which ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch08.html" data-for-analytics="9781449361747:ch08.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%208.%20Concurrency&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch07.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">7. Compiling to C</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch09.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">9. The multiprocessing module</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-concurrency"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;8.&nbsp;Concurrency</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
What is concurrency and how is it helpful?
</li><li class="listitem">
What is the difference between concurrency and parallelism?
</li><li class="listitem">
Which tasks can be done concurrently and which can’t?
</li><li class="listitem">
What are the various paradigms for concurrency?
</li><li class="listitem">
When is the right time to take advantage of concurrency?
</li><li class="listitem">
How can concurrency speed up my programs?
</li></ul></div></div><p>IO can be quite burdensome to the flow of a program.  Every time your code reads
from a file or writes to a network socket, your code pauses contacts the kernel,
requests the operation to happen, and then wait for it to complete.  This may
not seem like the end of the world, especially after realizing that a similar
operation happens every time memory is allocated, however if we look back to
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#FIG-performant-connection-speed">Figure&nbsp;1-3</a> we see that most of the IO operations we
perform are on devices that are orders of magnitude slower than the CPU.</p><p>For example, in the time it takes to write to a network socket, an operation
that typically takes about 1ms, we could have done 2,400,000 instructions while
waiting (on a 2.4GHz computer).  Worst of all, our program is halted for much of
this 1ms time—our execution is paused and we are waiting for a signal that
the write operation has completed.  This time you spend in a paused state is
called “IO wait”.</p><p>Concurrency helps us utilize this wasted time by allow us to perform other
operations while waiting for an IO operation to complete.  For example, in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_vs_concurrent">Figure&nbsp;8-1</a> we see a depiction of a program that must run 3
tasks, all of which have periods of IO wait within them.  If we run them
serially then we suffer the IO wait penalty 3 times.  However, if we run these
tasks concurrently we can essentially hide the wait time by running another task
in the meantime.  It is important to note that this is all still happening on a
single thread and still only uses 1 CPU at a time!</p><p>While concurrency isn’t simply limited to IO, this is the time when it really
performs the best.  What happens in a concurrent program is that instead of
having your code run serially, that is from one line to the next, your code is
written to handle events and different parts of your code run when different
events happen.</p><p>By modeling a program in this way, we are able to deal with the particular event
that we are concerned with: IO wait.</p><div class="figure"><a id="conn_serial_vs_concurrent"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 432; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/serial_vs_concurrent.png.jpg" alt="Comparison between serial and concurrent programs" width="781" height="376" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/serial_vs_concurrent.png.jpg"></div></div><div class="figure-title">Figure&nbsp;8-1.&nbsp;Comparison between serial and concurrent programs</div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_introduction_to_async">Introduction to Async</h2></div></div></div><p>When a program enters IO wait, the execution is exchanged to the kernel (called
a context switch) and is not resumed until the IO operation is completed.
Context switches are quite a heavy operation.  It requires us to save the state
of our program (losing any sort of caching we had at the CPU level) and give up
the use of the CPU.  Later, when we are allowed to run again, we must spend the
time re-initializing our program on the motherboard and getting ready to resume
(of course, all this happens behind the scenes).</p><p>With concurrency, on the other hand, we typically have a thing called an “event
loop” running which manages what gets to run in our program, and when.  In it’s
essence, an event loop  is simply a list of functions that need to get run.  The
function at the top of the list gets run, then the next, etc.</p><div class="example"><a id="conn_toy_eventloop"></a><div class="example-title">Example&nbsp;8-1.&nbsp;Toy Eventloop</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">Queue</code> <code class="kn">import</code> <code class="n">Queue</code>
<code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>

<code class="n">eventloop</code> <code class="o">=</code> <code class="bp">None</code>

<code class="k">class</code> <code class="nc">EventLoop</code><code class="p">(</code><code class="n">Queue</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">start</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>
            <code class="n">function</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get</code><code class="p">()</code>
            <code class="n">function</code><code class="p">()</code>

<code class="k">def</code> <code class="nf">do_hello</code><code class="p">():</code>
    <code class="k">global</code> <code class="n">eventloop</code>
    <code class="k">print</code> <code class="s">"Hello"</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">do_world</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">do_world</code><code class="p">():</code>
    <code class="k">global</code> <code class="n">eventloop</code>
    <code class="k">print</code> <code class="s">"world"</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">do_hello</code><code class="p">)</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="n">eventloop</code> <code class="o">=</code> <code class="n">EventLoop</code><code class="p">()</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">do_hello</code><code class="p">)</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">start</code><code class="p">()</code></pre></div></div><p>This may seem like the same as before, however we can couple it to asynchronous
IO operations.  These operations are non-blocking, meaning if we do a network
write with an async function, it will return right away even though the write
has not happened yet.  When the write has completed, however, an event fires and
our program can know about it.</p><p>Putting these two concepts together, we can have a program that, when an IO
operation is requested, runs other functions while we wait for the original IO
operation to complete.  This essentially allows us to still do meaningful
calculation while we would otherwise have been in IO wait.</p><div class="note"><h3 class="title">Note</h3><p>Switching from function to function does have a cost.  We must set up the
function in memory to be called and we probably won’t have the cache that may
have set up before.  It is because of this that concurrency is best when your
program has a lot of IO wait—while this switching does have a cost to it it
can be much less than what is gained by making IO wait useful.</p></div><p>Programming using event loops can take on two forms: callbacks or futures.  In
the callback paradigm, functions are called with an argument which is generally
called the “callback”.  Instead of the function returning it’s value, it calls
the callback function with the value instead.  This sets up long chains of
functions which are called, each getting the result of the previous function in
the chain.</p><div class="example"><a id="id805646"></a><div class="example-title">Example&nbsp;8-2.&nbsp;Example with Callbacks</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>
<code class="k">def</code> <code class="nf">save_value</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="n">callback</code><code class="p">):</code>
    <code class="k">print</code> <code class="s">"Saving {} to database"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">save_result_to_db</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="c"># </code><a id="CO15-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">

<code class="k">def</code> <code class="nf">print_response</code><code class="p">(</code><code class="n">db_response</code><code class="p">):</code>
    <code class="k">print</code> <code class="s">"Response from database: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">db_response</code><code class="p">)</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code>
        <code class="n">partial</code><code class="p">(</code><code class="n">save_value</code><code class="p">,</code> <code class="s">"Hello World"</code><code class="p">,</code> <code class="n">print_response</code><code class="p">)</code>
    <code class="p">)</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO15-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
<code class="literal">save_result_to_db</code> is an asynchronous function and will return immediately and the function will end and allow other code to run.  However, once the data is ready, <code class="literal">print_response</code> will be called.
</p></dd></dl></div></div></div><p>With futures, on the other hand, an asynchronous function returns a promise of a
future result instead of the actual result.  Because of this, we must wait for
the future that is returned by this sort of asynchronous function to complete
and be filled with the value we desire (either by doing a <code class="literal">yield</code> on it or by
running a function that explicitly waits for a value to be ready).  This allows
us to do other calculations while waiting for the future object to be filled
with the data we requested.  If we couple this with the concept of generators,
functions that can be paused and whose execution can later be resumed, we can
write asynchronous code that looks very close to serial code in form.</p><pre class="programlisting"><code class="nd">@coroutine</code>
<code class="k">def</code> <code class="nf">save_value</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="n">callback</code><code class="p">):</code>
    <code class="k">print</code> <code class="s">"Saving {} to database"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">db_response</code> <code class="o">=</code> <code class="k">yield</code> <code class="n">save_result_to_db</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="c"># </code><a id="CO16-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="k">print</code> <code class="s">"Response from database: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">db_response</code><code class="p">)</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code>
        <code class="n">partial</code><code class="p">(</code><code class="n">save_value</code><code class="p">,</code> <code class="s">"Hello World"</code><code class="p">)</code>
    <code class="p">)</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO16-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
In this case, <code class="literal">save_result_to_db</code> returns a <code class="literal">Future</code> type.  By yielding from it, <code class="literal">save_value</code> gets paused until the value is ready and then the function results.
</p></dd></dl></div><p>In python, coroutines are implemented as generators.  This is convenient because
generators already have the machinery to pause their execution and resume later.
So, what happens, is our coroutine will yield a future and the event loop will
wait until that future has it’s value ready.  Once this happens, the event loop
will resume execution of that function, sending back to it the value of the
future.  For python 2.7 implementations of future-based concurrency, things can
get a bit strange when trying to use coroutines as actual functions. Remember
that generators cannot return values, so there are various ways libraries deal
with this issue.  In python 3.4 however, new machinery has been introduced in
order to easily create coroutines and have them still return values.</p><p>In this chapter we will analyze a web crawler which fetches data from an HTTP
server that has latency built into it.  This represents the general response
time latency that will occur whenever dealing with IO.  We will first create a
serial crawler that looks like the naive python solution to this problem.  Then
we will go through two solutions in python 2.7—<code class="literal">gevent</code> and <code class="literal">tornado</code>.
Finally, we will look at the <code class="literal">asyncio</code> library in python 3.4 and see what the
future of asynchronous programming in python looks like.</p><div class="note"><h3 class="title">Note</h3><p>The web server we implemented can support multiple connections at a time.  This
will be true for most services that you will be performing IO with—most
databases can support multiple requests at a time and most web servers support
10K+ simultaneous connections.  However, when interacting with a service that
cannot do multiple connections at a time <sup>[<a id="id806261" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id806261" epub:type="noteref" class="footnote">44</a>]</sup>, we will
always have the same performance as the serial case.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_serial_crawler">Serial Crawler</h2></div></div></div><p>For the control in our experiment with concurrency we will write a serial web
scraper that takes a list of URL’s, fetches them, and sums the total length of
the content from the pages.  We will use a custom HTTP server that takes two
parameters, <code class="literal">name</code> and <code class="literal">delay</code>.  The <code class="literal">delay</code> field will tell the server how
long, in milliseconds, to pause before responding.  The <code class="literal">name</code> field is simply
for logging purposes.</p><p>By controlling the <code class="literal">delay</code> parameter, we can simulate the time it takes a server
to respond to our query.  In the real world, this could correspond to a slow web
server, a strenuous database call or any IO call which takes a long time to
perform.  For the serial case, this simply represents more time that our program
will be stuck in IO wait, but in the concurrent examples later it will represent
more time the program can spend doing other things.</p><p>In addition, we chose to use the <code class="literal">requests</code> module to perform the HTTP call.
This choice is simply because of the simplicity of the module.  We use HTTP in
general for this section because it is a simple example of IO and can be
performed quite easily.  In general, any call to a HTTP library can be replaced
with any IO.</p><div class="example"><a id="conn_serial_http"></a><div class="example-title">Example&nbsp;8-3.&nbsp;Serial HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">requests</code>
<code class="kn">import</code> <code class="nn">string</code>
<code class="kn">import</code> <code class="nn">random</code>

<code class="k">def</code> <code class="nf">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_urls</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    We add random characters to the end of the URL to break any caching</code>
<code class="sd">    mechanisms in the requests library or the server</code>
<code class="sd">    """</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">num_urls</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">base_url</code> <code class="o">+</code> <code class="s">""</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">response_size</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">url</code> <code class="ow">in</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>
        <code class="n">response_size</code> <code class="o">+=</code> <code class="nb">len</code><code class="p">(</code><code class="n">response</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">response_size</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="kn">import</code> <code class="nn">time</code>
    <code class="n">delay</code> <code class="o">=</code> <code class="mi">100</code>
    <code class="n">num_iter</code> <code class="o">=</code> <code class="mi">500</code>
    <code class="n">base_url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?name=serial&amp;delay={}&amp;"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">delay</code><code class="p">)</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="n">result</code> <code class="o">=</code> <code class="n">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">end</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">print</code><code class="p">(</code><code class="s">"Result: {}, Time: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">end</code> <code class="o">-</code> <code class="n">start</code><code class="p">))</code></pre></div></div><p>When running this code, an interesting metric to look at is the start and stop
time of each request as seen by the HTTP server.  This tells us how efficient
our code was during IO wait—since our task is simply to launch HTTP requests
and then sum the number of characters that were returned we should be able to
launch more HTTP requests, and process any responses, while waiting for other
requests to complete.</p><div class="figure"><a id="conn_serial_request_time"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/serial.png" alt="Request times for serial scraper" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/serial.png"></div></div><div class="figure-title">Figure&nbsp;8-2.&nbsp;Request Time for <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_http">Example&nbsp;8-3</a></div></div><p>We can see from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_request_time">Figure&nbsp;8-2</a> that, as expected, there is no
interleaving of our requests.  We do one request at a time and wait for the
previous request to happen before we move to the next request.  In fact, the
total run-time of the serial process makes perfect sense knowing this.  Since
each request takes 0.1s (because of our <code class="literal">delay</code> parameter) and we are doing 500
requests, we expect this runtime to be about 50s.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_gevent">Gevent</h2></div></div></div><p>One of the simplest asynchronous libraries is <code class="literal">gevent</code>.  It follows the paradigm
of having asynchronous functions return futures which means most of the logic in
your code can stay the same.  In addition, gevent monkey patches the standard IO
functions to be asynchronous, so most of the time you can simply use the
standard IO packages and benefit from asynchronous behaviour.</p><p>Gevent provides two mechanisms to enable asynchronous programming—as
mentioned before, it patches the standard library with asynchronous IO
functions, and it has a <code class="literal">Greenlets</code> object which can be used for concurrent
execution.  A greenlet is a type of coroutine and can be thought of as a thread
(see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html">Chapter&nbsp;9</a> for a discussion on threads), however all greenlets run
on the same physical thread.  Instead of using multiple CPU’s to run all the
greenlets, they are switched between during IO wait by use of an event loop.
For the most part, <code class="literal">gevent</code> tries to make the handling of the event loop as
transparent as possible through the use of <code class="literal">wait</code> functions.  The <code class="literal">wait</code>
function will start an event loop and run it as long as it needs for all
greenlets to finish.  Because of this, most of your gevent code will run
serially, then at some point you will set up many greenlets to do some
concurrent task and the start the event loop with the <code class="literal">wait</code> function.  While
the <code class="literal">wait</code> function is executing, all of the concurrent tasks you have queued up
will run until completion (or some stopping condition), and then your code will
go back to being serial again.</p><p>The futures are created with <code class="literal">gevent.spawn</code>, which takes a function and the
arguments to that function and launches a greenlet which is responsible for
running that function.  The greenlet can be though of as a future since, once
the function we specified completes, it’s value will be contained within the
greenlet’s <code class="literal">value</code> field.  However, we have launched as many greenlets as we
have URL’s, we need a mechanism to limit how many HTTP requests we make at a
time.</p><p>This patching of python standard modules can make it harder to control the
subtleties of what is going on.  For example, one thing we want to make sure
when doing async IO is that we don’t open too many files or connections at one
time.  If we do this, we can overload the remote server or slow down our process
by having to context switch between too many operations.</p><p>In order to do this manually, we use a Semaphore to only do HTTP gets from 100
greenlets at a time.  A semaphore works by making sure that only a certain
number of coroutines can enter the context block at a time.  As a result, we
launch all the greenelts that we need in order to fetch the URL’s right away,
however only 100 of them can make HTTP calls at a time.  Semaphore’s are one
type of locking mechanism used a lot in various parallel code flows.  By
restricting the progression of your code based on various rules, locks can help
you make sure that the various components of your program don’t interfere with
eachother.</p><div class="figure"><a id="conn_num_concurrent_requests"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/parallel_requests.png" alt="Experimenting with different numbers of concurrent requests for various request times" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/parallel_requests.png"></div></div><div class="figure-title">Figure&nbsp;8-3.&nbsp;Finding the right number of concurrent requests</div></div><p>Now that we have all the futures set up and have put in a locking mechanism to
control the flow of the greenlets, we can wait until we start having results by
using the the <code class="literal">gevent.iwait</code> function which will take a sequence of futures and
iterate over the ready items.  Conversely, we could have used <code class="literal">gevent.wait</code>
which would block execution of our program until all requests are done.</p><p>We go through the trouble of chunking our requests instead of sending them all
at once because overloading the eventloop can cause performnce decreases (and
this is true for all asynchronous programming).  From experimentation, we
generally see that 100 or so open connections at a time is optimal.  If we were
to use less, we would still have wasted time during IO wait.  With more, then we
are switching contexts too often in the event loop and adding unecissary
overhead to our program.  That being said, this value of 100 depends on many
things—the computer the code is being run on, the implemintation of the event
loop, the properties of the remote host, the expect time to respond of the
remote server, etc.  I recommend doing some experimentation before settling on a
choice.</p><div class="example"><a id="conn_grequest_http"></a><div class="example-title">Example&nbsp;8-4.&nbsp;GEvent HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">gevent</code> <code class="kn">import</code> <code class="n">monkey</code>
<code class="n">monkey</code><code class="o">.</code><code class="n">patch_socket</code><code class="p">()</code>

<code class="kn">import</code> <code class="nn">gevent</code>
<code class="kn">from</code> <code class="nn">gevent.coros</code> <code class="kn">import</code> <code class="n">Semaphore</code>
<code class="kn">import</code> <code class="nn">urllib2</code>
<code class="kn">import</code> <code class="nn">string</code>
<code class="kn">import</code> <code class="nn">random</code>

<code class="k">def</code> <code class="nf">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_urls</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">num_urls</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">base_url</code> <code class="o">+</code> <code class="s">""</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>

<code class="k">def</code> <code class="nf">chunked_requests</code><code class="p">(</code><code class="n">urls</code><code class="p">,</code> <code class="n">chunk_size</code><code class="o">=</code><code class="mi">100</code><code class="p">):</code>
    <code class="n">semaphore</code> <code class="o">=</code> <code class="n">Semaphore</code><code class="p">(</code><code class="n">chunk_size</code><code class="p">)</code> <code class="c"># </code><a id="CO17-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">requests</code> <code class="o">=</code> <code class="p">[</code><code class="n">gevent</code><code class="o">.</code><code class="n">spawn</code><code class="p">(</code><code class="n">download</code><code class="p">,</code> <code class="n">u</code><code class="p">,</code> <code class="n">semaphore</code><code class="p">)</code> <code class="k">for</code> <code class="n">u</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">]</code> <code class="c"># </code><a id="CO17-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="k">for</code> <code class="n">response</code> <code class="ow">in</code> <code class="n">gevent</code><code class="o">.</code><code class="n">iwait</code><code class="p">(</code><code class="n">requests</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">response</code>

<code class="k">def</code> <code class="nf">download</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">semaphore</code><code class="p">):</code>
    <code class="k">with</code> <code class="n">semaphore</code><code class="p">:</code> <code class="c"># </code><a id="CO17-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">
        <code class="n">data</code> <code class="o">=</code> <code class="n">urllib2</code><code class="o">.</code><code class="n">urlopen</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">response_futures</code> <code class="o">=</code> <code class="n">chunked_requests</code><code class="p">(</code><code class="n">urls</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code> <code class="c"># </code><a id="CO17-4"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png">
    <code class="n">response_size</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">value</code><code class="p">)</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">response_futures</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">response_size</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="kn">import</code> <code class="nn">time</code>
    <code class="n">delay</code> <code class="o">=</code> <code class="mi">100</code>
    <code class="n">num_iter</code> <code class="o">=</code> <code class="mi">500</code>
    <code class="n">base_url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?name=gevent&amp;delay={}&amp;"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">delay</code><code class="p">)</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="n">result</code> <code class="o">=</code> <code class="n">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">end</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">print</code><code class="p">(</code><code class="s">"Result: {}, Time: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">end</code> <code class="o">-</code> <code class="n">start</code><code class="p">))</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO17-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Here we generate a semaphore that lets <code class="literal">chunk_size</code> downloads happen.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO17-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
By using the semaphore as a context manager, we insure that only <code class="literal">chunk_size</code> greenlets can run the body of the context at a time.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO17-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
We can queue up as many Greenlets as we need, knowing that none of them will run until we start an event loop with <code class="literal">wait</code> or <code class="literal">iwait</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO17-4"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></a> </dt><dd><p>
<code class="literal">response_futures</code> now holds a generator over completed futures, all of which have our desired data in the <code class="literal">.value</code> property.
</p></dd></dl></div></div></div><p>Alternitively, we can use grequests to greatly simplify our <code class="literal">gevent</code> code.
While <code class="literal">gevent</code> provides all sorts of lower level concurrent socket operations,
<code class="literal">grequests</code> is a combination of the <code class="literal">requests</code> http library and gevent to make a
very simple API for making concurrent HTTP requests (it even handles the
semaphore logic for us).  In the end, our code becomes a lot more simple, more
understandable and maintainable while still getting comparable speedups to the
lower level <code class="literal">gevent</code> code (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_gevent_http">Example&nbsp;8-5</a>).</p><div class="example"><a id="conn_gevent_http"></a><div class="example-title">Example&nbsp;8-5.&nbsp;GRequests HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">grequests</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">response_futures</code> <code class="o">=</code> <code class="p">(</code><code class="n">grequests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">u</code><code class="p">)</code> <code class="k">for</code> <code class="n">u</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">)</code> <code class="c"># </code><a id="CO18-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">responses</code> <code class="o">=</code> <code class="n">grequests</code><code class="o">.</code><code class="n">imap</code><code class="p">(</code><code class="n">response_futures</code><code class="p">,</code> <code class="n">size</code> <code class="o">=</code> <code class="mi">100</code><code class="p">)</code> <code class="c"># </code><a id="CO18-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">response_size</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">text</code><code class="p">)</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">responses</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">response_size</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO18-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
First we create the requests and get futures back.  We chose to do this as a generator so that later we only need to evaluate as many requests as we are ready to issue.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO18-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
Now we can take the future objects and map then into real response objects.  The <code class="literal">.imap</code> function gives us a generator which yields response objects for which we have retrieved data for.
</p></dd></dl></div></div></div><p>An important thing to note is that we have used gevent to make our IO requests
asynchronous, but we are not doing any non-io computations while in IO wait.
However, in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_gevent_request_time">Figure&nbsp;8-4</a> we can see the massive speedup we get.
By launching more requests while waiting for previous requests to finish we are
able to achieve a 69x speedup!  We can explicitly see how requests are being
sent out before previous requests finish by how the horizontal lines
representing the requests stack on each other.  This is in sharp contrast to the
case of the serial crawler (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_request_time">Figure&nbsp;8-2</a>) where a line only
starts when the previous line finishes.</p><p>Furthermore, we can see more interesting effects going on with the shape that
the gevent request timeline.  For example, at around the first 100th request we
see a pause where new requests are not launched.  This is because it is the
first time that our semaphore is hit and we are able to lock the semaphore
before any previous requests finish.  After this, the semaphore goes into an
equilibrium where it locks just as another request finishes and unlocks it.</p><div class="figure"><a id="conn_gevent_request_time"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/gevent.png" alt="Request times for gevent scraper" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/gevent.png"></div></div><div class="figure-title">Figure&nbsp;8-4.&nbsp;Request Time for <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_http">Example&nbsp;8-3</a></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_tornado">Tornado</h2></div></div></div><p>Another very frequently used package for asynchronous IO in python is <code class="literal">tornado</code>,
a package developed by facebook primarily for HTTP clients and servers.  In
contrast to <code class="literal">gevent</code>, <code class="literal">tornado</code> choses to use the callback method for async
behaviour.  However, in the 3.x release coroutine like behaviour was added in in
a way that is compatible with old code.</p><p>In the following example, we implement the same web crawler as we did for
<code class="literal">gevent</code>, however we use the tornado IO loop (their version of an event loop)
and their HTTP client.  This saves us the trouble of having to batch our
requests and deal with other more low level aspects of our code.</p><div class="example"><a id="conn_tornado_http"></a><div class="example-title">Example&nbsp;8-6.&nbsp;Tornado HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">tornado</code> <code class="kn">import</code> <code class="n">ioloop</code>
<code class="kn">from</code> <code class="nn">tornado.httpclient</code> <code class="kn">import</code> <code class="n">AsyncHTTPClient</code>
<code class="kn">from</code> <code class="nn">tornado</code> <code class="kn">import</code> <code class="n">gen</code>

<code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>
<code class="kn">import</code> <code class="nn">string</code>
<code class="kn">import</code> <code class="nn">random</code>

<code class="n">AsyncHTTPClient</code><code class="o">.</code><code class="n">configure</code><code class="p">(</code><code class="s">"tornado.curl_httpclient.CurlAsyncHTTPClient"</code><code class="p">,</code>
<code class="n">max_clients</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code> <code class="c">#</code><a id="CO19-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">

<code class="k">def</code> <code class="nf">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_urls</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">num_urls</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">base_url</code> <code class="o">+</code> <code class="s">""</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>

<code class="nd">@gen.coroutine</code>
<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">http_client</code> <code class="o">=</code> <code class="n">AsyncHTTPClient</code><code class="p">()</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">responses</code> <code class="o">=</code> <code class="k">yield</code> <code class="p">[</code><code class="n">http_client</code><code class="o">.</code><code class="n">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">)</code> <code class="k">for</code> <code class="n">url</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">]</code> <code class="c"># </code><a id="CO19-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">response_sum</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">body</code><code class="p">)</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">responses</code><code class="p">)</code>
    <code class="k">raise</code> <code class="n">gen</code><code class="o">.</code><code class="n">Return</code><code class="p">(</code><code class="n">value</code><code class="o">=</code><code class="n">response_sum</code><code class="p">)</code> <code class="c"># </code><a id="CO19-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="c">#... initialization ...</code>

    <code class="n">_ioloop</code> <code class="o">=</code> <code class="n">ioloop</code><code class="o">.</code><code class="n">IOLoop</code><code class="o">.</code><code class="n">instance</code><code class="p">()</code>
    <code class="n">run_func</code> <code class="o">=</code> <code class="n">partial</code><code class="p">(</code><code class="n">run_experiment</code><code class="p">,</code> <code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">result</code> <code class="o">=</code> <code class="n">_ioloop</code><code class="o">.</code><code class="n">run_sync</code><code class="p">(</code><code class="n">run_func</code><code class="p">)</code> <code class="c"># </code><a id="CO19-4"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO19-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
We can configure our HTTP client and pick what backend library we wish to use and how many requests we would like to batch together
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO19-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
We generate many futures and then yield back to the IO loop.  This function will resume and the future’s results set into the <code class="literal">responses</code> variable once all futures are filled.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO19-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
coroutines in tornado are backed by python generators.  In order to return a value from them, we must raise a special exception that <code class="literal">gen.coroutine</code> turns into a return value.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO19-4"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></a> </dt><dd><p>
<code class="literal">ioloop.run_sync</code> will start the IOLoop just for the duration of the runtime of the specified function.  ioloop.start(), on the otherhand, starts an IOLoop that must be terminated manually.
</p></dd></dl></div></div></div><p>An important difference between the tornado code from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_http">Example&nbsp;8-6</a> and
the gevent code from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_gevent_http">Example&nbsp;8-5</a> is when the event loop is running.
For gevent, the event loop is only running while the <code class="literal">iwait</code> function is
running.  On the other hand, in tornado the event loop is running the entire time
and controls the complete execution flow of the program, not just the
asynchronous IO parts.</p><p>This makes tornado ideal for applications that are mostly IO bound and where
most, if not all, of the application should be asynchronous.  This is where
tornado makes it’s biggest claim to fame, as a performant web server.  In fact,
this author has on many occasions written tornado backed databases and data
structures that require a lot of IO <sup>[<a id="id809708" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id809708" class="footnote">45</a>]</sup>.  On the other hand, since
gevent makes no requirements to your program as a whole, it is an ideal solution
for a mainly CPU based tasked that must sometimes do heavy IO.  For example, a
program which does a lot of computations over a dataset and then must send the
results back to the database for storage.  This becomes even simpler with the
fact that most databases have simple HTTP API’s which means you can even use
grequests.</p><p>This fact becomes even more explicit if we look at the more old-style tornado
code that utilizes callbacks in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_callback_http">Example&nbsp;8-7</a>.  We explicitly
see that in order to start the code we must add the entry point for our program
into the IO loop and then start it.  Then, in order for the program to
terminate, we must carefully carry around the <code class="literal">stop</code> function for our ioloop and
call it when appropriate.  As a result, programs that must explicitly carry
callbacks become incredibly burdensome and quickly unmaintainable.  One reason
this happens is that tracebacks can no longer hold valuable information about
what function called what and how we got into an exception to begin with.  Even
simply knowing which functions are called at all can become hard since we are
constantly making partial functions to fill in parameters.  It is no surprise
this if often called “callback hell”.</p><div class="example"><a id="conn_tornado_callback_http"></a><div class="example-title">Example&nbsp;8-7.&nbsp;Tornado crawler with callbacks</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">tornado</code> <code class="kn">import</code> <code class="n">ioloop</code>
<code class="kn">from</code> <code class="nn">tornado.httpclient</code> <code class="kn">import</code> <code class="n">AsyncHTTPClient</code>

<code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>

<code class="n">AsyncHTTPClient</code><code class="o">.</code><code class="n">configure</code><code class="p">(</code><code class="s">"tornado.curl_httpclient.CurlAsyncHTTPClient"</code><code class="p">,</code> <code class="n">max_clients</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">fetch_urls</code><code class="p">(</code><code class="n">urls</code><code class="p">,</code> <code class="n">callback</code><code class="p">):</code>
    <code class="n">http_client</code> <code class="o">=</code> <code class="n">AsyncHTTPClient</code><code class="p">()</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="n">urls</code><code class="p">)</code>
    <code class="n">responses</code> <code class="o">=</code> <code class="p">[]</code>
    <code class="k">def</code> <code class="nf">_finish_fetch_urls</code><code class="p">(</code><code class="n">result</code><code class="p">):</code> <code class="c"># </code><a id="CO20-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
        <code class="n">responses</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="n">responses</code><code class="p">)</code> <code class="o">==</code> <code class="nb">len</code><code class="p">(</code><code class="n">urls</code><code class="p">):</code>
            <code class="n">callback</code><code class="p">(</code><code class="n">responses</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">url</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">:</code>
        <code class="n">http_client</code><code class="o">.</code><code class="n">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">callback</code><code class="o">=</code><code class="n">_finish_fetch_urls</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">,</code> <code class="n">callback</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">callback_passthrou</code> <code class="o">=</code> <code class="n">partial</code><code class="p">(</code><code class="n">_finish_run_experiment</code><code class="p">,</code>
            <code class="n">callback</code><code class="o">=</code><code class="n">callback</code><code class="p">)</code> <code class="c"># </code><a id="CO20-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">fetch_urls</code><code class="p">(</code><code class="n">urls</code><code class="p">,</code> <code class="n">callback_passthrou</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">_finish_run_experiment</code><code class="p">(</code><code class="n">responses</code><code class="p">,</code> <code class="n">callback</code><code class="p">):</code>
    <code class="n">response_sum</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">body</code><code class="p">)</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">responses</code><code class="p">)</code>
    <code class="k">print</code> <code class="n">response_sum</code>
    <code class="n">callback</code><code class="p">()</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="c">#... initialization ...</code>

    <code class="n">_ioloop</code> <code class="o">=</code> <code class="n">ioloop</code><code class="o">.</code><code class="n">IOLoop</code><code class="o">.</code><code class="n">instance</code><code class="p">()</code>
    <code class="n">_ioloop</code><code class="o">.</code><code class="n">add_callback</code><code class="p">(</code><code class="n">run_experiment</code><code class="p">,</code> <code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">,</code> <code class="n">_ioloop</code><code class="o">.</code><code class="n">stop</code><code class="p">)</code> <code class="c"># </code><a id="CO20-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">

    <code class="n">_ioloop</code><code class="o">.</code><code class="n">start</code><code class="p">()</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO20-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
We send <code class="literal">_ioloop.stop</code> as the callback to <code class="literal">run_experiment</code> so that once the experiment is done, it shuts off the ioloop for us.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO20-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
Callback-type async code has a lot of partial function creation.  This is because we often need to preserve the original callback we were sent even though we currently need to transfer the runtime to another function.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO20-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Sometimes games with scope are a necissary evil in order to preserve state while not cluttering the global namespace.
</p></dd></dl></div></div></div><p>Another interesting difference between gevent and tornado are the way the
internals change the request call graphs (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_request_time">Figure&nbsp;8-5</a> and
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_gevent_request_time">Figure&nbsp;8-4</a>).  For the gevent call graph we see some areas
where the diagonal line seems to get thinner, and others where it seems to get
much thicker.  The thinner regions show times when we are waiting for old
requests to finish before launching new ones.  On the other hand, the thicker
regions represent areas where we are too busy to read the responses from
requests that should have already finished.  Both these types of regions
represent times when the event loop isn’t doing its job optimally: times when we
are either under-utilizing our over-utilizing our resources.</p><p>On the other hand, the call graph for tornado is much more uniform.  This shows
that tornado is better able to optimize our resource use.  This can be
attributed to many things.  Firstly, since the semaphore logic limiting only 100
requests from being in the air at a time is internal to tornado it can better
allocate resources.  This includes pre-allocating and re-using connections in a
smarter way.</p><div class="figure"><a id="conn_tornado_request_time"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/tornado.png" alt="Request times for tornado scraper" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/tornado.png"></div></div><div class="figure-title">Figure&nbsp;8-5.&nbsp;Request Time for <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_http">Example&nbsp;8-6</a></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_asyncio">AsyncIO</h2></div></div></div><p>Drawing from the popularity of async functionality to deal with heavy IO
systems, Python 3.4+ introduced a revamping of the old <code class="literal">asyncio</code> standard
library module.  This module draws much of it’s influence from the <code class="literal">gevent</code> and
<code class="literal">tornado.gen</code> method of concurrency where coroutines are defined and yielded
from in order to halt the execution of the current function and allow other
coroutines to run.  Similar to <code class="literal">tornado</code>, the event loop is explicitly started
in order to start the execution of the coroutines.  In addition, python 3
introduced a new keyword, <code class="literal">yield from</code> which greatly simplifies dealing with
these coroutines (we no longer have to raise an exception to return a value from
a coroutine as we did in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_http">Example&nbsp;8-6</a>.</p><p>It is important to note that the <code class="literal">asyncio</code> library is very low level and does
not provide much higher level functionality to the user.  For example, while
there is a very full socket API, there is no easy way to do HTTP requests.  As a
result, we chose to use the <code class="literal">aiohttp</code> library in the following example.
However, the adoption of the <code class="literal">asyncio</code> library is just starting to ramp up and
the landscape of helper modules is probably going to be changing very quickly.</p><div class="example"><a id="conn_asyncio_http"></a><div class="example-title">Example&nbsp;8-8.&nbsp;AsyncIO HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">asyncio</code>
<code class="kn">import</code> <code class="nn">aiohttp</code>
<code class="kn">import</code> <code class="nn">random</code>
<code class="kn">import</code> <code class="nn">string</code>

<code class="k">def</code> <code class="nf">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_urls</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_urls</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">base_url</code> <code class="o">+</code> <code class="s">""</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>

<code class="k">def</code> <code class="nf">chunked_http_client</code><code class="p">(</code><code class="n">num_chunks</code><code class="p">):</code>
    <code class="n">semaphore</code> <code class="o">=</code> <code class="n">asyncio</code><code class="o">.</code><code class="n">Semaphore</code><code class="p">(</code><code class="n">num_chunks</code><code class="p">)</code> <code class="c"># </code><a id="CO21-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="nd">@asyncio.coroutine</code>
    <code class="k">def</code> <code class="nf">http_get</code><code class="p">(</code><code class="n">url</code><code class="p">):</code> <code class="c"># </code><a id="CO21-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
        <code class="n">nonlocal</code> <code class="n">semaphore</code>
        <code class="k">with</code> <code class="p">(</code><code class="k">yield from</code> <code class="n">semaphore</code><code class="p">):</code>
            <code class="n">response</code> <code class="o">=</code> <code class="k">yield from</code> <code class="n">aiohttp</code><code class="o">.</code><code class="n">request</code><code class="p">(</code><code class="s">'GET'</code><code class="p">,</code> <code class="n">url</code><code class="p">)</code>
            <code class="n">body</code> <code class="o">=</code> <code class="k">yield from</code> <code class="n">response</code><code class="o">.</code><code class="n">content</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>
            <code class="k">yield from</code> <code class="n">response</code><code class="o">.</code><code class="n">wait_for_close</code><code class="p">()</code>
        <code class="k">return</code> <code class="n">body</code>
    <code class="k">return</code> <code class="n">http_get</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">http_client</code> <code class="o">=</code> <code class="n">chunked_http_client</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
    <code class="n">tasks</code> <code class="o">=</code> <code class="p">[</code><code class="n">http_client</code><code class="p">(</code><code class="n">url</code><code class="p">)</code> <code class="k">for</code> <code class="n">url</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">]</code> <code class="c"># </code><a id="CO21-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">
    <code class="n">responses_sum</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">future</code> <code class="ow">in</code> <code class="n">asyncio</code><code class="o">.</code><code class="n">as_completed</code><code class="p">(</code><code class="n">tasks</code><code class="p">):</code> <code class="c"># </code><a id="CO21-4"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png">
        <code class="n">data</code> <code class="o">=</code> <code class="k">yield from</code> <code class="n">future</code>
        <code class="n">responses_sum</code> <code class="o">+=</code> <code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">responses_sum</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="kn">import</code> <code class="nn">time</code>
    <code class="n">delay</code> <code class="o">=</code> <code class="mi">100</code>
    <code class="n">num_iter</code> <code class="o">=</code> <code class="mi">500</code>
    <code class="n">base_url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?name=asyncio&amp;delay={}&amp;"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">delay</code><code class="p">)</code>
    <code class="n">loop</code> <code class="o">=</code> <code class="n">asyncio</code><code class="o">.</code><code class="n">get_event_loop</code><code class="p">()</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="n">result</code> <code class="o">=</code> <code class="n">loop</code><code class="o">.</code><code class="n">run_until_complete</code><code class="p">(</code><code class="n">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">))</code>
    <code class="n">end</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">print</code><code class="p">(</code><code class="s">"{} {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">end</code><code class="o">-</code><code class="n">start</code><code class="p">))</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO21-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Similar to the <code class="literal">gevent</code> example, we must use a semaphore to limit the number of requests.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO21-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
We return a new coroutine that will asynchronously download files and respect the locking of the semaphore.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO21-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
The <code class="literal">http_client</code> function returns futures.  To keep track of progress, we save the futures into a list
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO21-4"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></a> </dt><dd><p>
Similar to <code class="literal">gevent</code>, we can wait for futures to become ready and iterate over them.
</p></dd></dl></div></div></div><p>One of the fantastic benefits of the <code class="literal">asyncio</code> module is the compromise between
low level and high level functionality.  We are able to get the same sort of
results as we would with <code class="literal">tornado</code> or <code class="literal">gevent</code>, however if we wanted we could
dive deeper into the stack and make our own async protocols using a wide array
of supported structures.  In addition, being a standard library module, we are
assured that this module will always be PEP compliant and reasonably maintained.</p><p>Even though this support only comes with python 3.4 and higher <sup>[<a id="id812203" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id812203" epub:type="noteref" class="footnote">46</a>]</sup>,
this module at the very least is a great sign of more work in the future being
put into asynchronous IO.  As python starts dominating more and more processing
pipelines (from data processing to web request processing), this shift makes
perfect sense.</p><div class="figure"><a id="conn_asyncio_request_time"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/asyncio.png" alt="Request times for AsyncIO scraper" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/asyncio.png"></div></div><div class="figure-title">Figure&nbsp;8-6.&nbsp;Request Time for <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_asyncio_http">Example&nbsp;8-8</a></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_database_example">Database Example</h2></div></div></div><p>To make the above examples more concrete, we will create another toy problem
that is mostly CPU bound but contains a potentially limiting IO component.  We
will be calculating primes and saving the found primes into a database.  This
amorphous database could be anything and relates to a much more relevant problem
in which your program has heavy calculation it must do, but solutions to these
calculations must be communicated to a database and maybe incure a heavy IO
penalty.  The only restrictions we are putting on our database are,</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
It has an HTTP API so that we can use similar code from above <sup>[<a id="id812332" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id812332" epub:type="noteref" class="footnote">47</a>]</sup>
</li><li class="listitem">
Response times are on the order of 50ms
</li><li class="listitem">
The database can satisfy many requests at a time <sup>[<a id="id812269" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id812269" epub:type="noteref" class="footnote">48</a>]</sup>
</li></ul></div><p>We start with a simple code that calculates primes and makes a request to the
databases’s HTTP API every time a prime is found.</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">tornado.httpclient</code> <code class="kn">import</code> <code class="n">HTTPClient</code>
<code class="kn">import</code> <code class="nn">math</code>

<code class="n">httpclient</code> <code class="o">=</code> <code class="n">HTTPClient</code><code class="p">()</code>
<code class="k">def</code> <code class="nf">save_prime_serial</code><code class="p">(</code><code class="n">prime</code><code class="p">):</code>
    <code class="n">url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?prime={}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">prime</code><code class="p">)</code>
    <code class="n">response</code> <code class="o">=</code> <code class="n">httpclient</code><code class="o">.</code><code class="n">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>
    <code class="n">finish_save_prime</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="n">prime</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">finish_save_prime</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="n">prime</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">response</code><code class="o">.</code><code class="n">code</code> <code class="o">!=</code> <code class="mi">200</code><code class="p">:</code>
        <code class="k">print</code> <code class="s">"Error saving prime: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">prime</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">check_prime</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">number</code> <code class="o">%</code> <code class="mi">2</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
        <code class="k">return</code> <code class="bp">False</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="nb">int</code><code class="p">(</code><code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">number</code><code class="p">))</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">number</code> <code class="o">%</code> <code class="n">i</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">return</code> <code class="bp">False</code>
    <code class="k">return</code> <code class="bp">True</code>

<code class="k">def</code> <code class="nf">calculate_primes_serial</code><code class="p">(</code><code class="n">max_number</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">number</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">max_number</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">check_prime</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
            <code class="n">save_prime_serial</code><code class="p">(</code><code class="n">number</code><code class="p">)</code>
    <code class="k">return</code></pre><p>Just as in our <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_http">Example&nbsp;8-3</a>, the request time for each database save
(50ms) does no stack and just we must pay this penalty for each prime we find.
As a result, searching up to <code class="literal">max_number = 8,192</code> (which results in 1028 primes)
takes 55.2s.  We know, however, that because of the way our serial requests
work, we are spending 51.4s at minimum doing IO!  So, simply because we are
pausing our program while doing IO we are wasting 93% of our time!</p><p>What we want to do instead is to find a way to change our request scheme so that
we can issue many requests asynchronously at a time so that we don’t have such a
burdensome IO wait.  In order to do this, we create an <code class="literal">AsyncBatcher</code> class
which takes care of batching requests for us and making the requests when
necissary.</p><pre class="programlisting"><code class="kn">import</code> <code class="nn">grequests</code>
<code class="kn">from</code> <code class="nn">itertools</code> <code class="kn">import</code> <code class="n">izip</code>

<code class="k">class</code> <code class="nc">AsyncBatcher</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="n">__slots__</code> <code class="o">=</code> <code class="p">[</code><code class="s">"batch"</code><code class="p">,</code> <code class="s">"batch_size"</code><code class="p">,</code> <code class="s">"save"</code><code class="p">,</code> <code class="s">"flush"</code><code class="p">]</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">batch_size</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch_size</code> <code class="o">=</code> <code class="n">batch_size</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch</code> <code class="o">=</code> <code class="p">[]</code>

    <code class="k">def</code> <code class="nf">save</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">prime</code><code class="p">):</code>
        <code class="n">url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?prime={}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">prime</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch</code><code class="o">.</code><code class="n">append</code><code class="p">((</code><code class="n">url</code><code class="p">,</code><code class="n">prime</code><code class="p">))</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">batch</code><code class="p">)</code> <code class="o">==</code> <code class="bp">self</code><code class="o">.</code><code class="n">batch_size</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">flush</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">flush</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">responses_futures</code> <code class="o">=</code> <code class="p">(</code><code class="n">grequests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">url</code><code class="p">)</code> <code class="k">for</code> <code class="n">url</code><code class="p">,</code> <code class="n">_</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">batch</code><code class="p">)</code>
        <code class="n">responses</code> <code class="o">=</code> <code class="n">grequests</code><code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="n">responses_futures</code><code class="p">)</code>
        <code class="k">for</code> <code class="n">response</code><code class="p">,</code> <code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">prime</code><code class="p">)</code> <code class="ow">in</code> <code class="n">izip</code><code class="p">(</code><code class="n">responses</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">batch</code><code class="p">):</code>
            <code class="n">finish_save_prime</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="n">prime</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch</code> <code class="o">=</code> <code class="p">[]</code></pre><p>Now, we can proceed almost in the same way as we did before.  The only main
differences is that we add our new primes to our <code class="literal">AsyncBatcher</code> and let it take
care of when to send the requests.  In addition, since we are batching we must
make sure to send the last batch even if it is not full yet (which means making
a call to <code class="literal">AsyncBatcher.flush()</code>).</p><pre class="programlisting"><code class="k">def</code> <code class="nf">calculate_primes_async</code><code class="p">(</code><code class="n">max_number</code><code class="p">):</code>
    <code class="n">batcher</code> <code class="o">=</code> <code class="n">AsyncBatcher</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code> <code class="c"># </code><a id="CO22-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="k">for</code> <code class="n">number</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">max_number</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">check_prime</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
            <code class="n">batcher</code><code class="o">.</code><code class="n">save</code><code class="p">(</code><code class="n">number</code><code class="p">)</code>
    <code class="n">batcher</code><code class="o">.</code><code class="n">flush</code><code class="p">()</code>
    <code class="k">return</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO22-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
We choose to batch at 100 requests for similar reasons as from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_num_concurrent_requests">Figure&nbsp;8-3</a>
</p></dd></dl></div><p>With this change, we are able to bring our runtime for <code class="literal">max_number = 8,192</code> down
to 4.09s.  This represents a 13.5x speedup without having to do much work.  In a
constrained environment such as a realtime data pipeline, this extra speed could
mean the difference between a system being able to keep up with demand and
simply not keeping up.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_primes">Figure&nbsp;8-7</a> we can see a summary of how these changes effect the runtime
of our code for different number of of workloads.  The speedups are quite great
between the serial and the async code, although we are still a ways away from
the raw CPU problem.  For this to be completely remedied, we would need to use
modules like <code class="literal">multiprocessing</code> to have a completely separate process that can
deal with the IO burden of our program without slowing down the CPU portion of
the problem.</p><div class="figure"><a id="conn_primes"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/primes/images/primes.png" alt="Processing time difference between serial IO, async IO and IO disabled" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/primes/images/primes.png"></div></div><div class="figure-title">Figure&nbsp;8-7.&nbsp;Processing times for different number of primes</div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_wrap_up_6">Wrap Up</h2></div></div></div><p>When solving problems in real world and production systems, it is often
necessary to communicate to some outside source.  This outside source could be a
database running on another server, another worker computer or a data service
that is providing the raw data that must be processed.  Whenever this is the
case, your problem can quickly become IO bound meaning that most of the runtime
is dominated by dealing with input/output.</p><p>Concurrency helps IO bound problems by allowing you to interleave computation
with potentially multiple IO operations.  This allows you to exploit the
fundamental difference between IO and CPU operations in order to speed up
overall runtime.</p><p>As we saw, <code class="literal">gevent</code> provides the highest level interface for asynchronous IO.
On the other hand, <code class="literal">tornado</code> lets you manually control how the event loop is
running, allowing you to use the event loop to schedule any sort of task you
want.  Finally, <code class="literal">asyncio</code> in Python3.4+ allows full control of an asynchronous
IO stack.  In addition to the various levels of abstraction, every library uses
a different paradigm for it’s syntax (namely from the lack of native support for
concurrency before Python 3 and the introduction of the <code class="literal">yield from</code> statement).
We recommend gaining some experience in a range of methods and picking one based
on how much low-level control is necessary.</p><p>Finally, there are small speed differenes between the three libraries we
approached.  Many of these speed differences are based on how coroutines are
scheduled: <code class="literal">tornado</code> does an incredible job at launching asynchronous operations
and resuming the coutine quickly.  On the otherhand, even though <code class="literal">asyncio</code> seems
to perform slightly worse, it allows much lower access into the API and can be
tuned dramatically.</p><p>In the next chapter, we will take this concept of interleaving computation from
IO bound problems to CPU bound problems.  Adding this new ability will allows us
to not only perform multiple IO operations at once but also many computational
operations.  By doing this, we start to be able to make fully scalable programs
where more speed can be achieved by simply adding more computer resources which
can take a chunk of the problem.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" epub:type="footnote" id="ftn.id806261"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id806261" class="simpara">44</a>] </sup>Some databases, such as
redis, do this specifically to maintain atomicity in it’s operations</p></div><div class="footnote" id="ftn.id809708"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id809708" class="simpara">45</a>] </sup>For example, fuggetaboutit is a
special type of probabilistic datastructure (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_prob_ds">Probabilistic data structures</a>) that uses the
tornado ioloop to schedule time-based tasks.
<a class="ulink" href="https://github.com/mynameisfiber/fuggetaboutit" target="_top">https://github.com/mynameisfiber/fuggetaboutit</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id812203"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id812203" class="simpara">46</a>] </sup>Most
performance applications and moduels are still in the python 2.7 ecosystem</p></div><div class="footnote" epub:type="footnote" id="ftn.id812332"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id812332" class="simpara">47</a>] </sup>This is not necissary, it just serves to simplify our code</p></div><div class="footnote" epub:type="footnote" id="ftn.id812269"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id812269" class="simpara">48</a>] </sup>This is true for all distributed databases and other popular databases such as postgres, mongodb, riak, etc.</p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch07.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">7. Compiling to C</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch09.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">9. The multiprocessing module</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch08.html" data-for-analytics="9781449361747:ch08.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch09.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch09.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch09.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch09.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>9. The multiprocessing module - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch09.html"><meta name="description" content="Chapter&nbsp;9.&nbsp;The multiprocessing module Questions you’ll be able to answer after this chapter What does the multiprocessing module offer? Processes vs Threads? How to choose the right size ... "><meta property="og:title" content="9. The multiprocessing module"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="9. The multiprocessing module"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch09.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;9.&nbsp;The multiprocessing module Questions you’ll be able to answer after this chapter What does the multiprocessing module offer? Processes vs Threads? How to choose the right size ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch09.html" data-for-analytics="9781449361747:ch09.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch09.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch09.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch09.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%209.%20The%20multiprocessing%20module&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch09.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch08.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">8. Concurrency</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch10.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">10. Clusters and Job Queues</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="multiprocessing"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;9.&nbsp;The multiprocessing module</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
What does the multiprocessing module offer?
</li><li class="listitem">
Processes vs Threads?
</li><li class="listitem">
How to choose the right size for a Process Pool?
</li><li class="listitem">
How to use non-persistent Queues for work processing?
</li><li class="listitem">
What are the costs and benefits of Inter Process Communication?
</li><li class="listitem">
How can we process numpy data with many CPUs  ?
</li><li class="listitem">
Why do we need Locking to avoid data loss?
</li></ul></div></div><p>CPython doesn’t use multiple CPUs by default. This is partly due to Python’s
design back in a single-core era and partly because parallelizing can actually
be quite difficult to do efficiently. Python gives us the tools to do it but
leaves us to make our own choices. It is painful to see your multi-core machine
using just 1 CPU on a long-running process so in this chapter we’ll review ways
of using all the machine’s cores at once.</p><p>It is important to note that I mentioned <span class="emphasis"><em>CPython</em></span> above (the common implementation that we all use), there’s nothing in the Python language that stops it from using multi-core systems. CPython’s implementation cannot efficiently use multiple cores but other implementations (e.g. PyPy with the forthcoming Software Transactional Memory) may not be bound by this restriction.</p><p>We live in a multi-core world - four cores are common in laptops, eight core
desktops configurations will be popular soon and 10, 12, and 15 core server CPUs
are available. If your job can be split to run on multiple CPUs <span class="emphasis"><em>without</em></span> too
much engineering effort then this is a wise direction to consider.</p><p>When used to parallelize a problem over a set of CPUs you can expect <span class="emphasis"><em>up to</em></span> an
n-times speed-up with n-cores. If you have a quad-core machine and you can use
all four cores for your task, it might run in 1/4 of the original run-time. You
are unlikely to see a greater than 4* speed-up, probably you’ll get a 3-4*
speed-up in practice.</p><p>This is because each additional process will increase the
communications overhead and decrease available RAM, so you rarely get a full n*
speed-up.  Depending on which problem you are solving, the communications
overhead can even get so large that you can see very significan slow-downs.
These sorts of problems are often where the complexity of any sort of parallel
programming and normally require a change in algorithm.  This is often why
parallel programming is considered an art.</p><p>If you’re not familiar with Amdahl’s Law <sup>[<a id="id814204" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id814204" class="footnote">49</a>]</sup> then it is worth doing some background reading. The law shows that if only a small part of your code can be parallelized, it doesn’t matter how many CPUs you throw at it, overall you still won’t run much faster. Even if a large fraction of your run-time could be parallelized there’s a finite number of CPUs that can be used to efficiently make the overall process run faster, before you get to a point of diminishing returns.</p><p>The <code class="literal">multiprocessing</code> module lets you use process and thread based parallel
processing, share work over queues, and share data amongst processes. It is
mostly focused on single-machine multi-core parallelism (there are better
options for multi-machine parallelism). A very common use is to parallelize a
task over a set of processes for a CPU-bound problem. You might also use it to
parallelize an I/O-bound problem but there are better tools for this (e.g. the
new <code class="literal">asyncore</code> module in Python 3 and <code class="literal">gevent</code> or <code class="literal">tornado</code> in Python 2+).</p><p>To parallelize your task you have to think a little differently to the normal
way of writing a serial process. You must also accept that debugging a
parallelized task is <span class="emphasis"><em>harder</em></span> - often it can be very frustrating. I’d recommend
keeping the parallelizm as simple as possible (even if you’re not squeezing
every last drop of power from your machine) so that your development velocity is
kept high.</p><p>One particularly difficult topic is the sharing of state in a parallel system -
it “feels like it should be easy” but incurs lots of overheads and can be hard
to get right. There are many use cases, each with different trade-offs, so
there’s definitely no “one solution for everyone”. In
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-verifying-primes-using-inter-process-communication">Verifying Primes using Inter Process Communication</a> we’ll go
through state sharing with an eye on the synchronization costs. Avoiding shared
state will make your life far easier.</p><p>In fact, an algorithm can be analysed to see how well it’ll perform in a
parallel environment almost entirely by how much state must be shared.  For
example, if we can have multiple python processes all solving the same problem
without communicating to eachother (a situation known as embarassingly
parallel), then the problem doesn’t incur much of a penalty as we add more and
more python processes.</p><p>On the other hand, if each processes needed to communicate to every other python
process then communications overhead will slowely overwhelm the process and slow
things down.  This would mean that as we add more python processes we could
actually slow down our overall performance.</p><p>As a result, sometimes some counter-intuitive algorithmic changes must occur to
efficiently solve a problem in parallel.  For example, when solving the diffusion
equation (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a>) in parallel, each process actually does some
redundant work that another process also does.  This redundancy reduces the
amount of communications and speeds up the overall calculation!</p><p>Here are some typical jobs for the <code class="literal">multiprocessing</code> module:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Parallelize a CPU-bound task with <code class="literal">Process</code> or <code class="literal">Pool</code> objects
</li><li class="listitem">
Parallelize an I/O-bound task in a <code class="literal">Pool</code> with threads using the (oddly named) <code class="literal">dummy</code> module
</li><li class="listitem">
Share pickled work via a <code class="literal">Queue</code>
</li><li class="listitem">
Share state between parallelized workers including bytes, primitive datatypes, dictionaries and lists
</li></ul></div><p>If you come from a language where threads are used for CPU-bound tasks (e.g. C++
or Java) then you should know that whilst threads in Python are OS-native
(they’re not simulated, they are actual Operating System threads) they are bound
by the Global Interpreter Lock (GIL) so only one thread may interact with Python
objects at a time.</p><p>By using processes we run a number of Python interpreters in
parallel, each with a private memory space with their own GIL, and each runs in
series (so there’s no competition for each GIL) - this is the easiest way to
speed-up a CPU-bound task in Python. If we need to share state then we need to
add some communications overhead, we’ll explore that in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-verifying-primes-using-inter-process-communication">Verifying Primes using Inter Process Communication</a>.</p><p>If you work with <code class="literal">numpy</code> arrays you might wonder if you can create a larger
array (e.g. a large 2D matrix) and ask processes to work on segments of the
array in parallel. You can but it is hard to discover by trial and error so in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-sharing-numpy-data-with-multiprocessing">Sharing numpy data with multiprocessing</a> we’ll work through
sharing a 6.4GB <code class="literal">numpy</code> array across four CPUs. Rather than sending partial
copies of the data (which would at least double the working size required in
RAM) and create a massive communications overhead, we share the underlying bytes
of the array amongst the processes. This is an ideal approach to sharing a large
array amongst local workers on one machine.</p><div class="note"><h3 class="title">Note</h3><p>Here we discuss <code class="literal">multiprocessing</code> on *nix based machines (this chapter is
written using Ubuntu, it should run unchanged on a Mac). For Windows machines
you should check the official documentation
<sup>[<a id="id814377" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id814377" class="footnote">50</a>]</sup>.</p></div><p>In the following chapter I’m hardcoding the number of processes
(<code class="literal">NUM_PROCESSES=4</code>) to match the four physical cores on my laptop. By default
<code class="literal">multiprocessing</code> will use as many cores as it can see (my machine presents
eight - four CPUs and four HyperThreads). Normally you’d avoid hard-coding the
number of processes to create unless you were specifically managing your
resources.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_an_overview_of_the_multiprocessing_module">An overview of the multiprocessing module</h2></div></div></div><p>The <code class="literal">multiprocessing</code> module was introduced in Python 2.6
<sup>[<a id="id814457" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id814457" class="footnote">51</a>]</sup> by taking the existing
<code class="literal">pyProcessing</code> module and folding it into Python’s built-in library set. Its
main components are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">Process</code> - a forked copy of the current process, this creates a new Process Identifier and the task runs as an independent child process in the Operating System. You can start and query the state of the <code class="literal">Process</code> and provide it with a <code class="literal">target</code> method to run
</li><li class="listitem">
<code class="literal">Pool</code> - wraps the <code class="literal">Process</code> or <code class="literal">threading.Thread</code> API into a convenient pool of workers which share a chunk of work and return an aggregated result
</li><li class="listitem">
<code class="literal">Queue</code> - FIFO queue allowing multiple producers and consumers
</li><li class="listitem">
<code class="literal">Pipe</code> - uni- or bi-directional communication channel between two processes
</li><li class="listitem">
<code class="literal">Manager</code> - high level managed interface to share Python objects between processes
</li><li class="listitem">
<code class="literal">ctypes</code> - allows sharing primitive datatypes (e.g. integers, floats and bytes) between processes after they have forked
</li><li class="listitem">
Synchronization primitives - locks and semaphores to synchronize control flow between processes
</li></ul></div><div class="note"><h3 class="title">Note</h3><p>In Python 3.2 the <code class="literal">concurrent.futures</code> module was introduced (via PEP 3148 <sup>[<a id="id814567" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id814567" class="footnote">52</a>]</sup>), this provides the core bahavior of <code class="literal">multiprocessing</code> with a simpler interface based on Java’s <code class="literal">java.util.concurrent</code>. It is available as a backport to earlier versions of Python <sup>[<a id="id814600" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id814600" class="footnote">53</a>]</sup>. I don’t cover it here as it isn’t as flexible as <code class="literal">multiprocessing</code>. I suspect that with the growing adoption of Python 3+ we’ll see it replace <code class="literal">multiprocessing</code> over time.</p></div><p>In the rest of the chapter I’ll introduce a set of examples to demonstrate common ways of using this module.</p><p>We’ll estimate Pi using a Monte Carlo approach with a <code class="literal">Pool</code> of processes or threads, using normal Python and <code class="literal">numpy</code>. This is a simple problem with well-understodd complexity so it parallelizes easily, we can also see an unexpected result of using threads with <code class="literal">numpy</code>. Next we’ll search for Primes using the same <code class="literal">Pool</code> approach but we’ll investigate the non-predictable complexity of searching for Primes and look at how we can efficiently (and inefficiently!) split the workload to best use our computing resources. We’ll finish the Primes Search by switching to queues where we introduce <code class="literal">Process</code> objects in place of a <code class="literal">Pool</code> and use a list of work and poison pills to control the lifetime of workers.</p><p>Next we’ll tackle inter-process communication (IPC) to validate a small set of possible-Primes by splitting each number’s workload across multiple CPUs, we use IPC to end the search early if a factor is found so that we can significantly beat the speed of a single-CPU search process. We’ll cover shared Python objects, OS primitives and a Redis server to investigate the complexity and capability trade-offs of each approach.</p><p>We can share a 6.4GB <code class="literal">numpy</code> array across 4 CPUs to split a large workload
<span class="emphasis"><em>without</em></span> copying data.  If you have large arrays with parallelizable operations
then this technique should buy you a great speed-up since we have to allocate
less space in RAM and copy less data. Finally we’ll look at synchronizing access
to a file and a variable (as a <code class="literal">Value</code>) between processes to count without
corrupting data to illustrate how to correctly lock shared state.</p><div class="note"><h3 class="title">Note</h3><p>PyPy has full support of the <code class="literal">multiprocessing</code> library, the following CPython examples (though not the <code class="literal">numpy</code> examples at the time of writing) all run far quicker using PyPy. If you’re only using CPython code (no C extensions or more complex libraries) for parallel processing then PyPy might be a quick win for you.</p></div><p>OpenMP is a low level interface to multiple cores, you might wonder whether to focus on it rather than <code class="literal">multiprocessing</code>. We introduced it with Cython and Pythran back in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html">Chapter&nbsp;7</a> and we don’t cover it in this chapter. <code class="literal">multiprocessing</code> works at a higher level sharing Python data structures whilst OpenMP works with C primitive objects (e.g. integers and floats) once you’ve compiled to C. It only makes sense to use it if you’re compiling your code, if you’re not compiling (e.g. you’re using efficient <code class="literal">numpy</code> code and you want to run on many cores) then sticking with <code class="literal">multiprocessing</code> is probably the right approach.</p><p>This chapter (and the entire book) focuses on Linux, Linux has a forking process to create new processes by cloning the parent process. Windows lacks <code class="literal">fork</code> and so the <code class="literal">multiprocessing</code> module imposes some Windows-specific restrictions <sup>[<a id="id814731" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id814731" class="footnote">54</a>]</sup> which I urge you to review if you’re on Windows.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_estimating_pi_using_the_monte_carlo_method">Estimating Pi using the Monte Carlo method</h2></div></div></div><p>We can estimate Pi by throwing thousands of imaginary darts into a “dartboard” represented by a unit-circle. The relationship between the number of darts falling inside the circle’s edge and outside it will allow us to approximate Pi.</p><p>This is an ideal first problem as we can split the total workload evenly across a number of processes, each one running on a CPU. Each process will end at the same time as the workload for each is equal so we can investigate the speed-ups available as we add new CPUs and HyperThreads to the problem.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_estimate">Figure&nbsp;9-1</a> we throw 10,000 darts into the unit square, a percentage of them fall into the quarter of the unit circle that’s drawn. This estimate is rather bad - 10,000 dart throws does not reliably give us a 3 decimal place result. If you ran your own code you’d see this estimate vary between 3.0 and 3.2 on each run.</p><div class="figure"><a id="FIG-pi_monte_carlo_estimate"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_pi_plot_monte_carlo_example.png" alt="Estimating Pi using the Monte Carlo method" width="800" height="800" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_pi_plot_monte_carlo_example.png"></div></div><div class="figure-title">Figure&nbsp;9-1.&nbsp;Estimating Pi using the Monte Carlo method</div></div><p>To be confident of the first 3 decimal places we need to generate 10,000,000 random dart throws <sup>[<a id="id814788" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id814788" class="footnote">55</a>]</sup>. This is inefficient (and better methods for Pi’s estimation exist) but it is rather convenient to demonstrate the benefits of parallelization using <code class="literal">multiprocessing</code>.</p><p>With the Monte Carlo method we use the Pythagorean Theorem <sup>[<a id="id814834" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id814834" class="footnote">56</a>]</sup> to test if a dart has landed inside our circle:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0901.png" alt="" width="144" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0901.png"></span></p><p>As we’re using a unit circle we can optimize this by removing the square root operation as <span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0902.png" alt="" width="61" height="24" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0902.png"></span> to leave a simplfied expression to implement:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0903.png" alt="" width="113" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0903.png"></span></p><p>We’ll look at a loop version of this in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-pi-lists-calculation">Example&nbsp;9-1</a>. We’ll implement both a normal Python version and later a <code class="literal">numpy</code> version and we’ll use both Threads and Processes to parallelize the problem.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="multiprocessing-estimating-pi">Estimating Pi using Processes and Threads</h2></div></div></div><p>It is easier to understand a normal Python implementation so we’ll start with that in this section using float objects in a loop. We’ll parallelize this with Process to use all of our available CPUs and we’ll visualize the state of the machine as we use more CPUs.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_using_python_objects">Using Python objects</h3></div></div></div><p>The Python implementation is easy to follow but it carries an overhead as each Python float object has to be managed, referenced and synchronized in turn. This overhead slows down our run-time but it has bought us thinking-time as the implementation was quick to put together. By parallelizing this version we get additional speed-ups for very little extra work.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_threads_and_processes_lists">Figure&nbsp;9-2</a> shows three implementations of the Python example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
No use of <code class="literal">multiprocessing</code> (named Series)
</li><li class="listitem">
Using threads
</li><li class="listitem">
Using processes
</li></ul></div><p>When we use more than one thread or process we’re asking Python to calcualte the same total number of dart throws and to divide the work evenly between workers. If we want 100,000,000 dart throws in total using our Python implementation and we use 2 workers then we’ll be asking both threads or both processes to generate 50,000,000 dart throws per worker.</p><div class="figure"><a id="FIG-pi_monte_carlo_threads_and_processes_lists"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_pi_lists_graph_speed_tests_threaded_processes.png" alt="not set" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_pi_lists_graph_speed_tests_threaded_processes.png"></div></div><div class="figure-title">Figure&nbsp;9-2.&nbsp;Working in series, Threaded and with Processes</div></div><p>Using 1 thread takes approximately 120 seconds. Using 2 or more threads takes <span class="emphasis"><em>longer</em></span>. By using 2 or more processes the run time gets <span class="emphasis"><em>shorter</em></span>. The cost of using no processes or threads (the Series implementation) is the same as running with 1 process.</p><p>By using processes I get a linear speed-up when using 2 or 4 cores on my laptop. For the 8 worker case we’re using Intel’s HyperThreading - my laptop only has 4 physical cores so we get barely additional speed-up by running 8 processes.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-pi-lists-calculation">Example&nbsp;9-1</a> shows the Python version of our Pi estimator. If we’re using threads then each instruction is bound by the GIL so although each thread could run on a separate CPU it will only execute when no other threads are running. The process version is not bound by this restriction as each forked process has a private Python interpreter running as a single thread, so there’s no GIL contention as no objects are shared. We use Python’s built-in random number generator, see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-random-numbers">Random Numbers in Parallel Systems</a> for some notes about the dangers of parallelized random number sequences.</p><div class="example"><a id="code-pi-lists-calculation"></a><div class="example-title">Example&nbsp;9-1.&nbsp;Estimating Pi using a loop in Python</div><div class="example-contents"><pre class="screen">def estimate_nbr_points_in_quarter_circle(nbr_estimates):
    nbr_trials_in_quarter_unit_circle = 0
    for step in xrange(int(nbr_estimates)):
        x = random.uniform(0, 1)
        y = random.uniform(0, 1)
        is_in_unit_circle = x * x + y * y &lt;= 1.0
        nbr_trials_in_quarter_unit_circle += is_in_unit_circle

    return nbr_trials_in_quarter_unit_circle</pre></div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-pi-lists-main">Example&nbsp;9-2</a> shows the <code class="literal">__main__</code> block and note that we build the <code class="literal">Pool</code> before we start the timer. Spawning threads is relatively instant, spawning processes involves a fork and this takes a measurable fraction of a second. We ignore this overhead in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_threads_and_processes_lists">Figure&nbsp;9-2</a> as this cost will be a tiny fraction of the overall execution time.</p><p>We create a list containing <code class="literal">nbr_estimates</code> divided by the number of workers, this new argument will be sent to each worker. After execution we’ll receive the same number of results back, we’ll sum these to estimate the number of darts in the unit circle.</p><p>We import the process-based <code class="literal">Pool</code> from <code class="literal">multiprocessing</code>. We could also <code class="literal">from multiprocessing.dummy import Pool</code> to get a threaded version - the “dummy” name is rather misleading (I confess to not understanding why it is named this way), it is simply a light wrapper around the <code class="literal">threading</code> module to present the same interface as the process-based <code class="literal">Pool</code>.</p><div class="example"><a id="code-pi-lists-main"></a><div class="example-title">Example&nbsp;9-2.&nbsp;main for estimating Pi using a loop</div><div class="example-contents"><pre class="screen">from multiprocessing import Pool
...

if __name__ == "__main__":
    nbr_samples_in_total = 1e8
    nbr_parallel_blocks = 4
    pool = Pool(processes=nbr_parallel_blocks)
    nbr_samples_per_worker = nbr_samples_in_total / nbr_parallel_blocks
    print "Making {} samples per worker".format(nbr_samples_per_worker)
    nbr_trials_per_process = [nbr_samples_per_worker] * nbr_parallel_blocks
    t1 = time.time()
    nbr_in_unit_circles = pool.map(calculate_pi, nbr_trials_per_process)
    pi_estimate = sum(nbr_in_unit_circles) * 4 / nbr_samples_in_total
    print "Estimated pi", pi_estimate
    print "Delta:", time.time() - t1</pre></div></div><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>It is worth noting that each process we create consumes some RAM from the system. You can expect a forked process using the standard libraries to take on the order of 10-20MB of RAM, if you’re using many libraries and lots of data then you might expect each forked copy to take 100s of MB. On a system with a RAM constraint this might be a significant issue - if you run out of RAM and the system reverts to using the disk’s swap space then any parallelization advantage will be massively lost to the slow paging of RAM back and forth to disk!</p></div><p>The following figures plot the average CPU utilization of my 4 physical cores and their 4 associated HyperThreads (each HyperThread runs on unutilized silicon in a physical core). The data gathered for these figures <span class="emphasis"><em>includes</em></span> the startup time of the first Python process and the cost of starting sub-processes. The CPU sampler records the entire state of my laptop, not just the CPU time used by this tasks.</p><p>Note that the following diagrams are created using a different timing method with a slower sampling rate to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_threads_and_processes_lists">Figure&nbsp;9-2</a> so the overall run time is a little longer.</p><p>The execution behavior in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_1_processes">Figure&nbsp;9-3</a> with 1 process in the pool (along with the parent process) shows some overhead in the first seconds as the pool is created and then a consistent clost-to-100% CPU utilization throughout the run. With 1 process we’re efficiently using one core.</p><div class="figure"><a id="FIG-pi_monte_carlo_lists_1_processes"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_1_processes.png" alt="Estimating Pi using lists and 1 process" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_1_processes.png"></div></div><div class="figure-title">Figure&nbsp;9-3.&nbsp;Estimating Pi using Python objects and 1 process</div></div><p>Next we’ll add a second process, effectively saying <code class="literal">Pool(processes=2)</code>. By adding a second process <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_2_processes">Figure&nbsp;9-4</a> the execution time roughly halves to 56 seconds and two CPUs are fully occupied. This is the best result we can expect - we’ve efficiently used all the new computing resources and we’re not losing any speed to other overheads like communication, paging to disk or contention with competing processes who want to use the same CPUs.</p><div class="figure"><a id="FIG-pi_monte_carlo_lists_2_processes"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_2_processes.png" alt="Estimating Pi using lists and 2 processes" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_2_processes.png"></div></div><div class="figure-title">Figure&nbsp;9-4.&nbsp;Estimating Pi using Python objects and 2 processes</div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_4_processes">Figure&nbsp;9-5</a> we use all 4 physical CPUs, now we are using all of the raw power of this laptop. Execution time is roughly 1/4 of the single process version at 27 seconds.</p><div class="figure"><a id="FIG-pi_monte_carlo_lists_4_processes"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_4_processes.png" alt="Estimating Pi using lists and 4 processes" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_4_processes.png"></div></div><div class="figure-title">Figure&nbsp;9-5.&nbsp;Estimating Pi using Python objects and 4 processes</div></div><p>By switching to 8 processes in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_8_processes">Figure&nbsp;9-6</a> we cannot achieve more than a tiny speed-up on the 4 process version. That is because the 4 HyperThreads are only able to squeeze a little extra processing power out of spare silicon on the CPUs and the 4 CPUs are already maximally utilized.</p><div class="figure"><a id="FIG-pi_monte_carlo_lists_8_processes"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_8_processes.png" alt="Estimating Pi using lists and 8 processes" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_8_processes.png"></div></div><div class="figure-title">Figure&nbsp;9-6.&nbsp;Estimating Pi using Python objects and 8 processes with little additional gain</div></div><p>In each of the above diagrams we can see that we’re efficiently using more of the available CPU resources at each step and that the HyperThread resources are a poor addition. The biggest problem when using HyperThreads is that CPython is using a lot of RAM - it is not cache friendly so the spare resources on each chip are very poorly used. <code class="literal">numpy</code> in the following section makes better use of these resources.</p><div class="note"><h3 class="title">Note</h3><p>In my experience Hyperthreading can give up to a 30% performance gain <span class="emphasis"><em>if</em></span> ther are enough spare computing resources. This works if for example you have a mix of floating point and integer arithmatic rather than just the floating point operations we have here. By mixing the resource requirements the HyperThreads can schedule more of the CPU’s silicon to be working concurrently. Generally I see HyperThreads as an added bonus and not a resource to be optimized against as adding more CPUs is probably more economical than tuning your code which adds a support overhead.</p></div><p>Now we’ll switch to use threads in one process rather than multiple processes. The overhead around the “GIL battle” actually makes our code run <span class="emphasis"><em>more slowly</em></span>.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-davidbeazley-gil2threads">Figure&nbsp;9-7</a> shows two threads fighting on a dual core system with Python 2.6 (the same effect occurs with Python 2.7), this is the “GIL battle”. This image is taken with permissions from David Beazley’s blog post “The Python GIL Visualized” <sup>[<a id="id815432" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id815432" class="footnote">57</a>]</sup>.</p><p>The darker red tone shows Python threads repeatedly trying to get the GIL but failing. The lighter green tone is a running thread. White shows the brief periods of a thread that is idle.  We can see that there’s an overhead when adding threads to a CPU-bound task in CPython. The context switching overhead actually adds to the overall runtime. David Beazley explains this in “Understanding the Python GIL” <sup>[<a id="id815442" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id815442" class="footnote">58</a>]</sup>. Threads in Python are great for I/O bound tasks but they’re a poor choice for CPU-bound problems.</p><div class="figure"><a id="FIG-davidbeazley-gil2threads"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_davidbeazley_gil2threads.png" alt="notset" width="825" height="88" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_davidbeazley_gil2threads.png"></div></div><div class="figure-title">Figure&nbsp;9-7.&nbsp;Python threads fighting on a dual-core machine (thanks to David Beazley for the image)</div></div><p>Each time a thread wakes up and tries to acquire the GIL (whether it is available or not) it uses some system resources. If one thread is busy then the other will repeatedly awaken and try to acquire the GIL, these repeated attempts become expensive. David Beazley has an interactive set of plots which demonstrate the problem <sup>[<a id="id815426" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id815426" class="footnote">59</a>]</sup>, you can zoom in to see every failed attempt at GIL acquisition for multiple threads on multiple CPUs. Note that this is only a problem with multiple threads running on a multi-core system - a single core system with multiple threads has no “GIL battle”. This is easily seen on this page <sup>[<a id="id815423" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id815423" class="footnote">60</a>]</sup> on David’s site.</p><p>If the threads weren’t fighting for the GIL but were taking it efficiently then we shouldn’t see any of the dark red tone, instead we might expect the waiting thread to carry on waiting without consuming resources. By avoiding the battle for the GIL the overall runtime would be shorter (but still no faster than using a single thread due to the GIL). If there was no GIL then each thread could run in parallel without any waiting and so would use all of the system’s resources.</p><p>It is worth noting that the negative effect of threads on CPU bound problems is reasonably solved in Python 3.2+:</p><div class="blockquote"><blockquote class="blockquote"><p>“The mechanism for serializing execution of concurrently running Python threads (generally known as the GIL or Global Interpreter Lock) has been rewritten. Among the objectives were more predictable switching intervals and reduced overhead due to lock contention and the number of ensuing system calls. The notion of a “check interval” to allow thread switches has been abandoned and replaced by an absolute duration expressed in seconds.”</p><div class="attribution"><p>—<span class="attribution">
Raymond Hettinger
<em class="citetitle">http://docs.python.org/dev/whatsnew/3.2.html</em>
</span></p></div></blockquote></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_4_threads">Figure&nbsp;9-8</a> I run the same code that we used in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_4_processes">Figure&nbsp;9-5</a> but with threads in place of processes. Although a number of CPUs are being used, they each share the workload lightly. If each thread was running without the GIL then we’d see 100% CPU utilization on the four CPUs. Instead each CPU is partially utilized (due to the GIL) and in addition it is running slower than we’d like due to the “GIL battle”.</p><div class="figure"><a id="FIG-pi_monte_carlo_lists_4_threads"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_4.png" alt="Estimating Pi using lists and 4 threads" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_pi_lists_parallel_py_4.png"></div></div><div class="figure-title">Figure&nbsp;9-8.&nbsp;Estimating Pi using Python objects and 4 threads</div></div><p>Compare this to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_1_processes">Figure&nbsp;9-3</a> where 1 process executes the same job in approximately 120 seconds rather than 160 seconds.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="multiprocessing-random-numbers">Random Numbers in Parallel Systems</h3></div></div></div><p>Generating good random number sequences is a hard problem and it is easy to get it wrong if you try to do it yourself. Getting a good sequence quickly in parallel is even harder - suddenly you have to worry about whether you’ll get repeating or correlated sequences in the parallel processes.</p><p>We’ve just used Python’s built-in random number generator in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-pi-lists-calculation">Example&nbsp;9-1</a> and we’ll use the <code class="literal">numpy</code> random number generator in the next section in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-pi-numpy-calculation">Example&nbsp;9-3</a>. In both cases the random number generators are seeded in their forked process. For the Python <code class="literal">random</code> example the seeding is handled internally by <code class="literal">multiprocessing</code> - if during a fork it sees that <code class="literal">random</code> is in the namespace then it’ll force a call to seed the generators in each of the new processes.</p><p>In the forthcoming <code class="literal">numpy</code> example we have to do this explicitly. If you forget to seed the random number sequence with <code class="literal">numpy</code> then each of your forked processes will generate an identical sequence of random numbers.</p><p>If you care about the quality of the random numbers used in the parallel processes then we urge you to research this topic, we don’t discuss it here. <span class="emphasis"><em>Probably</em></span> the <code class="literal">numpy</code> and Python random number generators are good enough but if significant outcomes depend on the quality of the random sequences (e.g. for medical or financial systems) then you must read up on this area.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="multiprocessing-estimating-pi-using-numpy">Using numpy</h3></div></div></div><p>In this section we switch to using <code class="literal">numpy</code>. Our dart throwing problem is ideal for <code class="literal">numpy</code> vectorized operations - we generate the same estimate over 50 times faster than the Python examples before.</p><p>The main reason that <code class="literal">numpy</code> is faster when solving the same problem as our pure Python version is that it is creating and manipulating the same object types at a very low level in contiguous blocks of RAM, rather than creating many higher level Python objects which each require individual management and addressing.</p><p>As <code class="literal">numpy</code> is far more cache friendy we’ll also get a small speed boost when using the 4 HyperThreads. We didn’t get this in the pure Python version as caches aren’t used efficiently by larger Python objects.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_threads_and_processes_numpy">Figure&nbsp;9-9</a> we see three scenarios:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
No use of <code class="literal">multiprocessing</code> (named Series)
</li><li class="listitem">
Using threads
</li><li class="listitem">
Using processes
</li></ul></div><div class="figure"><a id="FIG-pi_monte_carlo_threads_and_processes_numpy"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_pi_numpy_graph_speed_tests_threaded_processes.png" alt="Working in series, Threaded and with Processes" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_pi_numpy_graph_speed_tests_threaded_processes.png"></div></div><div class="figure-title">Figure&nbsp;9-9.&nbsp;Working in series, Threaded and with Processes using numpy</div></div><p>The Serial and and single-worker versions execute at the same speed - there’s no overhead to using threads with <code class="literal">numpy</code> (and with only one worker there’s also no gain).</p><p>When using multiple processes we see a classic 100% utilization of each additional CPU, the result mirrors the plots shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_1_processes">Figure&nbsp;9-3</a>, <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_2_processes">Figure&nbsp;9-4</a>, <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_4_processes">Figure&nbsp;9-5</a> and <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-pi_monte_carlo_lists_8_processes">Figure&nbsp;9-6</a> but obviously runs much faster using <code class="literal">numpy</code>.</p><p>Interestingly the thread version runs <span class="emphasis"><em>faster</em></span> with more threads, this is the opposite behavior to the pure Python case where threads made the example run more slowly. As discussed on the SciPy wiki <sup>[<a id="id815781" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id815781" class="footnote">61</a>]</sup> by working outside of the GIL <code class="literal">numpy</code> can achieve some level of additional speed-up around threads.</p><p>Using processes gives us a predictable speedup, just as it did in the pure Python example. A second CPU doubles the speed, using four CPUs quadruples the speed.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-pi-numpy-calculation">Example&nbsp;9-3</a> shows the vectorized form of our code. Note that the random number generator is seeded when this function is called. For the thread version this isn’t necessary as each thread shares the same random number generator and they access it in series.</p><p>For the process version as each new process is a fork, all the forked versions will share the <span class="emphasis"><em>same state</em></span> so the random number calls in each will return the same sequence! By calling <code class="literal">seed()</code> each of the forked processes should generate a unique sequence of random numbers. Look back at <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-random-numbers">Random Numbers in Parallel Systems</a> for some notes about the dangers of parallelized random number sequences.</p><div class="example"><a id="code-pi-numpy-calculation"></a><div class="example-title">Example&nbsp;9-3.&nbsp;Estimating Pi using numpy</div><div class="example-contents"><pre class="screen">def estimate_nbr_points_in_quarter_circle(nbr_samples):
    # set random seed for numpy in each new process
    # else the fork will mean they all share the same state
    np.random.seed()
    xs = np.random.uniform(0, 1, nbr_samples)
    ys = np.random.uniform(0, 1, nbr_samples)
    estimate_inside_quarter_unit_circle = (xs * xs + ys * ys) &lt;= 1
    nbr_trials_in_quarter_unit_circle = np.sum(estimate_inside_quarter_unit_circle)
    return nbr_trials_in_quarter_unit_circle</pre></div></div><p>A short code analysis shows that the calls to <code class="literal">random</code> run a little slower on this machine when executed with multiple threads and the call to <code class="literal">(xs * xs + ys * ys) &lt;= 1</code> parallelizes well. Calls to the random number generator are GIL-bound as the internal state variable is a Python object.</p><p>The process to understand this was basic but reliable:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Comment out all of the <code class="literal">numpy</code> lines, run with <span class="emphasis"><em>no</em></span> threads using the Serial version, run several times and record the execution time using <code class="literal">time.time()</code> in <code class="literal">__main__</code>
</li><li class="listitem">
Add a line back (first of all I add <code class="literal">xs = np.random.uniform(...</code>), run several times again record completion times
</li><li class="listitem">
Add the next line back (now adding <code class="literal">ys = ...</code>), run again, record completion time
</li><li class="listitem">
Repeat including the <code class="literal">nbr_trials_in_quarter_unit_circle = np.sum(...</code> line
</li><li class="listitem">
Repeat this process again but this time with four threads, repeat line by line
</li><li class="listitem">
Compare the difference in run-time at each step for no-threads and four-threads
</li></ol></div><p>Because we’re running code in parallel it becomes harder to use tools like <code class="literal">line_profiler</code> or <code class="literal">cProfile</code>. Recording the raw run time and observing the differences in behavior with different configurations takes some patience but gives solid evidence from which to draw conclusions.</p><div class="note"><h3 class="title">Note</h3><p>If you want to understand the serial behavior of the <code class="literal">uniform</code> call then take a look at the <code class="literal">mtrand</code> code in the <code class="literal">numpy</code> source <sup>[<a id="id815963" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id815963" class="footnote">62</a>]</sup> and follow the call to <code class="literal">uniform</code> in <code class="literal">mtrand.pyx</code>. This is a useful exercise if you haven’t looked at the <code class="literal">numpy</code> source code before.</p></div><p>The libraries used when building <code class="literal">numpy</code> are important for some of the parallelization opportunities, depending on the underlying libraries used when building <code class="literal">numpy</code> (e.g. whether Intel’s Math Kernel Library or OpenBLAS were included or not) you’ll see different speed-up behavior.</p><p>You can check your <code class="literal">numpy</code> configuration using <code class="literal">numpy.show_config()</code>. There are some example timings <sup>[<a id="id816013" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id816013" class="footnote">63</a>]</sup> on StackOverflow if you’re curious about the possibilities. Only some <code class="literal">numpy</code> calls will benefit from parallelization by external libraries.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_finding_prime_numbers">Finding Prime Numbers</h2></div></div></div><p><a id="multiprocessing-finding-prime-numbers"></a>Next we’ll look at testing for Prime Numbers over a large number range. This is
a different problem to estimating Pi as the workload varies depending on your
location in the number range and each individual number’s check has an
unpredictable complexity. We can create a serial routine that checks for
Primality and then pass sets of numbers across multiple processes for checking.
This problem is embarrassingly parallel which means there is no state that needs
to be shared.</p><p>The <code class="literal">multiprocessing</code> module makes it easy to control the workload so we shall investigate how we can tune the work queue to use (and mis-use!) our computing resources and investigate an easy way to use our resources slightly more efficiently. This means we’re looking at <span class="emphasis"><em>load balancing</em></span> to try to efficiently distribute our varying-complexity tasks to our fixed set of resources.</p><p>We’ll use a slightly improved algorithm from the one earlier in the book in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#understanding-performance-idealized-computing">Idealized computing vs Python VM</a> which exits early if we have an even number, see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-primes-serial-generation-calculation">Example&nbsp;9-4</a>.</p><div class="example"><a id="code-primes-serial-generation-calculation"></a><div class="example-title">Example&nbsp;9-4.&nbsp;Finding Prime numbers using Python</div><div class="example-contents"><pre class="screen">def check_prime(n):
    if n % 2 == 0:
        return False
    from_i = 3
    to_i = math.sqrt(n) + 1
    for i in xrange(from_i, int(to_i), 2):
        if n % i == 0:
            return False
    return True</pre></div></div><p>How much variety in the work-load do we see when testing for a Prime with this approach? <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-primes-cost-to-check-primality">Figure&nbsp;9-10</a> shows the increasing time cost to check for Primality as the possibly-Prime <code class="literal">n</code> increases between <code class="literal">10,000</code> to <code class="literal">1,000,000</code></p><div class="figure"><a id="FIG-primes-cost-to-check-primality"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_prime_time_cost_1e4to1e6.png" alt="Time to check primality" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_prime_time_cost_1e4to1e6.png"></div></div><div class="figure-title">Figure&nbsp;9-10.&nbsp;Time required to check primality as n increases</div></div><p>Most numbers are non-Prime, they’re drawn with a <code class="literal">o</code> and some can be cheap to check for, others require the checking of many factors. Primes are drawn with an <code class="literal">x</code> and form the thick darker band, they’re the most expensive to check for. The time cost of checking a number increases as <code class="literal">n</code> increases as the range of possible factors to check increases with the square root of <code class="literal">n</code>. The sequence of Primes is not predictable so we can’t determine the expected cost of a range of numbers (we could estimate it, but we can’t be sure of its complexity).</p><p>For the figure we test each <code class="literal">n</code> 20 times and take the fastest result to remove jitter from the results.</p><p>When we distribute work to a <code class="literal">Pool</code> of processes we can specify how much work is passed to each worker. We could divide all of the work evenly and aim for one pass or we could make many chunks of work which we pass out whenever a CPU is free. This is controlled using the <code class="literal">chunksize</code> parameter. Larger chunks of work mean less communications overhead, smaller chunks of work mean more control over how resources are allocated.</p><p>For our Prime finder a single piece of work is a number <code class="literal">n</code> that is checked by <code class="literal">check_prime</code>. A <code class="literal">chunksize</code> of 10 would mean that a list of 10 <code class="literal">n</code> integers are handled by one process, one at a time.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-primes-pool-plot-chunksizetimes-type2">Figure&nbsp;9-11</a> we can see the effect of varying the <code class="literal">chunksize</code> from <code class="literal">1</code> (every job is a single piece of work) to <code class="literal">64</code> (every job is a list of 64 numbers). Although many tiny jobs gives us the greatest flexibility it also imposes the greatest communication overhead. All 4 CPUs will be utilized efficiently but the communication pipe will become a bottleneck as each job and result is passed through this single channel.</p><p>By doubling the <code class="literal">chunksize</code> to <code class="literal">2</code> our task is solved twice as quickly as we have less contention on the communication pipe. By increasing the <code class="literal">chunksize</code> we continue to improve the execution time, naively we might assume that if we continued to make the jobs bigger then we’d continue to see a speed increase.</p><div class="figure"><a id="FIG-primes-pool-plot-chunksizetimes-type2"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_primes_pool_plot_chunksizetimes_1to50000_plottype2.png" alt="notset" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_primes_pool_plot_chunksizetimes_1to50000_plottype2.png"></div></div><div class="figure-title">Figure&nbsp;9-11.&nbsp;Choosing a sensible chunksize value</div></div><p>We can continue to increase the <code class="literal">chunksize</code> until we start to see a worsening of behavior. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-primes-pool-plot-chunksizetimes-type1">Figure&nbsp;9-12</a> we expand the range of chunk sizes, making them not just tiny but also huge. The worst result shown takes 1.3 seconds where we’ve asked for <code class="literal">chunksize</code> to be <code class="literal">50000</code> - this means our <code class="literal">100000</code> items are divided into two work chunks leaving 2 CPUs idle for that entire pass.</p><p>With a <code class="literal">chunksize</code> of <code class="literal">10000</code> items we are creating 10 chunks of work - this means that 4 chunks of work will run twice in parallel following by the 2 remaining chunks. This leaves two CPUs idle in the third round of work which is an inefficient usage of resources.</p><div class="figure"><a id="FIG-primes-pool-plot-chunksizetimes-type1"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_primes_pool_plot_chunksizetimes_1to50000_plottype1.png" alt="notset" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_primes_pool_plot_chunksizetimes_1to50000_plottype1.png"></div></div><div class="figure-title">Figure&nbsp;9-12.&nbsp;Choosing a sensible chunksize value (continued)</div></div><p>An optimal solution in this case is to divide the total number of jobs by the number of CPUs and this is the default behavior in <code class="literal">multiprocessing</code>, shown as the “default” black dot in the figure.</p><p>As a general rule the default behavior is sensible, only tune it if you expect to see a real gain and definitely confirm your hypothesis against the default behavior.</p><p>Unlike with the Monte Carlo Pi problem our Prime Testing calculation has a varying complexity - sometimes a job exits quickly (an even number is detected the fastest) and sometimes the number is large and a Prime and this takes a much longer time to check.</p><p>What happens if we randomize our job sequence? For this problem we squeeze out a 2% performance gain that you can see in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-primes-pool-plot-chunksizetimes-type1-shuffled">Figure&nbsp;9-13</a>. By randomizing we reduce the likelihood of the problem that a final job in a sequence takes longer than the others, leaving all but one CPU active.</p><div class="figure"><a id="FIG-primes-pool-plot-chunksizetimes-type1-shuffled"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_primes_pool_plot_chunksizetimes_1to50000_shuffled_plottype1.png" alt="notset" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_primes_pool_plot_chunksizetimes_1to50000_shuffled_plottype1.png"></div></div><div class="figure-title">Figure&nbsp;9-13.&nbsp;Randomzing the job sequence</div></div><p>We noted in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-primes-pool-plot-chunksizetimes-type1">Figure&nbsp;9-12</a> that with a <code class="literal">chunksize</code> of <code class="literal">10000</code> we create three rounds of work, the first two rounds use 100% of the resources and the last round uses 50% of the resources. Misaligning the workload with the number of available resources leads to inefficiency.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-primes-pool-plot-chunksizetimes-by-nbrchunks-sawtoothpattern">Figure&nbsp;9-14</a> shows the odd effect that occurs when we mis-align the number of chunks of work against the number of processors. Mismatches will under-utilize the available resources. The slowest overall run time occurs when only 1 chunk of work is created, this leaves 3 unutilized CPUs. 2 work chunks leave 2 CPUs unutilized, once we have 4 work chunks we are using all of our resources. If we add a 5th work chunk then again we’re underutilizing our resources - 4 CPUs will work on their chunks and then 1 CPU will run to calculate the 5th chunk.</p><p>As we increase the number of chunks of work we can see that the inefficiencies decrease, the difference in run time between 29 and 32 work chunks is approximately 0.01 seconds. The general rule is to make lots of small jobs for efficient resource utilization if your jobs have varying run-times.</p><div class="figure"><a id="FIG-primes-pool-plot-chunksizetimes-by-nbrchunks-sawtoothpattern"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_primes_pool_plot_chunksizetimes_by_nbrchunks_sawtoothpattern.png" alt="notset" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_primes_pool_plot_chunksizetimes_by_nbrchunks_sawtoothpattern.png"></div></div><div class="figure-title">Figure&nbsp;9-14.&nbsp;The danger of choosing an inappropriate number of chunks</div></div><p>Strategies for efficiently using multiprocessing for embarrassingly parallel problems:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Split your jobs into independent units of work
</li><li class="listitem">
If you workers take varying amounts of time then consider randomizing the sequence of work (e.g. another example would be to process variable-sized files)
</li><li class="listitem">
Sorting your work-queue so slowest-jobs-go-first may be an equally useful strategy
</li><li class="listitem">
Use the default <code class="literal">chunksize</code> unless you have verified reasons for adjusting it
</li><li class="listitem">
Align the number of jobs with the number of physical CPUs (again the default <code class="literal">chunksize</code> takes care of this for you - although it’ll use any HyperThreads by default which may not offer any additional gain)
</li></ul></div><p>Note that by default <code class="literal">multiprocessing</code> will see HyperThreads as additional CPUS and so on my laptop it will allocate 8 processes when only 4 will really be running at 100% speed. The additional 4 processes could be taking up valuable RAM whilst barely offering any additional speed gain.</p><p>With a <code class="literal">Pool</code> we can split a chunk of pre-defined work up-front amongst CPUs. This is less helpful if we have dynamic workloads and particularly if we have workloads that arrive over time. For this sort of workload we might want to use a queue which I’ll introduce in the next section.</p><div class="note"><h3 class="title">Note</h3><p>If you’re working on long-running scientific problems where each job takes at least many seconds to run then you might want to review Gael Varoquaux’s <code class="literal">joblib</code> <sup>[<a id="id816594" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id816594" class="footnote">64</a>]</sup>. This tool supports lightweight pipelining, it sits on top of <code class="literal">multiprocessing</code> and offers an easier parallel interface, result caching and debugging features.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_queues_of_work">Queues of work</h3></div></div></div><p><code class="literal">multiprocessing.Queue</code> objects give us a non-persistent queue that can send any pickleable Python objects between processes. They carry an overhead as each object must be pickled to be sent and then unpickled in the consumer (along with some locking operations). If your workers are processing larger jobs then the communication overhead is probably acceptable. In the following example we’ll see that this cost is not negligible.</p><p>Working with the queues is fairly easy. In the following example we’ll check for Primes by consuming a list of candidate numbers and posting confirmed Primes back to a <code class="literal">definite_primes_queue</code>. We’ll run this with one, two, four and eight processes and confirm that these take longer than just running a single process that checks the same range.</p><p>A <code class="literal">Queue</code> gives us the ability to perform lots of inter-process communication using native Python objects, this can be useful it you’re passing around objects with lots of state. Since the <code class="literal">Queue</code> lacks persistence you probably don’t want to use them for jobs that might require robustness in the face of failure (e.g. if you lose power or a hard-drive gets corrupted).</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-queues-of-work-fullwork-check-prime">Example&nbsp;9-5</a> shows the <code class="literal">check_prime</code> function, we’re already familiar with the basic Primality test. We run in an infinite loop, blocking (waiting until work is available) on <code class="literal">possible_primes_queue.get()</code> to consume an item from the queue. Only one process can get an item at a time as the <code class="literal">Queue</code> object takes care of synchronizing the accesses. If there’s no work in the queue then the <code class="literal">.get()</code> blocks until a task is available.</p><p>When Primes are found they are <code class="literal">put</code> back on the <code class="literal">definite_primes_queue</code> for consumption by the parent process.</p><div class="example"><a id="code-queues-of-work-fullwork-check-prime"></a><div class="example-title">Example&nbsp;9-5.&nbsp;Using two Queues for IPC</div><div class="example-contents"><pre class="screen">FLAG_ALL_DONE = b"WORK_FINISHED"
FLAG_WORKER_FINISHED_PROCESSING = b"WORKER_FINISHED_PROCESSING"

def check_prime(possible_primes_queue, definite_primes_queue):
    while True:
        n = possible_primes_queue.get()
        if n == FLAG_ALL_DONE:
            # flag that our results have all been pushed to the results queue
            definite_primes_queue.put(FLAG_WORKER_FINISHED_PROCESSING)
            break
        else:
            if n % 2 == 0:
                continue
            for i in xrange(3, int(math.sqrt(n)) + 1, 2):
                if n % i == 0:
                    break
            else:
                definite_primes_queue.put(n)</pre></div></div><p>We define two flags, one is fed by the parent process as a poison pill to indicate that there is no more work available. The second is fed by the worker to confirm that it has seen the poison pill and has closed itself down.  The first poison pill is also known as a Sentinel <sup>[<a id="id816691" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id816691" class="footnote">65</a>]</sup> as it guarantees the termination of the processing loop.</p><p>When dealing with queues of work and remote workers it can be helpful to use flags like these to record that the poison pills were sent and to check that a response was sent from the children in a sensible time-window that they are shutting down. We don’t handle that process here but adding some timekeeping is a fairly simple addition to the code. The receipt of these flags can be logged or printed during debugging.</p><p>The <code class="literal">Queue</code> objects are created out of a <code class="literal">Manager</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-queues-of-work-fullwork-main1">Example&nbsp;9-6</a>. We’ll use the familiar process of building a list of <code class="literal">Process</code> objects which each contain a forked process, the two queues are sent as arguments and <code class="literal">multiprocessing</code> handles their synchronization.</p><p>Having started the new processes we had a list of jobs to the <code class="literal">possible_primes_queue</code> and end with one poison pill per process. The jobs will be consumed in FIFO order leaving the poison pills for last.</p><p>In <code class="literal">check_prime</code> we use a blocking <code class="literal">.get()</code> as the new processes will have to wait for work to appear in the queue. Since we use flags we could add some work, deal with the results and then iterate by adding more work and signal the end of life of the workers by adding the poison pills later.</p><div class="example"><a id="code-queues-of-work-fullwork-main1"></a><div class="example-title">Example&nbsp;9-6.&nbsp;Building two Queues for IPC</div><div class="example-contents"><pre class="screen">if __name__ == "__main__":
    primes = []

    manager = multiprocessing.Manager()
    possible_primes_queue = manager.Queue()
    definite_primes_queue = manager.Queue()

    NBR_PROCESSES = 2
    pool = Pool(processes=NBR_PROCESSES)
    processes = []
    for _ in range(NBR_PROCESSES):
        p = multiprocessing.Process(target=check_prime,
                                    args=(possible_primes_queue, definite_primes_queue))
        processes.append(p)
        p.start()

    t1 = time.time()
    number_range = xrange(100000000, 101000000)

    # add jobs to the inbound work queue
    for possible_prime in number_range:
        possible_primes_queue.put(possible_prime)

    # add poison pills to stop the remote workers
    for n in xrange(NBR_PROCESSES):
        possible_primes_queue.put(FLAG_ALL_DONE)</pre></div></div><p>To consume the results we start another infinite loop in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-queues-of-work-fullwork-main2">Example&nbsp;9-7</a> using a blocking <code class="literal">.get()</code> on the <code class="literal">definite_primes_queue</code>. If the finished-processing flag is found then we take a count of the number of processes that have signalled their exit. If not then we have a new Prime and we add this to the <code class="literal">primes</code> list.</p><p>We exit the infinite loop when all of our processes have signalled their exit.</p><div class="example"><a id="code-queues-of-work-fullwork-main2"></a><div class="example-title">Example&nbsp;9-7.&nbsp;Using two Queues for IPC</div><div class="example-contents"><pre class="screen">    processors_indicating_they_have_finished = 0
    while True:
        new_result = definite_primes_queue.get()  # block whilst waiting for results
        if new_result == FLAG_WORKER_FINISHED_PROCESSING:
            processors_indicating_they_have_finished += 1
            if processors_indicating_they_have_finished == NBR_PROCESSES:
                break
        else:
            primes.append(new_result)
    assert processors_indicating_they_have_finished == NBR_PROCESSES

    print "Took:", time.time() - t1
    print len(primes), primes[:10], primes[-10:]</pre></div></div><p>There is quite an overhead to using a Queue due to the pickling and synchronization. As you can see in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-queues-of-work-fullwork">Figure&nbsp;9-15</a> using a Queue-less single process solution is significantly faster than using any number of processes. The reason in this case is because our workload is very light - the communication cost dominates the overall time for this task.</p><p>Two processes complete this example a little faster than using one process, four and eight processes are each slower.</p><div class="figure"><a id="FIG-queues-of-work-fullwork"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/multiprocessing_serial_vs_queue_times.png" alt="notset" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/multiprocessing_serial_vs_queue_times.png"></div></div><div class="figure-title">Figure&nbsp;9-15.&nbsp;Cost of using Queue objects</div></div><p>If your task has a long completion time (at least a sizeable fraction of a second) with a small amount of communication then a <code class="literal">Queue</code> approach might be the right answer. You will have to verify whether the communication cost makes this approach useful enough.</p><p>You might wonder what happens if we remove the redundant half of the job queue (all the even numbers - these are rejected very quickly in <code class="literal">check_prime</code>). By halving the size of the input queue our execution time halves in each case (and it still doesn’t beat the single-process non-Queue example!). This helps to illustrate that the communication cost is the dominating factor in this problem.</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title" id="_asynchronously_adding_jobs_to_the_queue">Asynchronously adding jobs to the Queue</h4></div></div></div><p>By adding a <code class="literal">Thread</code> into the main process we can feed jobs asynchronously into the <code class="literal">possible_primes_queue</code>. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-queues-of-work-fullwork-jobs-feeder-thread">Example&nbsp;9-8</a> we define a <code class="literal">feed_new_jobs</code> function, it performs the same job as the job setup routine that we had in <code class="literal">__main__</code> before but it does it in a separate thread.</p><div class="example"><a id="code-queues-of-work-fullwork-jobs-feeder-thread"></a><div class="example-title">Example&nbsp;9-8.&nbsp;Asynchronous job feeding function</div><div class="example-contents"><pre class="screen">def feed_new_jobs(number_range, possible_primes_queue, nbr_poison_pills):
    for possible_prime in number_range:
        possible_primes_queue.put(possible_prime)
    # add poison pills to stop the remote workers
    for n in xrange(nbr_poison_pills):
        possible_primes_queue.put(FLAG_ALL_DONE)</pre></div></div><p>Now in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-queues-of-work-fullwork-main">Example&nbsp;9-9</a> our <code class="literal">__main__</code> will setup the <code class="literal">Thread</code> using the <code class="literal">possible_primes_queue</code> and then move on to the result-collection phase <span class="emphasis"><em>before</em></span> any work has been issued. The asynchronous job feeder could consume work from external sources (e.g. from a database or I/O bound communication) whilst the <code class="literal">__main__</code> thread handles each processed result. This means that the input sequence and output sequence do not need to be created in advance, they can both be handled on the fly.</p><div class="example"><a id="code-queues-of-work-fullwork-main"></a><div class="example-title">Example&nbsp;9-9.&nbsp;Using a Thread to setup an asyncronoush job feeder</div><div class="example-contents"><pre class="screen">if __name__ == "__main__":
    primes = []
    manager = multiprocessing.Manager()
    possible_primes_queue = manager.Queue()

    ...

    import threading
    thrd = threading.Thread(target=feed_new_jobs,
                            args=(number_range,
                                  possible_primes_queue,
                                  NBR_PROCESSES))
    thrd.start()

    # deal with the results</pre></div></div><p>It is <span class="emphasis"><em>very likely</em></span> that if you want robust asynchronous systems then you should probably look to an external library that is mature. <code class="literal">gevent</code>, <code class="literal">tornado</code> and <code class="literal">Twisted</code> are strong candidates, Python 3.4’s <code class="literal">tulip</code> is a new contender. The above examples will get you started but pragmatically they are more useful for simply systems and education than for production systems.</p><div class="informalexample"><a id="NOTE"></a><p>Another single-machine queue you might want to investigate is PyRes <sup>[<a id="id817027" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id817027" class="footnote">66</a>]</sup>. This module that uses Redis to store the queue’s state. I introduce Redis in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-using-redis-as-a-flag">Using Redis as a flag</a> later in this Chapter. Redis is a non-Python data storage system, a queue of data held in Redis is readable outside of Python (so you can inspect the queue’s state) and could be shared with non-Python systems.</p></div><p>Be <span class="emphasis"><em>very aware</em></span> that asynchronous systems require a special level of patience - you will end up tearing out your hair whilst you are debugging. We’d suggest:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Apply the “Keep It Simple, Stupid” principle
</li><li class="listitem">
Probably avoid asynchronous self-contained systems (like the above example) if possible as they will grow in complexity and quickly will become hard to maintain
</li><li class="listitem">
Use mature libraries like <code class="literal">gevent</code> which give you tried-and-tested approaches to dealing with certain problem sets
</li></ul></div><p>We’d strongly suggest using an external queue system (e.g. <code class="literal">Gearman</code>, <code class="literal">0MQ</code>, <code class="literal">Celery</code>, <code class="literal">PyRes</code> or <code class="literal">HotQueue</code>) which gives you external visibility on the state of the queues. This requires more thought but is likely to save you time due to increased debug efficiency and better system visibility for production systems.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_verifying_primes_using_inter_process_communication">Verifying Primes using Inter Process Communication</h2></div></div></div><p><a id="multiprocessing-verifying-primes-using-inter-process-communication"></a>Prime numbers have no factor other than themselves and one. It stands to reason that the most common factor is two (every even number cannot be a Prime). After that the low Prime numbers (e.g. 3, 5, 7) become factors of larger non-Primes (e.g. 9, 15, 21 respectively).</p><p>Let’s say that we’re given a large number and we’re asked to verify if it is Prime. We will probably have a large space of factors to search. <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-verifying-primes-count-of-factors-of-nonprimes">Figure&nbsp;9-16</a> shows the frequency of each factor for non-primes up to 10,000,000. Low factors are far more likely to occur than high factors but there’s no predictable pattern.</p><div class="figure"><a id="FIG-verifying-primes-count-of-factors-of-nonprimes"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/primes_validation_count_of_factors.png" alt="notset" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/primes_validation_count_of_factors.png"></div></div><div class="figure-title">Figure&nbsp;9-16.&nbsp;The frequency of factors of non-primes</div></div><p>Let’s define a new problem - we have a <span class="emphasis"><em>small</em></span> set of numbers and our task is to efficiently use our CPU resources to figure out if each number is a Prime, one number at a time. Possibly we’ll have just one large number to test. It no longer makes sense to use 1 CPU to do the check, we want to co-ordinate the work across many CPUs.</p><p>For this section we’ll look at some larger numbers, one of 15 digits and four with 18 digits:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
small non-prime: 112272535095295
</li><li class="listitem">
large non-prime 1: 100109100129100369
</li><li class="listitem">
large non-prime 2: 100109100129101027
</li><li class="listitem">
prime 1: 100109100129100151
</li><li class="listitem">
prime 2: 100109100129162907
</li></ol></div><p>By using a smaller non-prime and some larger non-primes we get to verify that our chosen process is not just faster at checking for primes but that it is also not getting slower at checking non-primes. We’ll assume that we don’t know the size or type of numbers that we’re being given so we want the fastest possible result for all our use-cases.</p><p>Co-operation comes at a cost - the cost of synchronizing data and checking the shared data can be quite high. We’ll work through several approaches here which can be used in different ways for task co-ordination. Note that I’m <span class="emphasis"><em>not</em></span> covering MPI (Message Passing Interface) here which is somewhat specialist, we’re lookinng at batteries-included modules and Redis (which is very common).</p><p>If you want to use MPI then I’m assuming you already know what you’re doing. The MPI4PY <sup>[<a id="id817243" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id817243" class="footnote">67</a>]</sup> project would be a good place to start. It is an ideal technology if you want to control latency when lots of processes are collaborating whether you have 1 or many machines.</p><p>For the following runs each test is performed 20 times and the minimum time is taken to show the fastest speed that is possible for that method. In these examples I’m using various techniques to share a flag (often as 1 byte). We could use a basic object like a <code class="literal">Lock</code> but then you could only share 1 bit of state. I’m choosing to show you how to share a primitive type so that more expressive state sharing is possible (even though we don’t need a more expressive state for this example).</p><p>I must emphasise that sharing state tends to make things <span class="emphasis"><em>get complicated</em></span> - you can easily end up in another hair-pulling state. Be careful and try to keep things as simple as they could be. It might be the case that less efficient resource usage is trumped by developer time spent on other challenges.</p><p>First we should discuss the results, then we’ll work through the code.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-validating-primes-slower-results">Figure&nbsp;9-17</a> shows the first approaches to trying to use inter-process communication to test for Primality faster. The benchmark is the Serial version which does not use any inter-process communication, each attempt to speed-up our code must at least be faster than this.</p><p>The Less Naive Pool version has a predictable (and good) speed. It is good enough to be rather hard to beat. Don’t overlook the obvious in your search for high-speed solutions, sometimes a dumb and good-enough solution is all you need.</p><p>The approach for the Less Naive Pool solution is to take our number under test, divide its possible-factor range evenly amongst the available CPUs and then push the work out to each CPU. If any CPU finds a factor is will exit early but it won’t communicate this fact - the other CPUs will continue to work through their part of the range. This means for an 18 digit number (our four larger examples) the search time is the same whether it is Prime or non-Prime.</p><p>The Redis and Manager solutions are slower when it comes to testing a larger number of factors for Primality due to the communication overhead. They use a shared flag to indicate that a factor has been found and the search should be called off.</p><p>Redis lets you share state not just to other Python processes but also to other tools and other machines and even to expose that state over a web-browser interface (which might be useful for remote monitoring). The Manager is a part of <code class="literal">multiprocessing</code>, it provides a high-level synchronized set of Python objects (including primitives, the <code class="literal">list</code> and the <code class="literal">dict</code>).</p><p>For the larger non-Prime cases although there is a cost to checking the shared flag, this is dwarfed by the saving in search time by signalling early that a factor has been found.</p><p>For the Prime cases though there is no way to exit early as no factor will be found, so the cost of checking the shared flag will become the dominating cost.</p><div class="figure"><a id="FIG-validating-primes-slower-results"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/multiprocessing_plot_prime_validation_times_slower_results.png" alt="notset" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/multiprocessing_plot_prime_validation_times_slower_results.png"></div></div><div class="figure-title">Figure&nbsp;9-17.&nbsp;The slower ways to use IPC to validate Primality</div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-validating-primes-faster-results">Figure&nbsp;9-18</a> shows that we can get a considerably faster result with a bit of effort. The Less naive Pool result is still our benchmark and the RawValue and MMap (memory-map) results are much faster than the previous Redis and Manager results. The real magic comes by taking the fasest solution and performing some less-obvious code manipulations to make a near-optimal MMap solution, this final version is faster than the Less naive Pool solution and almost as fast as it in the Primes case.</p><div class="figure"><a id="FIG-validating-primes-faster-results"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/multiprocessing_plot_prime_validation_times_faster_results.png" alt="notset" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/multiprocessing_plot_prime_validation_times_faster_results.png"></div></div><div class="figure-title">Figure&nbsp;9-18.&nbsp;The faster ways to use IPC to validate Primality</div></div><p>In the following section we’ll work through various ways of using IPC in Python to solve our co-operative search problem. I hope you’ll see that IPC is fairly easy but generally comes with a cost.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_serial_verification_is_inefficient">Serial verification is inefficient</h3></div></div></div><p>We’ll start with the same serial checking code that we used before, shown again in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-serial">Example&nbsp;9-10</a>. As noted above for any non-Prime with a large factor we could more efficiently search the space of factors in parallel. A serial sweep will give us a sensible baseline to work from.</p><div class="example"><a id="code-verifying-primes-serial"></a><div class="example-title">Example&nbsp;9-10.&nbsp;Serial verification</div><div class="example-contents"><pre class="screen">def check_prime(n):
    if n % 2 == 0:
        return False
    from_i = 3
    to_i = math.sqrt(n) + 1
    for i in xrange(from_i, int(to_i), 2):
        if n % i == 0:
            return False
    return True</pre></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_naive_pool_solution">Naive Pool solution</h3></div></div></div><p>The Naive Pool solution works with a <code class="literal">multiprocessing.Pool</code> as we’ve already seen in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-finding-prime-numbers">Finding Prime Numbers</a> and <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-estimating-pi">Estimating Pi using Processes and Threads</a> with four forked processes. We have a number to test for Primality, we divide the range of possible factors into four tuples of sub-ranges and send these into the <code class="literal">Pool</code>.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-pool1-1">Example&nbsp;9-11</a> we use a new method <code class="literal">create_range.create</code> (which I won’t show - it is quite boring) that splits the work space into equal sized regions, where each item in <code class="literal">ranges_to_check</code> is an pair of lower and upper bounds to search between. For the first 18 digit non-prime (100109100129100369) with 4 processes we’ll have the factor ranges <code class="literal">ranges_to_check == [(3, 79100057), (79100057, 158200111), (158200111, 237300165), (237300165, 316400222)]</code> (where 316400222 is the square root of 100109100129100369 plus one).</p><p>In <code class="literal">__main__</code> we establish a <code class="literal">Pool</code>, <code class="literal">check_prime</code> then splits the <code class="literal">ranges_to_check</code> for each possibly-Prime number <code class="literal">n</code> via a <code class="literal">map</code>. If the result is <code class="literal">False</code> then we have found a factor and we do not have a Prime.</p><div class="example"><a id="code-verifying-primes-pool1-1"></a><div class="example-title">Example&nbsp;9-11.&nbsp;Naive Pool solution</div><div class="example-contents"><pre class="screen">def check_prime(n, pool, nbr_processes):
    from_i = 3
    to_i = int(math.sqrt(n)) + 1
    ranges_to_check = create_range.create(from_i, to_i, nbr_processes)
    ranges_to_check = zip(len(ranges_to_check) * [n], ranges_to_check)
    assert len(ranges_to_check) == nbr_processes
    results = pool.map(check_prime_in_range, ranges_to_check)
    if False in results:
        return False
    return True

if __name__ == "__main__":
    NBR_PROCESSES = 4
    pool = Pool(processes=NBR_PROCESSES)
    ...</pre></div></div><p>We modify the previous <code class="literal">check_prime</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-pool1-2">Example&nbsp;9-12</a> to take a lower and upper bound for the range to check. There’s no value in passing a complete list of possible-factors to check so we save time and memory by passing just two numbers that define our range.</p><div class="example"><a id="code-verifying-primes-pool1-2"></a><div class="example-title">Example&nbsp;9-12.&nbsp;check_prime_in_range</div><div class="example-contents"><pre class="screen">def check_prime_in_range((n, (from_i, to_i))):
    if n % 2 == 0:
        return False
    assert from_i % 2 != 0
    for i in xrange(from_i, int(to_i), 2):
        if n % i == 0:
            return False
    return True</pre></div></div><p>For the “small non-Prime” case the verification time via the Pool is 0.1 second, a significantly longer time than the original 0.000002 seconds in the Serial process. Accepting this one worse result the overall result is a speed-up across the board. We might accept that one slower result isn’t a problem - but what if we might get lots of smaller non-Primes to check? It turns out we can avoid this slow-down, we’ll see that next with the Less Naive Pool solution.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_a_less_naive_pool_solution">A Less Naive Pool solution</h3></div></div></div><p>The previous solution was inefficient at validating the smaller non-Prime. For any smaller (less than 18 digit) non-Prime it is likely to be slower than the serial method due to the overhead of sending out partitioned work and not knowing if a very small factor (which are the more likely factors) will be found. If a small factor is found then the process would have to wait for the other larger factor searches to complete.</p><p>We could start to signal between the processes that a small factor had been found but since they happen so frequently, this adds a lot of communications overhead. The solution presented in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-pool2-1">Example&nbsp;9-13</a> is a more pragmatic approach - a serial check is performed quickly for likely small factors and if none are found then a parallel search is started. Combining a serial pre-check before launching a relatively more expensive parallel operation is a common approach to avoiding some of the the costs of parallel computing.</p><p>The speed of this solution is equal to or better than the original serial search for each of our test numbers. This is our new benchmark.</p><p>Importantly this Pool approach gives us an optimal case for the Prime-checking situation. If we have a Prime then there’s no way to exit early, we have to manually check all possible factors before we can exit.</p><div class="example"><a id="code-verifying-primes-pool2-1"></a><div class="example-title">Example&nbsp;9-13.&nbsp;Improving the Naive Pool Solution for the small-non-Prime case</div><div class="example-contents"><pre class="screen">def check_prime(n, pool, nbr_processes):
    # cheaply check high probability set of possible factors
    from_i = 3
    to_i = 21
    if not check_prime_in_range((n, (from_i, to_i))):
        return False

    # continue to check for larger factors in parallel
    from_i = to_i
    to_i = int(math.sqrt(n)) + 1
    ranges_to_check = create_range.create(from_i, to_i, nbr_processes)
    ranges_to_check = zip(len(ranges_to_check) * [n], ranges_to_check)
    assert len(ranges_to_check) == nbr_processes
    results = pool.map(check_prime_in_range, ranges_to_check)
    if False in results:
        return False
    return True</pre></div></div><p>There’s no faster way to check though these factors as any approach that adds complexity will have more instructions and so the check-all-factors case will cause the most instructions to be executed. See the various <code class="literal">mmap</code> solutions at the end of this section for a discussion on how to get as close to this current result for Primes as possible.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_using_manager_value_as_a_flag">Using Manager.Value as a flag</h3></div></div></div><p>The <code class="literal">multiprocessing.Manager()</code> lets us share higher level Python objects between processes as managed shared objects, the lower-level objects are wrapped in proxy objects. The wrapping and safety has a speed-cost but also offers great flexibility. You can share both lower level objects (e.g. integers and floats) and also lists and dictionaries.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-managervalue1">Example&nbsp;9-14</a> we create a <code class="literal">Manager</code> and then create a 1 byte (character) <code class="literal">manager.Value(b"c", FLAG_CLEAR)</code> flag. You could create any of the <code class="literal">ctypes</code> primitives (which are the same as the <code class="literal">array.array</code> primitives) if you wanted to share strings or numbers.</p><p>Note that <code class="literal">FLAG_CLEAR</code> and <code class="literal">FLAG_SET</code> are assigned a byte (<code class="literal">b'0'</code> and <code class="literal">b'1'</code> respectively), I’ve chosen to use the leading <code class="literal">b</code> to be very explicit (it might default to a unicode or string object if left as an implicit string depending on your environment and Python version).</p><p>Now we can flag across all of our processes that a factor has been found so the search can be called off early. The difficulty is balancing the cost of reading the flag against the speed saving that is possible. Because the flag is synchronized we don’t want to check it too frequenly - this adds an additional overhead.</p><div class="example"><a id="code-verifying-primes-managervalue1"></a><div class="example-title">Example&nbsp;9-14.&nbsp;Passing a Manager.Value object as a flag</div><div class="example-contents"><pre class="screen">SERIAL_CHECK_CUTOFF = 21
CHECK_EVERY = 1000
FLAG_CLEAR = b'0'
FLAG_SET = b'1'
print "CHECK_EVERY", CHECK_EVERY

if __name__ == "__main__":
    NBR_PROCESSES = 4
    manager = multiprocessing.Manager()
    value = manager.Value(b'c', FLAG_CLEAR)  # 1 byte character
    ...</pre></div></div><p><code class="literal">check_prime_in_range</code> will now be aware of the shared flag. The routine will be checking to see if a Prime has been spotted by another process, even though we’ve yet to begin the parallel search we must clear the flag in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-managervalue2">Example&nbsp;9-15</a> before we start the serial check. Having completed the serial check if we haven’t found a factor then we know that the flag must still be false.</p><div class="example"><a id="code-verifying-primes-managervalue2"></a><div class="example-title">Example&nbsp;9-15.&nbsp;Clearing the flag with a Manager.Value</div><div class="example-contents"><pre class="screen">def check_prime(n, pool, nbr_processes, value):
    # cheaply check high probability set of possible factors
    from_i = 3
    to_i = SERIAL_CHECK_CUTOFF
    value.value = FLAG_CLEAR
    if not check_prime_in_range((n, (from_i, to_i), value)):
        return False

    from_i = to_i
    ...</pre></div></div><p>How frequently should we check the shared flag? Each check has a cost, both because we’re adding more instructions to our tight inner-loop and because checking requires a lock to be made on the shared variable which adds additional cost. The solution I’ve chosen is to check the flag every 1000 iterations. Every time we can check we look to see if <code class="literal">value.value</code> has been set to <code class="literal">FLAG_SET</code>, if so we exit the search. If in the search the process finds a factor then it sets <code class="literal">value.value = FLAG_SET</code> and exits.</p><p>The 1000 iteration check is performend using a <code class="literal">check_every</code> local counter. It turns out that this approach, although readable, is sub-optimal for speed. By the end of this section we’ll replace it with a less readable but significantly faster approach.</p><div class="example"><a id="code-verifying-primes-managervalue3"></a><div class="example-title">Example&nbsp;9-16.&nbsp;Passing a Manager.Value object as a flag</div><div class="example-contents"><pre class="screen">def check_prime_in_range((n, (from_i, to_i), value)):
    if n % 2 == 0:
        return False
    assert from_i % 2 != 0
    check_every = CHECK_EVERY
    for i in xrange(from_i, int(to_i), 2):
        check_every -= 1
        if not check_every:
            if value.value == FLAG_SET:
                return False
            check_every = CHECK_EVERY

        if n % i == 0:
            value.value = FLAG_SET
            return False
    return True</pre></div></div><p>You might be curious about the total number of times we check for the shared flag - in the case of the two large primes with four processes we check for the flag 316,405 times (we check it this many times in all of the following examples). Since each check has an overhead due to locking, this cost really adds up.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_using_redis_as_a_flag">Using Redis as a flag</h3></div></div></div><p><a id="multiprocessing-using-redis-as-a-flag"></a>Redis is a key-value in-memory storage engine. It provides its own locking and each operation is atomic so we don’t have to worry about using locks from inside Python (or from any other interfacing language).</p><p>By using Redis we make the data storage language-agnostic - any language or tool with an interface to Redis can share data in a compatible way. You could share data between Python, Ruby, C++ and PHP equally easily. You can share data on the local machine or over a network - you need to change the Redis default of sharing only on <code class="literal">localhost</code> if you want to share to other machines.</p><p>Redis lets you store:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
lists of strings
</li><li class="listitem">
sets of strings
</li><li class="listitem">
sorted sets of strings
</li><li class="listitem">
hashes of strings
</li></ul></div><p>Redis stores everything in RAM and snapshots to disk (optionally using journaling) and supports master-slave replication to a cluster of instances. One possibility with Redis is to use it to share a workload across a cluster, where other machines read and write state and Redis acts as a fast centralized data repository.</p><p>We can read and write a flag as a text string (all values in Redis are strings) in just the same way as we have been using Python flags previously. We create a <code class="literal">StrictRedis</code> interface as a global object, this talks to the external Redis server. We could create a new connection inside <code class="literal">check_prime_in_range</code> but this is slower and can exhaust the limited number of Redis handles that are available.</p><p>We talk to the Redis server using a dictionary-like access - we can set a value using <code class="literal">rds[SOME_KEY] = SOME_VALUE</code> and read the string back using <code class="literal">rds[SOME_KEY]</code>.</p><p>The example in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-redis1">Example&nbsp;9-17</a> is very similar to the previous <code class="literal">Manager</code> example - we’re using Redis as a substitute for the local Manager. It comes with a similar access cost.</p><p>You should note that Redis supports other (more complex) datastructures - it is a powerful storage engine that we’re using just to share a flag for this example. I encourage you to familiarize yourself with its features.</p><div class="example"><a id="code-verifying-primes-redis1"></a><div class="example-title">Example&nbsp;9-17.&nbsp;Using an external Redis server for our flag</div><div class="example-contents"><pre class="screen">FLAG_NAME = b'redis_primes_flag'
FLAG_CLEAR = b'0'
FLAG_SET = b'1'

rds = redis.StrictRedis()


def check_prime_in_range((n, (from_i, to_i))):
    if n % 2 == 0:
        return False
    assert from_i % 2 != 0
    check_every = CHECK_EVERY
    for i in xrange(from_i, int(to_i), 2):
        check_every -= 1
        if not check_every:
            flag = rds[FLAG_NAME]
            if flag == FLAG_SET:
                return False
            check_every = CHECK_EVERY

        if n % i == 0:
            rds[FLAG_NAME] = FLAG_SET
            return False
    return True


def check_prime(n, pool, nbr_processes):
    # cheaply check high probability set of possible factors
    from_i = 3
    to_i = SERIAL_CHECK_CUTOFF
    rds[FLAG_NAME] = FLAG_CLEAR
    if not check_prime_in_range((n, (from_i, to_i))):
        return False

    ...
    if False in results:
        return False
    return True</pre></div></div><p>To confirm that the data is stored outside of these Python instances we can invoke the <code class="literal">redis-cli</code> at the command line in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-redis-cli">Redis-cli example</a> and get the value stored in the key <code class="literal">redis_primes_flag</code>. You’ll note that the returned item is a string (not an integer). All values returned from Redis are strings so if you want to manipulate them in Python, you’ll have to convert them to an appropriate data type first.</p><p><a id="code-08-redis-cli"></a><span class="title"><strong>Redis-cli example</strong></span>.&nbsp;
</p><pre class="screen">====
$ redis-cli
redis 127.0.0.1:6379&gt; GET "redis_primes_flag"
"0"
====</pre><p>
</p><p>One powerful argument in favour of the use of Redis for data sharing is that it lives outside of the Python world - non-Python developers on your team will understand it and many tools exist for it. They’ll be able to look at its state whilst reading (but not necessarily running and debugging) your code and follow what’s happening. From a team-velocity perspective this might be a big win for you, despite the communication overhead of using Redis. Whilst Redis is an additional dependency on your project you should note that it is a very commonly deployed tool, it is well debugged and well understood. Consider it a powerful tool to add to your armory.</p><p>Redis has many configuration options. By default it uses a TCP interface (that’s what I’m using), their benchmarks documentation notes that sockets might be much faster. TCP/IP lets you share data over a network between different types of OS, other configuration options are likely to be faster and also to limit your communication options.</p><div class="blockquote"><blockquote class="blockquote"><p>“When the server and client benchmark programs run on the same box, both the TCP/IP loopback and unix domain sockets can be used. It depends on the platform, but unix domain sockets can achieve around 50% more throughput than the TCP/IP loopback (on Linux for instance). The default behavior of redis-benchmark is to use the TCP/IP loopback.
The performance benefit of unix domain sockets compared to TCP/IP loopback tends to decrease when pipelining is heavily used (i.e. long pipelines).”</p><div class="attribution"><p>—<span class="attribution">
Redis documentation
<em class="citetitle">http://redis.io/topics/benchmarks</em>
</span></p></div></blockquote></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_using_rawvalue_as_a_flag">Using RawValue as a flag</h3></div></div></div><p>The <code class="literal">multiprocessing.RawValue</code> is a thin wrapper around a <code class="literal">ctypes</code> block of bytes. It lacks synchronization primitives and so there’s little to get in our way in our search for the fastest way to set a flag between processes. It will be almost as fast as the following <code class="literal">mmap</code> example (it is only slower because a few more instructions get in the way).</p><p>Again we could use any <code class="literal">ctypes</code> primitive, there’s also a <code class="literal">RawArray</code> option for sharing an array of primitive objects (which will behave similarly to <code class="literal">array.array</code>). <code class="literal">RawValue</code> avoids any locking - it is faster to use but you don’t get atomic operations.</p><p>Generally if you avoid the synchronization that Python provides during IPC then you’ll come unstuck (once again - back to that pulling-your-hair-out situation). <span class="emphasis"><em>However</em></span> in this problem it doesn’t matter if one or more processes set the flag at the same time - the flag only gets switched in one direction and every other time it is read it is just to learn if the search can be called off.</p><p>Because we never reset the state of the flag during the parallel search we don’t need synchronization. Be aware that this may not apply to your problem. If you avoid synchronization - please make sure you are doing it for the right reasons.</p><p>If you want to do things like update a shared counter then look at the documentation for the <code class="literal">Value</code> and use a context manager with <code class="literal">value.get_lock()</code> <sup>[<a id="id818012" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id818012" class="footnote">68</a>]</sup> as the implicit locking on a <code class="literal">Value</code> doesn’t allow for atomic operations.</p><p>This example looks very similar to the <code class="literal">Manager</code> example before, the only difference is that in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-value1">Example&nbsp;9-18</a> we create the <code class="literal">RawValue</code> as a 1 character (byte) flag.</p><div class="example"><a id="code-verifying-primes-value1"></a><div class="example-title">Example&nbsp;9-18.&nbsp;Creating and passing a RawValue</div><div class="example-contents"><pre class="screen">if __name__ == "__main__":
    NBR_PROCESSES = 4
    value = multiprocessing.RawValue(b'c', FLAG_CLEAR)  # 1 byte character
    pool = Pool(processes=NBR_PROCESSES)
    ...</pre></div></div><p>The flexibility to use managed and raw values is a benefit of the clean design for data sharing in <code class="literal">multiprocessing</code>.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_using_mmap_as_a_flag">Using mmap as a flag</h3></div></div></div><p>Finally we get to the fastest way of sharing bytes - <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-mmap1">Example&nbsp;9-19</a> shows a memory mapped (shared memory) solution using the <code class="literal">mmap</code> module. The bytes in a shared memory block are not synchronized and they come with very little overhead. They act like a file - in this case they are a block of memory with a file-like interface. We have to <code class="literal">seek</code> to a location and read or write sequentially.</p><p>Typically this is used to give a short (memory-mapped) view into a larger file, in our case rather than specifying a file number as the first argument we instead pass <code class="literal">-1</code> to indicate that we want an anonymous block of memory. We could also specify whether we want read-only or write-only access (we want both which is the default).</p><div class="example"><a id="code-verifying-primes-mmap1"></a><div class="example-title">Example&nbsp;9-19.&nbsp;Using a shared memory flag via mmap</div><div class="example-contents"><pre class="screen">sh_mem = mmap.mmap(-1, 1)  # memory map 1 byte as a flag


def check_prime_in_range((n, (from_i, to_i))):
    if n % 2 == 0:
        return False
    assert from_i % 2 != 0
    check_every = CHECK_EVERY
    for i in xrange(from_i, int(to_i), 2):
        check_every -= 1
        if not check_every:
            sh_mem.seek(0)
            flag = sh_mem.read_byte()
            if flag == FLAG_SET:
                return False
            check_every = CHECK_EVERY

        if n % i == 0:
            sh_mem.seek(0)
            sh_mem.write_byte(FLAG_SET)
            return False
    return True


def check_prime(n, pool, nbr_processes):
    # cheaply check high probability set of possible factors
    from_i = 3
    to_i = SERIAL_CHECK_CUTOFF
    sh_mem.seek(0)
    sh_mem.write_byte(FLAG_CLEAR)
    if not check_prime_in_range((n, (from_i, to_i))):
        return False

    ...
    if False in results:
        return False
    return True</pre></div></div><p>A <code class="literal">mmap</code> has a number of methods to move around the file that it would normally represent (including <code class="literal">find</code>, <code class="literal">readline</code>, <code class="literal">write</code>). We are using it in the most basic way - we <code class="literal">seek</code> to the start of the memory block before each read or write and since we’re sharing just 1 byte, we use <code class="literal">read_byte</code> and <code class="literal">write_byte</code> to be explict.</p><p>This is no Python overhead for locking and no interpretation of the data, we’re dealing with bytes directly with the Operating System so this is our fastest communication method.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_using_mmap_as_a_flag_redux">Using mmap as a flag redux</h3></div></div></div><p>Whilst the previous <code class="literal">mmap</code> result was the best overall, I couldn’t help but think that we should be able to get back to the naive <code class="literal">Pool</code> result for the most expensive case of having Primes. The goal is to accept that there is no early exit from the inner loop and to minimize the cost of anything extraneous.</p><p>I present a slightly more complex solution below, the same changes can be made to the other flag-based approaches above although this <code class="literal">mmap</code> result will still be fastest.</p><p>In our previous example we’ve used <code class="literal">CHECK_EVERY</code>, this means we have the <code class="literal">check_next</code> local variable to track, decrement and use in Boolean tests - each operations adds a bit of extra time to every iteration. In the case of validating a large Prime this extra management occurs over 300,000 times.</p><p>The first optimization, shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-mmap2-1">Example&nbsp;9-20</a>, is to realize that we can replace the decremented counter with a look-ahead value and then we only have to do a Boolean comparison on the inner loop.</p><p>This removes a decrement which, due to Python’s interpreted style, is quite slow. This optimization works in this test in CPython 2.7, it is unlikely to offer any benefit in a smarter compiler (e.g. PyPy or Cython).</p><p>This step saves 0.7 seconds when checking one of our large Primes.</p><div class="example"><a id="code-verifying-primes-mmap2-1"></a><div class="example-title">Example&nbsp;9-20.&nbsp;Starting to optimize away our expensive logic</div><div class="example-contents"><pre class="screen">def check_prime_in_range((n, (from_i, to_i))):
    if n % 2 == 0:
        return False
    assert from_i % 2 != 0
    check_next = from_i + CHECK_EVERY
    for i in xrange(from_i, int(to_i), 2):
        if check_next == i:
            sh_mem.seek(0)
            flag = sh_mem.read_byte()
            if flag == FLAG_SET:
                return False
            check_next += CHECK_EVERY

        if n % i == 0:
            sh_mem.seek(0)
            sh_mem.write_byte(FLAG_SET)
            return False
    return True</pre></div></div><p>We can also entirely replace the logic that the counter represents in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-verifying-primes-mmap3-1">Example&nbsp;9-21</a> by unrolling our loop into a two stage process. First - the outer loop covers the expected range but in steps on <code class="literal">CHECK_EVERY</code>.</p><p>Second - a new inner loop replaces the <code class="literal">check_every</code> logic - it checks the local range of factors and then finishes, this is equivalent to the <code class="literal">if not check_every:</code> test. We follow this with the previous <code class="literal">sh_mem</code> logic to check the early-exit flag.</p><p>The speed impact is dramatic. Our non-Prime case improves even further but more importantly our Prime-checking case is very nearly as fast as the Naive Pool version (it is now just 0.05 seconds slower). Given that we’re doing a lot of extra work with inter-process communication this is a very interesting result. Do note that it is specific to CPython and unlikely to offer any gains when run through a compiler.</p><div class="example"><a id="code-verifying-primes-mmap3-1"></a><div class="example-title">Example&nbsp;9-21.&nbsp;Optimizing away our expensive logic</div><div class="example-contents"><pre class="screen">def check_prime_in_range((n, (from_i, to_i))):
    if n % 2 == 0:
        return False
    assert from_i % 2 != 0
    for outer_counter in xrange(from_i, int(to_i), CHECK_EVERY):
        upper_bound = min(int(to_i), outer_counter + CHECK_EVERY)
        for i in xrange(outer_counter, upper_bound, 2):
            if n % i == 0:
                sh_mem.seek(0)
                sh_mem.write_byte(FLAG_SET)
                return False
        sh_mem.seek(0)
        flag = sh_mem.read_byte()
        if flag == FLAG_SET:
            return False
    return True</pre></div></div><p>We can go even further (but frankly - this is a bit foolish). Look-ups for variables that aren’t declared in the local scope are a little expensive. We can create local references to the global <code class="literal">FLAG_SET</code> and the frequencly used <code class="literal">.seek()</code> and <code class="literal">.read_byte()</code> methods to avoid their more expensive look-ups. The resulting code is even less readable than before and I really recommend that you <span class="emphasis"><em>do not do this</em></span>.</p><p>This final result is 1.5% slower than the Naive Pool version when checking the larger Primes. Given that we’re 4.8* faster for the non-Prime cases I think we’ve taken this example about as far as it could (and should!) go.</p><div class="example"><a id="code-verifying-primes-mmap4-1"></a><div class="example-title">Example&nbsp;9-22.&nbsp;Breaking the “don’t hurt team velocity” rule to eek out an extra speed-up</div><div class="example-contents"><pre class="screen">def check_prime_in_range((n, (from_i, to_i))):
    if n % 2 == 0:
        return False
    assert from_i % 2 != 0
    FLAG_SET_LOCAL = FLAG_SET
    sh_seek = sh_mem.seek
    sh_read_byte = sh_mem.read_byte
    for outer_counter in xrange(from_i, int(to_i), CHECK_EVERY):
        upper_bound = min(int(to_i), outer_counter + CHECK_EVERY)
        for i in xrange(outer_counter, upper_bound, 2):
            if n % i == 0:
                sh_seek(0)
                sh_mem.write_byte(FLAG_SET)
                return False
        sh_seek(0)
        if sh_read_byte() == FLAG_SET_LOCAL:
            return False
    return True</pre></div></div><p>The behavior above with manual loop unrolling and creating local references to global objects is foolish. Overall it is bound to lower team velocity by making the code harder to understand and really this is the job of a compiler (e.g. a JIT like PyPy or a static compiler like Cython).</p><p>Humans shouldn’t be doing this sort of manipulation because it’ll be very brittle. I haven’t tested this optimization approach in Python 3+ and I don’t want to - I don’t really expect that these incremental improvements will work in another version of Python (and certainly not in a different implementation like PyPy or IronPython).</p><p>I’m showing you so you know that it <span class="emphasis"><em>might</em></span> be possible and I’m warning you that to keep your sanity you really should let compilers take care of this sort of work for you.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_sharing_numpy_data_with_multiprocessing">Sharing numpy data with multiprocessing</h2></div></div></div><p><a id="multiprocessing-sharing-numpy-data-with-multiprocessing"></a>When working with large <code class="literal">numpy</code> arrays you’re bound to wonder if you can share the data for read and write access, without a copy, between processes. It is possible though a little fiddly. I’d like to acknowledge StackOverlfow user <code class="literal">pv</code> for the inspiration for this demo <sup>[<a id="id818496" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id818496" class="footnote">69</a>]</sup>.</p><p>Do not use this method to recreate the behaviors of BLAS, MKL, Accelerate and ATLAS. These libraries all have multithreading support in their primitives and it is likely that they are better debugged than a new routine that you create. These libraries can require some configuration to enable multithreading support, it would be wise to see if these libraries give you free speed-ups before investing time (and losing time to debugging!) as you write your own.</p><p>When you have a large matrix which could be shared between processes you’ll have several benefits:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
only one copy means no wasted RAM
</li><li class="listitem">
no time is wasted copying large blocks of RAM
</li><li class="listitem">
you gain the possibility of sharing partial results between the processes
</li></ul></div><p>Thinking back to the Pi estimation demo using <code class="literal">numpy</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-estimating-pi-using-numpy">Using numpy</a> we had the problem that the random number generation was a serial process. Here we could imagine forking processes that shared one large array, each one using a differently seeded random number generator to fill in a section of the array with random numbers, therefore completing the generation of a large random block faster than possible with a single process.</p><p>To verify this I modified the forthcoming demo to create a random large matrix (10,000 by 80,000 elements) as a serial process and by splitting the matrix into four segments where <code class="literal">random</code> is called in parallel (in both cases one row at a time). The serial process took 15 seconds, the parallel version took 4 seconds. Refer back to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-random-numbers">Random Numbers in Parallel Systems</a> to understand some of the dangers of parallelized random number generation.</p><p>For the rest of this section we’ll use a simplified demo that illustrates the point whilst remaining easy to verify.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#FIG-numpy-shared-multiprocessing-htop">Figure&nbsp;9-19</a> you can see <code class="literal">htop</code> on my laptop, it shows four child processes of the parent (with PID 11268) where all five processes are sharing a single 10,000 by 80,000 element <code class="literal">numpy</code> array of doubles. One copy of this array costs 6.4GB and my laptop has 8GB, you can see in <code class="literal">htop</code> by the process meters that the <code class="literal">Mem</code> reading shows a maximum of 7,941MB RAM.</p><div class="figure"><a id="FIG-numpy-shared-multiprocessing-htop"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/08_80000rows.png" alt="notset" width="1000" height="514" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/08_80000rows.png"></div></div><div class="figure-title">Figure&nbsp;9-19.&nbsp;htop showing RAM and swap usage</div></div><p>To understand this demo we’ll first walk through the console output and then we’ll look at the code. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-sharing-numpy-array-using-multiprocessing-run-setup">Example&nbsp;9-23</a> we start the parent process, it allocates a 6.4GB double array of dimension 10,000 by 80,000 filled with the value zero. The 10,000 rows will be passed out as indices to the worker function and the worker will operate on each column of 80,000 items in turn.</p><p>Having allocated the array we fill it with the answer to life, the universe and everything (<code class="literal">42</code>!). We can test in the worker function that we’re receiving this modified array and not a filled-with-0s version to confirm that this code is behaving as expected.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-run-setup"></a><div class="example-title">Example&nbsp;9-23.&nbsp;Setting up the shared array</div><div class="example-contents"><pre class="screen">$ python np_shared.py
Created shared array with 6,400,000,000 nbytes
Shared array id is 20255664 in PID 11268
Starting with an array of 0 values:
[[ 0.  0.  0. ...,  0.  0.  0.]
 ...,
 [ 0.  0.  0. ...,  0.  0.  0.]]

Original array filled with value 42:
[[ 42.  42.  42. ...,  42.  42.  42.]
 ...,
 [ 42.  42.  42. ...,  42.  42.  42.]]
Press a key to start workers using multiprocessing...</pre></div></div><p>Now in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-sharing-numpy-array-using-multiprocessing-run-worker-fn">Example&nbsp;9-24</a> we’ve started four processes working on this shared array. No copy of the array was made, each process is looking at the same large block of memory and each process has a different set of indices to work from. Every few thousand lines the worker outputs the current index and its PID so we can observe its behavior.</p><p>The worker’s job is trivial - it will check that the current element is still set to the default (so we know that no other process has modified it already) and then it will overwrite this value with the current PID.</p><p>Once the workers have completed we return to the parent process and print the array again - this time we see that it is filled with PIDs rather than <code class="literal">42</code>.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-run-worker-fn"></a><div class="example-title">Example&nbsp;9-24.&nbsp;Running worker_fn on the shared array</div><div class="example-contents"><pre class="screen"> worker_fn: with idx 0
  id of shared_array is 20255664 in PID 11288
 worker_fn: with idx 2000
  id of shared_array is 20255664 in PID 11291
 worker_fn: with idx 1000
  id of shared_array is 20255664 in PID 11289
 ...
 worker_fn: with idx 8000
  id of shared_array is 20255664 in PID 11290

The default value has been over-written with worker_fn's result:
[[ 11288.  11288.  11288. ...,  11288.  11288.  11288.]
 ...,
 [ 11291.  11291.  11291. ...,  11291.  11291.  11291.]]</pre></div></div><p>Finally in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-sharing-numpy-array-using-multiprocessing-run-verify">Example&nbsp;9-25</a> we use a <code class="literal">Counter</code> to confirm the frequency of each PID in the array. As the work was evenly divided we expect to see each of the four PIDs represented an equal number of times. In our 800,000,000 element array we see four sets of 200,000,000 PIDs. The table output is presented using PrettyTable <sup>[<a id="id818716" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id818716" class="footnote">70</a>]</sup>.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-run-verify"></a><div class="example-title">Example&nbsp;9-25.&nbsp;Verifying the result on the shared array</div><div class="example-contents"><pre class="screen">Verification - extracting unique values from 800,000,000 items
in the numpy array (this might be slow)...
Unique values in shared_array:
+---------+-----------+
|   PID   |   Count   |
+---------+-----------+
| 11288.0 | 200000000 |
| 11289.0 | 200000000 |
| 11290.0 | 200000000 |
| 11291.0 | 200000000 |
+---------+-----------+
Press a key to exit...</pre></div></div><p>Having completed the program now exits and the array is deleted.</p><p>We can take a peak inside each process under Linux using <code class="literal">ps</code> and <code class="literal">pmap</code>. <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-sharing-numpy-array-using-multiprocessing-run-pmap">Example&nbsp;9-26</a> shows the result of calling <code class="literal">ps</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">ps</code> tells us about the process
</li><li class="listitem">
<code class="literal">-A</code> lists all processes
</li><li class="listitem">
<code class="literal">-o pid,size,vsize,cmd</code> outputs the PID, size information and the command name
</li><li class="listitem">
<code class="literal">grep</code> is used to filter all other results and leave only the lines for our demo
</li></ul></div><p>The parent process (PID 11268) and its four forked children are shown, the result in similar to what we saw in <code class="literal">htop</code>.</p><p>We can use <code class="literal">pmap</code> to look at the memory map of each process, requesting extended output with <code class="literal">-x</code>. We grep for the pattern <code class="literal">s-</code> to list blocks of memory that are marked as being shared. In the parent process and the child processes we see a 6250000 kB block (6.2GB) that is shared between them.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-run-pmap"></a><div class="example-title">Example&nbsp;9-26.&nbsp;pmap and ps to investigate the Operating System’s view of the processes</div><div class="example-contents"><pre class="screen">$ ps -A -o pid,size,vsize,cmd | grep np_shared
11268 232464 6564988 python np_shared.py
11288 11232 6343756 python np_shared.py
11289 11228 6343752 python np_shared.py
11290 11228 6343752 python np_shared.py
11291 11228 6343752 python np_shared.py

ian@ian-Latitude-E6420 $ pmap -x 11268 | grep s-
Address           Kbytes     RSS   Dirty Mode   Mapping
00007f1953663000 6250000 6250000 6250000 rw-s-  zero (deleted)
...
ian@ian-Latitude-E6420 $ pmap -x 11288 | grep s-
Address           Kbytes     RSS   Dirty Mode   Mapping
00007f1953663000 6250000 1562512 1562512 rw-s-  zero (deleted)
...</pre></div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-sharing-numpy-array-using-multiprocessing-preamble1">Example&nbsp;9-27</a> shows the important steps to share this array. We use a <code class="literal">multprocessing.Array</code> to allocate a shared block of memory as a 1D array. We then instantiate a <code class="literal">numpy</code> array from this object and reshape it back to a 2D array. Now we have a <code class="literal">numpy</code> wrapped block of memory that can be shared between processes and addressed as though it were a normal <code class="literal">numpy</code> array. <code class="literal">numpy</code> is not managing the RAM, <code class="literal">multiprocessing.Array</code> is managing it.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-preamble1"></a><div class="example-title">Example&nbsp;9-27.&nbsp;Sharing the numpy array using multiprocessing</div><div class="example-contents"><pre class="screen">import os
import multiprocessing
from collections import Counter
import ctypes
import numpy as np
from prettytable import PrettyTable

SIZE_A, SIZE_B = 10000, 80000  # 6.2GB - starts to use swap (maximal RAM usage)</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-sharing-numpy-array-using-multiprocessing-worker-fn">Example&nbsp;9-28</a> you’ll see that each forked process has access to a global <code class="literal">main_nparray</code>. Whilst the forked process has a copy of the <code class="literal">numpy</code> object, the underlying bytes that the object accesses are stored as shared memory. Our <code class="literal">worker_fn</code> will overwrite a chosen row (via <code class="literal">idx</code>) with the current process identifier.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-worker-fn"></a><div class="example-title">Example&nbsp;9-28.&nbsp;worker_fn for sharing numpy arrays using multiprocessing</div><div class="example-contents"><pre class="screen">def worker_fn(idx):
    """Do some work on the shared np array on row idx"""
    # confirm that no other process has modified this value already
    assert main_nparray[idx, 0] == DEFAULT_VALUE
    # inside the subprocess print the PID and id of the array
    # to check we don't have a copy
    if idx % 1000 == 0:
        print " {}: with idx {}\n  id of local_nparray_in_process is {} in PID {}"\
            .format(worker_fn.__name__, idx, id(main_nparray), os.getpid())
    # we can do any work on the array, here we set every item in this row to
    # have the value of the process id for this process
    main_nparray[idx, :] = os.getpid()</pre></div></div><p>In our <code class="literal">__main__</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-sharing-numpy-array-using-multiprocessing-main1">Example&nbsp;9-29</a> we’ll work through three major stages:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Build a shared <code class="literal">multiprocessing.Array</code> and convert it into a <code class="literal">numpy</code> array
</li><li class="listitem">
Set a default value into the array, spawn four processes to work on the array in parallel
</li><li class="listitem">
Verify the array’s contents after the processes return
</li></ol></div><p>Typically you’d setup a <code class="literal">numpy</code> array and work on it in a single process, you’d probably do something like <code class="literal">arr = np.array((100, 5), dtype=np.float_)</code>. This is fine in a single process but you can’t share this data across processes for both reading and writing.</p><p>The trick is to make a shared block of bytes, one way is to create a <code class="literal">multiprocessing.Array</code>. By default the <code class="literal">Array</code> is wrapped in a lock to prevent concurrent edits, we don’t need this lock as we’ll be careful about our access patterns. To communicate this clearly to other team members it is worth being explicit and setting <code class="literal">lock=False</code>.</p><p>If you don’t set <code class="literal">lock=False</code> then you’ll have an object rather than a reference to the bytes, you’ll need to call <code class="literal">.get_obj()</code> to get to the bytes. By calling <code class="literal">.get_obj()</code> you bypass the lock, so there’s no value in not being explicit about this in the first place.</p><p>Next we take this block of shareable bytes and wrap a <code class="literal">numpy</code> array around them using <code class="literal">frombuffer</code>. The <code class="literal">dtype</code> is optional but since we’re passing bytes around it is always sensible to be explicit. We <code class="literal">reshape</code> so we can address the bytes as a 2D array. By default the array values are set to <code class="literal">0</code>.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-main1"></a><div class="example-title">Example&nbsp;9-29.&nbsp;main to setup numpy arrays for sharing</div><div class="example-contents"><pre class="screen">if __name__ == '__main__':
    DEFAULT_VALUE = 42
    NBR_OF_PROCESSES = 4

    # create a block of bytes, reshape into a local numpy array
    NBR_ITEMS_IN_ARRAY = SIZE_A * SIZE_B
    shared_array_base = multiprocessing.Array(ctypes.c_double,
                                              NBR_ITEMS_IN_ARRAY, lock=False)
    main_nparray = np.frombuffer(shared_array_base, dtype=ctypes.c_double)
    main_nparray = main_nparray.reshape(SIZE_A, SIZE_B)
    # Assert no copy was made
    assert main_nparray.base.base is shared_array_base
    print "Created shared array with {:,} nbytes".format(main_nparray.nbytes)
    print "Shared array id is {} in PID {}".format(id(main_nparray), os.getpid())
    print "Starting with an array of 0 values:"
    print main_nparray
    print</pre></div></div><p>To confirm that our processes are operating on the same block of data that we started with we’ll set each item to a new <code class="literal">DEFAULT_VALUE</code>, you’ll see that at the top of <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-sharing-numpy-array-using-multiprocessing-main2">Example&nbsp;9-30</a> (we use the answer to life, the universe and everything). Next we build a <code class="literal">Pool</code> of processes (four in this case) and then send batches of row indices via the call to <code class="literal">map</code>.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-main2"></a><div class="example-title">Example&nbsp;9-30.&nbsp;main for sharing numpy arrays using multiprocessing</div><div class="example-contents"><pre class="screen">    # Modify the data via our local numpy array
    main_nparray.fill(DEFAULT_VALUE)
    print "Original array filled with value {}:".format(DEFAULT_VALUE)
    print main_nparray

    raw_input("Press a key to start workers using multiprocessing...")
    print

    # create a pool of processes that will share the memory block
    # of the global numpy array, share the reference to the underlying
    # block of data so we can build a numpy array wrapper in the new processes
    pool = multiprocessing.Pool(processes=NBR_OF_PROCESSES)
    # perform a map where each row index is passed as a parameter to the
    # worker_fn
    pool.map(worker_fn, xrange(SIZE_A))</pre></div></div><p>Once we’ve completed the parallel processing we return to the parent process to verify the result. The verification step runs through a flattened view on the array (note that the view does <span class="emphasis"><em>not</em></span> make a copy, it just creates a 1D iterable view on the 2D array) counting the frequency of each PID. Finally we perform some <code class="literal">assert</code> checks to make sure we have the expected counts.</p><div class="example"><a id="code-sharing-numpy-array-using-multiprocessing-main3"></a><div class="example-title">Example&nbsp;9-31.&nbsp;main to verify the shared result</div><div class="example-contents"><pre class="screen">    print "Verification - extracting unique values from {:,} items\nin the numpy array (this might be slow)...".format(NBR_ITEMS_IN_ARRAY)
    # main_nparray.flat iterates over the contents of the array, it doesn't
    # make a copy
    counter = Counter(main_nparray.flat)
    print "Unique values in main_nparray:"
    tbl = PrettyTable(["PID", "Count"])
    for pid, count in counter.items():
        tbl.add_row([pid, count])
    print tbl

    total_items_set_in_array = sum(counter.values())

    # check that we have set every item in the array away from DEFAULT_VALUE
    assert DEFAULT_VALUE not in counter.keys()
    # check that we have accounted for every item in the array
    assert total_items_set_in_array == NBR_ITEMS_IN_ARRAY
    # check that we have NBR_OF_PROCESSES of unique keys to confirm that every
    # process did some of the work
    assert len(counter) == NBR_OF_PROCESSES

    raw_input("Press a key to exit...")</pre></div></div><p>We’ve just created a 1D array of bytes, converted it into a 2D array, shared the array amongst four processes and allowed them to process concurrently on the same block of memory. This recipe will help you parallize over many cores. Be careful with concurrent access to the <span class="emphasis"><em>same</em></span> data points - you’ll have to use the locks in <code class="literal">multiprocessing</code> if you want to avoid synchronizatoin problems and this will slow down your code.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_synchronizing_file_and_variable_access">Synchronizing File and Variable Access</h2></div></div></div><p>In the following examples we’ll look at multiple processes sharing and manipulating a state - in this case four processes incrementing a shared counter a set number of times. Without a synchronization process the counting is incorrect. If you’re sharing data in a coherent way you’ll always need a method to synchronize the reading and writing of data otherwise you’ll end up with errors.</p><p>Typically the synchronization methods are specific to the OS you’re using and often specific to the language you use. Here we look at file based synchronization using a Python library and sharing an integer object between Python processes.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_file_locking">File locking</h3></div></div></div><p>Reading and writing to a file will be the slowest example of data sharing in this section.</p><p>You can see our first <code class="literal">work</code> function in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-filelocking-nolock-1-work">Example&nbsp;9-32</a>. It will iterate over a local counter, in each iteration it opens a file and reads the existing value, increments it by one and then writes the new value over the old one. On the first iteration the file will be empty or won’t exist so it will catch an exception and assume the value should be zero.</p><div class="example"><a id="code-08-syncronization-filelocking-nolock-1-work"></a><div class="example-title">Example&nbsp;9-32.&nbsp;work function without a lock</div><div class="example-contents"><pre class="screen">def work(filename, max_count):
    for n in range(max_count):
        f = open(filename, "r")
        try:
            nbr = int(f.read())
        except ValueError as err:
            print "File is empty, starting to count from 0, error: " + str(err)
            nbr = 0
        f = open(filename, "w")
        f.write(str(nbr + 1) + '\n')
        f.close()</pre></div></div><p>Let’s run this example with one process, you can see the output in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-filelocking-nolock-1-console1">Example&nbsp;9-33</a>. <code class="literal">work</code> is called 1000 times, as expected it correctly counts without losing any data.</p><p>On the first read it sees and empty file, this raises the <code class="literal">invalid literal for int()</code> error for <code class="literal">int()</code> (as <code class="literal">int()</code> is called on an empty string). This error only occurs once, afterwards we always have a valid value to read and convert into an integer.</p><div class="example"><a id="code-08-syncronization-filelocking-nolock-1-console1"></a><div class="example-title">Example&nbsp;9-33.&nbsp;Timing of file based counting without a lock and 1 process</div><div class="example-contents"><pre class="screen">$ python ex1_nolock.py
Starting 1 process(es) to count to 1000
File is empty, starting to count from 0,
error: invalid literal for int() with base 10: ''
Expecting to see a count of 1000
count.txt contains:
1000</pre></div></div><p>Now we’ll run the same <code class="literal">work</code> function with four concurrent processes.  We don’t have any locking code so we’ll expect some odd results.</p><div class="tip"><h3 class="title">Tip</h3><p>BEFORE you look at the following code - what <span class="emphasis"><em>two</em></span> types of error can you expect to see when two processes read or write simultaneously to the same file? Think about the two main states of the code - the start of execution for each process and the normal running state of each process.</p></div><p>Take a look at <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-filelocking-nolock-1-console2">Example&nbsp;9-34</a> to see the problems. First - when each process starts the file is empty, so they each try to start counting from zero. Second - as one process writes the other can read a partially written result which can’t be parsed, this causes an exception and a zero will be written back. This causes our counter to keep getting reset!</p><p>Can you see how <code class="literal">\n</code> and two values have been written by two concurrent processes to the same open file, causing an invalid entry to be read by a third process?</p><div class="example"><a id="code-08-syncronization-filelocking-nolock-1-console2"></a><div class="example-title">Example&nbsp;9-34.&nbsp;Timing of file based counting without a lock and 4 processes</div><div class="example-contents"><pre class="screen">Starting 4 process(es) to count to 4000
File is empty, starting to count from 0,
error: invalid literal for int() with base 10: ''
File is empty, starting to count from 0,
error: invalid literal for int() with base 10: '1\n7\n'
# many errors like these
Expecting to see a count of 4000
count.txt contains:
629
$ python -m timeit -s "import ex1_nolock" "ex1_nolock.run_workers()"
10 loops, best of 3: 125 msec per loop</pre></div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-filelocking-nolock-1-main">Example&nbsp;9-35</a> shows the <code class="literal">multiprocessing</code> code that calls <code class="literal">work</code> with four processes. Note that rather than using a <code class="literal">map</code> instead we’re building a list of <code class="literal">Process</code> objects. Although we don’t use the functionality here the <code class="literal">Process</code> object gives us the power to introspect the state of each <code class="literal">Process</code>. I encourage you to read the documentation to learn about why you might want to use a <code class="literal">Process</code> <sup>[<a id="id819369" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id819369" class="footnote">71</a>]</sup>.</p><div class="example"><a id="code-08-syncronization-filelocking-nolock-1-main"></a><div class="example-title">Example&nbsp;9-35.&nbsp;run_workers setting up 4 processes</div><div class="example-contents"><pre class="screen">import multiprocessing
import os

...
MAX_COUNT_PER_PROCESS = 1000
FILENAME = "count.txt"
...

def run_workers():
    NBR_PROCESSES = 4
    total_expected_count = NBR_PROCESSES * MAX_COUNT_PER_PROCESS
    print "Starting {} process(es) to count to {}".format(NBR_PROCESSES, total_expected_count)
    # reset counter
    f = open(FILENAME, "w")
    f.close()

    processes = []
    for process_nbr in range(NBR_PROCESSES):
        p = multiprocessing.Process(target=work, args=(FILENAME, MAX_COUNT_PER_PROCESS))
        p.start()
        processes.append(p)

    for p in processes:
        p.join()

    print "Expecting to see a count of {}".format(total_expected_count)
    print "{} contains:".format(FILENAME)
    os.system('more ' + FILENAME)


if __name__ == "__main__":
    run_workers()</pre></div></div><p>Using the <code class="literal">lockfile</code> <sup>[<a id="id819448" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id819448" class="footnote">72</a>]</sup> module we can introduce a syncoronization method so only 1 process get to write at a time and the others each await their turn. The overal process therefore runs more slowly but it doesn’t make mistakes. You can see the correct output in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-filelocking-lock-1-console">Example&nbsp;9-36</a>. You’ll find full documentation online <sup>[<a id="id819468" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id819468" class="footnote">73</a>]</sup>. Be aware that the locking mechanism is specific to Python so other processes that are looking at this file will <span class="emphasis"><em>not</em></span> care about the “locked” nature of this file.</p><div class="example"><a id="code-08-syncronization-filelocking-lock-1-console"></a><div class="example-title">Example&nbsp;9-36.&nbsp;Timing of file based counting with a lock and 4 processes</div><div class="example-contents"><pre class="screen">$ python ex1_lock.py
Starting 4 process(es) to count to 4000
File is empty, starting to count from 0,
error: invalid literal for int() with base 10: ''
Expecting to see a count of 4000
count.txt contains:
4000

$ python -m timeit -s "import ex1_lock" "ex1_lock.run_workers()"
10 loops, best of 3: 401 msec per loop</pre></div></div><p>Using <code class="literal">lockfile</code> adds just a couple of lines of code. First we create a <code class="literal">FileLock</code> object, the filename can be anything but using the same name as the file you want to lock probably makes debugging from the command line easier. When you ask to <code class="literal">acquire</code> the lock the <code class="literal">FileLock</code> opens a new file with named as filename with <code class="literal">.lock</code> appended.</p><p><code class="literal">acquire</code> without any arguments will block forever, until the lock is available. Once you have the lock you can do your processing without any danger of a conflict and then <code class="literal">release</code> the lock once you’ve finished writing.</p><div class="example"><a id="code-08-syncronization-filelocking-lock-1"></a><div class="example-title">Example&nbsp;9-37.&nbsp;work function with a lock</div><div class="example-contents"><pre class="screen">def work(filename, max_count):
    lock = lockfile.FileLock(filename)
    for n in range(max_count):
        lock.acquire()
        f = open(filename, "r")
        try:
            nbr = int(f.read())
        except ValueError as err:
            print "File is empty, starting to count from 0, error: " + str(err)
            nbr = 0
        f = open(filename, "w")
        f.write(str(nbr + 1) + '\n')
        f.close()
        lock.release()</pre></div></div><p>You could use a context manager, you replace <code class="literal">acquire</code> and <code class="literal">release</code> with <code class="literal">with lock:</code>. This adds a small overhead to the runtime but it also makes the code a little easier to read. Clarity usually beats execution speed.</p><p>You can also ask to <code class="literal">acquire</code> the lock with a timeout, check for an existing lock and break an existing lock. Several locking mechanisms are provided, sensible default choices for each platform are hidden behind the <code class="literal">FileLock</code> interface.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_locking_a_value">Locking a Value</h3></div></div></div><p>The <code class="literal">multiprocessing</code> module offers several options to share Python objects between processes. We can share primitive objects with a low communication overhead, we can also share higher level Python objects (e.g. dictionaries and lists) using a <code class="literal">Manager</code> (but note that the syncronization cost will significantly slow down the data sharing).</p><p>Here we’ll use a <code class="literal">multiprocessing.Value</code> <sup>[<a id="id819608" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id819608" class="footnote">74</a>]</sup> object to share an integer between processes. Whilst a <code class="literal">Value</code> has a lock, the lock doesn’t do quite what you might expect - it prevent simultaneous reads or writes but does <span class="emphasis"><em>not</em></span> provide an atomic increment. Let’s illustrate this in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-valuelocking-nolock-1-console">Example&nbsp;9-38</a>, you can see that we end up with an incorrect count, this is similar to the file-based unsynchronized example before.</p><div class="example"><a id="code-08-syncronization-valuelocking-nolock-1-console"></a><div class="example-title">Example&nbsp;9-38.&nbsp;No locking leads to an incorrect count</div><div class="example-contents"><pre class="screen">$ python ex2_nolock.py
Expecting to see a count of 4000
We have counted to 2340
$ python -m timeit -s "import ex2_nolock" "ex2_nolock.run_workers()"
100 loops, best of 3: 12.6 msec per loop</pre></div></div><p>No corruption occurs to the data but we do miss some of the updates. This approach might be suitable if you’re writing to a <code class="literal">Value</code> from one process and consuming (but not modifying) that <code class="literal">Value</code> in other processes. The code to share the <code class="literal">Value</code> is shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-valuelocking-nolock-1">Example&nbsp;9-39</a>.</p><p>We have to specify a datatype and an initialization value, using <code class="literal">Value("i", 0)</code> we request a signed-integer with a default value of 0. This is passed as a regular argument to our <code class="literal">Process</code> object and behind the scenes it takes care of sharing the same block of bytes between processes.</p><p>To access the primitive object held by our <code class="literal">Value</code> we use <code class="literal">.value</code>. Note that I’m asking for an in-place addition, we’d expect this to be an atomic operation but that’s not supported by <code class="literal">Value</code> so our final count is lower than expected.</p><div class="example"><a id="code-08-syncronization-valuelocking-nolock-1"></a><div class="example-title">Example&nbsp;9-39.&nbsp;The counting code without a Lock</div><div class="example-contents"><pre class="screen">import multiprocessing

def work(value, max_count):
    for n in range(max_count):
        value.value += 1

def run_workers():
...
    value = multiprocessing.Value('i', 0)
    for process_nbr in range(NBR_PROCESSES):
        p = multiprocessing.Process(target=work, args=(value, MAX_COUNT_PER_PROCESS))
        p.start()
        processes.append(p)
...</pre></div></div><p>We can add a <code class="literal">Lock</code> <sup>[<a id="id819722" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id819722" class="footnote">75</a>]</sup>, it works very similarly to the <code class="literal">FileLock</code> example before. You can see the correctly synchronized count in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-valuelocking-lock-1-console">Example&nbsp;9-40</a>.</p><div class="example"><a id="code-08-syncronization-valuelocking-lock-1-console"></a><div class="example-title">Example&nbsp;9-40.&nbsp;Using a Lock to synchronize writes to a Value</div><div class="example-contents"><pre class="screen"># lock on the update but this isn't atomic
$ python ex2_lock.py
Expecting to see a count of 4000
We have counted to 4000
python -m timeit -s "import ex2_lock" "ex2_lock.run_workers()"
10 loops, best of 3: 22.2 msec per loop</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-valuelocking-lock-1">Example&nbsp;9-41</a> I’ve used a context manager (<code class="literal">with Lock</code>) to acquire the lock, as for the <code class="literal">FileLock</code> example before it waits indefinitely to acquire the lock.</p><div class="example"><a id="code-08-syncronization-valuelocking-lock-1"></a><div class="example-title">Example&nbsp;9-41.&nbsp;Acquiring a Lock using a context manager</div><div class="example-contents"><pre class="screen">import multiprocessing


def work(value, max_count, lock):
    for n in range(max_count):
        with lock:
            value.value += 1


def run_workers():
...
    processes = []
    lock = multiprocessing.Lock()
    value = multiprocessing.Value('i', 0)
    for process_nbr in range(NBR_PROCESSES):
        p = multiprocessing.Process(target=work, args=(value, MAX_COUNT_PER_PROCESS, lock))
        p.start()
        processes.append(p)
...</pre></div></div><p>As noted in the <code class="literal">FileLock</code> example it is a little quicker to avoid using the context manager, the snippet in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-valuelocking-lock-1-inline-lock">Example&nbsp;9-42</a> shows how to <code class="literal">acquire</code> and <code class="literal">release</code> the <code class="literal">Lock</code> object.</p><div class="example"><a id="code-08-syncronization-valuelocking-lock-1-inline-lock"></a><div class="example-title">Example&nbsp;9-42.&nbsp;In-line Locking rather than using a Conext Manager</div><div class="example-contents"><pre class="screen">lock.acquire()
value.value += 1
lock.release()</pre></div></div><p>Since a <code class="literal">Lock</code> doesn’t give us the level of granularity that we’re after, the basic locking that it provides waste a bit of time unnecessarily. We can replace the <code class="literal">Value</code> with a <code class="literal">RawValue</code> <sup>[<a id="id819844" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id819844" class="footnote">76</a>]</sup> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-valuelocking-lock-rawvalue-1-console">Example&nbsp;9-43</a> and we achieve an incremental speed-up. If you’re interested in seeing the bytecode behind this change then read Eli Bendersky’s blogpost <sup>[<a id="id819850" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#ftn.id819850" class="footnote">77</a>]</sup> on the subject.</p><div class="example"><a id="code-08-syncronization-valuelocking-lock-rawvalue-1-console"></a><div class="example-title">Example&nbsp;9-43.&nbsp;Console output showing the faster RawValue and Lock approach</div><div class="example-contents"><pre class="screen"># RawValue hsa no lock on it
$ python ex2_lock_rawvalue.py
Expecting to see a count of 4000
We have counted to 4000
$ python -m timeit -s "import ex2_lock_rawvalue" "ex2_lock_rawvalue.run_workers()"
100 loops, best of 3: 12.6 msec per loop</pre></div></div><p>To use a <code class="literal">RawValue</code> just swap it for a <code class="literal">Value</code> as shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#code-08-syncronization-valuelocking-lock-rawvalue-1">Example&nbsp;9-44</a>.</p><div class="example"><a id="code-08-syncronization-valuelocking-lock-rawvalue-1"></a><div class="example-title">Example&nbsp;9-44.&nbsp;Example of using a RawValue integer</div><div class="example-contents"><pre class="screen">...
def run_workers():
...
    lock = multiprocessing.Lock()
    value = multiprocessing.RawValue('i', 0)
    for process_nbr in range(NBR_PROCESSES):
        p = multiprocessing.Process(target=work, args=(value, MAX_COUNT_PER_PROCESS, lock))
        p.start()
        processes.append(p)</pre></div></div><p>We could also use a <code class="literal">RawArray</code> in place of <code class="literal">multiprocessing.Array</code> if we were sharing an array of primitive objects.</p><p>Now we’ve looked at various ways of diving up work on a single machine between multiple processes along with sharing a flag and synchronizing data sharing between these processes.</p><p>Remember that sharing data can lead to headaches - try to avoid it if possible. Making a machine deal with all the edge cases of state sharing is hard, the first time you have to debug the interactions of multiple processes you’ll realise why the wisdom is to avoid this situation if possible.</p><p>Do consider writing code that runs slower but is more likely to be understood by your team. Using an external tool like Redis to share state leads to a system that can be inspected at run-time by people <span class="emphasis"><em>other</em></span> than the developers - this is a powerful way to enable your team to keep on top of what’s happening in your parallel systems.</p><p>Definitely bare in mind that tweaked performant Python code is less likely to be understood by more junior members of your team - they’ll either be scared of it or they’ll break it. Avoid this problem (and accept a sacrifice in speed) to keep team velocity high.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_summary">Summary</h2></div></div></div><p>We’ve covered a lot in this chapter. First we looked at two embarrassingly parallel problems where one has predictable complexity and the other has non-predictable complexity. We’ll use these examples again shortly on multiple machines when we discuss <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html">Chapter&nbsp;10</a>.</p><p>Next we looked at Queue support in <code class="literal">multiprocessing</code> and its overheads, in general I recommend using an external queue library so that the state of the queue is more transparent. Preferably you should use an easy to read job format so that it is easy to debug, rather than pickled data.</p><p>The Inter-Process Communication discussion should have impressed upon you how difficult it is to use IPC efficiently and how it can make sense just to use a naive parallel solution (without IPC). Buying a faster computer with more cores might be a far more pragmatic solution than trying to use IPC to exploit an existing machine.</p><p>Sharing <code class="literal">numpy</code> matrices in parallel without making copies is important for a small set of problems (but when it counts, it’ll really count). It takes a few extra lines of code and requires some sanity checking to make sure that you’re really not copying the data between processes.</p><p>Finally we looked at using file and memory locks to avoid corrupting data - this is a source of subtle and hard to track errors, this section shows you robust and lightweight solutions.</p><p>In the next chapter we’ll look at Clustering using Python. With a Cluster we can move beyond single-machine parallelism and utilize the CPUs on a group of machines. This introduces a new world of debugging pain - not only can your code have errors but the other machines can have errors (either from bad configuration or failing hardware). We’ll show how to parallelize the Pi estimation demo using the <code class="literal">parallelpython</code> module and how to run research code inside IPython using <code class="literal">IPython cluster</code>.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id814204"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id814204" class="simpara">49</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Amdahl%27s_law" target="_top">http://en.wikipedia.org/wiki/Amdahl%27s_law</a></p></div><div class="footnote" id="ftn.id814377"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id814377" class="simpara">50</a>] </sup><a class="ulink" href="http://docs.python.org/2/library/multiprocessing.html#windows" target="_top">http://docs.python.org/2/library/multiprocessing.html#windows</a></p></div><div class="footnote" id="ftn.id814457"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id814457" class="simpara">51</a>] </sup><a class="ulink" href="http://legacy.python.org/dev/peps/pep-0371/" target="_top">http://legacy.python.org/dev/peps/pep-0371/</a></p></div><div class="footnote" id="ftn.id814567"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id814567" class="simpara">52</a>] </sup><a class="ulink" href="http://legacy.python.org/dev/peps/pep-3148/" target="_top">http://legacy.python.org/dev/peps/pep-3148/</a></p></div><div class="footnote" id="ftn.id814600"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id814600" class="simpara">53</a>] </sup><a class="ulink" href="https://pypi.python.org/pypi/futures" target="_top">https://pypi.python.org/pypi/futures</a></p></div><div class="footnote" id="ftn.id814731"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id814731" class="simpara">54</a>] </sup><a class="ulink" href="http://docs.python.org/2/library/multiprocessing.html#windows" target="_top">http://docs.python.org/2/library/multiprocessing.html#windows</a></p></div><div class="footnote" id="ftn.id814788"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id814788" class="simpara">55</a>] </sup><a class="ulink" href="http://math.missouristate.edu/assets/Math/brett.pptx" target="_top">http://math.missouristate.edu/assets/Math/brett.pptx</a></p></div><div class="footnote" id="ftn.id814834"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id814834" class="simpara">56</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Pythagorean_theorem" target="_top">http://en.wikipedia.org/wiki/Pythagorean_theorem</a></p></div><div class="footnote" id="ftn.id815432"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id815432" class="simpara">57</a>] </sup><a class="ulink" href="http://dabeaz.blogspot.co.uk/2010/01/python-gil-visualized.html" target="_top">http://dabeaz.blogspot.co.uk/2010/01/python-gil-visualized.html</a></p></div><div class="footnote" id="ftn.id815442"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id815442" class="simpara">58</a>] </sup><a class="ulink" href="http://www.dabeaz.com/GIL/" target="_top">http://www.dabeaz.com/GIL/</a></p></div><div class="footnote" id="ftn.id815426"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id815426" class="simpara">59</a>] </sup><a class="ulink" href="http://www.dabeaz.com/GIL/gilvis/index.html" target="_top">http://www.dabeaz.com/GIL/gilvis/index.html</a></p></div><div class="footnote" id="ftn.id815423"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id815423" class="simpara">60</a>] </sup><a class="ulink" href="http://www.dabeaz.com/GIL/gilvis/fourthread.html" target="_top">http://www.dabeaz.com/GIL/gilvis/fourthread.html</a></p></div><div class="footnote" id="ftn.id815781"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id815781" class="simpara">61</a>] </sup><a class="ulink" href="http://wiki.scipy.org/ParallelProgramming" target="_top">http://wiki.scipy.org/ParallelProgramming</a></p></div><div class="footnote" id="ftn.id815963"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id815963" class="simpara">62</a>] </sup><a class="ulink" href="https://github.com/numpy/numpy/blob/master/numpy/random/mtrand/" target="_top">https://github.com/numpy/numpy/blob/master/numpy/random/mtrand/</a></p></div><div class="footnote" id="ftn.id816013"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id816013" class="simpara">63</a>] </sup><a class="ulink" href="http://stackoverflow.com/questions/7596612/benchmarking-python-vs-c-using-blas-and-numpy" target="_top">http://stackoverflow.com/questions/7596612/benchmarking-python-vs-c-using-blas-and-numpy</a></p></div><div class="footnote" id="ftn.id816594"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id816594" class="simpara">64</a>] </sup><a class="ulink" href="https://pythonhosted.org/joblib/" target="_top">https://pythonhosted.org/joblib/</a></p></div><div class="footnote" id="ftn.id816691"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id816691" class="simpara">65</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Sentinel_value" target="_top">http://en.wikipedia.org/wiki/Sentinel_value</a></p></div><div class="footnote" id="ftn.id817027"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id817027" class="simpara">66</a>] </sup><a class="ulink" href="https://github.com/binarydud/pyres" target="_top">https://github.com/binarydud/pyres</a></p></div><div class="footnote" id="ftn.id817243"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id817243" class="simpara">67</a>] </sup><a class="ulink" href="https://pypi.python.org/pypi/mpi4py" target="_top">https://pypi.python.org/pypi/mpi4py</a></p></div><div class="footnote" id="ftn.id818012"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id818012" class="simpara">68</a>] </sup><a class="ulink" href="http://docs.python.org/2/library/multiprocessing.html#multiprocessing.Value" target="_top">http://docs.python.org/2/library/multiprocessing.html#multiprocessing.Value</a></p></div><div class="footnote" id="ftn.id818496"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id818496" class="simpara">69</a>] </sup><a class="ulink" href="http://stackoverflow.com/questions/5549190/is-shared-readonly-data-copied-to-different-processes-for-python-multiprocessing/5550156#5550156" target="_top">http://stackoverflow.com/questions/5549190/is-shared-readonly-data-copied-to-different-processes-for-python-multiprocessing/5550156#5550156</a></p></div><div class="footnote" id="ftn.id818716"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id818716" class="simpara">70</a>] </sup><a class="ulink" href="https://pypi.python.org/pypi/PrettyTable" target="_top">https://pypi.python.org/pypi/PrettyTable</a></p></div><div class="footnote" id="ftn.id819369"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id819369" class="simpara">71</a>] </sup><a class="ulink" href="http://docs.python.org/2/library/multiprocessing.html#process-and-exceptions" target="_top">http://docs.python.org/2/library/multiprocessing.html#process-and-exceptions</a></p></div><div class="footnote" id="ftn.id819448"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id819448" class="simpara">72</a>] </sup><a class="ulink" href="https://pypi.python.org/pypi/lockfile" target="_top">https://pypi.python.org/pypi/lockfile</a></p></div><div class="footnote" id="ftn.id819468"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id819468" class="simpara">73</a>] </sup><a class="ulink" href="http://pythonhosted.org//lockfile/" target="_top">http://pythonhosted.org//lockfile/</a></p></div><div class="footnote" id="ftn.id819608"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id819608" class="simpara">74</a>] </sup><a class="ulink" href="http://docs.python.org/2/library/multiprocessing.html#multiprocessing.Value" target="_top">http://docs.python.org/2/library/multiprocessing.html#multiprocessing.Value</a></p></div><div class="footnote" id="ftn.id819722"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id819722" class="simpara">75</a>] </sup><a class="ulink" href="http://docs.python.org/2/library/multiprocessing.html#multiprocessing.Lock" target="_top">http://docs.python.org/2/library/multiprocessing.html#multiprocessing.Lock</a></p></div><div class="footnote" id="ftn.id819844"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id819844" class="simpara">76</a>] </sup><a class="ulink" href="http://docs.python.org/2/library/multiprocessing.html#multiprocessing.sharedctypes.RawValue" target="_top">http://docs.python.org/2/library/multiprocessing.html#multiprocessing.sharedctypes.RawValue</a></p></div><div class="footnote" id="ftn.id819850"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#id819850" class="simpara">77</a>] </sup><a class="ulink" href="http://eli.thegreenplace.net/2012/01/04/shared-counter-with-pythons-multiprocessing/" target="_top">http://eli.thegreenplace.net/2012/01/04/shared-counter-with-pythons-multiprocessing/</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch08.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">8. Concurrency</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch10.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">10. Clusters and Job Queues</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch09.html" data-for-analytics="9781449361747:ch09.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch10.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch10.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch10.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch10.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>10. Clusters and Job Queues - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch10.html"><meta name="description" content="Chapter&nbsp;10.&nbsp;Clusters and Job Queues Questions you’ll be able to answer after this chapter Why are clusters useful? What are the costs of clustering? How can we convert ... "><meta property="og:title" content="10. Clusters and Job Queues"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="10. Clusters and Job Queues"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch10.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;10.&nbsp;Clusters and Job Queues Questions you’ll be able to answer after this chapter Why are clusters useful? What are the costs of clustering? How can we convert ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch10.html" data-for-analytics="9781449361747:ch10.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch10.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch10.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch10.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%2010.%20Clusters%20and%20Job%20Queues&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch10.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch09.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">9. The multiprocessing module</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch11.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">11. Using Less RAM</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="clustering"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;10.&nbsp;Clusters and Job Queues</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Why are clusters useful?
</li><li class="listitem">
What are the costs of clustering?
</li><li class="listitem">
How can we convert a multiprocessing solution into a clustered solution?
</li><li class="listitem">
How does IPython Cluster work?
</li><li class="listitem">
How does NSQ help with making robust production systems?
</li></ul></div></div><p>A cluster is commonly recognized to be a collection of computers working
together to solve a common task, it could be viewed from the outside as a larger
single system.</p><p>In the 1990s the term Beowulf Cluster
<sup>[<a id="id820094" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820094" class="footnote">78</a>]</sup> popularized the notion
of using a cluster of commodity PCs on a local area network for clustered
processing. Google
<sup>[<a id="id820108" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820108" class="footnote">79</a>]</sup> later popularized the
idea of clusters of commodity PCs in their data centers, particularly for
running map/reduce tasks. At the other end of the scale the TOP500
<sup>[<a id="id820104" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820104" class="footnote">80</a>]</sup> project ranks the most powerful
computer systems each year, typically these have a clustered design and the
fastest machines all use Linux.</p><p>Amazon Webservices (AWS) is commonly used for both engineering a production cluster in the cloud and for building on-demand clusters for short-lived tasks like machine learning. With AWS you could buy sets of 8 Intel Xeon cores with 60GB of RAM for $1.68USD each per hour, alongside 244GB RAM machines and machines with GPUs. Look at <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#clustering-ipython">Using IPython Parallel to support research</a> and the StarCluster package if you’d like to explore AWS for ad-hoc clusters for compute-heavy tasks.</p><p>Different computing tasks require different configurations, sizes and
capabilities in a cluster, I’ll define some common scenarios in this chapter.</p><p><span class="emphasis"><em>Before</em></span> you move to a clustered solution do make sure that you have:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Profiled your system so you understand the bottlenecks
</li><li class="listitem">
Exploited compiler solutions like <code class="literal">Cython</code>
</li><li class="listitem">
Exploited multiple cores on a single machine (possibly a big machine with many cores)
</li><li class="listitem">
Exploited techniques for using less RAM
</li></ul></div><p>Keeping your system to one machine (even if the “one machine” is a really beefy computer with lots of RAM and many CPUs) will make your life easier. Move to a cluster if you really need a <span class="emphasis"><em>lot</em></span> of CPUs or the ability to process data from disks in parallel or you have production needs like resiliency and speed of response.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_benefits_of_clustering">Benefits of clustering</h2></div></div></div><p>The most obvious benefit of a cluster is that you can easily
scale computing requirements - if you need to process more data or to get an
answer quicker you just add more machines (or “nodes”).</p><p>By adding machines you can also improve reliability - each machine’s components have a certain likelihood of
failing and with a good design the failure of a number of components will
not stop the operation of the cluster.</p><p>Clusters are also used to create systems that scale dynamically - a common use
case is to cluster a set of servers that process web requests (or associated
data - e.g. resizing user photos, transcoding video or transcribing speech) and
to activate more servers as demand increases at certain times of the day.</p><p>Dynamic scaling is a very cost-effective way of dealing with non-uniform usage
patterns, as long as the machine activation time is fast enough to deal with the
speed of changing demand.</p><p>A subtler benefit of clustering is that clusters can be separated geographically
but still centrally controlled. If one geographic area suffers an outage (e.g.
flood or power loss) then the other cluster can continue to work, perhaps with
more processing units being added to handle the demand. Clusters also allow you
to run heterogeneous software environments (e.g. different versions of operating
systems and processing software) which <span class="emphasis"><em>might</em></span> improve robustness of the overall
system - note that this is definitely an expert-level topic!</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_clusters_can_introduce_more_pain_than_you_might_expect">Clusters can introduce more pain than you might expect</h2></div></div></div><p>Moving to a clustered solution requires a change in thinking, this is an
evolution of the change in thinking required when you move from serial to
parallel code that we introduced back in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html">Chapter&nbsp;9</a>. Suddenly you
have to consider what happens when you have more than one machine - you have
latency between machines, you need to know if your other machines are working and you need to
keep all the machines running the same version of your software. System administration is probably your biggest challenge.</p><p>In addition,
you normally have to think hard about the algorithms you are implementing and
what happens once you have all these additional moving parts which may need to
stay in sync.  This additional planning can impose a heavy mental tax, it is
likely to distract you from your core task and once a system grows large enough
you’ll probably require a dedicated engineer to join your team.</p><div class="note"><h3 class="title">Note</h3><p>The reason why we’ve tried to focus on using 1 machine efficiently in this book
is because both Micha and I believe that life is easier if you’re only dealing
with 1 computer rather than a collection (though we confess it can be <span class="emphasis"><em>way</em></span> more
fun to play with a cluster - until it breaks). If you can scale vertically (by
buying more RAM or more CPUs) then it is worth investigating this approach in
favor of clustering. Your processing needs may of course exceed what’s possible
with vertical scaling. The robustness of a cluster may be more important than
having a single machine. If you’re a single person on this task then do realise
that running a cluster will suck some of your time.</p></div><p>When designing a clustered solution you’ll need to remember that each machine’s
configuration might be different (each machine will have a different load and
different local data) - how will you get all the right data onto the machine
that’s processing your job? Does the latency involved in moving the job and data
amount to a problem? Do your jobs need to communicate partial results to each
other? What happens if a process fails or the machine dies or a hardware wipes
itself when several jobs are running? Failures can be introduced if you don’t
consider these questions.</p><p>You should also consider that failures <span class="emphasis"><em>can be acceptable</em></span> - you probably don’t
need 99.999% reliability when you’re running a content-based web service, if on
occasion a job fails (e.g. a picture doesn’t get resized quickly enough) and the
user is required to reload a page then that’s something that everyone is already
used to. It might not be the solution you want to give to the user but accepting
a little bit of failure typically reduces your engineering and management costs
by a worthwhile margin. On the flip side if a high frequency trading system
experiences failures then the cost of bad stock market trades could be
considerable!</p><p>Maintaining a fixed infrastructure can become expensive. Machines are relatively
cheap to purchase but they have an awful habbit of going wrong - automatic
software upgrades can go wrong, network cards fail, disks have write errors,
power supplies can give spikey power which disrupts data, cosmic rays can flip a
bit in a RAM module. The more computers you have the more time will be lost to
dealing with these issues. Sooner or later you’ll want to add a system engineer
who can deal with these problems, so add another $100,000 to the budget. Using a
cloud-based cluster can mitigate a lot of these problems (it costs more but you
don’t have to deal with the hardware maintenance), some cloud providers also
offer a spot-priced market
<sup>[<a id="id820363" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820363" class="footnote">81</a>]</sup> for
cheap but temporary computing resources.</p><p>An insidious problem with a cluster that grows organically over time is that
perhaps nobody ever documented how to restart it safely if everything gets
turned off. If you don’t have a documented restart plan then you should assume
you’ll have to write one at the worst possible time (I’ve been involved in
debugging this sort of problem on Christmas Eve - this is not the Christmas
present you want!). At this point you’ll also learn just how long it can take
each part of a system to run up to speed - it might take minutes for each part
of a cluster to boot and to start to process jobs, if you have 10 parts that
operate in succession then it might take an hour to get the whole system running
from cold. The consequence is that you might have an hour’s worth of backlogged
data - do you then have the necessary capacity to deal with this backlog in a
timely fashion?</p><p>Slack behavior can be a cause of expensive mistakes, complex and hard to
anticipate behavior can also cause expensive unexpected outcomes. Let’s look at
two high-profile cluster failures and see what lessons we can learn.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_462_million_wall_street_loss_through_poor_cluster_upgrade_strategy">$462 Million Wall Street loss through poor cluster upgrade strategy</h3></div></div></div><p>In 2012 the high frequency trading firm Knigh Capital lost $462 million after a
bug was introduced during a software upgrade in their cluster
<sup>[<a id="id820485" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820485" class="footnote">82</a>]</sup>.
The software made more orders for shares than customers had requested.</p><p>In the trading software and older flag was repurposed for a new function. The
upgrade was rolled out to 7 of the 8 live machines, the eighth machine used
older code to handle the flag which resulted in the wrong trades being made. The
SEC noted that Knight Capital didn’t have a second technician review the upgrade
and no process to review the upgrade existed.</p><p>The underlying mistake seems to have two causes. The first was that the software
development process hadn’t remove an obsolete feature so the stale code stayed
around. The second was that no manual review process was in place to confirm
that the upgrade was completed successfully.</p><p>Technical debt adds a cost that eventually has to be paid - preferably by taking
time when not under pressure to remove the debt. Always use unit-tests both when
building and when refactoring code. The lack of a written checklist during
system upgrades along with a second pair of eyes could cost you an expensive
failure. There’s a reason that airplane pilots have to work through a take-off
checklist - it means that nobody ever skips the important steps, no matter how
many times they might have done them before.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_skype_8217_s_24_hour_global_outage">Skype’s 24 hour global outage</h3></div></div></div><p>Skype suffered a 24 hour planet-wide failure in 2010
<sup>[<a id="id820461" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820461" class="footnote">83</a>]</sup>.
Behind the scenes Skype is supported by a peer-to-peer network. An overload in
one part of the system (used to process off-line instant messages) caused
delayed responses from Windows clients, some versions of the Windows client
didn’t properly handle the delayed responses and would crash - approximately 40%
of the live clients crashed including 25% of the public SuperNodes. SuperNodes
are critical to routing data in the network.</p><p>After 25% of the routing capacity fell off of the network (it came back on, but
slowly), the network overall was under great strain. The crashed Windows client
nodes were also restarting and attempting to rejoin the network, adding a new
volume of traffic on the already overloaded system. The SuperNodes have a
back-off procedure if they experience too much load, so they started to
shut-down in response to the waves of traffic.</p><p>Overall Skype became mostly unavailable for 24 hours. The recovery process
involved first setting up hundreds of new MegaSuperNodes configured to deal with
the increased traffic and then following up with thousands more. Over the coming
days the network recovered.</p><p>This incident caused a lot of embarrassment for Skype, clearly it also changed
their focus to damage-limitation for several tense days. Customers would have
been forced to look for alternative solutions for voice calls which is likely to
have been a marketing boon for competitors.</p><p>Given the complexity of the network and the escalation of failures that
occurred, it is likely that this failure would have been hard to both predict
and to plan for. The reason that <span class="emphasis"><em>all</em></span> of the nodes on the network didn’t fail
was due to different versions of the software and different platforms - there’s
a reliability benefit to having a heterogenous network rather than a homogenous
system.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_common_cluster_designs">Common cluster designs</h2></div></div></div><p>It is common to start with a local ad-hoc cluster of reasonably-equivalent
machines. You might wonder if you can add old computers to an ad-hoc network but
typically older CPUs eat a lot of power and run very slowly, so they don’t
contribute as nearly as much as you might hope compared to one new
high-specification machine. An in-office cluster requires someone who can
maintain it. A cluster in Amazon’s EC2, Microft’s Azure or run by an academic
institution off-loads the hardware support to their team.</p><p>If you have well-understood processing requirements it might make sense to
design a custom cluster, perhaps one that uses an InfiniBand high-speed
interconnect in place of gigabit ethernet or one that uses a particular
configuration of RAID drives that support your read, write or resiliency
requirements. You might want to combine both CPUs and GPUs on some machines, or
just to default to CPUs.</p><p>You might want a massively decentralised processing cluster as used by projects
like <span class="email"><a class="email" href="mailto:SETI@home">SETI@home</a></span> and <span class="email"><a class="email" href="mailto:Folding@home">Folding@home</a></span> through the Berkeley Open Infrastructure for
Network Computing (BOINC) system
<sup>[<a id="id820477" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820477" class="footnote">84</a>]</sup>,
it still shares a centralized co-ordination system but the computing nodes join
and leave the project in an ad-hoc fashion.</p><p>On top of the hardware design you can run different software architectures.
Queues of work are the most common and easiest to understand - typically jobs
are put onto a queue and consumed by a processor, the result of processing might
go onto another queue for further processing or used as a final result (e.g. so
it gets added into a database). Message passing systems are slightly different -
messages get put onto a message bus which are then consumed by other machines,
the messages might time-out and get deleted and they might be consumed by
multiple machines. A more complex system is when processes talk to each other
using Inter Process Communication - this can be considered an expert level
configuration as there are lots of ways that you can set it up badly which’ll
result in you losing your sanity. Only go down the IPC route if you really know
that you need it.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_how_to_start_a_clustered_solution">How to start a clustered solution</h2></div></div></div><p>The easiest way to start a clustered system is to begin with 1 machine that will
both run the job server and a job processor (just 1 for 1 CPU). If your tasks
are CPU-bound then run 1 job processor per CPU, if your tasks are I/O bound
then run several per CPU, if they’re RAM-bound then be careful that you don’t
run out of RAM. Get your single machine solution working, with 1 processor, then
add more. Make your code fail in unpredictable ways (e.g. do a <code class="literal">1/0</code> in your
code, use <code class="literal">kill -9 &lt;pid&gt;</code> on your worker, pull the power from the socket so the
whole machine dies) - check if your system is robust.</p><p>Obviously you’ll want to do heavier testing than this - a unit-test suite full
of coding errors and artificial exceptions is good. Personally I like to throw
in unexpected events - e.g. a processor than runs a set of jobs whilst an
external process is systematically killing important processes and confirming
that these all get restarted cleanly by whatever monitoring process you’re
using.</p><p>Once your have 1 running job processor then add a second. Check that you’re not
using too much RAM. Do you process jobs twice as fast as before?</p><p>Now introduce a second machine, with just 1 job processor on that new machine
and 0 job processors on the co-ordinating machine. Does it process jobs as fast
as when you had the processor on the co-ordination machine? If not, why not? Is
latency a problem? Do you have different configurations? Maybe you have
different machine hardware like CPUs, RAM and cache sizes?</p><p>Now add another 9 computers and test to see if you’re processing jobs 10 times
faster than before. If not, why not? Are network collisions now occurring which
slow down your overall processing rate?</p><p>To reliably start the cluster’s components when the machine boots I tend to use
either a cron-job, Circus <sup>[<a id="id820570" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820570" class="footnote">85</a>]</sup>
or supervisord <sup>[<a id="id820554" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820554" class="footnote">86</a>]</sup> and sometimes Upstart
<sup>[<a id="id820560" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820560" class="footnote">87</a>]</sup> (which is being replaced by
systemd). Circus is newer than supervisord, both are Python based. cron is old
but very reliable if you’re just starting scripts like a monitor process that
can start sub-processes as required.</p><p>One you have a reliable cluster you might want to introduce a random-killer tool
like Netflix’s ChaosMonkey <sup>[<a id="id820663" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820663" class="footnote">88</a>]</sup>
which deliberately kills parts of your system to test them for resiliency. Your
processes and your hardware will die so it doesn’t hurt to know that you’re
likely to survive at least the errors you predict might happen.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_ways_to_avoid_pain_when_using_clusters">Ways to avoid pain when using clusters</h2></div></div></div><p>One particularly painful experience I encountered was when a series of queues in
a clustered system ground to a halt. Later queues were not being consumed, so
they filled up. That machine ran out of RAM, so the processes died. Earlier
queues were being processed but couldn’t pass their results to the next queue,
so they crashed. In the end the first queue was being filled but not consumed,
so it crashed. After that we were paying for data from a supplier that
ultimately was discarded. You must sketch out some notes to consider the various
ways your cluster will die (not <span class="emphasis"><em>if it dies</em></span> but simply <span class="emphasis"><em>what happens when it
dies</em></span>) - will you lose data (and is this a problem?)? Will you have a large
backlog that’s too painful to process?</p><p>An easily debugged system <span class="emphasis"><em>probably</em></span> beats having a faster system. Engineer time
and the cost of down-time is <span class="emphasis"><em>probably</em></span> your larger expense (this isn’t true if
you’re running a missile defense program but it is probably true for a
start-up). Rather than shaving a few bytes by using a low level compressed
binary protocol consider using human-readable text in JSON when passinng
messages. It does add an overhead for sending the messages and decoding them but
when you’re left with a partial database after a core computer has caught fire,
you’ll be glad that you can read the important messages quickly as you work to
bring the system back online.</p><p>Make sure it is cheap on time and money to deploy updates to the system - both
operating system updates and new versions of your software. Every time anything
changes in the cluster you risk the system responding in odd ways if it is in a
schizophrenic state. Make sure you use a deployment system like Fabric
<sup>[<a id="id820614" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820614" class="footnote">89</a>]</sup>, Salt
<sup>[<a id="id820626" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820626" class="footnote">90</a>]</sup>, Chef
<sup>[<a id="id820636" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820636" class="footnote">91</a>]</sup>, Puppet <sup>[<a id="id820737" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820737" class="footnote">92</a>]</sup> or
a system image like a Debian <code class="literal">.deb</code> or Redhat <code class="literal">.rpm</code> or an Amazon Machine Image
<sup>[<a id="id820753" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820753" class="footnote">93</a>]</sup>. Being able to
robustly deploy an update that upgrades an entire cluster (with a report on any
problems found) massively reduces stress during difficult times.</p><p>Positive reporting is useful - every day send an email to someone detailing the
performance of the cluster. If that email doesn’t turn up then that’s a useful
clue that something’s happened. Probably you want other early warning systems
that’ll notify you faster - Pingdom <sup>[<a id="id820616" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820616" class="footnote">94</a>]</sup> and
ServerDensity <sup>[<a id="id820702" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820702" class="footnote">95</a>]</sup> are particularly useful
here. A Dead Man’s Switch which reacts to the absence of an event is another
useful backup (e.g. DeadManSwitch <sup>[<a id="id820693" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820693" class="footnote">96</a>]</sup>).</p><p>Reporting to the team on the health of the cluster is very useful. This might be
an admin page inside a web application or a separate report. Ganglia
<sup>[<a id="id820686" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820686" class="footnote">97</a>]</sup> is great for this. I’ve seen a Star
Trek LCARS-like interface running on a spare PC in an office that plays the “red
alert” sound when problems were detected - that’s particularly effective at
getting the attention of an entire office. I’ve even seen Arduinos driving
analogue instruments like old fashioned boiler pressure gauges (they make a nice
sound when the needle moves!) showing system load. This kind of reporting is
important so that everyone understands the difference between “normal” and “this
might ruin Friday night!”.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_three_clustering_solutions">Three clustering solutions</h2></div></div></div><p>In the following sections we introduce <code class="literal">ParallelPython</code>, <code class="literal">IPython Parallel</code> and <code class="literal">NSQ</code>.</p><p><code class="literal">ParallelPython</code> has a very similar interface to <code class="literal">multiprocessing</code>. Upgrading your <code class="literal">multiprocessing</code> solution from a multi-core single machine to multi-machine is the matter of a few minutes work. <code class="literal">ParallelPython</code> has few dependencies and is easy to configure for research work on a local cluster. It isn’t very powerful and lacks communication mechanisms but for sending out embarrassingly parallel jobs to a small local cluster it is very easy to use.</p><p><code class="literal">IPython Cluster</code> is very easy to use on one machine with multiple cores, since many researchers use <code class="literal">IPython</code> as their shell it is natural to also use it for parallel job control. To build a cluster requires a little bit of system administration knowledge and some dependencies (such as ZeroMQ) are required, so the setup is a little more involved than with <code class="literal">ParallelPython</code>. A huge win with <code class="literal">IPython Parallel</code> is the fact that you can use remote clusters (e.g. using Amazon’s AWS and EC2) just as easily as local clusters.</p><p><code class="literal">NSQ</code> is a production-ready queuing system used in companies like Bitly. It has persistance (so if machines die then jobs can be picked up again by another machine) and strong mechanisms for scalability. With this greater power comes a slightly greater need for system administration and engineering skills.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="cluster-parallelpython">Using the ParallelPython module for simple local clusters</h2></div></div></div><p>The parallelpython <sup>[<a id="id820820" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820820" class="footnote">98</a>]</sup> module enables
local clusters of workers using an interface that is similar to
<code class="literal">multiprocessing</code>. Handily this means that converting code from
<code class="literal">multiprocessing</code> using <code class="literal">map</code> to parallelpython is very easy. You can run code
using 1 machine or an ad-hoc network just as easily. You can install it using
<code class="literal">pip install pp</code>.</p><p>We can calculate Pi using the Monte Carlo method as we did back in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html#multiprocessing-estimating-pi">Estimating Pi using Processes and Threads</a>
using our local machine, notice how similar in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#clusters-parallelpython1">Example&nbsp;10-1</a>  the interface is to the earlier <code class="literal">multiprocessing</code> example. We create a list of work into
<code class="literal">nbr_trials_per_process</code> and pass these to 4 local processes. We could create as
many work items as we wanted, they’d be consumed as workers became free.</p><div class="example"><a id="clusters-parallelpython1"></a><div class="example-title">Example&nbsp;10-1.&nbsp;parallelpython local example</div><div class="example-contents"><pre class="screen">...
import pp

NBR_ESTIMATES = 1e8

def calculate_pi(nbr_estimates):
    steps = xrange(int(nbr_estimates))
    nbr_trials_in_unit_circle = 0
    for step in steps:
        x = random.uniform(0, 1)
        y = random.uniform(0, 1)
        is_in_unit_circle = x * x + y * y &lt;= 1.0
        nbr_trials_in_unit_circle += is_in_unit_circle
    return nbr_trials_in_unit_circle

if __name__ == "__main__":
    NBR_PROCESSES = 4
    job_server = pp.Server(ncpus=NBR_PROCESSES)
    print "Starting pp with", job_server.get_ncpus(), "workers"
    nbr_trials_per_process = [NBR_ESTIMATES] * NBR_PROCESSES
    jobs = []
    for input_args in nbr_trials_per_process:
        job = job_server.submit(calculate_pi, (input_args,), (), ("random",))
        jobs.append(job)
    # each job blocks until the result is ready
    nbr_in_unit_circles = [job() for job in jobs]
    print "Amount of work:", sum(nbr_trials_per_process)
    print sum(nbr_in_unit_circles) * 4 / NBR_ESTIMATES / NBR_PROCESSES</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#clusters-parallelpython2">Example&nbsp;10-2</a> we’ll extend the example - this time we’ll
require 1024 jobs of 100,000,000 estimates each with a dynamically configured
cluster. On remote machines we can run <code class="literal">python ppserver.py -w 4 -a -d</code> and
remote servers will start using 4 processes (the default would be 8 on my laptop
but I don’t want to use the 4 HyperThreads so I’ve chosen 4 CPUs), with
autoconnect and with a debug log. The debug log prints debug information to the
screen, this is useful for checking that work has been received. The autoconnect
flag means that we don’t have to specify IP addresses, we let <code class="literal">pp</code> advertise
itself and connect to the servers.</p><div class="example"><a id="clusters-parallelpython2"></a><div class="example-title">Example&nbsp;10-2.&nbsp;parallelpython over a cluster</div><div class="example-contents"><pre class="screen">    ...
    NBR_JOBS = 1024
    NBR_LOCAL_CPUS = 4
    ppservers = ("*",)  # set IP list to be auto-discovered
    job_server = pp.Server(ppservers=ppservers, ncpus=NBR_LOCAL_CPUS)

    print "Starting pp with", job_server.get_ncpus(), "local workers"
    nbr_trials_per_process = [NBR_ESTIMATES] * NBR_JOBS
    jobs = []
    for input_args in nbr_trials_per_process:
        job = job_server.submit(calculate_pi, (input_args,), (), ("random",))
        jobs.append(job)
    ...</pre></div></div><p>If I run with a second powerful laptop then the computation time roughly halves.
If I use an old MacBook with 1 CPU then the MacBook barely helps - often it’ll
compute 1 of the jobs so slowly that the fast laptop is left idle with no more
work to perform, so the overall completion time is longer than if just the fast
laptop were used by itself.</p><p>This is a very useful way to begin building an ad-hoc cluster for light
computation tasks. You probably don’t want to use it in a production environment
(probably Celery or GearMan is a better choice) but for research and easy
scaling when learning about a problem it gives you a quick win.</p><p><code class="literal">pp</code> doesn’t help with distributing code or static data to remote machines, you
have to move external libraries (e.g. anything you might have compiled into a
static library) to the remote machines and provide any shared data. It does
handle pickling the code to run, additional imports and the data you supply from
the controller process.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="clustering-ipython">Using IPython Parallel to support research</h2></div></div></div><p>The IPython cluster support comes via <code class="literal">ipcluster</code>
<sup>[<a id="id820980" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id820980" class="footnote">99</a>]</sup>. IPython becomes an
interface to local and remote processing engines where data can be pushed
amongst the engines and jobs can be pushed to remote machines. Remote debugging
is possible and MPI is optionally supported. This same communication mechanism powers the IPython Notebook interface.</p><p>This is great for a research
setting - you can push jobs to machines in a local cluster, interact and debug
if there’s a problem, push data to machines and collect results back - all
interactively. Note also that PyPy runs IPython and IPython Parallel, the combination might be very powerful (if you don’t use <code class="literal">numpy</code>).</p><p>Behind the scenes ZeroMQ is used as the messaging middle-ware, you’ll need to
have this installed. If you’re building a cluster on a local network then you
can avoid ssh authentication, if you need some security then ssh is fully
supported but it makes configuration a little more involved - start on a local
trusted network and build out as you learn how each component works.</p><p>The project is split into 4 components. An <span class="emphasis"><em>engine</em></span> is a synchronous Python
interpreter that runs your code, you’ll run a set of these to enable parallel
computing. A <span class="emphasis"><em>controller</em></span> provides an interface to the engines, it is
responsible for work distribution and provides a <span class="emphasis"><em>direct</em></span> interface and a <span class="emphasis"><em>load
balanced interface</em></span> which provides a work scheduler. A <span class="emphasis"><em>hub</em></span> keeps track of
engines, schedulers and clients. <span class="emphasis"><em>Schedulers</em></span> hide the synchronous nature of the
engines and provide an asynchronous interface.</p><p>On my laptop I’ll start 4 engines using <code class="literal">$ ipcluster start -n 4</code>. In
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cluster-ipython-firsttest">Example&nbsp;10-3</a> we start IPython and check that a local <code class="literal">Client</code>
can see our 4 local engines. We can address all 4 engines using <code class="literal">c[:]</code> and we
apply a function to each engine - <code class="literal">apply_sync</code> takes a callable so we supply a 0
argument <code class="literal">lambda</code> which will return a string. Each of our 4 local engines will
run one of these functions, returning the same result.</p><div class="example"><a id="cluster-ipython-firsttest"></a><div class="example-title">Example&nbsp;10-3.&nbsp;Testing that we can see the local engines in IPython</div><div class="example-contents"><pre class="screen">In [1]: from IPython.parallel import Client

In [2]: c = Client()

In [3]: print c.ids
[0, 1, 2, 3]

In [4]: c[:].apply_sync(lambda:"Hello High Performance Pythonistas!")
Out[4]:
['Hello High Performance Pythonistas!',
 'Hello High Performance Pythonistas!',
 'Hello High Performance Pythonistas!',
 'Hello High Performance Pythonistas!']</pre></div></div><p>Having constructed our engines they’re now in an empty state. If we import
modules locally, they won’t be imported in the remote engines. A clean way to
import both locally and remotely is to use the <code class="literal">sync_imports</code> context manager. In
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cluster-ipython-secondtest">Example&nbsp;10-4</a> we’ll <code class="literal">import os</code> on both the local IPython and
the 4 connected engines, then call <code class="literal">apply_sync</code> again to the 4 engines to fetch
their PIDs. If we didn’t do the remote imports then we’d get a <code class="literal">NameError</code> as
the remote engines wouldn’t know about the <code class="literal">os</code> module. We can also use
<code class="literal">execute</code> to run any Python command remotely on the engines.</p><div class="example"><a id="cluster-ipython-secondtest"></a><div class="example-title">Example&nbsp;10-4.&nbsp;Import modules into our remote engines</div><div class="example-contents"><pre class="screen">In [5]: dview=c[:]  # this is a Direct View (not a Load Balanced View)

In [6]: with dview.sync_imports():
   ....:     import os
   ....:
importing os on engine(s)

In [7]: dview.apply_sync(lambda:os.getpid())
Out[7]: [15079, 15080, 15081, 15089]

In [8]: dview.execute("import sys")  # another way to execute commands remotely</pre></div></div><p>You’ll want to push data to the engines, the <code class="literal">push</code> command shown in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cluster-ipython-pushdata">Example&nbsp;10-5</a> lets you send a dictionary of items that are added
to the global namespace of each engine. There’s a corresponding <code class="literal">pull</code> to
retrieve items, you give it keys and it’ll return the corresponding values from
each of the engines.</p><div class="example"><a id="cluster-ipython-pushdata"></a><div class="example-title">Example&nbsp;10-5.&nbsp;Push shared data to the engines</div><div class="example-contents"><pre class="screen">In [9]: dview.push({'shared_data':[50, 100]})
Out[9]: &lt;AsyncResult: _push&gt;

In [10]: dview.apply_sync(lambda:len(shared_data))
Out[10]: [2, 2, 2, 2]</pre></div></div><p>Now let’s add a second machine to the cluster. First - kill the <code class="literal">ipengine</code>
engines that we’d created before and exit IPython. We’ll start from a clean
slate. You’ll need a second machine available which has ssh configured to allow
you to automatically login.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cluster-ipython-make-local-profile">Example&nbsp;10-6</a> we’ll create a new profile for our
cluster. A set of configuration files are placed in the
<code class="literal">&lt;HOME&gt;/.ipython/profile_mycluster</code> directory, by default the engines are
configured to accept connections from localhost only and not from external
devices. Edit <code class="literal">ipengine_config.py</code> to configure the <code class="literal">HubFactory</code> to accept
external connections, save and then start a new <code class="literal">ipcluster</code> using our new
profile. We’re back to having 4 local engines.</p><div class="example"><a id="cluster-ipython-make-local-profile"></a><div class="example-title">Example&nbsp;10-6.&nbsp;Create a local profile that accepts public connections</div><div class="example-contents"><pre class="screen">$ ipython profile create mycluster --parallel
$ gvim /home/ian/.ipython/profile_mycluster/ipengine_config.py
# add "c.HubFactory.ip = '*'" near the top
$ ipcluster start -n 4 --profile=mycluster</pre></div></div><p>Next we need to pass this configuration file to our remote machine. In
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cluster-ipython-copy-profile-remotely">Example&nbsp;10-7</a> we use <code class="literal">scp</code> to copy
<code class="literal">ipcontroller-engine.json</code> (which was created when we started <code class="literal">ipcluster</code>) to
the remote machine’s <code class="literal">.config/ipython/profile_default/security</code> directory. Once
it is copied, on the remote machine run <code class="literal">ipengine</code> and it’ll look in the default
directory for <code class="literal">ipcontroller-engine.json</code>, if it connects successfully then
you’ll see a message like the one shown below.</p><div class="example"><a id="cluster-ipython-copy-profile-remotely"></a><div class="example-title">Example&nbsp;10-7.&nbsp;Copy the edited profile to the remote machine and test</div><div class="example-contents"><pre class="screen"># On the local machine
$ scp /home/ian/.ipython/profile_mycluster/security/ipcontroller-engine.json
      ian@192.168.0.16:/home/ian/.config/ipython/profile_default/security/

# Now on the remote machine
ian@ubuntu:~$ ipengine
...Using existing profile dir: u'/home/ian/.config/ipython/profile_default'
...Loading url_file u'/home/ian/.config/ipython/profile_default/security/
       ipcontroller-engine.json'
...Registering with controller at tcp://192.168.0.128:35963
...Starting to monitor the heartbeat signal from the hub every 3010 ms.
...Using existing profile dir: u'/home/ian/.config/ipython/profile_default'
...Completed registration with id 4</pre></div></div><p>Let’s test the configuration. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cluster-ipython-test-cluster">Example&nbsp;10-8</a> we’ll start a
local IPython shell using the new profile, we’ll retrieve a list of 5 clients (4
locally and 1 remotely), then we’ll ask for Python’s version info - you can see
that on the remote machine I’m using the Anaconda distribution. We only get 1
additional engine as the remote machine in this case is a single core MacBook.</p><div class="example"><a id="cluster-ipython-test-cluster"></a><div class="example-title">Example&nbsp;10-8.&nbsp;Test that the new machine is a part of the cluster</div><div class="example-contents"><pre class="screen">$ ipython --profile=mycluster
Python 2.7.5+ (default, Sep 19 2013, 13:48:49)
Type "copyright", "credits" or "license" for more information.
IPython 1.1.0 -- An enhanced Interactive Python.
...
In [1]: from IPython.parallel import Client

In [2]: c = Client()

In [3]: c.ids
Out[3]: [0, 1, 2, 3, 4]

In [4]: dview=c[:]

In [5]: with dview.sync_imports():
   ...:     import sys

In [6]: dview.apply_sync(lambda:sys.version)
Out[6]:
['2.7.5+ (default, Sep 19 2013, 13:48:49) \n[GCC 4.8.1]',
 '2.7.5+ (default, Sep 19 2013, 13:48:49) \n[GCC 4.8.1]',
 '2.7.5+ (default, Sep 19 2013, 13:48:49) \n[GCC 4.8.1]',
 '2.7.5+ (default, Sep 19 2013, 13:48:49) \n[GCC 4.8.1]',
 '2.7.6 |Anaconda 1.9.2 (64-bit)| (default, Jan 17 2014, 10:13:17) \n
            [GCC 4.1.2 20080704 (Red Hat 4.1.2-54)]']</pre></div></div><p>Let’s put it all together. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cluster-ipython-pi">Example&nbsp;10-9</a> we’ll use the 5 engines to
estimate Pi as we did using <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cluster-parallelpython">Using the ParallelPython module for simple local clusters</a>. This time we’ll use the
<code class="literal">@require</code> decorator to import the <code class="literal">random</code> module in the engines. We use a
direct view to send our work out to the engines, this blocks until all the
results come back, then we estimate Pi as we’ve done before.</p><div class="example"><a id="cluster-ipython-pi"></a><div class="example-title">Example&nbsp;10-9.&nbsp;Estimating Pi using our local cluster</div><div class="example-contents"><pre class="screen">from IPython.parallel import Client, require
NBR_ESTIMATES = 1e8

@require('random')
def calculate_pi(nbr_estimates):
    ...
    return nbr_trials_in_unit_circle

if __name__ == "__main__":
    c = Client()
    nbr_engines = len(c.ids)
    print "We're using {} engines".format(nbr_engines)
    dview = c[:]
    nbr_in_unit_circles = dview.apply_sync(calculate_pi, NBR_ESTIMATES)

    print "Estimates made:", nbr_in_unit_circles

    # work using the engines only
    nbr_jobs = len(nbr_in_unit_circles)
    print sum(nbr_in_unit_circles) * 4 / NBR_ESTIMATES / nbr_jobs</pre></div></div><p>IPython Parallel offers much more than what’s shown here. Asychronous jobs and
mappings over larger input ranges are of course possible. A <code class="literal">CompositeError</code> is
a higher level Exception that wraps up the same Exception that’s occurred on
multiple engines (rather than you receiving multiple identical exceptions if
you’ve deployed bad code!), it is a convenience when dealing with lots of
engines
<sup>[<a id="id821380" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id821380" class="footnote">100</a>]</sup>.</p><p>One particularly powerful feature of IPython Parallel is that it supports
StarCluster so you can easily use larger clustering environments including
supercomputers and cloud services like Amazon’s EC2. To further ease this sort
of cluster’s development the Anaconda distribution includes support for
StarCluster. Olivier Grisel gives a great tutorial on Advanced Machine Learning
with scikit-learn
<sup>[<a id="id821389" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id821389" class="footnote">101</a>]</sup>
at PyCon 2013, at the 2 hour point he demos using StarCluster for machine
learning via IPython Parallel on Amazon EC2 spot instances.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_nsq_for_robust_production_clustering">NSQ for robust production clustering</h2></div></div></div><p>In a production environment, you will need a solution that is more robust than
the other solutions we’ve talked about so far.  This is because during the
everyday operation of your cluster, nodes may become unavailable, code may
crash, networks may go down, or one of the other thousands of problems that can
happen will happen.  The problem is that previous systems have one computer
where commands are issued and a limited and static number of computers that read
the commands and execute them.  Instead, we would like a system where we can
have multiple actors communicating via some message bus—this would allow us
to have an arbitrary and constantly changing number of message creators and
consumers.</p><p>One simple solution to these problems is NSQ
<sup>[<a id="id821521" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id821521" class="footnote">102</a>]</sup>, a highly performant distributed
messaging platform.  While it is written in GO it is completely data format and
language agnostic.  As a result, there are libraries in many languages and the
basic interface into it is a REST API which only requires the ability to make
HTTP calls.  Furthermore, we can send messages in any format we want; JSON,
Pickle, mesgpack, etc.  Most importantly however, it provides fundamental
guarantees regarding message delivery and does all of this using two simple
design patterns—queues and pub/subs.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_queues">Queues</h3></div></div></div><p>A queue is a type of buffer for messages.  Whenever you want to send a message
to another part of your processing pipeline, you send it to the queue and it’ll
wait in the queue until there is an available worker to read it.  A queue is
most useful in distributed processing when there is an imbalance between
production and consumption.  If this imbalance occurs we can simply scale
horizontally by adding more data consumers until the message production rate and
consumption rate are equal.  In addition, if the computers responsible for
consuming messages go down, the messages are not and are simply queued until
there is an available consumer, thus giving us message delivery guarantees.</p><p>For example, let’s say we would like to process new recommendations for a user
every time they rate a new item on our site.  If we didn’t have a queue, then
the “rate” action would directly call the “recalculate-recommendations” action,
regardless of how busy the servers dealing with recommendations are.  If all of
a sudden, thousands of users decide to rate something your recommendations could
get so swamped with requests they could start timing out, dropping messages and
generally become unresponsive!</p><p>On the other hand, with a queue the recommendations servers ask for more tasks
when they are ready.  A new “rate” action would put a new task on the queue, and
when a recommendations server becomes ready to do more work it would grab it
from the queue and process it.  In this setup, if more users than normal start
rating items, our queue would fill up and act as a buffer for the
recommendations servers—their workload would be unaffected and they could
still process messages until the queue is empty.</p><p>One potential problem with this is that if a queue becomes completely
overwhelmed with work, it will be storing quite a lot of messages.  NSQ solves
this by having multiple storage back-ends—when there aren’t many messages then
they are stored in memory and as more messages start coming in the messages get
put onto disk.</p><div class="note"><h3 class="title">Note</h3><p>Generally when working with queued systems, it is a good idea to try to have the
downstream systems (ie: the recommendations systems in the above example) be at
60% capacity with a normal workload.  This is a good compromise between
allocating too many resources for a problem and giving your servers enough extra
power for when the amount of work increases beyond normal levels.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_pub_sub">Pub/Sub</h3></div></div></div><p>A pub/sub (short for publisher/subscriber), on the other hand, describes who
gets what messages.  What happens is that a data publisher can put data out of a
particular topic, and data subscribers can subscribe to different feeds of data.
Whenever the publisher puts out a piece of information, it gets sent to all of
the subscribers—they each get an identical copy of the original information.
This can be thought of like a newspaper: many people can subscribe to a
particular newspaper and whenever a new edition of the newspaper comes out,
every subscriber gets an identical copy of it.  In addition, the producer of the
newspaper doesn’t need to know all of the people it’s papers are being sent to.
As a result, publishers and subscribers are decoupled from each other which
allows our system to be more robust as our network changes while still in
production.</p><p>In addition to this, NSQ adds the notion of a data consumer.  That is, multiple
processes can be connected to the same data subscription.  Whenever a new piece
of data comes out, every subscriber gets a copy of the data, however only one
consumer of each subscription sees that data.  In the newspaper analogy this can
be thought of as multiple people in the same household who read the newspaper.
The newspaper will deliver one paper to the house, since that house only has one
subscription, and whoever in the house gets the mail first gets to read that
data. Each of these consumers do the same processing to a message when they see
it, however they can potentially be on multiple computers and thus add more
processing power to the entire pool.</p><p>We can see a depiction of this pub/sub/consumer paradigm in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#clustering_nsq_overview">Figure&nbsp;10-1</a>.  If a new message gets published on the “clicks”
topic, all of the subscribers will get a copy (ie: “metrics”, “spam_analysis”
and “archive”).  However, each subscriber is comprised of one or more consumers
which represent actual processes which react to the messages.  So, one one
consumer within the “metrics” subscription will see this message.  The next
message will go to another consumer and so on.</p><div class="figure"><a id="clustering_nsq_overview"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/nsq.png.jpg" alt="NSQ Ideology" width="500" height="338" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/nsq.png.jpg"></div></div><div class="figure-title">Figure&nbsp;10-1.&nbsp;NSQ Ideology</div></div><p>The benefits of staggering out the messages between a potentially large pool of
consumers is essentially automatic load balancing.  If a message takes quite a
long time to process, that consumer will not signal to NSQ that it is ready for
more messages and thus the other consumers will get the majority of future
messages (until that original consumer is ready to process again).  In addition,
it allows consumers to disconnect (whether by choice or because of failure) or
new consumers to connect to the cluster while still maintaining processing
power within a particular subscription group.  For example, if we find that
metrics takes quite a while to process and it often is not keeping up with
demand, we can simply add more processes that join  the consumer pool for that
subscription group and this gives us more processing power.  On the other hand,
if we see that most of our processes are idle (ie: not getting any messages), we
can easily remove consumers from this subscription pool.</p><p>It is also important to note that anything can publish data.  A consumer doesn’t
simply need to be a consumer—it can consume data from one topic and then
publish it to another topic.  In fact, this chain is an important work-flow when
it comes to this paradigm for distributed computing.  Consumers will read from a
topic of data, transform the data in some way, and then publish the data onto a
new topic that other consumers can further transform.  In this way, different
topics represent different data, subscription groups represent different
transformations on the data and consumers are the actual workers who transform
individual messages.</p><p>Furthermore, there is an incredible redundancy in this system.  There can be
many <code class="literal">nsq</code> processes that each consumer connects to and there can be many
consumers connected to a particular subscription.  This makes it so that there
is no single point of failure and your system will be robust even if several
machines disappear.  We can see in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#clustering_nsq_spof">Figure&nbsp;10-2</a> that even if one of
the computers in the diagram goes down, the system is still able to deliver and
process messages.  In addition, since NSQ saves pending messages to disk when
shutting down, unless the hardware loss is catastrophic your data will most
likely still be intact and be delivered.  Lastly, if a consumer is shut down
before responding a particular message, then NSQ will re-send that message to
another consumer.  This means that even as consumers get shut down we know that
all the messages in a topic will be responded to at least once. <sup>[<a id="id821597" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id821597" epub:type="noteref" class="footnote">103</a>]</sup></p><div class="figure"><a id="clustering_nsq_spof"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/nsq_spof.png.jpg" alt="NSQ Connection Topology" width="500" height="307" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/nsq_spof.png.jpg"></div></div><div class="figure-title">Figure&nbsp;10-2.&nbsp;NSQ Connection Topology</div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_distributed_prime_calculation">Distributed Prime Calculation</h3></div></div></div><p>Code that uses NSQ is generally asynchronous <sup>[<a id="id821674" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id821674" epub:type="noteref" class="footnote">104</a>]</sup> (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html">Chapter&nbsp;8</a> for
a full explanation of this), although it doesn’t necessarily have to be.  In the
following example, we will create a pool of workers that read from a topic
called <span class="emphasis"><em>numbers</em></span> that simply has JSON blobs with a number in them.  The
consumers will read this topic, find out if the numbers are primes, and then
write to another topic depending on whether the number was prime.  This will
give us two new topics, <span class="emphasis"><em>primes</em></span> and <span class="emphasis"><em>non_primes</em></span> that other consumers can
connect to in order to do more calculations. <sup>[<a id="id821629" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id821629" epub:type="noteref" class="footnote">105</a>]</sup></p><p>As said before, there are many benefits to doing CPU bound work like this.
Firstly, we have all the guarantees of robustness, which may or may not be
useful for this project.  More importantly, however, we get automatic load
balancing.  That means that if one consumer gets a number that takes a
particularly long time to process, the other consumers will pick up the slack.</p><p>A consumer is created by creating an <code class="literal">nsq.Reader</code> object with the topic and
subscription group specified (as can be seen at the end of
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#clustering_nsq_example">Example&nbsp;10-10</a>).  We also must specify the location of the running
<code class="literal">nsqd</code> instance (or the <code class="literal">nsqlookupd</code> instance which we will not get into in this
section).  In addition, we specify a handler which is simply a function which
gets called for each message from the topic.</p><p>To create a producer, we create an <code class="literal">nsq.Writer</code> object and specify the location
of one (or multiple) <code class="literal">nsqd</code> instances to write to.  This gives us the ability to
write to <code class="literal">nsq</code>, asynchronously, simply by specifying the topic name and the
message. <sup>[<a id="id821743" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id821743" epub:type="noteref" class="footnote">106</a>]</sup></p><div class="example"><a id="clustering_nsq_example"></a><div class="example-title">Example&nbsp;10-10.&nbsp;Distributed prime calculation with NSQ</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">nsq</code>
<code class="kn">from</code> <code class="nn">tornado</code> <code class="kn">import</code> <code class="n">gen</code>

<code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>
<code class="kn">import</code> <code class="nn">ujson</code> <code class="kn">as</code> <code class="nn">json</code>

<code class="nd">@gen.coroutine</code>
<code class="k">def</code> <code class="nf">write_message</code><code class="p">(</code><code class="n">topic</code><code class="p">,</code> <code class="n">data</code><code class="p">,</code> <code class="n">writer</code><code class="p">):</code>
    <code class="n">response</code> <code class="o">=</code> <code class="k">yield</code> <code class="n">gen</code><code class="o">.</code><code class="n">Task</code><code class="p">(</code><code class="n">writer</code><code class="o">.</code><code class="n">pub</code><code class="p">,</code> <code class="n">topic</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code> <code class="c"># </code><a id="CO23-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="k">if</code> <code class="nb">isinstance</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="n">nsq</code><code class="o">.</code><code class="n">Error</code><code class="p">):</code>
        <code class="k">print</code> <code class="s">"Error with Message: {}: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">)</code>
        <code class="k">yield</code> <code class="n">write_message</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">writer</code><code class="p">)</code>
    <code class="k">else</code><code class="p">:</code>
        <code class="k">print</code> <code class="s">"Published Message: "</code><code class="p">,</code> <code class="n">data</code>

<code class="k">def</code> <code class="nf">calculate_prime</code><code class="p">(</code><code class="n">message</code><code class="p">,</code> <code class="n">writer</code><code class="p">):</code>
    <code class="n">message</code><code class="o">.</code><code class="n">enable_async</code><code class="p">()</code> <code class="c"># </code><a id="CO23-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">data</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">message</code><code class="o">.</code><code class="n">body</code><code class="p">)</code>

    <code class="n">prime</code> <code class="o">=</code> <code class="n">is_prime</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s">"number"</code><code class="p">])</code>
    <code class="n">data</code><code class="p">[</code><code class="s">"prime"</code><code class="p">]</code> <code class="o">=</code> <code class="n">prime</code>
    <code class="k">if</code> <code class="n">prime</code><code class="p">:</code>
        <code class="n">topic</code> <code class="o">=</code> <code class="s">'primes'</code>
    <code class="k">else</code><code class="p">:</code>
        <code class="n">topic</code> <code class="o">=</code> <code class="s">'non_primes'</code>

    <code class="n">output_message</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
    <code class="n">write_message</code><code class="p">(</code><code class="n">topic</code><code class="p">,</code> <code class="n">output_message</code><code class="p">,</code> <code class="n">writer</code><code class="p">)</code>
    <code class="n">message</code><code class="o">.</code><code class="n">finish</code><code class="p">()</code> <code class="c"># </code><a id="CO23-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="n">writer</code> <code class="o">=</code> <code class="n">nsq</code><code class="o">.</code><code class="n">Writer</code><code class="p">([</code><code class="s">'127.0.0.1:4150'</code><code class="p">,</code> <code class="p">])</code>
    <code class="n">handler</code> <code class="o">=</code> <code class="n">partial</code><code class="p">(</code><code class="n">calculate_prime</code><code class="p">,</code> <code class="n">writer</code><code class="o">=</code><code class="n">writer</code><code class="p">)</code>
    <code class="n">reader</code> <code class="o">=</code> <code class="n">nsq</code><code class="o">.</code><code class="n">Reader</code><code class="p">(</code>
        <code class="n">message_handler</code> <code class="o">=</code> <code class="n">handler</code><code class="p">,</code>
        <code class="n">nsqd_tcp_addresses</code> <code class="o">=</code> <code class="p">[</code><code class="s">'127.0.0.1:4150'</code><code class="p">,</code> <code class="p">],</code>
        <code class="n">topic</code> <code class="o">=</code> <code class="s">'numbers'</code><code class="p">,</code>
        <code class="n">channel</code> <code class="o">=</code> <code class="s">'worker_group_a'</code><code class="p">,</code>
    <code class="p">)</code>
    <code class="n">nsq</code><code class="o">.</code><code class="n">run</code><code class="p">()</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#CO23-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
We will asynchronously write the result to a new topic, and retry writing if it fails for some reason
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#CO23-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
By enabling async on a message, we can perform asynchronous operations while processing the message
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#CO23-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
With async-enabled messages, we must signal to NSQ when we are done with a message
</p></dd></dl></div></div></div><p>In order to set up the nsq ecosystem, we will first start an instance of <code class="literal">nsqd</code>
on our local machine,</p><pre class="programlisting"><code class="nv">$ </code>nsqd
2014/05/10 16:48:42 nsqd v0.2.27 <code class="o">(</code>built w/go1.2.1<code class="o">)</code>
2014/05/10 16:48:42 worker id 382
2014/05/10 16:48:42 NSQ: persisting topic/channel metadata to nsqd.382.dat
2014/05/10 16:48:42 TCP: listening on <code class="o">[</code>::<code class="o">]</code>:4150
2014/05/10 16:48:42 HTTP: listening on <code class="o">[</code>::<code class="o">]</code>:4151</pre><p>Now, we can start as many instances of our python code,
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#clustering_nsq_example">Example&nbsp;10-10</a>, as we want.  In fact, we can have these instances
running on other computers as long as the reference to the <code class="literal">nsqd_tcp_address</code> in
the instantiation of the <code class="literal">nsq.Reader</code> is still valid.  These consumers will
connect to nsqd and await messages to be published on the <span class="emphasis"><em>numbers</em></span> topic.</p><p>There are many ways data can be published to the <span class="emphasis"><em>numbers</em></span> topic.  We will use
command line tools to do this since knowing how to poke and prod a system goes a
long way in understanding how to properly deal with it.  We can simply use the
HTTP interface to publish messages to the topic,</p><pre class="programlisting"><code class="nv">$ </code><code class="k">for </code>i in <code class="sb">`</code>seq 10000<code class="sb">`</code>
&gt; <code class="k">do</code>
&gt;   <code class="nb">echo</code> <code class="o">{</code><code class="se">\"</code>number<code class="se">\"</code>: <code class="nv">$i</code><code class="o">}</code> | curl -d@- <code class="s2">"http://127.0.0.1:4151/pub?topic=numbers"</code>
&gt; <code class="k">done</code></pre><p>As this command starts running, we are publishing messages with different
numbers in them to the <span class="emphasis"><em>numbers</em></span> topic.  At the same time, all of our producers
will start outputting status messages that they have seen and processed
messages.  In addition, these numbers are being published to either the <span class="emphasis"><em>primes</em></span>
or <span class="emphasis"><em>non_primes</em></span> topic.  This allows us to have other data consumers that connect
to either of these topics to get a filtered subset of our original data.  For
example, an application that requires only the prime numbers can simply connect
to the <code class="literal">primes</code> topic and constantly have new primes for its calculation.  We
can see the status of this by uses the <code class="literal">stats</code> HTTP endpoint for nsq,</p><pre class="programlisting"><code class="nv">$ </code>curl <code class="s2">"http://127.0.0.1:4151/stats"</code>
nsqd v0.2.27 <code class="o">(</code>built w/go1.2.1<code class="o">)</code>

   <code class="o">[</code>numbers        <code class="o">]</code> depth: 0     be-depth: 0     msgs: 3060     e2e%:
      <code class="o">[</code>worker_group_a           <code class="o">]</code> depth: 1785  be-depth: 0     inflt: 1    def: 0
                                  re-q: 0     timeout: 0     msgs: 3060     e2e%:
        <code class="o">[</code>V2 muon:55915           <code class="o">]</code> state: 3 inflt: 1    rdy: 0    fin: 1469
                                   re-q: 0        msgs: 1469     connected: 24s

   <code class="o">[</code>primes         <code class="o">]</code> depth:  195  be-depth: 0     msgs: 1274     e2e%:

   <code class="o">[</code>non_primes     <code class="o">]</code> depth: 1274  be-depth: 0     msgs: 1274     e2e%:</pre><p>We can see above that the <span class="emphasis"><em>numbers</em></span> topic has one subscription group,
<span class="emphasis"><em>worker_group_a</em></span> with one consumer.  In addition, the subscription group has a
large depth of 1785 messages which means that we are putting messages into nsq
faster than we can process them.  This would be an indication to add more
consumers so that we have more processing power to get through more messages.
Furthermore, we can see that the particular consumer has been connected for 24
seconds, has processed 1469 messages and currently has 1 message in-flight.
This status endpoint gives quite a good deal of information to debug your nsq
setup!  Lastly, we see the <span class="emphasis"><em>primes</em></span> and <span class="emphasis"><em>non_primes</em></span> topic that has no
subscribers or consumers.  This means that the messages will be stored until a
subscriber comes requesting the data.</p><div class="note"><h3 class="title">Note</h3><p>In production, you can use the even more powerful tool <code class="literal">nsqadmin</code> which provides
a web interface with very detailed overviews of all topics/subscribers and
consumers.  In addition, it easily allows you to pause and delete subscribers and
topics.</p></div><p>Lastly, to actually see the messages we would create a new consumer for the
<span class="emphasis"><em>primes</em></span> that simply archives the results to a file or database.  Alternatively,
we can use the <code class="literal">nsq_tail</code> tool to take a peak into the data and see what it
contains.</p><pre class="programlisting"><code class="nv">$ </code>nsq_tail --topic primes --nsqd-tcp-address<code class="o">=</code>127.0.0.1:4150
2014/05/10 17:05:33 starting Handler go-routine
2014/05/10 17:05:33 <code class="o">[</code>127.0.0.1:4150<code class="o">]</code> connecting to nsqd
2014/05/10 17:05:33 <code class="o">[</code>127.0.0.1:4150<code class="o">]</code> IDENTIFY response:
                    <code class="o">{</code>MaxRdyCount:2500 TLSv1:false Deflate:false Snappy:false<code class="o">}</code>
<code class="o">{</code><code class="s2">"prime"</code>:true,<code class="s2">"number"</code>:5<code class="o">}</code>
<code class="o">{</code><code class="s2">"prime"</code>:true,<code class="s2">"number"</code>:7<code class="o">}</code>
<code class="o">{</code><code class="s2">"prime"</code>:true,<code class="s2">"number"</code>:11<code class="o">}</code>
<code class="o">{</code><code class="s2">"prime"</code>:true,<code class="s2">"number"</code>:13<code class="o">}</code>
<code class="o">{</code><code class="s2">"prime"</code>:true,<code class="s2">"number"</code>:17<code class="o">}</code></pre></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_other_clustering_tools_to_look_at">Other clustering tools to look at</h2></div></div></div><p>Job processing systems using queues have existed since the start of the computer
science industry, back when computers were very slow and lots of jobs needed to
be processed. As a result there are <span class="emphasis"><em>many</em></span> libraries for queues and many of
these can be used in a cluster configuration. We strongly suggest that you pick
a mature library with an active community behind it, supporting the same feature
set that you’ll need and not too many additional features.</p><p>The more features a library has, the more ways you’ll find to mis-configure it
and waste time on debugging. Simplicity is <span class="emphasis"><em>generally</em></span> the right aim when
dealing with clustered solutions. We list a few of the more commonly used
clustering solutions below.</p><p>Celery <sup>[<a id="id823350" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id823350" class="footnote">107</a>]</sup> (BSD license) is a widely used
asynchronous task queue using a distributed messaging architecture, written in
Python. It supports Python, PyPy and Jython. Typically is uses RabbitMQ as the
message broker but it also supports Redis, MongoDB and other storage systems. It
is often used in web development projects. Andrew Godwin discusses Celery in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-andrew">Task queues at Lanyrd.com</a>.</p><p>Gearman <sup>[<a id="id823372" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id823372" class="footnote">108</a>]</sup> (BSD license) is a multi-platform job
processing system. It is very useful if you are integrating job processing using
different technologies, bindings are available for Python, PHP, C++, Perl and
many other languages.</p><p>PyRes <sup>[<a id="id823395" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id823395" class="footnote">109</a>]</sup> is a Redis based lightweight
task manager for Python. Jobs are added to queues in Redis and consumers are
setup to process them, optionally passing results back on a new queue. It is a
very easy system to start with if your needs are light and Python-only.</p><p>Amazon’s Simple Queue Service <sup>[<a id="id823439" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id823439" class="footnote">110</a>]</sup> is a job
processing system integrated into Amazon Web Services. Job consumers and
producers can live inside AWS or can be external, so SQS is easy to start with
and supports easy migration into the cloud. Library supports exists for many
languages.</p><p>Clusters can also be used for distributed <code class="literal">numpy</code> processing, this is a relatively young development in the Python world. Both Enthought and Continuum have solutions via the <code class="literal">distarray</code> <sup>[<a id="id823457" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id823457" class="footnote">111</a>]</sup> and <code class="literal">blaze</code> <sup>[<a id="id823403" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#ftn.id823403" class="footnote">112</a>]</sup> packages. Note that these packages attempt to deal with the complicated problems of synchronization and data locality (there is no one-size-fits-all solution) on your behalf, so be aware that you probably have to think about how your data is laid out and accessed.</p><p>So far in the book we’ve looked at profiling to understand slow parts of your code, compiling and <code class="literal">numpy</code> to make your code run faster and various approaches to multiple processes and computers. In the penultimate chapter we’ll look at ways of using less RAM through different data structures and probabilistic approaches. These lessons could help you to keep all your data on one machine, avoiding the need to run a cluster.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id820094"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820094" class="simpara">78</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Beowulf_cluster" target="_top">http://en.wikipedia.org/wiki/Beowulf_cluster</a></p></div><div class="footnote" id="ftn.id820108"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820108" class="simpara">79</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Google_platform" target="_top">http://en.wikipedia.org/wiki/Google_platform</a></p></div><div class="footnote" id="ftn.id820104"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820104" class="simpara">80</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/TOP500" target="_top">http://en.wikipedia.org/wiki/TOP500</a></p></div><div class="footnote" id="ftn.id820363"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820363" class="simpara">81</a>] </sup><a class="ulink" href="http://aws.amazon.com/ec2/purchasing-options/spot-instances/" target="_top">http://aws.amazon.com/ec2/purchasing-options/spot-instances/</a></p></div><div class="footnote" id="ftn.id820485"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820485" class="simpara">82</a>] </sup><a class="ulink" href="http://www.theregister.co.uk/2013/10/23/lone_sysadmin_caused_462_meeellion_wall_street_crash/" target="_top">http://www.theregister.co.uk/2013/10/23/lone_sysadmin_caused_462_meeellion_wall_street_crash/</a></p></div><div class="footnote" id="ftn.id820461"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820461" class="simpara">83</a>] </sup><a class="ulink" href="http://beeyeas.blogspot.co.uk/2014/01/cio-update-post-mortem-on-skype-outage.html" target="_top">http://beeyeas.blogspot.co.uk/2014/01/cio-update-post-mortem-on-skype-outage.html</a></p></div><div class="footnote" id="ftn.id820477"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820477" class="simpara">84</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Berkeley_Open_Infrastructure_for_Network_Computing" target="_top">http://en.wikipedia.org/wiki/Berkeley_Open_Infrastructure_for_Network_Computing</a></p></div><div class="footnote" id="ftn.id820570"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820570" class="simpara">85</a>] </sup><a class="ulink" href="https://circus.readthedocs.org/en/latest/" target="_top">https://circus.readthedocs.org/en/latest/</a></p></div><div class="footnote" id="ftn.id820554"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820554" class="simpara">86</a>] </sup><a class="ulink" href="http://supervisord.org/" target="_top">http://supervisord.org/</a></p></div><div class="footnote" id="ftn.id820560"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820560" class="simpara">87</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Upstart" target="_top">http://en.wikipedia.org/wiki/Upstart</a></p></div><div class="footnote" id="ftn.id820663"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820663" class="simpara">88</a>] </sup><a class="ulink" href="https://github.com/Netflix/SimianArmy" target="_top">https://github.com/Netflix/SimianArmy</a></p></div><div class="footnote" id="ftn.id820614"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820614" class="simpara">89</a>] </sup><a class="ulink" href="http://www.fabfile.org/" target="_top">http://www.fabfile.org/</a></p></div><div class="footnote" id="ftn.id820626"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820626" class="simpara">90</a>] </sup><a class="ulink" href="https://salt.readthedocs.org/en/latest/" target="_top">https://salt.readthedocs.org/en/latest/</a></p></div><div class="footnote" id="ftn.id820636"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820636" class="simpara">91</a>] </sup><a class="ulink" href="http://www.getchef.com/" target="_top">http://www.getchef.com/</a></p></div><div class="footnote" id="ftn.id820737"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820737" class="simpara">92</a>] </sup><a class="ulink" href="http://puppetlabs.com/" target="_top">http://puppetlabs.com/</a></p></div><div class="footnote" id="ftn.id820753"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820753" class="simpara">93</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Amazon_Machine_Image" target="_top">http://en.wikipedia.org/wiki/Amazon_Machine_Image</a></p></div><div class="footnote" id="ftn.id820616"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820616" class="simpara">94</a>] </sup><a class="ulink" href="https://www.pingdom.com/" target="_top">https://www.pingdom.com/</a></p></div><div class="footnote" id="ftn.id820702"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820702" class="simpara">95</a>] </sup><a class="ulink" href="https://www.serverdensity.com/" target="_top">https://www.serverdensity.com/</a></p></div><div class="footnote" id="ftn.id820693"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820693" class="simpara">96</a>] </sup><a class="ulink" href="http://www.deadmansswitch.net/" target="_top">http://www.deadmansswitch.net/</a></p></div><div class="footnote" id="ftn.id820686"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820686" class="simpara">97</a>] </sup><a class="ulink" href="http://ganglia.sourceforge.net/" target="_top">http://ganglia.sourceforge.net/</a></p></div><div class="footnote" id="ftn.id820820"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820820" class="simpara">98</a>] </sup><a class="ulink" href="http://www.parallelpython.com/" target="_top">http://www.parallelpython.com/</a></p></div><div class="footnote" id="ftn.id820980"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id820980" class="simpara">99</a>] </sup><a class="ulink" href="http://ipython.org/ipython-doc/dev/parallel/" target="_top">http://ipython.org/ipython-doc/dev/parallel/</a></p></div><div class="footnote" id="ftn.id821380"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id821380" class="simpara">100</a>] </sup><a class="ulink" href="http://ipython.org/ipython-doc/dev/parallel/parallel_multiengine.html#parallel-exceptions" target="_top">http://ipython.org/ipython-doc/dev/parallel/parallel_multiengine.html#parallel-exceptions</a></p></div><div class="footnote" id="ftn.id821389"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id821389" class="simpara">101</a>] </sup><a class="ulink" href="http://pyvideo.org/video/1719/advanced-machine-learning-with-scikit-learn" target="_top">http://pyvideo.org/video/1719/advanced-machine-learning-with-scikit-learn</a></p></div><div class="footnote" id="ftn.id821521"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id821521" class="simpara">102</a>] </sup><a class="ulink" href="https://github.com/bitly/nsq" target="_top">https://github.com/bitly/nsq</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id821597"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id821597" class="simpara">103</a>] </sup>This
can be quite advantageous when working in AWS where we can have our <code class="literal">nsqd</code>
processes run on a reserved instance and our consumers working on a cluster of
spot instances.</p></div><div class="footnote" epub:type="footnote" id="ftn.id821674"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id821674" class="simpara">104</a>] </sup>This asynchronisity comes
from NSQ’s protocol for sending messages to consumers being PUSH based.  This
makes it so we can have an asynchronous read from our connection to NSQ happen
in the background and wake up when a message is found</p></div><div class="footnote" epub:type="footnote" id="ftn.id821629"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id821629" class="simpara">105</a>] </sup>This sort of chaining of
data analysis is called pipelining and can be an effective way to perform
multiple types of analysis on the same data efficiently.</p></div><div class="footnote" epub:type="footnote" id="ftn.id821743"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id821743" class="simpara">106</a>] </sup>You can also easily publish a message manually with an HTTP
call, however this <code class="literal">nsq.Writer</code> object simplifies much of the error handling</p></div><div class="footnote" id="ftn.id823350"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id823350" class="simpara">107</a>] </sup><a class="ulink" href="http://www.celeryproject.org/" target="_top">http://www.celeryproject.org/</a></p></div><div class="footnote" id="ftn.id823372"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id823372" class="simpara">108</a>] </sup><a class="ulink" href="http://gearman.org/" target="_top">http://gearman.org/</a></p></div><div class="footnote" id="ftn.id823395"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id823395" class="simpara">109</a>] </sup><a class="ulink" href="https://github.com/binarydud/pyres" target="_top">https://github.com/binarydud/pyres</a></p></div><div class="footnote" id="ftn.id823439"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id823439" class="simpara">110</a>] </sup><a class="ulink" href="http://aws.amazon.com/sqs/" target="_top">http://aws.amazon.com/sqs/</a></p></div><div class="footnote" id="ftn.id823457"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id823457" class="simpara">111</a>] </sup><a class="ulink" href="https://github.com/enthought/distarray" target="_top">https://github.com/enthought/distarray</a></p></div><div class="footnote" id="ftn.id823403"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#id823403" class="simpara">112</a>] </sup><a class="ulink" href="https://github.com/ContinuumIO/blaze" target="_top">https://github.com/ContinuumIO/blaze</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch09.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">9. The multiprocessing module</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch11.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">11. Using Less RAM</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch10.html" data-for-analytics="9781449361747:ch10.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch10.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch11.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch11.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch11.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch11.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>11. Using Less RAM - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch11.html"><meta name="description" content="Chapter&nbsp;11.&nbsp;Using Less RAM Questions you’ll be able to answer after this chapter Why should we use less RAM? Why are numpy and array better for storing lots ... "><meta property="og:title" content="11. Using Less RAM"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="11. Using Less RAM"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;11.&nbsp;Using Less RAM Questions you’ll be able to answer after this chapter Why should we use less RAM? Why are numpy and array better for storing lots ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch11.html" data-for-analytics="9781449361747:ch11.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%2011.%20Using%20Less%20RAM&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch10.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">10. Clusters and Job Queues</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch12.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">12. Lessons from the Field</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-lessram"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;11.&nbsp;Using Less RAM</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Why should we use less RAM?
</li><li class="listitem">
Why are numpy and array better for storing lots of numbers?
</li><li class="listitem">
How can lots of text be efficiently stored in RAM?
</li><li class="listitem">
How could we count (approximately!) to 1e77 using just 1 byte?
</li><li class="listitem">
What are Bloom Filters and why might we need them?
</li></ul></div></div><p>You rarely think about how much RAM you’re using until you run out of it. If you run out whilst scaling your code it can become a sudden blocker. Fitting more into a machine’s RAM means fewer machines to manage and it gives you a route to planning capacity for larger projects. Knowing why RAM gets eaten up and considering more efficient ways to use this scarce resource will help you deal with scaling issues.</p><p>Another route to saving RAM is to use containers that utilize features in your data for compression. We’ll look at Tries and a DAWG that can compress a 1.1GB set of strings down to just 254MB with little change in performance. A third approach is to trade storage for accuracy. For this we’ll look at approximate counting and approximate set membership which use dramatically less RAM than their exact counterparts.</p><p>A consideration with RAM usage is the notion that “data has mass” - the more there is of it, the slower it moves around. If you can be parsimonious in your use of RAM then your data will probably get consumed faster as it’ll move around buses faster and more of it will fit into constrained caches. If you need to store it in off-line storage (e.g. a hard-drive or a remote data cluster) then it’ll move far more slowly to your machine. Try to choose appropriate data structures so it can fit onto one machine.</p><p>Counting the amount of RAM used by Python objects is surprisingly tricky. Behind the
scenes we don’t necessarily know how an object is represented and if we ask the
Operating System for a count of bytes used it will tell us about the total
amount allocated to the process. In both cases we can’t see exactly how each
individual Python object adds to the total.</p><p>As some objects and libraries
don’t report their full internal allocation of bytes (or they wrap external
libraries which do not report their allocation at all), this has to be a case of
best-guessing. The following approaches help us to decide on the best way to
represent our data so we use less RAM overall.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_objects_for_primitives_are_emphasis_expensive_emphasis">Objects for primitives are <span class="emphasis"><em>expensive</em></span></h2></div></div></div><p>Typically we work with containers like the <code class="literal">list</code> and we store hundreds or thousands of items. As soon as you store a large number, RAM usage becomes an issue.</p><p>A <code class="literal">list</code> with 100,000,000 items consumes approximately 760MB <span class="emphasis"><em>if the items are
the same object</em></span>. If we store 100,000,000 <span class="emphasis"><em>different</em></span> items (e.g. unique integers) then we can expect to use gigabytes of RAM! Each unique object has a memory cost.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-1e8-same-items">Example&nbsp;11-1</a> we’ll store many <code class="literal">0</code> integers in a <code class="literal">list</code>. Roughly the same memory cost will occur if we store 100,000,000 of the same item as each item in the list is just a reference to the same underlying object. Refer back to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#memory_profiler">memory_profiler for diagnosing memory usage</a> for a reminder on how to use <code class="literal">memory_profiler</code>, here we load it as a new magic function in IPython using <code class="literal">%load_ext memory_profiler</code>.</p><div class="example"><a id="lessram-memory-profiler-1e8-same-items"></a><div class="example-title">Example&nbsp;11-1.&nbsp;Measuring memory usage of 100,000,000 of the same integer in a list</div><div class="example-contents"><pre class="screen">In [1]: %load_ext memory_profiler  # load the %memit magic function
In [2]: %memit [0]*int(1e8)
peak memory: 790.64 MiB, increment: 762.91 MiB</pre></div></div><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>Memory can be cached in the running process, it is always safer to exit and
restart the Python shell when using <code class="literal">memit</code> for profiling.</p></div><p>A fresh IPython shell consumes approximately 20MB of RAM. We can create a
temporary list of 100,000,000 <span class="emphasis"><em>unique</em></span> numbers and in total this consumes
approximately 3.1GB.</p><p>After the <code class="literal">memit</code> command finishes in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-1e8-different-items">Example&nbsp;11-2</a> the temporary list is
deallocated and the second call to <code class="literal">memit</code> shows that the memory usage stays at
approximately 2.3GB.</p><div class="tip"><h3 class="title">Tip</h3><p>Before reading the answer - why might the Python process still hold 2.3GB of RAM? What’s left behind even though the <code class="literal">list</code> has gone to the garbage collector?</p></div><div class="example"><a id="lessram-memory-profiler-1e8-different-items"></a><div class="example-title">Example&nbsp;11-2.&nbsp;Measuring memory usage of 100,000,000 different integers in a list</div><div class="example-contents"><pre class="screen"># we use a new IPython shell so we have a clean memory
In [1]: %load_ext memory_profiler
In [2]: %memit  # show how much RAM this process is consuming right now
peak memory: 20.05 MiB, increment: 0.03 MiB
In [3]: %memit [n for n in xrange(int(1e8))]
peak memory: 3127.53 MiB, increment: 3106.96 MiB
In [4]: %memit
peak memory: 2364.81 MiB, increment: 0.00 MiB</pre></div></div><p>The 100,000,000 integer objects occupy the majority of the 2.3GB even though they’re no longer being used. Python caches primitive objects like integers for later use, on a system with constrained RAM this can cause problems so you should be aware that these primitives may build up in the cache.</p><p>A subsequent <code class="literal">memit</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-1e8-different-items2">Example&nbsp;11-3</a> to create a second 100,000,000 item list consumes
approximately 760MB, this takes the overall allocation during this call back up
to approximately 3.1GB. The 760MB is for the container alone and as the underlying
Python integer objects already exist - they’re in the cache so they get reused.</p><div class="example"><a id="lessram-memory-profiler-1e8-different-items2"></a><div class="example-title">Example&nbsp;11-3.&nbsp;Measuring memory usage again for 100,000,000 different integers in a list</div><div class="example-contents"><pre class="screen">In [5]: %memit [n for n in xrange(int(1e8))]
peak memory: 3127.52 MiB, increment: 762.71 MiB</pre></div></div><p>Next we’ll see that we can use the <code class="literal">array</code> module to store 100,000,000 integers far more cheaply.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_the_literal_array_literal_module_stores_many_primitive_objects_cheaply">The <code class="literal">array</code> module stores many primitive objects cheaply</h3></div></div></div><p>The <code class="literal">array</code> module efficiently stores primitive types like integers, floats and
characters but <span class="emphasis"><em>not</em></span> complex numbers or classes. It creates a contiguous block of RAM to hold the underlying data.</p><p>Below we allocate 100,000,000
integers (8 bytes each) into a contiguous chunk of memory, in total
approximately 760MiB is consumed by the process. The difference between this
approach and the previous list-of-unique-integers approach is <code class="literal">2300MiB - 760MiB
== 1.5GiB</code>. This is a huge saving in RAM.</p><p>The unique numbers in the <code class="literal">array</code> are <span class="emphasis"><em>not</em></span> Python objects, they are
bytes in the <code class="literal">array</code>, if we were to dereference any of them then a new Python
<code class="literal">int</code> object would be constructed. If you’re going to compute on them then no overall saving will occur but if instead you’re going to pass the array to an external process or use only some of data, you should see a good saving in RAM compared to using a list of integers.</p><div class="example"><a id="lessram-array1"></a><div class="example-title">Example&nbsp;11-4.&nbsp;Building an array of 100,000,000 integers with 760MB of RAM</div><div class="example-contents"><pre class="screen">In [1]: %load_ext memory_profiler
In [2]: import array
In [3]: %memit array.array('l', xrange(int(1e8)))
peak memory: 781.03 MiB, increment: 760.98 MiB
In [4]: arr = array.array('l')
In [5]: arr.itemsize
Out[5]: 8</pre></div></div><div class="note"><h3 class="title">Note</h3><p>If you’re working with a large array or matrix of numbers with Cython and you don’t want an external dependency on <code class="literal">numpy</code>, be aware that you can store your data in an <code class="literal">array</code> and pass it into Cython for processing without any addition memory overhead.</p></div><p>The <code class="literal">array</code> module works with a limited set of datatypes with varying precisions.
Choose the smallest precision that you need so you allocate just as much RAM as
needed and no more. Be aware that the byte-size is platform dependent, the sizes
here refer to a 32 bit platform (it states <span class="emphasis"><em>minimum</em></span> size) whilst I’m running on
a 64 bit laptop.</p><div class="example"><a id="lessram-array2"></a><div class="example-title">Example&nbsp;11-5.&nbsp;The basic types provided by the array module</div><div class="example-contents"><pre class="screen">In [5]: array?  # IPython magic, similar to help(array)
Type:       module
String Form:&lt;module 'array' (built-in)&gt;
Docstring:
This module defines an object type which can efficiently represent
an array of basic values: characters, integers, floating point
numbers.  Arrays are sequence types and behave very much like lists,
except that the type of objects stored in them is constrained.  The
type is specified at object creation time by using a type code, which
is a single character.  The following type codes are defined:

    Type code   C Type             Minimum size in bytes
    'c'         character          1
    'b'         signed integer     1
    'B'         unsigned integer   1
    'u'         Unicode character  2
    'h'         signed integer     2
    'H'         unsigned integer   2
    'i'         signed integer     2
    'I'         unsigned integer   2
    'l'         signed integer     4
    'L'         unsigned integer   4
    'f'         floating point     4
    'd'         floating point     8

The constructor is:

array(typecode [, initializer]) -- create a new array</pre></div></div><p><code class="literal">numpy</code> has arrays that can hold a wider range of datatypes - you have more
control over the number of bytes per item and you can use complex numbers and
datetime objects.  A <code class="literal">complex128</code> object takes 16 bytes per item, each item is a
pair of 8 byte floating point numbers. You can’t store <code class="literal">complex</code> objects in a Python array but they come for free with <code class="literal">numpy</code>. If you’d like a refresher on <code class="literal">numpy</code> then look back to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a>.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-numpy1">Example&nbsp;11-6</a> you can see an additional feature of <code class="literal">numpy</code> arrays - you can query for the number of items, the size of each primitive and the combined total storage of the underlying block of RAM. Note that this doesn’t include the overhead of the Python object (typically this is tiny in comparison to the data you store in the arrays).</p><div class="example"><a id="lessram-numpy1"></a><div class="example-title">Example&nbsp;11-6.&nbsp;Storing more complex types in a numpy array</div><div class="example-contents"><pre class="screen">In [1]: %load_ext memory_profiler
In [2]: import numpy as np
In [3]: %memit arr=np.zeros(1e8, np.complex128)
peak memory: 1552.48 MiB, increment: 1525.75 MiB
In [4]: arr.size  # same as len(arr)
Out[4]: 100000000
In [5]: arr.nbytes
Out[5]: 1600000000
In [6]: arr.nbytes/arr.size  # bytes per item
Out[6]: 16
In [7]: arr.itemsize  # another way of checking
Out[7]: 16</pre></div></div><p>Using a regular <code class="literal">list</code> to store many numbers is much less efficient in RAM than
using an <code class="literal">array</code> object. This means more memory allocations have to occur which
each take time, calculations occur on larger objects which will be less cache
friendly and that more RAM is used overall so less RAM is available to other
programs.</p><p>However - if you do any work on the contents of the <code class="literal">array</code> in Python then the primitives are likely to be converted into temporary objects, negating their benefit. Using them as a data store when communicating with other processes is a strong benefit of the <code class="literal">array</code>.</p><p><code class="literal">numpy</code> arrays are almost certainly a better choice if you are doing anything
heavily numeric as you get more datatype options and many specialised and fast
functions. You might choose to avoid <code class="literal">numpy</code> if you want fewer dependencies for
your project. Cython and Pythran work equally well with <code class="literal">array</code> and <code class="literal">numpy</code>
arrays, Numba works with <code class="literal">numpy</code> arrays only.</p><p>Python provides a few other tools to understand memory usage.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_understanding_the_ram_used_in_a_collection">Understanding the RAM used in a collection</h2></div></div></div><p>You may wonder if you can ask Python about the RAM that’s used by each object. Python’s <code class="literal">sys.getsizeof(obj)</code> call will tell us <span class="emphasis"><em>something</em></span> about the memory used by an object (most
but not all objects provide this). If you haven’t seen it before then be warned
that it won’t give you the answer you’d expect for a container!</p><p>Let’s start by looking at some primitive types. An <code class="literal">int</code> in Python is a variable
sized object, it starts as a regular integer and turns into a Long integer if
you count above <code class="literal">sys.maxint</code> (on my 64 bit laptop this is
9,223,372,036,854,775,807).</p><p>As a regular integer it takes 24 bytes (the object has a lot of
overhead), as a Long integer it consumes 36 bytes.</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="nb">int</code><code class="p">())</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="mi">24</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="mi">24</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">n</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">maxint</code><code class="o">+</code><code class="mi">1</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">n</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="mi">36</code></pre><p>We can do the same check for byte strings. An empty string costs 37 bytes, each
additional byte adds one byte to the cost.</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">b</code><code class="s">""</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="mi">37</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">b</code><code class="s">"a"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="mi">38</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">23</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">b</code><code class="s">"ab"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">23</code><code class="p">]:</code> <code class="mi">39</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">b</code><code class="s">"cde"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="mi">40</code></pre><p>When we use a list we see different behavior. It isn’t counting the cost of the
contents of the list, just the cost of the list itself. An empty list costs 72
bytes, each item in the list takes another 8 bytes on my 64 bit laptop.</p><pre class="programlisting"><code class="c"># goes up in 8 byte steps rather than the 24 we might expect!</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">36</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">36</code><code class="p">]:</code> <code class="mi">72</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">37</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="mi">1</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">37</code><code class="p">]:</code> <code class="mi">80</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">38</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">38</code><code class="p">]:</code> <code class="mi">88</code></pre><p>This is more obvious if we use byte strings - we’d expect to see much larger
costs than <code class="literal">getsizeof</code> is reporting.</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">40</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="n">b</code><code class="s">""</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">40</code><code class="p">]:</code> <code class="mi">80</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">41</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="n">b</code><code class="s">"abcdefghijklm"</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">41</code><code class="p">]:</code> <code class="mi">80</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">42</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="n">b</code><code class="s">"a"</code><code class="p">,</code> <code class="n">b</code><code class="s">"b"</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">42</code><code class="p">]:</code> <code class="mi">88</code></pre><p><code class="literal">getsizeof</code> only reports some of the cost and often just for the parent object. As noted before it isn’t always implemented, so it can have limited usefulness.</p><p>A slightly better tool is <code class="literal">asizeof</code> <sup>[<a id="id825207" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id825207" class="footnote">113</a>]</sup> which will walk a
container’s hierarchy and attempt to get the best guess of the size of each
object it finds, adding them to a total. Be warned that it is quite slow.</p><p>It makes some guesses and assumptions, it also cannot count memory allocated
<span class="emphasis"><em>behind the scenes</em></span> (e.g. a module that wraps a C library may not report the
bytes allocated in the C library). It is best to use this as a guide. I prefer
to use <code class="literal">memit</code> as I get an accurate count of memory usage on the machine in
question.</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="o">%</code><code class="n">run</code> <code class="n">asizeof</code><code class="o">.</code><code class="n">py</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">asizeof</code><code class="p">([</code><code class="n">b</code><code class="s">"abcdefghijklm"</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="mi">136</code></pre><p>We can check the estimate for a large list - here we’ll use 10,000,000 integers.</p><pre class="programlisting"><code class="c"># this takes 30 seconds to run!</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="n">asizeof</code><code class="p">([</code><code class="n">x</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">10000000</code><code class="p">)])</code>  <code class="c"># 1e7 integers</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="mi">321528064</code></pre><p>We can validate this estimate by using <code class="literal">memit</code> to see how the process grew, in
this case the numbers are very similar:</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="o">%</code><code class="n">memit</code><code class="p">([</code><code class="n">x</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">10000000</code><code class="p">)])</code>
<code class="n">peak</code> <code class="n">memory</code><code class="p">:</code> <code class="mf">330.64</code> <code class="n">MiB</code><code class="p">,</code> <code class="n">increment</code><code class="p">:</code> <code class="mf">310.62</code> <code class="n">MiB</code></pre><p>Generally the <code class="literal">asizeof</code> process is slower than using <code class="literal">memit</code> but <code class="literal">asizeof</code> can
be useful when analysing small objects. <code class="literal">memit</code> is probably more useful for
real-world applications as the actual memory usage of the process is measured
rather than inferred.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_bytes_vs_unicode">Bytes vs Unicode</h2></div></div></div><p>One of the compelling reasons to switch to Python 3.3+ is that Unicode object storage is significantly cheaper than it is in Python 2.7. If you mainly handle lots of strings and they eat a lot of RAM, definitely consider a move to Python 3.3+. You get this RAM saving absolutely for free.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-stringvsunicode1">Example&nbsp;11-7</a> we can see a 100,000,000 character sequence being built as a collection of bytes (this is the same as a regular <code class="literal">str</code> in Python 2.7) and a Unicode object. The Unicode variant takes four times as much RAM. Every Unicode character costs the same higher price regardless of the number bytes required to represent the underlying data.</p><div class="example"><a id="lessram-memory-profiler-stringvsunicode1"></a><div class="example-title">Example&nbsp;11-7.&nbsp;Unicode objects are expensive in Python 2.7</div><div class="example-contents"><pre class="screen">In [1]: %load_ext memory_profiler
In [2]: %memit b"a" * int(1e8)
peak memory: 100.98 MiB, increment: 80.97 MiB
In [3]: %memit u"a" * int(1e8)
peak memory: 380.98 MiB, increment: 360.92 MiB</pre></div></div><p>The UTF-8 encoding of a Unicode object uses 1 byte per ASCII character and more bytes for less frequently seen characters. Python 2.7 uses an equal number of bytes for a Unicode character regardless of the character’s prevalence. If you’re not sure about Unicode encodings versus Unicode objects then go and watch Net Batchelder’s “Pragmatic Unicode - Or How Do I Stop The Pain?” <sup>[<a id="id825696" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id825696" class="footnote">114</a>]</sup>.</p><p>From Python 3.3 we have a flexible Unicode representation thanks to PEP 393
<sup>[<a id="id825718" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id825718" class="footnote">115</a>]</sup>. It works by observing the range of characters in the string and using a smaller number of bytes to represent the lower order characters if possible.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-stringvsunicode2">Example&nbsp;11-8</a> you can see that the cost of the byte and Unicode versions of an ASCII character are the same and that using a non-ASCII character (sigma) the memory usage only doubles - this is still better than the Python 2.7 situation.</p><div class="example"><a id="lessram-memory-profiler-stringvsunicode2"></a><div class="example-title">Example&nbsp;11-8.&nbsp;Unicode objects are far cheaper in Python 3.3+</div><div class="example-contents"><pre class="screen">Python 3.3.2+ (default, Oct  9 2013, 14:50:09)
IPython 1.2.0 -- An enhanced Interactive Python.
...
In [1]: %load_ext memory_profiler
In [2]: %memit b"a" * int(1e8)
peak memory: 91.77 MiB, increment: 71.41 MiB
In [3]: %memit u"a" * int(1e8)
peak memory: 91.54 MiB, increment: 70.98 MiB
In [4]: %memit u"Σ" * int(1e8)
peak memory: 174.72 MiB, increment: 153.76 MiB</pre></div></div><p>Given that Unicode objects are default in Python 3.3+, if you work with lots of string data then you’ll almost certainly benefit from the upgrade. The lack of cheap string storage was a hindrance for some in the early Python 3.1+ days, now with PEP 393 this is absolutely not an issue.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_efficiently_storing_lots_of_text_in_ram">Efficiently storing lots of text in RAM</h2></div></div></div><p>A common problem with text is that it occupies a lot of RAM, if we want to test
if we have seen strings before or count their frequency then it is convenient to
have them in RAM rather than paging them to and from a disk. Storing the strings
naively is expensive but Tries and Directed Acyclic Word Graphs (DAWGs) can be
used to compress their representation and still allow fast operations.</p><p>These more advanced algorithms can save you a significant amount of RAM which means that you might not need to expand to more servers - for production systems the savings can be huge. In this section we’ll look at compressing a <code class="literal">set</code> of strings costing 1.1GB down to 254MB using a Trie, with only a small change in performance.</p><p>For the following section we’ll use a text set built from a partial dump of
WikiPedia. This set contains 8,545,076 unique tokens from a portion of the English WikiPedia and is 111,707,546 (111MB) on disk.</p><p>The tokens are split on whitespace from their original articles, they have
variable length and contain unicode characters and numbers. They look like:</p><pre class="screen">faddishness
'melanesians'
Kharálampos
PizzaInACup™
url="http://en.wikipedia.org/wiki?curid=363886"
VIIIa),
Superbagnères.</pre><p>We’ll use this text sample to test how quickly we can build a data
structure holding one instance of each unique word and then we’ll see how
quickly we can query for a known word (we’ll use the uncommon “Zwiebel” from the painter Alfred Zwiebel). This
lets us ask “have we seen Zwiebel before?”. Token look-up is a common problem,
being able to do it quickly is important.</p><div class="informalexample"><a id="NOTEa"></a><p>When you try these containers on your own problems be aware that you will
probably see different behaviors. Each container builds its internal structures
in different ways, passing in different types of token is likely to affect the
build time of the structure and different lengths of token will affect the query
time. Always test in a methodical way.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_trying_these_approaches_on_8_million_tokens">Trying these approaches on 8 million tokens</h3></div></div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-less-ram-8mil_tokens">Figure&nbsp;11-1</a> shows the 8 million token text file (111MB raw data) stored using a number of containers which we’ll discuss in this section. The x-axis shows RAM usage for each container, the y-axis track the query time and the size of each point relates to the time taken to build the structure (larger means it took longer).</p><p>As we can see in this diagram the <code class="literal">set</code> and <code class="literal">DAWG</code> examples use a lot of RAM.
The <code class="literal">list</code> example is expensive on RAM and slow. The Marisa Trie and HAT Trie
examples are the most efficient for this data set - they use a <span class="emphasis"><em>quarter</em></span> of the
RAM of the other approaches with little change in look-up speed.</p><div class="figure"><a id="FIG-less-ram-8mil_tokens"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/less_ram_tries_dawg_text_8545076_tokens.png" alt="DAWG and Tries versus built-in containers for 8 million tokens" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/less_ram_tries_dawg_text_8545076_tokens.png"></div></div><div class="figure-title">Figure&nbsp;11-1.&nbsp;DAWG and Tries versus built-in containers.</div></div><p>The figure doesn’t show the look-up time for the naive <code class="literal">list</code> without sort approach which I’ll introduce shortly as it takes far too long. The <code class="literal">datrie</code>
example is not included in the plot because it raised a Segmentation Fault (I’ve had
problems with it on other problems in the past) - when it works it is fast and
compact but it can exhibit pathological build times that make it hard to justify. It is worth including <span class="emphasis"><em>because</em></span> it can be faster than the other methods but obviously you’ll want to test it thoroughly on your data.</p><p>Do be aware that you must test your problem with a variety of containers, each
offers different trade-offs such as construction time and API flexibility.</p><p>Next we’ll build up a process to test the behavior of each container.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_list">list</h3></div></div></div><p>Let’s start with the simplest approach. We’ll load our tokens into a <code class="literal">list</code> and then query then using an O(n) linear search. We <span class="emphasis"><em>can’t</em></span> do this on the large example that I’ve already mentioned - the search takes far too long. I’ll demonstrate the technique with a much smaller (499,048 token) example.</p><p>In each of the following examples we use a generator <code class="literal">text_example.readers</code>
that extracts one unicode token at a time from the input file, this means that only a tiny amount of RAM
is used by the read process.</p><div class="informalexample"><pre class="screen">    t1 = time.time()
    words = [w for w in text_example.readers]
    print "Loading {} words".format(len(words))
    t2 = time.time()
    print "RAM after creating list {:0.1f}MiB, took {:0.1f}s".
        format(memory_profiler.memory_usage()[0], t2 - t1)</pre></div><p>We’re interested in how quickly we can query this list, ideally we want to find
a container that will store our text and allow us to query it and modify it
without penalty. To query it we look for a known word a number of times using
<code class="literal">timeit</code>:</p><div class="informalexample"><pre class="screen">    assert u'Zwiebel' in words
    time_cost = sum(timeit.repeat(stmt="u'Zwiebel' in words",
                                  setup="from __main__ import words",
                                  number=1,
                                  repeat=10000))
    print "Summed time to lookup word {:0.4f}s".format(time_cost)</pre></div><p>Our test script reports that approximately 59MB was used to store the original
5MB file as a list and that the lookup time was 86 seconds:</p><pre class="screen">RAM at start 10.3MiB
Loading 499048 words
RAM after creating list 59.4MiB, took 1.7s
Summed time to lookup word 86.1757s</pre><p>Storing text in an unsorted <code class="literal">list</code> is obviously a poor idea, the O(n) look-up
time is expensive and the memory usage is expensive. This is the worst of all
worlds!</p><p>We can improve the look-up time by sorting the <code class="literal">list</code> and using a binary search
via the <code class="literal">bisect</code> module <sup>[<a id="id826005" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826005" class="footnote">116</a>]</sup>, this gives us a sensible lower-bound for future
queries. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_list_sorted_code">Example&nbsp;11-9</a> we time how long it takes to <code class="literal">sort</code>
the list. Now we’ll switch to the large 8,545,076 token set.</p><div class="example"><a id="less_ram_list_sorted_code"></a><div class="example-title">Example&nbsp;11-9.&nbsp;bisect to allow efficient searches on a sorted list</div><div class="example-contents"><pre class="screen">    t1 = time.time()
    words = [w for w in text_example.readers]
    print "Loading {} words".format(len(words))
    t2 = time.time()
    print "RAM after creating list {:0.1f}MiB, took {:0.1f}s".
        format(memory_profiler.memory_usage()[0], t2 - t1)
    print "The list contains {} words".format(len(words))
    words.sort()
    t3 = time.time()
    print "Sorting list took {:0.1f}s".format(t3 - t2)</pre></div></div><p>Next we do the same look-up as before but with the addition of the <code class="literal">index</code>
method which uses <code class="literal">bisect</code>:</p><div class="informalexample"><pre class="screen">import bisect
...
def index(a, x):
    'Locate the leftmost value exactly equal to x'
    i = bisect.bisect_left(a, x)
    if i != len(a) and a[i] == x:
        return i
    raise ValueError
...
    time_cost = sum(timeit.repeat(stmt="index(words, u'Zwiebel')",
                                  setup="from __main__ import words, index",
                                  number=1,
                                  repeat=10000))</pre></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_bisect_list_output">Example&nbsp;11-10</a> we see that the RAM usage is much larger than before as we’re loading significantly more data. The sort takes a further 16 seconds and the cumulative look-up time is 0.02 seconds.</p><div class="example"><a id="less_ram_bisect_list_output"></a><div class="example-title">Example&nbsp;11-10.&nbsp;Timings for using bisect on a sorted list</div><div class="example-contents"><pre class="screen">$ python text_example_list_bisect.py
RAM at start 10.3MiB
Loading 8545076 words
RAM after creating list 932.1MiB, took 31.0s
The list contains 8545076 words
Sorting list took 16.9s
Summed time to lookup word 0.0201s</pre></div></div><p>We now have a sensible baseline for timing string look-ups - RAM usage must get better than 932MB and the total look-up time should be better than 0.02 seconds.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_set">set</h3></div></div></div><p>Using the built-in <code class="literal">set</code> might seem to be the most obvious way to tackle our
task. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_set_code">Example&nbsp;11-11</a> the <code class="literal">set</code> stores each string in a hashed structure (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html">Chapter&nbsp;4</a> if you need a refresher) - it is quick to check for membership but each string must be stored separately which is expensive on RAM.</p><div class="example"><a id="less_ram_set_code"></a><div class="example-title">Example&nbsp;11-11.&nbsp;Using a set to store the data</div><div class="example-contents"><pre class="screen">    words_set = set(text_example.readers)</pre></div></div><p>The <code class="literal">set</code> uses more RAM than the <code class="literal">list</code> but it gives us a very fast look-up time
without needing an additional <code class="literal">index</code> function and without requiring an intermediate sorting operation.</p><pre class="screen">$ python text_example_set.py
RAM at start 10.3MiB
RAM after creating set 1122.9MiB, took 31.6s
The set contains 8545076 words
Summed time to lookup word 0.0033s</pre><p>If RAM isn’t at a premium then this might be the most sensible first approach.</p><p>We have now lost the <span class="emphasis"><em>ordering</em></span> of the original data. If that’s important to you then note that you could store the strings as keys in a dictionary, with each value being an index connected to the original read order. This way you could ask the dictionary if the key is present and for its index.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_more_efficient_tree_structures">More Efficient Tree Structures</h3></div></div></div><p>Let’s introduce a set of algorithms that use RAM more efficiently to represent our strings.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-less-ram-trie-dawg-picture">Figure&nbsp;11-2</a> (attribution: WikiMedia <sup>[<a id="id826195" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826195" class="footnote">117</a>]</sup>) shows the difference in representation of four words “tap”, “taps”, “top”, and “tops” between a Trie and a DAWG. With a <code class="literal">list</code> or a <code class="literal">set</code> each of these words would be stored as separate strings. Both the DAWG and Trie share parts of the strings so that less RAM is used. WikiPedia <sup>[<a id="id826211" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826211" class="footnote">118</a>]</sup> has some more background.</p><p>The main difference between these is that a DAWG shares common prefixes and suffixes, on words (like English) where there are many common prefixes and suffixes this can save a lot of repetition. A Trie shares just a common prefix. Exact memory behavior will depend on your data’s structure. Typically a DAWG cannot assign a value to a key due to the multiple paths from the start to the end of the string but the version I show here can accept a value mapping. Tries can accept a value mapping.</p><p>Some structures have to be constructed in a pass at the start, others can be updated at any time.</p><div class="figure"><a id="FIG-less-ram-trie-dawg-picture"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 270; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/lessram-trie-vs-minimal-acyclic-fa.svg.png.jpg" alt="DAWG and Trie data structures" width="877" height="1000" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/lessram-trie-vs-minimal-acyclic-fa.svg.png.jpg"></div></div><div class="figure-title">Figure&nbsp;11-2.&nbsp;Trie and DAWG Structures</div></div><p>A big strength of some of these structures is that they provide a <span class="emphasis"><em>common prefix search</em></span> - you can ask for all words that share the prefix you provide. With the four words above the result when searching for “ta” would be “tap” and “taps” - since these are discovered through the graph structure the retrieval of these results is very fast. If you’re working with DNA then compressing millions of short strings using a Trie can be an efficient way to reduce RAM usage.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_directed_acyclic_word_graph_dawg">Directed Acyclic Word Graph (DAWG)</h3></div></div></div><p>The Directed Acyclic Word Graph <sup>[<a id="id826283" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826283" class="footnote">119</a>]</sup> (MIT
license) attempts to efficiently represent strings that share common prefixes and suffixes.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_dawg_code">Example&nbsp;11-12</a> you’ll see the very simple setup for the DAWG. For this implementation the DAWG cannot be
modified after construction, it reads an iterator to construct itself once. The lack of post-construction updates might be a deal-breaker for your use-case.</p><div class="example"><a id="less_ram_dawg_code"></a><div class="example-title">Example&nbsp;11-12.&nbsp;Using a DAWG to store the data</div><div class="example-contents"><pre class="screen">import dawg
...
    words_dawg = dawg.DAWG(text_example.readers)</pre></div></div><p>It does support rich queries including prefix look-ups, it allows persistence and supports storing integer indexes as a value
along with byte and record values.</p><p>On this set of strings in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less-ram-dawg-example">Example&nbsp;11-13</a> it uses only slightly less RAM than the earlier <code class="literal">set</code> example. More similar input text will cause stronger compression.</p><div class="example"><a id="less-ram-dawg-example"></a><div class="example-title">Example&nbsp;11-13.&nbsp;Running the DAWG example</div><div class="example-contents"><pre class="screen">$ python text_example_dawg.py
RAM at start 10.3MiB
RAM after creating dawg 968.8MiB, took 63.1s
Summed time to lookup word 0.0049s</pre></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_marisa_trie">Marisa trie</h3></div></div></div><p>The Marisa Trie <sup>[<a id="id826372" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826372" class="footnote">120</a>]</sup> (dual-licensed
LGPL and BSD) is a static Trie <sup>[<a id="id826390" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826390" class="footnote">121</a>]</sup>
using Cython bindings to an external library. As it is static it cannot be modified after construction.</p><p>Each of the Tries available in
this package are static. Like the DAWG it supports storing integer indexes as
values, byte values and record values.</p><p>A key can be used to look-up a value and vice-versa. All keys sharing the same
prefix can be found efficiently. The Trie’s contents can be persisted.</p><div class="example"><a id="less_ram_marisa_trie_code"></a><div class="example-title">Example&nbsp;11-14.&nbsp;Using a Marisa trie to store the data</div><div class="example-contents"><pre class="screen">import marisa_trie
...
    words_trie = marisa_trie.Trie(text_example.readers)</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less-ram-marisa-trie-example">Example&nbsp;11-15</a> we see a marked improvement in RAM storage compared to the DAWG example but the overall search time is a little slower.</p><div class="example"><a id="less-ram-marisa-trie-example"></a><div class="example-title">Example&nbsp;11-15.&nbsp;Running the Marisa trie example</div><div class="example-contents"><pre class="screen">$ python text_example_trie.py
RAM at start 11.0MiB
RAM after creating trie 304.7MiB, took 55.3s
The trie contains 8545076 words
Summed time to lookup word 0.0101s</pre></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="memory_datrie">datrie</h3></div></div></div><p>The Double-Array Trie <sup>[<a id="id826451" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826451" class="footnote">122</a>]</sup> (licensed LGPL)
uses a pre-built alphabet to efficiently store keys. This Trie can be modified
after creation but only with the same alphabet. It can also find all keys that share the prefix of the provided
key and it supports persistence.</p><p>Along with the HAT Trie it offers one of the fastest look-up times.</p><p>I’ll note that when using the datrie on the WikiPedia example and for
past work on DNA representations the datrie had a pathological build-time, it
could take minutes or hours to represent my DNA strings compared to other data structures.</p><p>The datrie needs an alphabet to be presented to the constructor, only keys using
this alphabet are allowed. In our WikiPedia example this means we need two passes on the raw data, you can see this in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_datrie_code">Example&nbsp;11-16</a>.</p><p>The first pass builds an alphabet of characters into a <code class="literal">set</code> and a second  will build the Trie. This slower build process allows for faster look-up times.</p><div class="example"><a id="less_ram_datrie_code"></a><div class="example-title">Example&nbsp;11-16.&nbsp;Using a double-array trie to store the data</div><div class="example-contents"><pre class="screen">import datrie
...
    chars = set()
    for word in text_example.readers:
        chars.update(word)
    trie = datrie.BaseTrie(chars)
...
    # having consumed our generator in the first chars pass we need to make a new one
    readers = text_example.read_words(text_example.SUMMARISED_FILE)  # new generator
    for word in readers:
        trie[word] = 0</pre></div></div><p>Sadly on this example dataset the <code class="literal">datrie</code> threw a Segmentation Fault so I can’t show you timing information. I chose to include it because in other tests it tended to be slightly faster (but less RAM efficient) than the following HAT Trie. I have used it with success for DNA searching so if you have a static problem and it works, you can be confident that it’ll work well. If you have a problem with varying input text then this might not be a suitable choice.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_hat_trie">HAT Trie</h3></div></div></div><p>The HAT Trie <sup>[<a id="id826522" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826522" class="footnote">123</a>]</sup> (licensed MIT) uses a
cache-friendly representation to achieve very fast look-ups on modern CPUs. It can be modified
after construction but otherwise has a very limited API.</p><p>For simple use cases it has great performance, the API limitations (e.g. lack of prefix look-ups) might
make it less useful for your application.</p><div class="example"><a id="less_ram_hatrie_code"></a><div class="example-title">Example&nbsp;11-17.&nbsp;Using a Hat trie to store the data</div><div class="example-contents"><pre class="screen">import hat_trie
...
    words_trie = hat_trie.Trie()
    for word in text_example.readers:
        words_trie[word] = 0</pre></div></div><p>As you can see in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_hatrie_example">Example&nbsp;11-18</a> the HAT Trie offers the fastest lookup times of our new data structures along with superb RAM usage. The limitations in its API mean that its use is limited, but if you just need fast look-up in a large number of string then this might be your solution.</p><div class="example"><a id="less_ram_hatrie_example"></a><div class="example-title">Example&nbsp;11-18.&nbsp;Running the HAT Trie example</div><div class="example-contents"><pre class="screen">$ python text_example_hattrie.py
RAM at start 9.7MiB
RAM after creating trie 254.2MiB, took 44.7s
The trie contains 8545076 words
Summed time to lookup word 0.0051s</pre></div></div><p>The Trie and DAWG data structures offer good benefits but you must still benchmark them on your problem rather than blindly adopting them. If you have overlapping sequences in your strings then it is likely that you’ll see a RAM improvement.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_using_tries_in_production_systems">Using Tries in production systems</h3></div></div></div><p>Tries and DAWGs are less well known but can provide strong benefits in production systems. We have an impressive success story in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-alex">Large Scale Social Media Analysis at Sme.sh</a>. Jamie Matthews at DapApps (a Python software house based in the UK) also has a story, they use them in client systems to enable more efficient and cheaper deployments for their customers:</p><div class="blockquote"><blockquote class="blockquote"><p>At DabApps, we often try to tackle complex technical architecture problems by dividing them up into small, self-contained components, usually communicating over the network using HTTP. This approach (referred to as a “service-oriented” or “microservice” architecture) has all sorts of benefits, including the possibility of reusing or sharing the functionality of a single component between multiple projects.</p><p>One such task that is often a requirement in our consumer-facing client projects is postcode geocoding. This is the task of converting a full UK postcode (for example: “BN1 1AG”) into a latitude and longitude co-ordinate pair, to enable the application to perform geospatial calculations such as distance measurement.</p><p>At its most basic, a geocoding database is a simple mapping between strings, and can conceptually be represented as a dictionary. The dictionary keys are the postcodes, stored in a normalised form (“BN11AG”), and the values are some representation of the co-ordinates (we used a geohash encoding, but for simplicity imagine a comma-separated pair such as: “50.822921,-0.142871”).</p><p>There are approximately 1.7 million postcodes in the UK. Naïvely loading the full dataset into a Python dictionary, as described above, uses several hundred megabytes of memory. Persisting this data structure to disk using Python’s native pickle format requires an unacceptably large amount of storage space. We knew we could do better.</p><p>We experimented with several different in-memory and on-disk storage and serialisation formats, including storing the data externally in databases such as Redis and LevelDB, and compressing the key/values pairs. Eventually, we hit on the idea of using a trie. Tries are extremely efficient at representing large numbers of strings in memory, and the available open-source libraries (we chose “marisa-trie”) make them very simple to use.</p><p>The resulting application, including a tiny web API built with the Flask framework, uses only 30MB of memory to represent the entire UK postcode database, and can comfortably handle a high volume of postcode lookup requests. The code is simple, the service is very lightweight and painless to deploy and run on a free hosting platform such as Heroku, with no external requirements or dependencies on databases. Our implementation is open-source, available at <a class="ulink" href="https://github.com/j4mie/postcodeserver/" target="_top">https://github.com/j4mie/postcodeserver/</a>.</p><div class="attribution"><p>—<span class="attribution">
Jamie Matthews
<em class="citetitle">Technical Director of DabApps.com (UK)</em>
</span></p></div></blockquote></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_tips_for_using_less_ram">Tips for using less RAM</h2></div></div></div><p>Generally if you can avoid putting it into RAM, avoid doing so. Everything you load costs you RAM. You might be able to load just a part of your data (e.g. using a memory mapped file <sup>[<a id="id826713" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826713" class="footnote">124</a>]</sup>), alternatively you might be able to use generators to load only the part of the data that you need for partial computations rather than loading it all at once.</p><p>If you are working with numeric data then you’ll almost certainly want to switch to using <code class="literal">numpy</code> arrays - the package offers many fast algorithms that work directly on the underlying primitive objects. The RAM savings compared to using lists of numbers can be huge, the time savings can be similarly amazing.</p><p>You’ll have noticed in this book that we generally use <code class="literal">xrange</code> rather than <code class="literal">range</code> simply because (in Python 2.x) <code class="literal">xrange</code> is a generator whilst <code class="literal">range</code> builds an entire list. Building a list of 100,000,000 integers just to iterate the right number of times is excessive - the RAM cost is large and entirely unnecessary. Python 3.x turns <code class="literal">range</code> into a generator so you no longer need to make this change.</p><p>If you’re working with strings and you’re in Python 2.x then try to stick to <code class="literal">str</code> rather than <code class="literal">unicode</code> if you want to save RAM. You will probably be better served by simply upgrading to Python 3.3+ if you need lots of unicode objects throughout your program. If you’re storing a large number of Unicode objects in a static structure then you probably want to investigate the DAWG and Trie structures that we’ve just discussed.</p><p>If you’re working with lots of bit strings then investigate <code class="literal">numpy</code> and the <code class="literal">bitarray</code> <sup>[<a id="id826754" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826754" class="footnote">125</a>]</sup> package, they both have efficient representations of bits packed into bytes. You might also benefit from looking at Redis, it has efficient storage of bit patterns.</p><p>Be aware that the PyPy project is experimenting with more efficient representations of homogenous data structures so long lists of the same primitive type (e.g. integers) might cost much less than the equivalent structure in CPython. The micropython <sup>[<a id="id826795" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826795" class="footnote">126</a>]</sup> project will be interesting to anyone working with embedded systems, it is a tiny-memory-footprint implementation of Python that’s aiming for Python 3 compatibility.</p><p>It goes (almost!) without saying that you know you have to benchmark when you’re trying to optimize on RAM usage and that it pays handsomly to have a unit-test suite in place before you make algorithmic changes.</p><p>Having reviewed ways of compressing strings and storing numbers efficiently we’ll now look at trading accuracy for storage space.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="less_ram_prob_ds">Probabilistic data structures</h2></div></div></div><p>Probabilistic data structures allow you to make trade-offs in accuracy for immense
decreases in memory usage.  In addition, the number of operations you can do on
them is much more restricted than a <code class="literal">set</code> or a <code class="literal">trie</code>.  For example, with a
single HyperLogLog++ structure using 2.56kB can count the number of unique items
up to approximately 7,900,000,000 items with 1.625% error.</p><p>This means that if we are trying
to count the number of unique license plate numbers for cars, if our
HyperLogLog++ counter said there were 654,192,028 the we would be confident that
the actual number lies between 664,822,648 and 643,561,407.  Furthermore, if
this accuracy is not sufficient, you can simply add more memory to the structure
and it will perform better.  Giving it 40.96kB of resources will decrease the
error from 1.625% to 0.4%.  However, storing this in a <code class="literal">set</code> would take 3.925GB
assuming no overhead!</p><p>On the other hand, the HyperLogLog++ structure would only be able to count a <code class="literal">set</code>
of licence plates and merge with another <code class="literal">set</code>.  So, for example, we could have
one structure for every state, find how many unique license plates are in those
states, then merge them all to get a count for the whole country.  If we were
given a license plate we couldn’t tell you if we’ve seen it before with very
good accuracy and we couldn’t give you a sample of license plates we have already
seen.</p><p>Probabilistic data structures are fantastic when you have spent the time to
understand the problem and then need to put something into production that can
answer a very small set of questions over a very large set of data.  Each
different structure has different questions it can answer at different accuracies
so finding the right one is just a matter of understanding your requirements.</p><p>In almost all cases, probabilistic data structures work by finding an alternative
representation for the data that is more compact and contains the relevant
information for answering a certain set of questions.  This can be thought of as
a type of lossy compression where we may lose some aspects of the data but we
retain the necessary components.  Since we are allowing the loss of data that
isn’t necessarily relevant for the particular set of questions we care about,
this sort of lossy compression can be much more efficient than the lossless
compression we looked at before with tries.  It is because of this that the
choice of which probabilistic data structure you will use is quite important—you want to pick one that retains the right information for your use case!</p><p>Before we dive in, it should be made clear that all the “error rates” here are
defined in terms of standard deviations.  This term comes from describing
Gaussian distributions and says how spread out the function is around a center
value.  When the standard deviation grows so do the values further away from the
center point.  Error from probabilistic data structres are framed this way
because all the anaysis around them are probabilistic.  So, for example, when we
say that the HyperLogLog algorithm has an error of
<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1101.png" alt="" width="85" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1101.png"></span> we mean that 66% of the time the error
will be smaller than err, 95% of the time it will be below 2*err and 99.7% of
the time it will be below 3*err <sup>[<a id="id826919" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826919" class="footnote">127</a>]</sup>.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_very_approximate_counting_with_a_1_byte_morris_counter">Very approximate counting with a 1 byte Morris Counter</h3></div></div></div><p>We’ll introduce the topic of probabilistic counting with one of the earliest
probabilistic counters, the Morris Counter (by Robert Morris of the NSA and Bell
Labs). Applications include counting millions of objects in a restricted RAM
environment (e.g. on an embedded computer), understanding large data streams and
problems in AI like image and speech recognition.</p><p>The Morris Counter keeps track of an exponent and models the counted state as
<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1102.png" alt="" width="83" height="23" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1102.png"></span> (rather than a correct count) - it provides an
<span class="emphasis"><em>order of magnitude</em></span> estimate. This estimate is updated using a probabilistic
rule.</p><p>We start with the exponent set to 0, if we ask for the <span class="emphasis"><em>value</em></span> of the Counter
we’ll be given <code class="literal">pow(2,exponent)=1</code> (the keen reader will note that this is
off-by-one - we did say this was an <span class="emphasis"><em>approximate</em></span> counter!). If we ask the
Counter to increment itself it will generate a random number (using the uniform
distribution) and it will test if <code class="literal">random(0, 1) &lt;= 1/pow(2,exponent)</code> which will
always be true (<code class="literal">pow(2,0) == 1</code>). The Counter increments and the exponent is set
to 1.</p><p>The second time we ask the Counter to increment itself it will test if
<code class="literal">random(0, 1) &lt;= 1/pow(2,1)</code>, this will be true 50% of the time. If the test
passes then the exponent is incremented. If False then the exponent is not
incremented for this increment request.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#table_morris_counter">Table&nbsp;11-1</a> shows the likelihoods of an increment occurring for each
of the first exponents.</p><div class="table"><a id="table_morris_counter"></a><div class="table-title">Table&nbsp;11-1.&nbsp;Morris Counter Details</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">exponent</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">pow(2,exponent)  </td><td style="border-bottom: 0.5pt solid ; ">P(increment)</td></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1</p></td><td style="border-bottom: 0.5pt solid ; "><p>1</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2</p></td><td style="border-bottom: 0.5pt solid ; "><p>0.5</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4</p></td><td style="border-bottom: 0.5pt solid ; "><p>0.25</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>8</p></td><td style="border-bottom: 0.5pt solid ; "><p>0.125</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>16</p></td><td style="border-bottom: 0.5pt solid ; "><p>0.0625</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>…</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>…</p></td><td style="border-bottom: 0.5pt solid ; "><p>…</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p>254</p></td><td style="border-right: 0.5pt solid ; "><p>2.894802e+76</p></td><td><p>3.454467e-77</p></td></tr></tbody></table></div></div><p>The maximum we could approximately count where we use a single unsigned byte for
the exponent is <code class="literal">math.pow(2,255) == 5e76</code>. The error relative to the actual
count will be fairly large as the counts increase, but the RAM saving is
tremendous as we only use 1 byte rather than the 32 unsigned bytes we’d
otherwise have to use.</p><div class="example"><a id="memory_morris_example_code"></a><div class="example-title">Example&nbsp;11-19.&nbsp;Simple Morris Counter Implemintation</div><div class="example-contents"><pre class="screen">from random import random

class MorrisCounter(object):
    counter = 0
    def add(self, *args):
        if random() &lt; 1.0 / (2 ** self.counter):
            self.counter += 1

    def __len__(self):
        return 2**self.counter</pre></div></div><p>In addition to the example implemintation in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_morris_example_code">Example&nbsp;11-19</a>, . In
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#morris_counter_example">Example&nbsp;11-20</a> we can see that the first request to increment the
Counter succeeds and the second fails.</p><p>Using the example implemintaiton in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_morris_example_code">Example&nbsp;11-19</a>, we can see
that the first request to increment the Counter succeeds and the second fails.
<sup>[<a id="id827216" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id827216" class="footnote">128</a>]</sup></p><div class="example"><a id="morris_counter_example"></a><div class="example-title">Example&nbsp;11-20.&nbsp;Morris Counter library example</div><div class="example-contents"><pre class="screen">In [2]: mc = MorrisCounter()
In [3]: print len(mc)
1.0
In [4]: mc.add()  # P(1) of doing an add
In [5]: print len(mc)
2.0
In [6]: mc.add()  # P(0.5) of doing an add
In [7]: print len(mc)  # the add does not occur on this attempt
2.0</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-morris-counter">Figure&nbsp;11-3</a> the thick black line shows a normal integer
incrementing on each iteration, on my 64 bit laptop this is an 8 byte integer.
The evolution of three 1 byte Morris Counters are shown as dotted lines, the y
axis shows their value which approximately represents the true count for each
iteration. Three Counters are shown to give you an idea about their different
trajectories and the overall trend, the three Counters are entirely independent
of each other.</p><div class="figure"><a id="FIG-morris-counter"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/12_show_morris_counter.png" alt="Three 1-byte Morris Counters" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/12_show_morris_counter.png"></div></div><div class="figure-title">Figure&nbsp;11-3.&nbsp;Three 1-byte Morris Counters vs an 8 byte Integer.</div></div><p>This diagram gives you some idea about the error to expect when using a Morris
Counter. Further details about the error behavior are available
<sup>[<a id="id827315" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id827315" class="footnote">129</a>]</sup>
online.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_k_min_values">K-Min Values</h3></div></div></div><p>In the Morris Counter, we loose any sort of information about the items we
insert.  That is to say, the counter’s internal state is the same whether we did
<code class="literal">.add("micha")</code> or <code class="literal">.add("ian")</code>.  This extra information is useful and, if use
properlly, could help us have our counters only counting unique items.  In this
way, calling <code class="literal">.add("micha")</code> thousands of times would only increase the counter
once.</p><p>In order to do this, we will exploit properties of hashing functions (see
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#SEC-dict-set-hash-and-entropy">Hash functions and Entropy</a> for a more in depth discussion of hash
functions).  The main property we would like to take advantage of is the fact
that the hash function takes input and <span class="emphasis"><em>uniformly</em></span> distributes it.  For example,
let’s assume I have a hash function that takes in a string and outputs number
between 0 and 1.  For that function to be uniform means that when i feed it in a
string I am equally likely to get a value of 0.5 as I am to get a value of 0.2
or any other value.  This also means that if I feed it in many string values, I
would expect the values to be relatively evenly spaced.  Remember, this is a
probabilistic argument: they won’t always be evenly spaced, but in the limit
that I have many strings and try this experiment many times, it will tend to be
evenly spaced.</p><p>Let’s say I took 100 items and stored the hash of them (the number from 0-1).
Knowing the spacing is even means that instead of saying “I have 100 items”, I
could similarly say “I have a distance of 0.01 between every item”.  This is
where the K-Min Values algorithm <sup>[<a id="id827328" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id827328" epub:type="noteref" class="footnote">130</a>]</sup>
finally comes in—if we keep the <code class="literal">k</code> smallest, unique, hash values we have
seen, we can approximate the overall spacing between hash values and infer what
the total number of items is.  In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-kmv-hash-density">Figure&nbsp;11-4</a> we can see the state
of a K-Min Values structure (also called a KMV) as more and more items are
added.  At first, since we don’t have many hash values, the largest hash we have
kept is quite large.  As we add more and more, the largest of the <code class="literal">k</code> hash
values we have kept gets smaller and smaller.  Using this method, we can
get error rates of <span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1103.png" alt="" width="94" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1103.png"></span>.</p><div class="figure"><a id="FIG-kmv-hash-density"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/kmv.png" alt="Density of hash space for K-Min Value structures" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/kmv.png"></div></div><div class="figure-title">Figure&nbsp;11-4.&nbsp;The values stores in a K-Min Value structure as more elements are added</div></div><p>The larger <code class="literal">k</code> is, the more we can account for the hashing function we are using
not being completely uniform for our particular input and for unfortunate hash
values.  An example of unfortunate hash values would be hashing  “A”,"B”,"C” and
getting the values 0.01, 0.02, 0.03.  If we start hashing more and more values,
it is less and less probable that they will clump up.</p><p>Furthermore, since we are only keeping the smallest <span class="emphasis"><em>unique</em></span> hash values the data
structure only considers unique inputs.  We can see this easily because if we
are in a state where we only store the smallest 3 hashes and currently have
<code class="literal">[0.1, 0.2, 0.3]</code> are the smallest hash values, if we keep adding in something
with the hash value of <code class="literal">0.4</code> our state will not change.  Similarly, if we keep
adding <code class="literal">0.3</code> our state will also not change.  This is a property called
idempotents and means that if we do the same operation, with the same inputs, on
this structure multiple times the state will not be changed.  This is in
contrast to, for example, an append on a list which will always change it’s
value.  This concept of idempotents carries on to all of the data structures in
this section except for the Morris Counter.</p><div class="example"><a id="memory_simple_kmv"></a><div class="example-title">Example&nbsp;11-21.&nbsp;Simple K-Min Values Implementation</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">mmh3</code>
<code class="kn">from</code> <code class="nn">blist</code> <code class="kn">import</code> <code class="n">sortedset</code>

<code class="k">class</code> <code class="nc">KMinValues</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">num_hashes</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code> <code class="o">=</code> <code class="n">num_hashes</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">sortedset</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">item</code><code class="p">):</code>
        <code class="n">item_hash</code> <code class="o">=</code> <code class="n">mmh3</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="n">item</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">item_hash</code><code class="p">)</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">pop</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">2</code><code class="p">:</code>
            <code class="k">return</code> <code class="mi">0</code>
        <code class="k">return</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="p">(</code><code class="mi">2</code><code class="o">**</code><code class="mi">32</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="o">-</code><code class="mi">2</code><code class="p">]</code> <code class="o">+</code> <code class="mi">2</code><code class="o">**</code><code class="mi">31</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code></pre></div></div><p>Using the KMin Values implementation in the python package CountMeMaybe
<sup>[<a id="id828118" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828118" class="footnote">131</a>]</sup> we can begin to see the
utility of this data structure.  This implemintation is very similar to the one
above in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_simple_kmv">Example&nbsp;11-21</a>, however it fully implements the other set
operations such as union and intersection.  Also note that “size” and
“cardinality” are used interchangeably (the word “cardinality” is from set
theory and is used more in the analysis of probabilistic data structures).</p><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="kn">from</code> <code class="nn">countmemaybe</code> <code class="kn">import</code> <code class="n">KMinValues</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">kmv1</code> <code class="o">=</code> <code class="n">KMinValues</code><code class="p">(</code><code class="n">k</code><code class="o">=</code><code class="mi">1024</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">kmv2</code> <code class="o">=</code> <code class="n">KMinValues</code><code class="p">(</code><code class="n">k</code><code class="o">=</code><code class="mi">1024</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">50000</code><code class="p">):</code> <code class="c"># </code><a id="CO24-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">kmv1</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">...</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">25000</code><code class="p">,</code> <code class="mi">75000</code><code class="p">):</code> <code class="c"># </code><a id="CO24-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">kmv2</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">...</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">print</code> <code class="nb">len</code><code class="p">(</code><code class="n">kmv1</code><code class="p">)</code>
<code class="mi">50416</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">print</code> <code class="nb">len</code><code class="p">(</code><code class="n">kmv2</code><code class="p">)</code>
<code class="mi">52439</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">print</code> <code class="n">kmv1</code><code class="o">.</code><code class="n">cardinality_intersection</code><code class="p">(</code><code class="n">kmv2</code><code class="p">)</code>
<code class="mf">25900.2862992</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">print</code> <code class="n">kmv1</code><code class="o">.</code><code class="n">cardinality_union</code><code class="p">(</code><code class="n">kmv2</code><code class="p">)</code>
<code class="mf">75346.2874158</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO24-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
We put 50,000 elements into <code class="literal">kmv1</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO24-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
<code class="literal">kmv2</code> also gets 50,000 elements, 25,000 of which are the same as <code class="literal">kmv1</code>
</p></dd></dl></div><div class="note"><h3 class="title">Note</h3><p>With these sorts of algorithms, the choice of hash function can have a drastic
effect on the quality of the estimates.  We’ve chosen <code class="literal">mmh3</code>, a python
implementation of mumurhash3 which has nice properties for hashing strings.
However, different hash functions could be used if they are more convenient for
your particular dataset.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_bloom_filter">Bloom Filter</h3></div></div></div><p>Sometimes we need to be able to do other types of set operations and for this we
need to introduce new types of probabilistic data structures.  Bloom filters
<sup>[<a id="id828152" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828152" epub:type="noteref" class="footnote">132</a>]</sup> were
created to ask the question of whether we’ve seen an item before.</p><p>Bloom filters work by having multiple hash values in order to represent a value
as multiple integers.  If we later see something with the same set of integers,
we can be reasonably confident that it is the same value.</p><p>In order to do this in a way which efficiently utilizes available resources, we
implicitly encode the integers as the indexes of a list.  This could be thought
of as a list of <code class="literal">bool</code> values that are initially set to <code class="literal">False</code>. If we are asked
to add an object with hash values <code class="literal">[10, 4, 7]</code>, then we set the 10th, 4th and
7th indexes of the list to <code class="literal">True</code>.  In the future, if we are asked if we have
seen a particular item before, we simply find it’s hash values and check if all
the corresponding spots in the bool list are set to <code class="literal">True</code>.</p><p>This method gives us no false negatives and a controllable rate of false
positives.  What this means is that if the bloom filter says we have not seen an
item before then we can be 100% sure that we haven’t seen the item before.  On
the other-hand, if the bloom filter states we <span class="emphasis"><em>have</em></span> seen an item before, then
there is a probability that we actually have not and we are simply seeing an
erroneous result.  This erroneous result comes from the fact that we will have
hash collisions and sometimes the hash values for two objects will be the same
even if the objects themselves are not the same.  However, in practice bloom
filters are set to have error rates below 0.5% so this error can be acceptable.</p><div class="note"><h3 class="title">Note</h3><p>We can simulate having as many hash functions we want simply by having 2 hash
functions that are independent of each-other.  This method is called “double
hashing”. If  we have a hash function that gives us 2 independent hashes, we can
do:</p><pre class="screen">def multi_hash(key, num_hashes):
    hash1, hash2 = hashfunction(key)
    for i in xrange(num_hashes):
        yield (hash1 + i * hash2) % (2^32 - 1)</pre><p>The modulo insures that the resulting hash values are 32 bit (we would modulo by
<code class="literal">2^64 - 1</code> for 64bit hash functions).</p></div><p>The exact length of the <code class="literal">bool</code> list and the number of hash values per item we
need will be fixed based on the capacity and the error rate we require.  With
some reasonably simple statistical arguments <sup>[<a id="id828747" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828747" class="footnote">133</a>]</sup> we see
that the ideal values are,</p><div class="informalequation"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/eq_1104.png" alt="Bloom Filter" width="1634" height="140" data-mfp-src="/library/view/high-performance-python/9781449361747/eq_1104.png"></div></div><p>That is to say, if we wish to store 50,000 objects (no matter how big the
objects themselves are) at a false positive rate of 0.05% (that is to say, 0.05%
of the times we say we have seen an object before, we actually have not), it
would require 791,015 bits of storage and 11 hash functions.</p><p>In order to further improve our efficiency with memory, we can use single bits
to represent the <code class="literal">bool</code> value (since a native <code class="literal">bool</code> actually takes 4 bits).  We
can do this easily by using the <code class="literal">bitarray</code> module.</p><div class="example"><a id="id828840"></a><div class="example-title">Example&nbsp;11-22.&nbsp;Simple Bloom Filter Implemintation</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">bitarray</code>
<code class="kn">import</code> <code class="nn">math</code>
<code class="kn">import</code> <code class="nn">mmh3</code>

<code class="k">class</code> <code class="nc">BloomFilter</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">capacity</code><code class="p">,</code> <code class="n">error</code><code class="o">=</code><code class="mf">0.005</code><code class="p">):</code>
        <code class="sd">"""</code>
<code class="sd">        Initialize a bloom filter with given capacity and false positive rate</code>
<code class="sd">        """</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">capacity</code> <code class="o">=</code> <code class="n">capacity</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">error</code> <code class="o">=</code> <code class="n">error</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="o">-</code><code class="n">capacity</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">error</code><code class="p">)</code> <code class="o">/</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code class="o">**</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="mi">1</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="n">capacity</code><code class="p">))</code> <code class="o">+</code> <code class="mi">1</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">bitarray</code><code class="o">.</code><code class="n">bitarray</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">_indexes</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="n">h1</code><code class="p">,</code> <code class="n">h2</code> <code class="o">=</code> <code class="n">mmh3</code><code class="o">.</code><code class="n">hash64</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>
        <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code><code class="p">):</code>
            <code class="k">yield</code> <code class="p">(</code><code class="n">h1</code> <code class="o">+</code> <code class="n">i</code> <code class="o">*</code> <code class="n">h2</code><code class="p">)</code> <code class="o">%</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code>

    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="k">for</code> <code class="n">index</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">_indexes</code><code class="p">(</code><code class="n">key</code><code class="p">):</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="o">=</code> <code class="bp">True</code>

    <code class="k">def</code> <code class="nf">__contains__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="k">return</code> <code class="nb">all</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="k">for</code> <code class="n">index</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">_indexes</code><code class="p">(</code><code class="n">key</code><code class="p">))</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">num_bits_on</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="bp">True</code><code class="p">)</code>
        <code class="k">return</code> <code class="o">-</code><code class="mf">1.0</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="mf">1.0</code> <code class="o">-</code> <code class="n">num_bits_on</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code><code class="p">))</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code><code class="p">)</code>

    <code class="nd">@staticmethod</code>
    <code class="k">def</code> <code class="nf">union</code><code class="p">(</code><code class="n">bloom_a</code><code class="p">,</code> <code class="n">bloom_b</code><code class="p">):</code>
        <code class="k">assert</code> <code class="n">bloom_a</code><code class="o">.</code><code class="n">capacity</code> <code class="o">==</code> <code class="n">bloom_b</code><code class="o">.</code><code class="n">capacity</code><code class="p">,</code> <code class="s">"Capacities must be equal"</code>
        <code class="k">assert</code> <code class="n">bloom_a</code><code class="o">.</code><code class="n">error</code> <code class="o">==</code> <code class="n">bloom_b</code><code class="o">.</code><code class="n">error</code><code class="p">,</code> <code class="s">"Error rates must be equal"</code>

        <code class="n">bloom_union</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="n">bloom_a</code><code class="o">.</code><code class="n">capacity</code><code class="p">,</code> <code class="n">bloom_a</code><code class="o">.</code><code class="n">error</code><code class="p">)</code>
        <code class="n">bloom_union</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">bloom_a</code><code class="o">.</code><code class="n">data</code> <code class="o">|</code> <code class="n">bloom_b</code><code class="o">.</code><code class="n">data</code>
        <code class="k">return</code> <code class="n">bloom_union</code></pre></div></div><p>What happens if we insert more items than we specified for the capacity of the
bloom filter?  At the extreme end, the <code class="literal">bool</code> list will be all set to <code class="literal">True</code> in
which case we say that we have seen every item.  This means that bloom filters
are very sensitive to what their initial capacity was set to, which can be quite
aggravating if we are dealing with a set of data whose size is unknown (for
example a stream of data).</p><p>One way of dealing with this is to use a variant of bloom filters called Scaling
Bloom Filters <sup>[<a id="id828930" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828930" epub:type="noteref" class="footnote">134</a>]</sup>.  They work by chaining together multiple bloom
filters whose error rate varies in a specific way <sup>[<a id="id828944" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828944" epub:type="noteref" class="footnote">135</a>]</sup>.  By doing
this, we can guarantee an overall error rate and simply add a new bloom filter
when we need more capacity.  In order to check if we’ve seen an item before, we
simply iterate over all of the sub-blooms until either we find the object or we
exhaust the list.  A sample implementation of this structure can be seen in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_scaling_bloom">Example&nbsp;11-23</a> where we use the previous bloom filter implementation
for the underlying functionality and have a counter to simplify knowing when to
    add a new bloom.</p><p>Another way of dealing with this is using a method called Timing Bloom Filters.
This variant allows elements to be expired out of the data structure, thus
freeing up space for more elements.  This is especially nice for dealing with
streams since we can have elements expire after, say, an hour and have the
capacity large enough to deal with the amount of data we see per hour.  Using a
bloom filter this way would give us a nice view into what has been happening in
the last hour.</p><div class="example"><a id="memory_scaling_bloom"></a><div class="example-title">Example&nbsp;11-23.&nbsp;Simple Scaling Bloom Filter Implementation</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">bloomfilter</code> <code class="kn">import</code> <code class="n">BloomFilter</code>

<code class="k">class</code> <code class="nc">ScalingBloomFilter</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">capacity</code><code class="p">,</code> <code class="n">error</code><code class="o">=</code><code class="mf">0.005</code><code class="p">,</code> <code class="n">max_fill</code><code class="o">=</code><code class="mf">0.8</code><code class="p">,</code> <code class="n">error_tightening_ratio</code><code class="o">=</code><code class="mf">0.5</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">capacity</code> <code class="o">=</code> <code class="n">capacity</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">base_error</code> <code class="o">=</code> <code class="n">error</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">max_fill</code> <code class="o">=</code> <code class="n">max_fill</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">capacity</code> <code class="o">*</code> <code class="n">max_fill</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">error_tightening_ratio</code> <code class="o">=</code> <code class="n">error_tightening_ratio</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code> <code class="o">=</code> <code class="p">[]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code> <code class="o">=</code> <code class="bp">None</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">_add_bloom</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">_add_bloom</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">new_error</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">base_error</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">error_tightening_ratio</code> <code class="o">**</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code><code class="p">)</code>
        <code class="n">new_bloom</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">capacity</code><code class="p">,</code> <code class="n">new_error</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">new_bloom</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code> <code class="o">=</code> <code class="n">new_bloom</code>
        <code class="k">return</code> <code class="n">new_bloom</code>

    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">key</code> <code class="ow">in</code> <code class="bp">self</code><code class="p">:</code>
            <code class="k">return</code> <code class="bp">True</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">-=</code> <code class="mi">1</code>
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
            <code class="n">bloom_size</code> <code class="o">=</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code><code class="p">)</code>
            <code class="n">bloom_max_capacity</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code><code class="o">.</code><code class="n">capacity</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">max_fill</code><code class="p">)</code>

            <code class="c"># We may have been adding many duplicate values into the bloom, so</code>
            <code class="c"># we need to check if we actually need to scale or if we still have</code>
            <code class="c"># space</code>
            <code class="k">if</code> <code class="n">bloom_size</code> <code class="o">&gt;=</code> <code class="n">bloom_max_capacity</code><code class="p">:</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">_add_bloom</code><code class="p">()</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">=</code> <code class="n">bloom_max_capacity</code>
            <code class="k">else</code><code class="p">:</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">bloom_max_capacity</code> <code class="o">-</code> <code class="n">bloom_size</code><code class="p">)</code>
        <code class="k">return</code> <code class="bp">False</code>

    <code class="k">def</code> <code class="nf">__contains__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="k">return</code> <code class="nb">any</code><code class="p">(</code><code class="n">key</code> <code class="ow">in</code> <code class="n">bloom</code> <code class="k">for</code> <code class="n">bloom</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">bloom</code><code class="p">)</code> <code class="k">for</code> <code class="n">bloom</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code><code class="p">)</code></pre></div></div><p>Using this data structure will feel much like using a <code class="literal">set</code> object.  Below we
will use the scaling bloom filter to add many objects, test if we’ve seen them
before, and then try to experimentally find the false positive rate,</p><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="n">bloom</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">50</code><code class="p">):</code>
   <code class="o">....</code><code class="p">:</code>     <code class="n">bloom</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">....</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"20"</code> <code class="ow">in</code> <code class="n">bloom</code>
<code class="bp">True</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"25"</code> <code class="ow">in</code> <code class="n">bloom</code>
<code class="bp">True</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"51"</code> <code class="ow">in</code> <code class="n">bloom</code>
<code class="bp">False</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">num_false_positives</code> <code class="o">=</code> <code class="mi">0</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">num_true_negatives</code> <code class="o">=</code> <code class="mi">0</code>

<code class="o">&gt;&gt;&gt;</code> <code class="c"># None of the following numbers should be in the bloom.</code>
<code class="o">&gt;&gt;&gt;</code> <code class="c"># If one is found in the bloom, it is a false positive.</code>
<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">51</code><code class="p">,</code><code class="mi">10000</code><code class="p">):</code>
   <code class="o">....</code><code class="p">:</code>     <code class="k">if</code> <code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="ow">in</code> <code class="n">bloom</code><code class="p">:</code>
   <code class="o">....</code><code class="p">:</code>         <code class="n">num_false_positives</code> <code class="o">+=</code> <code class="mi">1</code>
   <code class="o">....</code><code class="p">:</code>     <code class="k">else</code><code class="p">:</code>
   <code class="o">....</code><code class="p">:</code>         <code class="n">num_true_negatives</code> <code class="o">+=</code> <code class="mi">1</code>
   <code class="o">....</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">num_false_positives</code>
<code class="mi">54</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">num_true_negatives</code>
<code class="mi">9895</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">false_positive_rate</code> <code class="o">=</code> <code class="n">num_false_positives</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="mi">10000</code> <code class="o">-</code> <code class="mi">51</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">false_positive_rate</code>
<code class="mf">0.005427681173987335</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">bloom</code><code class="o">.</code><code class="n">error</code>
<code class="mf">0.005</code></pre><p>We can also do unions with bloom filters in order to join multiple sets of
items.  One caveat with this is that you can only take the union of two blooms
with the same capacity and error rate.  Furthermore, the final blooms used
capacity can be as high as the sum of the used capacity of the two blooms
unioned to make this.  What this means is you could start with two bloom filters
that are a little more than half full and when you union them together you will
get a new bloom that is over capacity and not reliable!</p><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="n">bloom_a</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">bloom_b</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">50</code><code class="p">):</code>
   <code class="o">...</code><code class="p">:</code>     <code class="n">bloom_a</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">...</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code><code class="mi">75</code><code class="p">):</code>
   <code class="o">...</code><code class="p">:</code>     <code class="n">bloom_b</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">...</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">bloom</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="o">.</code><code class="n">union</code><code class="p">(</code><code class="n">bloom_a</code><code class="p">,</code> <code class="n">bloom_b</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"51"</code> <code class="ow">in</code> <code class="n">bloom_a</code> <code class="c"># </code><a id="CO25-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
<code class="n">Out</code><code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="bp">False</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"24"</code> <code class="ow">in</code> <code class="n">bloom_b</code> <code class="c"># </code><a id="CO25-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
<code class="n">Out</code><code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="bp">False</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"55"</code> <code class="ow">in</code> <code class="n">bloom</code> <code class="c"># </code><a id="CO25-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">
<code class="n">Out</code><code class="p">[</code><code class="mi">11</code><code class="p">]:</code> <code class="bp">True</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"25"</code> <code class="ow">in</code> <code class="n">bloom</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="bp">True</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO25-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
The value of “51” is not in <code class="literal">bloom_a</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO25-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
Similarly, the value of “25” is not in <code class="literal">bloom_b</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO25-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
However, the <code class="literal">bloom</code> object contains all the objects that both <code class="literal">bloom_a</code> and <code class="literal">bloom_b</code> has!
</p></dd></dl></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_loglog_counter">LogLog Counter</h3></div></div></div><p>Loglog <sup>[<a id="id833007" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id833007" class="footnote">136</a>]</sup>
type counters are based on the realization that the individual bits of a hash
function are can also be considered to be random.  That is to say, the
probability of the first bit of a hash being <code class="literal">1</code> is 50%, the probability of the
first two bits being <code class="literal">01</code> is 25% and <code class="literal">001</code> is 12.5%.  Knowing these
probabilities and the hash we’ve seen so far with the most amount of <code class="literal">0</code> ’s at
the beginning (ie: the least probable hash value), we can come up with an
estimate of how many items we’ve seen so far.</p><p>A good analogy for this method is flipping coins.  Imagine we would like to flip
a coin 32 times and get heads every time.  The number 32 comes from the fact that
we are using 32bit hash functions.  If I flip the coin once and it comes
up with tails, then I will store the number <code class="literal">0</code> since my best attempt yielded 0
heads in a row.  Since I know the probabilities behind this coin-flip, I can also
tell you that my longest series was <code class="literal">0</code> long and you can estimate that I’ve
tried this experiment <code class="literal">2^0 = 1</code> time.  If I keep flipping my coin and I’m able
to get 10 heads before getting a tail, then I would store the number 10.  Using
the same logic, you can estimate that I’ve tried the experiment <code class="literal">2^10 = 1024</code>
times.  With this system, the highest we can count would be the maximum number
of flips we consider (for 32 flips, this is <code class="literal">2^32 = 4,294,967,296</code>).</p><p>In order to encode this logic with loglog type counters we take the binary
representation of the hash value of our input and see how many zeros there are
before we see our first 1.  The hash value can be thought of as a series of 32
coin flips where 0 means a flip for heads and 1 means a flip for tails (ie:
<code class="literal">000010101101</code> means we flipped 4 heads before our first tails and <code class="literal">010101101</code>
means we flipped 1 head before flipping our first tail).  This gives us an idea
how many tries happened before this hash value was gotten.  The mathematics
behind this system is almost equivalent to that of the Morris counter with one
major exception: the “random” values are aquired by looking at the actual input
instead of a random number generator.  This means that if I keep adding the same
value to a loglog counter it’s internal state will not change.</p><div class="example"><a id="id833082"></a><div class="example-title">Example&nbsp;11-24.&nbsp;Simple Implementation of LogLog Register</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">mmh3</code>

<code class="k">def</code> <code class="nf">trailing_zeros</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    Returns the index of the first bit set to 1 from the right side of a 32bit</code>
<code class="sd">    integer</code>
<code class="sd">    &gt;&gt;&gt; trailing_zeros(0)</code>
<code class="sd">    32</code>
<code class="sd">    &gt;&gt;&gt; trailing_zeros(0b1000)</code>
<code class="sd">    3</code>
<code class="sd">    &gt;&gt;&gt; trailing_zeros(0b10000000)</code>
<code class="sd">    7</code>
<code class="sd">    """</code>
    <code class="k">if</code> <code class="ow">not</code> <code class="n">number</code><code class="p">:</code>
        <code class="k">return</code> <code class="mi">32</code>
    <code class="n">index</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">while</code> <code class="p">(</code><code class="n">number</code> <code class="o">&gt;&gt;</code> <code class="n">index</code><code class="p">)</code> <code class="o">&amp;</code> <code class="mi">1</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
        <code class="n">index</code> <code class="o">+=</code> <code class="mi">1</code>
    <code class="k">return</code> <code class="n">index</code>

<code class="k">class</code> <code class="nc">LogLogRegister</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="n">counter</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">item</code><code class="p">):</code>
        <code class="n">item_hash</code> <code class="o">=</code> <code class="n">mmh3</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">item</code><code class="p">))</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">_add</code><code class="p">(</code><code class="n">item_hash</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">_add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">item_hash</code><code class="p">):</code>
        <code class="n">bit_index</code> <code class="o">=</code> <code class="n">trailing_zeros</code><code class="p">(</code><code class="n">item_hash</code><code class="p">)</code>
        <code class="k">if</code> <code class="n">bit_index</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">counter</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">counter</code> <code class="o">=</code> <code class="n">bit_index</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="mi">2</code><code class="o">**</code><code class="bp">self</code><code class="o">.</code><code class="n">counter</code></pre></div></div><p>The biggest drawback of this method is that we may get a hash value that
increases the counter right at the beginning and skew our estimates.  This would
be similar to flipping all 32 tails on the first try.  In order to remedy this,
we should have many people flipping coins at the same time and combine their
results.  The law of large numbers tells us that as we add more and more
flippers the total statistics become less effected by anomalous samples from
individual flipper.  The exact way that we combine the results is the root of
the difference between loglog type methods (classic loglog, superloglog,
hyperloglog, hyperloglog++, etc.).</p><p>This “multiple flipper” method can be accomplished by taking the first couple
bits of a hash value and using that to designate which of our flippers had that
particular result.  If we take the first 4 bits of the hash, this means we have
<code class="literal">2^4 = 16</code> flippers.  Since we used the first 4 bits for this selection, we only
have 28bits left (corresponding to 28 individual coin flips per coin flipper)
meaning each counter can only count up to <code class="literal">2^28 = 268,435,456</code>.  In addition,
there is a constant (alpha) which depends on the number of flippers there are
which normalizes the estimation. <sup>[<a id="id833712" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id833712" class="footnote">137</a>]</sup>  All of this together
gives us an algorithm with <span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1105.png" alt="" width="104" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1105.png"></span> accuracy where <code class="literal">m</code> is the
number of registers (or flippers) used.</p><div class="example"><a id="id833102"></a><div class="example-title">Example&nbsp;11-25.&nbsp;Simple Implementation of LogLog</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">llregister</code> <code class="kn">import</code> <code class="n">LLRegister</code>
<code class="kn">import</code> <code class="nn">mmh3</code>

<code class="k">class</code> <code class="nc">LL</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">p</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">p</code> <code class="o">=</code> <code class="n">p</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">=</code> <code class="mi">2</code><code class="o">**</code><code class="n">p</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">registers</code> <code class="o">=</code> <code class="p">[</code><code class="n">LLRegister</code><code class="p">()</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="nb">int</code><code class="p">(</code><code class="mi">2</code><code class="o">**</code><code class="n">p</code><code class="p">))]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">alpha</code> <code class="o">=</code> <code class="mf">0.7213</code> <code class="o">/</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">+</code> <code class="mf">1.079</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">item</code><code class="p">):</code>
        <code class="n">item_hash</code> <code class="o">=</code> <code class="n">mmh3</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">item</code><code class="p">))</code>
        <code class="n">register_index</code> <code class="o">=</code> <code class="n">item_hash</code> <code class="o">&amp;</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code>
        <code class="n">register_hash</code> <code class="o">=</code> <code class="n">item_hash</code> <code class="o">&gt;&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">p</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">registers</code><code class="p">[</code><code class="n">register_index</code><code class="p">]</code><code class="o">.</code><code class="n">_add</code><code class="p">(</code><code class="n">register_hash</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">register_sum</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="n">h</code><code class="o">.</code><code class="n">counter</code> <code class="k">for</code> <code class="n">h</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">registers</code><code class="p">)</code>
        <code class="k">return</code> <code class="mi">2</code> <code class="o">**</code> <code class="p">(</code><code class="nb">float</code><code class="p">(</code><code class="n">register_sum</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code><code class="p">)</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">alpha</code></pre></div></div><p>In addition to this algorithm de-duplicating similar items by using the hash
value as an indicator, it has a tunable parameter which can be used to dial what
sort of accuracy vs storage compromise you are willing to make.</p><p>We can see in the <code class="literal">__len__</code> method, we are averaging the estimates from all of
the individual LogLog registers.  This, however, is not the most efficient way
do combine the data!  This is because we may get some unfortunate hash values
that make one particular register spike up while the others are still at low
values.  Because of this, we are only able to and error rate of
<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1106.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1106.png"></span> where m is the number of registers used.</p><p>A fix to this problem was called SuperLogLog <sup>[<a id="id834589" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id834589" epub:type="noteref" class="footnote">138</a>]</sup>.  With this algorithm, only the lowest 70% of
the registers were used for the size estimate and their value was limited by a
maximum value given by a restriction rule.  This addition decreased the error
rate to <span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1107.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1107.png"></span>.  This is counter intuitive since
we got a better estimate by disregarding information!</p><p>Finally, HyperLogLog <sup>[<a id="id834592" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id834592" epub:type="noteref" class="footnote">139</a>]</sup> came out in 2007 and gave us further accuracy
gains.  This was done simply by changing the method of averaging the individual
registers: instead of simply averaging we use a spherical averaging scheme which
also has special considerations for different edge cases the structure could be
in.  This brings us to the current best error rate of
<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1108.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1108.png"></span>.  In addition, this formulation removes a
sorting operation which is necissary with SuperLogLog.  This can greatly speed
up the performance of the data structure when trying to insert items at a high
volume.</p><div class="example"><a id="id834638"></a><div class="example-title">Example&nbsp;11-26.&nbsp;Simple Implementation of HyperLogLog</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">ll</code> <code class="kn">import</code> <code class="n">LL</code>
<code class="kn">import</code> <code class="nn">math</code>

<code class="k">class</code> <code class="nc">HyperLogLog</code><code class="p">(</code><code class="n">LL</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">indicator</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="mi">2</code><code class="o">**-</code><code class="n">m</code><code class="o">.</code><code class="n">counter</code> <code class="k">for</code> <code class="n">m</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">registers</code><code class="p">)</code>
        <code class="n">E</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">alpha</code> <code class="o">*</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code><code class="o">**</code><code class="mi">2</code><code class="p">)</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="n">indicator</code><code class="p">)</code>

        <code class="k">if</code> <code class="n">E</code> <code class="o">&lt;=</code> <code class="mf">5.0</code> <code class="o">/</code> <code class="mf">2.0</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code><code class="p">:</code>
            <code class="n">V</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="mi">1</code> <code class="k">for</code> <code class="n">m</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">registers</code> <code class="k">if</code> <code class="n">m</code><code class="o">.</code><code class="n">counter</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code>
            <code class="k">if</code> <code class="n">V</code> <code class="o">!=</code> <code class="mi">0</code><code class="p">:</code>
                <code class="n">Estar</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">/</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">*</code> <code class="n">V</code><code class="p">),</code> <code class="mi">2</code><code class="p">)</code>
            <code class="k">else</code><code class="p">:</code>
                <code class="n">Estar</code> <code class="o">=</code> <code class="n">E</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">if</code> <code class="n">E</code> <code class="o">&lt;=</code> <code class="mi">2</code><code class="o">**</code><code class="mi">32</code> <code class="o">/</code> <code class="mf">30.0</code><code class="p">:</code>
                <code class="n">Estar</code> <code class="o">=</code> <code class="n">E</code>
            <code class="k">else</code><code class="p">:</code>
                <code class="n">Estar</code> <code class="o">=</code> <code class="o">-</code><code class="mi">2</code><code class="o">**</code><code class="mi">32</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="n">E</code> <code class="o">/</code> <code class="mi">2</code><code class="o">**</code><code class="mi">32</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">Estar</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="kn">import</code> <code class="nn">mmh3</code>
    <code class="n">hll</code> <code class="o">=</code> <code class="n">HyperLogLog</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">100000</code><code class="p">):</code>
        <code class="n">hll</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">mmh3</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">)))</code>
    <code class="k">print</code> <code class="nb">len</code><code class="p">(</code><code class="n">hll</code><code class="p">)</code></pre></div></div><p>The only further increase in accuracy was given by the HyperLogLog++ algorithm
which increased accuracy of the data structure while it is relatively empty.
When more items are inserted, this scheme reverts to standard HyperLogLog.  This
is actually quite a useful thing to have since the statistics of the LogLog type
counters requires a lot of data to be accurate—having a scheme for allowing
better accuracy with less number of items greatly improves the usability of this
method.  This extra accuracy is achieved by having a smaller but more accurate
HyperLogLog structure that can be later converted into the larger structure that
was originally requested.  Also, there are some imperially derived constants
that are used in the size estimates which remove biases.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_real_world_example">Real World Example</h3></div></div></div><p>For a better understanding of the data structures, we first created a dataset
with many unique keys and then one that has duplicate entries.
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-prob-ds-comparison">Example&nbsp;11-27</a> shows the results when we feed these keys into the
data structures above and periodically query “How many unique entries have there
been?”.  We can see that the data structures that contain more stateful variables
(such as HyperLogLog and KMin Values) do better since they more robustly handle
bad statistics.  On the other hand, the Morris Counter and the single LogLog
register can quickly have very high error if one unfortunate random number or
hash value occurs.  For most of the algorithms, however, we know that the number
of stateful variables is directly correlated with the error guarantees, so this
makes sense.</p><div class="example"><a id="FIG-prob-ds-comparison"></a><div class="example-title">Example&nbsp;11-27.&nbsp;Comparison between various probabilistic data structures for unique (above) and repeating data (below)</div><div class="example-contents"><div class="informalfigure"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/prod_ds_unique.png" alt="PDS with unique data" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/prod_ds_unique.png"></div></div><div class="informalfigure"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/prod_ds_dup.png" alt="PDS with repeating data" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/prod_ds_dup.png"></div></div></div></div><p>Looking just at the probabilistic data structures that have the best performance
(and really the ones you will probably use), we can summarize their utility and
their approximate memory usage (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_pd_comparison">Example&nbsp;11-28</a>).  We can see a
huge change in memory usage depending on the questions we care to ask.  This
simply highlights the fact that when using a probabilistic data structure, you
must first consider what questions you really need to answer about the dataset
before proceeding.  Also note that only the Bloom Filter’s size depends on the
number of elements.  The HyperLogLog and KMin Values’s size is <span class="emphasis"><em>only</em></span> dependant
on the error rate.</p><div class="example"><a id="memory_pd_comparison"></a><div class="example-title">Example&nbsp;11-28.&nbsp;Comparison of major probabilistic data structures</div><div class="example-contents"><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">              </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Size </td><td style="border-bottom: 0.5pt solid ; "> Union <sup>[<a id="id835832" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id835832" class="footnote totri-footnote">a</a>]</sup> </td></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Intersection</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Contains</p></td><td style="border-bottom: 0.5pt solid ; "><p>Size <sup>[<a id="id835859" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id835859" class="footnote totri-footnote">b</a>]</sup></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HyperLogLog</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Yes (<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1109.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1109.png"></span>)</p></td><td style="border-bottom: 0.5pt solid ; "><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>No <sup>[<a id="memory_caveat" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.memory_caveat" class="footnote totri-footnote">c</a>]</sup></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>No</p></td><td style="border-bottom: 0.5pt solid ; "><p>2.704 MB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>KMinValues</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Yes (<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1110.png" alt="" width="98" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1110.png"></span>)</p></td><td style="border-bottom: 0.5pt solid ; "><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Yes</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>No</p></td><td style="border-bottom: 0.5pt solid ; "><p>20.372 MB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Bloom Filter</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Yes (<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1111.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1111.png"></span>)</p></td><td style="border-bottom: 0.5pt solid ; "><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p>No <sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.memory_caveat" class="footnoteref totri-footnote">c</a>]</sup></p></td><td style="border-right: 0.5pt solid ; "><p>Yes</p></td><td><p>197.8 MB</p></td></tr></tbody><tbody class="footnotes"><tr><td colspan="3"><div class="footnote" id="ftn.id835832"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id835832" class="simpara totri-footnote">a</a>] </sup>Union operations occur without a penalty
to error</p></div><div class="footnote" id="ftn.id835859"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id835859" class="simpara totri-footnote">b</a>] </sup>Size of data structure with 0.05% error rate, 100,000,000 unique elements and using a 64 bit hashing function</p></div><div class="footnote" id="ftn.memory_caveat"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_caveat" class="simpara totri-footnote">c</a>] </sup>These operations <span class="emphasis"><em>can</em></span> be done however at a considerable penalty in accuracy</p></div></td></tr></tbody></table></div></div></div><p>As another, more realistic test, we chose to use a dataset derived from the text
of wikipedia.  We ran a very simple script in order to extract all single word
tokens with 5 or more characters from all articles and store them in a newline
separated file.  The question then was, “How many unique tokens are there?” and
the results can be seen in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_pd_wiki_comparison">Example&nbsp;11-29</a>.  In addition, we attempted
to answer the same question using the datrie from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_datrie">datrie</a> (this trie
was chosen as opposed to the others because it offers good compression while
still being robust enough to deal with the entire dataset).</p><div class="example"><a id="memory_pd_wiki_comparison"></a><div class="example-title">Example&nbsp;11-29.&nbsp;Size estimates for the number of unique words in wikipedia</div><div class="example-contents"><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">                  </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Elements   </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Relative Error </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Processing Time <sup>[<a id="id836122" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836122" class="footnote totri-footnote">a</a>]</sup> </td><td style="border-bottom: 0.5pt solid ; "> Structure Size <sup>[<a id="id836131" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836131" class="footnote totri-footnote">b</a>]</sup>
 </td></tr></thead><tfoot><tr><td style="border-right: 0.5pt solid ; "><p>True Value</p></td><td style="border-right: 0.5pt solid ; "><p>4,956,262</p></td><td style="border-right: 0.5pt solid ; "><p>0.00%</p></td><td style="border-right: 0.5pt solid ; "><p>-----</p></td><td><p>49,558 KB <sup>[<a id="id836172" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836172" class="footnote totri-footnote">c</a>]</sup></p></td></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Morris Counter <sup>[<a id="id836189" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836189" class="footnote totri-footnote">d</a>]</sup></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1,073,741,824</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>6.52%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>751s</p></td><td style="border-bottom: 0.5pt solid ; "><p>5 bits</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Log Log Register</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1,048,576</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>78.84%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1690 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>5 bits</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>LogLog</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,522,232</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>8.76%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2112 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>5 bits</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HyperLogLog</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,983,171</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>-0.54%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2907 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>40 KB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>KMinValues</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,912,818</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.88%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>3503 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>256 KB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>ScalingBloom</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,949,358</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.14%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>10392 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>11,509 KB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Datrie</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,505,514 <sup>[<a id="id836363" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836363" class="footnote totri-footnote">e</a>]</sup></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.00%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>14620 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>114,068 KB</p></td></tr></tbody><tbody class="footnotes"><tr><td colspan="5"><div class="footnote" id="ftn.id836122"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836122" class="simpara totri-footnote">a</a>] </sup>Processing time has been adjusted to remove the time to read the dataset from disk. We also use the simple implemintations provided above for testing</p></div><div class="footnote" id="ftn.id836131"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836131" class="simpara totri-footnote">b</a>] </sup>Structure size is theoretical given the amount of data since the implementations used were not optimized</p></div><div class="footnote" id="ftn.id836172"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836172" class="simpara totri-footnote">c</a>] </sup>The dataset is 49,558 KB only considering unique tokens with 8.742GB total tokens</p></div><div class="footnote" id="ftn.id836189"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836189" class="simpara totri-footnote">d</a>] </sup>Since the Morris counter doesn’t de-duplicate input the size and relative error are given with regards to the total number of values</p></div><div class="footnote" id="ftn.id836363"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836363" class="simpara totri-footnote">e</a>] </sup>Because of some encoding problems, Datrie could not load all the keys.</p></div></td></tr></tbody></table></div></div></div><p>The major take-away from this experiment is that if you are able to specialize
your code then you can get amazing speed and memory gains.  This has been true
throughout the entire book: when we specialized our code in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_selective_optimizations">Selective optimizations: finding what needs to be fixed</a> we were able to similarly get speed
increases.</p><p>Probabilistic data structures are an algorithmic way of specializing your code.
We store only the data we need in order to answer specific questions with given
error bounds.  By only having to deal with a subset of the information given,
not only can the memory footprint be much smaller but we can also perform most
operations over the structure faster (as can be seen with the insertion time
into the datrie in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_pd_wiki_comparison">Example&nbsp;11-29</a> being larger than any of the
probabilistic data structures).</p><p>As a result, whether or not you use probabilistic data structures, you should
always keep in mind what questions you are going to be asking of your data and
how you can most effectively store that data in order to ask those specialized
questions.  This may come down to using one particular type of list over
another, one particular type of database index over another, or maybe even using
a probabilistic data structure to throw out all but the relevant data!</p></div></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id825207"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id825207" class="simpara">113</a>] </sup><a class="ulink" href="http://code.activestate.com/recipes/546530/" target="_top">http://code.activestate.com/recipes/546530/</a></p></div><div class="footnote" id="ftn.id825696"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id825696" class="simpara">114</a>] </sup><a class="ulink" href="http://nedbatchelder.com/text/unipain.html" target="_top">http://nedbatchelder.com/text/unipain.html</a></p></div><div class="footnote" id="ftn.id825718"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id825718" class="simpara">115</a>] </sup><a class="ulink" href="http://www.python.org/dev/peps/pep-0393/" target="_top">http://www.python.org/dev/peps/pep-0393/</a></p></div><div class="footnote" id="ftn.id826005"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826005" class="simpara">116</a>] </sup><a class="ulink" href="https://docs.python.org/2/library/bisect.html#searching-sorted-lists" target="_top">https://docs.python.org/2/library/bisect.html#searching-sorted-lists</a></p></div><div class="footnote" id="ftn.id826195"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826195" class="simpara">117</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/File:Trie-vs-minimal-acyclic-fa.svg" target="_top">http://en.wikipedia.org/wiki/File:Trie-vs-minimal-acyclic-fa.svg</a></p></div><div class="footnote" id="ftn.id826211"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826211" class="simpara">118</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Deterministic_acyclic_finite_state_automaton" target="_top">http://en.wikipedia.org/wiki/Deterministic_acyclic_finite_state_automaton</a></p></div><div class="footnote" id="ftn.id826283"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826283" class="simpara">119</a>] </sup><a class="ulink" href="https://github.com/kmike/DAWG" target="_top">https://github.com/kmike/DAWG</a></p></div><div class="footnote" id="ftn.id826372"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826372" class="simpara">120</a>] </sup><a class="ulink" href="https://github.com/kmike/marisa-trie" target="_top">https://github.com/kmike/marisa-trie</a></p></div><div class="footnote" id="ftn.id826390"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826390" class="simpara">121</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Trie" target="_top">http://en.wikipedia.org/wiki/Trie</a></p></div><div class="footnote" id="ftn.id826451"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826451" class="simpara">122</a>] </sup><a class="ulink" href="https://github.com/kmike/datrie" target="_top">https://github.com/kmike/datrie</a></p></div><div class="footnote" id="ftn.id826522"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826522" class="simpara">123</a>] </sup><a class="ulink" href="https://github.com/kmike/hat-trie" target="_top">https://github.com/kmike/hat-trie</a></p></div><div class="footnote" id="ftn.id826713"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826713" class="simpara">124</a>] </sup><a class="ulink" href="https://docs.python.org/2/library/mmap.html" target="_top">https://docs.python.org/2/library/mmap.html</a></p></div><div class="footnote" id="ftn.id826754"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826754" class="simpara">125</a>] </sup><a class="ulink" href="https://pypi.python.org/pypi/bitarray/0.8.1" target="_top">https://pypi.python.org/pypi/bitarray/0.8.1</a></p></div><div class="footnote" id="ftn.id826795"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826795" class="simpara">126</a>] </sup><a class="ulink" href="http://micropython.org/" target="_top">http://micropython.org/</a></p></div><div class="footnote" id="ftn.id826919"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826919" class="simpara">127</a>] </sup>These numbers come from the 66-95-99
rule of Gaussian distributions.  More information can be found at
<a class="ulink" href="http://en.wikipedia.org/wiki/68%E2%80%9395%E2%80%9399.7_rule" target="_top">http://en.wikipedia.org/wiki/68%E2%80%9395%E2%80%9399.7_rule</a></p></div><div class="footnote" id="ftn.id827216"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id827216" class="simpara">128</a>] </sup>A more fully fleshed out implementation which uses an <code class="literal">array</code> of bytes
to make many counters is available at
<a class="ulink" href="https://github.com/ianozsvald/morris_counter" target="_top">https://github.com/ianozsvald/morris_counter</a></p></div><div class="footnote" id="ftn.id827315"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id827315" class="simpara">129</a>] </sup><a class="ulink" href="http://geomblog.blogspot.co.uk/2011/06/bob-morris-and-stream-algorithms.html" target="_top">http://geomblog.blogspot.co.uk/2011/06/bob-morris-and-stream-algorithms.html</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id827328"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id827328" class="simpara">130</a>] </sup>Beyer, K., Haas, P. J., Reinwald, B.,
Sismanis, Y., &amp; Gemulla, R. (2007). On synopses for distinct-value estimation
under multiset operations. Proceedings of the 2007 ACM SIGMOD International
Conference on Management of Data - SIGMOD ’07, 199. doi:10.1145/1247480.1247504</p></div><div class="footnote" id="ftn.id828118"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828118" class="simpara">131</a>] </sup><a class="ulink" href="https://github.com/mynameisfiber/countmemaybe" target="_top">https://github.com/mynameisfiber/countmemaybe</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id828152"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828152" class="simpara">132</a>] </sup>Bloom, B. H. (1970). Space/time trade-offs in hash coding with
allowable errors. Communications of the ACM. doi:10.1145/362686.362692</p></div><div class="footnote" id="ftn.id828747"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828747" class="simpara">133</a>] </sup>The wikipedia page on
bloom filters has a very simple proof for the properties of a bloom filter,
<a class="ulink" href="http://en.wikipedia.org/wiki/Bloom_filter#Probability_of_false_positives" target="_top">http://en.wikipedia.org/wiki/Bloom_filter#Probability_of_false_positives</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id828930"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828930" class="simpara">134</a>] </sup>Almeida, P. S., Baquero, C., Preguiça, N., &amp; Hutchison,
D. (2007). Scalable Bloom Filters. Information Processing Letters, 101, 255–261.
doi:10.1016/j.ipl.2006.10.007</p></div><div class="footnote" epub:type="footnote" id="ftn.id828944"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828944" class="simpara">135</a>] </sup>The error values
actually decrease like the geometric series.  This way, when you take the
product of all the error rates they approach the desired error rate</p></div><div class="footnote" id="ftn.id833007"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id833007" class="simpara">136</a>] </sup><a class="ulink" href="http://algo.inria.fr/flajolet/Publications/DuFl03-LNCS.pdf" target="_top">http://algo.inria.fr/flajolet/Publications/DuFl03-LNCS.pdf</a></p></div><div class="footnote" id="ftn.id833712"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id833712" class="simpara">137</a>] </sup>“A full description of the basic
LogLog and SuperLogLog algorithms can be found at
<a class="ulink" href="http://algo.inria.fr/flajolet/Publications/DuFl03.pdf" target="_top">http://algo.inria.fr/flajolet/Publications/DuFl03.pdf</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id834589"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id834589" class="simpara">138</a>] </sup>Durand, M., &amp; Flajolet,
P. (2003). LogLog Counting of Large Cardinalities. In ESA’2003.
doi:10.1007/978-3-540-39658-1_55</p></div><div class="footnote" epub:type="footnote" id="ftn.id834592"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id834592" class="simpara">139</a>] </sup>Flajolet, P., &amp; Fusy, É. (2007). HyperLogLog: the
analysis of a near-optimal cardinality estimation algorithm. 2007 Conference on
Analysis of Algorithms, 127–146.</p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch10.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">10. Clusters and Job Queues</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch12.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">12. Lessons from the Field</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch11.html" data-for-analytics="9781449361747:ch11.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch12.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch12.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch12.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch12.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>12. Lessons from the Field - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch12.html"><meta name="description" content="Chapter&nbsp;12.&nbsp;Lessons from the Field Questions you’ll be able to answer after this chapter How do successful start-ups deal with large volumes of data and machine learning? What ... "><meta property="og:title" content="12. Lessons from the Field"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="12. Lessons from the Field"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch12.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;12.&nbsp;Lessons from the Field Questions you’ll be able to answer after this chapter How do successful start-ups deal with large volumes of data and machine learning? What ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch12.html" data-for-analytics="9781449361747:ch12.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch12.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch12.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch12.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%2012.%20Lessons%20from%20the%20Field&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch12.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch11.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">11. Using Less RAM</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/author_bios.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">About the Authors</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-lessons-from-the-field"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;12.&nbsp;Lessons from the Field</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
How do successful start-ups deal with large volumes of data and machine learning?
</li><li class="listitem">
What monitoring and deployment technologies keep systems stables?
</li><li class="listitem">
What lessons have successful CTOs learned about their technology and teams?
</li><li class="listitem">
How widely can PyPy be deployed?
</li></ul></div></div><p>In this chapter Micha and I have collected stories from successful companies where Python is used in high-data-volume and speed-critical situations. The stories are written by key people in each organization who have many years of experience, they share not just their technology choices but also some of their hard-won wisdom.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="lessons-from-field-ben">AdpativeLab for Social Media Analytics (SoMA)</h2></div></div></div><p>Adaptive Lab are a product development and innovation company, based in London’s Tech City area, Shoreditch.  We apply our lean, user-centric method of product design and delivery collaboratively with a wide range of companies, from startups to large corporates.</p><p>YouGov is a global market research company who state “[it is their] ambition to supply a live stream of continuous, accurate data and insight into what people are thinking and doing all over the world”, and that’s just what we managed to provide for them.  Adaptive Lab designed a way to listen passively to real discussions happening in social media and gain insight to their feelings on a customisable range of topics.  We built a scalable system capable of capturing a large volume of streaming information, processing it, storing it indefinitely and presenting it through a powerful, filterable interface in real-time.  The system was built using Python.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_python_at_adaptive_lab">Python at Adaptive Lab</h3></div></div></div><p>Python is one of our core technologies.  We use it in performance-critical applications and whenever we work with clients that have in-house Python skills so that the work we produce for them can be taken on in-house.</p><p>Python is ideal for small, self-contained, long-running daemons and it’s just as great with flexible, feature-rich web frameworks like Django and Pyramid.  The Python community is thriving, which means that there’s a huge library of open-source tools out there that allow us to build quickly, with confidence, leaving us to focus on the new and innovative stuff, solving problems for users.</p><p>Across all of our projects, Adaptive Lab re-use several tools that are built in Python, but that can be used in a language-agnostic way.  For example, we use SaltStack for server provisioning and Mozilla’s Circus for managing long-running processes.  The benefit to us when a tool is open-sourced and written in a language we’re familiar with is that if we find any problems, we can solve them ourselves and get those solutions taken up, which benefits the community.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_soma_s_design">SoMA’s Design</h3></div></div></div><p>Our Social Media Analytics tool needed to cope with a high throughput of social media data and the storage and retrieval in real-time of a large amount of information.  Through researching various data stores and search engines, we settled on elasticsearch as our real-time document store.  As its name suggests, it’s highly scalable, but is also very easy to use and is very capable of providing statistical responses as well as search - ideal for our application.  elasticsearch itself is built in Java but as with any well-architected component of a modern system, it has a good API and is well-catered for with a Python library and tutorials.</p><p>The system we designed uses queues with Celery held in Redis to quickly hand off such a large stream of data to any number of servers for independent processing and indexing.  Each component of the whole, complex system was designed to be small, individually simple and able to work in isolation.  Each focussed on one task, like analysing a conversation for sentiment or preparing a document for indexing into elasticsearch.  Several of these were configured to run as daemons using Mozilla’s Circus, which keeps all the processes up and running and allows them to be scaled up or down on individual servers.</p><p>SaltStack is used to define and provision the complex cluster and handles the set up of all of the libraries, languages, databases and document stores.  We also make use of Fabric, a Python tool for running arbitrary tasks on the command line.  Defining servers in code has many benefits: Complete parity with the production environment; Version control of your configuration; Having everything in one place; It also serves as documentation on the setup and dependencies required by your cluster.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_our_development_methodology">Our Development Methodology</h3></div></div></div><p>We aim to make it as easy as possible for a newcomer to a project to be able to quickly get into adding code and deploying confidently.  We use Vagrant to build the complexities of a system locally, inside a virtual machine that has complete parity with the production environment.  A simple ‘vagrant up’ is all a newcomer needs to get set up with all the dependencies required for their work.</p><p>We work in an agile way, planning together to discuss architecture decisions and determining a consensus on task estimates.  We made the decision to include at least a few tasks considered as corrections for ‘technical debt’ in each sprint.  Also included were tasks for documenting the system (we eventually established a wiki to house all the knowledge for this ever-expanding project).  Team members review each other’s code after each task, to sanity-check, offer feedback and to understand the new code that is about to get added to the system.</p><p>A good test suite helped bolster confidence that any changes weren’t going to cause existing features to fail.  Integration tests are vital in a system like SoMA, comprised of many moving parts.  A staging environment offers a way to test the performance of new code; on SoMA in particular, it was only through testing against the kind of large datasets seen in production that problems could occur, so it was often necessary to reproduce that amount of data in a separate environment, which Amazon’s EC2 compute cloud gave us the flexibility to do.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_maintaining_soma">Maintaining SoMA</h3></div></div></div><p>The SoMA system runs continuously and the amount of information it consumes grows every day.  We have to account for peaks in the data stream, network issues and problems in any of the third-party service providers it relies on.  So to make things easy on ourselves, SoMA is designed to fix itself whenever it can.  Thanks to Circus, processes that crash out will come back to life and resume their tasks from where they left off.  A task will queue up until a process can consume it and there’s enough breathing room there to stack up tasks while the system recovers.</p><p>We use Server Density to monitor the many SoMA servers.  It’s very simple to set up, but quite powerful.  A nominated engineer can receive a push message on their phone as soon as a problem is likely to occur, so they can react in time to ensure it doesn’t become a problem.  With Server Density it’s also very easy to write custom plugins in Python, making it possible for example to set up instant alerts on aspects of elasticsearch’s behaviour.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_advice_for_fellow_engineers">Advice for Fellow Engineers</h3></div></div></div><p>Above all, you and your team need to be confident and comfortable that what is about to be deployed into a live environment is going to work flawlessly.  To get to that point, you have to work backwards, spending time on all of the components of the system that will give you that sense of comfort: Make deployment simple and fool-proof; Use a staging environment to test the performance with real-world data; Ensure you have a good, solid test suite with high coverage; Implement a process for incorporating new code into the system; Make sure technical debt gets addressed sooner rather than later.  The more you shore up your technical infrastructure and improve your processes, the happier and more successful your team will be at engineering the right solutions.</p><p>If a solid foundation of code and ecosystem is not in place and the business are pressuring you to get things live, it’s only going to lead to problem software.  It’s going to be your responsibility to push back and stake out time for incremental improvements to the code, the tests and the operations involved in getting things out the door.</p><p>Ben Jackson (adaptivelab.co.uk)</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="lessons-from-field-radim">Making deep learning fly with RadimRehurek.com</h2></div></div></div><p>When Ian asked me to write “lessons from the field” on Python &amp; optimizations for this book, I immediately thought, “tell them how you made a Python port faster than Google’s C original!”. It’s an inspiring story of making a machine learning algorithm, Google’s poster child for deep learning, 12,000x faster than a naive Python implementation. Anyone can write bad code to then fanfare large speed ups though. But the optimized Python port also runs, somewhat astonishingly, almost four times faster than the original code by Google’s team! That is, four times faster than opaque, tightly profiled and optimized C.</p><p>But before drawing “machine-level” optimization lessons, some general advice about “human-level” optimizations.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_the_sweet_spot">The Sweet Spot</h3></div></div></div><p>I run a small consulting business <sup>[<a id="id836662" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#ftn.id836662" class="footnote">140</a>]</sup> laser-focused on machine learning, where me and my colleagues help companies make sense of the tumultuous world of data analysis, in order to make money or save costs (or both). We help clients design and build wondrous systems for data processing, especially text data.</p><p>The clients range from large multinationals to nascent startups and while each project is different and requires a different tech stack, plugging into client’s existing data flows and pipelines, Python is a clear favourite. Not to preach to the choir, but Python’s no-nonsense development philosophy, its malleability and the rich library ecosystem make it an ideal choice.</p><p>First, a few thoughts “from the field” on what works:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<span class="strong"><strong>Communication, communication, communication.</strong></span> This one’s obvious, but worth repeating. Understand the client’s problem on a higher, business level before deciding on an approach. Sit down and talk through what they think they need (based on their partial knowledge of what’s possible and or what they googled up before contacting you), until it becomes clear what they really need, free of cruft and preconceptions. Agree on ways to validate the solution beforehand. I like to visualize this process as a long, winding road to be built: get the starting line right (problem definition, available data sources) and the finish line right (evaluation, solution priorities) and the path in between falls into place.
</li><li class="listitem">
<span class="strong"><strong>Be on the lookout for promising technologies.</strong></span> An emergent tech that is reasonably well-understood and robust, gaining traction, yet is still relatively obscure in the industry brings huge value to the client (or yourself). As an example, a few years ago, Elasticsearch was a little known and somewhat raw open source project. But I evaluated its approach as solid (built on top of Apache Lucene, replication, cluster sharding…) and recommended its use to a client. We consequently built a search system with Elasticsearch at its core, saving the client significant amounts of money in licensing, dev and maintenance compared to the considered alternatives (large commercial databases). Even more importantly, using a new, flexible and powerful technology offered a massive competitive advantage to the product, beyond simply saving costs. Nowadays ES has entered the enterprise and conveys no competitive advantage at all—everyone knows it and uses it. Getting the timing right is what I call the “sweet spot”, maximizing value/cost ratio.
</li><li class="listitem">
<span class="strong"><strong>KISS aka “Keep It Simple, Stupid”.</strong></span> Another no-brainer. The best code is one you don’t have to write, and maintain. Start simple, improve and iterate where necessary. I prefer tools that follow the UNIX philosophy of “do one thing, and do it well”. Grand programming frameworks can be tempting, with everything imaginable under one roof and fitting neatly together. But invariably, sooner or later you need something the grand framework didn’t imagine, and then even simple modifications (conceptually) cascade into a nightmare (programmatically). Grand projects and their all-encompassing APIs tend to collapse under their own weight. Use modular, focused tools, with as small and uncomplicated APIs in between as possible. Prefer text formats that are open to simple visual inspection, unless performance dictates otherwise.
</li><li class="listitem">
<span class="strong"><strong>Use manual sanity checks in data pipelines.</strong></span> When optimizing data processing systems, it’s easy to stay in the “binary mindset” mode, using tight pipelines, efficient binary data formats, compressed I/O. As the data passes through the system unseen, unchecked (except for perhaps its type), it remains invisible until something outright blows up. Debugging commences. I advocate sprinkling a few simple log messages, showing what the data looks at various internal points of processing, as good practice. Nothing fancy, just an analogy to the “head” UNIX command, picking and visualizing a few data points. Not only does this help during the aforementioned debugging, but seeing the data in a human readable format leads to “aha!” moments surprisingly often even when all seems to go well. Strange tokenization! They promised input would always be encoded in latin1! How did a document in this language get in there? Image files leaked into a pipeline that expects and parses text files! These are often insights that go way beyond automatic type checking or a fixed unit test, hinting at issues beyond component boundaries. Real world data is messy. Catch early even things that wouldn’t necessarily lead to exceptions or glaring errors. Err on the side of too much verbosity.
</li><li class="listitem">
<span class="strong"><strong>Navigate fads carefully.</strong></span> Because a client keeps hearing about X and says they must have X too, doesn’t mean they really need it. It might be a marketing problem rather than a technology one, so take care to discern the two and deliver accordingly. “X” changes over time as hype waves come and go; a recent value would be “X=big data”.
</li></ul></div><p>Alright, enough business talk, here’s how I got word2vec in Python to run faster than C.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_lessons_in_optimizing">Lessons in Optimizing</h3></div></div></div><p>Word2vec <sup>[<a id="id836897" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#ftn.id836897" class="footnote">141</a>]</sup> is a deep learning algorithm that allows detection of similar words and phrases. With interesting applications in text analytics and SEO, and with Google’s lustrous brand name attached to it, startups and businesses flock to take advantage of this new tool.</p><p>Unfortunately the only available code used to be due to Google itself, an open source Linux command line tool written in C. A well optimized but rather hard to use implementation. The primary reason why I decided to port word2vec to Python was so I could extend word2vec to other platforms, making it easier to integrate and extend for clients.</p><p>The details are not relevant here, but word2vec requires a training phase which needs a lot of input data to produce a useful similarity model. For example, the folks at Google ran word2vec on their GoogleNews dataset, training on approximately 100 billion words. Datasets of this scale obviously don’t fit in RAM, so a memory-efficient approach must be taken.</p><p>I’ve authored a machine learning library, gensim <sup>[<a id="id836813" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#ftn.id836813" class="footnote">142</a>]</sup>, that targets exactly that sort of memory-optimization problem: datasets that are no longer trivial (anything that fits fully into RAM), yet not large enough to warrant petabyte-scale clusters of MapReduce computers. This “terabyte” problem range fits a surprisingly large portion of real-world cases, word2vec included.</p><p>Details <sup>[<a id="id836800" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#ftn.id836800" class="footnote">143</a>]</sup> are described on my blog, but here are a few optimization takeaways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<span class="strong"><strong>Stream your data, watch your memory.</strong></span> Let your input be accessed and processed one data point at a time, for a small, constant memory footprint. The streamed data points (sentences, in case of word2vec) may be grouped into larger batches internally for performance (such as processing 100 sentences at a time), but a high-level, streamed API proved a powerful and flexible abstraction. The Python language supports this pattern very naturally and elegantly, with its built-in generators. A truly beautiful problem-tech match. Avoid committing to algorithms and tools that load everything into RAM, unless you know your data will always remain small, or don’t mind re-implementing a production version yourself later.
</li><li class="listitem">
<span class="strong"><strong>Take advantage of Python’s rich ecosystem.</strong></span> I started with a readable, clean port of word2vec in NumPy. I am sure Ian and Micha cover NumPy elsewhere in this book (Note - see <code class="literal">numpy</code> discussion in  <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a>), but as a short reminder, NumPy is an amazing library, a cornerstone of Python’s scientific community and the de facto standard for number crunching in Python. Tapping into NumPy’s powerful arrays interfaces, memory access patterns and its wrapped BLAS routines for ultra-fast common vector operations lead to concise, clean and fast code. Hundreds of times faster than naive Python code. Normally I’d call it a day at this point, but “hundreds of times faster” was still 20x slower than Google’s optimized C version, so I pressed on.
</li><li class="listitem">
<span class="strong"><strong>Profile &amp; compile hotspots.</strong></span> Word2vec is a typical HPC app in that a few lines of code in one inner loop account for 90% of the entire training runtime. Here I rewrote a single core routine (approximately 20 lines of code) in C, using an external Python library, Cython, as the glue. While technically brilliant, I don’t consider Cython a particularly convenient tool conceptually—it’s basically like learning another language, a non-intuitive mix between Python, NumPy and C, with its own caveats and idiosyncrasies. But until Python’s JIT (just-in-time compilation) technologies mature, Cython is probably our best bet. With a Cython-compiled hotspot, performance of the Python word2vec port is now on par with the original C code. An additional advantage of having started with a clean NumPy version: free tests for correctness, by comparing against the slower but correct version.
</li><li class="listitem">
<span class="strong"><strong>Know your BLAS.</strong></span> A neat feature of NumPy is that it internally wraps BLAS (Basic Linear Algebra Subroutines), where available. These are sets of low-level routines, optimized directly by processor vendors (Intel, AMD…) in assembly, Fortran or C, to squeeze out maximum performance from a particular processor architecture. For example, calling an AXPY BLAS routine computes vector_y += scalar * vector_x, way faster than what a generic compiler would produce for an equivalent explicit for-loop. Expressing word2vec training as BLAS operations resulted in another 4x speed up, topping the performance of C word2vec. Victory! To be fair, the C code could of course link to BLAS as well, so this is not some inherent advantage of Python per se. NumPy just makes things like these stand out and easy to take advantage of.
</li><li class="listitem">
<span class="strong"><strong>Parallelization and multiple cores.</strong></span> Gensim contains distributed, cluster implementations of a few algorithms. For word2vec, I opted for multithreading on a single machine, because of the fine grained nature of its training algorithm. Using threads also allows us to avoid fork-without-exec POSIX issues that Python’s multiprocessing brings, especially in combination with certain BLAS libraries. Because our core routine is already in Cython, we can afford to release Python’s GIL (Global Interpreter Lock - see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-omp">Parallelizing the solution with OpenMP on One Machine</a>) that normally renders multithreading useless for CPU intensive tasks. Speed up: another 3x, on a machine with four cores.
</li><li class="listitem">
<span class="strong"><strong>Static memory allocations.</strong></span> At this point, we’re processing tens of thousand of sentences per second. Training is so fast that even little things like creating a new NumPy array (calling malloc for each streamed sentence) slow us down. Solution: pre-allocate a static “work” memory and pass it around, in good old Fortran fashion. Brings tears to my eyes. The lesson here is to keep as much bookkeeping and app logic in the clean, Python code as possible, and keep the optimized hotspot lean and mean.
</li><li class="listitem">
<span class="strong"><strong>Problem-specific optimizations.</strong></span> The original C implementation contained specific micro optimizations, such as aligning arrays onto specific memory boundaries or precomputing certain functions into memory lookup tables. A nostalgic blast from the past, but with today’s complex CPU instruction pipelines, memory cache hierarchies and coprocessors, such optimizations are no longer a clear winner. Careful profiling suggested a few percent improvement, which may not be worth the extra code complexity. Takeaway: use annotation and profiling tools to highlight poorly optimized spots. Use your domain knowledge to introduce algorithmic approximations that trade accuracy for performance (or vice versa). But never take it on faith, profile, preferably using real, production data.
</li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_wrap_up_7">Wrap up</h3></div></div></div><p>Optimize where appropriate; in my experience, there’s never enough communication to ascertain problem scope, priorities and connection to client’s business goals. Aka the “human-level” optimizations. Make sure you deliver on a problem that matters, rather than getting lost in “geek stuff” for the sake of it. And when you do roll up your sleeves, make it worth it!</p><p>Radim Řehůřek (radimrehurek.com)</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="lessons-from-field-sebastjan">Large scale productionized machine learning at Lyst.com</h2></div></div></div><p>Lyst.com is a fashion recommendation engine based in London, it has over 2,000,000 monthly users who learn about new fashion through Lyst’s scraping, cleaning and modelling processes. Founded in 2010 it has raised $20M of investment.</p><p>Sebastjan Trepca was the technical founder and is the CTO, he created the site using Django and Python has helped the team to quickly test new ideas.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_python_s_place_at_lyst">Python’s place at Lyst</h3></div></div></div><p>Python and Django has been at the heart of Lyst since the site’s creation. As internal projects have grown some of the Python components has been replaced with other tools and languages to fit the maturing needs of the system.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_cluster_design">Cluster design</h3></div></div></div><p>The cluster runs on Amazon EC2, in total there are approximately 100 machines including the more recent C3 instances which have good CPU performance.</p><p>Redis is used for queueing with PyRes and storing meta data. The dominant data format is JSON for ease of human comprehension. supervisord keeps the processes alive.</p><p>ElasticSearch and pyES are used to index all products. The ElasticSearch cluster stores 60M documents across 7 machines. Solr was investigated and discounted almost a year ago due to it’s lack of real-time updating features.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_code_evolution_in_a_fast_moving_start_up">Code evolution in a fast moving start-up</h3></div></div></div><p>It is better for code to be quickly implemented so that a business idea can be tested than to write “perfect code” in the first pass. If code is useful then it can be refactored, if the idea behind the code is poor then it is cheap to delete it and remove a feature. This can lead to a complicated code base with many objects being passed around, this is acceptable as the team makes time to refactor code that is useful to the business.</p><p>Docstrings are used heavily, an external Sphinx documentation system was tried but dropped in favour of just reading the code. A wiki is used to document processes and larger systems. We also started creating very small services instead of chucking everything into one codebase.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_building_the_recommendation_engine">Building the recommendation engine</h3></div></div></div><p>At first the recommendation engine was coded in Python, using numpy and scipy for computations. Subsequently, performance-critical parts of the recommender were speeded up using Cython; the core matrix factorization operations were written entirely in Cython, yielding an order of magnitude improvement in speed. This was mostly due to the ability to write performant loops over numpy arrays in Python, something that is extremely slow in pure Python, and performing poorly when vectorized because it necessitated memory copies of numpy arrays. The culprit was numpy fancy indexing, which always makes a data copy of the array being sliced: if no data copy is necessary or intended, Cython loops will be far faster.</p><p>Over time, the online components of the system, responsible for computing recommendations at request time, were integrated into our search component, ElasticSearch. In the process, it was translated into Java to allow full integration with ElasticSearch. The main reason behind this is not performance, but the utility of integrating the recommender with the full power of a search engine, allowing us to apply business rules to served recommendations more easily. The Java component itself is extremely simple and implements primarily efficient sparse vector inner products. The more complex offline component remains written in Python, using standard components of the Python scientific stack (mostly Python and Cython).</p><p>In our experience, Python is useful as more than a prototyping language: the availability of tools such as numpy, Cython, and weave (and more recently Numba) allowed us to achieve very good performance in the performance critical parts of the code while maintaining Python’s clarity and expressiveness where low-level optimization would be counterproductive.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_reporting_and_monitoring">Reporting and Monitoring</h3></div></div></div><p>Graphite is used for reporting, currently performance regressions can be seen by eye after a deployment. This makes it easy to drill into detailed event reports or to zoom out and see a high level report of the site’s behaviour, adding and removing events as necessary.</p><p>Internally a larger infrastructure for performance testing is being designed, it will include representative data and use cases to properly test new builds of the site.</p><p>A staging site will also be used to let a small fraction of real visitors see the latest version of the deployment - if a bug or performance regression is seen then it will only have affected a minority of visitors and this version could quickly be retired. This will make the deployment of bugs significantly less costly and problematic.</p><p>Sentry is used to log and diagnose Python stack traces.</p><p>Jenkins is used for CI with an in-memory database configuration. This enables parallelised testing so that check-ins quickly reveal any bugs to the developer.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_some_advice">Some advice</h3></div></div></div><p>It’s really important to have a good tools to track effectiveness of what you’re building and that you’re super practical in the beginning. Startups change constantly and engineering goes from super exploratory, building prototypes all the time and deleting code until you hit the goldmine and then you start to go deeper, improving code, performance etc. Until then, it’s just quick iterations and good monitoring/analytics. I guess this is pretty standard anyway and been repeated over and over, but I think many don’t really get it how important it is.</p><p>I don’t think technologies matter that much nowadays, whatever works for you, I’d think twice before moving to hosted environments like AppEngine or Heroku though.</p><p>Sebastjan Trepca (lyst.com)</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="lessons-from-field-alex">Large Scale Social Media Analysis at Sme.sh</h2></div></div></div><p>At Smesh we produce software which ingests data from a wide variety of APIs across the Web, filters, process and aggregates them, and then use that data to build bespoke apps for a variety of clients. For example we provide the tech that powers the tweet filtering and streaming in Beamly’s second screen TV app, run a brand and campaign monitoring platform for mobile network EE, and run a bunch of Adwords data analysis projects for Google.</p><p>To do that we run a variety of different streaming and polling services, processing several million tweets daily, and frequently polling Twitter, Facebook, YouTube and a host of other services for content.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_python_s_role_at_smesh">Python’s role at Smesh</h3></div></div></div><p>We use Python extensively - the majority of our platform and services are built with it. The wide variety of libraries, tools and frameworks available allows us to use it across the board for most of what we do.</p><p>That variety gives us the ability to (hopefully) pick the right tool for the job. For example we’ve created apps using each of Django, Flask, and Pyramid. Each has it’s own benefits and allows us to pick what’s right for the task in hand. We use Celery for tasks, Boto for interacting with AWS, PyMongo, Mongoengine, redis-py, Psycopg etc. for all our data needs. The list goes on and on.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_the_platform">The Platform</h3></div></div></div><p>Our main platform consists of a central Python module which provides hooks for data input, filtering, aggregations and processing and a variety of other core functions. Project specific code imports functionality from that core and then implements more specific data processing and view logic as each application requires.</p><p>This has worked well for us up to now, and allows us to build fairly complex applications which ingest and process data from a wide variety of sources without much duplication of effort. However it isn’t without it’s drawbacks - each app is dependent on a common core module, making the process of updating the code in that module and keeping all the apps which use it up-to-date a major task.</p><p>We’re currently working on a project to redesign that core software and move towards a more SoA based approach. It seems that finding the right time to make that sort of architectural change is one of the challenges that faces most software teams as a platform grows. There is overhead in building components as individual services, and often the deep domain specific knowledge required to build each service is only acquired through an initial iteration of development, where that architectural overhead is a hinderance to solving the real problem at hand. Hopefully we’ve chosen a sensible time to re-visit our architectural choices to move things forward. Time will tell.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_high_performance_real_time_string_matching">High performance real-time string matching</h3></div></div></div><p>We consume lots of data from the Twitter Streaming API. As we stream in tweets, we match the input strings against a set of keywords so that we know which of the terms we’re tracking that tweet is related to. That’s not such a problem with a low rate of input, or a small set of keywords, but doing that matching for hundreds of tweets per second, against hundreds or thousands of possible keywords starts to get tricky.</p><p>To make things more tricky, we’re not interested in simply whether the keyword string exists in the tweet, but more complex pattern matching against word boundaries, start and end of line, and optionally allow ‘#’ and ‘@’ characters to prefix the string. The most effective way to encapsulate that matching knowledge is using regular expressions. However running thousands of regex patterns across hundreds of tweets per second is computationally intensive. Previously it required us to run many worker nodes across a cluster of machines to perform the matching reliably in real-time.</p><p>Knowing this was a major performance bottleneck in the system, we tried a variety of things to improve the performance of our matching system. Simplifying the regexes, running enough processes to ensure we were utilising all the cores on our servers, ensuring all our regex patterns are compiled and cached properly, running the matching tasks under PyPy not CPython etc. Each of these resulted in a small increase in performance, but it’s clear this approach was only ever going to shave a fraction of our processing time. We were looking for an order of magnitude speedup, not a fractional improvement.</p><p>It was obvious that rather than trying to increase the performance of each match, we needed to reduce the problem space before the pattern matching takes place. So we needed to either reduce the number of tweets to process, or the number of regex patterns we needed to match the tweets against. Dropping the incoming tweets wasn’t an option - that’s the data we’re interested in. So we set about finding a way to reduce the number of patterns we need to compare an incoming tweet to in order to perform the matching.</p><p>We started looking at various trie structures for allowing us to do pattern matching between sets of strings more efficiently, and came across the Aho-Corasick string matching algorithm. It turns out to be ideal for our use-case. The dictionary from which the trie is built needs to be static - you can’t add new members to the trie once the automaton has been finalised. For us this isn’t a problem as the set of keywords is static for the duration of a session streaming from Twitter. When we change the terms we’re tracking we must disconnect from, and reconnect to the API - so we can rebuild the Aho-Corasick trie at the same time.</p><p>Processing an input against the strings using Aho-Corasick finds all possible matches simultaneously, stepping through the input string a character at a time and finding matching nodes at the next level down in the trie, or not as the case may be. So we can very quickly find which of our keyword terms may exist in the tweet. We still don’t know for sure as the pure string-in-string matching of Aho-Corasick doesn’t allow us to apply any of the more complex logic which is encapsulated in the regex patterns. However we use the Aho-Corasick matching as a pre-filter. Keywords which don’t exist in the string can’t match, so we know we only have to try a small subset of all our regex patterns, based on the keywords which do appear in the text. Rather than evaluating hundreds or thousands of regex patterns against every input, we rule out the majority, and only need to process a handful for each tweet.</p><p>By reducing the number of patterns we attempt to match against each incoming tweet to just a small handful, we’ve managed to achieve the speedup we were looking for. Depending on the complexity of the trie, and average length of input tweets, our keyword matching system now performs somewhere between 10-100x faster than the original naïve implementation.</p><p>If you’re doing a lot of regex processing, or other pattern matching, I highly recommend having a dig around the different variations of prefix and suffix tries that might help you to find a blazingly fast solution to your problem.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_reporting_monitoring_debugging_and_deployment">Reporting, monitoring, debugging and deployment</h3></div></div></div><p>We maintain a bunch of different systems running our Python software and all the rest of the infrastructure that powers it all. Keeping it all up and running without interruption can be tricky. Here’s a few lessons we’ve learned along the way.</p><p>It’s really powerful to be able to see both in real-time, and historically, what’s going on inside your systems. Whether that be in your own software, or the infrastructure it runs on. We use Graphite with collectd and StatsD to allow us to draw pretty graphs of what’s going on. That gives us a way to spot trends, and to retrospectively analyse problems to find the root cause. We haven’t got around to implementing it yet, but Etsy’s Skyline also looks brilliant as a way to spot the unexpected when you have more metrics than you can keep track of. Sentry is a great system for event logging and keeping track of exceptions being raised across a cluster of machines.</p><p>Deployment can be painful, no matter what you’re using to do it. We’ve been users of Puppet, Ansible and Salt. They all have pros and cons, but none of them will make a complex deployment problem magically go away.</p><p>To maintain high availability for some of our systems we run multiple geographically distributed clusters of infrastructure, running one system live and others as hot spares, with switchover being done by updates to DNS with low TTLs. Obviously that’s not always straightforward, especially when you have tight constraints on data consistency. Thankfully we’re not affected by that too badly, making the approach relatively straightforward. It also provides us with a fairly safe deployment strategy, updating one of our spare clusters and performing testing, before promoting that cluster to live and updating the others.</p><p>Along with everyone else we’re really excited by the prospect of what can be done with Docker. Also along with pretty much everyone else we’re still just at the stage of playing around with it to figure out how to make it part of our deployment processes. However the prospect of being able to rapidly deploy our software in a lightweight and reproducible fashion, with all it’s binary dependencies and system libraries included seems to be just around the corner.</p><p>At a server level there’s a whole bunch of routine stuff that just makes life easier. Monit is great for keeping an eye on things for you. Upstart and Supervisord make running things reliably as services less painful. Munin is useful for some quick and easy system level graphing if you’re not using a full graphite/collectd setup. And Corosync/Pacemaker can be a good solution for running services across a cluster of nodes. For example where you have a bunch of services which you need to run somewhere, but not everywhere.</p><p>I’ve tried not to just list buzzwords here, but to point you towards software we’re using every day, which is really making a difference to how effectively we can deploy and run our systems. If you’ve heard of them all already, I’m sure you must have a whole bunch of other useful tips to share, so please drop me a line with some pointers. If not, go check them out, hopefully some of them will be as useful to you as they are to us.</p><p>Alex Kelly (sme.sh)</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="lessons-from-field-marko">PyPy for successful web and data processing systems</h2></div></div></div><p>This document explains steps taken by a small team of developers to implement high performance cloud applications without prior knowledge of obstacles and with limited access to large computational and storage resources. Data structures, algorithms and “under the hood” logic of libraries, frameworks and servers used is essential to understand. This document is slightly technical, but it is also more practical approach for common reader. Installation and configuration is out of scope of this document.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_introduction">Introduction</h3></div></div></div><p>Since I have had a great experience before with pypy (“PyPy”), python implementation, I chose to use it everywhere where it was applicable. I used it from small toy projects where speed was essential to medium size projects. First project where I used it was protocol implementation, and protocols we implemented were Modbus and DNP3. Later, I used it for compression algorithms implementation, and everyone was amazed by its speed. First version I used in production was pypy 1.2 with JIT out of box, if I recall correctly. By its version 1.4 we were sure it is future of all our projects because many bugs got fixed and speed just increased more and more. We were surprised how simple cases were 2-3x faster just by upgrading pypy up to next version.</p><p>I will explain two separate but deeply related projects that share 90% of same code, but to keep explanation simple for reader to follow, I will refer to both of them as “project”.</p><p>Project was about to create system which will collect newspapers, magazines, blogs, apply OCR if necessary, classify them, translate, apply sentiment analysing, analyse documents structure, and index them for later search. User can search for keywords in any of available languages and retrieve information about indexed documents. Search is cross-language, so user can write in English and get results in French. Additionally, user will receive articles and keywords highlighted from document’s page with information of space occupied and price of publication. More advanced use case would be report generation, where user can see tabular view of results with detailed information on spending by any particular company on advertising in monitored newspapers, magazines, blogs. Not only advertising, but also it can “guess” if article is paid or objective, and determine its tone.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_prerequisites">Prerequisites</h3></div></div></div><p>Obviously, pypy was our favorite python implementation. For database we used Cassandra and ElasticSearch. Cache servers used Redis. We used Celery as distributed task queue (workers), and for its broker (task queue), we used RabbitMQ while results were kept in redis backend. Later on celery used redis more exclusively for both brokers and backend. OCR engine used is Tesseract. Language translation engine and server used is Moses. We used scrapy for crawling websites. For distributed locking in whole system we use ZooKeeper server, but initially redis was used for that. Web application is based on excellent Flask web framework, and many of its extensions such as flask-login, flask-principal, etc. Flask application was hosted by gunicorn and tornado on every web server, and nginx as reverse proxy server to web servers. Rest of code is written by us, and it is in pure python that runs on top of pypy.</p><p>The whole project is hosted on in-house OpenStack private cloud, and executes ArchLinux ranging between 100 and 1000 instances depending on requirements which can dynamically change on-fly. The whole system consumes up to 200TB of storage every 6-12 months depending on mentioned requirements. All processing is done by our python code, except OCR and translation.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_database">Database</h3></div></div></div><p>We developed python package that unifies model classes for cassandra, elasticsearch and redis. It is simple ORM that maps everything to dict or list of dicts in case of many records are retrieved from database.</p><p>Since cassandra 1.2 did not support complex queries on indices, we supported them with join-like queries. However, we allowed complex queries over small datasets up to 4GB because much of that had to be processed while held in memory. PyPy run in cases where CPython could not even load data into memory thanks to its strategies applied to homogeneous lists, so they could be more compact into the memory. Another benefit of pypy is that its JIT kicked in loops where data manipulation or analysis happened. We wrote code that way that types stay static inside of loops because thats where JIT’ed code is especially good.</p><p>ElasticSearch was used for indexing and fast searching of documents. It is very flexible when it comes to query complexity, so we did not have any major issues with it. One of issues we had was related to updating documents because it is not designed for rapidly changing documents, so we had to migrate that part to cassandra. Another limitation was related to facets and memory required on database instance, but it was solved by having more smaller queries and then manually manipulating data in celery workers. No major issues faced between pypy and pyes library used for interaction with ElasticSearch server pools.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_web_application">Web Application</h3></div></div></div><p>As mentioned above, we used Flask framework with its third party extensions. Initially, we started everything in Django, but switched to Flask because of rapid changes in requirements. This does not mean that Flask is better than Django, it was just easier for us to follow code in Flask then in Django, since its project layout is very flexible. Gunicorn was used as WSGI HTTP server, and its IO loop was executed by tornado. This allowed us to have up to 100 concurrent connections per web server. Reason why it is lower than expected is because many user queries can take longer because a lot of analysing happens on user request, also user has interaction with data returned.</p><p>Web application depended on PIL for article and word highlighting. We had issue with PIL library and pypy because at that time there were many memory leaks associated with PIL. Then we switched to Pillow which was more frequently maintained. But, at the end we wrote library that interacted with GraphicsMagick via subprocess module.</p><p>PyPy run well, and results we comparable with CPython. The only reason why they are compatible is because usually web applications are IO bound. However, with development of STM in pypy we hope to have scalable event handling on multi-core instance level.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_ocr_and_translation">OCR and Translation</h3></div></div></div><p>We wrote pure python libraries for tesseract and moses because we had problem with CPython API dependant extensions. PyPy has good support for CPython API using cpyext, but we wanted to be more in control of what happens under the hood. As a result we got pypy compatible solution and slightly faster code than on CPython. Reason why it was not more faster is that most of processing happened in C/C++ code of both tesseract and moses. We could only speed up output processing and building python structure of documents. No major issues at this stage happened with pypy compatibility.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_task_distribution_and_workers">Task Distribution and Workers</h3></div></div></div><p>Celery gave us power to massively run tasks in background. Typical tasks are OCR, translation, analysis, etc. The whole thing could be done using Hadoop for MapReduce, but we chose celery because of knowing fact that project requirements might change often.</p><p>We had about 20 workers, and a worker had between 10 and 20 functions. Almost all functions had loop or many nested loops. We cared that types stay static, so JIT can do its job. End results were 2-5x speedup over CPython. Reason why we did not get better speedup is because our loops were relatively small, between 20K and 100K iterations. In some cases where we had to do analysis on word level, we had over 1M iterations, and thats where get over 10x speedup.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_conclusion">Conclusion</h3></div></div></div><p>PyPy is an excellent choice for every pure python project that depends on speed of execution of readable and maintainable large source code. We found pypy also very stable. All our programs were long running with static and/or homogeneous types inside data structures, so JIT could do its job. When we tested whole system on CPython results did not surprise us, we had rough 2x speedup with pypy over CPython. In eyes of our clients this meant 2x better performance for same price. In the end, besides all good stuff that pypy brought to us, we hope that STM implementation will bring to us scalable parallel execution for python code.</p><p>Marko Tasic (github.com/mtasic85)</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="lessons-from-field-andrew">Task queues at Lanyrd.com</h2></div></div></div><p>Lanyrd is a website for social discovery of conferences - our users sign in, and we use their friend graphs from social networks as well as other indicators, like their industry of work or their geographic location.</p><p>The main work of the site is in distilling this raw data down into something we can show to the users - essentially, a ranked list of conferences. We have to do this offline, as we refresh it every couple of days as well as the fact that we’re hitting external APIs that are often slow. We also use the Celery task queue for other things that take a long time - like fetching thumbnails for links people provide or sending email. There is usually well over 100,000 tasks in the queue each day, sometimes much more.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_python_s_role_at_lanyrd">Python’s role at Lanyrd</h3></div></div></div><p>Lanyrd was built with Python and Django from day one, and virtually every part of it is written in Python - the website itself, the offline processing, our statistical and analysis tools, our mobile backend servers and the deployment system. It’s a very versatile and mature language and one that’s incredibly easy to write things in quickly, mostly thanks to the large amount of libraries available and the language’s easily-readable and concise syntax, which means it’s easy to update and refactor as well as easy to write initially.</p><p>The Celery task queue was already a mature project when we evolved the need for a task queue very early on, and the rest of Lanyrd was already in Python, so it was a natural fit. As we grew, there was some need to change the queue which backed it (which ended up being Redis), but it’s generally scaled very well.</p><p>As a startup, we had to ship some known technical debt in order to make some headway - this is something you just have to do, and as long as you know what your issues are and when they might surface, it’s not necessarily a bad thing. Python’s flexibility in this regard is fantastic; it generally encourages loose coupling of components which means it’s often easy to ship something with a “good enough” implementation and then easily refactor a better one in later.</p><p>Anything critical - such as payment code - would have full unit test coverage, but for other parts of the site and task queue flow (especially display-related code) things were often moving too fast to make unit tests worthwhile (they would be too fragile). Instead, we adopted a very agile approach and had a two-minute deploy time and excellent error tracking; if a bug made it into live, we could often fix and deploy it within five minutes.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_making_the_task_queue_performant">Making the task queue performant</h3></div></div></div><p>The main issue with a task queue is throughput. If it gets backlogged then the website keeps working but starts getting mysteriously outdated - lists don’t update, page content is wrong, and emails don’t get sent for hours.</p><p>Fortunately though, task queues also encourage a very scalable design; as long as your central messaging server (in our case, Redis) can handle the messaging overhead of the job requests and responses, for the actual processing you can spin up any number of worker daemons to handle the load.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_reporting_monitoring_debugging_and_deployment_2">Reporting, monitoring, debugging and deployment</h3></div></div></div><p>We had monitoring that kept track of our queue length and if it started becoming long we would just deploy another server with more worker daemons - Celery makes this very easy to do. Our deployment system had hooks where we could increase the number of worker threads on a box (if our CPU utilisation wasn’t optimal) and could easily turn a fresh server into a celery worker within 30 minutes. It’s not like website response times going through the floor - if your task queues suddenly get a load spike you have some time to implement a fix and usually it’ll smooth over itself, if you’ve left enough spare capacity.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_advice_to_a_fellow_developer">Advice to a fellow developer</h3></div></div></div><p>My main advice would be to shove as much as you can into a task queue (or a similar loosely coupled architecture) as soon as possible. It takes some initial engineering effort, but as you grow, operations that used to take half a second can grow to half a minute, and you’ll be glad they’re not blocking your main rendering thread. Once you’ve got there, make sure you keep a close eye on your average queue latency (how long it takes a job from submission to completion), and make sure there’s some spare capacity for when your load increases.</p><p>Finally, be aware that having multiple task queues for different priorities of tasks makes sense. Sending email isn’t very high priority; people are used to emails taking minutes to arrive, whereas if you’re rendering a thumbnail in the background and showing a spinner while you do it, you want that job to be high priority, as otherwise you’re making the user experience worse. You don’t want your 100,000-person mailshot to delay all thumbnailing on your site for the next 20 minutes!</p><p>Andrew Godwin (lanyrd.com)</p></div></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id836662"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#id836662" class="simpara">140</a>] </sup><a class="ulink" href="http://radimrehurek.com/" target="_top">http://radimrehurek.com/</a></p></div><div class="footnote" id="ftn.id836897"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#id836897" class="simpara">141</a>] </sup><a class="ulink" href="https://code.google.com/p/word2vec/" target="_top">https://code.google.com/p/word2vec/</a></p></div><div class="footnote" id="ftn.id836813"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#id836813" class="simpara">142</a>] </sup><a class="ulink" href="http://radimrehurek.com/gensim/" target="_top">http://radimrehurek.com/gensim/</a></p></div><div class="footnote" id="ftn.id836800"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#id836800" class="simpara">143</a>] </sup><a class="ulink" href="http://radimrehurek.com/2013/09/deep-learning-with-word2vec-and-gensim/" target="_top">http://radimrehurek.com/2013/09/deep-learning-with-word2vec-and-gensim/</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch11.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">11. Using Less RAM</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/author_bios.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">About the Authors</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch12.html" data-for-analytics="9781449361747:ch12.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/copyright.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="copyright.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/copyright.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="copyright.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>Copyright - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/copyright.html"><meta name="description" content=" High Performance Python Micha Gorelick Ian Ozsvald Editor Meghan Blanchette Editor Rachel Roumeliotis Revision History 2013-03-1 Early release revision 1 2014-04-09 Early release revision 2 2014-05-22 Early release revision 3 ... "><meta property="og:title" content="Copyright"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="Copyright"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/copyright.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content=" High Performance Python Micha Gorelick Ian Ozsvald Editor Meghan Blanchette Editor Rachel Roumeliotis Revision History 2013-03-1 Early release revision 1 2014-04-09 Early release revision 2 2014-05-22 Early release revision 3 ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/copyright.html" data-for-analytics="9781449361747:copyright.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/copyright.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/copyright.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/copyright.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20Copyright&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/copyright.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/author_bios.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">About the Authors</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
  <span class="nav-link"></span>
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><div class="colophon" epub:type="colophon" id="copyright_page_orm"><h2 class="title"></h2><div><h1 class="title">High Performance Python</h1></div><div><div class="author"><h3 class="author"><span class="firstname">Micha Gorelick</span></h3></div></div><div><div class="author"><h3 class="author"><span class="firstname">Ian Ozsvald</span></h3></div></div><div class="editor"><h4>Editor</h4><h3 class="editor"><span class="firstname">Meghan Blanchette</span></h3></div><div class="editor"><h4>Editor</h4><h3 class="editor"><span class="firstname">Rachel Roumeliotis</span></h3></div><div><div class="revhistory"><table style="border: 1; width: 100%; "><tbody><tr><td style="text-align: left; vertical-align: top; " colspan="2"><strong>Revision History</strong></td></tr><tr class="revision"><td class="revdate">2013-03-1</td><td class="revremark">Early release revision 1</td></tr><tr class="revision"><td class="revdate">2014-04-09</td><td class="revremark">Early release revision 2</td></tr><tr class="revision"><td class="revdate">2014-05-22</td><td class="revremark">Early release revision 3</td></tr><tr class="revision"><td class="revdate">2014-06-19</td><td class="revremark">Early release revision 4</td></tr></tbody></table></div></div><div><p class="copyright">Copyright © 2014 Micha Gorelick and Ian Ozsvald</p></div><div><div class="legalnotice"><a id="id299764"></a><p>O’Reilly books may be purchased for educational, business, or sales promotional use. Online editions are also available for most 
                titles (<a class="ulink" href="http://my.safaribooksonline.com/?portal=oreilly" target="_top">http://my.safaribooksonline.com</a>). For more information, contact our corporate/institutional sales department:
                800-998-9938 or <span class="email"><a class="email" href="mailto:corporate@oreilly.com">corporate@oreilly.com</a></span>.</p></div></div><div><div class="legalnotice"><a id="id308483"></a><p>Nutshell Handbook, the Nutshell Handbook logo, and the O’Reilly logo
                are registered trademarks of O’Reilly Media, Inc. !!FILL THIS IN!!
                and related trade dress are trademarks of O’Reilly Media, Inc.    </p><p>Many of the designations used by manufacturers and sellers to distinguish
                their products are claimed as trademarks. Where those designations appear
                in this book, and O’Reilly Media, Inc. was aware of a trademark claim,
                the designations have been printed in caps or initial caps.    </p></div></div><div><div class="legalnotice"><a id="id638780"></a><p>While every precaution has been taken in the preparation of this book,
                the publisher and authors assume no responsibility for errors or omissions, 
                or for damages resulting from the use of the information contained herein.</p></div></div><div class="publisher"><span class="publishername">O’Reilly Media<br></span><div class="address"><p><span class="street">1005 Gravenstein Highway North</span></p><p><span class="city">Sebastopol</span>, <span class="state">CA</span> <span class="postcode">95472</span> </p></div></div><div class="timestamp"><p>2014-06-19T08:39:37-07:00</p></div><p></p></div><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/author_bios.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">About the Authors</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
  <span class="nav-link"></span>
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/copyright.html" data-for-analytics="9781449361747:copyright.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/copyright.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html><!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/pr01.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="pr01.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/pr01.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="pr01.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>Preface - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/pr01.html"><meta name="description" content="Preface Python is easy to learn. You’re probably here because now that your code runs correctly, you need it to run faster. You like the fact that your code ... "><meta property="og:title" content="Preface"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="Preface"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/pr01.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Preface Python is easy to learn. You’re probably here because now that your code runs correctly, you need it to run faster. You like the fact that your code ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/pr01.html" data-for-analytics="9781449361747:pr01.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/pr01.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/pr01.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/pr01.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20Preface&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/pr01.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/index.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">High Performance Python</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch01.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">1. Understanding Performant Python</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="preface" epub:type="preface" id="_preface"><div class="titlepage"><div><div><h2 class="title">Preface</h2></div></div></div><p>Python is easy to learn. You’re probably here because now that your code runs
correctly, you need it to run faster. You like the fact that your code is easy
to modify and you can iterate with ideas quickly. The trade-off between <span class="emphasis"><em>easy to
develop</em></span> and <span class="emphasis"><em>runs as quickly as I need</em></span> is a well understood and bemoaned
phenomenon. There are solutions.</p><p>Some people have a serial process that has to run faster. Others have problems
that could take advantage of multi-core architectures, clusters or GPUs. Some
need scalable systems that can process more or less as expediency and funds
allow, without losing reliability. Others will realise that their coding
techniques, often borrowed from other languages, perhaps aren’t as natural as
examples they see from others.</p><p>In this book we will cover the above topics, giving practical guidance to
understanding bottlenecks and then producing faster and more scalable solutions.
We also include some war stories from those who went ahead of you, who took the
knocks so you don’t have to.</p><p>Python is well-suited for rapid development, production deployments and scalable
systems. The ecosystem is full of people who are working to make it scale on
your behalf, leaving you more time to focus on the more challenging tasks around
you.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_who_this_book_is_for">Who This Book is For</h2></div></div></div><p>You’ve used Python for long enough to have an idea about why certain things are
slow and to have seen technologies like Cython, numpy and PyPy being discussed
as possible solutions. You might also have programmed with other languages and
so know that there’s more than one way to solve a performance problem.</p><p>While this book is primarily aimed at people with a CPU-bound problem, we also
look at data transfer and memory bound solutions. Typically these problems are
faced by scientists, engineers, quants and academics.</p><p>We also look at problems that a web developer might face including the movement
of data and the use of Just in Time compilers like PyPy for easy-win performance
gains.</p><p>It might help if you have a background in C (or C++ or maybe Java), but it isn’t
a pre-requisite. Python’s most common interpreter (CPython - the standard you
normally get if you type <code class="literal">python</code> at the command line) is written in C and so
the hooks and libraries all expose the gory inner C machinery. There are lots of
other techniques that we cover that don’t assume any knowledge of C.</p><p>You might also have a lower level knowledge of the CPU, memory architecture and
data buses but again that’s not strictly necessary.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_who_this_book_is_not_for">Who This Book is Not For</h2></div></div></div><p>This book is meant for intermediate to advanced Python programmers. Motivated
novice Python programmers may be able to follow along as well, but we recommend
having a solid Python foundation.</p><p>We don’t cover storage-system optimization, if you have a SQL or NoSQL
bottleneck then this book probably won’t help you.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_what_you_8217_ll_learn">What You’ll Learn</h2></div></div></div><p>Your authors have been working with large volumes of data, a requirement for <span class="emphasis"><em>I
want the answers faster!</em></span> and a need for scalable architectures for many years
in both industry and academia. We’ll try to impart our hard-won experience to
save you from making the mistakes that we’ve made.</p><p>At the start of each chapter we’ll list questions that the following text should
answer (and if it doesn’t - tell us and we’ll fix that for the next revision!).</p><p>We cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
A background on the machinery of a computer so you know what’s happening behind the scenes
</li><li class="listitem">
Profiling - learn to figure out what is slow or eating all your RAM so you know where to focus your efforts
</li><li class="listitem">
Pure Python approaches - use Python and its modules effectively
</li><li class="listitem">
Matrices with numpy - use the beloved <code class="literal">numpy</code> library like a beast
</li><li class="listitem">
Compilation and Just In Time computing - processing faster by compiling down to machine code, make sure you’re guided by the results of profiling
</li><li class="listitem">
Concurrency - ways to move data efficiently
</li><li class="listitem">
multiprocessing - learn the various ways to use the built-in <code class="literal">multiprocessing</code> library for parallel computing, efficiently share <code class="literal">numpy</code> matrices and learn about inter-process communication (IPC)
</li><li class="listitem">
Cluster computing - convert your <code class="literal">multiprocessing</code> code to run on a local or remote cluster for both research and production systems
</li><li class="listitem">
Using less RAM - approaches to solving large problems without buying a humungous computer
</li><li class="listitem">
Lessons from the Field - lessons encoded in war stories from those who took the blows so you don’t have to
</li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_we_focus_on_python_2_7_on_64_bit_nix_systems">We focus on Python 2.7 on 64-bit *nix Systems</h2></div></div></div><p>Python 2.7 is the dominant version of Python for scientific and engineering
computing. 64-bit is dominant in this field along with *nix environments (often
Linux or Mac). 64-bit lets you address larger amounts of RAM. *nix lets you
build applications that can be deployed and configured in well-understood ways
with well-understood behaviors.</p><p>If you’re a Windows user then you’ll have to buckle-up. Most of what we show
will work just fine, some things are OS specific and you’ll have to research a
Windows solution. The biggest difficulty a Windows user might face is the
installation of modules, research in sites like StackOverflow should give you
the solutions you need. If you’re on Windows then having a virtual machine (e.g.
using VirtualBox) with a running Linux installation might help you to experiment
more freely.</p><p>Windows users should definitely look at a packaged solution like those available through Anaconda, Canopy, Python(x,y), or Sage. These same distributions will make the lives of Linux and Mac users far simpler too.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_moving_to_python_3">Moving to Python 3</h2></div></div></div><p>Python 3 is the future of Python and everyone is moving towards it. Python 2.7 will nonetheless be around for many
years to come (some installations still use Python 2.4 from 2004), the retirement date for Python 2.7 has been set to 2020.</p><p>The shift to
Python 3.3+ has caused enough headaches for library developers that people have
been slow to port their code (with good reason), therefore people have been slow
to adopt Python 3. This is mainly due to the complexities of switching from a mix of string and unicode datatypes in complicated applications to the unicode and byte implementation in Python 3.</p><p>Typically when you want reproducible results based on a set of trusted
libraries, you don’t want to be at the bleeding edge. High performance Python
developers are likely to be using and trusting Python 2.7 for years to come.</p><p>Most of the code in this book will run with little alteration for Python 3.3+
(the most significant change will be with <code class="literal">print</code> turning from a statement into
a function). In a few places we specifically look at improvements that Python
3.3+ provide. One item that might catch you out is the fact that <code class="literal">/</code> means <span class="emphasis"><em>integer</em></span> division in Python 2.7 but it becomes <span class="emphasis"><em>float</em></span> division in Python 3. Of course - being a good developer your well-constructed unit test suite will already be testing your important code paths and so you’ll be alerted by your unit tests if this needs to be addressed in your code.</p><p><code class="literal">scipy</code> and <code class="literal">numpy</code> have been Python 3 compatible since late in 2010, <code class="literal">matplotlib</code> was compatible from 2012, <code class="literal">scikit-learn</code> was compatible in 2013 and <code class="literal">NLTK</code> is expected to be compatible in 2014. Django has been compatible since 2013. Their transition notes are available in their repositories and newsgroups, it is worth reviewing the processes they used if you’re going to migrate older code to Python 3.</p><p>We encourage you to experiment with Python 3.3+ for new projects but to be
cautious with libraries that have only been recently ported and have few users -
you’ll have a harder time tracking down bugs. It would be wise to make your code
Python 3.3+ compatible (learn about the <code class="literal">__future__</code> imports), so a future
 upgrade would be easier.</p><p>Two good guides are “Porting Python 2 Code to Python 3” <sup>[<a id="id300986" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#ftn.id300986" class="footnote totri-footnote">1</a>]</sup> and “Porting to Python 3: An in-depth guide” <sup>[<a id="id611487" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#ftn.id611487" class="footnote totri-footnote">2</a>]</sup>. With a distribution like Anaconda or Canopy you can run both Python 2 and Python 3 simultaneously - this will simplify your porting.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_license">License</h2></div></div></div><p>This book is licensed Creative Commons Attribution-NonCommercial-NoDerivs 3.0
<sup>[<a id="id292351" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#ftn.id292351" class="footnote totri-footnote">3</a>]</sup>.</p><p>You’re welcome to use this book for non-commercial purposes including for
non-commercial teaching. The license only allows for complete reproductions, for
partial reproductions please contact O’Reilly. Please attribute the book as
noted in the following section.</p><p>We negotiated that the book should have a Creative Commons license so the
contents could spread further around the world. We’d be quite happy to receive a
beer if this decision has helped you. We suspect that the O’Reilly staff would
feel similarly about the beer.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_how_to_make_an_attribution">How to Make an Attribution</h2></div></div></div><p>The Creative Commons license requires that you attribute your use of a part of
this book. Attribution just means that you should write something that someone
else can follow to find this book. The following would be sensible: <span class="emphasis"><em>“High
Performance Python, by Micha Gorelick and Ian Ozsvald. Copyright 2014 Micha
Gorelick and Ian Ozsvald.”</em></span>.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_errata_and_feedback">Errata and Feedback</h2></div></div></div><p>We encourage you to review this book on public sites like Amazon, please help
others understand if they’d benefit from this book. You can email us at
<span class="email"><a class="email" href="mailto:feedback@highperformancepython.com">feedback@highperformancepython.com</a></span>.</p><p>We’re particularly keen to hear about errors in the book, successful use-cases where the book has helped you and high performance techniques that we should cover in the next edition.</p><p>Errors and mistakes do occur, errata will be found here (well, we’ll have a link
just as soon as we’ve finished the book…).</p><p>Complaints are welcomed through the instant-complaint-transmission-service <code class="literal">&gt;
/dev/null</code>.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_resources">Resources</h2></div></div></div><p>We’re sure there will be some once we have finished writing the book.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_conventions_used_in_this_book">Conventions Used in This Book</h2></div></div></div><p>The following typographical conventions are used in this book:</p><div class="variablelist"><dl><dt><span class="term">
<span class="emphasis"><em>Italic</em></span>
</span></dt><dd>
Indicates new terms, URLs, email addresses, filenames, and file extensions.
</dd><dt><span class="term">
<code class="literal">Constant width</code>
</span></dt><dd>
Used for program listings, as well as within paragraphs to refer to program elements such as variable or function names, databases, data types, environment variables, statements, and keywords.
</dd><dt><span class="term">
<span class="strong"><strong><code class="literal">Constant width bold</code></strong></span>
</span></dt><dd>
Shows commands or other text that should be typed literally by the user.
</dd><dt><span class="term">
<span class="emphasis"><em><code class="literal">Constant width italic</code></em></span>
</span></dt><dd>
Shows text that should be replaced with user-supplied values or by values determined by context.
</dd></dl></div><div class="tip"><h3 class="title">Tip</h3><p>This element signifies a question or exercise.</p></div><div class="note"><h3 class="title">Note</h3><p>This element signifies a general note.</p></div><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>This element indicates a warning or caution.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_using_code_examples">Using Code Examples</h2></div></div></div><p>Supplemental material (code examples, exercises, etc.) is available for download at <a class="ulink" href="https://github.com/oreillymedia/title_title" target="_top">https://github.com/oreillymedia/title_title</a>.</p><p>This book is here to help you get your job done. In general, if example code is offered with this book, you may use it in your programs and documentation. You do not need to contact us for permission unless you’re reproducing a significant portion of the code. For example, writing a program that uses several chunks of code from this book does not require permission. Selling or distributing a CD-ROM of examples from O’Reilly books does require permission. Answering a question by citing this book and quoting example code does not require permission. Incorporating a significant amount of example code from this book into your product’s documentation does require permission.</p><p>If you feel your use of code examples falls outside fair use or the permission given above, feel free to contact us at <span class="email"><a class="email" href="mailto:permissions@oreilly.com">permissions@oreilly.com</a></span>.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_safari_books_online">Safari® Books Online</h2></div></div></div><div class="note"><h3 class="title">Note</h3><p><a class="ulink" href="http://my.safaribooksonline.com/?portal=oreilly" target="_top">Safari Books Online</a> is an on-demand digital library that delivers expert <a class="ulink" href="http://www.safaribooksonline.com/content" target="_top">content</a> in both book and video form from the world’s leading authors in technology and business.</p></div><p>Technology professionals, software developers, web designers, and business and creative professionals use Safari Books Online as their primary resource for research, problem solving, learning, and certification training.</p><p>Safari Books Online offers a range of <a class="ulink" href="http://www.safaribooksonline.com/subscriptions" target="_top">product mixes</a> and pricing programs for <a class="ulink" href="http://www.safaribooksonline.com/organizations-teams" target="_top">organizations</a>, <a class="ulink" href="http://www.safaribooksonline.com/government" target="_top">government agencies</a>, and <a class="ulink" href="http://www.safaribooksonline.com/individuals" target="_top">individuals</a>. Subscribers have access to thousands of books, training videos, and prepublication manuscripts in one fully searchable database from publishers like O’Reilly Media, Prentice Hall Professional, Addison-Wesley Professional, Microsoft Press, Sams, Que, Peachpit Press, Focal Press, Cisco Press, John Wiley &amp; Sons, Syngress, Morgan Kaufmann, IBM Redbooks, Packt, Adobe Press, FT Press, Apress, Manning, New Riders, McGraw-Hill, Jones &amp; Bartlett, Course Technology, and dozens <a class="ulink" href="http://www.safaribooksonline.com/publishers" target="_top">more</a>. For more information about Safari Books Online, please visit us <a class="ulink" href="http://www.safaribooksonline.com/" target="_top">online</a>.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_how_to_contact_us">How to Contact Us</h2></div></div></div><p>Please address comments and questions concerning this book to the publisher:</p><table style="border: 0; " class="simplelist"><tbody><tr><td>O’Reilly Media, Inc.</td></tr><tr><td>1005 Gravenstein Highway North</td></tr><tr><td>Sebastopol, CA 95472</td></tr><tr><td>800-998-9938 (in the United States or Canada)</td></tr><tr><td>707-829-0515 (international or local)</td></tr><tr><td>707-829-0104 (fax)</td></tr></tbody></table><p>We have a web page for this book, where we list errata, examples, and any additional information. You can access this page at <a class="ulink" href="http://www.oreilly.com/catalog/%3Ccatalog%20page%3E" target="_top">http://www.oreilly.com/catalog/&lt;catalog page&gt;</a>.</p><p>To comment or ask technical questions about this book, send email to <span class="email"><a class="email" href="mailto:bookquestions@oreilly.com">bookquestions@oreilly.com</a></span>.</p><p>For more information about our books, courses, conferences, and news, see our website at <a class="ulink" href="http://www.oreilly.com/" target="_top">http://www.oreilly.com</a>.</p><p>Find us on Facebook: <a class="ulink" href="http://facebook.com/oreilly" target="_top">http://facebook.com/oreilly</a></p><p>Follow us on Twitter: <a class="ulink" href="http://twitter.com/oreillymedia" target="_top">http://twitter.com/oreillymedia</a></p><p>Watch us on YouTube: <a class="ulink" href="http://www.youtube.com/oreillymedia" target="_top">http://www.youtube.com/oreillymedia</a></p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_acknowledgements">Acknowledgements</h2></div></div></div><p>Thanks to Jake Vanderplas, Brian Granger, Dan Foreman-Mackey, Kyran Dale, John
Montgomery, Jamie Matthews, Calvin Giles, William Winter, Christian Schou Oxvig,
Balthazar Rouberol, Matt “snakes” Reiferson, Patrick Cooper and Michael Skirpan
for invaluable feedback and contributions. Ian thanks his wife Emily for letting
him disappear for 10 months to write this (thankfully she’s terribly
understanding).  Micha thanks Elaine and the rest of his friends and family for
being so patient while he learned to write.  O’Reilly are also rather lovely to
work with.</p><p>Our contributors for the Lessons from the Field chapter very kindly shared their
time and hard-won lessons. We give thanks to Ben Jackson, Radim Řehůřek,
Sebastjan Trebca, Alex Kelly, Marko Tasic and Andrew Godwin for their time and
effort.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id300986"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#id300986" class="simpara totri-footnote">1</a>] </sup><a class="ulink" href="https://docs.python.org/3/howto/pyporting.html" target="_top">https://docs.python.org/3/howto/pyporting.html</a></p></div><div class="footnote" id="ftn.id611487"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#id611487" class="simpara totri-footnote">2</a>] </sup><a class="ulink" href="http://python3porting.com/" target="_top">http://python3porting.com/</a></p></div><div class="footnote" id="ftn.id292351"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#id292351" class="simpara totri-footnote">3</a>] </sup><a class="ulink" href="http://creativecommons.org/licenses/by-nc-nd/3.0/" target="_top">http://creativecommons.org/licenses/by-nc-nd/3.0/</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/index.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">High Performance Python</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch01.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">1. Understanding Performant Python</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/pr01.html" data-for-analytics="9781449361747:pr01.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/pr01.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>
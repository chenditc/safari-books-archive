<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/streaming-systems/9781491983867/ch03.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="3905629"
  data-user-uuid="f04af719-1c84-4fc3-9be3-1f1b4622ab99"
  data-username="safaribooksonline122"
  data-account-type="Trial"
  
  data-activated-trial-date="12/09/2018"


  data-archive="9781491983867"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch03.html"
  data-epub-title="Streaming Systems" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class="js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/streaming-systems/9781491983867/ch03.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="3905629" data-user-uuid="f04af719-1c84-4fc3-9be3-1f1b4622ab99" data-username="safaribooksonline122" data-account-type="Trial" data-activated-trial-date="12/09/2018" data-archive="9781491983867" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch03.html" data-epub-title="Streaming Systems" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781491983867"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.0c29511d2d72.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>3. Watermarks - Streaming Systems</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/5e586a47a3b7.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.e3b0c44298fc.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td,#sbo-rt-content article,#sbo-rt-content aside,#sbo-rt-content canvas,#sbo-rt-content details,#sbo-rt-content embed,#sbo-rt-content figure,#sbo-rt-content figcaption,#sbo-rt-content footer,#sbo-rt-content header,#sbo-rt-content hgroup,#sbo-rt-content menu,#sbo-rt-content nav,#sbo-rt-content output,#sbo-rt-content ruby,#sbo-rt-content section,#sbo-rt-content summary,#sbo-rt-content time,#sbo-rt-content mark,#sbo-rt-content audio,#sbo-rt-content video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}#sbo-rt-content article,#sbo-rt-content aside,#sbo-rt-content details,#sbo-rt-content figcaption,#sbo-rt-content figure,#sbo-rt-content footer,#sbo-rt-content header,#sbo-rt-content hgroup,#sbo-rt-content menu,#sbo-rt-content nav,#sbo-rt-content section{display:block}#sbo-rt-content div{line-height:1}#sbo-rt-content ol,#sbo-rt-content ul{list-style:none}#sbo-rt-content blockquote,#sbo-rt-content q{quotes:none}#sbo-rt-content blockquote:before,#sbo-rt-content blockquote:after,#sbo-rt-content q:before,#sbo-rt-content q:after{content:none}#sbo-rt-content table{border-collapse:collapse;border-spacing:0}@page{margin:5px !important}#sbo-rt-content p{margin:10px 0 0;line-height:125%;text-align:left}#sbo-rt-content p.byline{text-align:left;margin:-33px auto 35px;font-style:italic;font-weight:bold}#sbo-rt-content div.preface p+p.byline{margin:1em 0 0 !important}#sbo-rt-content div.preface p.byline+p.byline{margin:0 !important}#sbo-rt-content div.sect1>p.byline{margin:-.25em 0 1em}#sbo-rt-content div.sect1>p.byline+p.byline{margin-top:-1em}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link,#sbo-rt-content a{text-decoration:none;color:#8e0012}#sbo-rt-content span.lineannotation{font-style:italic;color:#a62a2a;font-family:serif}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#fff}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important;margin-bottom:30px !important}#sbo-rt-content section[data-type="sect1"] h1{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content section[data-type="sect2"] h2{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content section[data-type="sect3"] h3{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content section[data-type="sect4"] h4{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section[data-type="chapter"]>div>h1,#sbo-rt-content section[data-type="preface"]>div>h1,#sbo-rt-content section[data-type="appendix"]>div>h1,#sbo-rt-content section[data-type="glossary"]>div>h1,#sbo-rt-content section[data-type="bibliography"]>div>h1,#sbo-rt-content section[data-type="index"]>div>h1{font-size:2em;line-height:1;margin-bottom:50px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content span.label,#sbo-rt-content span.keep-together{font-size:inherit;font-weight:inherit}#sbo-rt-content div[data-type="part"] h1{font-size:2em;text-align:center;margin-top:0 !important;margin-bottom:50px;padding:50px 0 10px 0;border-bottom:1px solid #000}#sbo-rt-content img.width-ninety{width:90%}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center !important;margin:15px 0 15px 0 !important;page-break-inside:avoid}#sbo-rt-content figure{margin:15px 0 15px 0 !important;page-break-inside:avoid}#sbo-rt-content div.figure h6,#sbo-rt-content figure h6,#sbo-rt-content figure figcaption{font-size:.9rem !important;text-align:center;font-weight:normal !important;font-style:italic;font-family:serif !important;text-transform:none !important;letter-spacing:normal !important;color:#000 !important;padding-top:10px !important;page-break-before:avoid}#sbo-rt-content div.informalfigure{text-align:center !important;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:15px 0 10px 0 !important;border:1px solid #DCDCDC;background-color:#F7F7F7;padding:15px !important;page-break-inside:avoid}#sbo-rt-content aside[data-type="sidebar"]{margin:15px 0 10px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title,#sbo-rt-content aside[data-type="sidebar"] h5{font-weight:bold;font-size:1em;font-family:sans-serif;text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar ol,#sbo-rt-content div.sidebar ul,#sbo-rt-content aside[data-type="sidebar"] ol,#sbo-rt-content aside[data-type="sidebar"] ul{margin-left:1.25em !important}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content aside[data-type="sidebar"] figcaption,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif !important;color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div[data-type="tip"],#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div[data-type="note"],#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div[data-type="warning"],#sbo-rt-content div.sidebar div[data-type="caution"],#sbo-rt-content div.sidebar div[data-type="important"]{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content aside[data-type="sidebar"] p.byline{font-size:90%;font-weight:bold;font-style:italic;text-align:center;text-indent:0;margin:5px auto 6px;page-break-after:avoid}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;overflow-wrap:break-word}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;overflow-wrap:break-word}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div[data-type="example"]{margin:10px 0 15px 0 !important}#sbo-rt-content div[data-type="example"] h1,#sbo-rt-content div[data-type="example"] h2,#sbo-rt-content div[data-type="example"] h3,#sbo-rt-content div[data-type="example"] h4,#sbo-rt-content div[data-type="example"] h5,#sbo-rt-content div[data-type="example"] h6{font-style:italic;font-weight:normal;text-align:left !important;text-transform:none !important;font-family:serif !important;margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div[data-type="example"] pre[data-type="programlisting"],#sbo-rt-content div[data-type="example"] pre[data-type="screen"]{margin:0}#sbo-rt-content section[data-type="titlepage"]>div>h1{font-size:2em;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content section[data-type="titlepage"] h2,#sbo-rt-content section[data-type="titlepage"] p.subtitle,#sbo-rt-content section[data-type="titlepage"] p[data-type="subtitle"]{font-size:1.3em;font-weight:normal;text-align:center;margin-top:.5em;color:#555}#sbo-rt-content section[data-type="titlepage"]>div>h2[data-type="author"],#sbo-rt-content section[data-type="titlepage"] p.author{font-size:1.3em;font-family:serif !important;font-weight:bold;margin:50px 0 !important;text-align:center}#sbo-rt-content section[data-type="titlepage"] p.edition{text-align:center;text-transform:uppercase;margin-top:2em}#sbo-rt-content section[data-type="titlepage"]{text-align:center}#sbo-rt-content section[data-type="titlepage"]:after{content:url(css_assets/titlepage_footer_ebook.png);margin:0 auto;max-width:80%}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content ul.stafflist{margin:15px 0 15px 20px !important}#sbo-rt-content ul.stafflist li{list-style-type:none;padding:5px 0}#sbo-rt-content ul.printings li{list-style-type:none}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif !important;font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif !important;margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10px}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif !important}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-style:italic;margin:.75em 0 0 !important}#sbo-rt-content blockquote div.attribution,#sbo-rt-content blockquote p[data-type="attribution"]{margin:5px 0 10px 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p,#sbo-rt-content blockquote p[data-type="attribution"]{font-style:normal;margin-top:5px}#sbo-rt-content blockquote div.attribution p:before,#sbo-rt-content blockquote p[data-type="attribution"]:before{font-style:normal;content:"—";-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div[data-type="footnotes"]{border-top:1px solid black;margin-top:1.5em}#sbo-rt-content sub,#sbo-rt-content sup{font-size:75%;line-height:0;position:relative}#sbo-rt-content sup{top:-.5em}#sbo-rt-content sub{bottom:-.25em}#sbo-rt-content div.refentry p.refname{font-size:1em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin-bottom:5px;overflow:auto;width:100%}#sbo-rt-content div.refentry{width:100%;display:block;margin-top:2em}#sbo-rt-content div.refsynopsisdiv{display:block;clear:both}#sbo-rt-content div.refentry header{page-break-inside:avoid !important;display:block;break-inside:avoid !important;padding-top:0;border-bottom:1px solid #000}#sbo-rt-content div.refsect1 h6{font-size:.9em;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content div.refsect1{margin-top:3em}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dd{margin-left:1.5em !important;margin-bottom:.25em}#sbo-rt-content dd ol,#sbo-rt-content dd ul{padding-left:1em}#sbo-rt-content dd li{margin-top:0;margin-bottom:0}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ul,#sbo-rt-content ul>li,#sbo-rt-content ol ul,#sbo-rt-content ol ul>li,#sbo-rt-content ul ol ul,#sbo-rt-content ul ol ul>li{list-style-type:disc}#sbo-rt-content ul ul,#sbo-rt-content ul ul>li{list-style-type:square}#sbo-rt-content ul ul ul,#sbo-rt-content ul ul ul>li{list-style-type:circle}#sbo-rt-content ol,#sbo-rt-content ol>li,#sbo-rt-content ol ul ol,#sbo-rt-content ol ul ol>li,#sbo-rt-content ul ol,#sbo-rt-content ul ol>li{list-style-type:decimal}#sbo-rt-content ol ol,#sbo-rt-content ol ol>li{list-style-type:lower-alpha}#sbo-rt-content ol ol ol,#sbo-rt-content ol ol ol>li{list-style-type:lower-roman}#sbo-rt-content ol,#sbo-rt-content ul{list-style-position:outside;margin:15px 0 15px 1.25em;padding-left:2.25em}#sbo-rt-content ol li,#sbo-rt-content ul li{margin:.5em 0 .65em;line-height:125%}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist,#sbo-rt-content ul.simplelist{margin:15px 0 15px 20px !important}#sbo-rt-content ul.simplelist li{list-style-type:none;padding:5px 0}#sbo-rt-content table.simplelist td{border:none}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content dl.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content dl.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content dl.calloutlist img,#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div[data-type="tip"],#sbo-rt-content div.note,#sbo-rt-content div[data-type="note"],#sbo-rt-content div.warning,#sbo-rt-content div[data-type="warning"],#sbo-rt-content div[data-type="caution"],#sbo-rt-content div[data-type="important"]{margin:30px !important;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip ol,#sbo-rt-content div.tip ul,#sbo-rt-content div[data-type="tip"] ol,#sbo-rt-content div[data-type="tip"] ul,#sbo-rt-content div.note ol,#sbo-rt-content div.note ul,#sbo-rt-content div[data-type="note"] ol,#sbo-rt-content div[data-type="note"] ul,#sbo-rt-content div.warning ol,#sbo-rt-content div.warning ul,#sbo-rt-content div[data-type="warning"] ol,#sbo-rt-content div[data-type="warning"] ul,#sbo-rt-content div[data-type="caution"] ol,#sbo-rt-content div[data-type="caution"] ul,#sbo-rt-content div[data-type="important"] ol,#sbo-rt-content div[data-type="important"] ul{margin-left:1.5em !important}#sbo-rt-content div.tip,#sbo-rt-content div[data-type="tip"],#sbo-rt-content div.note,#sbo-rt-content div[data-type="note"]{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div[data-type="warning"],#sbo-rt-content div[data-type="caution"],#sbo-rt-content div[data-type="important"]{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div[data-type="tip"] h6,#sbo-rt-content div[data-type="tip"] h1,#sbo-rt-content div.note h3,#sbo-rt-content div[data-type="note"] h6,#sbo-rt-content div[data-type="note"] h1,#sbo-rt-content div.warning h3,#sbo-rt-content div[data-type="warning"] h6,#sbo-rt-content div[data-type="warning"] h1,#sbo-rt-content div[data-type="caution"] h6,#sbo-rt-content div[data-type="caution"] h1,#sbo-rt-content div[data-type="important"] h1,#sbo-rt-content div[data-type="important"] h6{font-weight:bold;font-size:110%;font-family:sans-serif !important;text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div[data-type="tip"] figure h6,#sbo-rt-content div[data-type="note"] figure h6,#sbo-rt-content div[data-type="warning"] figure h6,#sbo-rt-content div[data-type="caution"] figure h6,#sbo-rt-content div[data-type="important"] figure h6{font-family:serif !important}#sbo-rt-content div.tip h3,#sbo-rt-content div[data-type="tip"] h6,#sbo-rt-content div.note h3,#sbo-rt-content div[data-type="note"] h6,#sbo-rt-content div[data-type="tip"] h1,#sbo-rt-content div[data-type="note"] h1{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div[data-type="warning"] h6,#sbo-rt-content div[data-type="caution"] h6,#sbo-rt-content div[data-type="important"] h6,#sbo-rt-content div[data-type="warning"] h1,#sbo-rt-content div[data-type="caution"] h1,#sbo-rt-content div[data-type="important"] h1{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note,#sbo-rt-content div.safarienabled{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3,#sbo-rt-content div.safarienabled h6{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px 0 30px 0 !important;max-width:95%;border:none !important;background:none;display:table !important}#sbo-rt-content div.table,#sbo-rt-content div.informaltable,#sbo-rt-content table{page-break-inside:avoid}#sbo-rt-content tr,#sbo-rt-content tr td{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td,#sbo-rt-content thead th{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif;font-weight:bold}#sbo-rt-content td,#sbo-rt-content th{display:table-cell;padding:.3em;text-align:left;vertical-align:middle;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title,#sbo-rt-content table caption{font-weight:normal;font-style:italic;font-family:serif;font-size:1em;margin:10px 0 10px 0 !important;padding:0;page-break-after:avoid;text-align:left !important}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation,#sbo-rt-content div[data-type="equation"]{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title,#sbo-rt-content div[data-type="equation"] h5{font-style:italic;font-weight:normal;font-family:serif !important;font-size:90%;margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content div[data-type="equation"] math{font-size:calc(.35em + 1vw)}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{text-indent:0}#sbo-rt-content div.index h3{padding:.25em;margin-top:1em !important;background-color:#F0F0F0}#sbo-rt-content div.index li{line-height:130%;list-style-type:none}#sbo-rt-content div.index a.indexterm{color:#8e0012 !important}#sbo-rt-content div.index ul{margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.index ul ul{margin-left:1em !important;margin-top:0 !important}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif;text-align:left}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content .what_lt{color:#c90;}#sbo-rt-content .where_lt{color:#26c}#sbo-rt-content .when_lt{color:#6a5;}#sbo-rt-content .how_lt{color:#c00}#sbo-rt-content .what_dk{color:#ffd040}#sbo-rt-content .where_dk{color:#6af}#sbo-rt-content .when_dk{color:#8ac86f}#sbo-rt-content .how_dk{color:#d77}#sbo-rt-content .grey_bg{background-color:#ff0}#sbo-rt-content .yellow_bg{background-color:#ff0}#sbo-rt-content .green_bg{background-color:#00FF7F}#sbo-rt-content .red_bg{background-color:#FFA07A}#sbo-rt-content .blue_bg{background-color:#87CEEB}#sbo-rt-content .code_blue{color:#00f}#sbo-rt-content .code_grey{color:#777}#sbo-rt-content .code_orange{color:#d83}#sbo-rt-content .code_purple{color:#87c}#sbo-rt-content .code_lightgrey{color:#C0C0C0}#sbo-rt-content .strikethrough{text-decoration:line-through}#sbo-rt-content .table_white{color:white}#sbo-rt-content .table_black{color:black}#sbo-rt-content .table_red{color:#d77}#sbo-rt-content .table_green{color:#8ac86f}#sbo-rt-content .table_blue{color:#00f}#sbo-rt-content .table_mediumgrey{background-color:#404040}#sbo-rt-content .table_lightgrey{background-color:#606060}#sbo-rt-content .table_darkgrey{background-color:#202020}
    </style><link rel="canonical" href="/site/library/view/streaming-systems/9781491983867/ch03.html"><meta name="description" content=" Chapter 3. Watermarks So far, we have been looking at stream processing from the perspective of the pipeline author or data scientist. Chapter&nbsp;2 introduced watermarks as part of the ... "><meta property="og:title" content="3. Watermarks"><meta itemprop="isPartOf" content="/library/view/streaming-systems/9781491983867/"><meta itemprop="name" content="3. Watermarks"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch03.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781491983867/"><meta property="og:description" itemprop="description" content=" Chapter 3. Watermarks So far, we have been looking at stream processing from the perspective of the pipeline author or data scientist. Chapter&nbsp;2 introduced watermarks as part of the ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781491983874"><meta property="og:book:author" itemprop="author" content="Reuven Lax"><meta property="og:book:author" itemprop="author" content="Slava Chernyak"><meta property="og:book:author" itemprop="author" content="Tyler Akidau"><meta property="og:book:tag" itemprop="about" content="Databases"><meta property="og:book:tag" itemprop="about" content="Engineering"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts subscribe-panel library" data-gr-c-s-loaded="true">

    
  
  
  



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        





<a href="/site/library/view/streaming-systems/9781491983867/ch03.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/playlists/" class="t-queue-nav l0 nav-icn None"><!--?xml version="1.0" encoding="UTF-8"?--><svg width="21px" height="17px" viewBox="0 0 21 17" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 46.2 (44496) - http://www.bohemiancoding.com/sketch --><title>icon_Playlist_sml</title><desc>Created with Sketch.</desc><defs></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="icon_Playlist_sml" fill-rule="nonzero" fill="#000000"><g id="playlist-icon"><g id="Group-6"><rect id="Rectangle-path" x="5" y="0" width="16" height="3" rx="0.5"></rect><circle id="Oval" cx="1.5" cy="1.5" r="1.5"></circle></g><g id="Group-5" transform="translate(0.000000, 7.000000)"><circle id="Oval" cx="1.5" cy="1.5" r="1.5"></circle><rect id="Rectangle-path" x="5" y="0" width="16" height="3" rx="0.5"></rect></g><g id="Group-5-Copy" transform="translate(0.000000, 14.000000)"><circle id="Oval" cx="1.5" cy="1.5" r="1.5"></circle><rect id="Rectangle-path" x="5" y="0" width="16" height="3" rx="0.5"></rect></g></g></g></g></svg><span>
               Playlists
            </span></a></li><li class="search"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" width="20" height="20" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>offers icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M35.9 20.6L27 15.5C26.1 15 24.7 15 23.7 15.5L14.9 20.6C13.9 21.1 13.2 22.4 13.2 23.4L13.2 41.4C13.2 42.4 13.9 43.7 14.9 44.2L23.3 49C24.2 49.5 25.6 49.5 26.6 49L35.9 43.6C36.8 43.1 37.6 41.8 37.6 40.8L37.6 23.4C37.6 22.4 36.8 21.1 35.9 20.6L35.9 20.6ZM40 8.2C39.1 7.6 37.6 7.6 36.7 8.2L30.2 11.9C29.3 12.4 29.3 13.2 30.2 13.8L39.1 18.8C40 19.4 40.7 20.6 40.7 21.7L40.7 39C40.7 40.1 41.4 40.5 42.4 40L48.2 36.6C49.1 36.1 49.8 34.9 49.8 33.8L49.8 15.6C49.8 14.6 49.1 13.3 48.2 12.8L40 8.2 40 8.2ZM27 10.1L33.6 6.4C34.5 5.9 34.5 5 33.6 4.5L26.6 0.5C25.6 0 24.2 0 23.3 0.5L16.7 4.2C15.8 4.7 15.8 5.6 16.7 6.1L23.7 10.1C24.7 10.6 26.1 10.6 27 10.1ZM10.1 21.7C10.1 20.6 10.8 19.4 11.7 18.8L20.6 13.8C21.5 13.2 21.5 12.4 20.6 11.9L13.6 7.9C12.7 7.4 11.2 7.4 10.3 7.9L1.6 12.8C0.7 13.3 0 14.6 0 15.6L0 33.8C0 34.9 0.7 36.1 1.6 36.6L8.4 40.5C9.3 41 10.1 40.6 10.1 39.6L10.1 21.7 10.1 21.7Z"></path></g></svg><span>Offers &amp; Deals</span></a><ul class="flyout"><li><a href="https://get.oreilly.com/email-signup.html" target="_blank" class="l2 nav-icn"><span>Newsletters</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/f04af719-1c84-4fc3-9be3-1f1b4622ab99/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" width="20" height="20" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/preferences/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://www.oreilly.com/online-learning/support/" class="l1 no-icon">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/preferences/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a><span class="l2 t-nag-notification" id="nav-nag"><strong class="trial-green">10</strong> days left in your trial.
  
  

  
    
      

<a class="" href="https://www.safaribooksonline.com/subscribe/">Subscribe</a>.


    
  

  

</span></li><li><a href="https://www.oreilly.com/online-learning/support/" class="l2">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Streaming Systems
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9781491983867/chapter/ch03.html"><div class="js-collections-dropdown collections-dropdown menu-bit-cards"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="https://www.safaribooksonline.com/static/images/ajax-transp.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch03.html&amp;text=Streaming%20Systems&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch03.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch03.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%203.%20Watermarks&amp;body=https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch03.html%0D%0Afrom%20Streaming%20Systems%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
        
        



 <!--[if lt IE 9]>
  
<![endif]-->



  


        
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/site/library/view/streaming-systems/9781491983867/ch02.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">2. The What, Where, When, and How of Data Processing</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/site/library/view/streaming-systems/9781491983867/ch04.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">4. Advanced Windowing</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content" style="transform: none;"><div class="annotator-wrapper"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 3. Watermarks"><div class="chapter" id="watermarks_chapter">
<h1><span class="label">Chapter 3. </span>Watermarks</h1>

<p>So far, we have been looking at stream processing from the perspective of the pipeline author <a contenteditable="false" data-primary="watermarks" data-type="indexterm" id="ix_wtrmk3"></a>or data scientist. <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch02.html#the_what_where_when_and_how">Chapter&nbsp;2</a> introduced watermarks as part of the answer to the fundamental questions of <span class="where_lt"><em>where</em></span> in event-time processing is taking place and <span class="when_lt"><em>when</em></span> in processing time results are materialized. In this chapter, we approach the same questions, but instead from the perspective of the underlying mechanics of the stream processing system. Looking at these mechanics will help us motivate, understand, and apply the concepts around watermarks. We discuss how watermarks are created at the point of data ingress, how they propagate through a data processing pipeline, and how they affect output timestamps. We also demonstrate how watermarks preserve the guarantees that are necessary for answering the questions of <span class="where_lt"><em>where</em></span> in event-time data are processed and <span class="when_lt"><em>when</em></span> it is materialized, while dealing with unbounded data.</p>

<section data-type="sect1" data-pdf-bookmark="Definition"><div class="sect1" id="idm140176522657456">
<h1>Definition</h1>

<p>Consider any pipeline that ingests data and outputs results continuously. <a contenteditable="false" data-primary="watermarks" data-secondary="about" data-type="indexterm" id="idm140176522655760"></a>We wish to solve the general problem of when it is safe to call an event-time window closed, meaning that the window does not expect any more data. To do so we would like to characterize the progress that the pipeline is making relative to its unbounded input.</p>

<p>One naive approach for solving the event-time windowing problem would be to <span class="keep-together">simply</span> base our event-time windows on the current processing time. As we saw in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch01.html#streaming_one_oh_one">Chapter&nbsp;1</a>, we quickly run into trouble—data processing and transport is not instantaneous, so processing and event times are almost never equal. Any hiccup or spike in our pipeline might cause us to incorrectly assign messages to windows. Ultimately, this strategy fails because we have no robust way to make any guarantees about such windows.</p>

<p>Another intuitive, but ultimately incorrect, approach would be to consider the rate of messages processed by the pipeline. Although this is an interesting metric, the rate may vary arbitrarily with changes in input, variability of expected results, resources available for processing, and so on. Even more important, rate does not help answer the fundamental questions of completeness. Specifically, rate does not tell us when we have seen all of the messages for a particular time interval. In a real-world system, there will be situations in which messages are not making progress through the system. This could be the result of transient errors (such as crashes, network failures, machine downtime), or the result of persistent errors such as application-level failures that require changes to the application logic or other manual intervention to resolve. Of course, if lots of failures are occurring, a rate-of-processing metric might be a good proxy for detecting this. However a rate metric could never tell us that a single message is failing to make progress through our pipeline. Even a single such message, however, can arbitrarily affect the correctness of the output results.</p>

<p>We require a more robust measure of progress. To arrive there, we make one fundamental assumption about <a contenteditable="false" data-primary="timestamps" data-secondary="event" data-type="indexterm" id="idm140176522649408"></a>our streaming data: <em>each message has an associated logical event timestamp</em>. This assumption is reasonable in the context of continuously arriving unbounded data because this implies the continuous generation of input data. In most cases, we can take the time of the original event’s occurrence as its logical event timestamp. With all input messages containing an event timestamp, we can then examine the distribution of such timestamps in any pipeline. Such a pipeline might be distributed to process in parallel over many agents and consuming input messages with no guarantee of ordering between individual shards. Thus, the set of event timestamps for active in-flight messages in this pipeline will form a distribution, as illustrated in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#example_distribution_of_in_flight_and_complete_message_event_times">Figure&nbsp;3-1</a>.</p>

<p>Messages are ingested by the pipeline, processed, and eventually marked completed. Each message is either “in-flight,” meaning that it has been received but not yet completed, or “completed,” meaning that no more processing on behalf of this message is required. If we examine the distribution of messages by event time, it will look<a contenteditable="false" data-primary="event time" data-secondary="distribution of messages by" data-type="indexterm" id="idm140176522644944"></a> something like <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#example_distribution_of_in_flight_and_complete_message_event_times">Figure&nbsp;3-1</a>. As time advances, more messages will be added to the “in-flight” distribution on the right, and more of those messages from the “in-flight” part of the distribution will be completed and moved into the “completed” distribution.</p>

<figure><div id="example_distribution_of_in_flight_and_complete_message_event_times" class="figure">
<video style="margin: 0 auto; max-width: 100%;" controls="controls" poster="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0301.png" autoplay="autoplay" loop="loop">
<source src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0301.mp4" type="video/mp4"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0301.png" alt="Distribution of in-flight and completed message event times within a streaming pipeline. New messages arrive as input and remain “in-flight” until processing for them completes. The leftmost edge of the “in-flight” distribution corresponds to the oldest unprocessed element at any given moment." width="600" height="588" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0301.png">
</video>
<h6><span class="label">Figure 3-1. </span>Distribution of in-flight and completed message event times within a streaming pipeline. New messages arrive as input and remain “in-flight” until processing for them completes. The leftmost edge of the “in-flight” distribution corresponds to the oldest unprocessed element at any given moment.</h6>
</div></figure>

<p>There is a key point on this distribution, located at the leftmost edge of the “in-flight” distribution, corresponding to the oldest event timestamp of any unprocessed message of our pipeline. We use this value to define the watermark:</p>

<blockquote>
<p>The watermark is a monotonically<sup><a data-type="noteref" id="idm140176522635488-marker" href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522635488" class="totri-footnote">1</a></sup> increasing timestamp of the oldest work not yet completed.</p>
</blockquote>

<p>There are two fundamental<a contenteditable="false" data-primary="timestamps" data-secondary="watermarks and" data-type="indexterm" id="idm140176522633424"></a> properties that are provided by this definition that make it useful:</p>

<dl>
	<dt>Completeness</dt>
	<dd>
	<p>If the watermark has advanced past some timestamp <em>T</em>, we are guaranteed by its monotonic property that no more processing will occur for on-time (nonlate data) events at or before <em>T</em>.<a contenteditable="false" data-primary="completeness" data-secondary="concept provided by watermarks" data-type="indexterm" id="idm140176522629264"></a> Therefore, we can correctly emit any aggregations at or before <em>T</em>. In other words, the watermark allows us to know when it is correct to close a window.</p>
	</dd>
	<dt>Visibility</dt>
	<dd>
	<p>If a message is stuck in our pipeline for any reason, the watermark cannot advance. <a contenteditable="false" data-primary="visibility (watermarks)" data-type="indexterm" id="idm140176522625856"></a>Furthermore, we will be able to find the source of the problem by examining the message that is preventing the watermark from advancing.</p>
	</dd>
</dl>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Source Watermark Creation"><div class="sect1" id="idm140176522656864">
<h1>Source Watermark Creation</h1>

<p>Where do these watermarks come from? To establish <a contenteditable="false" data-primary="watermarks" data-secondary="source watermark creation" data-type="indexterm" id="ix_wtrmk3src"></a>a watermark for a data source, we must assign a logical event timestamp to every message entering the pipeline from that source. As <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch02.html#the_what_where_when_and_how">Chapter&nbsp;2</a> informs us, all watermark creation falls<a contenteditable="false" data-primary="perfect watermarks" data-type="indexterm" id="idm140176522619360"></a> into one <a contenteditable="false" data-primary="heuristic watermarks" data-type="indexterm" id="idm140176522618160"></a>of two broad categories: <em>perfect</em> or <em>heuristic</em>. To remind ourselves about the difference between perfect and heuristic watermarks, let’s look at <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#windowed_summation_with_perfect_left_and_heuristic_right_watermarks">Figure&nbsp;3-2</a>, which presents the windowed summation example from <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch02.html#the_what_where_when_and_how">Chapter&nbsp;2</a>.</p>


<figure><div id="windowed_summation_with_perfect_left_and_heuristic_right_watermarks" class="figure">
<video style="margin: 0 auto; max-width: 100%;" controls="controls" poster="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0302.png" autoplay="autoplay" loop="loop">
<source src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0302.mp4" type="video/mp4"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0302.png" alt="Windowed summation with perfect (left) and heuristic (right) watermarks" width="540" height="800" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0302.png">
</video>
<h6><span class="label">Figure 3-2. </span>Windowed summation with perfect (left) and heuristic (right) watermarks</h6>
</div></figure>

<p>Notice that the distinguishing feature is that perfect watermarks ensure that the watermark accounts for <em>all</em> data, whereas heuristic watermarks admit some late-data elements.</p>

<p>After the watermark is created as either perfect or heuristic, watermarks remain so throughout the rest of the pipeline. As to what makes watermark creation perfect or heuristic, it depends a great deal on the nature of the source that’s being consumed. To see why, let’s look at a few examples of each type of watermark creation.</p>

<section data-type="sect2" data-pdf-bookmark="Perfect Watermark Creation"><div class="sect2" id="idm140176522607280">
<h2>Perfect Watermark Creation</h2>

<p>Perfect watermark creation assigns timestamps to incoming messages in such a way that the <a contenteditable="false" data-primary="watermarks" data-secondary="source watermark creation" data-tertiary="perfect watermarks" data-type="indexterm" id="idm140176522605872"></a>resulting<a contenteditable="false" data-primary="perfect watermarks" data-secondary="creation of" data-type="indexterm" id="idm140176522604032"></a> watermark is a <em>strict guarantee</em> that no data with event times less than the watermark will ever be seen again from this source. <a contenteditable="false" data-primary="late data" data-secondary="and perfect watermarks" data-type="indexterm" id="idm140176522601936"></a>Pipelines using perfect watermark creation never have to deal with late data; that is, data that arrive after the watermark has advanced past the event times of newly arriving messages. However, perfect watermark creation requires perfect knowledge of the input, and thus is impractical for many real-world distributed input sources. Here are a couple of examples of use cases that can create perfect watermarks:</p>

<dl>
	<dt>Ingress timestamping</dt>
	<dd>
	<p>A source that assigns ingress times as the event times for data entering the system can create a perfect watermark.<a contenteditable="false" data-primary="ingress timestamping, watermark creation by" data-type="indexterm" id="idm140176522598368"></a><a contenteditable="false" data-primary="perfect watermarks" data-secondary="creation of" data-tertiary="by ingress timestamping" data-type="indexterm" id="idm140176522597072"></a> In this case, the source watermark simply tracks the current processing time as observed by the pipeline. This is essentially the method that nearly all streaming systems supporting windowing prior to 2016 used.</p>

	<p>Because event times are assigned from a single, monotonically increasing source (actual processing time), the system thus has perfect knowledge about which timestamps will come next in the stream of data. As a result, event-time progress and windowing semantics become vastly easier to reason about. The downside, of course, is that the watermark has no correlation to the event times of the data themselves; those event times were effectively discarded, and the watermark instead merely tracks the progress of data relative to its arrival in the system.</p>
	</dd>
	<dt>Static sets of time-ordered logs</dt>
	<dd>
	<p>A statically sized<sup><a data-type="noteref" id="idm140176522592800-marker" href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522592800" class="totri-footnote">2</a></sup> input source of time-ordered logs (e.g., an Apache Kafka topic with a static set of partitions, where each <a contenteditable="false" data-primary="logs" data-secondary="static sets of time-ordered logs, creation of watermarks" data-type="indexterm" id="idm140176522590624"></a>partition of the source contains monotonically increasing event times) would be relatively straightforward source atop which to create a perfect watermark. To do so, the source would simply track the minimum event time of unprocessed data across the known and static set of source partitions (i.e., the minimum of the event times of the most recently read record in each of the partitions).</p>

	<p>Similar to the aforementioned ingress timestamps, the system has perfect knowledge about which timestamps will come next, thanks to the fact that event times across the static set of partitions are known to increase monotonically. This is effectively a form of bounded out-of-order processing; the amount of disorder across the known set of partitions is bounded by the minimum observed event time among those partitions.</p>

	<p>Typically, the only way you can guarantee monotonically increasing timestamps within partitions is if the timestamps within those partitions are assigned as data are written to it; for example, by web frontends logging events directly into Kafka. Though still a limited use case, this is definitely a much more useful one than ingress timestamping upon arrival at the data processing system because the watermark tracks meaningful event times of the underlying data.</p>
	</dd>
</dl>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Heuristic Watermark Creation"><div class="sect2" id="idm140176522586448">
<h2>Heuristic Watermark Creation</h2>

<p>Heuristic watermark creation, on the other hand, creates a watermark that is merely an <em>estimate</em> that no data with event times less than the watermark will ever be seen again.<a contenteditable="false" data-primary="heuristic watermarks" data-secondary="creation of" data-type="indexterm" id="idm140176522584448"></a><a contenteditable="false" data-primary="watermarks" data-secondary="source watermark creation" data-tertiary="heuristic watermarks" data-type="indexterm" id="idm140176522583072"></a> Pipelines using heuristic watermark creation might need to deal with some amount of <em>late data</em>.<a contenteditable="false" data-primary="late data" data-secondary="and heuristic watermarks" data-type="indexterm" id="idm140176522580816"></a> Late data is any data that arrives after the watermark has advanced past the event time of this data. Late data is only possible with heuristic watermark creation. If the heuristic is a reasonably good one, the amount of late data might be very small, and the watermark remains useful as a completion estimate. The system still needs to provide a way for the user to cope with late data if it’s to support use cases requiring correctness (e.g., things like billing).</p>

<p>For many real-world, distributed input sources, it’s computationally or operationally impractical to construct a perfect watermark, but still possible to build a highly accurate heuristic watermark by taking advantage of structural features of the input data source. Following are two example for which heuristic watermarks (of varying quality) are possible:</p>

<dl>
	<dt>Dynamic sets of time-ordered logs</dt>
	<dd>
	<p>Consider a dynamic set of structured log files (each individual file containing records with monotonically increasing event times relative to other records in the same<a contenteditable="false" data-primary="logs" data-secondary="dymanic sets of time-ordered logs, watermark creation from" data-type="indexterm" id="idm140176522576336"></a> file but with<a contenteditable="false" data-primary="heuristic watermarks" data-secondary="creation of" data-tertiary="from dynamic sets of time-ordered logs" data-type="indexterm" id="idm140176522574688"></a> no fixed relationship of event times between files), where the full set of expected log files (i.e., partitions, in Kafka parlance) is not known at runtime. Such inputs are often found in global-scale services constructed and managed by a number of independent teams. In such a use case, creating a perfect watermark over the input is intractable, but creating an accurate heuristic watermark is quite possible.</p>

	<p>By tracking the minimum event times of unprocessed data in the existing set of log files, monitoring growth rates, and utilizing external information like network topology and bandwidth availability, you can create a remarkably accurate watermark, even given the lack of perfect knowledge of all the inputs. This type of input source is one of the most common types of unbounded datasets found at Google, so we have extensive experience with creating and analyzing watermark quality for such scenarios and have seen them used to good effect across a number of use cases.</p>
	</dd>
	<dt>Google Cloud Pub/Sub</dt>
	<dd>
	<p>Cloud Pub/Sub is an interesting use case.<a contenteditable="false" data-primary="Cloud Pub/Sub" data-type="indexterm" id="idm140176522570064"></a> Pub/Sub currently <a contenteditable="false" data-primary="heuristic watermarks" data-secondary="creation of" data-tertiary="from Google Cloud Pub/Sub" data-type="indexterm" id="idm140176522568832"></a>makes no guarantees on in-order delivery; even if a single publisher publishes two messages in order, there’s a chance (usually small) that they might be delivered out of order (this is due to the dynamic nature of the underlying architecture, which allows for transparent scaling up to very high levels of throughput with zero user intervention). As a result, there’s no way to guarantee a perfect watermark for Cloud Pub/Sub. The Cloud Dataflow team has, however, built a reasonably accurate heuristic watermark by taking advantage of what knowledge <em>is</em> available about the data in Cloud Pub/Sub. The implementation of this heuristic is discussed at length as a case study later in this chapter.</p>
	</dd>
</dl>

<p>Consider an example where users play a mobile game, and their scores are sent to our pipeline for processing: you can generally assume that for any source utilizing mobile devices for input it will be generally impossible to provide a perfect watermark. Due to the problem of devices that go offline for extended periods of time, there’s just no way to provide any sort of reasonable estimate of absolute completeness for such a data source. You can, however, imagine building a watermark that accurately tracks input completeness for devices that are currently online, similar to the Google Pub/Sub watermark described a moment ago. Users who are actively online are likely the most relevant subset of users from the perspective of providing low-latency results anyway, so this often isn’t as much of a shortcoming as you might initially think.</p>

<p>With heuristic watermark creation, broadly speaking, the more that is known about the source, the better the heuristic, and the fewer late data items will be seen. There is no one-size-fits-all solution, given that the types of sources, distributions of events, and usage patterns will vary greatly. But in either case (perfect or heuristic), after a watermark is created at the input source, the system can propagate the watermark through the pipeline perfectly. This means perfect watermarks will remain perfect downstream, and heuristic watermarks will remain strictly as heuristic as they were when established. This is the benefit of the watermark approach: you can reduce the complexity of tracking completeness in a pipeline entirely to the problem of creating a watermark at the source.<a contenteditable="false" data-primary="watermarks" data-secondary="source watermark creation" data-startref="ix_wtrmk3src" data-type="indexterm" id="idm140176522563088"></a></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Watermark Propagation"><div class="sect1" id="idm140176522561296">
<h1>Watermark Propagation</h1>

<p>So far, we have considered only the watermark for the inputs within the context of a single operation or stage. <a contenteditable="false" data-primary="watermarks" data-secondary="propagation" data-type="indexterm" id="ix_wtrmk3prop"></a>However, most real-world pipelines consist of multiple stages. Understanding how watermarks propagate across independent stages is important in understanding how they affect the pipeline as a whole and the observed latency of its results.</p>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm140176522557408">
 <h5>Pipeline Stages</h5>
 <p>Different stages are typically necessary every time your pipeline groups data together by some new dimension. For example, if you had a pipeline that consumed raw data, computed some per-user aggregates, and then used those per-user aggregates to compute some per-team aggregates, you’d likely end up with a three-stage pipeline:</p>
 <ul>
  <li><p>One consuming the raw, ungrouped data</p></li>
  <li><p>One grouping the data by user and computing per-user aggregates</p></li>
  <li><p>One grouping the data by team and computing per-team aggregates</p></li>
 </ul>
 <p>We learn more about the effects of grouping on pipeline shapes in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch06.html#streams_and_tables">Chapter&nbsp;6</a>.</p>
</div></aside>

<p>Watermarks are created at input sources, as discussed in the preceding section. They then conceptually flow through the system as data progress through it.<sup><a data-type="noteref" id="idm140176522551280-marker" href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522551280" class="totri-footnote">3</a></sup> You can track watermarks at varying levels of granularity. For pipelines comprising multiple distinct stages, each stage likely tracks its own watermark, whose value is a function of all the inputs and stages that come before it. Therefore, stages that come later in the pipeline will have watermarks that are further in the past (because they’ve seen less of the overall input).</p>

<p>We can define watermarks at the boundaries of any single operation, or stage, in the pipeline. This is useful not only in understanding the relative progress that each stage in the pipeline is making, but for dispatching timely results independently and as soon as possible for each individual stage. We give the following definitions for the watermarks at the boundaries of stages:</p>

<ul>
	<li>
	<p>An <em>input watermark</em>, which captures the progress of everything upstream of that stage (i.e., how complete the input is for that stage).<a contenteditable="false" data-primary="input watermarks" data-type="indexterm" id="idm140176522547520"></a> For sources, the input watermark is a source-specific function creating the watermark for the input data. For nonsource stages, the input watermark is defined as the minimum of the output watermarks of all shards/partitions/instances of all of its upstream sources and stages.</p>
	</li>
	<li>
	<p>An <em>output watermark</em>, which captures the progress <a contenteditable="false" data-primary="output watermarks" data-type="indexterm" id="idm140176522544688"></a>of the stage itself, and is essentially defined as the minimum of the stage’s input watermark and the event times of all nonlate data active messages within the stage. Exactly what “active” encompasses is somewhat dependent upon the operations a given stage actually performs, and the implementation of the stream processing system. It typically includes data buffered for aggregation but not yet materialized downstream, pending output data in flight to downstream stages, and so on.</p>
	</li>
</ul>

<p>One nice feature of defining an input and output watermark for a specific stage is that we can use these to calculate the amount of event-time latency introduced by a stage. Subtracting the value of a stage’s output watermark from the value of its input watermark gives the amount of event-time latency or <em>lag</em> introduced by the stage. This lag is the notion of how far delayed behind real time the output of each stage will be. As an example, a stage performing 10-second windowed aggregations will have a lag of 10 seconds or more, meaning that the output of the stage will be at least that much delayed behind the input and real time. Definitions of input and output watermarks provide a recursive relationship of watermarks throughout a pipeline. Each subsequent stage in a pipeline delays the watermark as necessary, based on event-time lag of the stage.</p>

<p>Processing within each stage is also not monolithic. We can segment the processing within one stage into a flow with several conceptual components, each of which contributes to the output watermark. As mentioned previously, the exact nature of these components depends on the operations the stage performs and the implementation of the system. Conceptually, each such component serves as a buffer where active messages can reside until some operation has completed. For example, as data arrives, it is buffered for processing. Processing might then write the data to state for later delayed aggregation. Delayed aggregation, when triggered, might write the results to an output buffer awaiting consumption from a downstream stage, as shown in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#example_system_components_of_a_streaming_system_stage_containing_buffers">Figure&nbsp;3-3</a>.</p>

<figure><div id="example_system_components_of_a_streaming_system_stage_containing_buffers" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0303.png" width="600" height="252" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0303.png">
<h6><span class="label">Figure 3-3. </span>Example system components of a streaming system stage, containing buffers of in-flight data. Each will have associated watermark tracking, and the overall output watermark of the stage will be the minimum of the watermarks across all such buffers.</h6>
</div></figure>

<p>We can track each such buffer with its own watermark. The minimum of the watermarks across the buffers of each stage forms the output watermark of the stage.<a contenteditable="false" data-primary="output watermarks" data-secondary="components of" data-type="indexterm" id="idm140176522536432"></a> Thus the output watermark could be the minimum of the following:</p>

<ul>
	<li>
	<p><em>Per-source</em> watermark—for each sending stage.</p>
	</li>
	<li>
	<p><em>Per-external input</em> watermark—for sources external to the pipeline</p>
	</li>
	<li>
	<p><em>Per-state component</em> watermark—for each type of state that can be written</p>
	</li>
	<li>
	<p><em>Per-output buffer</em> watermark—for each receiving stage</p>
	</li>
</ul>

<p>Making watermarks available at this level of granularity also provides better visibility into the behavior of the system. The watermarks track locations of messages across various buffers in the system, allowing for easier diagnosis of stuckness.</p>

<section data-type="sect2" data-pdf-bookmark="Understanding Watermark Propagation"><div class="sect2" id="idm140176522528624">
<h2>Understanding Watermark Propagation</h2>

<p>To get a better sense for the relationship between input and output watermarks and how they affect watermark propagation, let’s look at an example. Let’s consider gaming scores, but instead of computing sums of team scores, we’re going to take a stab at measuring user engagement levels. We’ll do this by first calculating per-user session lengths, under the assumption that the amount of time a user stays engaged with the game is a reasonable proxy for how much they’re enjoying it. After answering our four questions once to calculate sessions lengths, we’ll then answer them a second time to calculate average session lengths within fixed periods of time.</p>

<p>To make our example even more interesting, lets say that we are working with two datasets, one for Mobile Scores and one for Console Scores. We would like to perform identical score calculations via integer summation in parallel over these two independant datasets. One pipeline is calculating scores for users playing on mobile devices, whereas the other is for users playing on home gaming consoles, perhaps due to different data collection strategies employed for the different platforms. The important point is that these two stages are performing the same operation but over different data, and thus with very different output watermarks.</p>

<p>To begin, <a contenteditable="false" data-primary="sessions" data-secondary="calculating length per user across two input pipelines" data-type="indexterm" id="idm140176522524704"></a>let’s take a look at <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#calculating_sessions_lengths">Example&nbsp;3-1</a> to see what the abbreviated code for what the first section of this pipeline might be like.</p>

<div data-type="example" id="calculating_sessions_lengths">
<h5><span class="label">Example 3-1. </span>Calculating session lengths</h5>

<pre data-type="programlisting">PCollection&lt;Double&gt; mobileSessions = IO.read(new MobileInputSource())
  .apply(<span class="where_lt">Window.into(Sessions.withGapDuration(Duration.standardMinutes(1)))</span>
               <span class="when_lt">.triggering(AtWatermark())</span>
               <span class="how_lt">.discardingFiredPanes()</span>)
  .apply(<span class="what_lt">CalculateWindowLength()</span>);

PCollection&lt;Double&gt; consoleSessions = IO.read(new ConsoleInputSource())
  .apply(<span class="where_lt">Window.into(Sessions.withGapDuration(Duration.standardMinutes(1)))</span>
               <span class="when_lt">.triggering(AtWatermark())</span>
               <span class="how_lt">.discardingFiredPanes()</span>)
  .apply(<span class="what_lt">CalculateWindowLength()</span>);
</pre>
</div>

<p>Here, we read in each of our inputs independently, and whereas previously we were keying our collections by team, in this example we key by user. After that, for the first stage of each pipeline, we window into sessions and then call a custom <code>PTransform</code> named <code>CalculateWindowLength</code>. This <code>PTransform</code> simply groups by key (i.e., <code>User</code>) and then computes the per-user session length by treating the size of the current window as the value for that window. In this case, we’re fine with the default trigger (<code>AtWatermark</code>) and accumulation mode (<code>discardingFiredPanes</code>) settings, but I’ve listed them explicitly for completeness. The output for each pipeline for two particular users might look something like <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#per_user_session_lengths_across_two_different_input_pipeline">Figure&nbsp;3-4</a>.</p>

<figure><div id="per_user_session_lengths_across_two_different_input_pipeline" class="figure"><video style="margin: 0 auto; max-width: 100%;" controls="controls" poster="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0304.png" autoplay="autoplay" loop="loop">
<source src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0304.mp4" type="video/mp4"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0304.png" alt="Per-user session lengths across two different input pipelines" width="600" height="549" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0304.png">
</video>
<h6><span class="label">Figure 3-4. </span>Per-user session lengths across two different input pipelines</h6>
</div></figure>

<p>Because we need to track data across multiple stages, we track everything related to Mobile Scores in red, everything related to Console Scores in blue, while the watermark and output for Average Session Lengths in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_of_mobile_and_console_gaming_sessions">Figure&nbsp;3-5</a> are yellow.</p>

<p>We have answered the four questions of <span class="what_lt"><em>what</em></span>, <span class="where_lt"><em>where</em></span>, <span class="when_lt"><em>when</em></span>, and <span class="how_lt"><em>how</em></span> to compute individual session lengths. Next we’ll answer them a second time to transform those session lengths into global session-length averages within fixed windows of time. This requires us to first flatten our two data sources into one, and then re-window into fixed windows; we’ve already captured the important essence of the session in the session-length value we computed, and we now want to compute a global average of those sessions within consistent windows of time over the course of the day. <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#calculating_session_lengths">Example&nbsp;3-2</a> shows the code for this.</p>

<div data-type="example" id="calculating_session_lengths">
<h5><span class="label">Example 3-2. </span>Calculating session lengths</h5>

<pre data-type="programlisting">PCollection&lt;Double&gt; mobileSessions = IO.read(new MobileInputSource())
  .apply(<span class="where_lt">Window.into(Sessions.withGapDuration(Duration.standardMinutes(1)))</span>
               <span class="when_lt">.triggering(AtWatermark())</span>
               <span class="how_lt">.discardingFiredPanes()</span>)
  .apply(<span class="what_lt">CalculateWindowLength()</span>);

PCollection&lt;Double&gt; consoleSessions = IO.read(new ConsoleInputSource())
  .apply(<span class="where_lt">Window.into(Sessions.withGapDuration(Duration.standardMinutes(1)))</span>
               <span class="when_lt">.triggering(AtWatermark())</span>
               <span class="how_lt">.discardingFiredPanes()</span>)
  .apply(<span class="what_lt">CalculateWindowLength()</span>);
  
PCollection&lt;Float&gt; averageSessionLengths = PCollectionList
  .of(mobileSessions).and(consoleSessions)
  .apply(Flatten.pCollections())
  .apply(<span class="where_lt">Window.into(FixedWindows.of(Duration.standardMinutes(2)))</span>
               <span class="when_lt">.triggering(AtWatermark())</span>
  .apply(<span class="what_lt">Mean.globally()</span>);
</pre>
</div>

<p>If we were to see this pipeline in action, it would look something like <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_of_mobile_and_console_gaming_sessions">Figure&nbsp;3-5</a>. As before, the two input pipelines are computing individual session lengths for mobile and console players. Those session lengths then feed into the second stage of the pipeline, where global session-length averages are computed in fixed windows.</p>

<figure><div id="average_session_lengths_of_mobile_and_console_gaming_sessions" class="figure">
<video style="margin: 0 auto; max-width: 100%;" controls="controls" poster="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0305.png" autoplay="autoplay" loop="loop">
<source src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0305.mp4" type="video/mp4"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0305.png" alt="Average session lengths of mobile and console gaming sessions" width="600" height="447" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0305.png">
</video>
<h6><span class="label">Figure 3-5. </span>Average session lengths of mobile and console gaming sessions</h6>
</div></figure>


<p class="pagebreak-before">Let’s walk through some of this example, given that there’s a lot going on. The two important points here are:</p>

<ul>
	<li>
	<p>The <em>output watermark</em> for each of the Mobile Sessions and Console Sessions stages is at least as old as the corresponding input watermark of each, and in reality a little bit older.<a contenteditable="false" data-primary="output watermarks" data-secondary="for Mobile Sessions and Console Sessions stages" data-type="indexterm" id="idm140176522477888"></a> This is because in a real system computing answers takes time, and we don’t allow the output watermark to advance until processing for a given input has completed.</p>
	</li>
	<li>
	<p>The <em>input watermark</em> for the Average Session Lengths stage is the minimum of the output watermarks <a contenteditable="false" data-primary="input watermarks" data-secondary="for Average Session Lengths stage" data-type="indexterm" id="idm140176522474800"></a>for the two stages directly upstream.</p>
	</li>
</ul>

<p>The result is that the downstream input watermark is an alias for the minimum composition of the upstream output watermarks. Note that this matches the definitions for those two types of watermarks earlier in the chapter. Also notice how watermarks further downstream are further in the past, capturing the intuitive notion that upstream stages are going to be further ahead in time than the stages that follow them.</p>

<p>One observation worth making here is just how cleanly we were able to ask the questions again in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#calculating_sessions_lengths">Example&nbsp;3-1</a> to substantially alter the results of the pipeline. Whereas before we simply computed per-user session lengths, we now compute two-minute global session-length averages. This provides a much more insightful look into the overall behaviors of the users playing our games and gives you a tiny glimpse of the difference between simple data transformations and real data science.</p>

<p>Even better, now that we understand the basics of how this pipeline operates, we can look more closely at one of the more subtle issues related to asking the four questions over again: <em>output timestamps</em>.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Watermark Propagation and Output Timestamps"><div class="sect2" id="idm140176522528000">
<h2>Watermark Propagation and Output Timestamps</h2>

<p>In <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_of_mobile_and_console_gaming_sessions">Figure&nbsp;3-5</a>, I glossed over some of the details of output timestamps. <a contenteditable="false" data-primary="output timestamps" data-secondary="watermark propagation and" data-type="indexterm" id="ix_outtimwmk"></a><a contenteditable="false" data-primary="watermarks" data-secondary="propagation" data-tertiary="and output timestamps" data-type="indexterm" id="ix_wtrmk3propot"></a>But if you look closely at the second stage in the diagram, you can see that each of the outputs from the first stage was assigned a timestamp that matched the end of its window. Although that’s a fairly natural choice for output timestamps, it’s not the only valid choice. As you know from earlier in this chapter, watermarks are never allowed to move backward. Given that restriction, you can infer that the range of valid timestamps for a given window begins with the timestamp of the earliest nonlate record in the window (because only nonlate records are guaranteed to hold a watermark up) and extends all the way to positive infinity. That’s quite a lot of options. In practice, however, there tend to be only a few choices that make sense in most circumstances:</p>

<dl>
	<dt>End of the window<sup><a data-type="noteref" id="idm140176522460768-marker" href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522460768" class="totri-footnote">4</a></sup></dt>
	<dd>
	<p>Using the end of the window is the only safe choice if you want the output timestamp to be representative of the window bounds. <a contenteditable="false" data-primary="windowing" data-secondary="end of window and output timestamp" data-type="indexterm" id="idm140176522458160"></a>As we’ll see in a moment, it also allows the smoothest watermark progression out of all of the options.</p>
	</dd>
	<dt>Timestamp of first nonlate element</dt>
	<dd>
	<p>Using the timestamp of the first nonlate element is a good choice when you want to keep your watermarks as conservative as possible. The trade-off, however, is that watermark progress will likely be more hindered, as we’ll also see shortly.</p>
	</dd>
	<dt>Timestamp of a specific element</dt>
	<dd>
	<p>For certain use cases, the timestamp of some other arbitrary (from the system’s perspective) element is the right choice. Imagine a use case in which you’re joining a stream of queries to a stream of clicks on results for that query. After performing the join, some systems will find the timestamp of the query to be more useful; others will prefer the timestamp of the click. Any such timestamp is valid from a watermark correctness perspective, as long as it corresponded to an element that did not arrive late.</p>
	</dd>
</dl>

<p>Having thought a bit about some alternate options for output timestamps, let’s look at what effects the choice of output timestamp can have on the overall pipeline. To make the changes as dramatic as possible, in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_pipeline_with_output">Example&nbsp;3-3</a> and <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_for_sessions_which_are_output">Figure&nbsp;3-6</a>, we’ll switch to using the earliest timestamp possible for the window: the timestamp of the first nonlate element as the timestamp for the window.&nbsp;</p>

<div data-type="example" id="average_session_lengths_pipeline_with_output">
<h5><span class="label">Example 3-3. </span>Average session lengths pipeline, that output timestamps for session windows set at earliest element</h5>

<pre data-type="programlisting">PCollection&lt;Double&gt; mobileSessions = IO.read(new MobileInputSource())
  .apply(<span class="where_lt">Window.into(Sessions.withGapDuration(Duration.standardMinutes(1)))</span>
               <span class="when_lt">.triggering(AtWatermark())</span>
               <span class="where_lt grey_bg">.withTimestampCombiner(EARLIEST)</span>
               <span class="how_lt">.discardingFiredPanes()</span>)
  .apply(<span class="what_lt">CalculateWindowLength()</span>);

PCollection&lt;Double&gt; consoleSessions = IO.read(new ConsoleInputSource())
  .apply(<span class="where_lt">Window.into(Sessions.withGapDuration(Duration.standardMinutes(1)))</span>
               <span class="when_lt">.triggering(AtWatermark())</span>
               <span class="where_lt grey_bg">.withTimestampCombiner(EARLIEST)</span>
               <span class="how_lt">.discardingFiredPanes()</span>)
  .apply(<span class="what_lt">CalculateWindowLength()</span>);
  
PCollection&lt;Float&gt; averageSessionLengths = PCollectionList
  .of(mobileSessions).and(consoleSessions)
  .apply(Flatten.pCollections())
  .apply(<span class="where_lt">Window.into(FixedWindows.of(Duration.standardMinutes(2)))</span>
               <span class="when_lt">.triggering(AtWatermark())</span>
  .apply(<span class="what_lt">Mean.globally()</span>);
</pre>
</div>

<figure><div id="average_session_lengths_for_sessions_which_are_output" class="figure">
<video style="margin: 0 auto; max-width: 100%;" controls="controls" poster="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0306.png" autoplay="autoplay" loop="loop">
<source src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0306.mp4" type="video/mp4"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0306.png" alt="Average session lengths for sessions that are output at the timestamp of the earliest element" width="600" height="447" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0306.png">
</video>
<h6><span class="label">Figure 3-6. </span>Average session lengths for sessions that are output at the timestamp of the earliest element</h6>
</div></figure>


<p>To help call out the effect of the output timestamp choice, look at the dashed lines in the first stages showing what the output watermark for each stage is being held to. The output watermark is delayed by our choice of timestamp, as compared to Figures <a data-type="xref" data-xrefstyle="select:labelnumber" href="/site/library/view/streaming-systems/9781491983867/ch03.html#comparison_of_watermarks_and_results_with_different_choice_of_window_out">3-7</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="/site/library/view/streaming-systems/9781491983867/ch03.html#comparison_of_watermarks_and_results_with_different_choice_of_window_out_b">3-8</a>, in which the output timestamp was chosen to be the end of the window. You can see from this diagram that the input watermark of the second stage is thus subsequently also delayed.</p>

<figure class="smallerseventy"><div id="comparison_of_watermarks_and_results_with_different_choice_of_window_out" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0307a.png" width="600" height="447" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0307a.png">
<h6><span class="label">Figure 3-7. </span>Comparison of watermarks and results with different choice of window outout timestamps. The watermarks in this figure correspond to output timestamps at the end of the session windows (i.e., <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_of_mobile_and_console_gaming_sessions">Figure&nbsp;3-5</a>).</h6>
</div></figure>

<figure class="smallerseventy"><div id="comparison_of_watermarks_and_results_with_different_choice_of_window_out_b" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0307b.png" width="600" height="447" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0307b.png">
<h6><span class="label">Figure 3-8. </span>In this figure, the watermarks are at the beginning of the session windows (i.e., <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_for_sessions_which_are_output">Figure&nbsp;3-6</a>). We can see that the watermark line in this figure is more delayed, and the resulting average session lengths are different.</h6>
</div></figure>

<p class="pagebreak-before">As far as differences in this version compared to <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#comparison_of_watermarks_and_results_with_different_choice_of_window_out">Figure&nbsp;3-7</a>, two are worth noting:</p>

<dl>
	<dt>Watermark delay</dt>
	<dd>
	<p>Compared to <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_of_mobile_and_console_gaming_sessions">Figure&nbsp;3-5</a>, the watermark proceeds much more slowly in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#average_session_lengths_for_sessions_which_are_output">Figure&nbsp;3-6</a>. This is because the output watermark for the first stage is held back to the timestamp of the first element in every window until the input for that window becomes complete. Only after a given window has been materialized is the output watermark (and thus the downstream input watermark) allowed to advance.</p>
	</dd>
	<dt>Semantic differences</dt>
	<dd>
	<p>Because the session timestamps are now assigned to match the earliest nonlate element in the session, the individual sessions often end up in different fixed window buckets when we then calculate the session-length averages in the next stage. There’s nothing inherently right or wrong about either of the two options we’ve seen so far; they’re just different. But it’s important to understand that they <em>will</em> be different as well as have an intuition for the way in which they’ll be different so that you can make the correct choice for your specific use case when the time comes.<a contenteditable="false" data-primary="output timestamps" data-secondary="watermark propagation and" data-startref="ix_outtimwmk" data-type="indexterm" id="idm140176522415280"></a><a contenteditable="false" data-primary="watermarks" data-secondary="propagation" data-startref="ix_wtrmk3propot" data-tertiary="and output timestamps" data-type="indexterm" id="idm140176522413616"></a></p>
	</dd>
</dl>
</div></section>

<section data-type="sect2" data-pdf-bookmark="The Tricky Case of Overlapping Windows"><div class="sect2" id="idm140176522468528">
<h2>The Tricky Case of Overlapping Windows</h2>

<p>One additional subtle but important issue regarding output timestamps is how to handle sliding windows.<a contenteditable="false" data-primary="watermarks" data-secondary="propagation" data-tertiary="with overlapping windows" data-type="indexterm" id="idm140176522409824"></a><a contenteditable="false" data-primary="windowing" data-secondary="overlapping windows and output timestamp" data-type="indexterm" id="idm140176522408160"></a><a contenteditable="false" data-primary="output timestamps" data-secondary="watermarks and" data-tertiary="with overlapping windows" data-type="indexterm" id="idm140176522406752"></a> The naive approach of setting the output timestamp to the earliest element can very easily lead to delays downstream due to watermarks being (correctly) held back. To see why, consider an example pipeline with two stages, each using the same type of sliding windows. Suppose that each element ends up in three successive windows. As the input watermark advances, the desired semantics for sliding windows in this case would be as follows:</p>

<ul>
	<li>
	<p>The first window completes in the first stage and is emitted downstream.</p>
	</li>
	<li>
	<p>The first window then completes in the second stage and can also be emitted downstream.</p>
	</li>
	<li>
	<p>Some time later, the second window completes in the first stage… and so on.</p>
	</li>
</ul>

<p>However, if output timestamps are chosen to be the timestamp of the first nonlate element in the pane, what actually happens is the following:</p>

<ul>
	<li>
	<p>The first window completes in the first stage and is emitted downstream.</p>
	</li>
	<li>
	<p>The first window in the second stage remains unable to complete because its input watermark is being held up by the output watermark of the second and third windows upstream. Those watermarks are rightly being held back because the earliest element timestamp is being used as the output timestamp for those windows.</p>
	</li>
	<li>
	<p>The second window completes in the first stage and is emitted downstream.</p>
	</li>
	<li>
	<p>The first and second windows in the second stage remain unable to complete, held up by the third window upstream.</p>
	</li>
	<li>
	<p>The third window completes in the first stage and is emitted downstream.</p>
	</li>
	<li>
	<p>The first, second, and third windows in the second stage are now all able to complete, finally emitting all three in one swoop.</p>
	</li>
</ul>

<p>Although the results of this windowing are correct, this leads to the results being materialized in an unnecessarily delayed way. Because of this, Beam has special logic for overlapping windows that ensures the output timestamp for window <em>N</em>+1 is always greater than the end of window <em>N</em>.<a contenteditable="false" data-primary="watermarks" data-secondary="propagation" data-startref="ix_wtrmk3prop" data-type="indexterm" id="idm140176522392672"></a></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Percentile Watermarks"><div class="sect1" id="idm140176522560672">
<h1>Percentile Watermarks</h1>

<p>So far, we have concerned ourselves with watermarks as measured by the minimum event time of active messages in a stage.<a contenteditable="false" data-primary="watermarks" data-secondary="percentile" data-type="indexterm" id="ix_wtrmk3pct"></a><a contenteditable="false" data-primary="percentile watermarks" data-type="indexterm" id="ix_pctwtrmk"></a> Tracking the minimum allows the system to know when all earlier timestamps have been accounted for. On the other hand, we could consider the entire distribution of event timestamps for active messages and make use of it to create finer-grained triggering conditions.</p>

<p>Instead of considering the minimum point of the distribution, we could take any percentile of the distribution and say that we are guaranteed to have processed this percentage of all events with earlier timestamps.<sup><a data-type="noteref" id="idm140176522385232-marker" href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522385232" class="totri-footnote">5</a></sup></p>

<p>What is the advantage of this scheme? If for the business logic “mostly” correct is sufficient, percentile watermarks provide a mechanism by which the watermark can advance more quickly and more smoothly than if we were tracking the minimum event time by discarding outliers in the long tail of the distribution from the watermark. <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#normal_looking_watermark_histogram">Figure&nbsp;3-9</a> shows a compact distribution of event times where the 90<sup>th</sup> percentile watermark is close to the 100<sup>th</sup> percentile. <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#watermark_histogram_with_outliers">Figure&nbsp;3-10</a> demonstrates a case where the outlier is further behind, so the 90<sup>th</sup> percentile watermark is significantly ahead of the 100<sup>th</sup> percentile. By discarding the outlier data from the watermark, the percentile watermark can still keep track of the bulk of the distribution without being delayed by the outliers.</p>

<figure><div id="normal_looking_watermark_histogram" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0308.png" width="600" height="271" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0308.png">
<h6><span class="label">Figure 3-9. </span>Normal-looking watermark histogram</h6>
</div></figure>

<figure><div id="watermark_histogram_with_outliers" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0309.png" width="600" height="271" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0309.png">
<h6><span class="label">Figure 3-10. </span>Watermark histogram with outliers</h6>
</div></figure>

<p><a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#effects_of_varying_watermark_percentiles">Figure&nbsp;3-11</a> shows an example of percentile watermarks used to draw window boundaries for two-minute fixed windows. We can draw early boundaries based on the percentile of timestamps of arrived data as tracked by the percentile watermark.</p>

<figure><div id="effects_of_varying_watermark_percentiles" class="figure">
<video style="margin: 0 auto; max-width: 100%;" controls="controls" poster="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0310.png" autoplay="autoplay" loop="loop">
<source src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0310.mp4" type="video/mp4"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0310.png" alt="Effects of varying watermark percentiles. As the percentile increases, more events are included in the window: however, the processing time delay to materialize the window also increases." width="600" height="475" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0310.png">
</video>
<h6><span class="label">Figure 3-11. </span>Effects of varying watermark percentiles. As the percentile increases, more events are included in the window: however, the processing time delay to materialize the window also increases.</h6>
</div></figure>

<p><a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#effects_of_varying_watermark_percentiles">Figure&nbsp;3-11</a> shows the 33<sup>rd</sup> percentile, 66<sup>th</sup> percentile, and 100<sup>th</sup> percentile (full) watermark, tracking the respective timestamp percentiles in the data distribution. As expected, these allow boundaries to be drawn earlier than tracking the full 100<sup>th</sup> percentile watermark. Notice that the 33<sup>rd</sup> and 66<sup>th</sup> percentile watermarks each allow earlier triggering of windows but with the trade-off of marking more data as late. For example, for the first window, [12:00, 12:02), a window closed based on the 33<sup>rd</sup> percentile watermark would include only four events and materialize the result at 12:06 processing time. If we use the 66<sup>th</sup> percentile watermark, the same event-time window would include seven events, and materialize at 12:07 processing time. Using the 100<sup>th</sup> percentile watermark includes all ten events and delays materializing the results until 12:08 processing time. Thus, percentile watermarks provide a way to tune the trade-off between latency of materializing results and precision of the results.<a contenteditable="false" data-primary="watermarks" data-secondary="percentile" data-startref="ix_wtrmk3pct" data-type="indexterm" id="idm140176522363504"></a><a contenteditable="false" data-primary="percentile watermarks" data-startref="ix_pctwtrmk" data-type="indexterm" id="idm140176522361856"></a></p>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Processing-Time Watermarks"><div class="sect1" id="idm140176522369232">
<h1>Processing-Time Watermarks</h1>

<p>Until now, we have been looking at watermarks as they relate to the data flowing through our system.<a contenteditable="false" data-primary="watermarks" data-secondary="processing-time" data-type="indexterm" id="ix_wtrmk3prtm"></a><a contenteditable="false" data-primary="processing time" data-secondary="watermarks" data-type="indexterm" id="ix_proctmwtrmk"></a> We have seen how looking at the watermark can help us identify the overall delay between our oldest data and real time. However, this is not enough to distinguish between old data and a delayed system. In other words, by only examining the event-time watermark as we have defined it up until now, we cannot distinguish between a system that is processing data from an hour ago quickly and without delay, and a system that is attempting to process real-time data and has been delayed for an hour while doing so.</p>

<p>To make this distinction, we need something more: processing-time watermarks. We have already seen that there are two time domains in a streaming system: processing time and event time. Until now, we have defined the watermark entirely in the event-time domain, as a function of timestamps of the data flowing through the system. This is an event-time watermark. We will now apply the same model to the processing-time domain to define a processing-time watermark.</p>

<p>Our stream processing system is constantly performing operations such as shuffling messages between stages, reading or writing messages to persistent state, or triggering delayed aggregations based on watermark progress. All of these operations are performed in response to previous operations done at the current or upstream stage of the pipeline. Thus, just as data elements “flow” through the system, a cascade of operations involved in processing these elements also “flows” through the system.</p>

<p>We define the processing-time watermark in the exact same way as we have defined the event-time watermark, except instead of using the event-time timestamp of oldest work not yet completed, we use the processing-time timestamp of the oldest operation not yet completed. An example of delay to the processing-time watermark could be a stuck message delivery from one stage to another, a stuck I/O call to read state or external data, or an exception while processing that prevents processing from completing.</p>

<p>The processing-time watermark, therefore, provides a notion of processing delay separate from the data delay. To understand the value of this distinction, consider the graph in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#event_time_watermark_increasing_it_is_not">Figure&nbsp;3-12</a> where we look at the event-time watermark delay.</p>

<p>We see that the data delay is monotonically increasing, but there is not enough information to distinguish between the cases of a stuck system and stuck data. Only by looking at the processing-time watermark, shown in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#processing_time_watermark_also_increasing_this_indicates_that_the_system_processing_is_delayed">Figure&nbsp;3-13</a>, can we distinguish the cases.</p>

<figure class="smallerninety"><div id="event_time_watermark_increasing_it_is_not" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0311.png" width="600" height="190" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0311.png">
<h6><span class="label">Figure 3-12. </span>Event-time watermark increasing. It is not possible to know from this information whether this is due to data buffering or system processing delay.</h6>
</div></figure>



<figure class="smallerninety"><div id="processing_time_watermark_also_increasing_this_indicates_that_the_system_processing_is_delayed" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0312.png" width="600" height="190" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0312.png">
<h6><span class="label">Figure 3-13. </span>Processing-time watermark also increasing. This indicates that the system processing is delayed.</h6>
</div></figure>

<p>In the first case (<a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#event_time_watermark_increasing_it_is_not">Figure&nbsp;3-12</a>), when we examine the processing-time watermark delay we see that it too is increasing. This tells us that an operation in our system is stuck, and the stuckness is also causing the data delay to fall behind. Some real-world examples of situations in which this might occur are when there is a network issue preventing message delivery between stages of a pipeline or if a failure has occurred and is being retried. In general, a growing processing-time watermark indicates a problem that is preventing operations from completing that are necessary to the system’s function, and often involves user or administrator intervention to resolve.</p>

<p>In this second case, as seen in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#event_time_watermark_delay_increasing_processing_time_watermark_stable">Figure&nbsp;3-14</a>, the processing-time watermark delay is small. This tells us that there are no stuck operations. <a contenteditable="false" data-primary="event time" data-secondary="watermarks" data-type="indexterm" id="idm140176522341104"></a>The event-time watermark delay is still increasing, which indicates that we have some buffered state that we are waiting to drain.<a contenteditable="false" data-primary="latency" data-secondary="system vs. data, distinguishing with processing-time watermarks" data-type="indexterm" id="idm140176522339408"></a> This is possible, for example, if we are buffering some state while waiting for a window boundary to emit an aggregation, and corresponds to a normal operation of the pipeline, as in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#watermark_delay_for_fixed_windows_the_event_time_watermark_delay_increases">Figure&nbsp;3-15</a>.</p>

<figure class="smallerninety"><div id="event_time_watermark_delay_increasing_processing_time_watermark_stable" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0313.png" width="600" height="190" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0313.png">
<h6><span class="label">Figure 3-14. </span>Event-time watermark delay increasing, processing-time watermark stable. This is an indication that data are buffered in the system and waiting to be processed, rather than an indication that a system operation is preventing data processing from completing.</h6>
</div></figure>

<figure class="smallerninety"><div id="watermark_delay_for_fixed_windows_the_event_time_watermark_delay_increases" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0314.png" width="600" height="190" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0314.png">
<h6><span class="label">Figure 3-15. </span>Watermark delay for fixed windows. The event-time watermark delay increases as elements are buffered for each window, and decreases as each window’s aggregate is emitted via an on-time trigger, whereas the processing-time watermark simply tracks system-level delays (which remain relatively steady in a healthy pipeline).</h6>
</div></figure>

<p>Therefore, the processing-time watermark is a useful tool in distinguishing system latency from data latency. In addition to visibility, we can use the processing-time watermark at the system-implementation level for tasks such as garbage collection of <a contenteditable="false" data-primary="processing time" data-secondary="watermarks" data-startref="ix_proctmwtrmk" data-type="indexterm" id="idm140176522331600"></a>temporary <a contenteditable="false" data-primary="watermarks" data-secondary="processing-time" data-startref="ix_wtrmk3prtm" data-type="indexterm" id="idm140176522329824"></a>state (Reuven talks more about an example of this in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch05.html#exactly_once_and_side_effects">Chapter&nbsp;5</a>).</p>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Case Studies"><div class="sect1" id="idm140176522360016">
<h1>Case Studies</h1>

<p>Now that we’ve laid the groundwork for how watermarks ought to behave, it’s time to take a look at some real systems to understand how different mechanisms of the watermark are implemented.<a contenteditable="false" data-primary="watermarks" data-secondary="case study, watermarks in Google Cloud Dataflow" data-type="indexterm" id="ix_wtrmk3cs1"></a> We hope that these shed some light on the trade-offs that are possible between latency and correctness as well as scalability and availability for watermarks in real-world systems.</p>

<section data-type="sect2" data-pdf-bookmark="Case Study: Watermarks in Google Cloud Dataflow"><div class="sect2" id="idm140176522323056">
<h2>Case Study: Watermarks in Google Cloud Dataflow</h2>

<p>There are many possible approaches to implementing watermarks in a stream processing system. <a contenteditable="false" data-primary="Cloud Dataflow" data-secondary="watermarks in, case study" data-type="indexterm" id="ix_GCDwtrmk"></a>Here, we present a quick survey of the implementation in Google Cloud Dataflow, a fully managed service for executing Apache Beam pipelines. Dataflow includes SDKs for defining data processing workflows, and a Cloud Platform managed service to run those workflows on Google Cloud Platform resources.<a contenteditable="false" data-primary="Dataflow" data-see="Google Cloud Dataflow" data-type="indexterm" id="idm140176522319136"></a></p>

<p>Dataflow stripes (shards) each of the data processing steps in its data processing graph across multiple physical workers by splitting the available keyspace of each worker into key ranges and assigning each range to a worker. Whenever a <code>GroupByKey</code> operation with distinct keys is encountered, data must be shuffled to corresponding keys.</p>

<p><a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#a_groupbykey_step_consumes_data_from_another_dofn_this_means_there_is_a">Figure&nbsp;3-16</a> depicts a logical representation of the processing graph with a <code>GroupByKey</code>.</p>

<figure class="smallerthirty"><div id="a_groupbykey_step_consumes_data_from_another_dofn_this_means_there_is_a" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0315.png" width="559" height="367" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0315.png">
<h6><span class="label">Figure 3-16. </span>A GroupByKey step consumes data from another DoFn. This means that there is a data shuffle between the keys of the first step and the keys of the second step.</h6>
</div></figure>

<p>Whereas the physical assignment of key ranges to workers might look <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#key_ranges_of_both_steps_are_assigned_striped_across_the_available">Figure&nbsp;3-17</a>.</p>

<figure class="smallertwentyfive"><div id="key_ranges_of_both_steps_are_assigned_striped_across_the_available" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0316.png" width="418" height="800" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0316.png">
<h6><span class="label">Figure 3-17. </span>Key ranges of both steps are assigned (striped) across the available workers.</h6>
</div></figure>

<p>In the watermark propagation section, we discussed that the watermark is maintained for multiple subcomponents of each step. Dataflow keeps track of the per-range watermarks of each of these components. Watermark aggregation then involves computing the minimum of each watermark across all ranges, ensuring that the following guarantees are met:</p>

<ul>
	<li>
	<p>All ranges must be reporting a watermark. If a watermark is not present for a range, we cannot advance the watermark, because a range not reporting must be treated as unknown.</p>
	</li>
	<li>
	<p>Ensure that the watermark is monotonically increasing. Because late data is possible, we must not update the watermark if it would cause the watermark to move backward.</p>
	</li>
</ul>

<p>Google Cloud Dataflow performs aggregation via a centralized aggregator agent. We can shard this agent for efficiency. From a correctness standpoint, the watermark aggregator serves as a “single source of truth” about the watermark.</p>

<p>Ensuring correctness in distributed watermark aggregation poses certain challenges. It is paramount that watermarks are not advanced prematurely because advancing the watermark prematurely will turn on-time data into late data. Specifically, as physical assignments are actuated to workers, the workers maintain leases on the persistent state attached to the key ranges, ensuring that only a single worker may mutate the persistent state for a key. To guarantee watermark correctness, we must ensure that each watermark update from a worker process is admitted into the aggregate only if the worker process still maintains a lease on its persistent state; therefore, the watermark update protocol must take state ownership lease validation into account.<a contenteditable="false" data-primary="Cloud Dataflow" data-secondary="watermarks in, case study" data-startref="ix_GCDwtrmk" data-type="indexterm" id="idm140176522303792"></a><a contenteditable="false" data-primary="watermarks" data-secondary="case study, watermarks in Google Cloud Dataflow" data-startref="ix_wtrmk3cs1" data-type="indexterm" id="idm140176522302128"></a></p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Case Study: Watermarks in Apache Flink"><div class="sect2" id="idm140176522322432">
<h2>Case Study: Watermarks in Apache Flink</h2>

<p>Apache Flink is an open source stream processing framework for distributed, high-performing, always-available, and accurate data streaming applications.<a contenteditable="false" data-primary="watermarks" data-secondary="case study, watermarks in Apache Flink" data-type="indexterm" id="idm140176522298608"></a><a contenteditable="false" data-primary="Apache Flink" data-secondary="watermarks in, case study" data-type="indexterm" id="idm140176522297216"></a> It is possible to run Beam programs using a Flink runner. In doing so, Beam relies on the implementation of stream processing concepts such as watermarks within Flink. Unlike Google Cloud Dataflow, which implements watermark aggregation via a centralized watermark aggregator agent, Flink performs watermark tracking and aggregation in-band.<sup><a data-type="noteref" id="idm140176522295344-marker" href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522295344" class="totri-footnote">6</a></sup></p>

<p>To understand how this works, let’s look at a Flink pipeline, as shown in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#a_flink_pipeline_with_two_sources_and_event_time_watermarks_propagating_in_band">Figure&nbsp;3-18</a>.</p>

<figure><div id="a_flink_pipeline_with_two_sources_and_event_time_watermarks_propagating_in_band" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0317.png" width="600" height="312" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0317.png">
<h6><span class="label">Figure 3-18. </span>A Flink pipeline with two sources and event-time watermarks propagating in-band</h6>
</div></figure>

<p>In this pipeline data is generated at two sources. These sources also both generate watermark “checkpoints” that are sent synchronously in-band with the data stream. This means that when a watermark checkpoint from source A for timestamp “53” is emitted, it guarantees that no nonlate data messages will be emitted from source A with timestamp behind “53”. The downstream “keyBy” operators consume the input data and the watermark checkpoints. As new watermark checkpoints are consumed, the downstream operators’ view of the watermark is advanced, and a new watermark checkpoint for downstream operators can be emitted.</p>

<p>This choice to send watermark checkpoints in-band with the data stream differs from the Cloud Dataflow approach that relies on central aggregation and leads to a few interesting trade-offs.</p>

<p>Following are some<a contenteditable="false" data-primary="in-band watermarks" data-type="indexterm" id="idm140176522288976"></a> advantages of in-band watermarks:</p>

<dl>
	<dt>Reduced watermark propagation latency, and very low-latency watermarks</dt>
	<dd>
	<p>Because it is not necessary to have watermark data traverse multiple hops and await central aggregation, it is possible to achieve very low latency more easily with the in-band approach.</p>
	</dd>
	<dt>No single point of failure for watermark aggregation</dt>
	<dd>
	<p>Unavailability in the central watermark aggregation agent will lead to a delay in watermarks across the entire pipeline. With the in-band approach, unavailability of part of the pipeline cannot cause watermark delay to the entire pipeline.</p>
	</dd>
	<dt>Inherent scalability</dt>
	<dd>
	<p>Although Cloud Dataflow scales well in practice, more complexity is needed to achieve scalability with a centralized watermark aggregation service versus implicit scalability with in-band watermarks.</p>
	</dd>
</dl>

<p class="pagebreak-before">Here are some advantages of out-of-band watermark aggregation:</p>

<dl>
	<dt>Single source of “truth”</dt>
	<dd>
	<p>For debuggability, monitoring, <a contenteditable="false" data-primary="out-of-band watermark aggregation" data-type="indexterm" id="idm140176522280064"></a>and other applications such as throttling inputs based on pipeline progress, it is advantageous to have a service that can vend the values of watermarks rather than having watermarks implicit in the streams, with each component of the system having its own partial view.</p>
	</dd>
	<dt>Source watermark creation</dt>
	<dd>
	<p>Some source watermarks require global information. <a contenteditable="false" data-primary="source watermarks, creation of" data-type="indexterm" id="idm140176522277040"></a>For example, sources might be temprarily idle, have low data rates, or require out-of-band information about the source or other system components to generate the watermarks. This is easier to achieve in a central service.<a contenteditable="false" data-primary="Google Cloud Pub/Sub" data-see="Cloud Pub/Sub" data-type="indexterm" id="idm140176522275504"></a> For an example see the case study that follows on source watermarks for Google Cloud Pub/Sub.</p>
	</dd>
</dl>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Case Study: Source Watermarks for Google Cloud Pub/Sub"><div class="sect2" id="idm140176522299856">
<h2>Case Study: Source Watermarks for Google Cloud Pub/Sub</h2>

<p>Google Cloud Pub/Sub is a fully managed real-time messaging service that allows you to send and receive messages between independent<a contenteditable="false" data-primary="Cloud Pub/Sub" data-secondary="watermarks for, case study" data-type="indexterm" id="ix_GCPSwtrmk"></a> applications.<a contenteditable="false" data-primary="watermarks" data-secondary="case study, watermarks for Google Cloud Pub/Sub" data-type="indexterm" id="ix_wtrmk3cs3"></a> Here, we discuss how to create a reasonable heuristic watermark for data sent into a pipeline via Cloud Pub/Sub.</p>

<p>First, we need to describe a little about how Pub/Sub works. Messages are published on Pub/Sub <em>topics</em>. A particular topic can be subscribed to by any number of Pub/Sub <em>subscriptions</em>. The same messages are delivered on all subscriptions subscribed to a given topic. The method of delivery is for clients to <em>pull</em> messages off the subscription, and to ack the receipt of particular messages via provided IDs. Clients do not get to choose which messages are pulled, although Pub/Sub does attempt to provide oldest messages first, with no hard guarantees around this.</p>

<p>To build a heuristic, we make some assumptions about the source that is sending data into Pub/Sub. Specifically, we assume that the timestamps of the original data are “well behaved”; in other words, we expect a bounded amount of out-of-order timestamps on the source data, before it is sent to Pub/Sub. Any data that are sent with timestamps outside the allowed out-of-order bounds will be considered late data. In our current implementation, this bound is at least 10 seconds, meaning reordering of timestamps up to 10 seconds before sending to Pub/Sub will not create late data. We call this value the <em>estimation band</em>. Another way to look at this is that when the pipepline is perfectly caught up with the input, the watermark will be 10 seconds behind real time to allow for possible reorderings from the source. If the pipeline is backlogged, all of the backlog (not just the 10-second band) is used for estimating the watermark.</p>

<p>What are the challenges we face with Pub/Sub? Because Pub/Sub does not guarantee ordering, we must have some kind of additional metadata to know enough about the backlog. Luckily, Pub/Sub provides a measurement of backlog in terms of the “oldest unacknowledged publish timestamp.” This is not the same as the event timestamp of our message, because Pub/Sub is agnostic to the application-level metadata being sent through it; instead, this is the timestamp of when the message was ingested by Pub/Sub.</p>

<p>This measurement is not the same as an event-time watermark. It is in fact the processing-time watermark for Pub/Sub message delivery. The Pub/Sub publish timestamps are not equal to the event timestamps, and in the case that historical (past) data are being sent, it might be arbitrarily far away. The ordering on these timestamps might also be different because, as mentioned earlier, we allow a limited amount of reordering.</p>

<p>However, we can use this as a measure of backlog to learn enough information about the event timestamps present in the backlog so that we can create a reasonable watermark as follows.</p>

<p>We create two subscriptions to the topic containing<a contenteditable="false" data-primary="subscriptions in Google Cloud Pub/Sub case study" data-type="indexterm" id="idm140176522260832"></a> the input messages: a <em>base subscription</em> that the<a contenteditable="false" data-primary="base subscription (Google Cloud Pub/Sub case study)" data-type="indexterm" id="idm140176522259056"></a> pipeline will actually use to read the data to be processed, and a <em>tracking subscription</em>, which is used for metadata only, to perform the watermark estimation.<a contenteditable="false" data-primary="tracking subscription (Google Cloud Pub/Sub case study)" data-type="indexterm" id="idm140176522257264"></a></p>

<p>Taking a look at our base subscription in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#processing_time_and_event_time_timestamps_of_messages_arriving_on_a_pub_sub_subscription">Figure&nbsp;3-19</a>, we see that messages might arrive out of order. We label each message with its Pub/Sub publish timestamp “pt” and its event-time timestamp “et.” Note that the two time domains can be unrelated.</p>

<figure><div id="processing_time_and_event_time_timestamps_of_messages_arriving_on_a_pub_sub_subscription" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0318.png" width="600" height="236" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0318.png">
<h6><span class="label">Figure 3-19. </span>Processing-time and event-time timestamps of messages arriving on a Pub/Sub subscription</h6>
</div></figure>

<p>Some messages on the base subscription are unacknowledged forming a backlog. This might be due to them not yet being delivered or they might have been delivered but not yet processed. Remember also that pulls from this subscription are distributed across multiple shards. Thus, it is not possible to say just by looking at the base subscription what our watermark should be.</p>

<p>The tracking subscription, seen in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch03.html#an_additional_tracking_subscriptions_receiving_the_messages">Figure&nbsp;3-20</a>, is used to effectively inspect the backlog of the base subscription and take the minimum of the event timestamps in the backlog. By maintaining little or no backlog on the tracking subscription, we can inspect the messages ahead of the base subsciption’s oldest unacknowledged message.</p>

<figure><div id="an_additional_tracking_subscriptions_receiving_the_messages" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0319.png" width="600" height="272" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0319.png">
<h6><span class="label">Figure 3-20. </span>An additional “tracking” subscription receiving the same messages as the “base” subscription</h6>
</div></figure>

<p>We stay caught up on the tracking subscription by ensuring that pulling from this subscription is computationally inexpensive. Conversely, if we fall sufficiently behind on the tracking subscription, we will stop advancing the watermark. To do so, we ensure that at least one of the following conditions is met:</p>

<ul>
	<li>
	<p>The tracking subscription is sufficiently ahead of the base subscription. Sufficiently ahead means that the tracking subscription is ahead by at least the estimation band. This ensures that any bounded reorder within the estimation band is taken into account.</p>
	</li>
	<li>
	<p>The tracking subscription is sufficiently close to real time. In other words, there is no backlog on the tracking subscription.</p>
	</li>
</ul>

<p>We acknowledge the messages on the tracking subscription as soon as possible, after we have durably saved metadata about the publish and event timestamps of the messages. We store this metadata in a sparse histogram format to minimize the amount of space used and the size of the durable writes.</p>

<p>Finally, we ensure that we have enough data to make a reasonable watermark estimate. We take a band of event timestamps we’ve read from our tracking subscription with publish timestamps newer than the oldest unacknowledged of the base subscription, or the width of the estimation band. This ensures that we consider all event timestamps in the backlog, or if the backlog is small, the most recent estimation band, to make a watermark estimate.</p>

<p>Finally, the watermark value is computed to be the minimum event time in the band.</p>

<p>This method is correct in the sense that all timestamps within the reordering limit of 10 seconds at the input will be accounted for by the watermark and not appear as late data. However, it produces possibly an overly conservative watermark, one that advances “too slowly” in the sense described in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch02.html#the_what_where_when_and_how">Chapter&nbsp;2</a>. Because we consider all messages ahead of the base subscription’s oldest unacknowledged message on the tracking subscription, we can include event timestamps in the watermark estimate for messages that have already been acknowledged.</p>

<p>Additionally, there are a few heuristics to ensure progress. This method works well in the case of dense, frequently arriving data. In the case of sparse or infrequent data, there might not be enough recent messages to build a reasonable estimate. In the case that we have not seen data on the subscription in more than two minutes (and there’s no backlog), we advance the watermark to near real time. This ensures that the watermark and the pipeline continue to make progress even if no more messages are forthcoming.</p>

<p>All of the above ensures that as long as source data-event timestamp reordering is within the estimation band, there will be no additional late data.<a contenteditable="false" data-primary="Cloud Pub/Sub" data-secondary="watermarks for, case study" data-startref="ix_GCPSwtrmk" data-type="indexterm" id="idm140176522239424"></a><a contenteditable="false" data-primary="watermarks" data-secondary="case study, watermarks for Google Cloud Pub/Sub" data-startref="ix_wtrmk3cs3" data-type="indexterm" id="idm140176522237712"></a>&nbsp;</p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idm140176522272720">
<h1>Summary</h1>

<p>At this point, we have explored how we can use the event times of messages to give a robust definition of progress in a stream processing system. We saw how this notion of progress can subsequently help us answer the question of <span class="where_lt"><em>where</em></span> in event time processing is taking place and <span class="when_lt"><em>when</em></span> in processing time results are materialized. Specifically, we looked at how watermarks are created at the sources, the points of data ingestion into a pipeline, and then propagated throughout the pipeline to preserve the essential guarantees that allow the questions of <span class="where_lt"><em>where</em></span> and <span class="when_lt"><em>when</em></span> to be answered. We also looked at the implications of changing the output window timestamps on watermarks. Finally, we explored some real-world system considerations when building watermarks at scale.</p>

<p>Now that we have a firm footing in how watermarks work under the covers, we can take a dive into what they can do for us as we use windowing and triggering to answer more complex queries in <a data-type="xref" href="/site/library/view/streaming-systems/9781491983867/ch04.html#advanced_windowing">Chapter&nbsp;4</a>.<a contenteditable="false" data-primary="watermarks" data-startref="ix_wtrmk3" data-type="indexterm" id="idm140176522229088"></a></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm140176522635488"><sup><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522635488-marker" class="totri-footnote">1</a></sup> Note the additional mention of monotonicity; we have not yet discussed how to achieve this. Indeed the discussion thus far makes no mention of monotonicity. If we considered exclusively the oldest in-flight event time, the watermark would not always be monotonic, as we have made no assumptions about our input. We return to this discussion later on. </p><p data-type="footnote" id="idm140176522592800"><sup><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522592800-marker" class="totri-footnote">2</a></sup> To be precise, it’s not so much that the number of logs need be static as it is that the number of logs at any given time be known a priori by the system. A more sophisticated input source composed of a dynamically chosen number of inputs logs, such as <a href="http://pravega.io/">Pravega</a>, could just as well be used for constructing a perfect watermark. It’s only when the number of logs that exist in the dynamic set at any given time is unknown (as in the example in the next section) that one must fall back on a heuristic watermark.</p><p data-type="footnote" id="idm140176522551280"><sup><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522551280-marker" class="totri-footnote">3</a></sup> Note that by saying “flow through the system,” I don’t necessarily imply they flow along the same path as normal data. They might (as in Apache Flink), but they might also be transmitted out-of-band (as in MillWheel/Cloud Dataflow).</p><p data-type="footnote" id="idm140176522460768"><sup><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522460768-marker" class="totri-footnote">4</a></sup> The <em>start</em> of the window is not a safe choice from a watermark correctness perspective because the first element in the window often comes <em>after</em> the beginning of the window itself, which means that the watermark is not guaranteed to have been held back as far as the start of the window.</p><p data-type="footnote" id="idm140176522385232"><sup><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522385232-marker" class="totri-footnote">5</a></sup> The percentile watermark triggering scheme described here is not currently implemented by Beam; however, other systems such as MillWheel implement this.</p><p data-type="footnote" id="idm140176522295344"><sup><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#idm140176522295344-marker" class="totri-footnote">6</a></sup> For more information on Flink watermarks, see the <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.3/dev/event_time.html">Flink documentation on the subject.</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="/site/library/view/streaming-systems/9781491983867/ch03.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="/site/library/view/streaming-systems/9781491983867/ch03.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="/site/library/view/streaming-systems/9781491983867/ch03.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#">Add Highlight</a></li>
		<li class="add-note"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#">
			
				Add Note
			
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/streaming-systems/9781491983867/ch02.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">2. The What, Where, When, and How of Data Processing</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/streaming-systems/9781491983867/ch04.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">4. Advanced Windowing</div>
        </a>
    
  
  </div>


        
    </section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag collapsed slideUp">
        
        
          
          
            <p class="usage-data">Find answers on the fly, or master something new. Subscribe today. <a href="https://www.safaribooksonline.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
          

          
        
        

      </div>

    
    



        
      </div>
      




  <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li>
      <a class="t-queue-footer" href="https://www.safaribooksonline.com/playlists/">Playlists</a>
      </li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/preferences/">Settings</a></li>
      <li class="full-support"><a href="https://www.oreilly.com/online-learning/support/">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2018 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    
    
      <img src="https://www.oreilly.com/library/view/oreilly_set_cookie/" alt="" style="display:none;">
    
    
    
  

<div class="annotator-notice"></div><div class="font-flyout" style="top: 151px; left: 1356px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="/site/library/view/streaming-systems/9781491983867/ch03.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="/site/library/view/streaming-systems/9781491983867/ch03.html#">Reset</a>
</div>
</div>
<div style="width:0px; height:0px; display:none; visibility:hidden;" id="batBeacon0.25746430373595364"><img style="width:0px; height:0px; display:none; visibility:hidden;" id="batBeacon0.06251248562713374" width="0" height="0" alt="" src="https://bat.bing.com/action/0?ti=5794699&amp;Ver=2&amp;mid=39faf51a-325d-9f96-cb09-2c228b9ff500&amp;pi=1200101525&amp;lg=en-US&amp;sw=1440&amp;sh=900&amp;sc=24&amp;tl=3.%20Watermarks%20-%20Streaming%20Systems&amp;p=https%3A%2F%2Fwww.safaribooksonline.com%2Flibrary%2Fview%2Fstreaming-systems%2F9781491983867%2Fch03.html&amp;r=&amp;lt=9430&amp;evt=pageLoad&amp;msclkid=N&amp;rn=876417"></div></body></html>
<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/streaming-systems/9781491983867/ch07.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="3905629"
  data-user-uuid="f04af719-1c84-4fc3-9be3-1f1b4622ab99"
  data-username="safaribooksonline122"
  data-account-type="Trial"
  
  data-activated-trial-date="12/09/2018"


  data-archive="9781491983867"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch07.html"
  data-epub-title="Streaming Systems" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class="js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/streaming-systems/9781491983867/ch07.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="3905629" data-user-uuid="f04af719-1c84-4fc3-9be3-1f1b4622ab99" data-username="safaribooksonline122" data-account-type="Trial" data-activated-trial-date="12/09/2018" data-archive="9781491983867" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch07.html" data-epub-title="Streaming Systems" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781491983867"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.0c29511d2d72.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>7. The Practicalities of Persistent State - Streaming Systems</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/5e586a47a3b7.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.e3b0c44298fc.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td,#sbo-rt-content article,#sbo-rt-content aside,#sbo-rt-content canvas,#sbo-rt-content details,#sbo-rt-content embed,#sbo-rt-content figure,#sbo-rt-content figcaption,#sbo-rt-content footer,#sbo-rt-content header,#sbo-rt-content hgroup,#sbo-rt-content menu,#sbo-rt-content nav,#sbo-rt-content output,#sbo-rt-content ruby,#sbo-rt-content section,#sbo-rt-content summary,#sbo-rt-content time,#sbo-rt-content mark,#sbo-rt-content audio,#sbo-rt-content video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}#sbo-rt-content article,#sbo-rt-content aside,#sbo-rt-content details,#sbo-rt-content figcaption,#sbo-rt-content figure,#sbo-rt-content footer,#sbo-rt-content header,#sbo-rt-content hgroup,#sbo-rt-content menu,#sbo-rt-content nav,#sbo-rt-content section{display:block}#sbo-rt-content div{line-height:1}#sbo-rt-content ol,#sbo-rt-content ul{list-style:none}#sbo-rt-content blockquote,#sbo-rt-content q{quotes:none}#sbo-rt-content blockquote:before,#sbo-rt-content blockquote:after,#sbo-rt-content q:before,#sbo-rt-content q:after{content:none}#sbo-rt-content table{border-collapse:collapse;border-spacing:0}@page{margin:5px !important}#sbo-rt-content p{margin:10px 0 0;line-height:125%;text-align:left}#sbo-rt-content p.byline{text-align:left;margin:-33px auto 35px;font-style:italic;font-weight:bold}#sbo-rt-content div.preface p+p.byline{margin:1em 0 0 !important}#sbo-rt-content div.preface p.byline+p.byline{margin:0 !important}#sbo-rt-content div.sect1>p.byline{margin:-.25em 0 1em}#sbo-rt-content div.sect1>p.byline+p.byline{margin-top:-1em}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link,#sbo-rt-content a{text-decoration:none;color:#8e0012}#sbo-rt-content span.lineannotation{font-style:italic;color:#a62a2a;font-family:serif}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#fff}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important;margin-bottom:30px !important}#sbo-rt-content section[data-type="sect1"] h1{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content section[data-type="sect2"] h2{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content section[data-type="sect3"] h3{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content section[data-type="sect4"] h4{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section[data-type="chapter"]>div>h1,#sbo-rt-content section[data-type="preface"]>div>h1,#sbo-rt-content section[data-type="appendix"]>div>h1,#sbo-rt-content section[data-type="glossary"]>div>h1,#sbo-rt-content section[data-type="bibliography"]>div>h1,#sbo-rt-content section[data-type="index"]>div>h1{font-size:2em;line-height:1;margin-bottom:50px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content span.label,#sbo-rt-content span.keep-together{font-size:inherit;font-weight:inherit}#sbo-rt-content div[data-type="part"] h1{font-size:2em;text-align:center;margin-top:0 !important;margin-bottom:50px;padding:50px 0 10px 0;border-bottom:1px solid #000}#sbo-rt-content img.width-ninety{width:90%}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center !important;margin:15px 0 15px 0 !important;page-break-inside:avoid}#sbo-rt-content figure{margin:15px 0 15px 0 !important;page-break-inside:avoid}#sbo-rt-content div.figure h6,#sbo-rt-content figure h6,#sbo-rt-content figure figcaption{font-size:.9rem !important;text-align:center;font-weight:normal !important;font-style:italic;font-family:serif !important;text-transform:none !important;letter-spacing:normal !important;color:#000 !important;padding-top:10px !important;page-break-before:avoid}#sbo-rt-content div.informalfigure{text-align:center !important;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:15px 0 10px 0 !important;border:1px solid #DCDCDC;background-color:#F7F7F7;padding:15px !important;page-break-inside:avoid}#sbo-rt-content aside[data-type="sidebar"]{margin:15px 0 10px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title,#sbo-rt-content aside[data-type="sidebar"] h5{font-weight:bold;font-size:1em;font-family:sans-serif;text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar ol,#sbo-rt-content div.sidebar ul,#sbo-rt-content aside[data-type="sidebar"] ol,#sbo-rt-content aside[data-type="sidebar"] ul{margin-left:1.25em !important}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content aside[data-type="sidebar"] figcaption,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif !important;color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div[data-type="tip"],#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div[data-type="note"],#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div[data-type="warning"],#sbo-rt-content div.sidebar div[data-type="caution"],#sbo-rt-content div.sidebar div[data-type="important"]{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content aside[data-type="sidebar"] p.byline{font-size:90%;font-weight:bold;font-style:italic;text-align:center;text-indent:0;margin:5px auto 6px;page-break-after:avoid}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;overflow-wrap:break-word}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;overflow-wrap:break-word}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div[data-type="example"]{margin:10px 0 15px 0 !important}#sbo-rt-content div[data-type="example"] h1,#sbo-rt-content div[data-type="example"] h2,#sbo-rt-content div[data-type="example"] h3,#sbo-rt-content div[data-type="example"] h4,#sbo-rt-content div[data-type="example"] h5,#sbo-rt-content div[data-type="example"] h6{font-style:italic;font-weight:normal;text-align:left !important;text-transform:none !important;font-family:serif !important;margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div[data-type="example"] pre[data-type="programlisting"],#sbo-rt-content div[data-type="example"] pre[data-type="screen"]{margin:0}#sbo-rt-content section[data-type="titlepage"]>div>h1{font-size:2em;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content section[data-type="titlepage"] h2,#sbo-rt-content section[data-type="titlepage"] p.subtitle,#sbo-rt-content section[data-type="titlepage"] p[data-type="subtitle"]{font-size:1.3em;font-weight:normal;text-align:center;margin-top:.5em;color:#555}#sbo-rt-content section[data-type="titlepage"]>div>h2[data-type="author"],#sbo-rt-content section[data-type="titlepage"] p.author{font-size:1.3em;font-family:serif !important;font-weight:bold;margin:50px 0 !important;text-align:center}#sbo-rt-content section[data-type="titlepage"] p.edition{text-align:center;text-transform:uppercase;margin-top:2em}#sbo-rt-content section[data-type="titlepage"]{text-align:center}#sbo-rt-content section[data-type="titlepage"]:after{content:url(css_assets/titlepage_footer_ebook.png);margin:0 auto;max-width:80%}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content ul.stafflist{margin:15px 0 15px 20px !important}#sbo-rt-content ul.stafflist li{list-style-type:none;padding:5px 0}#sbo-rt-content ul.printings li{list-style-type:none}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif !important;font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif !important;margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif !important;font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10px}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif !important}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-style:italic;margin:.75em 0 0 !important}#sbo-rt-content blockquote div.attribution,#sbo-rt-content blockquote p[data-type="attribution"]{margin:5px 0 10px 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p,#sbo-rt-content blockquote p[data-type="attribution"]{font-style:normal;margin-top:5px}#sbo-rt-content blockquote div.attribution p:before,#sbo-rt-content blockquote p[data-type="attribution"]:before{font-style:normal;content:"—";-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div[data-type="footnotes"]{border-top:1px solid black;margin-top:1.5em}#sbo-rt-content sub,#sbo-rt-content sup{font-size:75%;line-height:0;position:relative}#sbo-rt-content sup{top:-.5em}#sbo-rt-content sub{bottom:-.25em}#sbo-rt-content div.refentry p.refname{font-size:1em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin-bottom:5px;overflow:auto;width:100%}#sbo-rt-content div.refentry{width:100%;display:block;margin-top:2em}#sbo-rt-content div.refsynopsisdiv{display:block;clear:both}#sbo-rt-content div.refentry header{page-break-inside:avoid !important;display:block;break-inside:avoid !important;padding-top:0;border-bottom:1px solid #000}#sbo-rt-content div.refsect1 h6{font-size:.9em;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content div.refsect1{margin-top:3em}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dd{margin-left:1.5em !important;margin-bottom:.25em}#sbo-rt-content dd ol,#sbo-rt-content dd ul{padding-left:1em}#sbo-rt-content dd li{margin-top:0;margin-bottom:0}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ul,#sbo-rt-content ul>li,#sbo-rt-content ol ul,#sbo-rt-content ol ul>li,#sbo-rt-content ul ol ul,#sbo-rt-content ul ol ul>li{list-style-type:disc}#sbo-rt-content ul ul,#sbo-rt-content ul ul>li{list-style-type:square}#sbo-rt-content ul ul ul,#sbo-rt-content ul ul ul>li{list-style-type:circle}#sbo-rt-content ol,#sbo-rt-content ol>li,#sbo-rt-content ol ul ol,#sbo-rt-content ol ul ol>li,#sbo-rt-content ul ol,#sbo-rt-content ul ol>li{list-style-type:decimal}#sbo-rt-content ol ol,#sbo-rt-content ol ol>li{list-style-type:lower-alpha}#sbo-rt-content ol ol ol,#sbo-rt-content ol ol ol>li{list-style-type:lower-roman}#sbo-rt-content ol,#sbo-rt-content ul{list-style-position:outside;margin:15px 0 15px 1.25em;padding-left:2.25em}#sbo-rt-content ol li,#sbo-rt-content ul li{margin:.5em 0 .65em;line-height:125%}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist,#sbo-rt-content ul.simplelist{margin:15px 0 15px 20px !important}#sbo-rt-content ul.simplelist li{list-style-type:none;padding:5px 0}#sbo-rt-content table.simplelist td{border:none}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content dl.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content dl.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content dl.calloutlist img,#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div[data-type="tip"],#sbo-rt-content div.note,#sbo-rt-content div[data-type="note"],#sbo-rt-content div.warning,#sbo-rt-content div[data-type="warning"],#sbo-rt-content div[data-type="caution"],#sbo-rt-content div[data-type="important"]{margin:30px !important;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip ol,#sbo-rt-content div.tip ul,#sbo-rt-content div[data-type="tip"] ol,#sbo-rt-content div[data-type="tip"] ul,#sbo-rt-content div.note ol,#sbo-rt-content div.note ul,#sbo-rt-content div[data-type="note"] ol,#sbo-rt-content div[data-type="note"] ul,#sbo-rt-content div.warning ol,#sbo-rt-content div.warning ul,#sbo-rt-content div[data-type="warning"] ol,#sbo-rt-content div[data-type="warning"] ul,#sbo-rt-content div[data-type="caution"] ol,#sbo-rt-content div[data-type="caution"] ul,#sbo-rt-content div[data-type="important"] ol,#sbo-rt-content div[data-type="important"] ul{margin-left:1.5em !important}#sbo-rt-content div.tip,#sbo-rt-content div[data-type="tip"],#sbo-rt-content div.note,#sbo-rt-content div[data-type="note"]{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div[data-type="warning"],#sbo-rt-content div[data-type="caution"],#sbo-rt-content div[data-type="important"]{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div[data-type="tip"] h6,#sbo-rt-content div[data-type="tip"] h1,#sbo-rt-content div.note h3,#sbo-rt-content div[data-type="note"] h6,#sbo-rt-content div[data-type="note"] h1,#sbo-rt-content div.warning h3,#sbo-rt-content div[data-type="warning"] h6,#sbo-rt-content div[data-type="warning"] h1,#sbo-rt-content div[data-type="caution"] h6,#sbo-rt-content div[data-type="caution"] h1,#sbo-rt-content div[data-type="important"] h1,#sbo-rt-content div[data-type="important"] h6{font-weight:bold;font-size:110%;font-family:sans-serif !important;text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div[data-type="tip"] figure h6,#sbo-rt-content div[data-type="note"] figure h6,#sbo-rt-content div[data-type="warning"] figure h6,#sbo-rt-content div[data-type="caution"] figure h6,#sbo-rt-content div[data-type="important"] figure h6{font-family:serif !important}#sbo-rt-content div.tip h3,#sbo-rt-content div[data-type="tip"] h6,#sbo-rt-content div.note h3,#sbo-rt-content div[data-type="note"] h6,#sbo-rt-content div[data-type="tip"] h1,#sbo-rt-content div[data-type="note"] h1{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div[data-type="warning"] h6,#sbo-rt-content div[data-type="caution"] h6,#sbo-rt-content div[data-type="important"] h6,#sbo-rt-content div[data-type="warning"] h1,#sbo-rt-content div[data-type="caution"] h1,#sbo-rt-content div[data-type="important"] h1{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note,#sbo-rt-content div.safarienabled{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3,#sbo-rt-content div.safarienabled h6{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px 0 30px 0 !important;max-width:95%;border:none !important;background:none;display:table !important}#sbo-rt-content div.table,#sbo-rt-content div.informaltable,#sbo-rt-content table{page-break-inside:avoid}#sbo-rt-content tr,#sbo-rt-content tr td{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td,#sbo-rt-content thead th{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif;font-weight:bold}#sbo-rt-content td,#sbo-rt-content th{display:table-cell;padding:.3em;text-align:left;vertical-align:middle;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title,#sbo-rt-content table caption{font-weight:normal;font-style:italic;font-family:serif;font-size:1em;margin:10px 0 10px 0 !important;padding:0;page-break-after:avoid;text-align:left !important}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation,#sbo-rt-content div[data-type="equation"]{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title,#sbo-rt-content div[data-type="equation"] h5{font-style:italic;font-weight:normal;font-family:serif !important;font-size:90%;margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content div[data-type="equation"] math{font-size:calc(.35em + 1vw)}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{text-indent:0}#sbo-rt-content div.index h3{padding:.25em;margin-top:1em !important;background-color:#F0F0F0}#sbo-rt-content div.index li{line-height:130%;list-style-type:none}#sbo-rt-content div.index a.indexterm{color:#8e0012 !important}#sbo-rt-content div.index ul{margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.index ul ul{margin-left:1em !important;margin-top:0 !important}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif;text-align:left}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content .what_lt{color:#c90;}#sbo-rt-content .where_lt{color:#26c}#sbo-rt-content .when_lt{color:#6a5;}#sbo-rt-content .how_lt{color:#c00}#sbo-rt-content .what_dk{color:#ffd040}#sbo-rt-content .where_dk{color:#6af}#sbo-rt-content .when_dk{color:#8ac86f}#sbo-rt-content .how_dk{color:#d77}#sbo-rt-content .grey_bg{background-color:#ff0}#sbo-rt-content .yellow_bg{background-color:#ff0}#sbo-rt-content .green_bg{background-color:#00FF7F}#sbo-rt-content .red_bg{background-color:#FFA07A}#sbo-rt-content .blue_bg{background-color:#87CEEB}#sbo-rt-content .code_blue{color:#00f}#sbo-rt-content .code_grey{color:#777}#sbo-rt-content .code_orange{color:#d83}#sbo-rt-content .code_purple{color:#87c}#sbo-rt-content .code_lightgrey{color:#C0C0C0}#sbo-rt-content .strikethrough{text-decoration:line-through}#sbo-rt-content .table_white{color:white}#sbo-rt-content .table_black{color:black}#sbo-rt-content .table_red{color:#d77}#sbo-rt-content .table_green{color:#8ac86f}#sbo-rt-content .table_blue{color:#00f}#sbo-rt-content .table_mediumgrey{background-color:#404040}#sbo-rt-content .table_lightgrey{background-color:#606060}#sbo-rt-content .table_darkgrey{background-color:#202020}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html"><meta name="description" content=" Chapter 7. The Practicalities of Persistent State Why do people write books? When you factor out the joy of creativity, a certain fondness for grammar and punctuation, and perhaps the ... "><meta property="og:title" content="7. The Practicalities of Persistent State"><meta itemprop="isPartOf" content="/library/view/streaming-systems/9781491983867/"><meta itemprop="name" content="7. The Practicalities of Persistent State"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch07.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781491983867/"><meta property="og:description" itemprop="description" content=" Chapter 7. The Practicalities of Persistent State Why do people write books? When you factor out the joy of creativity, a certain fondness for grammar and punctuation, and perhaps the ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781491983874"><meta property="og:book:author" itemprop="author" content="Reuven Lax"><meta property="og:book:author" itemprop="author" content="Slava Chernyak"><meta property="og:book:author" itemprop="author" content="Tyler Akidau"><meta property="og:book:tag" itemprop="about" content="Databases"><meta property="og:book:tag" itemprop="about" content="Engineering"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts subscribe-panel library" data-gr-c-s-loaded="true">

    
  
  
  



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        





<a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/playlists/" class="t-queue-nav l0 nav-icn None"><!--?xml version="1.0" encoding="UTF-8"?--><svg width="21px" height="17px" viewBox="0 0 21 17" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!-- Generator: Sketch 46.2 (44496) - http://www.bohemiancoding.com/sketch --><title>icon_Playlist_sml</title><desc>Created with Sketch.</desc><defs></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="icon_Playlist_sml" fill-rule="nonzero" fill="#000000"><g id="playlist-icon"><g id="Group-6"><rect id="Rectangle-path" x="5" y="0" width="16" height="3" rx="0.5"></rect><circle id="Oval" cx="1.5" cy="1.5" r="1.5"></circle></g><g id="Group-5" transform="translate(0.000000, 7.000000)"><circle id="Oval" cx="1.5" cy="1.5" r="1.5"></circle><rect id="Rectangle-path" x="5" y="0" width="16" height="3" rx="0.5"></rect></g><g id="Group-5-Copy" transform="translate(0.000000, 14.000000)"><circle id="Oval" cx="1.5" cy="1.5" r="1.5"></circle><rect id="Rectangle-path" x="5" y="0" width="16" height="3" rx="0.5"></rect></g></g></g></g></svg><span>
               Playlists
            </span></a></li><li class="search"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" width="20" height="20" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>offers icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M35.9 20.6L27 15.5C26.1 15 24.7 15 23.7 15.5L14.9 20.6C13.9 21.1 13.2 22.4 13.2 23.4L13.2 41.4C13.2 42.4 13.9 43.7 14.9 44.2L23.3 49C24.2 49.5 25.6 49.5 26.6 49L35.9 43.6C36.8 43.1 37.6 41.8 37.6 40.8L37.6 23.4C37.6 22.4 36.8 21.1 35.9 20.6L35.9 20.6ZM40 8.2C39.1 7.6 37.6 7.6 36.7 8.2L30.2 11.9C29.3 12.4 29.3 13.2 30.2 13.8L39.1 18.8C40 19.4 40.7 20.6 40.7 21.7L40.7 39C40.7 40.1 41.4 40.5 42.4 40L48.2 36.6C49.1 36.1 49.8 34.9 49.8 33.8L49.8 15.6C49.8 14.6 49.1 13.3 48.2 12.8L40 8.2 40 8.2ZM27 10.1L33.6 6.4C34.5 5.9 34.5 5 33.6 4.5L26.6 0.5C25.6 0 24.2 0 23.3 0.5L16.7 4.2C15.8 4.7 15.8 5.6 16.7 6.1L23.7 10.1C24.7 10.6 26.1 10.6 27 10.1ZM10.1 21.7C10.1 20.6 10.8 19.4 11.7 18.8L20.6 13.8C21.5 13.2 21.5 12.4 20.6 11.9L13.6 7.9C12.7 7.4 11.2 7.4 10.3 7.9L1.6 12.8C0.7 13.3 0 14.6 0 15.6L0 33.8C0 34.9 0.7 36.1 1.6 36.6L8.4 40.5C9.3 41 10.1 40.6 10.1 39.6L10.1 21.7 10.1 21.7Z"></path></g></svg><span>Offers &amp; Deals</span></a><ul class="flyout"><li><a href="https://get.oreilly.com/email-signup.html" target="_blank" class="l2 nav-icn"><span>Newsletters</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/f04af719-1c84-4fc3-9be3-1f1b4622ab99/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" width="20" height="20" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/preferences/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://www.oreilly.com/online-learning/support/" class="l1 no-icon">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/preferences/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a><span class="l2 t-nag-notification" id="nav-nag"><strong class="trial-green">10</strong> days left in your trial.
  
  

  
    
      

<a class="" href="https://www.safaribooksonline.com/subscribe/">Subscribe</a>.


    
  

  

</span></li><li><a href="https://www.oreilly.com/online-learning/support/" class="l2">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Streaming Systems
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9781491983867/chapter/ch07.html"><div class="js-collections-dropdown collections-dropdown menu-bit-cards"></div></div></li><li class="js-font-control-panel font-control-activator"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch07.html&amp;text=Streaming%20Systems&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch07.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch07.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%207.%20The%20Practicalities%20of%20Persistent%20State&amp;body=https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/ch07.html%0D%0Afrom%20Streaming%20Systems%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
        
        



 <!--[if lt IE 9]>
  
<![endif]-->



  


        
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">6. Streams and Tables</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch08.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">8. Streaming SQL</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content" style="transform: none;"><div class="annotator-wrapper"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. The Practicalities of Persistent State"><div class="chapter" id="practicalities_of_persistent_state">
<h1><span class="label">Chapter 7. </span>The Practicalities of Persistent State</h1>

<p>Why do people write books?<a contenteditable="false" data-primary="persistent state" data-type="indexterm" id="ix_perst"></a> When you factor out the joy of creativity, a certain fondness for grammar and punctuation, and perhaps the occasional touch of narcissism, you’re basically left with the desire to capture an otherwise ephemeral idea so that it can be revisited in the future. At a very high level, I’ve just motivated and explained persistent state in data processing pipelines.</p>

<p>Persistent state is, quite literally, the tables we just talked about in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html#streams_and_tables">Chapter&nbsp;6</a>, with the additional requirement that the tables be robustly stored in a media relatively immune to loss.<a contenteditable="false" data-primary="tables" data-secondary="persistent state" data-type="indexterm" id="idm140176513026480"></a> Stored on local disk counts, as long as you don’t ask your Site Reliability Engineers. Stored on a replicated set of disks is better. Stored on a replicated set of disks in distinct physical locations is better still. Stored in memory once definitely doesn’t count. Stored in replicated memory across multiple machines with UPS power backup and generators onsite maybe does. You get the picture.</p>

<p>In this chapter, our objective is to do the following:</p>

<ul>
	<li>
	<p>Motivate the need for persistent state within pipelines</p>
	</li>
	<li>
	<p>Look at two forms of implicit state often found within pipelines</p>
	</li>
	<li>
	<p>Consider a real-world use case (advertising conversion attribution) that lends itself poorly to implicit state, use that to motivate the salient features of a general, explicit form of persistent state management</p>
	</li>
	<li>
	<p>Explore a concrete manifestation of one such state API, as found in Apache Beam</p>
	</li>
</ul>

<section data-type="sect1" data-pdf-bookmark="Motivation"><div class="sect1" id="idm140176513019680">
<h1>Motivation</h1>

<p>To begin, let’s more precisely motivate persistent state. <a contenteditable="false" data-primary="persistent state" data-secondary="motivation for" data-type="indexterm" id="ix_persmoti"></a>We know from <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html#streams_and_tables">Chapter&nbsp;6</a> that grouping is what gives us tables. And the core of what I postulated at the beginning of this chapter was correct: the point of persisting these tables is to capture the otherwise ephemeral data contained therein. But why is that necessary?</p>

<section data-type="sect2" data-pdf-bookmark="The Inevitability of Failure"><div class="sect2" id="idm140176513015120">
<h2>The Inevitability of Failure</h2>

<p>The answer to that question is most clearly seen in the case of processing unbounded input data, so we’ll start there.<a contenteditable="false" data-primary="failures, inevitability of" data-type="indexterm" id="idm140176513013456"></a><a contenteditable="false" data-primary="persistent state" data-secondary="motivation for" data-tertiary="inevitability of failure" data-type="indexterm" id="idm140176513012288"></a> The main issue is that pipelines processing unbounded data are effectively intended to run forever. But running forever is a far more demanding Service-Level Objective than can be achieved by the environments in which these pipelines typically execute. Long-running pipelines will inevitably see interruptions thanks to machine failures, planned maintenance, code changes, and the occasional misconfigured command that takes down an entire cluster of production pipelines. To ensure that they can resume where they left off when these kinds of things happen, long-running pipelines need some sort of durable recollection of where they were before the interruption. That’s where persistent state comes in.</p>

<p>Let’s expand on that idea a bit beyond unbounded data. Is this only relevant in the unbounded case? <a contenteditable="false" data-primary="batch processing" data-secondary="persistent state in" data-type="indexterm" id="idm140176513009248"></a>Do batch pipelines use persistent state, and why or why not? As with nearly every other batch-versus-streaming question we’ve come across, the answer has less to do with the nature of batch and streaming systems themselves (perhaps unsurprising given what we learned in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html#streams_and_tables">Chapter&nbsp;6</a>), and more to do with the types of datasets they historically have been used to process.</p>

<p>Bounded datasets by nature are finite in size.<a contenteditable="false" data-primary="bounded datasets" data-secondary="recomputation on failure" data-type="indexterm" id="idm140176513005904"></a> As a result, systems that process bounded data (historically batch systems) have been tailored to that use case. They often assume that the input can be reprocessed in its entirety upon failure. In other words, if some piece of the processing pipeline fails and if the input data are still available, we can simply restart the appropriate piece of the processing pipeline and let it read the same input again.<a contenteditable="false" data-primary="reprocessing the input" data-type="indexterm" id="idm140176513004032"></a> This is called <em>reprocessing the input</em>.</p>

<p>They might also assume failures are infrequent and thus optimize for the common case by persisting as little as possible, accepting the extra cost of recomputation upon failure.<a contenteditable="false" data-primary="checkpointing" data-secondary="in bounded datasets on batch processing pipelines" data-type="indexterm" id="idm140176513001728"></a> For particularly expensive, multistage pipelines, there might be some sort of per-stage global checkpointing that allows for more efficiently resuming execution (typically as part of a shuffle), but it’s not a strict requirement and might not be present in many systems.</p>

<p>Unbounded datasets, on the other hand, must be assumed to have infinite size. As a result, systems that process unbounded data (historically streaming systems) have been built to match.<a contenteditable="false" data-primary="checkpointing" data-secondary="in processing of unbounded datasets" data-type="indexterm" id="idm140176512999216"></a> They never assume that all of the data will be available for reprocessing, only some known subset of it. To provide at-least-once or exactly-once semantics, any data that are no longer available for reprocessing must be accounted for in durable checkpoints. And if at-most-once is all you’re going for, you don’t need checkpointing.</p>

<p>At the end of the day, there’s nothing batch- or streaming-specific about persistent state. State can be useful in both circumstances. It just happens to be critical when processing unbounded data, so you’ll find that streaming systems typically provide more sophisticated support for persistent state.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Correctness and Efficiency"><div class="sect2" id="idm140176512996480">
<h2>Correctness and Efficiency</h2>

<p>Given the inevitability of failures and the need to cope with them, persistent state can be seen<a contenteditable="false" data-primary="persistent state" data-secondary="motivation for" data-tertiary="correctness and efficiency" data-type="indexterm" id="idm140176512995072"></a> as providing two things:</p>

<ul>
	<li>
	<p>A <em>basis for correctness</em> in light of ephemeral inputs. <a contenteditable="false" data-primary="correctness" data-secondary="persistent stte as basis for" data-type="indexterm" id="idm140176512991440"></a>When processing bounded data, it’s often safe to assume inputs stay around forever;<sup><a data-type="noteref" id="idm140176512989872-marker" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512989872" class="totri-footnote">1</a></sup> with unbounded data, this assumption typically falls short of reality. Persistent state allows you to keep around the intermediate bits of information necessary to allow processing to continue when the inevitable happens, even after your input source has moved on and forgotten about records it gave you previously.</p>
	</li>
	<li>
	<p>A way to <em>minimize work duplicated and data persisted</em> as part of coping with failures. <a contenteditable="false" data-primary="efficiency" data-secondary="persistent data, minimizing work duplicated and data persistend" data-type="indexterm" id="idm140176512987296"></a>Regardless of whether your inputs are ephemeral, when your pipeline experiences a machine failure, any work on the failed machine that wasn’t checkpointed somewhere must be redone. Depending upon the nature of the pipeline and its inputs, this can be costly in two dimensions: the amount of work performed during reprocessing, and the amount of input data stored to support reprocessing.</p>

	<p>Minimizing duplicated work is relatively straightforward.<a contenteditable="false" data-primary="duplicated work, minimizing with persistent state" data-type="indexterm" id="idm140176512984960"></a> By checkpointing partial progress<a contenteditable="false" data-primary="checkpointing" data-secondary="partial progress within a pipeline" data-type="indexterm" id="idm140176512983504"></a> within a pipeline (both the intermediate results computed as well as the current location within the input as of checkpointing time), it’s possible to greatly reduce the amount of work repeated when failures occur because none of the operations that came before the checkpoint need to be replayed from durable inputs. Most commonly, this involves data at rest (i.e., tables), which is why we typically refer to persistent state in the context of tables and grouping. <a contenteditable="false" data-primary="streams" data-secondary="persistent forms of" data-type="indexterm" id="idm140176512981456"></a>But there are persistent forms of streams (e.g., Kafka and its relatives) that serve this function, as well.</p>

	<p>Minimizing the amount of data persisted is a larger discussion, one that will consume a sizeable chunk of this chapter. For now, at least, suffice it to say that, for many real-world use cases, rather than remembering all of the raw inputs within a checkpoint for any given stage in the pipeline, it’s often practical to instead remember some partial, intermediate form of the ongoing calculation that consumes less space than all of the original inputs (for example, when computing a mean, the total sum and the count of values seen are much more compact than the complete list of values contributing to that sum and count). Not only can checkpointing these intermediate data drastically reduce the amount of data that you need to remember at any given point in the pipeline, it also commensurately reduces the amount of reprocessing needed for that specific stage to recover from a failure.</p>

	<p>Furthermore, by intelligently garbage-collecting those bits of<a contenteditable="false" data-primary="garbage collection" data-secondary="bits of persistent state not needed" data-type="indexterm" id="idm140176512978080"></a> persistent state that are no longer needed (i.e., state for records which are known to have been processed completely by the pipeline already), the amount of data stored in persistent state for a given pipeline can be kept to a manageable size over time, even when the inputs are technically infinite. This is how pipelines processing unbounded data can continue to run effectively forever, while still providing strong consistency guarantees but without a need for complete recall of the original inputs to the pipeline.</p>
	</li>
</ul>

<p>At the end of the day, persistent state is really just a means of providing correctness and efficient fault tolerance in data processing pipelines. The amount of support needed in either of those dimensions depends greatly upon the natures of the inputs to the pipeline and the operations being performed. Unbounded inputs tend to require more correctness support than bounded inputs. Computationally expensive operations tend to demand more efficiency support than computationally cheap operations.<a contenteditable="false" data-primary="persistent state" data-secondary="motivation for" data-startref="ix_persmoti" data-type="indexterm" id="idm140176512974752"></a></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Implicit State"><div class="sect1" id="idm140176512972720">
<h1>Implicit State</h1>

<p>Let’s now begin to talk about the practicalities of persistent state. <a contenteditable="false" data-primary="implicit state" data-type="indexterm" id="ix_implst"></a><a contenteditable="false" data-primary="persistent state" data-secondary="implicit state" data-type="indexterm" id="ix_persimpl"></a>In most cases, this essentially boils down to finding the right balance between always persisting everything (good for consistency, bad for efficiency) and never persisting anything (bad for consistency, good for efficiency). We’ll begin at the always-persisting-everything end of the spectrum, and work our way in the other direction, looking at ways of trading off complexity of implementation for efficiency without compromising consistency (because compromising consistency by never persisting anything is the easy way out for cases in which consistency doesn’t matter, and a nonoption, otherwise). As before, we use the Apache Beam APIs to concretely ground our discussions, but the concepts we discuss are applicable across most systems in existence today.</p>

<p>Also, because there isn’t much you can do to reduce the size of raw inputs, short of perhaps compressing the data, our discussion centers around the ways data are persisted within the intermediate state tables created as part of grouping operations within a pipeline. The inherent nature of grouping multiple records together into some sort of composite will provide us with opportunities to eke out gains in efficiency at the cost of implementation complexity.</p>

<section data-type="sect2" data-pdf-bookmark="Raw Grouping"><div class="sect2" id="idm140176512966256">
<h2>Raw Grouping</h2>

<p>The first step in our exploration, at the always-persisting-everything end of the spectrum, is the most straightforward implementation of grouping within a pipeline: raw grouping of the inputs.<a contenteditable="false" data-primary="persistent state" data-secondary="implicit state" data-tertiary="raw grouping of inputs" data-type="indexterm" id="idm140176512964384"></a><a contenteditable="false" data-primary="raw grouping" data-type="indexterm" id="idm140176512962736"></a><a contenteditable="false" data-primary="grouping operations" data-secondary="raw grouping of inputs" data-type="indexterm" id="idm140176512961632"></a> The grouping operation in this case is typically akin to list appending: any time a new element arrives in the group, it’s appended to the list of elements seen for that group.</p>

<p>In Beam, this is exactly what you get when you apply a <code>GroupByKey</code> transform to a <code>PCollection</code>. The stream representing that <code>PCollection</code> in motion is grouped by key to yield a table at rest containing the records from the stream,<sup><a data-type="noteref" id="idm140176512957744-marker" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512957744" class="totri-footnote">2</a></sup> grouped together as lists of values with identical keys. This shows up in the <code>PTransform</code> signature for <code>GroupByKey</code>, which declares the input as a <code>PCollection</code> of <code>K</code>/<code>V</code> pairs, and the output as a collection of <code>K</code>/<code>Iterable&lt;V&gt;</code> pairs:</p>

<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">GroupByKey</code><code class="o">&lt;</code><code class="n">K</code><code class="o">,</code> <code class="n">V</code><code class="o">&gt;</code> <code class="kd">extends</code> <code class="n">PTransform</code><code class="o">&lt;</code>
    <code class="n">PCollection</code><code class="o">&lt;</code><code class="n">KV</code><code class="o">&lt;</code><code class="n">K</code><code class="o">,</code> <code class="n">V</code><code class="o">&gt;&gt;,</code> <code class="n">PCollection</code><code class="o">&lt;</code><code class="n">KV</code><code class="o">&lt;</code><code class="n">K</code><code class="o">,</code> <code class="n">Iterable</code><code class="o">&lt;</code><code class="n">V</code><code class="o">&gt;&gt;&gt;&gt;&gt;</code>
</pre>

<p>Every time a trigger fires for a key+window in that table, it will emit a new pane for that key+window, with the value being the <code>Iterable&lt;V&gt;</code> we see in the preceding signature.</p>

<p>Let’s look at an example in action in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#early_on_time_and_late_chap_seven">Example&nbsp;7-1</a>. We’ll take the summation pipeline from <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html#early_on_time_and_late_firings_via_the_early_on_time_late_api_chap_six">Example&nbsp;6-5</a> (the one with fixed windowing and early/on-time/late triggers) and convert it to use raw grouping instead of incremental combination (which we discuss a little later in this chapter). We do this by first applying a <code>GroupByKey</code> transformation to the parsed user/score key/value pairs. The <code>GroupByKey</code> operation performs raw grouping, yielding a <code>PCollection</code> with key/value pairs of users and <code>Iterable&lt;Integer&gt;</code> groups of scores. We then sum up all of the <code>Integer</code>s in each iterable by using a simple <code>MapElements</code> lambda that converts the <code>Iterable&lt;Integer&gt;</code> into an <code>IntStream&lt;Integer&gt;</code> and calls <code>sum</code> on it.</p>

<div data-type="example" id="early_on_time_and_late_chap_seven">
<h5><span class="label">Example 7-1. </span>Early, on-time, and late firings via the early/on-time/late API</h5>

<pre data-type="programlisting">PCollection&lt;String&gt; raw = IO.read(...);
PCollection&lt;KV&lt;Team, Integer&gt;&gt; input = raw.apply(<span class="what_lt">new ParseFn()</span>);
PCollection&lt;KV&lt;Team, Integer&gt;&gt; <span class="yellow_bg">groupedScores</span> = input
  .apply(<span class="where_lt">Window.into(FixedWindows.of(TWO_MINUTES))</span>
               <span class="when_lt">.triggering(</span>
                 <span class="when_lt">AfterWatermark()</span>
                   <span class="when_lt">.withEarlyFirings(AlignedDelay(ONE_MINUTE))</span>
                   <span class="when_lt">.withLateFirings(AfterCount(1)))</span>)
  .apply(<span class="what_lt yellow_bg">GroupBy.&lt;String, Integer&gt;create()</span>);
<span class="yellow_bg">PCollection&lt;KV&lt;Team, Integer&gt;&gt; totals = input</span>
  <span class="yellow_bg">.apply(<span class="what_lt">MapElements.via((KV&lt;String, Iterable&lt;Integer&gt;&gt; kv) -&gt;</span></span>
    <span class="what_lt yellow_bg">StreamSupport.intStream(</span>
      <span class="what_lt yellow_bg">kv.getValue().spliterator(), false).sum())</span>);
</pre>
</div>

<p>Looking at this pipeline in action, we would see something like that depicted in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#summation_via_raw_grouping_of_input_with_windowing">Figure&nbsp;7-1</a>.</p>

<figure><div id="summation_via_raw_grouping_of_input_with_windowing" class="figure">
<video style="margin: 0 auto; max-width: 100%;" controls="controls" poster="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0701.png" autoplay="autoplay" loop="loop">
<source src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0701.mp4" type="video/mp4"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0701.png" alt="Summation via raw grouping of inputs with windowing and early/on-time/late triggering. The raw inputs are grouped together and stored in the table via the GroupByKey transformation. After being triggered, the MapElements lambda sums the raw inputs within a single pane together to yield per-team scores." width="600" height="405" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0701.png">
</video>
<h6><span class="label">Figure 7-1. </span>Summation via raw grouping of inputs with windowing and early/on-time/late triggering. The raw inputs are grouped together and stored in the table via the GroupByKey transformation. After being triggered, the MapElements lambda sums the raw inputs within a single pane together to yield per-team scores.</h6>
</div></figure>

<p>Comparing this to <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html#streams_and_tables_view_of_windowed_summation">Figure&nbsp;6-10</a> (which was using incremental combining, discussed shortly), it’s clear to see this is a lot worse. <a contenteditable="false" data-primary="streams and tables" data-secondary="view of windowed summation" data-type="indexterm" id="idm140176512899248"></a>First, we’re storing a lot more data: instead of a single integer per window, we now store all the inputs for that window. Second, if we have multiple trigger firings, we’re duplicating effort by re-summing inputs we already added together for previous trigger firings. And finally, if the grouping operation is the point at which we checkpoint our state to persistent storage, upon machine failure we again must recompute the sums for any retriggerings of the table. That’s a lot of duplicated data and computation. Far better would be to incrementally compute and checkpoint the actual sums, which is an example of <em>incremental combining</em>.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Incremental Combining"><div class="sect2" id="idm140176512965632">
<h2>Incremental Combining</h2>

<p>The first step in our journey of trading implementation complexity for efficiency is incremental combining.<a contenteditable="false" data-primary="incremental combination" data-type="indexterm" id="ix_incr"></a><a contenteditable="false" data-primary="persistent state" data-secondary="implicit state" data-tertiary="in incremental combining" data-type="indexterm" id="idm140176512893280"></a> This concept is manifested in the <a contenteditable="false" data-primary="Apache Beam" data-secondary="CombineFn API" data-type="indexterm" id="idm140176512891536"></a>Beam API<a contenteditable="false" data-primary="CombineFn class (Beam)" data-type="indexterm" id="idm140176512890032"></a> via the <code><span class="keep-together">CombineFn</span></code> class. In a nutshell, incremental combining is a form of automatic state built upon a user-defined<a contenteditable="false" data-primary="combination, incremental" data-see="incremental combination" data-type="indexterm" id="idm140176512887776"></a> associative and commutative combining operator (if you’re not sure what I mean by these two terms, I define them more precisely in a moment). Though not strictly necessary for the discussion that follows, the important parts of the CombineFn API look like <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#abbreviated_combinefn_api_from_apache_beam">Example&nbsp;7-2</a>.</p>

<div data-type="example" id="abbreviated_combinefn_api_from_apache_beam">
<h5><span class="label">Example 7-2. </span>Abbreviated CombineFn API from Apache Beam</h5>

<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">CombineFn</code><code class="o">&lt;</code><code class="n">InputT</code><code class="o">,</code> <code class="n">AccumT</code><code class="o">,</code> <code class="n">OutputT</code><code class="o">&gt;</code> <code class="o">{</code>
    <code class="c1">// Returns an accumulator representing the empty value.</code>
    <code class="n">AccumT</code> <code class="nf">createAccumulator</code><code class="o">();</code>

    <code class="c1">// Adds the given input value into the given accumulator</code>
    <code class="n">AccumT</code> <code class="nf">addInput</code><code class="o">(</code><code class="n">AccumT</code> <code class="n">accumulator</code><code class="o">,</code> <code class="n">InputT</code> <code class="n">input</code><code class="o">);</code>

    <code class="c1">// Merges the given accumulators into a new, combined accumulator</code>
    <code class="n">AccumT</code> <code class="nf">mergeAccumulators</code><code class="o">(</code><code class="n">Iterable</code><code class="o">&lt;</code><code class="n">AccumT</code><code class="o">&gt;</code> <code class="n">accumulators</code><code class="o">);</code>

    <code class="c1">// Returns the output value for the given accumulator</code>
    <code class="n">OutputT</code> <code class="nf">extractOutput</code><code class="o">(</code><code class="n">AccumT</code> <code class="n">accumulator</code><code class="o">);</code>
<code class="o">}</code>
</pre>
</div>

<p>A <code>CombineFn</code> accepts inputs of type <code>InputT</code>, which can be combined together into partial aggregates called <em>accumulators</em>, of type <code>AccumT</code>.<a contenteditable="false" data-primary="accumulators" data-type="indexterm" id="idm140176512803600"></a> These accumulators themselves can also be combined together into new accumulators. And finally, an accumulator can be transformed into an output value of type <code>OutputT</code>. For something like an average, the inputs might be integers, the accumulators pairs of integers (i.e., <code>Pair&lt;sum of inputs, count of inputs&gt;</code>), and the output a single floating-point value representing the mean value of the combined inputs.</p>

<p>But what does all this structure buy us? Conceptually, the basic idea with incremental <a contenteditable="false" data-primary="aggregations" data-secondary="properties of" data-type="indexterm" id="idm140176512800960"></a>combining is that many types of aggregations (sum, mean, etc.) exhibit the following properties:</p>

<ul>
	<li>
	<p>Incremental aggregations possess an <em>intermediate form</em> that captures the <em>partial progress</em> of combining a set of <em>N</em> inputs <em>more compactly</em> than the full list of those inputs themselves (i.e., the <code>AccumT</code> type in <code>CombineFn</code>). As discussed earlier, for mean, this is a sum/count pair. Basic summation is even simpler, with a single number as its accumulator. A histogram would have a relatively complex accumulator composed of buckets, where each bucket contains a count for the number of values seen within some specific range. In all three cases, however, the amount of space consumed by an accumulator that represents the aggregation of <em>N</em> elements remains significantly smaller than the amount of space consumed by the original <em>N</em> elements themselves, particularly as the size of <em>N</em> grows.</p>
	</li>
	<li>
	<p>Incremental aggregations are <em>indifferent to ordering</em> across two dimensions:</p>

	<ul>
		<li>
		<p><em>Individual elements</em>, meaning:</p>

		<p><code>COMBINE(a, b) == COMBINE(b, a)</code></p>
		</li>
		<li>
		<p><em>Groupings of elements</em>, meaning:</p>

		<p><code>COMBINE(COMBINE(a, b), c) == COMBINE(a, COMBINE(b, c))</code></p>
		</li>
	</ul>

	<p>These properties are <a contenteditable="false" data-primary="commutativity" data-type="indexterm" id="idm140176512787760"></a>known as <em>commutativity</em> and <em>associativity</em>, respectively.<a contenteditable="false" data-primary="associativity" data-type="indexterm" id="idm140176512785600"></a> In concert,<sup><a data-type="noteref" id="idm140176512784336-marker" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512784336" class="totri-footnote">3</a></sup> they effectively mean that we are free to combine elements and partial aggregates in any arbitrary order and with any arbitrary subgrouping. This allows us to optimize the aggregation in two ways:</p>

	<dl>
		<dt>Incrementalization</dt>
		<dd>
		<p>Because the order of individual inputs<a contenteditable="false" data-primary="incrementalization of aggregations" data-type="indexterm" id="idm140176512781296"></a> doesn’t matter, <a contenteditable="false" data-primary="aggregations" data-secondary="incrementalization of" data-type="indexterm" id="idm140176512780000"></a>we don’t need to buffer all of the inputs ahead of time and then process them in some strict order (e.g., in order of event time; note, however, that this remains independent of <em>shuffling</em> elements by event time into proper event-time windows before aggregating); we can simply combine them one-by-one as they arrive. This not only greatly reduces the amount of data that must be buffered (thanks to the first property of our operation, which stated the intermediate form was a more compact representation of partial aggregation than the raw inputs themselves), but also spreads the computation load more evenly over time (versus aggregating a burst of inputs all at once after the full input set has been buffered).</p>
		</dd>
		<dt>Parallelization</dt>
		<dd>
		<p>Because the order in which<a contenteditable="false" data-primary="parallelization of aggregations" data-type="indexterm" id="idm140176512775776"></a> partial subgroups<a contenteditable="false" data-primary="aggregations" data-secondary="parallelization of" data-type="indexterm" id="idm140176512774528"></a> of inputs are combined doesn’t matter, we’re free to arbitrarily distribute the computation of those subgroups. More specifically, we’re free to spread the computation of those<a contenteditable="false" data-primary="MapReduce" data-secondary="Combiners" data-type="indexterm" id="idm140176512772800"></a> subgroups across a plurality of machines. This optimization is at the heart of MapReduce’s <code>Combiners</code> (the genesis of Beam’s <code>CombineFn</code>).</p>

		<p>MapReduce’s Combiner optimization is essential to solving the hot-key problem, where some sort of grouping computation is performed on an input stream that is too large to be reasonably processed by a single physical machine. A canonical example is breaking down high-volume analytics data (e.g., web traffic to a popular website) across a relatively low number of dimensions (e.g., by web browser family: Chrome, Firefox, Safari, etc.). For websites with a particularly high volume of traffic, it’s often intractable to calculate stats for any single web browser family on a single machine, even if that’s the only thing that machine is dedicated to doing; there’s simply too much traffic to keep up with. But with an associative and commutative operation like summation, it’s possible to spread the initial aggregation across multiple machines, each of which computes a partial aggregate. The set of partial aggregates generated by those machines (whose size is now many of orders magnitude smaller than the original inputs) might then be further combined together on a single machine to yield the final aggregate result.</p>

		<p>As an aside, this ability to parallelize also yields one additional benefit: the aggregation operation<a contenteditable="false" data-primary="merging windows" data-secondary="in parallelized aggregations" data-type="indexterm" id="idm140176512768352"></a> is naturally compatible with merging windows. When two windows merge, their values must somehow be merged, as well. <a contenteditable="false" data-primary="raw grouping" data-secondary="merging windows" data-type="indexterm" id="idm140176512766704"></a>With raw grouping, this means merging the two full lists of buffered values together, which has a cost of O(N). But with a <code>CombineFn</code>, it’s a simple combination of two partial aggregates, typically an O(1) operation.</p>
		</dd>
	</dl>
	</li>
</ul>

<p>For the sake of <a contenteditable="false" data-primary="aggregations" data-secondary="grouping and summation via incremental combination" data-type="indexterm" id="idm140176512763488"></a>completeness, <a contenteditable="false" data-primary="grouping operations" data-secondary="grouping via incremental combination" data-type="indexterm" id="idm140176512761856"></a>consider<a contenteditable="false" data-primary="summation via incremental combination" data-type="indexterm" id="idm140176512760352"></a> again <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html#early_on_time_and_late_firings_via_the_early_on_time_late_api_chap_six">Example&nbsp;6-5</a>, shown in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#grouping_and_summation_chap_seven">Example&nbsp;7-3</a>, which implements a summation pipeline using incremental combination.</p>

<div data-type="example" id="grouping_and_summation_chap_seven">
<h5><span class="label">Example 7-3. </span>Grouping and summation via incremental combination, as in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html#early_on_time_and_late_firings_via_the_early_on_time_late_api_chap_six">Example&nbsp;6-5</a></h5>

<pre data-type="programlisting">PCollection&lt;String&gt; raw = IO.read(...);
PCollection&lt;KV&lt;Team, Integer&gt;&gt; input = raw.apply(<span class="what_lt">new ParseFn()</span>);
PCollection&lt;KV&lt;Team, Integer&gt;&gt; totals = input
  .apply(<span class="where_lt">Window.into(FixedWindows.of(TWO_MINUTES))</span>
               <span class="when_lt">.triggering(</span>
                 <span class="when_lt">AfterWatermark()</span>
                   <span class="when_lt">.withEarlyFirings(AlignedDelay(ONE_MINUTE))</span>
                   <span class="when_lt">.withLateFirings(AfterCount(1)))</span>)
  .apply(<span class="what_lt">Sum.integersPerKey()</span>);
</pre>
</div>

<p>When executed, we get what we saw <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html#streams_and_tables_view_of_windowed_summation">Figure&nbsp;6-10</a> (shown here in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#grouping_and_summation_via_incremental_combination">Figure&nbsp;7-2</a>). Compared to <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#summation_via_raw_grouping_of_input_with_windowing">Figure&nbsp;7-1</a>, this is clearly a big improvement, with much greater efficiency in terms of amount of data stored and amount of computation performed.</p>

<figure><div id="grouping_and_summation_via_incremental_combination" class="figure">
<video style="margin: 0 auto; max-width: 100%;" controls="controls" poster="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0702.png" autoplay="autoplay" loop="loop">
<source src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0702.mp4" type="video/mp4"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0702.png" alt="Grouping and summation via incremental combination. In this version, incremental sums are computed and stored in the table rather than lists of inputs, which must later be summed together independently." width="600" height="411" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0702.png">
</video>
<h6><span class="label">Figure 7-2. </span>Grouping and summation via incremental combination. In this version, incremental sums are computed and stored in the table rather than lists of inputs, which must later be summed together independently.</h6>
</div></figure>

<p>By providing a more compact intermediate representation for a grouping operation, and by relaxing requirements on ordering (both at the element and subgroup levels), Beam’s <code>CombineFn</code> trades off a certain amount of implementation complexity in exchange for increases in efficiency. In doing so, it provides a clean solution for the hot-key problem and also plays nicely with the concept of merging windows.</p>

<p>One shortcoming, however, is that your grouping operation must fit within a relatively restricted structure. This is all well and good for sums, means, and so on, but there are plenty of real-world use cases in which a more general approach, one which allows precise control over trade-offs of complexity and efficiency, is needed. We’ll look next at what such a general approach entails.<a contenteditable="false" data-primary="implicit state" data-type="indexterm" id="idm140176512738128"></a><a contenteditable="false" data-primary="incremental combination" data-startref="ix_incr" data-type="indexterm" id="idm140176512737024"></a><a contenteditable="false" data-primary="persistent state" data-secondary="implicit state" data-startref="ix_persimpl" data-type="indexterm" id="idm140176512735648"></a></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Generalized State"><div class="sect1" id="idm140176512896112">
<h1>Generalized State</h1>

<p>Though both of the implicit approaches we’ve looked at so <a contenteditable="false" data-primary="persistent state" data-secondary="generalized state" data-type="indexterm" id="ix_perstgen"></a>far have their merits, they each fall short in one <a contenteditable="false" data-primary="flexibility" data-secondary="shortcomings of implicit approaches" data-type="indexterm" id="idm140176512730608"></a>dimension: flexibility.<a contenteditable="false" data-primary="generalized state" data-type="indexterm" id="ix_genst"></a> The raw grouping method requires you to always buffer up the raw inputs to the grouping operation before processing the group in whole, so there’s no way to partially process some of the data along the way; it’s all or nothing. The incremental combining approach specifically allows for partial processing but with the restriction that the processing in question be commutative and associative and happen as records arrive one-by-one.</p>

<p>If we want to support a more generalized approach to streaming persistent state, we need something more flexible.<a contenteditable="false" data-primary="flexibility" data-secondary="needs in streaming persistent state" data-type="indexterm" id="idm140176512726608"></a> Specifically, we need flexibility in three dimensions:</p>

<ul>
	<li>
	<p>Flexibility in data structures; that is, an ability to structure the data we write and read in ways that are most appropriate and efficient for the task at hand. Raw grouping essentially provides an appendable list, and incremental combination essentially provides a single value that is always written and read in its entirety. But there are myriad other ways in which we might want to structure our persistent data, each with different types of access patterns and associated costs: maps, trees, graphs, sets, and so on. Supporting a variety of persistent data types is critical for efficiency.</p>

	<p>Beam supports flexibility in <a contenteditable="false" data-primary="data types, flexibility in" data-type="indexterm" id="idm140176512723056"></a>data types by allowing a single <code>DoFn</code> to declare multiple state fields, each of a specific type. In this way, logically independent pieces of state (e.g., visits and impressions) can be stored separately, and semantically different types of state (e.g., maps and lists) can be accessed in ways that are natural given their types of access patterns.</p>
	</li>
	<li>
	<p>Flexibility in write and read granularity; that is, an ability to tailor the amount and type of data written or read at any given time for optimal efficiency.<a contenteditable="false" data-primary="write and read granularity, flexibility in" data-type="indexterm" id="idm140176512719984"></a> What this boils down to is the ability to write and read precisely the necessary amount of data at any given point of time: no more, and no less (and in parallel as much as possible).</p>

	<p>This goes hand in hand with the previous point, given that dedicated data types allow for focused types of access patterns (e.g., a set-membership operation that can use something like a Bloom filter under the covers to greatly minimize the amount of data read in certain circumstances). But it goes beyond it, as well; for example, allowing multiple large reads to be dispatched in parallel (e.g., via futures).</p>

	<p>In Beam, flexibly granular writes and reads are enabled via datatype-specific APIs that provide fine-grained access capabilities, combined with an asynchronous I/O mechanism that allows for writes and reads to be batched together for efficiency.</p>
	</li>
	<li>
	<p>Flexibility in scheduling of processing; that is, an ability<a contenteditable="false" data-primary="scheduling of processing, flexibility in" data-type="indexterm" id="idm140176512716064"></a> to bind the time at which specific types of processing occur to the progress of time in either of the two time domains we care about: event-time completeness and processing time. Triggers provide a restricted set of flexibility here, with completeness triggers providing a way to bind processing to the watermark passing the end of the window, and repeated update triggers providing a way to bind processing to periodic progress in the processing-time domain. But for certain use cases (e.g., certain types of joins, for which you don’t necessarily care about input completeness of the entire window, just input completeness up to the event-time of a specific record in the join), triggers are insufficiently flexible. Hence, our need for a more general solution.</p>

	<p>In Beam, flexible scheduling of processing <a contenteditable="false" data-primary="timers" data-type="indexterm" id="idm140176512713520"></a>is provided via <em>timers</em>.<sup><a data-type="noteref" id="idm140176512711840-marker" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512711840" class="totri-footnote">4</a></sup> A timer is a special type of state that binds a specific point in time in either supported time domain (event time or processing time) with a method to be called when that point in time is reached. In this way, specific bits of processing can be delayed until a more appropriate time in the future.</p>
	</li>
</ul>

<p>The common thread among these three characteristics is <em>flexibility</em>. A specific subset of use cases are served very well by the relatively inflexible approaches of raw grouping or incremental combination. But when tackling anything outside their relatively narrow domain of expertise, those options often fall short. When that happens, you need the power and flexibility of a fully general-state API to let you tailor your utilization of persistent state optimally.</p>

<p>To think of it another way, raw grouping and incremental combination are relatively high-level abstractions that enable the pithy expression of pipelines with (in the case of combiners, at least) some good properties for automatic optimizations. But sometimes you need to go low level to get the behavior or performance you need. That’s what generalized state lets you do.</p>

<section data-type="sect2" data-pdf-bookmark="Case Study: Conversion Attribution"><div class="sect2" id="idm140176512707120">
<h2>Case Study: Conversion Attribution</h2>

<p>To see this in<a contenteditable="false" data-primary="persistent state" data-secondary="generalized state" data-tertiary="in conversion attribution" data-type="indexterm" id="ix_perstgenca"></a> action, let’s now look at a use case that is poorly served by both raw grouping and <a contenteditable="false" data-primary="generalized state" data-secondary="case study, conversion attribution" data-type="indexterm" id="ix_genstcsca"></a>incremental <a contenteditable="false" data-primary="conversion attribution" data-type="indexterm" id="ix_cnvattr"></a>combination: <em>conversion attribution</em>. <a contenteditable="false" data-primary="generalized state" data-secondary="in conversion attribution" data-type="indexterm" id="ix_genstcnvatt"></a>This is a technique that sees widespread use across the advertising world to provide concrete feedback on the effectiveness of advertisements. Though relatively easy to understand, its somewhat diverse set of requirements doesn’t fit nicely into either of the two types of implicit state we’ve considered so far.</p>

<p>Imagine that you have an analytics pipeline that monitors traffic to a website in conjunction with advertisement impressions that directed traffic to that site. The goal is to provide attribution of specific advertisements shown to a user toward the achievement of some goal on the site itself (which often might lie many steps beyond the initial advertisement landing page), such as signing up for a mailing list or purchasing an item.</p>

<p><a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#example_conversion_attribution_in_this_diagram_a_users_traversal">Figure&nbsp;7-3</a> shows an example set of website visits, goals, and ad impressions, with one attributed conversion highlighted in red. <a contenteditable="false" data-primary="out-of-order data" data-secondary="handling in conversion attribution pipeline" data-type="indexterm" id="chap_seven_handling_in_conversion"></a>Building up conversion attributions over an unbounded, out-of-order stream of data requires keeping track of impressions, visits, and goals seen so far. That’s where persistent state comes in.</p>

<figure><div id="example_conversion_attribution_in_this_diagram_a_users_traversal" class="figure"><img src="https://www.safaribooksonline.com/library/view/streaming-systems/9781491983867/assets/stsy_0703.png" width="600" height="503" data-mfp-src="/library/view/streaming-systems/9781491983867/assets/stsy_0703.png">
<h6><span class="label">Figure 7-3. </span>Example conversion attribution</h6>
</div></figure>

<p>In this diagram, a user’s traversal of various pages on a website is represented as a graph. Impressions are advertisements that were shown to the user and clicked, resulting in the user visiting a page on the site. Visits represent a single page viewed on the site. Goals are specific visited pages that have been identified as a desired destination for users (e.g., completing a purchase, or signing up for a mailing list). The goal of conversion attribution is to identify ad impressions that resulted in the user achieving some goal on the site. In this figure, there is one such conversion highlighted in red. Note that events might arrive out of order, hence the event-time axis in the diagram and the watermark reference point indicating the time up to which input is believed to be correct.</p>

<p>A lot goes into building a robust, large-scale attribution pipeline, but there are a few aspects worth calling out explicitly. Any such pipeline we attempt to build must do the following:</p>

<dl>
	<dt>Handle out-of-order data</dt>
	<dd>
	<p>Because the website traffic and ad <a contenteditable="false" data-primary="out-of-order data" data-secondary="handling in conversion attribution pipeline" data-startref="chap_seven_handling_in_conversion" data-type="indexterm" id="idm140176512663056"></a>impression data come from separate systems, both of which are implemented as distributed collection services themselves, the data might arrive wildly out of order. Thus, our pipeline must be resilient to such disorder.</p>
	</dd>
	<dt>Handle high volumes of data</dt>
	<dd>
	<p>Not only <a contenteditable="false" data-primary="high volumes of data, handling in conversion attribution pipeline" data-type="indexterm" id="idm140176512659664"></a>must we assume that this pipeline will be processing data for a large number of independent users, but depending upon the volume of a given ad campaign and the popularity of a given website, we might need to store a large amount of impression and/or traffic data as we attempt to build evidence of attribution. For example, it would not be unheard of to store 90 days worth of visit, impression, and goal tree<sup><a data-type="noteref" id="idm140176512657920-marker" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512657920" class="totri-footnote">5</a></sup> data per user to allow us to build up attributions that span multiple months’ worth of activity.</p>
	</dd>
	<dt>Protect against spam</dt>
	<dd>
	<p>Given that money is involved, correctness is paramount. <a contenteditable="false" data-primary="exactly-once processing" data-secondary="in conversion attribution pipeline" data-type="indexterm" id="idm140176512655328"></a>Not only must we ensure that visits and impressions are accounted for exactly once (something we’ll get more or less for free by simply using an execution engine that supports effectively-once processing), but we must also guard our advertisers against spam attacks<a contenteditable="false" data-primary="spam attacks, protecting against in conversion attribution pipeline" data-type="indexterm" id="idm140176512653392"></a> that attempt to charge advertisers unfairly. For example, a single ad that is clicked multiple times in a row by the same user will arrive as multiple impressions, but as long as those clicks occur within a certain amount of time of one another (e.g., within the same day), they must be attributed only once. In other words, even if the system guarantees we’ll see every individual <em>impression</em> once, we must also perform some manual deduplication across impressions that are technically different events but which our business logic dictates we interpret as duplicates.</p>
	</dd>
	<dt>Optimize for performance</dt>
	<dd>
	<p>Above all, because of the potential scale of this pipeline, we must always keep an eye toward optimizing the performance of our pipeline.<a contenteditable="false" data-primary="performance" data-secondary="optimizing in conversion attribution pipeline" data-type="indexterm" id="idm140176512649664"></a> Persistent state, because of the inherent costs of writing to persistent storage, can often be the performance bottleneck in such a pipeline. As such, the flexibility characteristics we discussed earlier will be critical in ensuring our design is as performant as <span class="keep-together">possible</span>.<a contenteditable="false" data-primary="persistent state" data-secondary="generalized state" data-startref="ix_perstgenca" data-tertiary="in conversion attribution" data-type="indexterm" id="idm140176512647152"></a><a contenteditable="false" data-primary="generalized state" data-secondary="in conversion attribution" data-startref="ix_genstcnvatt" data-type="indexterm" id="idm140176512645136"></a><a contenteditable="false" data-primary="conversion attribution" data-startref="ix_cnvattr" data-type="indexterm" id="idm140176512643472"></a><a contenteditable="false" data-primary="generalized state" data-secondary="case study, conversion attribution" data-startref="ix_genstcsca" data-type="indexterm" id="idm140176512642096"></a></p>
	</dd>
</dl>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Conversion Attribution with Apache Beam"><div class="sect2" id="idm140176512640176">
<h2>Conversion Attribution with Apache Beam</h2>

<p>Now that we understand <a contenteditable="false" data-primary="conversion attribution" data-secondary="with Apache Beam" data-type="indexterm" id="ix_cnvattrAB"></a>the basic problem<a contenteditable="false" data-primary="Apache Beam" data-secondary="conversion attribution with" data-type="indexterm" id="ix_ApBmcnvattr"></a> that we’re trying to solve and have some <a contenteditable="false" data-primary="persistent state" data-secondary="generalized state" data-tertiary="in conversion attribution using Apache Beam" data-type="indexterm" id="ix_perstgencaAB"></a>of the important requirements squarely in mind,<a contenteditable="false" data-primary="generalized state" data-secondary="in conversion attribution using Apache Beam" data-type="indexterm" id="ix_genstcnvattAB"></a> let’s use Beam’s State and Timers API to build a basic conversion attribution transformation. We’ll write this just like we would any other <code>DoFn</code> in Beam, but we’ll make use of state and timer extensions that allow us to write and read persistent state and timer fields. Those of you that want to follow along in real code can find the full implementation on <a href="http://bit.ly/2yeAGAQ">GitHub</a>.</p>

<p>Note that, as with all grouping operations in Beam, usage of the State API is scoped to the current key and window, with window lifetimes dictated by the specified allowed lateness parameter; in this example, we’ll be operating within a single global window. Parallelism is linearized per key, as with most <code>DoFns</code>. Also note that, for simplicity, we’ll be eliding the manual garbage collection of visits and impressions falling outside of our 90-day horizon that would be necessary to keep the persisted state from growing forever.</p>

<p>To begin, let’s define a few POJO classes for visits, impressions, a visit/impression union (used for joining), and completed attributions, as shown in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#pojo_definitions_of_visit_impression_and_attribution_objects">Example&nbsp;7-4</a>.</p>

<div data-type="example" id="pojo_definitions_of_visit_impression_and_attribution_objects">
<h5><span class="label">Example 7-4. </span>POJO definitions of Visit, Impression, VisitOrImpression, and Attribution objects</h5>

<pre data-code-language="java" data-type="programlisting"><code class="nd">@DefaultCoder</code><code class="o">(</code><code class="n">AvroCoder</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
<code class="kd">class</code> <code class="nc">Visit</code> <code class="o">{</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">url</code><code class="o">;</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">Instant</code> <code class="n">timestamp</code><code class="o">;</code>
    <code class="c1">// The referring URL. Recall that we’ve constrained the problem in this</code>
    <code class="c1">// example to assume every page on our website has exactly one possible</code>
    <code class="c1">// referring URL, to allow us to solve the problem for simple trees</code>
    <code class="c1">// rather than more general DAGs.</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">referer</code><code class="o">;</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="kt">boolean</code> <code class="n">isGoal</code><code class="o">;</code>

    <code class="nd">@SuppressWarnings</code><code class="o">(</code><code class="s">"unused"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="nf">Visit</code><code class="o">()</code> <code class="o">{</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="nf">Visit</code><code class="o">(</code><code class="n">String</code> <code class="n">url</code><code class="o">,</code> <code class="n">Instant</code> <code class="n">timestamp</code><code class="o">,</code> <code class="n">String</code> <code class="n">referer</code><code class="o">,</code>
                 <code class="kt">boolean</code> <code class="n">isGoal</code><code class="o">)</code> <code class="o">{</code>
	<code class="k">this</code><code class="o">.</code><code class="na">url</code> <code class="o">=</code> <code class="n">url</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">timestamp</code> <code class="o">=</code> <code class="n">timestamp</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">referer</code> <code class="o">=</code> <code class="n">referer</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">isGoal</code> <code class="o">=</code> <code class="n">isGoal</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">String</code> <code class="nf">url</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">url</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="n">Instant</code> <code class="nf">timestamp</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">timestamp</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">referer</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">referer</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">isGoal</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">isGoal</code><code class="o">;</code> <code class="o">}</code>

    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code><code class="s">"{ %s %s from:%s%s }"</code><code class="o">,</code> <code class="n">url</code><code class="o">,</code> <code class="n">timestamp</code><code class="o">,</code> <code class="n">referer</code><code class="o">,</code>
                             <code class="n">isGoal</code> <code class="o">?</code> <code class="s">" isGoal"</code> <code class="o">:</code> <code class="s">""</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code>

<code class="nd">@DefaultCoder</code><code class="o">(</code><code class="n">AvroCoder</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
<code class="kd">class</code> <code class="nc">Impression</code> <code class="o">{</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">Long</code> <code class="n">id</code><code class="o">;</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">sourceUrl</code><code class="o">;</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">targetUrl</code><code class="o">;</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">Instant</code> <code class="n">timestamp</code><code class="o">;</code>

    <code class="kd">public</code> <code class="kd">static</code> <code class="n">String</code> <code class="nf">sourceAndTarget</code><code class="o">(</code><code class="n">String</code> <code class="n">source</code><code class="o">,</code> <code class="n">String</code> <code class="n">target</code><code class="o">)</code> <code class="o">{</code> 
        <code class="k">return</code> <code class="n">source</code> <code class="o">+</code> <code class="s">":"</code> <code class="o">+</code> <code class="n">target</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="nd">@SuppressWarnings</code><code class="o">(</code><code class="s">"unused"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="nf">Impression</code><code class="o">()</code> <code class="o">{</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="nf">Impression</code><code class="o">(</code><code class="n">Long</code> <code class="n">id</code><code class="o">,</code> <code class="n">String</code> <code class="n">sourceUrl</code><code class="o">,</code> <code class="n">String</code> <code class="n">targetUrl</code><code class="o">,</code>
                      <code class="n">Instant</code> <code class="n">timestamp</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">id</code> <code class="o">=</code> <code class="n">id</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">sourceUrl</code> <code class="o">=</code> <code class="n">sourceUrl</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">targetUrl</code> <code class="o">=</code> <code class="n">targetUrl</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">timestamp</code> <code class="o">=</code> <code class="n">timestamp</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">Long</code> <code class="nf">id</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">id</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">sourceUrl</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">sourceUrl</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">targetUrl</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">targetUrl</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">sourceAndTarget</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="nf">sourceAndTarget</code><code class="o">(</code><code class="n">sourceUrl</code><code class="o">,</code> <code class="n">targetUrl</code><code class="o">);</code>
    <code class="o">}</code>
    <code class="kd">public</code> <code class="n">Instant</code> <code class="nf">timestamp</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">timestamp</code><code class="o">;</code> <code class="o">}</code>

    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="o">()</code> <code class="o">{</code>
	<code class="k">return</code> <code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code><code class="s">"{ %s source:%s target:%s %s }"</code><code class="o">,</code>
                             <code class="n">id</code><code class="o">,</code> <code class="n">sourceUrl</code><code class="o">,</code> <code class="n">targetUrl</code><code class="o">,</code> <code class="n">timestamp</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code>

<code class="nd">@DefaultCoder</code><code class="o">(</code><code class="n">AvroCoder</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
<code class="kd">class</code> <code class="nc">VisitOrImpression</code> <code class="o">{</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">Visit</code> <code class="n">visit</code><code class="o">;</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">Impression</code> <code class="n">impression</code><code class="o">;</code>

    <code class="nd">@SuppressWarnings</code><code class="o">(</code><code class="s">"unused"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="nf">VisitOrImpression</code><code class="o">()</code> <code class="o">{</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="nf">VisitOrImpression</code><code class="o">(</code><code class="n">Visit</code> <code class="n">visit</code><code class="o">,</code> <code class="n">Impression</code> <code class="n">impression</code><code class="o">)</code> <code class="o">{</code>
	<code class="k">this</code><code class="o">.</code><code class="na">visit</code> <code class="o">=</code> <code class="n">visit</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">impression</code> <code class="o">=</code> <code class="n">impression</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">Visit</code> <code class="nf">visit</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">visit</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="n">Impression</code> <code class="nf">impression</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">impression</code><code class="o">;</code> <code class="o">}</code>
<code class="o">}</code>

<code class="nd">@DefaultCoder</code><code class="o">(</code><code class="n">AvroCoder</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
<code class="kd">class</code> <code class="nc">Attribution</code> <code class="o">{</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">Impression</code> <code class="n">impression</code><code class="o">;</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;</code> <code class="n">trail</code><code class="o">;</code>
    <code class="nd">@Nullable</code> <code class="kd">private</code> <code class="n">Visit</code> <code class="n">goal</code><code class="o">;</code>

    <code class="nd">@SuppressWarnings</code><code class="o">(</code><code class="s">"unused"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="nf">Attribution</code><code class="o">()</code> <code class="o">{</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="nf">Attribution</code><code class="o">(</code><code class="n">Impression</code> <code class="n">impression</code><code class="o">,</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;</code> <code class="n">trail</code><code class="o">,</code> <code class="n">Visit</code> <code class="n">goal</code><code class="o">)</code> <code class="o">{</code>
	<code class="k">this</code><code class="o">.</code><code class="na">impression</code> <code class="o">=</code> <code class="n">impression</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">trail</code> <code class="o">=</code> <code class="n">trail</code><code class="o">;</code>
	<code class="k">this</code><code class="o">.</code><code class="na">goal</code> <code class="o">=</code> <code class="n">goal</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">Impression</code> <code class="nf">impression</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">impression</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;</code> <code class="nf">trail</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">trail</code><code class="o">;</code> <code class="o">}</code>
    <code class="kd">public</code> <code class="n">Visit</code> <code class="nf">goal</code><code class="o">()</code> <code class="o">{</code> <code class="k">return</code> <code class="n">goal</code><code class="o">;</code> <code class="o">}</code>

    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="o">()</code> <code class="o">{</code>
	<code class="n">StringBuilder</code> <code class="n">builder</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="o">();</code>
	<code class="n">builder</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"imp="</code> <code class="o">+</code> <code class="n">impression</code><code class="o">.</code><code class="na">id</code><code class="o">()</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">impression</code><code class="o">.</code><code class="na">sourceUrl</code><code class="o">());</code>
	<code class="k">for</code> <code class="o">(</code><code class="n">Visit</code> <code class="n">visit</code> <code class="o">:</code> <code class="n">trail</code><code class="o">)</code> <code class="o">{</code>
	    <code class="n">builder</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">" → "</code> <code class="o">+</code> <code class="n">visit</code><code class="o">.</code><code class="na">url</code><code class="o">());</code>
	<code class="o">}</code>
	<code class="n">builder</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">" → "</code> <code class="o">+</code> <code class="n">goal</code><code class="o">.</code><code class="na">url</code><code class="o">());</code>
	<code class="k">return</code> <code class="n">builder</code><code class="o">.</code><code class="na">toString</code><code class="o">();</code>
    <code class="o">}</code>
<code class="o">}</code>
</pre>
</div>

<p>We next define a Beam <code>DoFn</code> to consume a flattened collection of <code>Visit</code>s and <code><span class="keep-together">Impression</span></code>s, keyed by the user. In turn, it will yield a collection of <code>Attribution</code>s. Its signature looks like <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#dofn_signature_for_our_conversation_attribution_transformation">Example&nbsp;7-5</a>.</p>

<div data-type="example" id="dofn_signature_for_our_conversation_attribution_transformation">
<h5><span class="label">Example 7-5. </span>DoFn signature for our conversion attribution transformation​</h5>

<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">AttributionFn</code> <code class="kd">extends</code> <code class="n">DoFn</code><code class="o">&lt;</code><code class="n">KV</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">VisitOrImpression</code><code class="o">&gt;,</code> <code class="n">Attribution</code><code class="o">&gt;</code>
</pre>
</div>

<p>Within that <code>DoFn</code>, we need to implement the following logic:</p>

<ol>
	<li>
	<p>Store all visits in a map keyed by their URL so that we can easily look them up when tracing visit trails backward from a goal.</p>
	</li>
	<li>
	<p>Store all impressions in a map keyed by the URL they referred to, so we can identify impressions that initiated a trail to a goal.</p>
	</li>
	<li>
	<p>Any time we see a visit that happens to be a goal, set an event-time timer for the timestamp of the goal. Associated with this timer will be a method that performs goal attribution for the pending goal. This will ensure that attribution only happens once the input leading up to the goal is complete.</p>
	</li>
	<li>
	<p>Because Beam lacks support for a dynamic set of timers (currently all timers must be declared at pipeline definition time, though each individual timer can be set and reset for different points in time at runtime), we also need to keep track of the timestamps for all of the goals we still need to attribute. This will allow us to have a single attribution timer set for the minimum timestamp of all pending goals. After we attribute the goal with the earliest timestamp, we set the timer again with the timestamp of the next earliest goal.</p>
	</li>
</ol>

<p>Let’s now walk through the implementation in pieces. First up, we need to declare specifications for all of our state and timer fields within the <code>DoFn</code>. For state, the specification dictates the type of data structure for the field itself (e.g., map or list) as well as the type(s) of data contained therein, and their associated coder(s); for timers, it dictates the associated time domain. Each specification is then assigned a unique ID string (via the <code>@StateID</code>/<code>@TimerId</code> annotations), which will allow us to dynamically associate these specifications with parameters and methods later on. For our use case, we’ll define (in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#state_field_specifications">Example&nbsp;7-6</a>) the following:</p>

<ul>
	<li>
	<p>Two <code>MapState</code> specifications for visits and impressions</p>
	</li>
	<li>
	<p>A single <code>SetState</code> specification for goals</p>
	</li>
	<li>
	<p>A <code>ValueState</code> specification for keeping track of the minimum pending goal timestamp</p>
	</li>
	<li>
	<p>A <code>Timer</code> specification for our delayed attribution logic</p>
	</li>
</ul>

<div data-type="example" id="state_field_specifications" class="pagebreak-before">
<h5><span class="label">Example 7-6. </span>State field specifications</h5>

<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">AttributionFn</code> <code class="kd">extends</code> <code class="n">DoFn</code><code class="o">&lt;</code><code class="n">KV</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">VisitOrImpression</code><code class="o">&gt;,</code> <code class="n">Attribution</code><code class="o">&gt;</code> <code class="o">{</code>
    <code class="nd">@StateId</code><code class="o">(</code><code class="s">"visits"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">StateSpec</code><code class="o">&lt;</code><code class="n">MapState</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Visit</code><code class="o">&gt;&gt;</code> <code class="n">visitsSpec</code> <code class="o">=</code>
	<code class="n">StateSpecs</code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">StringUtf8Coder</code><code class="o">.</code><code class="na">of</code><code class="o">(),</code> <code class="n">AvroCoder</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">Visit</code><code class="o">.</code><code class="na">class</code><code class="o">));</code>

    <code class="c1">// Impressions are keyed by both sourceUrl (i.e., the query) and targetUrl</code>
    <code class="c1">// (i.e., the click), since a single query can result in multiple impressions.</code>
    <code class="c1">// The source and target are encoded together into a single string by the</code>
    <code class="c1">// Impression.sourceAndTarget method.</code>
    <code class="nd">@StateId</code><code class="o">(</code><code class="s">"impressions"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">StateSpec</code><code class="o">&lt;</code><code class="n">MapState</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Impression</code><code class="o">&gt;&gt;</code> <code class="n">impSpec</code> <code class="o">=</code>
	<code class="n">StateSpecs</code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">StringUtf8Coder</code><code class="o">.</code><code class="na">of</code><code class="o">(),</code> <code class="n">AvroCoder</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">Impression</code><code class="o">.</code><code class="na">class</code><code class="o">));</code>

    <code class="nd">@StateId</code><code class="o">(</code><code class="s">"goals"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">StateSpec</code><code class="o">&lt;</code><code class="n">SetState</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;&gt;</code> <code class="n">goalsSpec</code> <code class="o">=</code>
	<code class="n">StateSpecs</code><code class="o">.</code><code class="na">set</code><code class="o">(</code><code class="n">AvroCoder</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">Visit</code><code class="o">.</code><code class="na">class</code><code class="o">));</code>

    <code class="nd">@StateId</code><code class="o">(</code><code class="s">"minGoal"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">StateSpec</code><code class="o">&lt;</code><code class="n">ValueState</code><code class="o">&lt;</code><code class="n">Instant</code><code class="o">&gt;&gt;</code> <code class="n">minGoalSpec</code> <code class="o">=</code>
	<code class="n">StateSpecs</code><code class="o">.</code><code class="na">value</code><code class="o">(</code><code class="n">InstantCoder</code><code class="o">.</code><code class="na">of</code><code class="o">());</code>

    <code class="nd">@TimerId</code><code class="o">(</code><code class="s">"attribution"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">TimerSpec</code> <code class="n">timerSpec</code> <code class="o">=</code>
	<code class="n">TimerSpecs</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="n">TimeDomain</code><code class="o">.</code><code class="na">EVENT_TIME</code><code class="o">);</code>

<code class="o">...</code> <code class="n">continued</code> <code class="n">in</code> <code class="n">Example</code> <code class="mi">7</code><code class="o">-</code><code class="mi">7</code> <code class="n">below</code> <code class="o">...</code>
</pre>
</div>

<p>Next up, we implement our core <code>@ProcessElement</code> method. This is the processing logic that will run every time a new record arrives. As noted earlier, we need to record visits and impressions to persistent state as well as keep track of goals and manage the timer that will bind our attribution logic to the progress of event-time completeness as tracked by the watermark. Access to state and timers is provided via parameters passed to our <code>@ProcessElement</code> method, and the Beam runtime invokes our method with appropriate parameters indicated by <code>@StateId</code> and <code>@TimerId</code> annotations. The logic itself is then relatively straightforward, as demonstrated in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#process_element_implementation">Example&nbsp;7-7</a>.</p>

<div data-type="example" id="process_element_implementation">
<h5><span class="label">Example 7-7. </span>@ProcessElement implementation</h5>

<pre data-code-language="java" data-type="programlisting"><code class="o">...</code> <code class="n">continued</code> <code class="n">from</code> <code class="n">Example</code> <code class="mi">7</code><code class="o">-</code><code class="mi">6</code> <code class="n">above</code> <code class="o">...</code>

<code class="nd">@ProcessElement</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">processElement</code><code class="o">(</code>
        <code class="nd">@Element</code> <code class="n">KV</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">VisitOrImpression</code><code class="o">&gt;</code> <code class="n">kv</code><code class="o">,</code>
	<code class="nd">@StateId</code><code class="o">(</code><code class="s">"visits"</code><code class="o">)</code> <code class="n">MapState</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Visit</code><code class="o">&gt;</code> <code class="n">visitsState</code><code class="o">,</code>
	<code class="nd">@StateId</code><code class="o">(</code><code class="s">"impressions"</code><code class="o">)</code> <code class="n">MapState</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Impression</code><code class="o">&gt;</code> <code class="n">impressionsState</code><code class="o">,</code>
	<code class="nd">@StateId</code><code class="o">(</code><code class="s">"goals"</code><code class="o">)</code> <code class="n">SetState</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;</code> <code class="n">goalsState</code><code class="o">,</code>
	<code class="nd">@StateId</code><code class="o">(</code><code class="s">"minGoal"</code><code class="o">)</code> <code class="n">ValueState</code><code class="o">&lt;</code><code class="n">Instant</code><code class="o">&gt;</code> <code class="n">minGoalState</code><code class="o">,</code>
	<code class="nd">@TimerId</code><code class="o">(</code><code class="s">"attribution"</code><code class="o">)</code> <code class="n">Timer</code> <code class="n">attributionTimer</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">Visit</code> <code class="n">visit</code> <code class="o">=</code> <code class="n">kv</code><code class="o">.</code><code class="na">getValue</code><code class="o">().</code><code class="na">visit</code><code class="o">();</code>
    <code class="n">Impression</code> <code class="n">impression</code> <code class="o">=</code> <code class="n">kv</code><code class="o">.</code><code class="na">getValue</code><code class="o">().</code><code class="na">impression</code><code class="o">();</code>

    <code class="k">if</code> <code class="o">(</code><code class="n">visit</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>
	<code class="k">if</code> <code class="o">(!</code><code class="n">visit</code><code class="o">.</code><code class="na">isGoal</code><code class="o">())</code> <code class="o">{</code>
	    <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Adding visit: {}"</code><code class="o">,</code> <code class="n">visit</code><code class="o">);</code>
	    <code class="n">visitsState</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">visit</code><code class="o">.</code><code class="na">url</code><code class="o">(),</code> <code class="n">visit</code><code class="o">);</code>
	<code class="o">}</code> <code class="k">else</code> <code class="o">{</code>
	    <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Adding goal (if absent): {}"</code><code class="o">,</code> <code class="n">visit</code><code class="o">);</code>
	    <code class="n">goalsState</code><code class="o">.</code><code class="na">addIfAbsent</code><code class="o">(</code><code class="n">visit</code><code class="o">);</code>
	    <code class="n">Instant</code> <code class="n">minTimestamp</code> <code class="o">=</code> <code class="n">minGoalState</code><code class="o">.</code><code class="na">read</code><code class="o">();</code>
	    <code class="k">if</code> <code class="o">(</code><code class="n">minTimestamp</code> <code class="o">==</code> <code class="kc">null</code> <code class="o">||</code> <code class="n">visit</code><code class="o">.</code><code class="na">timestamp</code><code class="o">().</code><code class="na">isBefore</code><code class="o">(</code><code class="n">minTimestamp</code><code class="o">))</code> <code class="o">{</code>
                <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Setting timer from {} to {}"</code><code class="o">,</code>
                         <code class="n">Utils</code><code class="o">.</code><code class="na">formatTime</code><code class="o">(</code><code class="n">minTimestamp</code><code class="o">),</code>
                         <code class="n">Utils</code><code class="o">.</code><code class="na">formatTime</code><code class="o">(</code><code class="n">visit</code><code class="o">.</code><code class="na">timestamp</code><code class="o">()));</code>
                <code class="n">attributionTimer</code><code class="o">.</code><code class="na">set</code><code class="o">(</code><code class="n">visit</code><code class="o">.</code><code class="na">timestamp</code><code class="o">());</code>
		<code class="n">minGoalState</code><code class="o">.</code><code class="na">write</code><code class="o">(</code><code class="n">visit</code><code class="o">.</code><code class="na">timestamp</code><code class="o">());</code>
	    <code class="o">}</code>
	    <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Done with goal"</code><code class="o">);</code>
	<code class="o">}</code>
    <code class="o">}</code>
    <code class="k">if</code> <code class="o">(</code><code class="n">impression</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>
        <code class="c1">// Dedup logical impression duplicates with the same source and target URL.</code>
	<code class="c1">// In this case, first one to arrive (in processing time) wins. A more</code>
	<code class="c1">// robust approach might be to pick the first one in event time, but that</code>
        <code class="c1">// would require an extra read before commit, so the processing-time</code>
        <code class="c1">// approach may be slightly more performant.</code>
        <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Adding impression (if absent): {} → {}"</code><code class="o">,</code>
                 <code class="n">impression</code><code class="o">.</code><code class="na">sourceAndTarget</code><code class="o">(),</code> <code class="n">impression</code><code class="o">);</code>
	<code class="n">impressionsState</code><code class="o">.</code><code class="na">putIfAbsent</code><code class="o">(</code><code class="n">impression</code><code class="o">.</code><code class="na">sourceAndTarget</code><code class="o">(),</code> <code class="n">impression</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code>

<code class="o">...</code> <code class="n">continued</code> <code class="n">in</code> <code class="n">Example</code> <code class="mi">7</code><code class="o">-</code><code class="mi">8</code> <code class="n">below</code> <code class="o">...</code>
</pre>
</div>

<p>Note how this ties back to our three desired capabilities in a general state API:</p>

<dl>
	<dt>Flexibility in data structures</dt>
	<dd>
	<p>We have maps, a<a contenteditable="false" data-primary="data types, flexibility in" data-type="indexterm" id="idm140176511963440"></a> set, a value, and a timer. <a contenteditable="false" data-primary="flexibility" data-secondary="needs in streaming persistent state" data-tertiary="in conversion attribution using Apache Beam" data-type="indexterm" id="idm140176511962112"></a>They allow us to efficiently manipulate our state in ways that are effective for our algorithm.</p>
	</dd>
	<dt>Flexibility in write and read granularity</dt>
	<dd>
	<p>Our <code>@ProcessElement</code> method is called for <a contenteditable="false" data-primary="write and read granularity, flexibility in" data-type="indexterm" id="idm140176511391360"></a>every single visit and impression we process. As such, we need it to be as efficient as possible. We take advantage of the ability to make fine-grained, blind writes only to the specific fields we need. We also only ever read from state within our <code>@ProcessElement</code> method in the uncommon case of encountering a new goal. And when we do, we read only a single integer value, without touching the (potentially much larger) maps and list.</p>
	</dd>
	<dt>Flexibility in scheduling of processing</dt>
	<dd>
	<p>Thanks to timers, we’re able to delay our complex goal <a contenteditable="false" data-primary="scheduling of processing, flexibility in" data-type="indexterm" id="idm140176511387840"></a>attribution logic (defined next) until we’re confident we’ve received all the necessary input data, minimizing duplicated work and maximizing efficiency.</p>
	</dd>
</dl>

<p>Having defined the core processing logic, let’s now look at our final piece of code, the goal attribution method. This method is annotated with an <code>@TimerId</code> annotation to identify it as the code to execute when the corresponding attribution timer fires. The logic here is significantly more complicated than the <code>@ProcessElement</code> method:</p>

<ol>
	<li>
	<p>First, we need to load the entirety of our visit and impression maps, as well as our set of goals. We need the maps to piece our way backward through the attribution trail we’ll be building, and we need the goals to know which goals we’re attributing as a result of the current timer firing, as well as the next pending goal we want to schedule for attribution in the future (if any).</p>
	</li>
	<li>
	<p>After we’ve loaded our state, we process goals for this timer one at a time in a loop, repeatedly:</p>

	<ul>
		<li>
		<p>Checking to see if any impressions referred the user to the current visit in the trail (beginning with the goal). If so, we’ve completed attribution of this goal and can break out of the loop and emit the attribution trail.</p>
		</li>
		<li>
		<p>Checking next to see if any visits were the referrer for the current visit. If so, we’ve found a back pointer in our trail, so we traverse it and start the loop over.</p>
		</li>
		<li>
		<p>If no matching impressions or visits are found, we have a goal that was reached organically, with no associated impression. In this case, we simply break out of the loop and move on to the next goal, if any.</p>
		</li>
	</ul>
	</li>
	<li>
	<p>After we’ve exhausted our list of goals ready for attribution, we set a timer for the next pending goal in the list (if any) and reset the corresponding <code>ValueState</code> tracking the minimum pending goal timestamp.</p>
	</li>
</ol>

<p>To keep things concise, we first look at the core goal attribution logic, shown in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#goal_attribution_logic">Example&nbsp;7-8</a>, which roughly corresponds to point 2 in the preceding list.</p>

<div data-type="example" id="goal_attribution_logic">
<h5><span class="label">Example 7-8. </span>Goal attribution logic</h5>

<pre data-code-language="java" data-type="programlisting"><code class="o">...</code> <code class="n">continued</code> <code class="n">from</code> <code class="n">Example</code> <code class="mi">7</code><code class="o">-</code><code class="mi">7</code> <code class="n">above</code> <code class="o">...</code>

<code class="kd">private</code> <code class="n">Impression</code> <code class="nf">attributeGoal</code><code class="o">(</code><code class="n">Visit</code> <code class="n">goal</code><code class="o">,</code>
				 <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Visit</code><code class="o">&gt;</code> <code class="n">visits</code><code class="o">,</code>
				 <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Impression</code><code class="o">&gt;</code> <code class="n">impressions</code><code class="o">,</code>
				 <code class="n">List</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;</code> <code class="n">trail</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">Impression</code> <code class="n">impression</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>
    <code class="n">Visit</code> <code class="n">visit</code> <code class="o">=</code> <code class="n">goal</code><code class="o">;</code>
    <code class="k">while</code> <code class="o">(</code><code class="kc">true</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">String</code> <code class="n">sourceAndTarget</code> <code class="o">=</code> <code class="n">Impression</code><code class="o">.</code><code class="na">sourceAndTarget</code><code class="o">(</code>
            <code class="n">visit</code><code class="o">.</code><code class="na">referer</code><code class="o">(),</code> <code class="n">visit</code><code class="o">.</code><code class="na">url</code><code class="o">());</code>
        <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"attributeGoal: visit={} sourceAndTarget={}"</code><code class="o">,</code>
                 <code class="n">visit</code><code class="o">,</code> <code class="n">sourceAndTarget</code><code class="o">);</code>
	<code class="k">if</code> <code class="o">(</code><code class="n">impressions</code><code class="o">.</code><code class="na">containsKey</code><code class="o">(</code><code class="n">sourceAndTarget</code><code class="o">))</code> <code class="o">{</code>
	    <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"attributeGoal: impression={}"</code><code class="o">,</code> <code class="n">impression</code><code class="o">);</code>
	    <code class="c1">// Walked entire path back to impression. Return success.</code>
	    <code class="k">return</code> <code class="n">impressions</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">sourceAndTarget</code><code class="o">);</code>
	<code class="o">}</code> <code class="k">else</code> <code class="k">if</code> <code class="o">(</code><code class="n">visits</code><code class="o">.</code><code class="na">containsKey</code><code class="o">(</code><code class="n">visit</code><code class="o">.</code><code class="na">referer</code><code class="o">()))</code> <code class="o">{</code>
	    <code class="c1">// Found another visit in the path, continue searching.</code>
	    <code class="n">visit</code> <code class="o">=</code> <code class="n">visits</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">visit</code><code class="o">.</code><code class="na">referer</code><code class="o">());</code>
	    <code class="n">trail</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="mi">0</code><code class="o">,</code> <code class="n">visit</code><code class="o">);</code>
	<code class="o">}</code> <code class="k">else</code> <code class="o">{</code>
	    <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"attributeGoal: not found"</code><code class="o">);</code>
	    <code class="c1">// Referer not found, trail has gone cold. Return failure.</code>
	    <code class="k">return</code> <code class="kc">null</code><code class="o">;</code>
	<code class="o">}</code>
    <code class="o">}</code>
<code class="o">}</code>

<code class="o">...</code> <code class="n">continued</code> <code class="n">in</code> <code class="n">Example</code> <code class="mi">7</code><code class="o">-</code><code class="mi">9</code> <code class="n">below</code> <code class="o">...</code>
</pre>
</div>

<p>The rest of the code (eliding a few simple helper methods), which handles initializing and fetching state, invoking the attribution logic, and handling cleanup to schedule any remaining pending goal attribution attempts, looks like <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#overall_timerid_handling_logic_for_goal_attribution">Example&nbsp;7-9</a>.</p>

<div data-type="example" id="overall_timerid_handling_logic_for_goal_attribution">
<h5><span class="label">Example 7-9. </span>Overall @TimerId handling logic for goal attribution</h5>

<pre data-code-language="java" data-type="programlisting"><code class="o">...</code> <code class="n">continued</code> <code class="n">from</code> <code class="n">Example</code> <code class="mi">7</code><code class="o">-</code><code class="mi">8</code> <code class="n">above</code> <code class="o">...</code>

<code class="nd">@OnTimer</code><code class="o">(</code><code class="s">"attribution"</code><code class="o">)</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">attributeGoal</code><code class="o">(</code>
        <code class="nd">@Timestamp</code> <code class="n">Instant</code> <code class="n">timestamp</code><code class="o">,</code>
	<code class="nd">@StateId</code><code class="o">(</code><code class="s">"visits"</code><code class="o">)</code> <code class="n">MapState</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Visit</code><code class="o">&gt;</code> <code class="n">visitsState</code><code class="o">,</code>
	<code class="nd">@StateId</code><code class="o">(</code><code class="s">"impressions"</code><code class="o">)</code> <code class="n">MapState</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Impression</code><code class="o">&gt;</code> <code class="n">impressionsState</code><code class="o">,</code>
	<code class="nd">@StateId</code><code class="o">(</code><code class="s">"goals"</code><code class="o">)</code> <code class="n">SetState</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;</code> <code class="n">goalsState</code><code class="o">,</code>
	<code class="nd">@StateId</code><code class="o">(</code><code class="s">"minGoal"</code><code class="o">)</code> <code class="n">ValueState</code><code class="o">&lt;</code><code class="n">Instant</code><code class="o">&gt;</code> <code class="n">minGoalState</code><code class="o">,</code>
	<code class="nd">@TimerId</code><code class="o">(</code><code class="s">"attribution"</code><code class="o">)</code> <code class="n">Timer</code> <code class="n">attributionTimer</code><code class="o">,</code>
	<code class="n">OutputReceiver</code><code class="o">&lt;</code><code class="n">Attribution</code><code class="o">&gt;</code> <code class="n">output</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Processing timer: {}"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">formatTime</code><code class="o">(</code><code class="n">timestamp</code><code class="o">));</code>

    <code class="c1">// Batch state reads together via futures.</code>
    <code class="n">ReadableState</code><code class="o">&lt;</code><code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Map</code><code class="o">.</code><code class="na">Entry</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Visit</code><code class="o">&gt;</code> <code class="o">&gt;</code> <code class="o">&gt;</code> <code class="n">visitsFuture</code>
        <code class="o">=</code> <code class="n">visitsState</code><code class="o">.</code><code class="na">entries</code><code class="o">().</code><code class="na">readLater</code><code class="o">();</code>
    <code class="n">ReadableState</code><code class="o">&lt;</code><code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Map</code><code class="o">.</code><code class="na">Entry</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Impression</code><code class="o">&gt;</code> <code class="o">&gt;</code> <code class="o">&gt;</code> <code class="n">impressionsFuture</code>
        <code class="o">=</code> <code class="n">impressionsState</code><code class="o">.</code><code class="na">entries</code><code class="o">().</code><code class="na">readLater</code><code class="o">();</code>
    <code class="n">ReadableState</code><code class="o">&lt;</code><code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;&gt;</code> <code class="n">goalsFuture</code> <code class="o">=</code> <code class="n">goalsState</code><code class="o">.</code><code class="na">readLater</code><code class="o">();</code>

    <code class="c1">// Accessed the fetched state.</code>
    <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Visit</code><code class="o">&gt;</code> <code class="n">visits</code> <code class="o">=</code> <code class="n">buildMap</code><code class="o">(</code><code class="n">visitsFuture</code><code class="o">.</code><code class="na">read</code><code class="o">());</code>
    <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Impression</code><code class="o">&gt;</code> <code class="n">impressions</code> <code class="o">=</code> <code class="n">buildMap</code><code class="o">(</code><code class="n">impressionsFuture</code><code class="o">.</code><code class="na">read</code><code class="o">());</code>
    <code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;</code> <code class="n">goals</code> <code class="o">=</code> <code class="n">goalsFuture</code><code class="o">.</code><code class="na">read</code><code class="o">();</code>

    <code class="c1">// Find the matching goal</code>
    <code class="n">Visit</code> <code class="n">goal</code> <code class="o">=</code> <code class="n">findGoal</code><code class="o">(</code><code class="n">timestamp</code><code class="o">,</code> <code class="n">goals</code><code class="o">);</code>

    <code class="c1">// Attribute the goal</code>
    <code class="n">List</code><code class="o">&lt;</code><code class="n">Visit</code><code class="o">&gt;</code> <code class="n">trail</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;();</code>
    <code class="n">Impression</code> <code class="n">impression</code> <code class="o">=</code> <code class="n">attributeGoal</code><code class="o">(</code><code class="n">goal</code><code class="o">,</code> <code class="n">visits</code><code class="o">,</code> <code class="n">impressions</code><code class="o">,</code> <code class="n">trail</code><code class="o">);</code>
    <code class="k">if</code> <code class="o">(</code><code class="n">impression</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>
	<code class="n">output</code><code class="o">.</code><code class="na">output</code><code class="o">(</code><code class="k">new</code> <code class="n">Attribution</code><code class="o">(</code><code class="n">impression</code><code class="o">,</code> <code class="n">trail</code><code class="o">,</code> <code class="n">goal</code><code class="o">));</code>
	<code class="n">impressions</code><code class="o">.</code><code class="na">remove</code><code class="o">(</code><code class="n">impression</code><code class="o">.</code><code class="na">sourceAndTarget</code><code class="o">());</code>
    <code class="o">}</code>
    <code class="n">goalsState</code><code class="o">.</code><code class="na">remove</code><code class="o">(</code><code class="n">goal</code><code class="o">);</code>

    <code class="c1">// Set the next timer, if any.</code>
    <code class="n">Instant</code> <code class="n">minGoal</code> <code class="o">=</code> <code class="n">minTimestamp</code><code class="o">(</code><code class="n">goals</code><code class="o">,</code> <code class="n">goal</code><code class="o">);</code>
    <code class="k">if</code> <code class="o">(</code><code class="n">minGoal</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>
	<code class="n">LOG</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Setting new timer at {}"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">formatTime</code><code class="o">(</code><code class="n">minGoal</code><code class="o">));</code>
	<code class="n">minGoalState</code><code class="o">.</code><code class="na">write</code><code class="o">(</code><code class="n">minGoal</code><code class="o">);</code>
	<code class="n">attributionTimer</code><code class="o">.</code><code class="na">set</code><code class="o">(</code><code class="n">minGoal</code><code class="o">);</code>
    <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>
	<code class="n">minGoalState</code><code class="o">.</code><code class="na">clear</code><code class="o">();</code>
    <code class="o">}</code>
<code class="o">}</code>
</pre>
</div>

<p>This code block ties back to the three desired capabilities of a general state API in very similar ways as the <code>@ProcessElement</code> method, with one noteworthy difference:</p>

<dl>
	<dt>Flexibility in write and read granularity</dt>
	<dd>
	<p>We were able to make a single, coarse-grained read up front to load all of the data in the maps and set. This is typically much more efficient than loading each field separately, or even worse loading each field element by element. It also shows the importance of being able to traverse the spectrum of access granularities, from fine-grained to coarse-grained.</p>
	</dd>
</dl>

<p>And that’s it! We’ve implemented a basic conversion attribution pipeline, in a way that’s efficient enough to be operated at respectable scales using a reasonable amount of resources. And importantly, it functions properly in the face of out-of-order data. If you look at the dataset used for the <a href="http://bit.ly/2sY4goW">unit test</a> in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#example_dataset_for_validating_conversion_attribution_logic">Example&nbsp;7-10</a>, you can see it presents a number of challenges, even at this small scale:</p>

  <ul class="pagebreak-before">
    <li><p>Tracking and attributing multiple distinct conversions across a shared set of URLs.</p></li>
    <li><p>Data arriving out of order, and in particular, goals arriving (in processing time) before visits and impressions that lead to them, as well as other goals which occurred earlier.</p></li>
    <li><p>Source URLs that generate multiple distinct impressions to different target URLs.</p></li>
    <li><p>Physically distinct impressions (e.g., multiple clicks on the same advertisement) that must be deduplicated to a single logical impression.</p></li>
  </ul>

<div data-type="example" id="example_dataset_for_validating_conversion_attribution_logic">
<h5><span class="label">Example 7-10. </span>Example dataset for validating conversion attribution logic</h5>

<pre data-code-language="java" data-type="programlisting"><code class="kd">private</code> <code class="kd">static</code> <code class="n">TestStream</code><code class="o">&lt;</code><code class="n">KV</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">VisitOrImpression</code><code class="o">&gt;&gt;</code> <code class="n">createStream</code><code class="o">()</code> <code class="o">{</code>
    <code class="c1">// Impressions and visits, in event-time order, for two (logical) attributable</code>
    <code class="c1">// impressions and one unattributable impression.</code>
    <code class="n">Impression</code> <code class="n">signupImpression</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Impression</code><code class="o">(</code>
	<code class="mi">123L</code><code class="o">,</code> <code class="s">"http://search.com?q=xyz"</code><code class="o">,</code>
	<code class="s">"http://xyz.com/"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:01:00"</code><code class="o">));</code>
    <code class="n">Visit</code> <code class="n">signupVisit</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Visit</code><code class="o">(</code>
	<code class="s">"http://xyz.com/"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:01:10"</code><code class="o">),</code>
	<code class="s">"http://search.com?q=xyz"</code><code class="o">,</code> <code class="kc">false</code><code class="cm">/*isGoal*/</code><code class="o">);</code>
    <code class="n">Visit</code> <code class="n">signupGoal</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Visit</code><code class="o">(</code>
	<code class="s">"http://xyz.com/join-mailing-list"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:01:30"</code><code class="o">),</code>
	<code class="s">"http://xyz.com/"</code><code class="o">,</code> <code class="kc">true</code><code class="cm">/*isGoal*/</code><code class="o">);</code>

    <code class="n">Impression</code> <code class="n">shoppingImpression</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Impression</code><code class="o">(</code>
	<code class="mi">456L</code><code class="o">,</code> <code class="s">"http://search.com?q=thing"</code><code class="o">,</code>
	<code class="s">"http://xyz.com/thing"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:02:00"</code><code class="o">));</code>
    <code class="n">Impression</code> <code class="n">shoppingImpressionDup</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Impression</code><code class="o">(</code>
	<code class="mi">789L</code><code class="o">,</code> <code class="s">"http://search.com?q=thing"</code><code class="o">,</code>
	<code class="s">"http://xyz.com/thing"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:02:10"</code><code class="o">));</code>
    <code class="n">Visit</code> <code class="n">shoppingVisit1</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Visit</code><code class="o">(</code>
	<code class="s">"http://xyz.com/thing"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:02:30"</code><code class="o">),</code>
	<code class="s">"http://search.com?q=thing"</code><code class="o">,</code> <code class="kc">false</code><code class="cm">/*isGoal*/</code><code class="o">);</code>
    <code class="n">Visit</code> <code class="n">shoppingVisit2</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Visit</code><code class="o">(</code>
	<code class="s">"http://xyz.com/thing/add-to-cart"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:03:00"</code><code class="o">),</code>
	<code class="s">"http://xyz.com/thing"</code><code class="o">,</code> <code class="kc">false</code><code class="cm">/*isGoal*/</code><code class="o">);</code>
    <code class="n">Visit</code> <code class="n">shoppingVisit3</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Visit</code><code class="o">(</code>
	<code class="s">"http://xyz.com/thing/purchase"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:03:20"</code><code class="o">),</code>
	<code class="s">"http://xyz.com/thing/add-to-cart"</code><code class="o">,</code> <code class="kc">false</code><code class="cm">/*isGoal*/</code><code class="o">);</code>
    <code class="n">Visit</code> <code class="n">shoppingGoal</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Visit</code><code class="o">(</code>
	<code class="s">"http://xyz.com/thing/receipt"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:03:45"</code><code class="o">),</code>
	<code class="s">"http://xyz.com/thing/purchase"</code><code class="o">,</code> <code class="kc">true</code><code class="cm">/*isGoal*/</code><code class="o">);</code>

    <code class="n">Impression</code> <code class="n">unattributedImpression</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Impression</code><code class="o">(</code>
	<code class="mi">000L</code><code class="o">,</code> <code class="s">"http://search.com?q=thing"</code><code class="o">,</code>
	<code class="s">"http://xyz.com/other-thing"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:04:00"</code><code class="o">));</code>
    <code class="n">Visit</code> <code class="n">unattributedVisit</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Visit</code><code class="o">(</code>
	<code class="s">"http://xyz.com/other-thing"</code><code class="o">,</code> <code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:04:20"</code><code class="o">),</code>
	<code class="s">"http://search.com?q=other thing"</code><code class="o">,</code> <code class="kc">false</code><code class="cm">/*isGoal*/</code><code class="o">);</code>

    <code class="c1">// Create a stream of visits and impressions, with data arriving out of order.</code>
    <code class="k">return</code> <code class="n">TestStream</code><code class="o">.</code><code class="na">create</code><code class="o">(</code>
	<code class="n">KvCoder</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">StringUtf8Coder</code><code class="o">.</code><code class="na">of</code><code class="o">(),</code> <code class="n">AvroCoder</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">VisitOrImpression</code><code class="o">.</code><code class="na">class</code><code class="o">)))</code>
	<code class="o">.</code><code class="na">advanceWatermarkTo</code><code class="o">(</code><code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:00:00"</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="n">shoppingVisit2</code><code class="o">,</code> <code class="kc">null</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="n">shoppingGoal</code><code class="o">,</code> <code class="kc">null</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="n">shoppingVisit3</code><code class="o">,</code> <code class="kc">null</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="n">signupGoal</code><code class="o">,</code> <code class="kc">null</code><code class="o">))</code>
	<code class="o">.</code><code class="na">advanceWatermarkTo</code><code class="o">(</code><code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:00:30"</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code> <code class="n">signupImpression</code><code class="o">))</code>
	<code class="o">.</code><code class="na">advanceWatermarkTo</code><code class="o">(</code><code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:01:00"</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code> <code class="n">shoppingImpression</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="n">signupVisit</code><code class="o">,</code> <code class="kc">null</code><code class="o">))</code>
	<code class="o">.</code><code class="na">advanceWatermarkTo</code><code class="o">(</code><code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:01:30"</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code> <code class="n">shoppingImpressionDup</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="n">shoppingVisit1</code><code class="o">,</code> <code class="kc">null</code><code class="o">))</code>
	<code class="o">.</code><code class="na">advanceWatermarkTo</code><code class="o">(</code><code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:03:45"</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code> <code class="n">unattributedImpression</code><code class="o">))</code>
	<code class="o">.</code><code class="na">advanceWatermarkTo</code><code class="o">(</code><code class="n">Utils</code><code class="o">.</code><code class="na">parseTime</code><code class="o">(</code><code class="s">"12:04:00"</code><code class="o">))</code>
	<code class="o">.</code><code class="na">addElements</code><code class="o">(</code><code class="n">visitOrImpression</code><code class="o">(</code><code class="n">unattributedVisit</code><code class="o">,</code> <code class="kc">null</code><code class="o">))</code>
	<code class="o">.</code><code class="na">advanceWatermarkToInfinity</code><code class="o">();</code>
<code class="o">}</code>
</pre>
</div>

<p>And remember, we’re working here on a relatively constrained version of conversion attribution. A full-blown impelementation would have additional challenges to deal with (e.g., garbage collection, DAGs of visits instead of trees). Regardless, this pipeline provides a nice contrast to the oftentimes insufficiently flexible approaches provided by raw grouping an incremental combination. By trading off some amount of implementation complexity, we were able to find the necessary balance of efficiency, without compromising on correctness.<a contenteditable="false" data-primary="persistent state" data-secondary="generalized state" data-startref="ix_perstgencaAB" data-tertiary="in conversion attribution using Apache Beam" data-type="indexterm" id="idm140176510738448"></a><a contenteditable="false" data-primary="persistent state" data-secondary="generalized state" data-startref="ix_perstgen" data-type="indexterm" id="idm140176510736592"></a><a contenteditable="false" data-primary="generalized state" data-secondary="in conversion attribution using Apache Beam" data-startref="ix_genstcnvattAB" data-type="indexterm" id="idm140176510734944"></a><a contenteditable="false" data-primary="conversion attribution" data-secondary="with Apache Beam" data-startref="ix_cnvattrAB" data-type="indexterm" id="idm140176510257104"></a><a contenteditable="false" data-primary="Apache Beam" data-secondary="conversion attribution with" data-startref="ix_ApBmcnvattr" data-type="indexterm" id="idm140176510255456"></a><a contenteditable="false" data-primary="generalized state" data-startref="ix_genst" data-type="indexterm" id="idm140176510253744"></a> Additionally, this pipeline highlights the more imperative approach towards stream processing that state and timers afford (think C or Java), which is a nice complement to the more functional approach afforded by windowing and triggers (think Haskell).</p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idm140176512639264">
<h1>Summary</h1>

<p>In this chapter, we’ve looked closely at why persistent state is important, coming to the conclusion that it provides a basis for correctness and efficiency in long-lived pipelines. We then looked at the two most common types of implicit state encountered in data processing systems: raw grouping and incremental combination. <a contenteditable="false" data-primary="raw grouping" data-type="indexterm" id="idm140176510250592"></a><a contenteditable="false" data-primary="incremental combination" data-type="indexterm" id="idm140176510249488"></a>We learned that raw grouping is straightforward but potentially inefficient and that incremental combination greatly improves efficiency for operations that are commutative and associative. Finally, we looked a relatively complex, but very practical use case (and implementation via Apache Beam Java) grounded in real-world experience, and used that to highlight the important characteristics needed<a contenteditable="false" data-primary="generalized state" data-secondary="flexibility in" data-type="indexterm" id="idm140176510247840"></a> in a general state <span class="keep-together">abstraction</span>:</p>

<ul>
	<li>
	<p><em>Flexibility in data structures</em>, allowing for the use of data types tailored to specific use cases at hand.</p>
	</li>
	<li>
	<p><em>Flexibility in write and read granularity</em>, allowing the amount of data written and read at any point to be tailored to the use case, minimizing or maximizing I/O as appropriate.</p>
	</li>
	<li>
	<p><em>Flexibility in scheduling of processing</em>, allowing certain portions of processing to be delayed until a more appropriate point in time, such as when the input is believed to be complete up to a specific point in event time.<a contenteditable="false" data-primary="persistent state" data-startref="ix_perst" data-type="indexterm" id="idm140176510241648"></a></p>
	</li>
</ul>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm140176512989872"><sup><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512989872-marker" class="totri-footnote">1</a></sup> For some definition of “forever,” typically at least “until we successfully complete execution of our batch pipeline and no longer require the inputs.”</p><p data-type="footnote" id="idm140176512957744"><sup><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512957744-marker" class="totri-footnote">2</a></sup> Recall that Beam doesn’t currently expose these state tables directly; you must trigger them back into a stream to observe their contents as a new PCollection.</p><p data-type="footnote" id="idm140176512784336"><sup><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512784336-marker" class="totri-footnote">3</a></sup> Or, as my colleague Kenn Knowles points out, if you take the definition as being commutativity across sets, the three-parameter version of commutativity is actually sufficient to also imply associativity: <code>COMBINE(a, b, c) == COMBINE(a, c, b) == COMBINE(b, a, c) == COMBINE(b, c, a) == COMBINE(c, a, b) == COMBINE(c, b, a)</code>. Math is fun.</p><p data-type="footnote" id="idm140176512711840"><sup><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512711840-marker" class="totri-footnote">4</a></sup> And indeed, timers are the underlying feature used to implement most of the completeness and repeated updated triggers we discussed in <a data-type="xref" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch02.html#the_what_where_when_and_how">Chapter&nbsp;2</a> as well as garbage collection based on allowed lateness.</p><p data-type="footnote" id="idm140176512657920"><sup><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#idm140176512657920-marker" class="totri-footnote">5</a></sup> Thanks to the nature of web browsing, the visit trails we’ll be analyzing are trees of URLs linked by HTTP referrer fields. In reality, they would end up being directed graphs, but for the sake of simplicity, we’ll assume each page on our website has incoming links from exactly one other referring page on the site, thus yielding a simpler tree structure. Generalizing to graphs is a natural extension of the tree-based implementation, and only further drives home the points being made.</p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#">Add Highlight</a></li>
		<li class="add-note"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#">
			
				Add Note
			
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch06.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">6. Streams and Tables</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch08.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">8. Streaming SQL</div>
        </a>
    
  
  </div>


        
    </section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel t-subscribe-nag collapsed">
        
        
          
          
            <p class="usage-data">Find answers on the fly, or master something new. Subscribe today. <a href="https://www.safaribooksonline.com/subscribe/" class="ga-active-trial-subscribe-nag">See pricing options.</a></p>
          

          
        
        

      </div>

    
    



        
      </div>
      




  <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li>
      <a class="t-queue-footer" href="https://www.safaribooksonline.com/playlists/">Playlists</a>
      </li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/preferences/">Settings</a></li>
      <li class="full-support"><a href="https://www.oreilly.com/online-learning/support/">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2018 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    
    
      <img src="https://www.oreilly.com/library/view/oreilly_set_cookie/" alt="" style="display:none;">
    
    
<div style="width:0px; height:0px; display:none; visibility:hidden;" id="batBeacon0.48365925681703414"><img style="width:0px; height:0px; display:none; visibility:hidden;" id="batBeacon0.09368623002549681" width="0" height="0" alt="" src="https://bat.bing.com/action/0?ti=5794699&amp;Ver=2&amp;mid=1adf3dfa-3440-1d9c-5f1b-dfccbdf9597a&amp;pi=1200101525&amp;lg=en-US&amp;sw=1440&amp;sh=900&amp;sc=24&amp;tl=7.%20The%20Practicalities%20of%20Persistent%20State%20-%20Streaming%20Systems&amp;p=https%3A%2F%2Fwww.safaribooksonline.com%2Flibrary%2Fview%2Fstreaming-systems%2F9781491983867%2Fch07.html&amp;r=&amp;evt=pageLoad&amp;msclkid=N&amp;rn=406392"></div>
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="/safari-books-archive/site/library/view/streaming-systems/9781491983867/ch07.html#">Reset</a>
</div>
</div></body></html>
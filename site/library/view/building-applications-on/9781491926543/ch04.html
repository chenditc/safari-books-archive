<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/building-applications-on/9781491926543/ch04.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781491926543"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch04.html"
  data-epub-title="Building Applications on Mesos" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/building-applications-on/9781491926543/ch04.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781491926543" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch04.html" data-epub-title="Building Applications on Mesos" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781491926543"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>4. Creating a New Framework for Mesos - Building Applications on Mesos</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link,#sbo-rt-content a{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important;margin-bottom:30px !important}#sbo-rt-content section[data-type="sect1"] h1{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content section[data-type="sect2"] h2{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content section[data-type="sect3"] h3{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content section[data-type="sect4"] h4{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section[data-type="chapter"]>div>h1,#sbo-rt-content section[data-type="preface"]>div>h1,#sbo-rt-content section[data-type="appendix"]>div>h1,#sbo-rt-content section[data-type="glossary"]>div>h1,#sbo-rt-content section[data-type="bibliography"]>div>h1,#sbo-rt-content section[data-type="index"]>div>h1{font-size:2em;line-height:1;margin-bottom:50px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div[data-type="part"] h1{font-size:2em;text-align:center;margin-top:0 !important;margin-bottom:50px;padding:50px 0 10px 0;border-bottom:1px solid #000}#sbo-rt-content img.width-ninety{width:90%}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:15px 0 15px 0 !important;page-break-inside:avoid}#sbo-rt-content figure{margin:15px 0 15px 0 !important;page-break-inside:avoid}#sbo-rt-content div.figure h6{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding-top:10px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:15px 0 10px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content aside[data-type="sidebar"]{margin:15px 0 10px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title,#sbo-rt-content aside[data-type="sidebar"] h5{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content aside[data-type="sidebar"] figcaption,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol,#sbo-rt-content aside[data-type="sidebar"] ul{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure,#sbo-rt-content aside[data-type="sidebar"] figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div[data-type="example"]{margin:10px 0 15px 0 !important}#sbo-rt-content div[data-type="example"] h1,#sbo-rt-content div[data-type="example"] h2,#sbo-rt-content div[data-type="example"] h3,#sbo-rt-content div[data-type="example"] h4,#sbo-rt-content div[data-type="example"] h5,#sbo-rt-content div[data-type="example"] h6{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div[data-type="example"] pre[data-type="programlisting"],#sbo-rt-content div[data-type="example"] pre[data-type="screen"]{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content section[data-type="titlepage"]>div>h1{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content section[data-type="titlepage"]>div>h2[data-type="author"]{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:.25em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content dl.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content dl.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content dl.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div[data-type="tip"],#sbo-rt-content div.note,#sbo-rt-content div[data-type="note"],#sbo-rt-content div.warning,#sbo-rt-content div[data-type="warning"],#sbo-rt-content div[data-type="caution"],#sbo-rt-content div[data-type="important"]{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div[data-type="tip"],#sbo-rt-content div.note,#sbo-rt-content div[data-type="note"]{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div[data-type="warning"],#sbo-rt-content div[data-type="caution"],#sbo-rt-content div[data-type="important"]{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div[data-type="tip"] h6,#sbo-rt-content div[data-type="tip"] h1,#sbo-rt-content div.note h3,#sbo-rt-content div[data-type="note"] h6,#sbo-rt-content div[data-type="note"] h1,#sbo-rt-content div.warning h3,#sbo-rt-content div[data-type="warning"] h6,#sbo-rt-content div[data-type="warning"] h1,#sbo-rt-content div[data-type="caution"] h6,#sbo-rt-content div[data-type="caution"] h1,#sbo-rt-content div[data-type="important"] h1{font-weight:bold;font-size:110%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div[data-type="tip"] h6,#sbo-rt-content div.note h3,#sbo-rt-content div[data-type="note"] h6{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div[data-type="warning"] h6,#sbo-rt-content div[data-type="caution"] h6,#sbo-rt-content div[data-type="important"] h6{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note,#sbo-rt-content div.safarienabled{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr,#sbo-rt-content tr td{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td,#sbo-rt-content thead th{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td,#sbo-rt-content th{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title,#sbo-rt-content table caption{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:10px 0 10px 0 !important;text-align:center;padding:0;page-break-after:avoid}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold;text-indent:0}#sbo-rt-content div.index li{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content div.index ul{list-style-type:none;padding-left:0;margin-left:0}#sbo-rt-content div.index ul li{padding-left:0;margin-left:0}#sbo-rt-content div.index ul li ul li{margin-left:20px}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/site/library/view/building-applications-on/9781491926543/ch04.html"><meta name="description" content=" Chapter 4. Creating a New Framework for Mesos A Mesos framework is the conceptual aggregation of a distributed system. But what does that mean to us, as framework developers? How ... "><meta property="og:title" content="4. Creating a New Framework for Mesos"><meta itemprop="isPartOf" content="/library/view/building-applications-on/9781491926543/"><meta itemprop="name" content="4. Creating a New Framework for Mesos"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/ch04.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781491926543/"><meta property="og:description" itemprop="description" content=" Chapter 4. Creating a New Framework for Mesos A Mesos framework is the conceptual aggregation of a distributed system. But what does that mean to us, as framework developers? How ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781491926529"><meta property="og:book:author" itemprop="author" content="David Greenberg"><meta property="og:book:tag" itemprop="about" content="Databases"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Building Applications on Mesos
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781491926543/chapter/ch04.html" data-for-analytics="9781491926543:ch04.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/ch04.html&amp;text=Building%20Applications%20on%20Mesos&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/ch04.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/ch04.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%204.%20Creating%20a%20New%20Framework%20for%20Mesos&amp;body=https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/ch04.html%0D%0Afrom%20Building%20Applications%20on%20Mesos%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/site/library/view/building-applications-on/9781491926543/ch03.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">3. Porting an Existing Application to Mesos</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/site/library/view/building-applications-on/9781491926543/ch05.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">5. Building a Mesos Executor</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 4. Creating a New Framework for Mesos"><div class="chapter" id="chapter_creating_new_scheduler">
<h1><span class="label">Chapter 4. </span>Creating a New Framework for Mesos</h1>


<p>A Mesos <a data-type="indexterm" data-primary="framework design" data-secondary="scheduler-only" data-see="schedulers" id="idp9820640"></a>framework is the conceptual aggregation of a distributed system.
But what does that mean to us, as framework developers?
How can we actually understand how the structure of the code we write maps onto the Mesos cluster?
Let’s review the Mesos architecture, and learn some common patterns in framework design.</p>

<p>Instead of trying to understand everything about Mesos architecture all at once, we’ll look at the simplest case: a framework that only has a scheduler, and no custom executor.
This type of framework could spin up workers to process requests coming in on a queue, or it could manage a pool of services.</p>






<section data-type="sect1" data-pdf-bookmark="The Scheduler"><div class="sect1" id="idp9823104">
<h1>The Scheduler</h1>

<p>The <a data-type="indexterm" data-primary="schedulers" id="s4"></a><a data-type="indexterm" data-primary="schedulers" data-secondary="responsibilities" id="idp9825616"></a>scheduler is the component that interacts directly with the leading Mesos master.
A scheduler has four responsibilities:</p>
<ol>
<li>
<p>Launch tasks on the received offers.</p>
</li>
<li>
<p>Handle status updates from those tasks, particularly to respond to task failures and crashes.</p>
</li>
<li>
<p>Persist state and manage failovers in order to be highly available.</p>
</li>
<li>
<p>Interact with clients, users, or other systems (since no system runs in a vacuum!).</p>
</li>

</ol>

<p>Some of these responsibilities are implemented purely by interacting with the Mesos API; others must be implemented using the language of choice’s platform.
For instance, launching tasks and handling status updates are implemented entirely by Mesos callbacks and API requests.
On the other hand, it’s up to you to start a web server (such as Jetty on Java or Flask on Python) to allow clients to interact with the scheduler.
High availability usually requires using both Mesos APIs and other libraries to create a solution that is suitable for the problem domain.</p>

<p>But how can we launch tasks if we’re only focusing on the scheduler?
For our convenience, Mesos comes with something called the <code>CommandExecutor</code>, <a data-type="indexterm" data-primary="CommandExecutor" id="idp9832864"></a>which is specifically designed to make it easy to launch and orchestrate command-line programs and Docker containers.
Let’s take a look at some high-level designs for several common scheduler abstractions: building a pool of servers, a work queue, and a job processor.</p>

<p>First, we’ll look at the pool of servers design. Its architecture is illustrated <a data-type="indexterm" data-primary="pool of servers scheduler" id="idp9834400"></a><a data-type="indexterm" data-primary="schedulers" data-secondary="pool of servers design" id="idp9835072"></a>in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#pool_of_servers_scheduler_fig">Figure&nbsp;4-1</a>.</p>








<section data-type="sect2" data-pdf-bookmark="Pool of Servers Scheduler"><div class="sect2" id="pool_of_servers">
<h2>Pool of Servers Scheduler</h2>

<figure><div id="pool_of_servers_scheduler_fig" class="figure">
<img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/baom_0401.png" alt="Architecture and Information Flow of a Pool of Servers Scheduler" width="1375" height="513" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/baom_0401.png">
<h6><span class="label">Figure 4-1. </span>Architecture and information flow of a pool of servers scheduler</h6>
</div></figure>

<p>This scheduler is simply going to ensure that there are always <em>X</em> copies of some application, such as Ruby on Rails, running.
To build a pool of servers, our scheduler will have a list of all the servers it wants to be running.
Initially, the list will have all the servers in <a data-type="indexterm" data-primary="server states" id="idp9841824"></a><a data-type="indexterm" data-primary="pending state" id="idp9842528"></a>the <em>pending</em> state.
As the scheduler receives offers, it will attempt to launch servers, putting them into the <em>staging</em> state.
Once <a data-type="indexterm" data-primary="staging state" id="idp9844272"></a><a data-type="indexterm" data-primary="running state" id="idp9845008"></a>the servers start successfully, the scheduler can move them to the <em>running</em> state.
If they ever crash, they’ll go back to the initial pending state so that they can be relaunched on a new offer.
Note that we need three states here: pending, staging, and running.</p>

<p>You might be tempted to remove the staging state, since, after all, that seems awfully similar to pending—in both cases, the server is not yet started.
But here’s the problem: Mesos is an asynchronous system!
You could receive many offers between attempting to launch a task and having the task actually start.
Thus, the staging state ensures that we only try to launch each server once, and only retry if the launch fails.
If you forget to have a staging state, you might encounter a bug in which there are tens or hundreds of instances of a task when there should be only one.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Work Queue Scheduler"><div class="sect2" id="work_queue_scheduler_example">
<h2>Work Queue Scheduler</h2>

<p>The <a data-type="indexterm" data-primary="schedulers" data-secondary="work queue design" id="idp9849200"></a><a data-type="indexterm" data-primary="work queue scheduler" id="idp9850208"></a>work queue architecture, illustrated in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#architecture_and_information_flow">Figure&nbsp;4-2</a>, allows clients to submit “work items” to a queue, where they’ll eventually be processed by workers.
A work queue scheduler will ensure that we always have a sufficient number of workers running, so that there will be a sufficient number of workers to process the queued work items.</p>

<figure><div id="architecture_and_information_flow" class="figure">
<img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/baom_0402.png" alt="Architecture and Information Flow of a Work Queue Scheduler" width="1272" height="542" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/baom_0402.png">
<h6><span class="label">Figure 4-2. </span>Architecture and information flow of a work queue scheduler</h6>
</div></figure>

<p>To build this scheduler, we’re actually going to cheat and assume that we already have a pool of servers scheduler, as described in the previous section.
This way, we simply start the workers as servers in the pool.
Therefore, the meat of this system will reside in the workers themselves.</p>

<p>Our workers will retrieve their work items from some known location.
This location could be passed to them from the scheduler as a command-line option or environment variable.
Each worker will connect to the queue, and then loop forever: retrieve an item, process it, and mark it as done.</p>

<p>The neat thing about considering work queues (and all potential frameworks) in this way is that you don’t even need to write a scheduler—you could just use Marathon or some other pool of services scheduler.
Of course, this shifts the implementation of the queue to another system, such as RabbitMQ or Redis.
This is a good thing: the Mesos messaging APIs are designed for controlling the applications on the cluster and are not as well suited to other domains, such as transactional logic or high-performance messaging.
When developing frameworks for Mesos, you must use appropriate data storage backends—queues, databases, and document stores are all likely useful, depending on the framework you’re building.</p>
</div></section>













<section data-type="sect2" class="pagebreak-before" data-pdf-bookmark="Job Processor Scheduler"><div class="sect2" id="job_processor_scheduler">
<h2>Job Processor Scheduler</h2>

<p>The <a data-type="indexterm" data-primary="schedulers" data-secondary="job processor design" id="idp9858880"></a><a data-type="indexterm" data-primary="job processor scheduler" id="idp9859888"></a>final abstraction we’ll consider is the job processor scheduler (<a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#architecture_information_flow_job_processor">Figure&nbsp;4-3</a>).</p>

<figure><div id="architecture_information_flow_job_processor" class="figure">
<img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/baom_0403.png" alt="Architecture and Information Flow of a Job Processor Scheduler" width="1272" height="542" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/baom_0403.png">
<h6><span class="label">Figure 4-3. </span>Architecture and information flow of a job processor scheduler</h6>
</div></figure>

<p>A job processor will accept a list of jobs from clients and then run those jobs on a cluster; a job is just a command line to invoke, along with the CPU and memory resources it needs.
This scheduler will require a slightly more complex state machine, since we’ll also need terminal states for jobs (we’ll call them <em>successful</em> and <em>failed</em>).
We’ll also track how many retries have been attempted, so that we can give up on jobs with no hope for success.</p>

<p>This scheduler’s state machine will move jobs from <a data-type="indexterm" data-primary="server states" id="idp9865952"></a>pending to staging <a data-type="indexterm" data-primary="pending state" id="idp9866784"></a><a data-type="indexterm" data-primary="running state" id="idp9867488"></a>when it attempts to launch them on an offer, and from staging to running when the job actually starts running.
Handling completion of a task is trickier, though: we’ll want to move the job to successful if it succeeds, to failed if it has exceeded the maximum number of retries, or to pending if it has more retries remaining.
Furthermore, we could determine whether the task failed due to a bug in its code, a transient machine failure, or some other issue—this is useful feedback for deciding whether to have the job fail fast, or let it continue to retry.</p>

<p>Now that we’ve seen conceptually how a framework could be implemented with just a scheduler, let’s try our hand at implementing the job processor.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Useless Remote BASH"><div class="sect1" id="idp9869536">
<h1>Useless Remote BASH</h1>

<p>Before <a data-type="indexterm" data-primary="framework design" data-secondary="minimal code for task launch" id="fd4mcftl"></a>we get started on the job processor, let’s break down the absolute minimal code needed to get a task to launch on Mesos.
We’ll call this program Useless Remote BASH,<sup><a data-type="noteref" id="idp9873088-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp9873088" class="totri-footnote">1</a></sup> as it’ll just run the hardcoded program in a container on the cluster.</p>

<p>Let’s break down this most simple of frameworks into several parts, and see
why each part is necessary. In <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#imports_cdecl_urb">Example&nbsp;4-1</a>, we can see the imports and class declaration of our new scheduler.</p>
<div id="imports_cdecl_urb" data-type="example">
<h5><span class="label">Example 4-1. </span>Imports and class declaration of useless remote BASH</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">com</code><code class="o">.</code><code class="na">example</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.nio.file.*</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.*</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.mesos.*</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.mesos.Protos.*</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">UselessRemoteBASH</code> <code class="kd">implements</code> <code class="n">Scheduler</code> <code class="o">{</code>
    <code class="c1">// We'll discuss the inner bits as we go</code>
<code class="o">}</code></pre></div>

<p>Two things here deserve our attention:</p>
<ol>
<li>
<p>We import everything from <code>org.apache.mesos</code> and <code>org.apache.mesos.Protos</code>, so that we can use the Mesos APIs.</p>
</li>
<li>
<p>Schedulers should implement the <code>Scheduler</code> interface, which defines the messages a scheduler can receive as callbacks.</p>
</li>

</ol>

<p>We’ll use the complementary <code>SchedulerDriver</code> class to send messages to Mesos. <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#main_urb">Example&nbsp;4-2</a> is the entry point of our program.</p>
<div id="main_urb" data-type="example">
<h5><span class="label">Example 4-2. </span>main of Useless Remote BASH</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code> <code class="o">...</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>
    <code class="n">FrameworkInfo</code> <code class="n">frameworkInfo</code> <code class="o">=</code> <code class="n">FrameworkInfo</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">()</code>
        <code class="o">.</code><code class="na">setUser</code><code class="o">(</code><code class="s">""</code><code class="o">)</code>
        <code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"Useless Remote BASH"</code><code class="o">)</code>
        <code class="o">.</code><code class="na">build</code><code class="o">();</code>

    <code class="n">Scheduler</code> <code class="n">mySched</code> <code class="o">=</code> <code class="k">new</code> <code class="n">UselessRemoteBASH</code><code class="o">();</code>


    <code class="n">SchedulerDriver</code> <code class="n">driver</code> <code class="o">=</code> <code class="k">new</code> <code class="n">MesosSchedulerDriver</code><code class="o">(</code>
        <code class="n">mySched</code><code class="o">,</code>
        <code class="n">frameworkInfo</code><code class="o">,</code>
        <code class="s">"zk://"</code> <code class="o">+</code> <code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code> <code class="o">+</code> <code class="s">"/mesos"</code>
    <code class="o">);</code>
    <code class="n">driver</code><code class="o">.</code><code class="na">start</code><code class="o">();</code>
    <code class="n">driver</code><code class="o">.</code><code class="na">join</code><code class="o">();</code>
<code class="o">}</code></pre></div>

<p>In the <code>main</code> function, first, we construct the <code>FrameworkInfo</code> of our framework.
<code>FrameworkInfo</code> is a <a data-type="indexterm" data-primary="FrameWorkInfo" id="idp9973568"></a>protobuf that describes the framework to Mesos.
You’ll want to choose a clear name for the framework, so that you can identify your framework in the Mesos UI.
In practice, you’ll want to construct the name to include several pieces of data: which framework this is, as well as other high-level information about the framework, such as whether it’s a <code>dev</code> or <code>prod</code> instance.
It’s entirely up to you what you name your framework, but consider the anecdote in the following sidebar!</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idp10026496">
<h5>When Poorly Chosen Framework Names Become Annoying</h5>
<p>We <a data-type="indexterm" data-primary="framework design" data-secondary="names" id="idp10027792"></a>decided it’d be effective to run Spark on our Mesos cluster.
We also decided that every user would get their own instance of Spark.
The next day, a user complained that tasks weren’t getting scheduled.
We opened the Mesos UI to see what was happening, but to our chagrin, every single user’s Spark framework was just called <code>Spark 0.7.6</code>.
As a result, we had no way to identify which user was hogging the resources!
From then on, we made sure to change the name of the Spark framework to <code>$username Spark 0.7.6</code>, so that we could tell what our cluster was doing at a glance.</p>
</div></aside>

<p>Typically, we set the framework’s user to an empty string (<code>""</code>), which means that it will register with Mesos as whichever user is running the scheduler.
In <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch02.html#mesos_roles">“Roles”</a>, we discussed how the framework’s user can be used for quotas, capacity planning, and security.
Most of the other fields of <code>FrameworkInfo</code> are used to configure high availability, so we’ll postpone discussing those until later.</p>

<p>After we’ve constructed our <code>FrameworkInfo</code>, we can create the <em>driver</em>, which is the component that actually communicates with Mesos.
The driver for the scheduler is an instance <a data-type="indexterm" data-primary="schedulers" data-secondary="SchedulerDriver" id="idp10034448"></a>of <code>SchedulerDriver</code>; you should stick with the <code>MesosSchedulerDriver</code> that is built with Mesos for now.
In the future, other implementations may be written in order to remove the dependencies on native code.
Unfortunately, the current projects working on this are more trouble than they’re worth for framework developers, as they haven’t reached stability yet.<sup><a data-type="noteref" id="idp10036688-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp10036688" class="totri-footnote">2</a></sup>
The <code>SchedulerDriver</code> takes three arguments: an implementation of the Mesos <code>Scheduler</code> interface, the <code>FrameworkInfo</code>, and the address of the Mesos cluster.
At this point, when we call <code>start()</code>, our driver will connect to the Mesos cluster, register the framework, and begin receiving offers.
Usually, you’ll want to call <code>join()</code> at the end of your <code>main</code> function.
<code>join()</code> blocks until the driver terminates, either from having <code>stop()</code> called on it or because Mesos instructed the driver to stop because the framework failed over.</p>
<div data-type="tip"><h1>A Common Pattern for Starting the SchedulerDriver</h1>
<p>Often, the last thing our main function does is call <code>start()</code> followed by <code>join()</code>.
Because this is so common, you can just call <code>run()</code>, which is essentially <code>start() &amp;&amp; join()</code>.</p>
</div>

<p>Now that we’ve seen how frameworks start up, let’s look at <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#maketask_urb">Example&nbsp;4-3</a>.
This function is an example of how to create a Mesos task that we can launch.
As this is a useless framework, we hardcode what would normally be important parameters: the <code>cpus</code>, <code>mem</code>, and <code>command</code> we want to run.</p>
<div id="maketask_urb" data-type="example">
<h5><span class="label">Example 4-3. </span>makeTask of Useless Remote BASH</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">TaskInfo</code><code> </code><code class="nf">makeTask</code><code class="o">(</code><code class="n">SlaveID</code><code> </code><code class="n">targetSlave</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kt">double</code><code> </code><code class="n">cpus</code><code> </code><code class="o">=</code><code> </code><code class="mf">1.0</code><code class="o">;</code><code>
</code><code>    </code><code class="kt">double</code><code> </code><code class="n">mem</code><code> </code><code class="o">=</code><code> </code><code class="mf">100.0</code><code class="o">;</code><code>
</code><code>    </code><code class="n">String</code><code> </code><code class="n">command</code><code> </code><code class="o">=</code><code> </code><code class="s">"echo hello world"</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="n">UUID</code><code> </code><code class="n">uuid</code><code> </code><code class="o">=</code><code> </code><code class="n">UUID</code><code class="o">.</code><code class="na">randomUUID</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">TaskID</code><code> </code><code class="n">id</code><code> </code><code class="o">=</code><code> </code><code class="n">TaskID</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-1a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-1a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>        </code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">uuid</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">TaskInfo</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-2a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-2a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>        </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"useless_remote_bash.task "</code><code> </code><code class="o">+</code><code> </code><code class="n">id</code><code class="o">.</code><code class="na">getValue</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">setTaskId</code><code class="o">(</code><code class="n">id</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">addResources</code><code class="o">(</code><code class="n">Resource</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-3a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-3a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>                </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"cpus"</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setType</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Type</code><code class="o">.</code><code class="na">SCALAR</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setScalar</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Scalar</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">cpus</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">addResources</code><code class="o">(</code><code class="n">Resource</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code> </code><a class="co" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-3a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>                </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"mem"</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setType</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Type</code><code class="o">.</code><code class="na">SCALAR</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setScalar</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Scalar</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">mem</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">setCommand</code><code class="o">(</code><code class="n">CommandInfo</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">command</code><code class="o">)</code><code class="o">)</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-4a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-4a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>        </code><code class="o">.</code><code class="na">setSlaveId</code><code class="o">(</code><code class="n">targetSlave</code><code class="o">)</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-5a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-5a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code>
</code><code>        </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-1a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-1a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>First, <a contenteditable="false" data-type="indexterm" data-primary="TaskID" id="idp10110576"></a>we make a <code>TaskID</code>.
The <code>TaskID</code> must be unique to the framework, just as the <code>ExecutorID</code> must be unique to the slave and the <code>SlaveID</code> must be unique to the cluster.
I typically find it easiest to just use UUIDs appended to any IDs I need to generate, since that way I don’t need to ever worry about the uniqueness constraints that Mesos requires.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-2a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-2a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>Next, we make the <code>TaskInfo</code>, which is the protobuf that explains how to launch a task.
The <code>TaskInfo</code> <a contenteditable="false" data-type="indexterm" data-primary="TaskInfo" id="idp10089648"></a>requires you to set a name for the task.
This name is what’s displayed in the UI, and many Mesos tools can interact with it, such as the Mesos CLI.
Typically, you’ll want to set the name of the task to include useful specifying information, such as the framework name and any related entity (such as the app in Marathon or job in Hadoop).
By writing the name from most general (i.e., framework) to most specific (i.e., instance of the task), you’ll benefit from tools that can provide tab completion and autocompletion of the task names.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-3a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-3a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>A task wouldn’t be useful without any resources: <code>TaskInfo</code> is where you can add all of the resources that the task will consume.
The only two resources that you’ll always want to specify are <code>cpus</code> and <code>mem</code> (note the s at the end of <code>cpus</code>); if your application listens to the network, you should also specify <code>ports</code>.
There are many other resource types that Mesos can manage; you can read more about them in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch02.html#custom_resources_info">“Resources”</a>.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-4a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-4a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>Since this framework is very simple, we set the command so that the Mesos <code>CommandExecutor</code> <a contenteditable="false" data-type="indexterm" data-primary="CommandExecutor" id="idp10366080"></a>will handle the actual running of our task.
We specify our command to <a contenteditable="false" data-type="indexterm" data-primary="CommandInfo" id="idp10367344"></a>the <code>CommandInfo</code> that we provide as the command; its features are discussed in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#commandinfo_details">“CommandInfo”</a>.
For the <code>CommandExecutor</code>, the <code>TaskID</code> and the <code>ExecutorID</code> are the same.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-5a" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-5a"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p>Finally, we must tie this <code>TaskInfo</code> to the offer.
Since it’s possible to apply several offers from the same slave to one task (pooling them for more total resources), we specify the <code>SlaveID</code> of the slave we want the task to launch on rather than the <code>OfferID</code>s that we want it to use.
When we actually call <code>launchTasks()</code>, that’s where we’ll link the offers to the <code>TaskInfo</code> (see the note <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#combining_offers_tip">Combining Offers</a> following <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#resource_offers_urb">Example&nbsp;4-5</a>).</p></dd>
</dl>
</div>

<p>We’ve managed to register our framework, and we’ve learned how to specify a task to launch.
The last step is to actually implement that pesky <code>Scheduler</code> interface.
For this super-basic framework, we’re going to ignore most of the callbacks, <a data-type="indexterm" data-primary="schedulers" data-secondary="callbacks" id="idp10378944"></a>as they update us on information we don’t want to react to.
Note that all of the callbacks provide you with a driver; this driver is guaranteed to be the same one you called <code>start()</code> on.
Mesos passes you this as a convenience, since it’s the only way to interact with the cluster, and that’s typically something you’d like to do in response to cluster events. <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#logging_sched_cb_urb">Example&nbsp;4-4</a> shows the callbacks we want to log: <code>registered</code> and <code>statusUpdate</code>.</p>
<div id="logging_sched_cb_urb" data-type="example">
<h5><span class="label">Example 4-4. </span>Scheduler callbacks to log</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">registered</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">,</code> <code class="n">FrameworkID</code> <code class="n">frameworkId</code><code class="o">,</code>
                               <code class="n">MasterInfo</code> <code class="n">masterInfo</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Registered with framework id "</code> <code class="o">+</code> <code class="n">frameworkId</code><code class="o">);</code>
<code class="o">}</code>

<code class="kd">public</code> <code class="kt">void</code> <code class="nf">statusUpdate</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">,</code> <code class="n">TaskStatus</code> <code class="n">status</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Got status update "</code><code class="o">+</code><code class="n">status</code><code class="o">);</code>
<code class="o">}</code></pre></div>

<p>When we have successfully registered with the Mesos masters, we’ll get the <code>registered</code> callback.
When you register a framework for the first time, you don’t specify the <code>FrameworkID</code>; instead, Mesos will assign it for you.
This callback is the only place to learn the assignment of <a data-type="indexterm" data-primary="FrameworkID" id="idp10445312"></a>the <code>FrameworkID</code>.
(In <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#storing_the_fid">Example&nbsp;4-15</a> and <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#using_stored_fid">Example&nbsp;4-14</a>, we’ll see how we can use this <code>FrameworkID</code> to safely fail a scheduler over to a new instance, so that we can build zero-downtime systems.)
The <code>MasterInfo</code> <a data-type="indexterm" data-primary="MasterInfo" id="idp10449040"></a>tells you which port and version the master is running on.
Frameworks can decide which Mesos features are valid to use based on the master’s version.</p>

<p>The <code>statusUpdate</code> <a data-type="indexterm" data-primary="status updates" id="idp10450768"></a>callback will soon become very important for our scheduler, as it’s how we track the lifecycle of our tasks: when they start running, and when and why they fail.
Even though we’re not going to do anything with this callback yet, it’s convenient to log when it happens, as that will help us debug our framework and confirm tasks that are actually launching and finishing.
Whenever I build a production framework, I always make sure to enable logging for every <code>statusUpdate</code> callback: those logs have helped me identify and debug issues countless times.</p>

<p>Finally, we get to look at the core of our new framework, as shown in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#resource_offers_urb">Example&nbsp;4-5</a>.
This callback is how we receive offers from Mesos—offers that are chock-full of juicy resources that we can launch <a data-type="indexterm" data-primary="resourceOffers" id="idp10453872"></a>tasks on.</p>
<div id="resource_offers_urb" data-type="example">
<h5><span class="label">Example 4-5. </span>Implementation of resourceOffers</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">private</code><code> </code><code class="kt">boolean</code><code> </code><code class="n">submitted</code><code> </code><code class="o">=</code><code> </code><code class="kc">false</code><code class="o">;</code><code>
</code><code>
</code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">resourceOffers</code><code class="o">(</code><code class="n">SchedulerDriver</code><code> </code><code class="n">driver</code><code class="o">,</code><code> </code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">List</code><code class="o">&lt;</code><code class="n">Offer</code><code class="o">&gt;</code><code> </code><code class="n">offers</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kd">synchronized</code><code> </code><code class="o">(</code><code class="k">this</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">submitted</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>            </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Offer</code><code> </code><code class="n">o</code><code> </code><code class="o">:</code><code> </code><code class="n">offers</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>                </code><code class="n">driver</code><code class="o">.</code><code class="na">declineOffer</code><code class="o">(</code><code class="n">o</code><code class="o">.</code><code class="na">getId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="o">}</code><code>
</code><code>            </code><code class="k">return</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>        </code><code class="n">submitted</code><code> </code><code class="o">=</code><code> </code><code class="kc">true</code><code class="o">;</code><code>
</code><code>        </code><code class="n">Offer</code><code> </code><code class="n">offer</code><code> </code><code class="o">=</code><code> </code><code class="n">offers</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">TaskInfo</code><code> </code><code class="n">ti</code><code> </code><code class="o">=</code><code> </code><code class="n">makeTask</code><code class="o">(</code><code class="n">offer</code><code class="o">.</code><code class="na">getSlaveId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>        </code><code class="n">driver</code><code class="o">.</code><code class="na">launchTasks</code><code class="o">(</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO1-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO1-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>            </code><code class="n">Collections</code><code class="o">.</code><code class="na">singletonList</code><code class="o">(</code><code class="n">offer</code><code class="o">.</code><code class="na">getId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">,</code><code>
</code><code>            </code><code class="n">Collections</code><code class="o">.</code><code class="na">singletonList</code><code class="o">(</code><code class="n">ti</code><code class="o">)</code><code>
</code><code>        </code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Launched offer: "</code><code> </code><code class="o">+</code><code> </code><code class="n">ti</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>In our framework, we first check if we’ve already submitted our task.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>If we have, we simply decline all the offers.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>If we haven’t submitted our task yet, we <a data-type="indexterm" data-primary="TaskInfo" id="idp10121408"></a>construct a <code>TaskInfo</code> for it with the ID of the slave from the first offer we received.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO1-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO1-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>Then, we call <code>launchTasks</code> <a data-type="indexterm" data-primary="launchTasks" id="idp10105696"></a>to attempt to launch the task!</p></dd>
</dl>
<div data-type="tip" id="combining_offers_tip"><h1>Combining Offers</h1>
<p><code>launchTasks</code> takes a list of offers, which allows us to combine several offers for the same slave in order to pool those offers’ resources.
It also takes a list of tasks, so that you can launch as many tasks as fit on the given offers.
Note that all the tasks and offers must be for the same slave—the <code>launchTasks</code> will fail if they’re not.
If you want to launch tasks on multiple slaves, simply call <code>launchTasks</code> multiple times.</p>
</div>

<p>The other <code>Scheduler</code> callbacks, listed in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#noop_cb_urb">Example&nbsp;4-6</a>, can all be ignored for now.</p>
<div id="noop_cb_urb" data-type="example">
<h5><span class="label">Example 4-6. </span>Ignored callbacks for Useless Remote BASH</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">disconnected</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">)</code> <code class="o">{</code> <code class="o">}</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">error</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">,</code> <code class="n">java</code><code class="o">.</code><code class="na">lang</code><code class="o">.</code><code class="na">String</code> <code class="n">message</code><code class="o">)</code> <code class="o">{</code> <code class="o">}</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">executorLost</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">,</code> <code class="n">ExecutorID</code> <code class="n">executorId</code><code class="o">,</code>
                             <code class="n">SlaveID</code> <code class="n">slaveId</code><code class="o">,</code> <code class="kt">int</code> <code class="n">status</code><code class="o">)</code> <code class="o">{</code> <code class="o">}</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">frameworkMessage</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">,</code> <code class="n">ExecutorID</code> <code class="n">executorId</code><code class="o">,</code>
                                 <code class="n">SlaveID</code> <code class="n">slaveId</code><code class="o">,</code> <code class="kt">byte</code><code class="o">[]</code> <code class="n">data</code><code class="o">)</code> <code class="o">{</code> <code class="o">}</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">offerRescinded</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">,</code> <code class="n">OfferID</code> <code class="n">offerId</code><code class="o">)</code> <code class="o">{</code> <code class="o">}</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">reregistered</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">,</code> <code class="n">MasterInfo</code> <code class="n">masterInfo</code><code class="o">)</code> <code class="o">{</code> <code class="o">}</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">slaveLost</code><code class="o">(</code><code class="n">SchedulerDriver</code> <code class="n">driver</code><code class="o">,</code> <code class="n">SlaveID</code> <code class="n">slaveId</code><code class="o">)</code> <code class="o">{</code> <code class="o">}</code></pre></div>

<p>And there you have it!
You’ve written your first Mesos framework, and it actually does quite a lot.
It can register with the master, create a <code>TaskInfo</code> to express how to launch a task, log status updates, and accept an offer to launch the task.</p>
<div data-type="warning" epub:type="warning" id="executorLost_is_lol"><h1>executorLost Doesn’t Do Anything</h1>
<p>Unfortunately, there’s one scheduler callback that isn’t actually implemented or supported by <a data-type="indexterm" data-primary="executorLost" id="idp10774176"></a>Mesos: <code>executorLost</code>.
If you’d like to be notified about when an executor shuts down, we discuss a solution in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch05.html#canary_tasks">“Canary tasks”</a>.
This issue is being pursued in <a href="http://bit.ly/MESOS313">MESOS-313</a>, so future versions of Mesos will implement this callback.</p>
</div>

<p>This Framework actually has two problematic bugs: when it accepts the offer to launch a task, it fails to check if the offer is actually big enough.
If the offer was too small, we’ll get <a data-type="indexterm" data-primary="TASK_LOST" id="idp10777776"></a>a <code>TASK_LOST</code> status update about the task, rather than anything indicating success.
The other bug is that when it accepts the offer, it doesn’t decline the other offers that were potentially received <a data-type="indexterm" data-primary="resourceOffers" id="idp10779232"></a>in the <code>resourceOffers</code> callback.
Those other offers will be stuck in a limbo state until they expire, which could be several minutes (or forever, if you didn’t change the default).
They’ll be unavailable to other frameworks in the meantime.</p>

<p>In the coming sections, we’ll improve <code>resourceOffers</code> to fix <a data-type="indexterm" data-primary="framework design" data-secondary="minimal code for task launch" data-startref="fd4mcftl" id="idp10781552"></a>these issues.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Implementing a Basic Job Processor"><div class="sect1" id="idp9870448">
<h1>Implementing a Basic Job Processor</h1>

<p>Now, <a data-type="indexterm" data-primary="schedulers" data-secondary="job implementation" id="s4ji"></a><a data-type="indexterm" data-primary="job implementation" id="ji4"></a>let’s extend our framework to be more useful by reading a list of jobs from a JSON file, and then having it launch all of those jobs on Mesos.
We’ll start by looking at how we’ll model a job (<a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#implementation_of_job">Example&nbsp;4-7</a>).</p>
<div id="implementation_of_job" data-type="example">
<h5><span class="label">Example 4-7. </span>Job implementation</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">Job</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="kt">double</code><code> </code><code class="n">cpus</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO3-1b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-1b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="kt">double</code><code> </code><code class="n">mem</code><code class="o">;</code><code> </code><a class="co" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-1b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="n">String</code><code> </code><code class="n">command</code><code class="o">;</code><code> </code><a class="co" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-1b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="kt">boolean</code><code> </code><code class="n">submitted</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO3-2b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-2b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="nf">Job</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">submitted</code><code> </code><code class="o">=</code><code> </code><code class="kc">false</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">TaskInfo</code><code> </code><code class="nf">makeTask</code><code class="o">(</code><code class="n">SlaveID</code><code> </code><code class="n">targetSlave</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO3-3b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-3b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>        </code><code class="n">UUID</code><code> </code><code class="n">uuid</code><code> </code><code class="o">=</code><code> </code><code class="n">UUID</code><code class="o">.</code><code class="na">randomUUID</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">TaskID</code><code> </code><code class="n">id</code><code> </code><code class="o">=</code><code> </code><code class="n">TaskID</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">uuid</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">TaskInfo</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"task "</code><code> </code><code class="o">+</code><code> </code><code class="n">id</code><code class="o">.</code><code class="na">getValue</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">setTaskId</code><code class="o">(</code><code class="n">id</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">addResources</code><code class="o">(</code><code class="n">Resource</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                    </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"cpus"</code><code class="o">)</code><code>
</code><code>                    </code><code class="o">.</code><code class="na">setType</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Type</code><code class="o">.</code><code class="na">SCALAR</code><code class="o">)</code><code>
</code><code>                    </code><code class="o">.</code><code class="na">setScalar</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Scalar</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">cpus</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">addResources</code><code class="o">(</code><code class="n">Resource</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                    </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"mem"</code><code class="o">)</code><code>
</code><code>                    </code><code class="o">.</code><code class="na">setType</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Type</code><code class="o">.</code><code class="na">SCALAR</code><code class="o">)</code><code>
</code><code>                    </code><code class="o">.</code><code class="na">setScalar</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Scalar</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">mem</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">setSlaveId</code><code class="o">(</code><code class="n">targetSlave</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">setCommand</code><code class="o">(</code><code class="n">CommandInfo</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">command</code><code class="o">)</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">Job</code><code> </code><code class="nf">fromJSON</code><code class="o">(</code><code class="n">JSONObject</code><code> </code><code class="n">obj</code><code class="o">)</code><code> </code><code class="kd">throws</code><code> </code><code class="n">JSONException</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO3-4b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-4b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>        </code><code class="n">Job</code><code> </code><code class="n">job</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">Job</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">job</code><code class="o">.</code><code class="na">cpus</code><code> </code><code class="o">=</code><code> </code><code class="n">obj</code><code class="o">.</code><code class="na">getDouble</code><code class="o">(</code><code class="s">"cpus"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">job</code><code class="o">.</code><code class="na">mem</code><code> </code><code class="o">=</code><code> </code><code class="n">obj</code><code class="o">.</code><code class="na">getDouble</code><code class="o">(</code><code class="s">"mem"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">job</code><code class="o">.</code><code class="na">command</code><code> </code><code class="o">=</code><code> </code><code class="n">obj</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="s">"command"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">job</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="c1">// ... snip ... </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO3-5b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-5b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code class="c1">
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO3-1b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO3-1b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>As you can see, we have parameterized the CPU, memory, and command arguments.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO3-2b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO3-2b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>We’ve moved the <code>submitted</code> field into the <code>Job</code>, so that we can track its lifecycle.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO3-3b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO3-3b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>We’ve moved the <code>makeTask</code> function into the <code>Job</code> as well, so that it can access all the local fields of the <code>Job</code>.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO3-4b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO3-4b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>For convenience, we’ve defined a single way to construct a <code>Job</code>, via the factory method <code>fromJSON</code>.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO3-5b" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO3-5b"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p>I’ve left out the getter and setter definitions.</p></dd>
</dl>
</div>

<p>The <code>Job</code> is a container for information about a particular job, like a model class in MVC.
We’ve only added two special methods: <code>fromJSON</code>, which gives us a way to construct the <code>Job</code> with valid starting state, and <code>makeTask</code>, which gives us a way to easily turn it into a <code>TaskInfo</code> without having all the protobuf munging code in our scheduler class.</p>

<p>Next, let’s look at how our <code>main</code> function has evolved. <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#revised_main_for_useless_Remote">Example&nbsp;4-8</a> shows the revised version.</p>
<div id="revised_main_for_useless_Remote" data-type="example">
<h5><span class="label">Example 4-8. </span>Revised main for Useless Remote BASH</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="kt">void</code><code> </code><code class="nf">main</code><code class="o">(</code><code class="n">String</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code> </code><code class="n">args</code><code class="o">)</code><code> </code><code class="kd">throws</code><code> </code><code class="n">Exception</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kt">byte</code><code class="o">[</code><code class="o">]</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">Files</code><code class="o">.</code><code class="na">readAllBytes</code><code class="o">(</code><code class="n">Paths</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">args</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO2-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO2-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>    </code><code class="n">JSONObject</code><code> </code><code class="n">config</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">JSONObject</code><code class="o">(</code><code class="k">new</code><code> </code><code class="n">String</code><code class="o">(</code><code class="n">data</code><code class="o">,</code><code> </code><code class="s">"UTF-8"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO2-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO2-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>    </code><code class="n">JSONArray</code><code> </code><code class="n">jobsArray</code><code> </code><code class="o">=</code><code> </code><code class="n">config</code><code class="o">.</code><code class="na">getJSONArray</code><code class="o">(</code><code class="s">"jobs"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Job</code><code class="o">&gt;</code><code> </code><code class="n">jobs</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ArrayList</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="o">(</code><code class="kt">int</code><code> </code><code class="n">i</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="o">;</code><code> </code><code class="n">i</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">jobsArray</code><code class="o">.</code><code class="na">length</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><code class="n">i</code><code class="o">+</code><code class="o">+</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO2-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO2-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>        </code><code class="n">jobs</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">Job</code><code class="o">.</code><code class="na">fromJSON</code><code class="o">(</code><code class="n">jobsArray</code><code class="o">.</code><code class="na">getJSONObject</code><code class="o">(</code><code class="n">i</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">jobs</code><code class="o">)</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="c1">// Below here, the function remains almost as before
</code><code>    </code><code class="n">FrameworkInfo</code><code> </code><code class="n">frameworkInfo</code><code> </code><code class="o">=</code><code> </code><code class="n">FrameworkInfo</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">setUser</code><code class="o">(</code><code class="s">""</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"Useless Remote BASH"</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="n">Scheduler</code><code> </code><code class="n">mySched</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">UselessRemoteBASH</code><code class="o">(</code><code class="n">jobs</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO2-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO2-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>    </code><code class="n">SchedulerDriver</code><code> </code><code class="n">driver</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">MesosSchedulerDriver</code><code class="o">(</code><code>
</code><code>        </code><code class="n">mySched</code><code class="o">,</code><code>
</code><code>        </code><code class="n">frameworkInfo</code><code class="o">,</code><code>
</code><code>        </code><code class="s">"zk://"</code><code> </code><code class="o">+</code><code> </code><code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code> </code><code class="o">+</code><code> </code><code class="s">"/mesos"</code><code>
</code><code>    </code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">driver</code><code class="o">.</code><code class="na">start</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">driver</code><code class="o">.</code><code class="na">join</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO2-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO2-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>This allows us to read the entire contents of a file into memory. We assume that the first argument is still the Mesos cluster, and the second argument is the name of a file that contains the JSON configuration.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO2-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO2-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>We convert the byte array to JSON in this step, so that we can extract the <code>Job</code> configurations.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO2-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO2-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>Finally, we loop over the JSON job descriptors, processing them into <code>Job</code>s.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO2-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO2-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>This time, we pass an argument to our <code>Scheduler</code>: the jobs we want it to launch.</p></dd>
</dl>

<p class="pagebreak-before">Let’s take a look at a sample <a data-type="indexterm" data-primary="JSON" id="idp11656656"></a>JSON file of jobs, to get a feel for the schema:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code><code>
    </code><code class="nt">"jobs"</code><code class="p">:</code><code> </code><code class="p">[</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO3-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
        </code><code class="p">{</code><code>
            </code><code class="nt">"cpus"</code><code class="p">:</code><code> </code><code class="mf">0.5</code><code class="p">,</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO3-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO3-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
            </code><code class="nt">"mem"</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">,</code><code>
            </code><code class="nt">"command"</code><code class="p">:</code><code> </code><code class="s2">"sleep 60; echo hello world"</code><code>
        </code><code class="p">}</code><code>
    </code><code class="p">]</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO3-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO3-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>The JSON file should contain a JSON object with a single key, <code>jobs</code>. That key’s value should be a list of <code>Job</code> objects.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO3-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO3-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>Each job object has three properties: <code>cpus</code>, <code>mem</code>, and <code>command</code>, which correspond to the eponymous fields in the <code>Job</code> class.</p></dd>
</dl>

<p>Now that we can load jobs up, let’s see how we <a data-type="indexterm" data-primary="offers" data-secondary="resourceOffers" id="o4ro"></a><a data-type="indexterm" data-primary="resourceOffers" id="ro4"></a>evolved <code>resourceOffers</code>. The new version is shown in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#revised_implementation_of_resourceoffers">Example&nbsp;4-9</a>.</p>
<div id="revised_implementation_of_resourceoffers" data-type="example">
<h5><span class="label">Example 4-9. </span>Revised implementation of resourceOffers</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">resourceOffers</code><code class="o">(</code><code class="n">SchedulerDriver</code><code> </code><code class="n">driver</code><code class="o">,</code><code> </code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">List</code><code class="o">&lt;</code><code class="n">Offer</code><code class="o">&gt;</code><code> </code><code class="n">offers</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kd">synchronized</code><code> </code><code class="o">(</code><code class="n">jobs</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Job</code><code class="o">&gt;</code><code> </code><code class="n">pendingJobs</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ArrayList</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO4-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO4-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>        </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Job</code><code> </code><code class="n">j</code><code> </code><code class="o">:</code><code> </code><code class="n">jobs</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO4-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO4-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="o">(</code><code class="o">!</code><code class="n">j</code><code class="o">.</code><code class="na">isSubmitted</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>                </code><code class="n">pendingJobs</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">j</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="o">}</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>        </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Offer</code><code> </code><code class="n">o</code><code> </code><code class="o">:</code><code> </code><code class="n">offers</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO4-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO4-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">pendingJobs</code><code class="o">.</code><code class="na">isEmpty</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO4-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO4-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>                </code><code class="n">driver</code><code class="o">.</code><code class="na">declineOffer</code><code class="o">(</code><code class="n">o</code><code class="o">.</code><code class="na">getId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                </code><code class="k">break</code><code class="o">;</code><code>
</code><code>            </code><code class="o">}</code><code>
</code><code>            </code><code class="n">Job</code><code> </code><code class="n">j</code><code> </code><code class="o">=</code><code> </code><code class="n">pendingJobs</code><code class="o">.</code><code class="na">remove</code><code class="o">(</code><code class="mi">0</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO4-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO4-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code>
</code><code>            </code><code class="n">TaskInfo</code><code> </code><code class="n">ti</code><code> </code><code class="o">=</code><code> </code><code class="n">j</code><code class="o">.</code><code class="na">makeTask</code><code class="o">(</code><code class="n">o</code><code class="o">.</code><code class="na">getSlaveId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="n">driver</code><code class="o">.</code><code class="na">launchTasks</code><code class="o">(</code><code>
</code><code>                </code><code class="n">Collections</code><code class="o">.</code><code class="na">singletonList</code><code class="o">(</code><code class="n">o</code><code class="o">.</code><code class="na">getId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">,</code><code>
</code><code>                </code><code class="n">Collections</code><code class="o">.</code><code class="na">singletonList</code><code class="o">(</code><code class="n">ti</code><code class="o">)</code><code>
</code><code>            </code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="n">j</code><code class="o">.</code><code class="na">setSubmitted</code><code class="o">(</code><code class="kc">true</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO4-6" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO4-6"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO4-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO4-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>Because our <code>Job</code>s contain state information (i.e., whether or not they were just launched), we need to first calculate which jobs haven’t yet been launched.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO4-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO4-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>This loop allows us to find all the jobs that haven’t been submitted yet, and add them to <code>pendingJobs</code>.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO4-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO4-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>Now, we’re going to try to match jobs to offers.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO4-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO4-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>If we have no more jobs we want to launch, then we can decline the offer.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO4-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO4-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p>If we reach this line, we have a job to launch. From here on, the code is similar to our first incarnation.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO4-6" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO4-6"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a></dt>
<dd><p>Remember that we want to mark the job as submitted, or else we could accidentally double-submit the job.</p></dd>
</dl>

<p>This version of <code>resourceOffers</code> shows us several useful patterns.
Every framework needs to keep track of the running tasks and work that it wants to do in the future.
For most frameworks, it will be most convenient to have a single data structure that tracks all ongoing work.
This data structure will include both running and pending tasks.
Of course, when you actually want to launch a task, you’ll need to calculate the specific set of tasks that are still pending.
In this example, after each resource offer, we compute the set of pending tasks.
Later in this chapter, we’ll look at other architectures for tracking this information.</p>

<p>The other pattern that every framework uses is looping over all the offers, matching offers to pending work until one or the other is exhausted.
But you might be thinking: <code>resourceOffers</code> requires a lot of care, and this framework still fails to handle it effectively!
You’d be absolutely correct, which is why we’re going to look at how to fix that problem <a data-type="indexterm" data-primary="offers" data-secondary="resourceOffers" data-startref="o4ro" id="idp10822400"></a><a data-type="indexterm" data-primary="resourceOffers" data-startref="ro4" id="idp11288752"></a><a data-type="indexterm" data-primary="schedulers" data-secondary="job implementation" data-startref="s4ji" id="idp11289696"></a><a data-type="indexterm" data-primary="job implementation" data-startref="ji4" id="idp11290912"></a>now.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Matching Tasks to Offers"><div class="sect1" id="idp10783184">
<h1>Matching Tasks to Offers</h1>

<p>As <a data-type="indexterm" data-primary="schedulers" data-secondary="matching tasks to offers" id="s4mtto"></a><a data-type="indexterm" data-primary="tasks" data-secondary="matching to offers" id="t4mto"></a><a data-type="indexterm" data-primary="offers" data-secondary="assigning tasks to" id="o4att"></a>we’ve been alluding to throughout this chapter, the assignment of tasks to offers is fraught with details that must be attended to.
For instance, we must ensure that the offer has all the necessary resources for our job, we must attempt to launch as many tasks as we can on each offer, and we must prioritize which task we’ll launch next.
The reason we want to match as many tasks as possible to each offer is that if we only match one task per offer, our scheduler will launch tasks at a slow rate. Specifically:</p>
<div data-type="equation">
<img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/eq_1.png" alt="tasks launched per minute equals StartFraction number of slaves Over offer interval EndFraction" width="1229" height="100" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/eq_1.png">
</div>

<p>With the default offer interval of 1 second, if you have a five-slave cluster, you’ll only be able to launch at most 60 tasks per minute.
With properly implemented offer handling code, however, you could launch tens of thousands of tasks per minute!
For our example, we’re going to implement the first fit algorithm, since it requires very little code.
Then, we’ll learn about other algorithms, and various considerations therein. Let’s make the following change to our <code>resourceOffers</code>:</p>

<pre data-type="programlisting" data-code-language="java"><code class="o">...</code> <code class="c1">// code unchanged</code>
<code class="n">driver</code><code class="o">.</code><code class="na">launchTasks</code><code class="o">(</code>
    <code class="n">Collections</code><code class="o">.</code><code class="na">singletonList</code><code class="o">(</code><code class="n">o</code><code class="o">.</code><code class="na">getId</code><code class="o">()),</code>
    <code class="n">doFirstFit</code><code class="o">(</code><code class="n">o</code><code class="o">,</code> <code class="n">pendingJobs</code><code class="o">);</code>
<code class="o">);</code>
<code class="o">...</code> <code class="c1">// code unchanged</code></pre>

<p>Instead of directly taking a job, we’re going to compute the first fit of all the pending jobs to the given offer. The solution we find is a <code>List</code> of tasks, since the whole point is that we can launch multiple tasks on a single <a data-type="indexterm" data-primary="doFirstFit" id="dff4"></a><a data-type="indexterm" data-primary="first fit" id="ff4"></a>offer.</p>
<div data-type="tip" id="dofirstfit_semantics"><h1>doFirstFit’s Semantics</h1>
<p><code>doFirstFit</code> takes an <code>Offer</code> and a list of <code>Job</code>s and returns a list of <code>TaskInfo</code>s that we can launch on the cluster.
Note that <code>doFirstFit</code> is designed to remove all the <code>Job</code>s that it decides to match from the list of <code>Job</code>s passed into it.</p>
</div>

<p>Obviously, the interesting part is the implementation of <code>doFirstFit</code> (<a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#first_fit_offer_packing">Example&nbsp;4-10</a>).
The idea of first fit is this: given the amount of space available in an offer, we’ll add tasks that fit in whatever space is left in the offer.
When we decide to add a task, we’ll deduct its space usage from the remaining space.
Once we can’t fit any more tasks into the offer, we’ll remove all the matched <code>Job</code>s from the list of <code>Job</code> provided as an argument, and we’ll return the <code>TaskInfo</code>s that will launch those <code>Job</code>s.</p>
<div id="first_fit_offer_packing" data-type="example">
<h5><span class="label">Example 4-10. </span>First-fit offer packing</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">TaskInfo</code><code class="o">&gt;</code><code> </code><code class="nf">doFirstFit</code><code class="o">(</code><code class="n">Offer</code><code> </code><code class="n">offer</code><code class="o">,</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Job</code><code class="o">&gt;</code><code> </code><code class="n">jobs</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="n">List</code><code class="o">&lt;</code><code class="n">TaskInfo</code><code class="o">&gt;</code><code> </code><code class="n">toLaunch</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ArrayList</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Job</code><code class="o">&gt;</code><code> </code><code class="n">launchedJobs</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ArrayList</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="kt">double</code><code> </code><code class="n">offerCpus</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO5-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO5-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>    </code><code class="kt">double</code><code> </code><code class="n">offerMem</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="o">;</code><code>
</code><code>    </code><code class="c1">// We always need to extract the resource info from the offer.
</code><code>    </code><code class="c1">// It's a bit annoying in every language.
</code><code>    </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Resource</code><code> </code><code class="n">r</code><code> </code><code class="o">:</code><code> </code><code class="n">offer</code><code class="o">.</code><code class="na">getResourcesList</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO5-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO5-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">r</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="s">"cpus"</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">offerCpus</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">r</code><code class="o">.</code><code class="na">getScalar</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getValue</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code> </code><code class="k">else</code><code> </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">r</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="s">"mem"</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">offerMem</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">r</code><code class="o">.</code><code class="na">getScalar</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getValue</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>    </code><code class="c1">// Now, we will pack jobs into the offer
</code><code>    </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Job</code><code> </code><code class="n">j</code><code> </code><code class="o">:</code><code> </code><code class="n">jobs</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="kt">double</code><code> </code><code class="n">jobCpus</code><code> </code><code class="o">=</code><code> </code><code class="n">j</code><code class="o">.</code><code class="na">getCpus</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="kt">double</code><code> </code><code class="n">jobMem</code><code> </code><code class="o">=</code><code> </code><code class="n">j</code><code class="o">.</code><code class="na">getMem</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">jobCpus</code><code> </code><code class="o">&lt;</code><code class="o">=</code><code> </code><code class="n">offerCpus</code><code> </code><code class="o">&amp;</code><code class="o">&amp;</code><code> </code><code class="n">jobMem</code><code> </code><code class="o">&lt;</code><code class="o">=</code><code> </code><code class="n">offerMem</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO5-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO5-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>            </code><code class="n">offerCpus</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">jobCpus</code><code class="o">;</code><code>
</code><code>            </code><code class="n">offerMem</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">jobMem</code><code class="o">;</code><code>
</code><code>            </code><code class="n">toLaunch</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">j</code><code class="o">.</code><code class="na">makeTask</code><code class="o">(</code><code class="n">offer</code><code class="o">.</code><code class="na">getSlaveId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="n">j</code><code class="o">.</code><code class="na">setSubmitted</code><code class="o">(</code><code class="kc">true</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="n">launchedJobs</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">j</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO5-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO5-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Job</code><code> </code><code class="n">j</code><code> </code><code class="o">:</code><code> </code><code class="n">launchedJobs</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">j</code><code class="o">.</code><code class="na">launch</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO5-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO5-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>    </code><code class="n">jobs</code><code class="o">.</code><code class="na">removeAll</code><code class="o">(</code><code class="n">launchedJobs</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">toLaunch</code><code class="o">;</code><code>
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO5-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO5-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>We’ll keep track of how many resources are remaining in the offer in these variables.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO5-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO5-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>You must iterate over all the resources in the offer to find the ones whose names match the type of resource you care about, and only then can you extract the value. The reason this cannot be a map is that you can receive multiple resources of the same name; for example, you could receive both reserved and unreserved memory resources from a slave.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO5-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO5-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>Here, we check to see if the offer still has enough resources remaining to launch our task. If it does, we’ll deduct those resources from our method’s internal count, add the <code>TaskInfo</code> to the list of tasks we will launch, and mark the job as submitted.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO5-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO5-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>In order to support <code>doFirstFit</code> semantics, we add all jobs we’ll launch to a list, so that we can remove all those elements from the original list of all pending jobs.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO5-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO5-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p><code>Job</code> has methods that help us track its instances’ progress through their state machine. We’ll go over this in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#expanded_job_listing">Example&nbsp;4-11</a>.</p></dd>
</dl>

<p>First fit is usually the best algorithm to use when matching tasks to offers.
You might think that this won’t always utilize offers as efficiently as if you put more work into trying to optimize matching the offers.
That’s absolutely true, but consider the following:
a cluster either has sufficient or insufficient resources for launching every pending task.
If there are plenty of resources, then first fit should always be able to launch every task.
If, on the other hand, there are not enough resources, nothing would be able to launch every task. Thus, it’s a good idea to write code to choose which task to run next, so that you can maintain the target <a data-type="indexterm" data-primary="doFirstFit" data-startref="dff4" id="idp12154224"></a><a data-type="indexterm" data-primary="first fit" data-startref="ff4" id="idp12155200"></a>quality of service.
Only if there are just barely enough resources does more sophisticated packing begin to make sense.
Unfortunately for us, this problem—known more generally as <a data-type="indexterm" data-primary="knapsack problem" id="idp12156464"></a>the <em>knapsack problem</em>—is a notorious NP-complete problem.
NP-complete problems are those problems for which it can be proved that an optimal solution will take an extremely long time to find, and there’s not a clever trick in existence to solve the problem faster.<sup><a data-type="noteref" id="idp12148944-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12148944" class="totri-footnote">3</a></sup></p>

<p>Actually, the situation isn’t so bad.
In fact, although it’s impossible to solve the packing problem <em>perfectly</em> and quickly, there are several techniques that give “good enough” results and aren’t too tricky to implement.
For some frameworks, all tasks will be bottlenecked on a single resource: either CPUs (for compute-bound workloads, like data analysis) or memory (i.e., caches like memcached or Redis).
As a result, when we try to pack our resources, we can simplify the packing problem to a single dimension: the most constrained dimension.
Once we’ve done this, we can use techniques such as the fully polynomial time greedy approximation scheme for the 0/1 knapsack problem.<sup><a data-type="noteref" id="idp12151712-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12151712" class="totri-footnote">4</a></sup></p>








<section data-type="sect2" data-pdf-bookmark="Bridging the Semantic Gap Between Offers and Jobs"><div class="sect2" id="idp12075968">
<h2>Bridging the Semantic Gap Between Offers and Jobs</h2>

<p>Now, we’ve got a pretty cool framework.
It takes a JSON configuration file filled with the jobs we want to run, and it submits those jobs to the Mesos cluster efficiently.
We have a problem, though—what if a job fails?
At the moment, we’ll just see a bit of output in the terminal indicating that the task failed, succeeded, or was lost.
We want to add support for retries: when a job fails, we’ll resubmit it in the hope that it will succeed this time.
Eventually, however, we’ll give up and consider it truly failed.
To this end, we’re going to expand our <code>Job</code> class so that instead of simply having a Boolean property <code>submitted</code>, it will <a data-type="indexterm" data-primary="job states" id="js4"></a>have a <code>JobState</code>:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kd">enum</code> <code class="n">JobState</code> <code class="o">{</code>
    <code class="n">PENDING</code><code class="o">,</code>
    <code class="n">STAGING</code><code class="o">,</code>
    <code class="n">RUNNING</code><code class="o">,</code>
    <code class="n">SUCCESSFUL</code><code class="o">,</code>
    <code class="n">FAILED</code>
<code class="o">}</code></pre>

<p>We need to increase the number of states a job can be in in order to support retries.
Before, we would simply launch unsubmitted jobs.
Now, we’ll need to track the exact part of the task lifecycle a job is in, and resubmit it only if it has already failed.
<a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#valid_transitions_of_jobstate">Figure&nbsp;4-4</a> illustrates the valid state transitions.</p>

<figure><div id="valid_transitions_of_jobstate" class="figure">
<img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/baom_0404.png" alt="Valid Transitions of JobState" width="1245" height="348" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/baom_0404.png">
<h6><span class="label">Figure 4-4. </span>Valid transitions of JobState</h6>
</div></figure>

<p>We’ll also have to expand the <code>Job</code> class to internally keep track of retries and the job’s state. <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#expanded_job_listing">Example&nbsp;4-11</a> shows the new methods that will implement the preceding state transition diagram.</p>
<div id="expanded_job_listing" data-type="example">
<h5><span class="label">Example 4-11. </span>State transition methods for Job</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Job</code> <code class="o">{</code>
    <code class="c1">// previous fields elided</code>
    <code class="kd">private</code> <code class="kt">int</code> <code class="n">retries</code><code class="o">;</code>

    <code class="kd">private</code> <code class="nf">Job</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">status</code> <code class="o">=</code> <code class="n">JobState</code><code class="o">.</code><code class="na">PENDING</code><code class="o">;</code>
        <code class="n">id</code> <code class="o">=</code> <code class="n">UUID</code><code class="o">.</code><code class="na">randomUUID</code><code class="o">().</code><code class="na">toString</code><code class="o">();</code>
        <code class="n">retries</code> <code class="o">=</code> <code class="mi">3</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">launch</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">status</code> <code class="o">=</code> <code class="n">JobState</code><code class="o">.</code><code class="na">STAGING</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">started</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">status</code> <code class="o">=</code> <code class="n">JobState</code><code class="o">.</code><code class="na">RUNNING</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">succeed</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">status</code> <code class="o">=</code> <code class="n">JobState</code><code class="o">.</code><code class="na">SUCCESSFUL</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">fail</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">if</code> <code class="o">(</code><code class="n">retries</code> <code class="o">==</code> <code class="mi">0</code><code class="o">)</code> <code class="o">{</code>
            <code class="n">status</code> <code class="o">=</code> <code class="n">JobState</code><code class="o">.</code><code class="na">FAILED</code><code class="o">;</code>
        <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>
            <code class="n">retries</code><code class="o">--;</code>
            <code class="n">status</code> <code class="o">=</code> <code class="n">JobState</code><code class="o">.</code><code class="na">PENDING</code><code class="o">;</code>
        <code class="o">}</code>
    <code class="o">}</code>
<code class="o">}</code></pre></div>

<p>We’ve decided to give every job three retries.
To simplify the implementation of the state changes of the job, we have four functions to move between states: <code>launch()</code>, <code>started()</code>, <code>succeed()</code>, and <code>fail()</code>.
These functions will be called, respectively, when we submit the task to Mesos, when it starts, and when it succeeds or fails. <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#enhanced_statusupdate_handler">Example&nbsp;4-12</a> shows how we move between states.</p>
<div data-type="example" id="enhanced_statusupdate_handler">
<h5><span class="label">Example 4-12. </span>Enhanced statusUpdate handler</h5>
<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">statusUpdate</code><code class="o">(</code><code class="n">SchedulerDriver</code><code> </code><code class="n">driver</code><code class="o">,</code><code> </code><code class="n">TaskStatus</code><code> </code><code class="n">status</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kd">synchronized</code><code> </code><code class="o">(</code><code class="n">jobs</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="c1">// We'll see if we can find a job this corresponds to
</code><code>        </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Job</code><code> </code><code class="n">j</code><code> </code><code class="o">:</code><code> </code><code class="n">jobs</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-1d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-1d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">j</code><code class="o">.</code><code class="na">getId</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">status</code><code class="o">.</code><code class="na">getTaskId</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getValue</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-1d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>                </code><code class="k">switch</code><code> </code><code class="o">(</code><code class="n">status</code><code class="o">.</code><code class="na">getState</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>                    </code><code class="k">case</code><code> </code><code class="nl">TASK_RUNNING:</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-2d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-2d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>                        </code><code class="n">j</code><code class="o">.</code><code class="na">started</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                        </code><code class="k">break</code><code class="o">;</code><code>
</code><code>                    </code><code class="k">case</code><code> </code><code class="nl">TASK_FINISHED:</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-3d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-3d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>                        </code><code class="n">j</code><code class="o">.</code><code class="na">succeed</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                        </code><code class="k">break</code><code class="o">;</code><code>
</code><code>                    </code><code class="k">case</code><code> </code><code class="nl">TASK_FAILED:</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-4d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-4d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>                    </code><code class="k">case</code><code> </code><code class="nl">TASK_KILLED:</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-5d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-5d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code>
</code><code>                    </code><code class="k">case</code><code> </code><code class="nl">TASK_LOST:</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-6d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-6d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a><code>
</code><code>                    </code><code class="k">case</code><code> </code><code class="nl">TASK_ERROR:</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-7d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-7d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/7.png" alt="7" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/7.png"></a><code>
</code><code>                        </code><code class="n">j</code><code class="o">.</code><code class="na">fail</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                        </code><code class="k">break</code><code class="o">;</code><code>
</code><code>                    </code><code class="k">default</code><code class="o">:</code><code>
</code><code>                        </code><code class="k">break</code><code class="o">;</code><code>
</code><code>                </code><code class="o">}</code><code>
</code><code>            </code><code class="o">}</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-1d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-1d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>Typically, one should store a mapping between the <code>TaskID</code> and the <code>Job</code>, rather than doing a linear search.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-2d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-2d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>This <a contenteditable="false" data-type="indexterm" data-primary="tasks" data-secondary="statuses" id="idp12808560"></a>task status, <em>running</em>, means that we’ve received confirmation that the task was successfully started by the slave.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-3d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-3d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>A <em>finished</em> task is one that completed without reporting any kind of error.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-4d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-4d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p><em>Failed</em> tasks are those that did not complete successfully, and whose termination was initiated through a normal codepath by the task itself. For example, if a task that is supposed to download a file wasn’t able to do so, it should report its status as failed.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-5d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-5d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p><em>Killed</em> tasks are those that did not complete successfully because the scheduler told them to stop. When a scheduler performs preemption or allows a user to request the early termination of a task, that task should report the status killed.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-6d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-6d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a></dt>
<dd><p>When a task is <em>lost</em>, that means that an unexpected error occurred. That could be due to the slave unexpectedly going offline, or an executor that exited before it sent a <code>TASK_FINISHED</code>, <code>TASK_KILLED</code>, or <code>TASK_KILLED</code> message.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-7d" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-7d"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/7.png" alt="7" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/7.png"></a></dt>
<dd><p>This is a very rare case, indicating a problem with the task descriptor itself. You can look in the <code>TaskStatus</code>’s <code>message</code> field for <a contenteditable="false" data-type="indexterm" data-primary="tasks" data-secondary="matching to offers" data-startref="t4mto" id="idp12839248"></a><a contenteditable="false" data-type="indexterm" data-primary="schedulers" data-secondary="matching tasks to offers" data-startref="s4mtto" id="idp12840704"></a><a contenteditable="false" data-type="indexterm" data-primary="offers" data-secondary="assigning tasks to" data-startref="o4att" id="idp12842160"></a>details.</p></dd>
</dl>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Adding High Availability"><div class="sect1" id="scheduler_ha">
<h1>Adding High Availability</h1>

<p>At <a data-type="indexterm" data-primary="job states" data-startref="js4" id="idp12845952"></a><a data-type="indexterm" data-primary="schedulers" data-secondary="adding high availability" id="s4aha"></a><a data-type="indexterm" data-primary="high availability" id="ha4"></a>this point, our scheduler-only framework is nearly feature-complete.
We are loading jobs from configuration files, launching them on Mesos, and automatically restarting them when they fail.
Now it’s time to add the final feature: high availability.</p>

<p>High availability means that when the scheduler process fails, the framework as a whole continues to run.
This is accomplished via the cooperation of three subfeatures:</p>
<ol>
<li>
<p>The scheduler will use leader election so that we can run multiple instances and have a fallback instance automatically take over when the current leader fails.</p>
</li>
<li>
<p>The scheduler must synchronize its state to shared, distributed storage, so that the newly elected leader can pick up where the last one left off.</p>
</li>
<li>
<p>The scheduler must opt into a few Mesos features that will ensure that running tasks are unaffected by scheduler failure.</p>
</li>

</ol>

<p>For this example, we’re going to use <a data-type="indexterm" data-primary="ZooKeeper" id="idp12853376"></a>ZooKeeper to provide our leader election and distributed storage, since Mesos clusters usually<sup><a data-type="noteref" id="idp12854224-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12854224" class="totri-footnote">5</a></sup> come with a ZooKeeper cluster.
Furthermore, we’re going to use <a data-type="indexterm" data-primary="Apache Curator" id="idp12855600"></a><a data-type="indexterm" data-primary="Curator" id="idp12856208"></a>the <a href="http://curator.apache.org/">Apache Curator</a> library to interact with ZooKeeper, since it handles many of the challenges of the included ZooKeeper API.<sup><a data-type="noteref" id="idp12857696-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12857696" class="totri-footnote">6</a></sup> Since this isn’t meant to be a production-quality framework, we’ll hardcode all our framework’s data to reside under the <code>/sampleframework</code> path in ZooKeeper.
For production-quality frameworks, you should make the location of all data configurable in ZooKeeper. <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#simple_leader_election">Example&nbsp;4-13</a> shows how we add basic <a data-type="indexterm" data-primary="leader election" id="le4"></a>leader election to our <code>main</code> function.</p>
<div id="simple_leader_election" data-type="example">
<h5><span class="label">Example 4-13. </span>Simple leader election</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="kt">void</code><code> </code><code class="nf">main</code><code class="o">(</code><code class="n">String</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code> </code><code class="n">args</code><code class="o">)</code><code> </code><code class="kd">throws</code><code> </code><code class="n">Exception</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="n">CuratorFramework</code><code> </code><code class="n">curator</code><code> </code><code class="o">=</code><code> </code><code class="n">CuratorFrameworkFactory</code><code class="o">.</code><code class="na">newClient</code><code class="o">(</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>            </code><code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="o">,</code><code>
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">RetryOneTime</code><code class="o">(</code><code class="mi">1000</code><code class="o">)</code><code>
</code><code>    </code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">curator</code><code class="o">.</code><code class="na">start</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>
</code><code>    </code><code class="n">LeaderLatch</code><code> </code><code class="n">leaderLatch</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">LeaderLatch</code><code class="o">(</code><code class="n">curator</code><code class="o">,</code><code> </code><code class="s">"/sampleframework/leader"</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>    </code><code class="n">leaderLatch</code><code class="o">.</code><code class="na">start</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>    </code><code class="n">leaderLatch</code><code class="o">.</code><code class="na">await</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO6-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO6-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code>
</code><code>
</code><code>    </code><code class="c1">// The previous main implementation goes here
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>Here, <a data-type="indexterm" data-primary="LeaderLatch" id="ll4"></a>we see how to create a new instance of Curator. It takes the address of the ZooKeeper cluster and a <code>RetryPolicy</code> as arguments. While we are using the <code>RetryOneTime</code> policy in this book, this is probably not the right choice for <span class="keep-together">production</span> frameworks. Instead, the <code>ExponentialBackoffRetry</code> or <code>BoundedExponentialBackoffRetry</code> policies are more robust choices.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>Note that you must explicitly <code>start()</code> the Curator framework.<sup><a data-type="noteref" id="idp12964608-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12964608" class="totri-footnote">7</a></sup></p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>Next, we create a <code>LeaderLatch</code> for our framework, which we’ll put under the ZooKeeper path we chose for our framework, <code>/sampleframework</code>.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>Never forget to <code>start()</code> Curator components—this is the #1 pitfall.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO6-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO6-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p>The <code>await()</code> method on a started <code>LeaderLatch</code> will not return until we are the leader.</p></dd>
</dl>
<div data-type="warning" epub:type="warning" id="leader_latch_selector"><h1>LeaderLatch Is Nice, but LeaderSelector Is Better</h1>
<p>A <code>LeaderLatch</code> is a very easy way to add leader election to an application.
You simply call <code>await()</code>, and when it returns, you’re the leader!
Unfortunately, if you do this, your application will not always behave correctly.
Leaders can be deposed not only when they crash, but also when they are disconnected from the network.
As a result, a properly implemented user of leader election needs to be constantly checking whether it’s still the leader, and then recreating the leader latch after it’s deposed.
A better option for building robust leader election is <code>LeaderSelector</code>, another class in Curator.
<code>LeaderSelector</code> <a data-type="indexterm" data-primary="LeaderSelector" id="idp13012640"></a>has a listener-based API that notifies you whenever you become the leader or lose leadership.
This book doesn’t use <code>LeaderSelector</code> because it requires substantially more scaffolding code to <a data-type="indexterm" data-primary="LeaderLatch" data-startref="ll4" id="idp13013888"></a><a data-type="indexterm" data-primary="leader election" data-startref="le4" id="idp13014736"></a>use.</p>
</div>

<p>Unfortunately, it’s not enough to simply allow multiple instances of our framework to elect a leader from amongst themselves.
Our goal is to have the new leader actually become the same framework as before.
To do this, we’ll need to inform Mesos that our scheduler supports failover.
In addition, when the new leader registers, it needs to tell Mesos that it’s the new scheduler for our framework.
In Mesos, schedulers are identified by <a data-type="indexterm" data-primary="FrameworkID" id="fid4"></a>their <code>FrameworkID</code>, an optional value in <a data-type="indexterm" data-primary="FrameWorkInfo" id="idp13018144"></a>the <code>FrameworkInfo</code>.
The <code>FrameworkID</code> must be assigned by Mesos in order to ensure it remains unique for each framework.
Now, we’ll need to actually store the <code>FrameworkID</code> when it’s assigned, so that future leaders can reuse it.</p>

<p>We’re going to store the <code>FrameworkID</code> in the ZooKeeper node <code>id</code> under our <code>/sampleframework</code> path.
When we start up, we’ll first check to see if there’s already a saved <code>FrameworkID</code>; if so, we’ll start up using that.
Otherwise, we’ll operate as before, and allow the Mesos master to assign a <code>FrameworkID</code> (see <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#using_stored_fid">Example&nbsp;4-14</a>).
In addition, we will store whatever <code>FrameworkID</code> Mesos informs us we registered with, so that future leaders can reuse that ID.
We can store that <code>FrameworkID</code> unconditionally, since it will never change after the first assignment, and thus is idempotent.<sup><a data-type="noteref" id="idp13024432-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp13024432" class="totri-footnote">8</a></sup></p>
<div id="using_stored_fid" data-type="example">
<h5><span class="label">Example 4-14. </span>Using a stored FrameworkID with FrameworkInfo</h5>

<pre data-type="programlisting" data-code-language="java"><code class="n">FrameworkInfo</code><code class="o">.</code><code class="na">Builder</code><code> </code><code class="n">frameworkInfoBuilder</code><code> </code><code class="o">=</code><code> </code><code class="n">FrameworkInfo</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>    </code><code class="o">.</code><code class="na">setUser</code><code class="o">(</code><code class="s">""</code><code class="o">)</code><code>
</code><code>    </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"Useless Remote BASH"</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO7-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO7-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>
</code><code class="k">try</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kt">byte</code><code class="o">[</code><code class="o">]</code><code> </code><code class="n">curatorData</code><code> </code><code class="o">=</code><code> </code><code class="n">curator</code><code class="o">.</code><code class="na">getData</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">forPath</code><code class="o">(</code><code class="s">"/sampleframework/id"</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO7-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO7-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>    </code><code class="n">frameworkInfoBuilder</code><code class="o">.</code><code class="na">setId</code><code class="o">(</code><code class="k">new</code><code> </code><code class="n">String</code><code class="o">(</code><code class="n">curatorData</code><code class="o">,</code><code> </code><code class="s">"UTF-8"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code><code> </code><code class="k">catch</code><code> </code><code class="o">(</code><code class="n">KeeperException</code><code class="o">.</code><code class="na">NoNodeException</code><code> </code><code class="n">e</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="c1">// Don't set the FrameworkID </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO7-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO7-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code class="c1">
</code><code class="o">}</code><code>
</code><code>
</code><code class="n">FrameworkInfo</code><code> </code><code class="n">frameworkInfo</code><code> </code><code class="o">=</code><code> </code><code class="n">frameworkInfoBuilder</code><code>
</code><code>    </code><code class="o">.</code><code class="na">setFailoverTimeout</code><code class="o">(</code><code class="mi">60</code><code class="o">*</code><code class="mi">60</code><code class="o">*</code><code class="mi">24</code><code class="o">*</code><code class="mi">7</code><code class="o">)</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO7-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO7-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>    </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO7-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO7-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>We start with our builder, the same as usual.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO7-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO7-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>We attempt to fetch the stored <code>FrameworkID</code>. If this node doesn’t exist in ZooKeeper, we throw a <code>KeeperException.NoNodeException</code>.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO7-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO7-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>If there wasn’t a stored <code>FrameworkID</code>, we allow Mesos to assign it.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO7-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO7-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>We must configure the framework to have a failover timeout, in seconds. In this case, we allow failover to happen for up to a week. This means we’ve got a week to reconnect a new scheduler for this framework after shutting down the previous scheduler. This timeout should be set to help you survive a worst-case scenario when you need enough time to recover the system after a catastrophe. After this timeout, requests to register with the old <code>FrameworkID</code> will be met with an error about registering a finished framework, and all tasks that were running under that framework will be killed.</p></dd>
</dl>

<p>Now, we need to update our <code>registered</code> scheduler callback to store the <code>FrameworkID</code>. The new version is shown in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#storing_the_fid">Example&nbsp;4-15</a>.</p>
<div id="storing_the_fid" data-type="example">
<h5><span class="label">Example 4-15. </span>Storing the FrameworkID</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">registered</code><code class="o">(</code><code class="n">SchedulerDriver</code><code> </code><code class="n">driver</code><code class="o">,</code><code> </code><code class="n">FrameworkID</code><code> </code><code class="n">frameworkId</code><code class="o">,</code><code>
</code><code>                                 </code><code class="n">MasterInfo</code><code> </code><code class="n">masterInfo</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Registered with framework id "</code><code> </code><code class="o">+</code><code> </code><code class="n">frameworkId</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="k">try</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">curator</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">creatingParentsIfNeeded</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">forPath</code><code class="o">(</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO8-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO8-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>            </code><code class="s">"/sampleframework/id"</code><code class="o">,</code><code>
</code><code>            </code><code class="n">frameworkId</code><code class="o">.</code><code class="na">getBytes</code><code class="o">(</code><code class="o">)</code><code>
</code><code>        </code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code> </code><code class="k">catch</code><code> </code><code class="o">(</code><code class="n">KeeperException</code><code class="o">.</code><code class="na">NodeExistsException</code><code> </code><code class="n">e</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="c1">// Do nothing </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO8-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO8-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code class="c1">
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO8-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO8-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>We attempt to store the data of the <code>FrameworkID</code> to the predetermined location.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO8-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO8-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>If we catch this exception, it means that we’ve already created the node <code>/sampleframework/id</code>. In this case, we’ll assume that means an earlier leader scheduler already stored the ID, so we’ll do nothing. If you’re using a different store than ZooKeeper, it may be more convenient to simply unconditionally store the ID every time, since it will never change.</p></dd>
</dl>

<p>Now, we’ve finally got a highly available framework with failover working.
Or at least, we would if the framework had any way to also synchronize its state with regard to which jobs are running.
To do this, we’ll need to add support for serializing and deserializing jobs from ZooKeeper.
We’ll store each job in ZooKeeper at <code>/sampleframework/jobs/$jobid</code>, where <code>$jobid</code> is the <code>id</code> field of the job.
Serialization can be trivially <a data-type="indexterm" data-primary="FrameworkID" data-startref="fid4" id="idp13217040"></a>implemented via JSON.</p>

<p>Now that our framework is highly available, we don’t want to always have to provide the set of jobs it should run.
In fact, we’d like to have our framework automatically pick up the monitoring of all previously provided jobs on the command line, and also optionally launch new jobs provided on the command line.
To do this, we’ll load jobs both from the command line (if provided) and from <a data-type="indexterm" data-primary="ZooKeeper" id="idp13215024"></a>ZooKeeper, as <a data-type="indexterm" data-primary="job data, loading" id="jdl4"></a>shown in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#loading_job_data">Example&nbsp;4-16</a>.</p>
<div id="loading_job_data" data-type="example">
<h5><span class="label">Example 4-16. </span>Loading job data</h5>

<pre data-type="programlisting" data-code-language="java"><code class="n">List</code><code class="o">&lt;</code><code class="n">Job</code><code class="o">&gt;</code><code> </code><code class="n">jobs</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ArrayList</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO9-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO9-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">args</code><code class="o">.</code><code class="na">length</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">1</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO9-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO9-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>    </code><code class="kt">byte</code><code class="o">[</code><code class="o">]</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">Files</code><code class="o">.</code><code class="na">readAllBytes</code><code class="o">(</code><code class="n">Paths</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">args</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">JSONObject</code><code> </code><code class="n">config</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">JSONObject</code><code class="o">(</code><code class="k">new</code><code> </code><code class="n">String</code><code class="o">(</code><code class="n">data</code><code class="o">,</code><code> </code><code class="s">"UTF-8"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">JSONArray</code><code> </code><code class="n">jobsArray</code><code> </code><code class="o">=</code><code> </code><code class="n">config</code><code class="o">.</code><code class="na">getJSONArray</code><code class="o">(</code><code class="s">"jobs"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="o">(</code><code class="kt">int</code><code> </code><code class="n">i</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="o">;</code><code> </code><code class="n">i</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">jobsArray</code><code class="o">.</code><code class="na">length</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><code class="n">i</code><code class="o">+</code><code class="o">+</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">jobs</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">Job</code><code class="o">.</code><code class="na">fromJSON</code><code class="o">(</code><code class="n">jobsArray</code><code class="o">.</code><code class="na">getJSONObject</code><code class="o">(</code><code class="n">i</code><code class="o">)</code><code class="o">,</code><code> </code><code class="n">curator</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>    </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Loaded jobs from file"</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code><code>
</code><code>
</code><code class="c1">//Load jobs from ZK
</code><code class="k">try</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">id</code><code> </code><code class="o">:</code><code> </code><code class="n">curator</code><code class="o">.</code><code class="na">getChildren</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">forPath</code><code class="o">(</code><code class="s">"/sampleframework/jobs"</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO9-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO9-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>        </code><code class="kt">byte</code><code class="o">[</code><code class="o">]</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">curator</code><code class="o">.</code><code class="na">getData</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                             </code><code class="o">.</code><code class="na">forPath</code><code class="o">(</code><code class="s">"/sampleframework/jobs/"</code><code> </code><code class="o">+</code><code> </code><code class="n">id</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO9-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO9-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>        </code><code class="n">JSONObject</code><code> </code><code class="n">jobJSON</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">JSONObject</code><code class="o">(</code><code class="k">new</code><code> </code><code class="n">String</code><code class="o">(</code><code class="n">data</code><code class="o">,</code><code> </code><code class="s">"UTF-8"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">Job</code><code> </code><code class="n">job</code><code> </code><code class="o">=</code><code> </code><code class="n">Job</code><code class="o">.</code><code class="na">fromJSON</code><code class="o">(</code><code class="n">jobJSON</code><code class="o">,</code><code> </code><code class="n">curator</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO9-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO9-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code>
</code><code>        </code><code class="n">jobs</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">job</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>    </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Loaded jobs from ZK"</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code><code> </code><code class="k">catch</code><code> </code><code class="o">(</code><code class="n">Exception</code><code> </code><code class="n">e</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="c1">// Sample code isn't production ready </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO9-6" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO9-6"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a><code class="c1">
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO9-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO9-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>We start by creating the <code>List</code> we’ll store all the <code>Job</code>s in.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO9-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO9-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>We only run the original job loading code if a filename was passed on the command line.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO9-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO9-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>The <code>getChildren()</code> method in Curator allows us to get the names of all the child nodes of a path. These child nodes are saved after most state-changing methods, such as <code>launch()</code>, <code>started()</code>, and <code>succeed()</code>.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO9-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO9-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>For each job, we’ll fetch the serialized JSON representation from ZooKeeper.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO9-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO9-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p>At this point, we can use the original JSON processing code to deserialize the <code>Job</code>. Note that we must provide every <code>Job</code> with a reference to the Curator now, since the <code>Job</code>s must serialize themselves.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO9-6" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO9-6"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a></dt>
<dd><p>In real production code, you should probably handle exceptions.</p></dd>
</dl>

<p>We’ll also need to enhance our <code>Job</code>s to be able to save their state, as shown <a data-type="indexterm" data-primary="job data, loading" data-startref="jdl4" id="idp13739040"></a><a data-type="indexterm" data-primary="job serialization" id="jobser4"></a>in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#job_listing_with_save">Example&nbsp;4-17</a>.</p>
<div id="job_listing_with_save" data-type="example">
<h5><span class="label">Example 4-17. </span>Job serialization</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">Job</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="c1">// Previously defined fields elided
</code><code>    </code><code class="kd">private</code><code> </code><code class="n">String</code><code> </code><code class="n">id</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO10-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO10-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="kt">void</code><code> </code><code class="nf">saveState</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO10-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO10-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>        </code><code class="n">JSONObject</code><code> </code><code class="n">obj</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">JSONObject</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">obj</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"id"</code><code class="o">,</code><code> </code><code class="n">id</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO10-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO10-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>        </code><code class="n">obj</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"status"</code><code class="o">,</code><code> </code><code class="o">(</code><code class="n">status</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="n">JobState</code><code class="o">.</code><code class="na">STAGING</code><code> </code><code class="o">?</code><code>
</code><code>            </code><code class="n">JobState</code><code class="o">.</code><code class="na">RUNNING</code><code> </code><code class="o">:</code><code> </code><code class="n">status</code><code class="o">)</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO10-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO10-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>        </code><code class="c1">// Storing other fields omitted for brevity
</code><code>        </code><code class="kt">byte</code><code class="o">[</code><code class="o">]</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">obj</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getBytes</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="k">try</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO10-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO10-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code>
</code><code>            </code><code class="n">curator</code><code class="o">.</code><code class="na">setData</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">forPath</code><code class="o">(</code><code class="s">"/sampleframework/jobs/"</code><code> </code><code class="o">+</code><code> </code><code class="n">id</code><code class="o">,</code><code> </code><code class="n">data</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code> </code><code class="k">catch</code><code> </code><code class="o">(</code><code class="n">KeeperException</code><code class="o">.</code><code class="na">NoNodeException</code><code> </code><code class="n">e</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">curator</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                   </code><code class="o">.</code><code class="na">creatingParentsIfNeeded</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                   </code><code class="o">.</code><code class="na">forPath</code><code class="o">(</code><code class="s">"/sampleframework/jobs/"</code><code> </code><code class="o">+</code><code> </code><code class="n">id</code><code class="o">,</code><code> </code><code class="n">data</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>
</code><code>
</code><code>
</code><code>
</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">launch</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="c1">// ... previous code omitted ...
</code><code>        </code><code class="n">saveState</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO10-6" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO10-6"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="c1">// started(), succeed(), fail() are modified as above
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO10-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO10-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>We need to include an identifier for each job, so that they can be looked up by a primary key in the database we sync them to.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO10-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO10-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>We’ve added a method to save the state of the <code>Job</code> to an external store. In this case, we’re storing the JSON-formatted data to ZooKeeper.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO10-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO10-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>We need to make sure to store all the fields to the database.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO10-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO10-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>We always store jobs that are in <code>STAGING</code> as if they were running. Since we can’t be sure whether a job in the <code>STAGING</code> state has launched successfully, we’ll assume it succeeded during a failover, so that we’ll either get a new <code>statusUpdate</code> if it finished in the meantime or a <code>TASK_LOST</code> after reconciliation.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO10-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO10-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p>Curator’s API requires a different method to create a new ZooKeeper node and update its data.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO10-6" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO10-6"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a></dt>
<dd><p>We need to make sure to save the <code>Job</code>’s state after every status update. Note that the addition of <code>saveState()</code> to the last line of <code>started()</code>, <code>succeed()</code>, and <code>fail()</code> is omitted in this code, but this must be done for a <a data-type="indexterm" data-primary="schedulers" data-secondary="adding high availability" data-startref="s4aha" id="idp13705792"></a><a data-type="indexterm" data-primary="high availability" data-startref="ha4" id="idp13707008"></a>working framework.</p></dd>
</dl>

<p>And there you have it!
Our job scheduler is now able to automatically fail over to waiting hot spares without impacting the running jobs or losing track of them—well, <a data-type="indexterm" data-primary="job serialization" data-startref="jobser4" id="idp13383456"></a>almost.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Adding Reconciliation"><div class="sect1" id="idp12844656">
<h1>Adding Reconciliation</h1>

<p>It <a data-type="indexterm" data-primary="schedulers" data-secondary="adding reconciliation" id="s4ar"></a><a data-type="indexterm" data-primary="reconciliation" id="r4"></a>turns out that there are still situations in which things can fall out of synchronization: these cases are explained in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch06.html#reconciliation_concepts">“Reconciliation During Failover”</a>.
This is the final piece missing from our robust, highly available Mesos scheduler.
Luckily, it’s easy to add reconciliation to a scheduler.
When implementing the <code>statusUpdate()</code> callback, you are mapping the Mesos state events to your framework’s state machine model.
As long as this state machine never moves out of the terminal states (e.g., <code>TASK_LOST</code>, <code>TASK_FINISHED</code>, <code>TASK_KILLED</code>, etc.), reconciliation shouldn’t require additional work.
Typically, you’ll want to run reconciliation periodically; I usually just run it on startup and every 30 minutes thereafter.
Reconciliation is a sort of catchall for any message loss—it ensures that even if some unknown bug or hardware failure causes your framework to fall out of sync with the state of the Mesos cluster, you’ll eventually correct that issue.</p>

<p>To reconcile, we will just generate a list of running tasks, along with the ID of the slave that they’re running on (for an explanation of why, see <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch06.html#reconciliation_concepts">“Reconciliation During Failover”</a>).
Then, we’ll invoke <code>reconcileTasks()</code>.
Mesos will automatically send the responses to the <code>statusUpdate()</code> callback.
If you want to implement special handling of reconciliation-related status updates, you can check if the <code>reason</code> field of the status update is <code>TASK_RECONCILIATION</code>.
We don’t bother with that in our framework, because our framework’s task state machine is robust. <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#reconciliation_of_running_tasks">Example&nbsp;4-18</a> shows how to reconcile the running tasks.</p>
<div id="reconciliation_of_running_tasks" data-type="example">
<h5><span class="label">Example 4-18. </span>Reconciliation of running tasks</h5>

<pre data-type="programlisting" data-code-language="java"><code class="n">List</code><code class="o">&lt;</code><code class="n">TaskStatus</code><code class="o">&gt;</code><code> </code><code class="n">runningTasks</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ArrayList</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Job</code><code> </code><code class="n">job</code><code> </code><code class="o">:</code><code> </code><code class="n">jobs</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">job</code><code class="o">.</code><code class="na">getStatus</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="n">JobState</code><code class="o">.</code><code class="na">RUNNING</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">TaskID</code><code> </code><code class="n">id</code><code> </code><code class="o">=</code><code> </code><code class="n">TaskID</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">job</code><code class="o">.</code><code class="na">getId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">SlaveID</code><code> </code><code class="n">slaveId</code><code> </code><code class="o">=</code><code> </code><code class="n">SlaveID</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">setValue</code><code class="o">(</code><code class="n">job</code><code class="o">.</code><code class="na">getSlaveId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO11-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO11-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>        </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Reconciling the task "</code><code> </code><code class="o">+</code><code> </code><code class="n">job</code><code class="o">.</code><code class="na">getId</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">runningTasks</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">TaskStatus</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setSlaveId</code><code class="o">(</code><code class="n">slaveId</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setTaskId</code><code class="o">(</code><code class="n">id</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setState</code><code class="o">(</code><code class="n">TaskState</code><code class="o">.</code><code class="na">TASK_RUNNING</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code><code>
</code><code class="n">driver</code><code class="o">.</code><code class="na">reconcileTasks</code><code class="o">(</code><code class="n">runningTasks</code><code class="o">)</code><code class="o">;</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO11-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO11-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>Although we didn’t show the code for it, we must record the ID of the slave we believe each task is currently running on so that we can perform reconciliation.</p></dd>
</dl>

<p>At last, we have a complete implementation of a highly available Mesos scheduler that is robust to all kinds of failures: masters can crash, slaves can be disconnected from the network, and the scheduler itself can be killed and restarted.
In spite of any of those problems, the framework will endure, continually tracking, monitoring, and ensuring its tasks complete successfully.
We accomplished this through several means:</p>
<dl>
<dt>Jobs over tasks</dt>
<dd>
<p>We separated the notion of a job that we’d like to run from the Mesos task.
This allowed us to manage retries of a job, since the job’s success or failure wasn’t tied to a single attempt to run it.
This conceptual framework works equally well for long-running services: a service is a <em>goal</em> to run some number of instances of a program; a task is an instance, but it could fail and be replaced with another task.
If you’re interested in learning more about using goals to handle the reliability of scalable, distributed systems, this idea was pioneered by Joe Armstrong in his thesis on building reliable telephone systems.<sup><a data-type="noteref" id="idp14118880-marker" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp14118880" class="totri-footnote">9</a></sup></p>
</dd>
<dt>Persistent framework identity</dt>
<dd>
<p>We enabled different schedulers to automatically fail over by storing the identity of our framework: <a data-type="indexterm" data-primary="FrameworkID" id="idp13673280"></a>the <code>FrameworkID</code>.
This is the one part of framework management that we must do out-of-band from Mesos, since it must be propagated in spite of failures even within Mesos itself.</p>
</dd>
<dt>Shared job state</dt>
<dd>
<p>Whenever we received updates about the state of a job, we synchronized those updates with our distributed store of choice, ZooKeeper.
This ensured that newly elected leader schedulers would have the best possible information about the state of the cluster.</p>
</dd>
<dt>Retries for jobs</dt>
<dd>
<p>Sometimes, a Mesos slave machine just doesn’t work: perhaps it was misconfigured, or perhaps another task running on that slave is affecting its neighbors through a type of resource that Mesos can’t isolate.
To defend against these cases, we should always retry our actions.
However, usually we also want to give up if a job keeps failing, since that may indicate a problem with the job itself.</p>
</dd>
<dt>Reconciliation</dt>
<dd>
<p>Ultimately, things will go wrong that we didn’t predict.
In an attempt to handle these events (or at least eventually recover from them automatically), we used the Mesos reconciliation API to periodically attempt to clarify our state.
Although even reconciliation won’t handle every such issue, it is the best tool we have for handling unknown <a data-type="indexterm" data-primary="schedulers" data-secondary="adding reconciliation" data-startref="s4ar" id="idp13521296"></a><a data-type="indexterm" data-primary="reconciliation" data-startref="r4" id="idp13522432"></a>unknowns.</p>
</dd>
</dl>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Advanced Scheduler Techniques"><div class="sect1" id="idp13523888">
<h1>Advanced Scheduler Techniques</h1>

<p>Although<a data-type="indexterm" data-primary="schedulers" data-secondary="advanced techniques" id="s4at"></a> we’ve managed to implement a feature-complete, reliable scheduler, there are many other ways in which we could add features and robustness to our scheduler.
In this section, we’ll discuss further improvements that production-quality schedulers should consider implementing.</p>








<section data-type="sect2" data-pdf-bookmark="Distributed Communication"><div class="sect2" id="idp13354976">
<h2>Distributed Communication</h2>

<p>In our <a data-type="indexterm" data-primary="schedulers" data-secondary="distributed communication" id="s4atdc"></a><a data-type="indexterm" data-primary="distributed communication" id="dc4"></a>Useless Remote BASH, we only handled new jobs when a scheduler that had just become the leader was passed a file containing JSON job descriptors.
In real schedulers, we’ll want to be able to receive new jobs at any time.
Most commonly, work will be communicated to our scheduler via an HTTP API.</p>

<p>If you decide to allow your scheduler to receive work over HTTP, it’s better if both the leader and hot spare schedulers are all able to process HTTP requests.
This can be accomplished in several ways:</p>
<dl>
<dt>Shared database</dt>
<dd>
<p>In <a data-type="indexterm" data-primary="shared database design" id="idp14110656"></a>this design, the leader and hot spare schedulers all are able to read from and write to a shared database.
This way, they can all serve client requests.
Whenever a client modifies the database, however, we must ensure that the leading scheduler is notified.
Some databases support notifications; if your database doesn’t support this, the leading scheduler can frequently poll the database for updates so that it never lags too far behind the clients’ instructions.
The other solution for notifications is to use the leader election subsystem to identify the current leader, and then make a remote procedure call (RPC) to that leader so that it updates itself.</p>
</dd>
<dt>Redirect modification requests</dt>
<dd>
<p>HTTP <a data-type="indexterm" data-primary="redirection" id="idp14131776"></a>already supports redirection.
In this case, leader and hot spare schedulers can handle read-only requests, but requests that update the state of the framework can simply be redirected to the leading master with a 302 Found response.</p>
</dd>
<dt>The data is the truth</dt>
<dd>
<p>This <a data-type="indexterm" data-primary="data stores" id="idp13350288"></a>pattern is similar to the shared database pattern, but rather than providing an HTTP API, clients communicate directly with the data layer, and the scheduler is totally subservient to whatever data is in the data layer.
For instance, if you used Redis or RabbitMQ as your data layer, any client could add work to it, and the leading scheduler would periodically poll for new tasks it needs to launch and replicate all status updates to the data layer.</p>
</dd>
</dl>

<p>In practice, most framework authors reach for <a data-type="indexterm" data-primary="ZooKeeper" id="idp13420016"></a>ZooKeeper first.
ZooKeeper is a great choice for many types of frameworks, for the following reasons:</p>

<ul>
<li>
<p>It provides leader election primitives.</p>
</li>
<li>
<p>It stores arbitrary data.</p>
</li>
<li>
<p>It supports arbitrary transactions.</p>
</li>
<li>
<p>It’s highly available.</p>
</li>
<li>
<p>It can notify clients when data changes.</p>
</li>
<li>
<p>A Mesos cluster already has an instance.</p>
</li>
</ul>

<p>ZooKeeper’s main downside is that it can’t scale to hundreds of thousands of data elements.
For that use case, you’ll need to sacrifice the strong consistency it provides <a data-type="indexterm" data-primary="schedulers" data-secondary="distributed communication" data-startref="s4atdc" id="idp14089872"></a><a data-type="indexterm" data-primary="distributed communication" data-startref="dc4" id="idp14091088"></a>for other data stores like Cassandra, Redis, or MySQL.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Forced Failover"><div class="sect2" id="idp14092256">
<h2>Forced Failover</h2>

<p>At <a data-type="indexterm" data-primary="schedulers" data-secondary="forced failover" id="idp14093552"></a><a data-type="indexterm" data-primary="forced failover" id="idp14147904"></a>some point, you may want to make a framework that automatically forces failover to a new scheduler.
This could be useful in two cases:</p>
<ol>
<li>
<p>Your scheduler knows what the current running version is and will trigger a failover if it is a newer version, to simplify the upgrade process.</p>
</li>
<li>
<p>Your scheduler starts out running on the user’s command line, but it actually creates a task on the Mesos cluster that will take over for the command-line tool. For example, <a href="http://bit.ly/mesos-submit"><code>mesos-submit</code></a> (now deprecated) did this.</p>
</li>

</ol>

<p>If you want to trigger a failover, simply register your new scheduler with the existing <code>FrameworkID</code>.
When Mesos accepts the new scheduler’s registration, it will trigger the <code>error()</code> callback of the old scheduler, with the message <code>Framework failover</code>.
Unfortunately, this message string is the only way to distinguish a purposeful failover from an actual framework error.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Consolidating Offers"><div class="sect2" id="idp13336864">
<h2>Consolidating Offers</h2>

<p>One <a data-type="indexterm" data-primary="schedulers" data-secondary="consolidated offers" id="s4atco"></a><a data-type="indexterm" data-primary="offer consolidation" id="co4"></a><a data-type="indexterm" data-primary="fragmentation" id="idp14209008"></a>issue that some schedulers run into is offer fragmentation.
Offer fragmentation occurs when multiple frameworks are connected to the Mesos cluster, and one of them launches multiple tasks of similar (but not the same) size.
Usually, the Mesos master can consolidate free resources from each host.
Fragmentation occurs when the master isn’t able to do so.
The root cause is that the various fractions of the resources are repeatedly being offered to different connected frameworks, and thus are never idle long enough to consolidate.
This can manifest as, for example, a host having eight offers with one CPU each, rather than one eight-CPU offer.
To solve this problem, your framework must change the way it handles offers: rather than immediately using or declining offers, it can hold on to them temporarily in order to wait and see if any more offers come in on those hosts.
Remember, when you call <code>launchTasks</code>, you can pass it as many offers for the same slave as you’d like (see the note <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#combining_offers_tip">Combining Offers</a> following <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#resource_offers_urb">Example&nbsp;4-5</a>).</p>

<p>You can build offer consolidation as a form of middleware for your <code>resourceOffers</code> <a data-type="indexterm" data-primary="resourceOffers" id="idp14213648"></a><a data-type="indexterm" data-primary="offers" data-secondary="resourceOffers" id="idp14214384"></a>callback.
Instead of calling your original implementation of <code>resourceOffers</code>, first put all new offers into a map, keyed by slave, so that you can track all the offers for each slave.
Then, you can decide when to remove a group of offers from the map and pass them to your original <code>resourceOffers</code> callback.
When doing this, you should also make sure that you can’t accidentally hold on to an offer forever—you should still try to decline offers after a couple of minutes, to keep the whole cluster operating smoothly.</p>

<p>There are two broad classes of strategies for deciding when you should pass a group of offers along to the original <code>resourceOffers</code> implementation: you can pass along a group when it’s <em>big enough</em>, or when it’s been <em>long enough</em>.
If you choose the <em>big enough</em> strategy, you’ll need to keep track of the biggest task that you need to launch.
Then, when you finally receive enough offers on a single slave to satisfy the task, you can pass along the group of offers to the code that will launch the task.
If you choose the <em>long enough</em> strategy, you’ll also need to choose how long to hold on to an offer (typically, 15–60 seconds).
Then, when an offer is held for longer than the chosen time, you can pass all of that slave’s offers to your original <code>resourceOffers</code>, and hopefully that group will be big enough.</p>

<p>The benefit of the big enough strategy is that you’re guaranteed to launch your task when you find enough offers.
The downsides are that you still need to worry about liveness (occasionally declining old offers), and you need to track the size of pending tasks.
The strategy becomes even more complicated if you’d like to try to pack multiple tasks into an offer group, as you now need to keep track of many variables: the offers on each slave, the pending tasks, and the different ways those tasks could be packed into the offers.</p>

<p>On the other hand, the long enough strategy is simpler to implement: you don’t need to worry about the task sizes at all;
instead, you are assuming that you will eventually receive enough offers during the time window you chose to satisfy any pending task.
The downside of this strategy is that it could struggle to launch a very big task, since if you waited longer, you could’ve received the last necessary offer to succeed.</p>

<p>Ultimately, consolidating offers is not necessary until you reach a certain scale on your Mesos cluster.
It is, however, good to know how to diagnose this problem, and how to design a solution to it.
In production Mesos clusters I’ve operated, we’ve run into this problem and solved it successfully using the long enough strategy.</p>
<div data-type="tip"><h1>Fenzo, a Scheduling Library</h1>
<p><a href="https://github.com/Netflix/Fenzo">Fenzo</a> is a library released by Netflix in the summer of 2015.
For <a data-type="indexterm" data-primary="Fenzo" id="idp14195424"></a><a data-type="indexterm" data-primary="Netflix Fenzo" id="idp14196016"></a>Java-based schedulers, Fenzo provides a complete solution to offer buffering, multiple task launching, and hard and soft constraint matching.
Many, if not most, schedulers would probably benefit from using Fenzo to compute task assignments, rather than writing the offer buffering, packing, and placement routines <a data-type="indexterm" data-primary="schedulers" data-secondary="consolidated offers" data-startref="s4atco" id="idp14197152"></a><a data-type="indexterm" data-primary="offer consolidation" data-startref="co4" id="idp14198368"></a>themselves.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Hardening Your Scheduler"><div class="sect2" id="idp14199696">
<h2>Hardening Your Scheduler</h2>

<p>In <a data-type="indexterm" data-primary="schedulers" data-secondary="hardening" id="idp14200880"></a>our example scheduler, we simply retry jobs on the next offer that we receive once they’ve failed.
Often, some job won’t run on a particular host due to some uniquely broken aspect of that host.
To protect against this type of repeated failure, you should track which hosts a job has failed on, and not retry the job on those hosts.
In practice, this protects against all kinds of host misconfiguration.</p>

<p>A job not working on a particular host isn’t the only host-related issue you could encounter.
Rarely (but what’s rare at scale?), you’ll <a data-type="indexterm" data-primary="black hole hosts" id="idp14203200"></a>get a <em>black hole host</em>: a host that causes every job it runs to fail, often extremely quickly.
Black hole hosts will rapidly exhaust all the retries for all the jobs you’re trying to run, resulting in spurious failures that require manual intervention.
To handle black hole hosts, you should track how many failures you’ve seen on each host in the past minute.
If that number exceeds some predetermined target, then you should stop accepting offers from that host entirely.
Some frameworks expect tasks to never fail (like long-running services), so seeing 20 failures from a single host in a minute bodes poorly for it.
On the other hand, some frameworks complete thousands of tasks every second; for these, 20 failures on a single host in a minute would be totally normal, and so they’d only <a data-type="indexterm" data-primary="blacklists" id="idp14154512"></a>blacklist a host after thousands of failures in a short duration.
Finally, when implementing a blacklist, make sure that you can receive notifications when hosts are blacklisted, and make sure that those hosts are automatically unblacklisted after a week.
If you don’t automatically notify and later unblock these hosts, you could accidentally forget about them and leave those resources idling forever, costing money but not doing any work.
Alternatively, you can use an automated system like <a href="https://github.com/twosigma/satellite">Satellite</a> to <a data-type="indexterm" data-primary="Satellite" id="idp14156480"></a>handle this situation for all frameworks.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Framework UI"><div class="sect2" id="idp14157472">
<h2>Framework UI</h2>

<p>Usually, <a data-type="indexterm" data-primary="schedulers" data-secondary="Framework UI" id="idp14158992"></a><a data-type="indexterm" data-primary="Framework UI" id="idp14160000"></a>frameworks have a web UI, since the browser is such a powerful platform for graphical interfaces.
The <code>FrameworkInfo</code> <a data-type="indexterm" data-primary="FrameWorkInfo" id="idp14161296"></a>protobuf has a field called <code>webui_url</code> that should be set to the URL that the UI is available on.
When you set this field, the Mesos UI will make the framework’s name in the UI a link to the provided <code>webui_url</code>.
If you use this feature, you should either ensure that the <code>webui_url</code> is managed behind a load balancer, or update it in the <code>FrameworkInfo</code> every time a new scheduler becomes the leader.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Allocating Ports"><div class="sect2" id="idp13984224">
<h2>Allocating Ports</h2>

<p>We <a data-type="indexterm" data-primary="schedulers" data-secondary="allocating ports" id="s4atap"></a><a data-type="indexterm" data-primary="port allocation" id="pa4"></a>only used scalar resources in our scheduler (i.e., CPUs and memory).
Mesos also supports range-type resources, the most common of which is ports.
Mesos manages the ports on the cluster to ensure that each task that needs to listen on a socket binds to a unique port, and to ensure that tasks that require specific ports won’t start on slaves for which those ports are already in use.
The available ports are encoded as a list of <code>[<em>begin</em>, <em>end</em>]</code> pairs of available ports; to use them, you simply add the subranges you’re interested in as resources.
For example, in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#port_allocation">Example&nbsp;4-19</a> we demonstrate a function, <code>findNPorts</code>, that finds <em>N</em> ports from the given offer and returns the resources that should be added to the <code>TaskInfo</code> that needs those ports.</p>
<div id="port_allocation" data-type="example">
<h5><span class="label">Example 4-19. </span>Port allocation</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">Resource</code><code> </code><code class="nf">findNPorts</code><code class="o">(</code><code class="n">Offer</code><code> </code><code class="n">offer</code><code class="o">,</code><code> </code><code class="kt">int</code><code> </code><code class="n">n</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kt">int</code><code> </code><code class="n">numStillNeeded</code><code> </code><code class="o">=</code><code> </code><code class="n">n</code><code class="o">;</code><code>
</code><code>    </code><code class="n">Value</code><code class="o">.</code><code class="na">Ranges</code><code class="o">.</code><code class="na">Builder</code><code> </code><code class="n">ranges</code><code> </code><code class="o">=</code><code> </code><code class="n">Value</code><code class="o">.</code><code class="na">Ranges</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Value</code><code class="o">.</code><code class="na">Range</code><code class="o">&gt;</code><code> </code><code class="n">availablePorts</code><code> </code><code class="o">=</code><code> </code><code class="kc">null</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="o">(</code><code class="n">Resource</code><code> </code><code class="n">r</code><code> </code><code class="o">:</code><code> </code><code class="n">offer</code><code class="o">.</code><code class="na">getResourcesList</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">r</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="s">"ports"</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">availablePorts</code><code> </code><code class="o">=</code><code> </code><code class="n">r</code><code class="o">.</code><code class="na">getRanges</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getRangeList</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO12-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO12-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="o">(</code><code class="n">numStillNeeded</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code> </code><code class="o">&amp;</code><code class="o">&amp;</code><code>
</code><code>                   </code><code class="n">availablePorts</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="kc">null</code><code> </code><code class="o">&amp;</code><code class="o">&amp;</code><code>
</code><code>                   </code><code class="o">!</code><code class="n">availablePorts</code><code class="o">.</code><code class="na">isEmpty</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO12-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO12-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a><code>
</code><code>        </code><code class="n">Value</code><code class="o">.</code><code class="na">Range</code><code> </code><code class="n">portRange</code><code> </code><code class="o">=</code><code> </code><code class="n">availablePorts</code><code class="o">.</code><code class="na">remove</code><code class="o">(</code><code class="mi">0</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO12-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO12-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a><code>
</code><code>        </code><code class="kt">long</code><code> </code><code class="n">numAvail</code><code> </code><code class="o">=</code><code> </code><code class="n">portRange</code><code class="o">.</code><code class="na">getEnd</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">-</code><code> </code><code class="n">portRange</code><code class="o">.</code><code class="na">getBegin</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO12-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO12-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a><code>
</code><code>        </code><code class="kt">long</code><code> </code><code class="n">numWillUse</code><code> </code><code class="o">=</code><code> </code><code class="n">numAvail</code><code> </code><code class="o">&gt;</code><code class="o">=</code><code> </code><code class="n">numStillNeeded</code><code> </code><code class="o">?</code><code>
</code><code>                </code><code class="n">numStillNeeded</code><code> </code><code class="o">:</code><code> </code><code class="n">numAvail</code><code class="o">;</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO12-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO12-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a><code>
</code><code>        </code><code class="n">ranges</code><code class="o">.</code><code class="na">addRange</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Range</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setBegin</code><code class="o">(</code><code class="n">portRange</code><code class="o">.</code><code class="na">getBegin</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setEnd</code><code class="o">(</code><code class="n">portRange</code><code class="o">.</code><code class="na">getBegin</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">+</code><code> </code><code class="n">numWillUse</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="o">)</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO12-6" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO12-6"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a><code>
</code><code>                </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="n">numStillNeeded</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">numWillUse</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">numStillNeeded</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_creating_a_new_framework_for_mesos_CO12-7" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#callout_creating_a_new_framework_for_mesos_CO12-7"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/7.png" alt="7" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/7.png"></a><code>
</code><code>        </code><code class="k">throw</code><code> </code><code class="k">new</code><code> </code><code class="nf">RuntimeException</code><code class="o">(</code><code class="s">"Couldn't satisfy "</code><code> </code><code class="o">+</code><code> </code><code class="n">n</code><code> </code><code class="o">+</code><code> </code><code class="s">" ports"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">Resource</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">setName</code><code class="o">(</code><code class="s">"ports"</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">setType</code><code class="o">(</code><code class="n">Value</code><code class="o">.</code><code class="na">Type</code><code class="o">.</code><code class="na">RANGES</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">setRanges</code><code class="o">(</code><code class="n">ranges</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO12-1" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO12-1"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/1.png"></a></dt>
<dd><p>We first find the <code>Range</code>s that contain the available ports.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO12-2" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO12-2"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/2.png"></a></dt>
<dd><p>We will keep looking for ports as long as there are still available ports and we need them.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO12-3" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO12-3"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/3.png"></a></dt>
<dd><p>We will check the contiguous subranges one at a time.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO12-4" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO12-4"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/4.png"></a></dt>
<dd><p>The contiguous subranges are inclusive; thus, if the subrange is <code>[10-20]</code>, there are actually 11 ports available.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO12-5" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO12-5"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/5.png" alt="5" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/5.png"></a></dt>
<dd><p>When deciding how many ports to use from this subrange, we will never exceed how many we still need or how many are available.</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO12-6" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO12-6"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/6.png" alt="6" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/6.png"></a></dt>
<dd><p>Remember that the range is inclusive, and beware the off-by-one error!</p></dd>
<dt><a class="co" id="callout_creating_a_new_framework_for_mesos_CO12-7" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#co_creating_a_new_framework_for_mesos_CO12-7"><img src="https://www.safaribooksonline.com/library/view/building-applications-on/9781491926543/assets/7.png" alt="7" width="12" height="12" data-mfp-src="/library/view/building-applications-on/9781491926543/assets/7.png"></a></dt>
<dd><p>It’s possible that we couldn’t find enough ports; better to blow up than return bad data.</p></dd>
</dl>

<p>Besides ranges, which can be tricky to work with, Mesos also has set-type resources.
Sets of resources currently only exist when defined on the slave command line.
They are represented as lists in the <code>Resource</code> protobuf, and they’re straightforward to use.
You can learn more about creating custom resource <a data-type="indexterm" data-primary="schedulers" data-secondary="allocating ports" data-startref="s4atap" id="idp14756272"></a><a data-type="indexterm" data-primary="port allocation" data-startref="pa4" id="idp14757520"></a>types in <a data-type="xref" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch02.html#configuring_custom_resources">“Configuring Custom Resources”</a>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Checkpointing"><div class="sect2" id="idp14759520">
<h2>Checkpointing</h2>

<p>Even <a data-type="indexterm" data-primary="schedulers" data-secondary="checkpointing" id="idp14760848"></a><a data-type="indexterm" data-primary="checkpointing" id="idp14591568"></a>though we should always strive to implement our frameworks to be robust against all kinds of errors, it’s actually possible to instruct Mesos to checkpoint status updates from tasks onto disk, in case the update coincides with a slave restart.
You can enable this by setting the <code>checkpoint</code> property of the <code>FrameworkInfo</code> to <code>true</code>.
This turns some slave crashes and restarts into unexceptional behavior.
I recommend always doing this, unless you expect to generate large numbers of status updates over short intervals.
Since checkpointing causes every status update to be written to disk, if you make thousands of status updates per second per slave, that would incur thousands of additional disk I/O operations per second per slave, which could degrade cluster performance.
You should benchmark your framework with and without checkpointing if you’re concerned about its performance impact; otherwise, it’s best to always use it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="CommandInfo"><div class="sect2" id="commandinfo_details">
<h2>CommandInfo</h2>

<p>The <code>CommandInfo</code> <a data-type="indexterm" data-primary="CommandInfo" id="idp14597056"></a>protobuf describes how a process should be launched. We’ll examine <code>CommandInfo</code>’s two sides: fields related to launching a process, and fields related to setting up the environment for the process.</p>










<section data-type="sect3" data-pdf-bookmark="Launching a process"><div class="sect3" id="idp14263920">
<h3>Launching a process</h3>

<p><code>CommandInfo</code> supports <a data-type="indexterm" data-primary="process launching" id="idp14265920"></a>two ways to launch a process: through the <code>execv</code> syscall, and via the system’s default shell (such as Dash or Bash).
If you want to launch your process using <code>execv</code>, this will ensure that you can control the arguments to your process very precisely, and not worry about how shells interpret strings.
To launch the process directly, set the <code>value</code> to be the path to the executable, set the <code>arguments</code> to be the args array, and set <code>shell</code> to <code>false</code>.
If you’d like it to be launched via a shell, however (so that you can use shell operators like <code>&amp;&amp;</code>, <code>||</code>, and <code>|</code> to compose programs), you must set <code>shell</code> to <code>true</code>, and then the entire contents of the <code>value</code> will be invoked by running <code>/bin/sh -c "$value"</code>; <code>arguments</code> are ignored for shell commands.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Configuring the process’s environment"><div class="sect3" id="configuring_process_environment">
<h3>Configuring the process’s environment</h3>

<p>Mesos <a data-type="indexterm" data-primary="process environment" id="idp14351600"></a>allows you to control three additional aspects of the process’s environment: the user account that it runs as (via the <code>user</code> field, subject to the ACLs), the environment variables that the process sees (via the <code>environment</code> field, which is just a list of name/value pairs wrapped into a protobuf), and the filesystem state (via URIs).
This last parameter requires additional explanation: it allows you to specify any number of URIs that should be downloaded into the executor sandbox (the current working directory when the executor starts running).
You can choose whether those URIs should be executable, which is useful because you can instruct your <code>CommandInfo</code> to bootstrap and install the application’s binaries directly into the sandbox, obviating the need for a deployment system.
You can also specify whether to extract archive files, as Mesos understands those extensions and can download and unpack the application or additional resources automatically.
The extensions recognized are currently <em>.tgz</em>, <em>.tar.gz</em>, <em>.tbz2</em>, <em>.tar.bz2</em>, <em>.txz</em>, <em>.tar.xz</em>, and <em>.zip</em>.
By default, Mesos supports the URI schemes <em>hdfs://</em>, <em>http://</em>, <em>https://</em>, <em>ftp://</em>, <em>ftps://</em>, and <em>file://</em> (for use with NFS or other networked POSIX filesystems), as well as any other URI schemes that the installed Hadoop client supports (Hadoop is not a required dependency, though, and <em>hdfs://</em> will simply fail if it’s not installed).
You can add support for additional means of fetching binary dependencies by modifying <em>src/launcher/fetcher.cpp</em> accordingly.</p>
<div data-type="tip"><h6>Tip</h6>
<p>The task’s sandbox is always available in the environment variable <code>$MESOS_DIRECTORY</code>.</p>
</div>
</div></section>



</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idp13352368">
<h1>Summary</h1>

<p>In <a data-type="indexterm" data-primary="schedulers" data-secondary="advanced techniques" data-startref="s4at" id="idp14464112"></a>this chapter, we learned how to implement the scheduler component of a Mesos framework.
The scheduler is responsible for launching tasks, monitoring those tasks, and interacting with the user.
Many frameworks only need to implement a scheduler; all the functionality necessary to build most distributed, scalable, clustered applications can be implemented by orchestrating the launching of worker processes.
We looked at a few example framework architectures, such as the <a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#pool_of_servers">pool of servers scheduler</a>, <a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#work_queue_scheduler_example">work queue scheduler</a>, and <a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#job_processor_scheduler">job processor scheduler</a>.
Then, we walked through the implementation of a job processor.</p>

<p>To build the job processor scheduler, we had to use a database, ZooKeeper, to persist the state of the application.
Even though the scheduler API has many callbacks, we only needed to implement a handful of them to create a working system.
We separated the notion of jobs (what the user wants to do) from tasks (code that Mesos runs on the cluster).
This separation allowed us to easily build retries into our scheduler.
The scheduler also needed a basic optimization, offer packing, in order to avoid being too slow.</p>

<p>Once the scheduler was up and running, we added high availability by combining an external leader election library, Curator, with additional features of the Mesos framework registration API.
Unfortunately, once we gained the ability to fail over, we opened ourselves up to the possible loss of task status updates.
To resolve this, we implemented task reconciliation, which allowed the scheduler to always behave correctly during planned and unplanned failover scenarios.</p>

<p>After learning how to implement a reliable Mesos scheduler, we discussed additional considerations for production-quality frameworks should.
Since we usually have many instances of a scheduler running, and only one is the master, we looked at several designs for how clients can interact with the schedulers.
We learned about offer fragmentation, what causes it, and some strategies to ensure that a framework never fails to find big enough offers.
Besides CPUs and memory, many frameworks must allocate ports to their tasks: we learned about range-type resources, and how port allocation differs from CPU and memory scalar allocation.
Finally, we briefly discussed issues such as building a user interface for a framework, hardening a framework against unknowns, and automating failovers during maintenance.</p>

<p>At this point, you’re fully equipped to write a Mesos framework that can launch and monitor tasks, handle various types of failures and unexpected scenarios, and operate efficiently on your cluster.
Next, we’ll learn about how to increase the capabilities of frameworks by implementing custom executors, which will allow things like dynamically resizing containers and allowing tasks to share <a data-type="indexterm" data-primary="schedulers" data-startref="s4" id="idp14471936"></a>resources.</p>
</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idp9873088"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp9873088-marker" class="totri-footnote">1</a></sup> The name of this framework refers to it hardcoding the command that it runs; as an example of how to work with the Mesos APIs, it is very useful.</p><p data-type="footnote" id="idp10036688"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp10036688-marker" class="totri-footnote">2</a></sup> Some projects to watch for purely native Mesos bindings are <a href="https://github.com/groupon/jesos">Jesos</a> for Java, <a href="https://github.com/wickman/pesos">Pesos</a> for Python, and <a href="https://github.com/mesos/mesos-go">Go bindings</a> for Go.</p><p data-type="footnote" id="idp12148944"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12148944-marker" class="totri-footnote">3</a></sup> NP-completeness is out of scope for this book, but you can start with <a href="https://en.wikipedia.org/wiki/NP-complete">the Wikipedia article</a>.</p><p data-type="footnote" id="idp12151712"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12151712-marker" class="totri-footnote">4</a></sup> This is also outside the scope of this book; for more information, see the <a href="http://en.wikipedia.org/wiki/Knapsack_problem">Wikipedia page</a> on the knapsack problem.</p><p data-type="footnote" id="idp12854224"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12854224-marker" class="totri-footnote">5</a></sup> There’s ongoing work to enable etcd as a ZooKeeper alternative. The issue is tracked on the Apache Mesos Jira as <a href="https://issues.apache.org/jira/browse/MESOS-1806">MESOS-1806</a>.</p><p data-type="footnote" id="idp12857696"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12857696-marker" class="totri-footnote">6</a></sup> The examples in the book are written against Curator 2.7.1, using <code>curator-framework</code> and <code>curator-recipes</code>.</p><p data-type="footnote" id="idp12964608"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp12964608-marker" class="totri-footnote">7</a></sup> Somewhat confusingly, the Apache Curator’s API is also called a framework; however, it’s completely unrelated to Mesos frameworks!</p><p data-type="footnote" id="idp13024432"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp13024432-marker" class="totri-footnote">8</a></sup> Operations that are idempotent have the same effect no matter whether you do them once or a thousand times. When building distributed systems, trying to make as many operations idempotent as possible reduces the chances of race conditions or unpredictable behavior when the network reorders and drops messages.</p><p data-type="footnote" id="idp14118880"><sup><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#idp14118880-marker" class="totri-footnote">9</a></sup> Joe Armstrong, the author of <a href="http://www.erlang.org/download/armstrong_thesis_2003.pdf">Making reliable distributed systems in the presence of software errors</a>, is also the creator of Erlang. Even though most of us aren’t using Erlang, his ideas about goal-oriented programming and supervision pervade all reliable distributed systems, including Mesos and its close cousin from Google, Borg.</p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/building-applications-on/9781491926543/ch03.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">3. Porting an Existing Application to Mesos</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/building-applications-on/9781491926543/ch05.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">5. Building a Mesos Executor</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781491926543/chapter/ch04.html" data-for-analytics="9781491926543:ch04.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#">Reset</a>
</div>
</div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/building-applications-on/9781491926543/ch04.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>
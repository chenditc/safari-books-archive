<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/effective-c-55/0321334876/ch07.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="0321334876"
  data-publishers="Addison-Wesley Professional"



  data-htmlfile-name="ch07.html"
  data-epub-title="Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/effective-c-55/0321334876/ch07.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="0321334876" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch07.html" data-epub-title="Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://0321334876"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>7. Templates and Generic Programming - Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content div{margin-top:5pt;margin-bottom:5pt;margin-right:15pt}#sbo-rt-content .cover{margin-top:2pt;margin-bottom:2pt;text-align:center}#sbo-rt-content h1{page-break-before:right;margin-top:5pt;text-align:center;margin-bottom:12pt;font-weight:bold}#sbo-rt-content .subtitle{font-size:large;margin-top:30pt;margin-bottom:55pt;font-weight:bold;text-align:center}#sbo-rt-content .publisher{text-align:center;margin-top:64pt;margin-bottom:4pt}#sbo-rt-content .copyright{margin-top:5pt;margin-bottom:5pt;text-indent:.12pt}#sbo-rt-content h2{page-break-before:right;margin-top:7pt;margin-bottom:25pt;font-weight:bold}#sbo-rt-content h3{margin-top:9pt;margin-bottom:8pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content h4{margin-top:9pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content h5{margin-top:9pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content h6{margin-top:8pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content .author{text-align:center;font-weight:bold;margin-top:66pt;margin-bottom:24pt}#sbo-rt-content .bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content .toc-chapter{margin-top:12pt;margin-bottom:5pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .emphasis{font-style:italic}#sbo-rt-content .mediaobject{margin-top:12pt;margin-bottom:12pt;text-align:center}#sbo-rt-content .tabimage{margin-top:12pt;margin-bottom:12pt;text-align:center}#sbo-rt-content .smaller{font-size:small}#sbo-rt-content .center{margin-top:50pt;margin-bottom:5pt;text-align:center}#sbo-rt-content .note{margin-top:6pt;margin-bottom:12pt;margin-left:.12pt;text-indent:.12pt;margin-right:24pt}#sbo-rt-content .toc-preface{margin-top:5pt;margin-bottom:5pt;margin-left:1pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .programlisting{font-family:"Courier New";font-size:small;margin-top:8pt;margin-bottom:8pt;text-indent:.12pt}#sbo-rt-content .programlisting1{font-family:"Courier New";font-size:small;margin-top:5pt;margin-bottom:4pt;margin-left:36pt;text-indent:.12pt}#sbo-rt-content code{font-size:x-small}#sbo-rt-content .toc-section{margin-top:4pt;margin-bottom:4pt;margin-left:12pt;text-indent:.12pt}#sbo-rt-content .toc-index{margin-top:12pt;margin-bottom:4pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .toc-appendix{margin-top:12pt;margin-bottom:4pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .strong{font-weight:bold}#sbo-rt-content .italic{font-style:italic}#sbo-rt-content .title{margin-top:12pt;margin-bottom:6pt;font-size:medium;font-weight:bold;text-align:center}#sbo-rt-content .attribution{margin-top:4pt;margin-bottom:12pt;margin-right:15pt;text-align:right}#sbo-rt-content .indexmain{margin-top:2pt;margin-bottom:2pt;text-indent:.12pt}#sbo-rt-content .indexsub{margin-top:2pt;margin-bottom:2pt;margin-left:24pt;text-indent:.12pt}#sbo-rt-content .indexsubsub{margin-top:2pt;margin-bottom:2pt;margin-left:40pt;text-indent:.12pt}#sbo-rt-content .paraindent{margin-top:4pt;margin-bottom:4pt;margin-left:25pt;text-indent:.12pt}#sbo-rt-content .indenthanding{margin-top:4pt;margin-bottom:4pt;padding-left:25pt;text-indent:-15pt}#sbo-rt-content .indenthanding1{margin-top:4pt;margin-bottom:4pt;padding-left:48pt;text-indent:-8pt}#sbo-rt-content .underline{text-decoration:underline}#sbo-rt-content .footnotes{font-size:small;margin-top:5pt;margin-bottom:4pt;padding-left:20pt;text-indent:-8pt}#sbo-rt-content .courierb{font-family:"Courier New Bold"}#sbo-rt-content .courieri{font-family:"Courier New Italic"}#sbo-rt-content .center1{margin-top:4pt;margin-bottom:4pt;margin-left:80pt;text-align:center}#sbo-rt-content .noindent{margin-top:6pt;margin-bottom:5pt;text-indent:.12pt}#sbo-rt-content .noindent1{margin-top:12pt;margin-bottom:2pt;text-indent:.12pt}#sbo-rt-content .edition{font-size:1.2em;margin-top:2pt;margin-bottom:2pt;text-align:center}#sbo-rt-content .image1{page-break-before:always;page-break-after:always}#sbo-rt-content .codelink{margin-top:6pt;margin-bottom:6pt;text-indent:.12pt;font-weight:bold;page-break-after:avoid;font-size:small}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch07.html"><meta name="description" content="7. Templates and Generic Programming The initial motivation for C++ templates was straightforward: to make it possible to create type-safe containers like vector, list, and map. The more people worked ... "><meta property="og:title" content="7. Templates and Generic Programming"><meta itemprop="isPartOf" content="/library/view/effective-c-55/0321334876/"><meta itemprop="name" content="7. Templates and Generic Programming"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch07.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/0321334876/"><meta property="og:description" itemprop="description" content="7. Templates and Generic Programming The initial motivation for C++ templates was straightforward: to make it possible to create type-safe containers like vector, list, and map. The more people worked ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="0321334876"><meta property="og:book:author" itemprop="author" content="Scott Meyers"><meta property="og:book:tag" itemprop="about" content="C++"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/0321334876/chapter/ch07.html" data-for-analytics="0321334876:ch07.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch07.html&amp;text=Effective%20C%2B%2B%3A%2055%20Specific%20Ways%20to%20Improve%20Your%20Programs%20and%20Designs%2C%20Third%20Edition&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch07.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch07.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%207.%20Templates%20and%20Generic%20Programming&amp;body=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch07.html%0D%0Afrom%20Effective%20C%2B%2B%3A%2055%20Specific%20Ways%20to%20Improve%20Your%20Programs%20and%20Designs%2C%20Third%20Edition%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch06.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">6. Inheritance and Object-Oriented Design</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch08.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">8. Customizing new and delete</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><h2 id="ch07">7. Templates and Generic Programming</h2>
<p class="noindent"><a id="page_199"></a>The initial motivation for C++ templates was straightforward: to make it possible to create type-safe containers like <code>vector</code>, <code>list</code>, and <code>map</code>. The more people worked with templates, however, the wider the variety of things they found they could do with them. Containers were good, but generic programming — the ability to write code that is independent of the types of objects being manipulated — was even better. STL algorithms like <code>for_each</code>, <code>find</code>, and <code>merge</code> are examples of such programming. Ultimately, it was discovered that the C++ template mechanism is itself Turing-complete: it can be used to compute any computable value. That led to template metaprogramming: the creation of programs that execute inside C++ compilers and that stop running when compilation is complete. These days, containers are but a small part of the C++ template pie. Despite the breadth of template applications, however, a set of core ideas underlie all template-based programming. Those ideas are the focus of this chapter.</p>
<p class="noindent">This chapter won't make you an expert template programmer, but it will make you a better one. It will also give you information you need to expand your template-programming boundaries as far as you desire.</p>
<h3 id="ch07lev1sec1">Item 41: Understand implicit interfaces and compile-time polymorphism</h3>
<p class="noindent">The world of object-oriented programming revolves around <em>explicit</em> interfaces and <em>runtime</em> polymorphism. For example, given this (meaningless) class,</p>
<p class="programlisting"><br>class Widget {<br>public:<br>&nbsp;&nbsp;Widget();<br>&nbsp;&nbsp;virtual ~Widget();<br><br><a id="page_200"></a>&nbsp;&nbsp;virtual std::size_t size() const;<br>&nbsp;&nbsp;virtual void normalize();<br>&nbsp;&nbsp;void swap(Widget&amp; other);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 25<br><br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">and this (equally meaningless) function,</p>
<p class="programlisting"><br>void doProcessing(Widget&amp; w)<br>{<br>&nbsp;&nbsp;if (w.size() &gt; 10 &amp;&amp; w != someNastyWidget) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Widget temp(w);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;temp.normalize();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;temp.swap(w);<br>&nbsp;&nbsp;}<br>}<br></p>
<p class="noindent">we can say this about <code>w</code> in <code>doProcessing</code>:</p>
<p class="indenthanding">• Because <code>w</code> is declared to be of type <code>Widget</code>, <code>w</code> must support the <code>Widget</code> interface. We can look up this interface in the source code (e.g., the <code>.h</code> file for <code>Widget</code>) to see exactly what it looks like, so I call this an <em>explicit interface</em> — one explicitly visible in the source code.</p>
<p class="indenthanding">• Because some of <code>Widget</code>'s member functions are virtual, <code>w</code>'s calls to those functions will exhibit <em>runtime polymorphism</em>: the specific function to call will be determined at runtime based on <code>w</code>'s dynamic type (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec6">Item 37</a>).</p>
<p class="noindent">The world of templates and generic programming is fundamentally different. In that world, explicit interfaces and runtime polymorphism continue to exist, but they're less important. Instead, <em>implicit interfaces</em> and <em>compile-time polymorphism</em> move to the fore. To see how this is the case, look what happens when we turn <code>doProcessing</code> from a function into a function template:</p>
<p class="programlisting"><br><span class="courierb">template&lt;typename T&gt;</span><br>void doProcessing(<span class="courierb">T</span>&amp; w)<br>{<br>&nbsp;&nbsp;if (w.size() &gt; 10 &amp;&amp; w != someNastyWidget) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">T</span> temp(w);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;temp.normalize();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;temp.swap(w);<br>&nbsp;&nbsp;}<br>}<br></p>
<p class="noindent">Now what can we say about <code>w</code> in <code>doProcessing</code>?</p>
<p class="indenthanding">• The interface that <code>w</code> must support is determined by the operations performed on <code>w</code> in the template. In this example, it appears that <code>w</code>'s type (<code>T</code>) must support the <code>size</code>, <code>normalize</code>, and <code>swap</code> member <a id="page_201"></a>functions; copy construction (to create <code>temp</code>); and comparison for inequality (for comparison with <code>someNastyWidget</code>). We'll soon see that this isn't quite accurate, but it's true enough for now. What's important is that the set of expressions that must be valid in order for the template to compile is the <em>implicit interface</em> that <code>T</code> must support.</p>
<p class="indenthanding">• The calls to functions involving <code>w</code> such as <code>operator&gt;</code> and <code>operator!=</code> may involve instantiating templates to make these calls succeed. Such instantiation occurs during compilation. Because instantiating function templates with different template parameters leads to different functions being called, this is known as <em>compile-time polymorphism</em>.</p>
<p class="noindent">Even if you've never used templates, you should be familiar with the difference between runtime and compile-time polymorphism, because it's similar to the difference between the process of determining which of a set of overloaded functions should be called (which takes place during compilation) and dynamic binding of virtual function calls (which takes place at runtime). The difference between explicit and implicit interfaces is new to templates, however, and it bears closer examination.</p>
<p class="noindent">An explicit interface typically consists of function signatures, i.e., function names, parameter types, return types, etc. The <code>Widget</code> class public interface, for example,</p>
<p class="programlisting"><br>class Widget {<br>public:<br>&nbsp;&nbsp;<span class="courierb">Widget();</span><br>&nbsp;&nbsp;virtual <span class="courierb">~Widget();</span><br><br>&nbsp;&nbsp;virtual <span class="courierb">std::size_t size() const;</span><br>&nbsp;&nbsp;virtual <span class="courierb">void normalize();</span><br>&nbsp;&nbsp;<span class="courierb">void swap(Widget&amp; other);</span><br>};<br></p>
<p class="noindent">consists of a constructor, a destructor, and the functions <code>size</code>, <code>normalize</code>, and <code>swap</code>, along with the parameter types, return types, and constnesses of these functions. (It also includes the compiler-generated copy constructor and copy assignment operator — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec1">Item 5</a>.) It could also include typedefs and, if you were so bold as to violate <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec5">Item 22</a>'s advice to make data members private, data members, though in this case, it does not.</p>
<p class="noindent">An implicit interface is quite different. It is not based on function signatures. Rather, it consists of valid <em>expressions</em>. Look again at the conditional at the beginning of the <code>doProcessing</code> template:</p>
<p class="programlisting"><br><br><a id="page_202"></a>template&lt;typename T&gt;<br>void doProcessing(T&amp; w)<br>{<br>&nbsp;&nbsp;if (<span class="courierb">w.size() &gt; 10 &amp;&amp; w != someNastyWidget</span>) {<br>&nbsp;&nbsp;...<br></p>
<p class="noindent">The implicit interface for <code>T</code> (<code>w</code>'s type) appears to have these constraints:</p>
<p class="indenthanding">• It must offer a member function named <code>size</code> that returns an integral value.</p>
<p class="indenthanding">• It must support an <code>operator!=</code> function that compares two objects of type <code>T</code>. (Here, we assume that <code>someNastyWidget</code> is of type <code>T</code>.)</p>
<p class="noindent">Thanks to the possibility of operator overloading, neither of these constraints need be satisfied. Yes, <code>T</code> must support a <code>size</code> member function, though it's worth mentioning that the function might be inherited from a base class. But this member function need not return an integral type. It need not even return a numeric type. For that matter, it need not even return a type for which <code>operator&gt;</code> is defined! All it needs to do is return an object of some type <code>X</code> such that there is an <code>operator&gt;</code> that can be called with an object of type <code>X</code> and an <code>int</code> (because 10 is of type <code>int</code>). The <code>operator&gt;</code> need not take a parameter of type <code>X</code>, because it could take a parameter of type <code>Y</code>, and that would be okay as long as there were an implicit conversion from objects of type <code>X</code> to objects of type <code>Y</code>!</p>
<p class="noindent">Similarly, there is no requirement that <code>T</code> support <code>operator!=</code>, because it would be just as acceptable for <code>operator!=</code> to take one object of type <code>X</code> and one object of type <code>Y</code>. As long as <code>T</code> can be converted to <code>X</code> and <code>someNastyWidget</code>'s type can be converted to <code>Y</code>, the call to <code>operator!=</code> would be valid.</p>
<p class="noindent">(As an aside, this analysis doesn't take into account the possibility that <code>operator&amp;&amp;</code> could be overloaded, thus changing the meaning of the above expression from a conjunction to something potentially quite different.)</p>
<p class="noindent">Most people's heads hurt when they first start thinking about implicit interfaces this way, but there's really no need for aspirin. Implicit interfaces are simply made up of a set of valid expressions. The expressions themselves may look complicated, but the constraints they impose are generally straightforward. For example, given the conditional,</p>
<p class="programlisting"><br>if (w.size() &gt; 10 &amp;&amp; w != someNastyWidget) ...<br></p>
<p class="noindent">it's hard to say much about the constraints on the functions <code>size</code>, <code>operator&gt;</code>, <code>operator&amp;&amp;</code>, or <code>operator!=</code>, but it's easy to identify the constraint <a id="page_203"></a>on the expression as a whole. The conditional part of an <code>if</code> statement must be a boolean expression, so regardless of the exact types involved, whatever “<code>w.size() &gt; 10 &amp;&amp; w != someNastyWidget</code>” yields, it must be compatible with <code>bool</code>. This is part of the implicit interface the template <code>doProcessing</code> imposes on its type parameter <code>T</code>. The rest of the interface required by <code>doProcessing</code> is that calls to the copy constructor, to <code>normalize</code>, and to <code>swap</code> must be valid for objects of type <code>T</code>.</p>
<p class="noindent">The implicit interfaces imposed on a template's parameters are just as real as the explicit interfaces imposed on a class's objects, and both are checked during compilation. Just as you can't use an object in a way contradictory to the explicit interface its class offers (the code won't compile), you can't try to use an object in a template unless that object supports the implicit interface the template requires (again, the code won't compile).</p>
<div class="note">
<h3 id="ch07note01">Things to Remember</h3>
<p class="indenthanding">• Both classes and templates support interfaces and polymorphism.</p>
<p class="indenthanding">• For classes, interfaces are explicit and centered on function signatures. Polymorphism occurs at runtime through virtual functions.</p>
<p class="indenthanding">• For template parameters, interfaces are implicit and based on valid expressions. Polymorphism occurs during compilation through template instantiation and function overloading resolution.</p>
</div>
<h3 id="ch07lev1sec2">Item 42: Understand the two meanings of <code>typename</code></h3>
<p class="noindent">Question: what is the difference between <code>class</code> and <code>typename</code> in the following template declarations?</p>
<p class="codelink"><a id="procode271"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode271">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;<span class="courierb">class</span> T&gt; class Widget;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// uses "class"<br><br>template&lt;<span class="courierb">typename</span> T&gt; class Widget;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// uses "typename"<br></p>
<p class="noindent">Answer: nothing. When declaring a template type parameter, <code>class</code> and <code>typename</code> mean exactly the same thing. Some programmers prefer <code>class</code> all the time, because it's easier to type. Others (including me) prefer <code>typename</code>, because it suggests that the parameter need not be a class type. A few developers employ <code>typename</code> when any type is allowed and reserve <code>class</code> for when only user-defined types are acceptable. But from C++'s point of view, <code>class</code> and <code>typename</code> mean exactly the same thing when declaring a template parameter.</p>
<p class="noindent">C++ doesn't always view <code>class</code> and <code>typename</code> as equivalent, however. Sometimes you must use <code>typename</code>. To understand when, we have to talk about two kinds of names you can refer to in a template.</p>
<p class="noindent"><a id="page_204"></a>Suppose we have a template for a function that takes an STL-compatible container holding objects that can be assigned to <code>int</code>s. Further suppose that this function simply prints the value of its second element. It's a silly function implemented in a silly way, and as I've written it below, it shouldn't even compile, but please overlook those things — there's a method to my madness:</p>
<p class="codelink"><a id="procode272"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode272">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename C&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// print 2nd element in<br>void print2nd(const C&amp; container)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// container;<br>{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// <span class="courieri">this is not valid C++!</span><br>&nbsp;&nbsp;if (container.size() &gt;= 2) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C::const_iterator <span class="courierb">iter</span>(container.begin()); // get iterator to 1st element<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++iter;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// move iter to 2nd element<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int <span class="courierb">value</span> = *iter;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy that element to an int<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::cout &lt;&lt; value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// print the int<br>&nbsp;&nbsp;}<br>}<br></p>
<p class="noindent">I've highlighted the two local variables in this function, <code>iter</code> and <code>value</code>. The type of <code>iter</code> is <code>C::const_iterator</code>, a type that depends on the template parameter <code>C</code>. Names in a template that are dependent on a template parameter are called <em>dependent names</em>. When a dependent name is nested inside a class, I call it a <em>nested dependent name</em>. <code>C::const_iterator</code> is a nested dependent name. In fact, it's a <em>nested dependent type name</em>, i.e., a nested dependent name that refers to a type.</p>
<p class="noindent">The other local variable in <code>print2nd</code>, <code>value</code>, has type <code>int</code>. <code>int</code> is a name that does not depend on any template parameter. Such names are known as <em>non-dependent names</em>, (I have no idea why they're not called independent names. If, like me, you find the term “non-dependent” an abomination, you have my sympathies, but “non-dependent” is the term for these kinds of names, so, like me, roll your eyes and resign yourself to it.)</p>
<p class="noindent">Nested dependent names can lead to parsing difficulties. For example, suppose we made <code>print2nd</code> even sillier by starting it this way:</p>
<p class="programlisting"><br>template&lt;typename C&gt;<br>void print2nd(const C&amp; container)<br>{<br>&nbsp;&nbsp;<span class="courierb">C::const_iterator * x;</span><br>&nbsp;&nbsp;...<br>}<br></p>
<p class="noindent">This looks like we're declaring <code>x</code> as a local variable that's a pointer to a <code>C::const_iterator</code>. But it looks that way only because we “know” that <code>C::const_iterator</code> is a type. But what if <code>C::const_iterator</code> weren't a type? What if <code>C</code> had a static data member that happened to be named <code>const_iterator</code>, and what if <code>x</code> happened to be the name of a global variable? <a id="page_205"></a>In that case, the code above wouldn't declare a local variable, it would be a multiplication of <code>C::const_iterator</code> by <code>x</code>! Sure, that sounds crazy, but it's <em>possible</em>, and people who write C++ parsers have to worry about all possible inputs, even the crazy ones.</p>
<p class="noindent">Until <code>C</code> is known, there's no way to know whether <code>C::const_iterator</code> is a type or isn't, and when the template <code>print2nd</code> is parsed, <code>C</code> isn't known. C++ has a rule to resolve this ambiguity: if the parser encounters a nested dependent name in a template, it assumes that the name is <em>not</em> a type unless you tell it otherwise. By default, nested dependent names are <em>not</em> types. (There is an exception to this rule that I'll get to in a moment.)</p>
<p class="noindent">With that in mind, look again at the beginning of <code>print2nd</code>:</p>
<p class="codelink"><a id="procode273"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode273">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename C&gt;<br>void print2nd(const C&amp; container)<br>{<br>&nbsp;&nbsp;if (container.size() &gt;= 2) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">C::const_iterator</span> iter(container.begin());&nbsp;&nbsp;&nbsp;// this name is assumed to<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// <span class="courieri">not</span> be a type<br></p>
<p class="noindent">Now it should be clear why this isn't valid C++. The declaration of <code>iter</code> makes sense only if <code>C::const_iterator</code> is a type, but we haven't told C++ that it is, and C++ assumes that it's not. To rectify the situation, we have to tell C++ that <code>C::const_iterator</code> is a type. We do that by putting <code>typename</code> immediately in front of it:</p>
<p class="codelink"><a id="procode274"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode274">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename C&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this is valid C++<br>void print2nd(const C&amp; container)<br>{<br>&nbsp;&nbsp;if (container.size() &gt;= 2) {<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">typename</span> C::const_iterator iter(container.begin());<br>&nbsp;&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;}<br>}<br></p>
<p class="noindent">The general rule is simple: anytime you refer to a nested dependent type name in a template, you must immediately precede it by the word <code>typename</code>. (Again, I'll describe an exception shortly.)</p>
<p class="noindent"><code>typename</code> should be used to identify only nested dependent type names; other names shouldn't have it. For example, here's a function template that takes both a container and an iterator into that container:</p>
<p class="codelink"><a id="procode275"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode275">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename C&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// typename allowed (as is "class")<br>void f(const <span class="courierb">C</span>&amp; container,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// typename not allowed<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">typename C::iterator</span> iter);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// typename required<br></p>
<p class="noindent"><a id="page_206"></a><code>C</code> is not a nested dependent type name (it's not nested inside anything dependent on a template parameter), so it must not be preceded by <code>typename</code> when declaring <code>container</code>, but <code>C::iterator</code> is a nested dependent type name, so it's required to be preceded by <code>typename</code>.</p>
<p class="noindent">The exception to the “<code>typename</code> must precede nested dependent type names” rule is that <code>typename</code> must not precede nested dependent type names in a list of base classes or as a base class identifier in a member initialization list. For example:</p>
<p class="codelink"><a id="procode276"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode276">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class Derived: public <span class="courierb">Base&lt;T&gt;::Nested</span> { // base class list: <span class="courieri">typename not</span><br>public:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// <span class="courieri">allowed</span><br>&nbsp;&nbsp;explicit Derived(int x)<br>&nbsp;&nbsp;: <span class="courierb">Base&lt;T&gt;::Nested</span>(x)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// base class identifier in mem<br>&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// init. list: <span class="courieri">typename not allowed</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">typename Base&lt;T&gt;::Nested</span> temp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use of nested dependent type<br>&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// name not in a base class list or<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// as a base class identifier in a<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// mem. init. list: <span class="courieri">typename required</span><br>};<br></p>
<p class="noindent">Such inconsistency is irksome, but once you have a bit of experience under your belt, you'll barely notice it.</p>
<p class="noindent">Let's look at one last <code>typename</code> example, because it's representative of something you're going to see in real code. Suppose we're writing a function template that takes an iterator, and we want to make a local copy, <code>temp</code>, of the object the iterator points to. We can do it like this:</p>
<p class="codelink"><a id="procode277"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode277">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT&gt;<br>void workWithIterator(IterT iter)<br>{<br>&nbsp;&nbsp;<span class="courierb">typename std::iterator_traits&lt;IterT&gt;::value_type</span> temp(*iter);<br>&nbsp;&nbsp;...<br>}<br></p>
<p class="noindent">Don't let the <code>std::iterator_traits&lt;IterT&gt;::value_type</code> startle you. That's just a use of a standard traits class (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec7">Item 47</a>), the C++ way of saying “the type of thing pointed to by objects of type <code>IterT</code>.” The statement declares a local variable (<code>temp</code>) of the same type as what <code>IterT</code> objects point to, and it initializes <code>temp</code> with the object that <code>iter</code> points to. If <code>IterT</code> is <code>vector&lt;int&gt;::iterator</code>, <code>temp</code> is of type <code>int</code>. If <code>IterT</code> is <code>list&lt;string&gt;::iterator</code>, <code>temp</code> is of type <code>string</code>. Because <code>std::iterator_traits&lt;IterT&gt;::value_type</code> is a nested dependent type name (<code>value_type</code> is nested inside <code>iterator_traits&lt;IterT&gt;</code>, and <code>IterT</code> is a template parameter), we must precede it by <code>typename</code>.</p>
<p class="noindent"><a id="page_207"></a>If you think reading <code>std::iterator_traits&lt;IterT&gt;::value_type</code> is unpleasant, imagine what it's like to type it. If you're like most programmers, the thought of typing it more than once is ghastly, so you'll want to create a typedef. For traits member names like <code>value_type</code> (again, see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec7">Item 47</a> for information on traits), a common convention is for the typedef name to be the same as the traits member name, so such a local typedef is often defined like this:</p>
<p class="codelink"><a id="procode278"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode278">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT&gt;<br>void workWithIterator(IterT iter)<br>{<br>&nbsp;&nbsp;<span class="courierb">typedef typename</span> std::iterator_traits&lt;IterT&gt;::value_type value_type;<br><br>&nbsp;&nbsp;value_type temp(*iter);<br>&nbsp;&nbsp;...<br>}<br></p>
<p class="noindent">Many programmers find the “<code>typedef typename</code>” juxtaposition initially jarring, but it's a logical fallout from the rules for referring to nested dependent type names. You'll get used to it fairly quickly. After all, you have strong motivation. How many times do you want to type <code>typename std::iterator_traits&lt;IterT&gt;::value_type</code>?</p>
<p class="noindent">As a closing note, I should mention that enforcement of the rules surrounding <code>typename</code> vary from compiler to compiler. Some compilers accept code where <code>typename</code> is required but missing; some accept code where <code>typename</code> is present but not allowed; and a few (usually older ones) reject <code>typename</code> where it's present and required. This means that the interaction of <code>typename</code> and nested dependent type names can lead to some mild portability headaches.</p>
<div class="note">
<h3 id="ch07note02">Things to Remember</h3>
<p class="indenthanding">• When declaring template parameters, <code>class</code> and <code>typename</code> are interchangeable.</p>
<p class="indenthanding">• Use <code>typename</code> to identify nested dependent type names, except in base class lists or as a base class identifier in a member initialization list.</p>
</div>
<h3 id="ch07lev1sec3">Item 43: Know how to access names in templatized base classes</h3>
<p class="noindent">Suppose we need to write an application that can send messages to several different companies. Messages can be sent in either encrypted or cleartext (unencrypted) form. If we have enough information during compilation to determine which messages will go to which companies, we can employ a template-based solution:</p>
<p class="codelink"><a id="procode279"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode279">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_208"></a>class CompanyA {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void sendCleartext(const std::string&amp; msg);<br>&nbsp;&nbsp;void sendEncrypted(const std::string&amp; msg);<br>&nbsp;&nbsp;...<br>};<br><br>class CompanyB {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void sendCleartext(const std::string&amp; msg);<br>&nbsp;&nbsp;void sendEncrypted(const std::string&amp; msg);<br>&nbsp;&nbsp;...<br>};<br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// classes for other companies<br><br>class MsgInfo { ... };&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// class for holding information<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// used to create a message<br>template&lt;typename Company&gt;<br>class MsgSender {<br>public:<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ctors, dtor, etc.<br><br>&nbsp;&nbsp;void sendClear(const MsgInfo&amp; info)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;std::string msg;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courieri">create msg from info;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;Company c;<br>&nbsp;&nbsp;&nbsp;&nbsp;c.sendCleartext(msg);<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;void sendSecret(const MsgInfo&amp; info)&nbsp;&nbsp;&nbsp;// similar to sendClear, except<br>&nbsp;&nbsp;{ ... }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// calls c.sendEncrypted<br>};<br></p>
<p class="noindent">This will work fine, but suppose we sometimes want to log some information each time we send a message. A derived class can easily add that capability, and this seems like a reasonable way to do it:</p>
<p class="codelink"><a id="procode280"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode280">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename Company&gt;<br>class LoggingMsgSender: public MsgSender&lt;Company&gt; {<br>public:<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ctors, dtor, etc.<br>&nbsp;&nbsp;void sendClearMsg(const MsgInfo&amp; info)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courieri">write "before sending" info to the log;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">sendClear(info);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call base class function;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// <span class="courieri">this code will not compile!</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courieri">write "after sending" info to the log;</span><br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;...<br><br>};<br></p>
<p class="noindent"><a id="page_209"></a>Note how the message-sending function in the derived class has a different name (<code>sendClearMsg</code>) from the one in its base class (there, it's called <code>sendClear</code>). That's good design, because it side-steps the issue of hiding inherited names (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec2">Item 33</a>) as well as the problems inherent in redefining an inherited non-virtual function (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec5">Item 36</a>). But the code above won't compile, at least not with conformant compilers. Such compilers will complain that <code>sendClear</code> doesn't exist. We can see that <code>sendClear</code> is in the base class, but compilers won't look for it there. We need to understand why.</p>
<p class="noindent">The problem is that when compilers encounter the definition for the class template <code>LoggingMsgSender</code>, they don't know what class it inherits from. Sure, it's <code>MsgSender&lt;Company&gt;</code>, but <code>Company</code> is a template parameter, one that won't be known until later (when <code>LoggingMsgSender</code> is instantiated). Without knowing what <code>Company</code> is, there's no way to know what the class <code>MsgSender&lt;Company&gt;</code> looks like. In particular, there's no way to know if it has a <code>sendClear</code> function.</p>
<p class="noindent">To make the problem concrete, suppose we have a class <code>CompanyZ</code> that insists on encrypted communications:</p>
<p class="codelink"><a id="procode281"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode281">Click here to view code image</a></p>
<p class="programlisting"><br>class CompanyZ {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this class offers no<br>public:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// sendCleartext function<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void sendEncrypted(const std::string&amp; msg);<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">The general <code>MsgSender</code> template is inappropriate for <code>CompanyZ</code>, because that template offers a <code>sendClear</code> function that makes no sense for <code>CompanyZ</code> objects. To rectify that problem, we can create a specialized version of <code>MsgSender</code> for <code>CompanyZ</code>:</p>
<p class="codelink"><a id="procode282"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode282">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">template&lt;&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// a <span class="courieri">total specialization</span> of<br><span class="courierb">class MsgSender&lt;CompanyZ&gt;</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// MsgSender; the same as the<br>public:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// general template, except<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// sendCleartext is omitted<br>&nbsp;&nbsp;void sendSecret(const MsgInfo&amp; info)<br>&nbsp;&nbsp;{ ... }<br>};<br></p>
<p class="noindent">Note the “<code>template &lt;&gt;</code>” syntax at the beginning of this class definition. It signifies that this is neither a template nor a standalone class. Rather, it's a specialized version of the <code>MsgSender</code> template to be used when the template argument is <code>CompanyZ</code>. This is known as a <em>total template specialization</em>: the template <code>MsgSender</code> is specialized for the type <code>CompanyZ</code>, and the specialization is <em>total</em> — once the type parameter <a id="page_210"></a>has been defined to be <code>CompanyZ</code>, no other aspect of the template's parameters can vary.</p>
<p class="noindent">Given that <code>MsgSender</code> has been specialized for <code>CompanyZ</code>, consider again the derived class <code>LoggingMsgSender</code>:</p>
<p class="codelink"><a id="procode283"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode283">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename Company&gt;<br>class LoggingMsgSender: public MsgSender&lt;Company&gt; {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void sendClearMsg(const MsgInfo&amp; info)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courieri">write "before sending" info to the log;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">sendClear(info);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if Company == CompanyZ,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this function doesn't exist!<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courieri">write "after sending" info to the log;</span><br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;...<br><br>};<br></p>
<p class="noindent">As the comment notes, this code makes no sense when the base class is <code>MsgSender&lt;CompanyZ&gt;</code>, because that class offers no <code>sendClear</code> function. That's why C++ rejects the call: it recognizes that base class templates may be specialized and that such specializations may not offer the same interface as the general template. As a result, it generally refuses to look in templatized base classes for inherited names. In some sense, when we cross from Object-oriented C++ to Template C++ (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec1">Item 1</a>), inheritance stops working.</p>
<p class="noindent">To restart it, we have to somehow disable C++'s “don't look in templatized base classes” behavior. There are three ways to do this. First, you can preface calls to base class functions with “<code>this-&gt;</code>”:</p>
<p class="codelink"><a id="procode284"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode284">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename Company&gt;<br>class LoggingMsgSender: public MsgSender&lt;Company&gt; {<br>public:<br><br>&nbsp;&nbsp;...<br><br>&nbsp;&nbsp;void sendClearMsg(const MsgInfo&amp; info)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courieri">write "before sending" info to the log;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">this-&gt;</span>sendClear(info);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// okay, assumes that<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// sendClear will be inherited<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courieri">write "after sending" info to the log;</span><br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;...<br><br>};<br></p>
<p class="noindent"><a id="page_211"></a>Second, you can employ a <code>using</code> declaration, a solution that should strike you as familiar if you've read <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec2">Item 33</a>. That Item explains how <code>using</code> declarations bring hidden base class names into a derived class's scope. We can therefore write <code>sendClearMsg</code> like this:</p>
<p class="codelink"><a id="procode285"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode285">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename Company&gt;<br>class LoggingMsgSender: public MsgSender&lt;Company&gt; {<br>public:<br>&nbsp;&nbsp;<span class="courierb">using MsgSender&lt;Company&gt;::sendClear;</span>&nbsp;&nbsp;&nbsp;// tell compilers to assume<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// that sendClear is in the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// base class<br>&nbsp;&nbsp;void sendClearMsg(const MsgInfo&amp; info)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;&nbsp;&nbsp;sendClear(info);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// okay, assumes that<br>&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// sendClear will be inherited<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">(Although a <code>using</code> declaration will work both here and in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec2">Item 33</a>, the problems being solved are different. Here, the situation isn't that base class names are hidden by derived class names, it's that compilers don't search base class scopes unless we tell them to.)</p>
<p class="noindent">A final way to get your code to compile is to explicitly specify that the function being called is in the base class:</p>
<p class="codelink"><a id="procode286"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode286">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename Company&gt;<br>class LoggingMsgSender: public MsgSender&lt;Company&gt; {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void sendClearMsg(const MsgInfo&amp; info)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">MsgSender&lt;Company&gt;::</span>sendClear(info);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// okay, assumes that<br>&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// sendClear will be<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//inherited<br><br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">This is generally the least desirable way to solve the problem, because if the function being called is virtual, explicit qualification turns off the virtual binding behavior.</p>
<p class="noindent">From a name visibility point of view, each of these approaches does the same thing: it promises compilers that any subsequent specializations of the base class template will support the interface offered by the general template. Such a promise is all compilers need when they parse a derived class template like <code>LoggingMsgSender</code>, but if the promise <a id="page_212"></a>turns out to be unfounded, the truth will emerge during subsequent compilation. For example, if the source code later contains this,</p>
<p class="codelink"><a id="procode287"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode287">Click here to view code image</a></p>
<p class="programlisting"><br>LoggingMsgSender&lt;CompanyZ&gt; zMsgSender;<br><br>MsgInfo msgData;<br><br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// put info in msgData<br><br><span class="courierb">zMsgSender.sendClearMsg(msgData);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// error! won't compile<br></p>
<p class="noindent">the call to <code>sendClearMsg</code> won't compile, because at this point, compilers know that the base class is the template specialization <code>MsgSender&lt;CompanyZ&gt;</code>, and they know that class doesn't offer the <code>sendClear</code> function that <code>sendClearMsg</code> is trying to call.</p>
<p class="noindent">Fundamentally, the issue is whether compilers will diagnose invalid references to base class members sooner (when derived class template definitions are parsed) or later (when those templates are instantiated with specific template arguments). C++'s policy is to prefer early diagnoses, and that's why it assumes it knows nothing about the contents of base classes when those classes are instantiated from templates.</p>
<div class="note">
<h3 id="ch07note03">Things to Remember</h3>
<p class="indenthanding">• In derived class templates, refer to names in base class templates via a “<code>this-&gt;</code>” prefix, via <code>using</code> declarations, or via an explicit base class qualification.</p>
</div>
<h3 id="ch07lev1sec4">Item 44: Factor parameter-independent code out of templates</h3>
<p class="noindent">Templates are a wonderful way to save time and avoid code replication. Instead of typing 20 similar classes, each with 15 member functions, you type one class template, and you let compilers instantiate the 20 specific classes and 300 functions you need. (Member functions of class templates are implicitly instantiated only when used, so you should get the full 300 member functions only if each is actually used.) Function templates are similarly appealing. Instead of writing many functions, you write one function template and let the compilers do the rest. Ain't technology grand?</p>
<p class="noindent">Yes, well...sometimes. If you're not careful, using templates can lead to <em>code bloat</em>: binaries with replicated (or almost replicated) code, data, or both. The result can be source code that looks fit and trim, yet object code that's fat and flabby. Fat and flabby is rarely fashionable, so you need to know how to avoid such binary bombast.</p>
<p class="noindent">Your primary tool has the imposing name <em>commonality and variability analysis</em>, but there's nothing imposing about the idea. Even if you've <a id="page_213"></a>never written a template in your life, you do such analysis all the time.</p>
<p class="noindent">When you're writing a function and you realize that some part of the function's implementation is essentially the same as another function's implementation, do you just replicate the code? Of course not. You factor the common code out of the two functions, put it into a third function, and have both of the other functions call the new one. That is, you analyze the two functions to find the parts that are common and those that vary, you move the common parts into a new function, and you keep the varying parts in the original functions. Similarly, if you're writing a class and you realize that some parts of the class are the same as parts of another class, you don't replicate the common parts. Instead, you move the common parts to a new class, then you use inheritance or composition (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec1">Items 32</a>, <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec7">38</a>, and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec8">39</a>) to give the original classes access to the common features. The parts of the original classes that differ — the varying parts — remain in their original locations.</p>
<p class="noindent">When writing templates, you do the same analysis, and you avoid replication in the same ways, but there's a twist. In non-template code, replication is explicit: you can <em>see</em> that there's duplication between two functions or two classes. In template code, replication is implicit: there's only one copy of the template source code, so you have to train yourself to sense the replication that may take place when a template is instantiated multiple times.</p>
<p class="noindent">For example, suppose you'd like to write a template for fixed-size square matrices that, among other things, support matrix inversion.</p>
<p class="codelink"><a id="procode288"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode288">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// template for n x n matrices of<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::size_t n&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// objects of type T; see below for info<br>class SquareMatrix {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// on the size_t parameter<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void invert();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// invert the matrix in place<br>};<br></p>
<p class="noindent">This template takes a type parameter, <code>T</code>, but it also takes a parameter of type <code>size_t</code> — a <em>non-type parameter</em>. Non-type parameters are less common than type parameters, but they're completely legal, and, as in this example, they can be quite natural.</p>
<p class="noindent">Now consider this code:</p>
<p class="codelink"><a id="procode289"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode289">Click here to view code image</a></p>
<p class="programlisting"><br>SquareMatrix&lt;double, 5&gt; sm1;<br>...<br>sm1.<span class="courierb">invert();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call SquareMatrix&lt;double, 5&gt;::invert<br><br>SquareMatrix&lt;double, 10&gt; sm2;<br>...<br>sm2.<span class="courierb">invert</span>();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call SquareMatrix&lt;double, 10&gt;::invert<br></p>
<p class="noindent"><a id="page_214"></a>Two copies of <code>invert</code> will be instantiated here. The functions won't be identical, because one will work on 5×5 matrices and one will work on 10 × 10 matrices, but other than the constants 5 and 10, the two functions will be the same. This is a classic way for template-induced code bloat to arise.</p>
<p class="noindent">What would you do if you saw two functions that were character-for-character identical except for the use of 5 in one version and 10 in the other? Your instinct would be to create a version of the function that took a value as a parameter, then call the parameterized function with 5 or 10 instead of replicating the code. Your instinct serves you well! Here's a first pass at doing that for <code>SquareMatrix</code>:</p>
<p class="codelink"><a id="procode290"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode290">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">template&lt;typename T&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// size-independent base class for<br><span class="courierb">class SquareMatrixBase {</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// square matrices<br><span class="courierb">protected:</span><br>&nbsp;&nbsp;<span class="courierb">...</span><br>&nbsp;&nbsp;<span class="courierb">void invert(std::size_t matrixSize);</span> // invert matrix of the given size<br>&nbsp;&nbsp;<span class="courierb">...</span><br><span class="courierb">}</span>;<br><br>template&lt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typename T, std::size_t n&gt;<br>class SquareMatrix<span class="courierb">: private SquareMatrixBase&lt;T&gt;</span> {<br>private:<br>&nbsp;&nbsp;using SquareMatrixBase&lt;T&gt;::invert;&nbsp;&nbsp;&nbsp;// avoid hiding base version of<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// invert; see Item 33<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void invert() <span class="courierb">{ this-&gt;invert(n); }</span>&nbsp;&nbsp;&nbsp;// make inline call to base class<br>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// version of invert; see below<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for why "this-&gt;" is here<br></p>
<p class="noindent">As you can see, the parameterized version of <code>invert</code> is in a base class, <code>SquareMatrixBase</code>. Like <code>SquareMatrix</code>, <code>SquareMatrixBase</code> is a template, but unlike <code>SquareMatrix</code>, it's templatized only on the type of objects in the matrix, not on the size of the matrix. Hence, all matrices holding a given type of object will share a single <code>SquareMatrixBase</code> class. They will thus share a single copy of that class's version of <code>invert</code>.</p>
<p class="noindent"><code>SquareMatrixBase::invert</code> is intended only to be a way for derived classes to avoid code replication, so it's <code>protected</code> instead of being <code>public</code>. The additional cost of calling it should be zero, because derived classes' <code>invert</code>s call the base class version using inline functions. (The <code>inline</code> is implicit — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec5">Item 30</a>.) These functions use the “<code>this-&gt;</code>” notation, because otherwise, as <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec3">Item 43</a> explains, function names in templatized base classes (such as <code>SquareMatrixBase&lt;T&gt;</code>) are hidden from derived classes. Notice also that the inheritance between <code>SquareMatrix</code> and <code>SquareMatrixBase</code> is <code>private</code>. This accurately reflects the fact that the reason for the base class is only to facilitate the derived classes' implementations, not to express a conceptual is-a relationship <a id="page_215"></a>between <code>SquareMatrix</code> and <code>SquareMatrixBase</code>. (For information on private inheritance, see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec8">Item 39</a>.)</p>
<p class="noindent">So far, so good, but there's a sticky issue we haven't addressed yet. How does <code>SquareMatrixBase::invert</code> know what data to operate on? It knows the size of the matrix from its parameter, but how does it know where the data for a particular matrix is? Presumably only the derived class knows that. How does the derived class communicate that to the base class so that the base class can do the inversion?</p>
<p class="noindent">One possibility would be to add another parameter to <code>SquareMatrixBase::invert</code>, perhaps a pointer to the beginning of a chunk of memory with the matrix's data in it. That would work, but in all likelihood, <code>invert</code> is not the only function in <code>SquareMatrix</code> that can be written in a size-independent manner and moved into <code>SquareMatrixBase</code>. If there are several such functions, all will need a way to find the memory holding the values in the matrix. We could add an extra parameter to all of them, but we'd be telling <code>SquareMatrixBase</code> the same information repeatedly. That seems wrong.</p>
<p class="noindent">An alternative is to have <code>SquareMatrixBase</code> store a pointer to the memory for the matrix values. And as long as it's storing that, it might as well store the matrix size, too. The resulting design looks like this:</p>
<p class="codelink"><a id="procode291"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode291">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class SquareMatrixBase {<br>protected:<br>&nbsp;&nbsp;<span class="courierb">SquareMatrixBase(std::size_t n, T *pMem)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// store matrix size and a<br>&nbsp;&nbsp;<span class="courierb">: size(n), pData(pMem) {}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ptr to matrix values<br><br>&nbsp;&nbsp;<span class="courierb">void setDataPtr(T *ptr) { pData = ptr; }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// reassign pData<br>&nbsp;&nbsp;...<br><br><span class="courierb">private:</span><br>&nbsp;&nbsp;<span class="courierb">std::size_t size;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// size of matrix<br><br>&nbsp;&nbsp;<span class="courierb">T *pData;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// pointer to matrix values<br>};<br></p>
<p class="noindent">This lets derived classes decide how to allocate the memory. Some implementations might decide to store the matrix data right inside the <code>SquareMatrix</code> object:</p>
<p class="codelink"><a id="procode292"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode292">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T, std::size_t n&gt;<br>class SquareMatrix: private SquareMatrixBase&lt;T&gt; {<br>public:<br>&nbsp;&nbsp;<span class="courierb">SquareMatrix()</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// send matrix size and<br>&nbsp;&nbsp;<span class="courierb">: SquareMatrixBase&lt;T&gt;(n, data) {}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// data ptr to base class<br>&nbsp;&nbsp;...<br><br><span class="courierb">private:</span><br>&nbsp;&nbsp;<span class="courierb">T data[n*n];</span><br>};<br></p>
<p class="noindent"><a id="page_216"></a>Objects of such types have no need for dynamic memory allocation, but the objects themselves could be very large. An alternative would be to put the data for each matrix on the heap:</p>
<p class="codelink"><a id="procode293"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode293">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T, std::size_t n&gt;<br>class SquareMatrix: private SquareMatrixBase&lt;T&gt; {<br>public:<br>&nbsp;&nbsp;<span class="courierb">SquareMatrix()</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// set base class data ptr to null,<br>&nbsp;&nbsp;<span class="courierb">: SquareMatrixBase&lt;T&gt;(n, 0),</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// allocate memory for matrix<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">pData(new T[n*n])</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// values, save a ptr to the<br>&nbsp;&nbsp;<span class="courierb">{ this-&gt;setDataPtr(pData.get()); }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// memory, and give a copy of it<br>&nbsp;&nbsp;<span class="courierb">...</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// to the base class<br><br><span class="courierb">private:</span><br>&nbsp;&nbsp;<span class="courierb">boost::scoped_array&lt;T&gt; pData;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 13 for info on<br>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// boost::scoped_array<br></p>
<p class="noindent">Regardless of where the data is stored, the key result from a bloat point of view is that now many — maybe all — of <code>SquareMatrix</code>'s member functions can be simple inline calls to base class versions that are shared with all other matrices holding the same type of data, regardless of their size. At the same time, <code>SquareMatrix</code> objects of different sizes are distinct types, so even though, e.g., <code>SquareMatrix&lt;double, 5&gt;</code> and <code>SquareMatrix&lt;double, 10&gt;</code> objects use the same member functions in <code>SquareMatrixBase&lt;double&gt;</code>, there's no chance of passing a <code>SquareMatrix&lt;double, 5&gt; object</code> to a function expecting a <code>SquareMatrix&lt;double, 10&gt;</code>. Nice, no?</p>
<p class="noindent">Nice, yes, but not free. The versions of <code>invert</code> with the matrix sizes hardwired into them are likely to generate better code than the shared version where the size is passed as a function parameter or is stored in the object. For example, in the size-specific versions, the sizes would be compile-time constants, hence eligible for such optimizations as constant propagation, including their being folded into the generated instructions as immediate operands. That can't be done in the size-independent version.</p>
<p class="noindent">On the other hand, having only one version of <code>invert</code> for multiple matrix sizes decreases the size of the executable, and that could reduce the program's working set size and improve locality of reference in the instruction cache. Those things could make the program run faster, more than compensating for any lost optimizations in size-specific versions of <code>invert</code>. Which effect would dominate? The only way to know is to try it both ways and observe the behavior on your particular platform and on representative data sets.</p>
<p class="noindent">Another efficiency consideration concerns the sizes of objects. If you're not careful, moving size-independent versions of functions up into a base class can increase the overall size of each object. For <a id="page_217"></a>example, in the code I just showed, each <code>SquareMatrix</code> object has a pointer to its data in the <code>SquareMatrixBase</code> class, even though each derived class already has a way to get to the data. This increases the size of each <code>SquareMatrix</code> object by at least the size of a pointer. It's possible to modify the design so that these pointers are unnecessary, but, again, there are trade-offs. For example, having the base class store a <code>protected</code> pointer to the matrix data leads to the loss of encapsulation described in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec5">Item 22</a>. It can also lead to resource management complications: if the base class stores a pointer to the matrix data, but that data may have been either dynamically allocated or physically stored inside the derived class object (as we saw), how will it be determined whether the pointer should be deleted? Such questions have answers, but the more sophisticated you try to be about them, the more complicated things become. At some point, a little code replication begins to look like a mercy.</p>
<p class="noindent">This Item has discussed only bloat due to non-type template parameters, but type parameters can lead to bloat, too. For example, on many platforms, <code>int</code> and <code>long</code> have the same binary representation, so the member functions for, say, <code>vector&lt;int&gt;</code> and <code>vector&lt;long&gt;</code> would likely be identical — the very definition of bloat. Some linkers will merge identical function implementations, but some will not, and that means that some templates instantiated on both <code>int</code> and <code>long</code> could cause code bloat in some environments. Similarly, on most platforms, all pointer types have the same binary representation, so templates holding pointer types (e.g., <code>list&lt;int*&gt;</code>, <code>list&lt;const int*&gt;</code>, <code>list&lt;SquareMatrix&lt;long, 3&gt;*&gt;</code>, etc.) should often be able to use a single underlying implementation for each member function. Typically, this means implementing member functions that work with strongly typed pointers (i.e., <code>T*</code> pointers) by having them call functions that work with untyped pointers (i.e., <code>void*</code> pointers). Some implementations of the standard C++ library do this for templates like <code>vector</code>, <code>deque</code>, and <code>list</code>. If you're concerned about code bloat arising in your templates, you'll probably want to develop templates that do the same thing.</p>
<div class="note">
<h3 id="ch07note04">Things to Remember</h3>
<p class="indenthanding">• Templates generate multiple classes and multiple functions, so any template code not dependent on a template parameter causes bloat.</p>
<p class="indenthanding">• Bloat due to non-type template parameters can often be eliminated by replacing template parameters with function parameters or class data members.</p>
<p class="indenthanding">• Bloat due to type parameters can be reduced by sharing implementations for instantiation types with identical binary representations.</p>
</div>
<h3 id="ch07lev1sec5">Item 45: Use member function templates to accept “all compatible types.”</h3>
<p class="noindent"><a id="page_218"></a><em>Smart pointers</em> are objects that act much like pointers but add functionality pointers don't provide. For example, <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a> explains how the standard <code>auto_ptr</code> and <code>tr1::shared_ptr</code> can be used to automatically delete heap-based resources at the right time. Iterators into STL containers are almost always smart pointers; certainly you couldn't expect to move a built-in pointer from one node in a linked list to the next by using “<code>++</code>,” yet that works for <code>list::iterator</code>s.</p>
<p class="noindent">One of the things that real pointers do well is support implicit conversions. Derived class pointers implicitly convert into base class pointers, pointers to non-<code>const</code> objects convert into pointers to <code>const</code> objects, etc. For example, consider some conversions that can occur in a three-level hierarchy:</p>
<p class="codelink"><a id="procode294"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode294">Click here to view code image</a></p>
<p class="programlisting"><br>class Top { ... };<br>class Middle: public Top { ... };<br>class Bottom: public Middle { ... };<br>Top *pt1 = new Middle;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// convert Middle* ⇒Top*<br>Top *pt2 = new Bottom;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// convert Bottom* ⇒Top*<br>const Top *pct2 = pt1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// convert Top* ⇒ const Top*<br></p>
<p class="noindent">Emulating such conversions in user-defined smart pointer classes is tricky. We'd need the following code to compile:</p>
<p class="codelink"><a id="procode295"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode295">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class SmartPtr {<br>public:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// smart pointers are typically<br>&nbsp;&nbsp;explicit SmartPtr(T *realPtr);&nbsp;&nbsp;&nbsp;&nbsp;// initialized by built-in pointers<br>&nbsp;&nbsp;...<br>};<br><br>SmartPtr&lt;Top&gt; pt1 =&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// convert SmartPtr&lt;Middle&gt; ⇒<br>&nbsp;&nbsp;SmartPtr&lt;Middle&gt;(new Middle);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;SmartPtr&lt;Top&gt;<br><br>SmartPtr&lt;Top&gt; pt2 =&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// convert SmartPtr&lt;Bottom&gt; ⇒<br>&nbsp;&nbsp;SmartPtr&lt;Bottom&gt;(new Bottom);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;SmartPtr&lt;Top&gt;<br><br>SmartPtr&lt;const Top&gt; pct2 = pt1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// convert SmartPtr&lt;Top&gt; ⇒<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;SmartPtr&lt;const Top&gt;<br></p>
<p class="noindent">There is no inherent relationship among different instantiations of the same template, so compilers view <code>SmartPtr&lt;Middle&gt;</code> and <code>SmartPtr&lt;Top&gt;</code> as completely different classes, no more closely related than, say, <code>vector&lt;float&gt;</code> and <code>Widget</code>. To get the conversions among <code>SmartPtr</code> classes that we want, we have to program them explicitly.</p>
<p class="noindent"><a id="page_219"></a>In the smart pointer sample code above, each statement creates a new smart pointer object, so for now we'll focus on how to write smart pointer constructors that behave the way we want. A key observation is that there is no way to write out all the constructors we need. In the hierarchy above, we can construct a <code>SmartPtr&lt;Top&gt;</code> from a <code>SmartPtr&lt;Middle&gt;</code> or a <code>SmartPtr&lt;Bottom&gt;</code>, but if the hierarchy is extended in the future, <code>SmartPtr&lt;Top&gt;</code> objects will have to be constructible from other smart pointer types. For example, if we later add</p>
<p class="programlisting"><br>class BelowBottom: public Bottom { ... };<br></p>
<p class="noindent">we'll need to support the creation of <code>SmartPtr&lt;Top&gt;</code> objects from <code>SmartPtr&lt;BelowBottom&gt;</code> objects, and we certainly won't want to have to modify the <code>SmartPtr</code> template to do it.</p>
<p class="noindent">In principle, the number of constructors we need is unlimited. Since a template can be instantiated to generate an unlimited number of functions, it seems that we don't need a constructor <em>function</em> for <code>SmartPtr</code>, we need a constructor <em>template</em>. Such templates are examples of <em>member function templates</em> (often just known as <em>member templates</em>) — templates that generate member functions of a class:</p>
<p class="codelink"><a id="procode296"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode296">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class SmartPtr {<br>public:<br>&nbsp;&nbsp;<span class="courierb">template&lt;typename U&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// member template<br>&nbsp;&nbsp;<span class="courierb">SmartPtr(const SmartPtr&lt;U&gt;&amp; other);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for a "generalized<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy constructor"<br>};<br></p>
<p class="noindent">This says that for every type <code>T</code> and every type <code>U</code>, a <code>SmartPtr&lt;T&gt;</code> can be created from a <code>SmartPtr&lt;U&gt;</code>, because <code>SmartPtr&lt;T&gt;</code> has a constructor that takes a <code>SmartPtr&lt;U&gt;</code> parameter. Constructors like this — ones that create one object from another object whose type is a different instantiation of the same template (e.g., create a <code>SmartPtr&lt;T&gt;</code> from a <code>SmartPtr&lt;U&gt;</code>) — are sometimes known as <em>generalized copy constructors</em>.</p>
<p class="noindent">The generalized copy constructor above is not declared <code>explicit</code>. That's deliberate. Type conversions among built-in pointer types (e.g., from derived to base class pointers) are implicit and require no cast, so it's reasonable for smart pointers to emulate that behavior. Omitting <code>explicit</code> on the templatized constructor does just that.</p>
<p class="noindent">As declared, the generalized copy constructor for <code>SmartPtr</code> offers more than we want. Yes, we want to be <a id="page_220"></a>able to create a <code>SmartPtr&lt;Top&gt;</code> from a <code>SmartPtr&lt;Bottom&gt;</code>, but we don't want to be able to create a <code>SmartPtr&lt;Bottom&gt;</code> from a <code>SmartPtr&lt;Top&gt;</code>, as that's contrary to the meaning of public inheritance (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec1">Item 32</a>). We also don't want to be able to create a <code>SmartPtr&lt;int&gt;</code> from a <code>SmartPtr&lt;double&gt;</code>, because there is no corresponding implicit conversion from <code>double*</code> to <code>int*</code>. Somehow, we have to cull the herd of member functions that this member template will generate.</p>
<p class="noindent">Assuming that <code>SmartPtr</code> follows the lead of <code>auto_ptr</code> and <code>tr1::shared_ptr</code> by offering a <code>get</code> member function that returns a copy of the built-in pointer held by the smart pointer object (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec3">Item 15</a>), we can use the implementation of the constructor template to restrict the conversions to those we want:</p>
<p class="codelink"><a id="procode297"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode297">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class SmartPtr {<br>public:<br>&nbsp;&nbsp;template&lt;typename U&gt;<br>&nbsp;&nbsp;SmartPtr(const SmartPtr&lt;U&gt;&amp; other)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// initialize this held ptr<br>&nbsp;&nbsp;<span class="courierb">: heldPtr(other.get())</span> { ... }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// with other's held ptr<br><br>&nbsp;&nbsp;<span class="courierb">T* get() const { return heldPtr; }</span><br>&nbsp;&nbsp;...<br><br><span class="courierb">private:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// built-in pointer held<br>&nbsp;&nbsp;<span class="courierb">T *heldPtr;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// by the SmartPtr<br>};<br></p>
<p class="noindent">We use the member initialization list to initialize <code>SmartPtr&lt;T&gt;</code>'s data member of type <code>T*</code> with the pointer of type <code>U*</code> held by the <code>SmartPtr&lt;U&gt;</code>. This will compile only if there is an implicit conversion from a <code>U*</code> pointer to a <code>T*</code> pointer, and that's precisely what we want. The net effect is that <code>SmartPtr&lt;T&gt;</code> now has a generalized copy constructor that will compile only if passed a parameter of a compatible type.</p>
<p class="noindent">The utility of member function templates isn't limited to constructors. Another common role for them is in support for assignment. For example, TR1's <code>shared_ptr</code> (again, see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>) supports construction from all compatible built-in pointers, <code>tr1::shared_ptr</code>s, <code>auto_ptr</code>s, and <code>tr1::weak_ptr</code>s (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>), as well as assignment from all of those except <code>tr1::weak_ptr</code>s. Here's an excerpt from TR1's specification for <code>tr1::shared_ptr</code>, including its penchant for using <code>class</code> instead of <code>typename</code></p>
<p class="noindent">when declaring template parameters. (As <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec2">Item 42</a> explains, they mean exactly the same thing in this context.)</p>
<p class="codelink"><a id="procode298"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode298">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;class T&gt; class shared_ptr {<br>public:<br>&nbsp;&nbsp;template&lt;class Y&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// construct from<br>&nbsp;&nbsp;&nbsp;&nbsp;explicit shared_ptr(Y * p);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// any compatible<br>&nbsp;&nbsp;template&lt;class Y&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// built-in pointer,<br>&nbsp;&nbsp;&nbsp;&nbsp;shared_ptr(shared_ptr&lt;Y&gt; const&amp; r);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// shared_ptr,<br>&nbsp;&nbsp;template&lt;class Y&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// weak_ptr, or<br>&nbsp;&nbsp;&nbsp;&nbsp;explicit shared_ptr(weak_ptr&lt;Y&gt; const&amp; r);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// auto_ptr<br>&nbsp;&nbsp;template&lt;class Y&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;explicit shared_ptr(auto_ptr&lt;Y&gt;&amp; r);<br><br><a id="page_221"></a>&nbsp;&nbsp;template&lt;class Y&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// assign from<br>&nbsp;&nbsp;&nbsp;&nbsp;shared_ptr&amp; operator=(shared_ptr&lt;Y&gt; const&amp; r);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// any compatible<br>&nbsp;&nbsp;template&lt;class Y&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// shared_ptr or<br>&nbsp;&nbsp;&nbsp;&nbsp;shared_ptr&amp; operator=(auto_ptr&lt;Y&gt;&amp; r);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// auto_ptr<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">All these constructors are <code>explicit</code>, except the generalized copy constructor. That means that implicit conversion from one type of <code>shared_ptr</code> to another is allowed, but <em>implicit</em> conversion from a built-in pointer or other smart pointer type is not permitted. (<em>Explicit</em> conversion — e.g., via a cast — is okay.) Also interesting is how the <code>auto_ptr</code>s passed to <code>tr1::shared_ptr</code> constructors and assignment operators aren't declared <code>const</code>, in contrast to how the <code>tr1::shared_ptr</code>s and <code>tr1::weak_ptr</code>s are passed. That's a consequence of the fact that <code>auto_ptr</code>s stand alone in being modified when they're copied (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>).</p>
<p class="noindent">Member function templates are wonderful things, but they don't alter the basic rules of the language. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec1">Item 5</a> explains that two of the four member functions that compilers may generate are the copy constructor and the copy assignment operator. <code>tr1::shared_ptr</code> declares a generalized copy constructor, and it's clear that when the types <code>T</code> and <code>Y</code> are the same, the generalized copy constructor could be instantiated to create the “normal” copy constructor. So will compilers generate a copy constructor for <code>tr1::shared_ptr</code>, or will they instantiate the generalized copy constructor template when one <code>tr1::shared_ptr</code> object is constructed from another <code>tr1::shared_ptr</code> object of the same type?</p>
<p class="noindent">As I said, member templates don't change the rules of the language, and the rules state that if a copy constructor is needed and you don't declare one, one will be generated for you automatically. Declaring a generalized copy constructor (a member template) in a class doesn't keep compilers from generating their own copy constructor (a non-template), so if you want to control all aspects of copy construction, you must declare both a generalized copy constructor as well as the “normal” copy constructor. The same applies to assignment. Here's an excerpt from <code>tr1::shared_ptr</code>'s definition that exemplifies this:</p>
<p class="codelink"><a id="procode299"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode299">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;class T&gt; class shared_ptr {<br>public:<br>&nbsp;&nbsp;<span class="courierb">shared_ptr(shared_ptr const&amp; r);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy constructor<br><br>&nbsp;&nbsp;<span class="courierb">template&lt;class Y&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// generalized<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">shared_ptr(shared_ptr&lt;Y&gt; const&amp; r);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy constructor<br><br>&nbsp;&nbsp;<span class="courierb">shared_ptr&amp; operator=(shared_ptr const&amp; r);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy assignment<br><br>&nbsp;&nbsp;<span class="courierb">template&lt;class Y&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// generalized<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">shared_ptr&amp; operator=(shared_ptr&lt;Y&gt; const&amp; r);</span> // copy assignment<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent"><a id="page_222"></a></p>
<div class="note">
<h3 id="ch07note05">Things to Remember</h3>
<p class="indenthanding">• Use member function templates to generate functions that accept all compatible types.</p>
<p class="indenthanding">• If you declare member templates for generalized copy construction or generalized assignment, you'll still need to declare the normal copy constructor and copy assignment operator, too.</p>
</div>
<h3 id="ch07lev1sec6">Item 46: Define non-member functions inside templates when type conversions are desired</h3>
<p class="noindent"><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec7">Item 24</a> explains why only non-member functions are eligible for implicit type conversions on all arguments, and it uses as an example the <code>operator*</code> function for a <code>Rational</code> class. I recommend you familiarize yourself with that example before continuing, because this Item extends the discussion with a seemingly innocuous modification to <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec7">Item 24</a>'s example: it templatizes both <code>Rational</code> and <code>operator*</code>:</p>
<p class="codelink"><a id="procode300"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode300">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">template&lt;typename T&gt;</span><br>class Rational {<br>public:<br>&nbsp;&nbsp;Rational(<span class="courierb">const T&amp;</span> numerator = 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 20 for why params<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">const T&amp;</span> denominator = 1);&nbsp;&nbsp;// are now passed by reference<br><br>&nbsp;&nbsp;<span class="courierb">const T</span> numerator() const;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 28 for why return<br>&nbsp;&nbsp;<span class="courierb">const T</span> denominator() const;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// values are still passed by value,<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Item 3 for why they're const<br>};<br><br><span class="courierb">template&lt;typename T&gt;</span><br>const Rational<span class="courierb">&lt;T&gt;</span> operator*(const Rational<span class="courierb">&lt;T&gt;</span>&amp; lhs,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Rational<span class="courierb">&lt;T&gt;</span>&amp; rhs)<br>{ ... }<br></p>
<p class="noindent">As in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec7">Item 24</a>, we want to support mixed-mode arithmetic, so we want the code below to compile. We expect that it will, because we're using the same code that works in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec7">Item 24</a>. The only difference is that <code>Rational</code> and operator<code>*</code> are now templates:</p>
<p class="codelink"><a id="procode301"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode301">Click here to view code image</a></p>
<p class="programlisting"><br>Rational<span class="courierb">&lt;int&gt;</span> oneHalf(1, 2);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this example is from Item 24,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// except Rational is now a template<br><br>Rational<span class="courierb">&lt;int&gt;</span> result = oneHalf * 2;&nbsp;&nbsp;&nbsp;// error! won't compile<br></p>
<p class="noindent">The fact that this fails to compile suggests that there's something about the templatized <code>Rational</code> that's different from the non-template version, and indeed there is. In <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec7">Item 24</a>, compilers know what function we're trying to call (<code>operator*</code> taking two <code>Rational</code>s), but here, compilers do <em>not</em> know which function we want to call. Instead, they're <a id="page_223"></a>trying to <em>figure out</em> what function to instantiate (i.e., create) from the template named <code>operator*</code>. They know that they're supposed to instantiate some function named <code>operator*</code> taking two parameters of type <code>Rational&lt;T&gt;</code>, but in order to do the instantiation, they have to figure out what <code>T</code> is. The problem is, they can't.</p>
<p class="noindent">In attempting to deduce <code>T</code>, they look at the types of the arguments being passed in the call to <code>operator*</code>. In this case, those types are <code>Rational&lt;int&gt;</code> (the type of <code>oneHalf</code>) and <code>int</code> (the type of 2). Each parameter is considered separately.</p>
<p class="noindent">The deduction using <code>oneHalf</code> is easy. <code>operator*</code>'s first parameter is declared to be of type <code>Rational&lt;T&gt;</code>, and the first argument passed to <code>operator*</code> (<code>oneHalf</code>) is of type <code>Rational&lt;int&gt;</code>, so <code>T</code> must be <code>int</code>. Unfortunately, the deduction for the other parameter is not so simple. <code>operator*</code>'s second parameter is declared to be of type <code>Rational&lt;T&gt;</code>, but the second argument passed to <code>operator*</code> (2) is of type <code>int</code>. How are compilers to figure out what <code>T</code> is in this case? You might expect them to use <code>Rational&lt;int&gt;</code>'s non-<code>explicit</code> constructor to convert 2 into a <code>Rational&lt;int&gt;</code>, thus allowing them to deduce that <code>T</code> is <code>int</code>, but they don't do that. They don't, because implicit type conversion functions are <em>never</em> considered during template argument deduction. Never. Such conversions are used during function calls, yes, but before you can call a function, you have to know which functions exist. In order to know that, you have to deduce parameter types for the relevant function templates (so that you can instantiate the appropriate functions). But implicit type conversion via constructor calls is not considered during template argument deduction. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec7">Item 24</a> involves no templates, so template argument deduction is not an issue. Now that we're in the template part of C++ (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec1">Item 1</a>), it's the primary issue.</p>
<p class="noindent">We can relieve compilers of the challenge of template argument deduction by taking advantage of the fact that a <code>friend</code> declaration in a template class can refer to a specific function. That means the class <code>Rational&lt;T&gt;</code> can declare <code>operator*</code> for <code>Rational&lt;T&gt;</code> as a friend function. Class templates don't depend on template argument deduction (that process applies only to function templates), so <code>T</code> is always known at the time the class <code>Rational&lt;T&gt;</code> is instantiated. That makes it easy for the <code>Rational&lt;T&gt;</code> class to declare the appropriate <code>operator*</code> function as a friend:</p>
<p class="codelink"><a id="procode302"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode302">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class Rational {<br>public:<br>&nbsp;&nbsp;...<br><br><a id="page_224"></a><span class="courierb">friend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// declare operator*<br>&nbsp;&nbsp;<span class="courierb">const Rational operator*(const Rational&amp; lhs,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// function (see<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">const Rational&amp; rhs);</span>&nbsp;&nbsp;&nbsp;&nbsp;// below for details)<br>};<br><br>template&lt;typename T&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// define operator*<br>const Rational&lt;T&gt; operator*(const Rational&lt;T&gt;&amp; lhs, // functions<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Rational&lt;T&gt;&amp; rhs)<br>{ ... }<br></p>
<p class="noindent">Now our mixed-mode calls to <code>operator*</code> will compile, because when the object <code>oneHalf</code> is declared to be of type <code>Rational&lt;int&gt;</code>, the class <code>Rational&lt;int&gt;</code> is instantiated, and as part of that process, the friend function <code>operator*</code> that takes <code>Rational&lt;int&gt;</code> parameters is automatically declared. As a declared <em>function</em> (not a function <em>template</em>), compilers can use implicit conversion functions (such as <code>Rational</code>'s non-<code>explicit</code> constructor) when calling it, and that's how they make the mixed-mode call succeed.</p>
<p class="noindent">Alas, “succeed” is a funny word in this context, because although the code will compile, it won't link. We'll deal with that in a moment, but first I want to remark on the syntax used to declare <code>operator*</code> inside <code>Rational</code>.</p>
<p class="noindent">Inside a class template, the name of the template can be used as shorthand for the template and its parameters, so inside <code>Rational&lt;T&gt;</code>, we can just write <code>Rational</code> instead of <code>Rational&lt;T&gt;</code>. That saves us only a few characters in this example, but when there are multiple parameters or longer parameter names, it can both save typing and make the resulting code clearer. I bring this up, because <code>operator*</code> is declared taking and returning <code>Rational</code>s instead of <code>Rational&lt;T&gt;</code>s. It would have been just as valid to declare <code>operator*</code> like this:</p>
<p class="codelink"><a id="procode303"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode303">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class Rational {<br>public:<br>&nbsp;&nbsp;...<br>friend<br>&nbsp;&nbsp;&nbsp;const Rational<span class="courierb">&lt;T&gt;</span> operator*(const Rational<span class="courierb">&lt;T&gt;</span>&amp; lhs,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Rational&lt;T&gt;&amp; rhs);<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">However, it's easier (and more common) to use the shorthand form.</p>
<p class="noindent">Now back to the linking problem. The mixed-mode code compiles, because compilers know that we want to call a specific function (<code>operator*</code> taking a <code>Rational&lt;int&gt;</code> and a <code>Rational&lt;int&gt;</code>), but that function is only <em>declared</em> inside <code>Rational</code>, not <em>defined</em> there. Our intent is to have <a id="page_225"></a>the <code>operator*</code> template outside the class provide that definition, but things don't work that way. If we declare a function ourselves (which is what we're doing inside the <code>Rational</code> template), we're also responsible for defining that function. In this case, we never provide a definition, and that's why linkers can't find one.</p>
<p class="noindent">The simplest thing that could possibly work is to merge the body of <code>operator*</code> into its declaration:</p>
<p class="codelink"><a id="procode304"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode304">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class Rational {<br>public:<br>&nbsp;&nbsp;...<br><br>friend const Rational operator*(const Rational&amp; lhs, const Rational&amp; rhs)<br><span class="courierb">{</span><br>&nbsp;&nbsp;<span class="courierb">return Rational(lhs.numerator()</span> * rhs.numerator(),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// same impl<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">lhs.denominator() * rhs.denominator());</span>&nbsp;&nbsp;// as in<br><span class="courierb">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Item 24<br>};<br></p>
<p class="noindent">Indeed, this works as intended: mixed-mode calls to <code>operator*</code> now compile, link, and run. Hooray!</p>
<p class="noindent">An interesting observation about this technique is that the use of friendship has nothing to do with a need to access non-public parts of the class. In order to make type conversions possible on all arguments, we need a non-member function (<a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec7">Item 24</a> still applies); and in order to have the proper function automatically instantiated, we need to declare the function inside the class. The only way to declare a non-member function inside a class is to make it a friend. So that's what we do. Unconventional? Yes. Effective? Without a doubt.</p>
<p class="noindent">As <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec5">Item 30</a> explains, functions defined inside a class are implicitly declared <code>inline</code>, and that includes friend functions like <code>operator*</code>. You can minimize the impact of such <code>inline</code> declarations by having <code>operator*</code> do nothing but call a helper function defined outside of the class. In the example in this Item, there's not much point in doing that, because <code>operator*</code> is already implemented as a one-line function, but for more complex function bodies, it may be desirable. It's worth taking a look at the “have the friend call a helper” approach.</p>
<p class="noindent">The fact that <code>Rational</code> is a template means that the helper function will usually also be a template, so the code in the header file defining <code>Rational</code> will typically look something like this:</p>
<p class="codelink"><a id="procode305"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode305">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_226"></a><span class="courierb">template&lt;typename T&gt; class Rational;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// declare<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Rational<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// template<br><span class="courierb">template&lt;typename T&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// declare<br><span class="courierb">const Rational&lt;T&gt; doMultiply(const Rational&lt;T&gt;&amp; lhs,</span>&nbsp;&nbsp;&nbsp;&nbsp;// helper<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">const Rational&lt;T&gt;&amp; rhs);</span>&nbsp;&nbsp;&nbsp;// template<br>template&lt;typename T&gt;<br>class Rational {<br>public:<br>&nbsp;&nbsp;...<br><br>friend<br>&nbsp;&nbsp;const Rational&lt;T&gt; operator*(const Rational&lt;T&gt;&amp; lhs,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Rational&lt;T&gt;&amp; rhs)&nbsp;&nbsp;&nbsp;// Have friend<br>&nbsp;&nbsp;<span class="courierb">{ return doMultiply(lhs, rhs); }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call helper<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">Many compilers essentially force you to put all template definitions in header files, so you may need to define <code>doMultiply</code> in your header as well. (As <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec5">Item 30</a> explains, such templates need not be inline.) That could look like this:</p>
<p class="codelink"><a id="procode306"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode306">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">template&lt;typename T&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// define<br><span class="courierb">const Rational&lt;T&gt; doMultiply(const Rational&lt;T&gt;&amp; lhs,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// helper<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">const Rational&lt;T&gt;&amp; rhs)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// template in<br><span class="courierb">{</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// header file,<br>&nbsp;&nbsp;<span class="courierb">return Rational&lt;T&gt;(lhs.numerator() * rhs.numerator(),</span>&nbsp;&nbsp;&nbsp;// if necessary<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">lhs.denominator() * rhs.denominator());</span><br><span class="courierb">}</span><br></p>
<p class="noindent">As a template, of course, <code>doMultiply</code> won't support mixed-mode multiplication, but it doesn't need to. It will only be called by <code>operator*</code>, and <code>operator*</code> <em>does</em> support mixed-mode operations! In essence, the <em>function</em> <code>operator*</code> supports whatever type conversions are necessary to ensure that two <code>Rational</code> objects are being multiplied, then it passes these two objects to an appropriate instantiation of the <code>doMultiply</code> <em>template</em> to do the actual multiplication. Synergy in action, no?</p>
<div class="note">
<h3 id="ch07note06">Things to Remember</h3>
<p class="indenthanding">• When writing a class template that offers functions related to the template that support implicit type conversions on all parameters, define those functions as friends inside the class template.</p>
</div>
<h3 id="ch07lev1sec7">Item 47: Use traits classes for information about types</h3>
<p class="noindent">The STL is primarily made up of templates for containers, iterators, and algorithms, but it also has a few utility templates. One of these is called <code>advance</code>. <code>advance</code> moves a specified iterator a specified distance:</p>
<p class="codelink"><a id="procode307"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode307">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_227"></a>template&lt;typename IterT, typename DistT&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// move iter d units<br>void advance(IterT&amp; iter, DistT d);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// forward; if d &lt; 0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// move iter backward<br></p>
<p class="noindent">Conceptually, <code>advance</code> just does <code>iter += d</code>, but <code>advance</code> can't be implemented that way, because only random access iterators support the <code>+=</code> operation. Less powerful iterator types have to implement advance by iteratively applying <code>++</code> or <code>-- d</code> times.</p>
<p class="noindent">Um, you don't remember your STL iterator categories? No problem, we'll do a mini-review. There are five categories of iterators, corresponding to the operations they support. <em>Input iterators</em> can move only forward, can move only one step at a time, can only read what they point to, and can read what they're pointing to only once. They're modeled on the read pointer into an input file; the C++ library's <code>istream_iterator</code>s are representative of this category. <em>Output iterators</em> are analogous, but for output: they move only forward, move only one step at a time, can only write what they point to, and can write it only once. They're modeled on the write pointer into an output file; <code>ostream_iterator</code>s epitomize this category. These are the two least powerful iterator categories. Because input and output iterators can move only forward and can read or write what they point to at most once, they are suitable only for one-pass algorithms.</p>
<p class="noindent">A more powerful iterator category consists of <em>forward iterators</em>. Such iterators can do everything input and output iterators can do, plus they can read or write what they point to more than once. This makes them viable for multi-pass algorithms. The STL offers no singly linked list, but some libraries offer one (usually called <code>slist</code>), and iterators into such containers are forward iterators. Iterators into TR1's hashed containers (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>) may also be in the forward category.</p>
<p class="noindent"><em>Bidirectional iterators</em> add to forward iterators the ability to move backward as well as forward. Iterators for the STL's <code>list</code> are in this category, as are iterators for <code>set</code>, <code>multiset</code>, <code>map</code>, and <code>multimap</code>.</p>
<p class="noindent">The most powerful iterator category is that of <em>random access iterators</em>. These kinds of iterators add to bidirectional iterators the ability to perform “iterator arithmetic,” i.e., to jump forward or backward an arbitrary distance in constant time. Such arithmetic is analogous to pointer arithmetic, which is not surprising, because random access iterators are modeled on built-in pointers, and built-in pointers can act as random access iterators. Iterators for <code>vector</code>, <code>deque</code>, and <code>string</code> are random access iterators.</p>
<p class="noindent">For each of the five iterator categories, C++ has a “tag struct” in the standard library that serves to identify it:</p>
<p class="codelink"><a id="procode308"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode308">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_228"></a>struct <span class="courierb">input_iterator_tag</span> {};<br><br>struct <span class="courierb">output_iterator_tag</span> {};<br><br>struct <span class="courierb">forward_iterator_tag</span>: public input_iterator_tag {};<br><br>struct <span class="courierb">bidirectional_iterator_tag</span>: public forward_iterator_tag {};<br><br>struct <span class="courierb">random_access_iterator_tag</span>: public bidirectional_iterator_tag {};<br></p>
<p class="noindent">The inheritance relationships among these structs are valid is-a relationships (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec1">Item 32</a>): it's true that all forward iterators are also input iterators, etc. We'll see the utility of this inheritance shortly.</p>
<p class="noindent">But back to <code>advance</code>. Given the different iterator capabilities, one way to implement <code>advance</code> would be to use the lowest-common-denominator strategy of a loop that iteratively increments or decrements the iterator. However, that approach would take linear time. Random access iterators support constant-time iterator arithmetic, and we'd like to take advantage of that ability when it's present.</p>
<p class="noindent">What we really want to do is implement <code>advance</code> essentially like this:</p>
<p class="codelink"><a id="procode309"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode309">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT, typename DistT&gt;<br>void advance(IterT&amp; iter, DistT d)<br>{<br>&nbsp;&nbsp;if (<span class="courierb"><span class="courieri">iter is a random access iterator</span></span>) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter += d;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use iterator arithmetic<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for random access iters<br>&nbsp;&nbsp;else {<br>&nbsp;&nbsp;&nbsp;&nbsp;if (d &gt;= 0) { while (d--) ++iter; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use iterative calls to<br>&nbsp;&nbsp;&nbsp;&nbsp;else { while (d++) --iter; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ++ or -- for other<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// iterator categories<br>}<br></p>
<p class="noindent">This requires being able to determine whether <code>iter</code> is a random access iterator, which in turn requires knowing whether its type, <code>IterT</code>, is a random access iterator type. In other words, we need to get some information about a type. That's what <em>traits</em> let you do: they allow you to get information about a type during compilation.</p>
<p class="noindent">Traits aren't a keyword or a predefined construct in C++; they're a technique and a convention followed by C++ programmers. One of the demands made on the technique is that it has to work as well for built-in types as it does for user-defined types. For example, if <code>advance</code> is called with a pointer (like a <code>const char*</code>) and an <code>int</code>, <code>advance</code> has to work, but that means that the traits technique must apply to built-in types like pointers.</p>
<p class="noindent">The fact that traits must work with built-in types means that things like nesting information inside types won't do, because there's no way to nest information inside pointers. The traits information for a type, then, must be external to the type. The standard technique is to put it <a id="page_229"></a>into a template and one or more specializations of that template. For iterators, the template in the standard library is named <code>iterator_traits</code>:</p>
<p class="codelink"><a id="procode310"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode310">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// template for information about<br>struct iterator_traits;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// iterator types<br></p>
<p class="noindent">As you can see, <code>iterator_traits</code> is a struct. By convention, traits are always implemented as structs. Another convention is that the structs used to implement traits are known as — I am not making this up — traits <em>classes</em>.</p>
<p class="noindent">The way <code>iterator_traits</code> works is that for each type <code>IterT</code>, a typedef named <code>iterator_category</code> is declared in the struct <code>iterator_traits&lt;IterT&gt;</code>. This typedef identifies the iterator category of <code>IterT</code>.</p>
<p class="noindent"><code>iterator_traits</code> implements this in two parts. First, it imposes the requirement that any user-defined iterator type must contain a nested typedef named <code>iterator_category</code> that identifies the appropriate tag struct. <code>deque</code>'s iterators are random access, for example, so a class for <code>deque</code> iterators would look something like this:</p>
<p class="codelink"><a id="procode311"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode311">Click here to view code image</a></p>
<p class="programlisting"><br>template &lt; ... &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// template params elided<br>class deque {<br>public:<br>&nbsp;&nbsp;class iterator {<br>&nbsp;&nbsp;public:<br>&nbsp;&nbsp;&nbsp;&nbsp;typedef <span class="courierb">random_access_iterator_tag</span> iterator_category;<br>&nbsp;&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;}:<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent"><code>list</code>'s iterators are bidirectional, however, so they'd do things this way:</p>
<p class="codelink"><a id="procode312"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode312">Click here to view code image</a></p>
<p class="programlisting"><br>template &lt; ... &gt;<br>class list {<br>public:<br>&nbsp;&nbsp;class iterator {<br>&nbsp;&nbsp;public:<br>&nbsp;&nbsp;&nbsp;&nbsp;typedef <span class="courierb">bidirectional_iterator_tag</span> iterator_category;<br>&nbsp;&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;}:<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent"><code>iterator_traits</code> just parrots back the iterator class's nested typedef:</p>
<p class="codelink"><a id="procode313"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode313">Click here to view code image</a></p>
<p class="programlisting"><br>// the iterator_category for type IterT is whatever IterT says it is;<br>// see Item 42 for info on the use of "typedef typename"<br>template&lt;typename IterT&gt;<br>struct iterator_traits {<br>&nbsp;&nbsp;<span class="courierb">typedef typename IterT::iterator_category iterator_category;</span><br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent"><a id="page_230"></a>This works well for user-defined types, but it doesn't work at all for iterators that are pointers, because there's no such thing as a pointer with a nested typedef. The second part of the <code>iterator_traits</code> implementation handles iterators that are pointers.</p>
<p class="noindent">To support such iterators, <code>iterator_traits</code> offers a <em>partial template specialization</em> for pointer types. Pointers act as random access iterators, so that's the category <code>iterator_traits</code> specifies for them:</p>
<p class="codelink"><a id="procode314"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode314">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// partial template specialization<br>struct iterator_traits&lt;<span class="courierb">IterT*</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for built-in pointer types<br><br>{<br>&nbsp;&nbsp;<span class="courierb">typedef random_access_iterator_tag iterator_category;</span><br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">At this point, you know how to design and implement a traits class:</p>
<p class="indenthanding">• Identify some information about types you'd like to make available (e.g., for iterators, their iterator category).</p>
<p class="indenthanding">• Choose a name to identify that information (e.g., <code>iterator_category</code>).</p>
<p class="indenthanding">• Provide a template and set of specializations (e.g., <code>iterator_traits</code>) that contain the information for the types you want to support.</p>
<p class="noindent">Given <code>iterator_traits</code> — actually <code>std::iterator_traits</code>, since it's part of C++'s standard library — we can refine our pseudocode for <code>advance</code>:</p>
<p class="codelink"><a id="procode315"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode315">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT, typename DistT&gt;<br>void advance(IterT&amp; iter, DistT d)<br>{<br>&nbsp;&nbsp;if (<span class="courierb">typeid</span>(typename std::iterator_traits&lt;IterT&gt;::iterator_category) ==<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">typeid</span>(<span class="courierb">std::random_access_iterator_tag</span>))<br>&nbsp;&nbsp;...<br>}<br></p>
<p class="noindent">Although this looks promising, it's not what we want. For one thing, it will lead to compilation problems, but we'll explore that in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec8">Item 48</a>; right now, there's a more fundamental issue to consider. <code>IterT</code>'s type is known during compilation, so <code>iterator_traits&lt;IterT&gt;::iterator_category</code> can also be determined during compilation. Yet the <code>if</code> statement is evaluated at runtime. Why do something at runtime that we can do during compilation? It wastes time (literally), and it bloats our executable.</p>
<p class="noindent">What we really want is a conditional construct (i.e., an <code>if...else</code> statement) for types that is evaluated during compilation. As it happens, C++ already has a way to get that behavior. It's called overloading.</p>
<p class="noindent">When you overload some function <code>f</code>, you specify different parameter types for the different overloads. When you call <code>f</code>, compilers pick the <a id="page_231"></a>best overload, based on the arguments you're passing. Compilers essentially say, “If this overload is the best match for what's being passed, call this <code>f</code>; if this other overload is the best match, call it; if this third one is best, call it,” etc. See? A compile-time conditional construct for types. To get <code>advance</code> to behave the way we want, all we have to do is create two versions of an overloaded function containing the “guts” of <code>advance</code>, declaring each to take a different type of <code>iterator_category</code> object. I use the name <code>doAdvance</code> for these functions:</p>
<p class="codelink"><a id="procode316"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode316">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT, typename DistT&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use this impl for<br>void doAdvance(IterT&amp; iter, DistT d,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// random access<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">std::random_access_iterator_tag</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// iterators<br><br>{<br>&nbsp;&nbsp;iter += d;<br>}<br><br>template&lt;typename IterT, typename DistT&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use this impl for<br>void doAdvance(IterT&amp; iter, DistT d,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// bidirectional<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">std::bidirectional_iterator_tag</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// iterators<br>{<br>&nbsp;&nbsp;if (d &gt;= 0) { while (d--) ++iter; }<br>&nbsp;&nbsp;else { while (d++) --iter;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br>template&lt;typename IterT, typename DistT&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use this impl for<br>void doAdvance(IterT&amp; iter, DistT d,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// input iterators<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">std::input_iterator_tag</span>)<br>{<br>&nbsp;&nbsp;if (d &lt; 0 ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw std::out_of_range("Negative distance");&nbsp;&nbsp;&nbsp;&nbsp;// see below<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;while (d--) ++iter;<br>}<br></p>
<p class="noindent">Because <code>forward_iterator_tag</code> inherits from <code>input_iterator_tag</code>, the version of <code>doAdvance</code> for <code>input_iterator_tag</code> will also handle forward iterators. That's the motivation for inheritance among the various <code>iterator_tag</code> structs. (In fact, it's part of the motivation for <em>all</em> public inheritance: to be able to write code for base class types that also works for derived class types.)</p>
<p class="noindent">The specification for <code>advance</code> allows both positive and negative distances for random access and bidirectional iterators, but behavior is undefined if you try to move a forward or input iterator a negative distance. The implementations I checked simply assumed that <code>d</code> was non-negative, thus entering a <em>very</em> long loop counting “down” to zero if a negative distance was passed in. In the code above, I've shown an exception being thrown instead. Both implementations are valid. That's the curse of undefined behavior: you <em>can't predict</em> what will happen.</p>
<p class="noindent"><a id="page_232"></a>Given the various overloads for <code>doAdvance</code>, all <code>advance</code> needs to do is call them, passing an extra object of the appropriate iterator category type so that the compiler will use overloading resolution to call the proper implementation:</p>
<p class="codelink"><a id="procode317"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode317">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT, typename DistT&gt;<br>void advance(IterT&amp; iter, DistT d)<br>{<br>&nbsp;&nbsp;<span class="courierb">doAdvance</span>(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call the version<br>&nbsp;&nbsp;&nbsp;&nbsp;iter, d,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// of doAdvance<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">typename</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// that is<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">std::iterator_traits&lt;IterT&gt;::iterator_category()</span>&nbsp;&nbsp;&nbsp;&nbsp;// appropriate for<br>&nbsp;&nbsp;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// iter's iterator<br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// category<br></p>
<p class="noindent">We can now summarize how to use a traits class:</p>
<p class="indenthanding">• Create a set of overloaded “worker” functions or function templates (e.g., <code>doAdvance</code>) that differ in a traits parameter. Implement each function in accord with the traits information passed.</p>
<p class="indenthanding">• Create a “master” function or function template (e.g., <code>advance</code>) that calls the workers, passing information provided by a traits class.</p>
<p class="noindent">Traits are widely used in the standard library. There's <code>iterator_traits</code>, of course, which, in addition to <code>iterator_category</code>, offers four other pieces of information about iterators (the most useful of which is <code>value_type</code> — <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec2">Item 42</a> shows an example of its use). There's also <code>char_traits</code>, which holds information about character types, and <code>numeric_limits</code>, which serves up information about numeric types, e.g., their minimum and maximum representable values, etc. (The name <code>numeric_limits</code> is a bit of a surprise, because the more common convention is for traits classes to end with “traits,” but <code>numeric_limits</code> is what it's called, so <code>numeric_limits</code> is the name we use.)</p>
<p class="noindent">TR1 (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>) introduces a slew of new traits classes that give information about types, including <code>is_fundamental&lt;T&gt;</code> (whether <code>T</code> is a built-in type), <code>is_array&lt;T&gt;</code> (whether <code>T</code> is an array type), and <code>is_base_of&lt;T1, T2&gt;</code> (whether <code>T1</code> is the same as or is a base class of <code>T2</code>). All told, TR1 adds over 50 traits classes to standard C++.</p>
<div class="note">
<h3 id="ch07note07">Things to Remember</h3>
<p class="indenthanding">• Traits classes make information about types available during compilation. They're implemented using templates and template specializations.</p>
<p class="indenthanding">• In conjunction with overloading, traits classes make it possible to perform compile-time <code>if...else</code> tests on types.</p>
</div>
<h3 id="ch07lev1sec8">Item 48: Be aware of template metaprogramming</h3>
<p class="noindent"><a id="page_233"></a>Template metaprogramming (TMP) is the process of writing template-based C++ programs that execute during compilation. Think about that for a minute: a template metaprogram is a program written in C++ that executes <em>inside the C++ compiler</em>. When a TMP program finishes running, its output — pieces of C++ source code instantiated from templates — is then compiled as usual.</p>
<p class="noindent">If this doesn't strike you as just plain bizarre, you're not thinking about it hard enough.</p>
<p class="noindent">C++ was not designed for template metaprogramming, but since TMP was discovered in the early 1990s, it has proven to be so useful, extensions are likely to be added to both the language and its standard library to make TMP easier. Yes, TMP was discovered, not invented. The features underlying TMP were introduced when templates were added to C++. All that was needed was for somebody to notice how they could be used in clever and unexpected ways.</p>
<p class="noindent">TMP has two great strengths. First, it makes some things easy that would otherwise be hard or impossible. Second, because template metaprograms execute during C++ compilation, they can shift work from runtime to compile-time. One consequence is that some kinds of errors that are usually detected at runtime can be found during compilation. Another is that C++ programs making use of TMP can be more efficient in just about every way: smaller executables, shorter runtimes, lesser memory requirements. (However, a consequence of shifting work from runtime to compile-time is that compilation takes longer. Programs using TMP may take <em>much</em> longer to compile than their non-TMP counterparts.)</p>
<p class="noindent">Consider the pseudocode for STL's <code>advance</code> introduced on page <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#page_228">228</a>. (That's in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec7">Item 47</a>. You may want to read that Item now, because in this Item, I'll assume you are familiar with the material in that one.) As on page <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#page_228">228</a>, I've highlighted the pseudo part of the code:</p>
<p class="codelink"><a id="procode318"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode318">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT, typename DistT&gt;<br>void advance(IterT&amp; iter, DistT d)<br>{<br>&nbsp;&nbsp;if (<span class="courierb"><span class="courieri">iter is a random access iterator</span></span>) {<br>&nbsp;&nbsp;&nbsp;&nbsp;iter += d;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use iterator arithmetic<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for random access iters<br>&nbsp;&nbsp;else {<br>&nbsp;&nbsp;&nbsp;&nbsp;if (d &gt;= 0) { while (d--) ++iter; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use iterative calls to<br>&nbsp;&nbsp;&nbsp;&nbsp;else { while (d++) --iter; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ++ or -- for other<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// iterator categories<br>}<br></p>
<p class="noindent"><a id="page_234"></a>We can use <code>typeid</code> to make the pseudocode real. That yields a “normal” C++ approach to this problem — one that does all its work at runtime:</p>
<p class="codelink"><a id="procode319"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode319">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename IterT, typename DistT&gt;<br>void advance(IterT&amp; iter, DistT d)<br>{<br>&nbsp;&nbsp;if (<span class="courierb">typeid(</span>typename std::iterator_traits&lt;IterT&gt;::iterator_category<span class="courierb">)</span> ==<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">typeid(</span>std::random_access_iterator_tag<span class="courierb">)</span>) {<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter += d;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use iterator arithmetic<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for random access iters<br>&nbsp;&nbsp;else {<br>&nbsp;&nbsp;&nbsp;&nbsp;if (d &gt;= 0) { while (d--) ++iter; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use iterative calls to<br>&nbsp;&nbsp;&nbsp;&nbsp;else { while (d++) --iter; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ++ or -- for other<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// iterator categories<br>}<br></p>
<p class="noindent"><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec7">Item 47</a> notes that this <code>typeid</code>-based approach is less efficient than the one using traits, because with this approach, (1) the type testing occurs at runtime instead of during compilation, and (2) the code to do the runtime type testing must be present in the executable. In fact, this example shows how TMP can be more efficient than a “normal” C++ program, because the traits approach <em>is</em> TMP. Remember, traits enable compile-time <code>if...else</code> computations on types.</p>
<p class="noindent">I remarked earlier that some things are easier in TMP than in “normal” C++, and <code>advance</code> offers an example of that, too. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec7">Item 47</a> mentions that the <code>typeid</code>-based implementation of <code>advance</code> can lead to compilation problems, and here's an example where it does:</p>
<p class="codelink"><a id="procode320"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode320">Click here to view code image</a></p>
<p class="programlisting"><br>std::list&lt;int&gt;::iterator iter;<br><br>...<br><br><span class="courierb">advance(iter, 10);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// move iter 10 elements forward;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// won't compile with above impl.<br></p>
<p class="noindent">Consider the version of <code>advance</code> that will be generated for the above call. After substituting <code>iter</code>'s and <code>10</code>'s types for the template parameters <code>IterT</code> and <code>DistT</code>, we get this:</p>
<p class="codelink"><a id="procode321"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode321">Click here to view code image</a></p>
<p class="programlisting"><br>void advance(std::list&lt;int&gt;::iterator&amp; iter, int d)<br>{<br>&nbsp;&nbsp;if (typeid(std::iterator_traits&lt;std::list&lt;int&gt;::iterator&gt;::iterator_category) ==<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typeid(std::random_access_iterator_tag)) {<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">iter += d;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// error!<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;else {<br>&nbsp;&nbsp;&nbsp;&nbsp;if (d &gt;= 0) { while (d--) ++iter; }<br>&nbsp;&nbsp;&nbsp;&nbsp;else { while (d++) --iter; }<br>&nbsp;&nbsp;}<br>}<br></p>
<p class="noindent"><a id="page_235"></a>The problem is the highlighted line, the one using <code>+=</code>. In this case, we're trying to use <code>+=</code> on a <code>list&lt;int&gt;::iterator</code>, but <code>list&lt;int&gt;::iterator</code> is a bidirectional iterator (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec7">Item 47</a>), so it doesn't support <code>+=</code>. Only random access iterators support <code>+=</code>. Now, we know we'll never try to execute the <code>+=</code> line, because the <code>typeid</code> test will always fail for <code>list&lt;int&gt;::iterator</code>s, but compilers are obliged to make sure that all source code is valid, even if it's not executed, and “<code>iter += d</code>” isn't valid when <code>iter</code> isn't a random access iterator. Contrast this with the traits-based TMP solution, where code for different types is split into separate functions, each of which uses only operations applicable to the types for which it is written.</p>
<p class="noindent">TMP has been shown to be Turing-complete, which means that it is powerful enough to compute anything. Using TMP, you can declare variables, perform loops, write and call functions, etc. But such constructs look very different from their “normal” C++ counterparts. For example, <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec7">Item 47</a> shows how <code>if...else</code> conditionals in TMP are expressed via templates and template specializations. But that's assembly-level TMP. Libraries for TMP (e.g., Boost's MPL — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec3">Item 55</a>) offer a higher-level syntax, though still not something you'd mistake for “normal” C++.</p>
<p class="noindent">For another glimpse into how things work in TMP, let's look at loops. TMP has no real looping construct, so the effect of loops is accomplished via recursion. (If you're not comfortable with recursion, you'll need to address that before venturing into TMP. It's largely a functional language, and recursion is to functional languages as TV is to American pop culture: inseparable.) Even the recursion isn't the normal kind, however, because TMP loops don't involve recursive function calls, they involve recursive <em>template instantiations</em>.</p>
<p class="noindent">The “hello world” program of TMP is computing a factorial during compilation. It's not a very exciting program, but then again, neither is “hello world,” yet both are helpful as language introductions. TMP factorial computation demonstrates looping through recursive template instantiation. It also demonstrates one way in which variables are created and used in TMP. Look:</p>
<p class="codelink"><a id="procode322"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode322">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;unsigned n&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// general case: the value of<br>struct Factorial {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Factorial&lt;n&gt; is n times the value<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// of Factorial&lt;n-1&gt;<br><br>&nbsp;&nbsp;enum { value = n * Factorial&lt;n-1&gt;::value };<br><br>};<br><br>template&lt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// special case: the value of<br>struct Factorial&lt;0&gt; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Factorial&lt;0&gt; is 1<br>&nbsp;&nbsp;enum { value = 1 };<br><br>};<br></p>
<p class="noindent"><a id="page_236"></a>Given this template metaprogram (really just the single template metafunction <code>Factorial</code>), you get the value of factorial(n) by referring to <code>Factorial&lt;n&gt;::value</code>.</p>
<p class="noindent">The looping part of the code occurs where the template instantiation <code>Factorial&lt;n&gt;</code> references the template instantiation <code>Factorial&lt;n-1&gt;</code>. Like all good recursion, there's a special case that causes the recursion to terminate. Here, it's the template specialization <code>Factorial&lt;0&gt;</code>.</p>
<p class="noindent">Each instantiation of the <code>Factorial</code> template is a struct, and each struct uses the enum hack (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec2">Item 2</a>) to declare a TMP variable named <code>value</code>. <code>value</code> is what holds the current value of the factorial computation. If TMP had a real looping construct, <code>value</code> would be updated each time around the loop. Since TMP uses recursive template instantiation in place of loops, each instantiation gets its own copy of <code>value</code>, and each copy has the proper value for its place in the “loop.”</p>
<p class="noindent">You could use <code>Factorial</code> like this:</p>
<p class="codelink"><a id="procode323"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode323">Click here to view code image</a></p>
<p class="programlisting"><br>int main()<br>{<br>&nbsp;&nbsp;std::cout &lt;&lt; Factorial&lt;5&gt;::value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// prints 120<br>&nbsp;&nbsp;std::cout &lt;&lt; Factorial&lt;10&gt;::value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// prints 3628800<br>}<br></p>
<p class="noindent">If you think this is cooler than ice cream, you've got the makings of a template metaprogrammer. If the templates and specializations and recursive instantiations and enum hacks and the need to type things like <code>Factorial&lt;n</code>-<code>1&gt;::value</code> make your skin crawl, well, you're a pretty normal C++ programmer.</p>
<p class="noindent">Of course, <code>Factorial</code> demonstrates the utility of TMP about as well as “hello world” demonstrates the utility of any conventional programming language. To grasp why TMP is worth knowing about, it's important to have a better understanding of what it can accomplish. Here are three examples:</p>
<p class="indenthanding">• <strong>Ensuring dimensional unit correctness.</strong> In scientific and engineering applications, it's essential that dimensional units (e.g., mass, distance, time, etc.) be combined correctly. Assigning a variable representing mass to a variable representing velocity, for example, is an error, but dividing a distance variable by a time variable and assigning the result to a velocity variable is fine. Using TMP, it's possible to ensure (during compilation) that all dimensional unit combinations in a program are correct, no matter how complex the calculations. (This is an example of how TMP can be used for early error detection.) One interesting aspect of this use of TMP is that fractional dimensional exponents can be supported. <a id="page_237"></a>This requires that such fractions be reduced <em>during compilation</em> so that compilers can confirm, for example, that the unit <em>time</em><sup>1/2</sup> is the same as <em>time</em><sup>4/8</sup>.</p>
<p class="indenthanding">• <strong>Optimizing matrix operations.</strong> <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec4">Item 21</a> explains that some functions, including <code>operator*</code>, must return new objects, and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec4">Item 44</a> introduces the <code>SquareMatrix</code> class, so consider the following code:</p>
<p class="codelink"><a id="procode324"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode324">Click here to view code image</a></p>
<p class="programlisting"><br>typedef SquareMatrix&lt;double, 10000&gt; BigMatrix;<br>BigMatrix m1, m2, m3, m4, m5;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// create matrices and<br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// give them values<br><br>BigMatrix result = <span class="courierb">m1 * m2 * m3 * m4 * m5</span>;&nbsp;&nbsp;&nbsp;&nbsp;// compute their product<br></p>
<p class="noindent">Calculating <code>result</code> in the “normal” way calls for the creation of four temporary matrices, one for the result of each call to <code>operator*</code>. Furthermore, the independent multiplications generate a sequence of four loops over the matrix elements. Using an advanced template technology related to TMP called <em>expression templates</em>, it's possible to eliminate the temporaries and merge the loops, all without changing the syntax of the client code above. The resulting software uses less memory and runs dramatically faster.</p>
<p class="indenthanding">• <strong>Generating custom design pattern implementations.</strong> Design patterns like Strategy (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec4">Item 35</a>), Observer, Visitor, etc. can be implemented in many ways. Using a TMP-based technology called <em>policy-based design</em>, it's possible to create templates representing independent design choices (“policies”) that can be combined in arbitrary ways to yield pattern implementations with custom behavior. For example, this technique has been used to allow a few templates implementing smart pointer behavioral policies to generate (during compilation) any of <em>hundreds</em> of different smart pointer types. Generalized beyond the domain of programming artifacts like design patterns and smart pointers, this technology is a basis for what's known as <em>generative programming</em>.</p>
<p class="noindent">TMP is not for everybody. The syntax is unintuitive, and tool support is weak. (Debuggers for template metaprograms? Ha!) Being an “accidental” language that was only relatively recently discovered, TMP programming conventions are still somewhat experimental. Nevertheless, the efficiency improvements afforded by shifting work from runtime to compile-time can be impressive, and the ability to express behavior that is difficult or impossible to implement at runtime is attractive, too.</p>
<p class="noindent">TMP support is on the rise. It's likely that the next version of C++ will provide explicit support for it, and TR1 already does (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>). Books are beginning to come out on the subject, and TMP information <a id="page_238"></a>on the web just keeps getting richer. TMP will probably never be mainstream, but for some programmers — especially library developers — it's almost certain to be a staple.</p>
<div class="note">
<h3 id="ch07note08">Things to Remember</h3>
<p class="indenthanding">• Template metaprogramming can shift work from runtime to compile-time, thus enabling earlier error detection and higher runtime performance.</p>
<p class="indenthanding">• TMP can be used to generate custom code based on combinations of policy choices, and it can also be used to avoid generating code inappropriate for particular types.</p>
</div>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch06.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">6. Inheritance and Object-Oriented Design</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch08.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">8. Customizing new and delete</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/0321334876/chapter/ch07.html" data-for-analytics="0321334876:ch07.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>
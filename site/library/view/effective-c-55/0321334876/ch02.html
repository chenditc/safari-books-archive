<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/effective-c-55/0321334876/ch02.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="0321334876"
  data-publishers="Addison-Wesley Professional"



  data-htmlfile-name="ch02.html"
  data-epub-title="Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/effective-c-55/0321334876/ch02.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="0321334876" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch02.html" data-epub-title="Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://0321334876"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>2. Constructors, Destructors, and Assignment Operators - Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content div{margin-top:5pt;margin-bottom:5pt;margin-right:15pt}#sbo-rt-content .cover{margin-top:2pt;margin-bottom:2pt;text-align:center}#sbo-rt-content h1{page-break-before:right;margin-top:5pt;text-align:center;margin-bottom:12pt;font-weight:bold}#sbo-rt-content .subtitle{font-size:large;margin-top:30pt;margin-bottom:55pt;font-weight:bold;text-align:center}#sbo-rt-content .publisher{text-align:center;margin-top:64pt;margin-bottom:4pt}#sbo-rt-content .copyright{margin-top:5pt;margin-bottom:5pt;text-indent:.12pt}#sbo-rt-content h2{page-break-before:right;margin-top:7pt;margin-bottom:25pt;font-weight:bold}#sbo-rt-content h3{margin-top:9pt;margin-bottom:8pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content h4{margin-top:9pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content h5{margin-top:9pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content h6{margin-top:8pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content .author{text-align:center;font-weight:bold;margin-top:66pt;margin-bottom:24pt}#sbo-rt-content .bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content .toc-chapter{margin-top:12pt;margin-bottom:5pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .emphasis{font-style:italic}#sbo-rt-content .mediaobject{margin-top:12pt;margin-bottom:12pt;text-align:center}#sbo-rt-content .tabimage{margin-top:12pt;margin-bottom:12pt;text-align:center}#sbo-rt-content .smaller{font-size:small}#sbo-rt-content .center{margin-top:50pt;margin-bottom:5pt;text-align:center}#sbo-rt-content .note{margin-top:6pt;margin-bottom:12pt;margin-left:.12pt;text-indent:.12pt;margin-right:24pt}#sbo-rt-content .toc-preface{margin-top:5pt;margin-bottom:5pt;margin-left:1pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .programlisting{font-family:"Courier New";font-size:small;margin-top:8pt;margin-bottom:8pt;text-indent:.12pt}#sbo-rt-content .programlisting1{font-family:"Courier New";font-size:small;margin-top:5pt;margin-bottom:4pt;margin-left:36pt;text-indent:.12pt}#sbo-rt-content code{font-size:x-small}#sbo-rt-content .toc-section{margin-top:4pt;margin-bottom:4pt;margin-left:12pt;text-indent:.12pt}#sbo-rt-content .toc-index{margin-top:12pt;margin-bottom:4pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .toc-appendix{margin-top:12pt;margin-bottom:4pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .strong{font-weight:bold}#sbo-rt-content .italic{font-style:italic}#sbo-rt-content .title{margin-top:12pt;margin-bottom:6pt;font-size:medium;font-weight:bold;text-align:center}#sbo-rt-content .attribution{margin-top:4pt;margin-bottom:12pt;margin-right:15pt;text-align:right}#sbo-rt-content .indexmain{margin-top:2pt;margin-bottom:2pt;text-indent:.12pt}#sbo-rt-content .indexsub{margin-top:2pt;margin-bottom:2pt;margin-left:24pt;text-indent:.12pt}#sbo-rt-content .indexsubsub{margin-top:2pt;margin-bottom:2pt;margin-left:40pt;text-indent:.12pt}#sbo-rt-content .paraindent{margin-top:4pt;margin-bottom:4pt;margin-left:25pt;text-indent:.12pt}#sbo-rt-content .indenthanding{margin-top:4pt;margin-bottom:4pt;padding-left:25pt;text-indent:-15pt}#sbo-rt-content .indenthanding1{margin-top:4pt;margin-bottom:4pt;padding-left:48pt;text-indent:-8pt}#sbo-rt-content .underline{text-decoration:underline}#sbo-rt-content .footnotes{font-size:small;margin-top:5pt;margin-bottom:4pt;padding-left:20pt;text-indent:-8pt}#sbo-rt-content .courierb{font-family:"Courier New Bold"}#sbo-rt-content .courieri{font-family:"Courier New Italic"}#sbo-rt-content .center1{margin-top:4pt;margin-bottom:4pt;margin-left:80pt;text-align:center}#sbo-rt-content .noindent{margin-top:6pt;margin-bottom:5pt;text-indent:.12pt}#sbo-rt-content .noindent1{margin-top:12pt;margin-bottom:2pt;text-indent:.12pt}#sbo-rt-content .edition{font-size:1.2em;margin-top:2pt;margin-bottom:2pt;text-align:center}#sbo-rt-content .image1{page-break-before:always;page-break-after:always}#sbo-rt-content .codelink{margin-top:6pt;margin-bottom:6pt;text-indent:.12pt;font-weight:bold;page-break-after:avoid;font-size:small}
    </style><link rel="canonical" href="/Library/view/effective-c-55/0321334876/ch02.html"><meta name="description" content="2. Constructors, Destructors, and Assignment Operators Almost every class you write will have one or more constructors, a destructor, and a copy assignment operator. Little wonder. These are your bread-and-butter ... "><meta property="og:title" content="2. Constructors, Destructors, and Assignment Operators"><meta itemprop="isPartOf" content="/library/view/effective-c-55/0321334876/"><meta itemprop="name" content="2. Constructors, Destructors, and Assignment Operators"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch02.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/0321334876/"><meta property="og:description" itemprop="description" content="2. Constructors, Destructors, and Assignment Operators Almost every class you write will have one or more constructors, a destructor, and a copy assignment operator. Little wonder. These are your bread-and-butter ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="0321334876"><meta property="og:book:author" itemprop="author" content="Scott Meyers"><meta property="og:book:tag" itemprop="about" content="C++"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/0321334876/chapter/ch02.html" data-for-analytics="0321334876:ch02.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch02.html&amp;text=Effective%20C%2B%2B%3A%2055%20Specific%20Ways%20to%20Improve%20Your%20Programs%20and%20Designs%2C%20Third%20Edition&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch02.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch02.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%202.%20Constructors%2C%20Destructors%2C%20and%20Assignment%20Operators&amp;body=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch02.html%0D%0Afrom%20Effective%20C%2B%2B%3A%2055%20Specific%20Ways%20to%20Improve%20Your%20Programs%20and%20Designs%2C%20Third%20Edition%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/Library/view/effective-c-55/0321334876/ch01.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">1. Accustoming Yourself to C++</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/Library/view/effective-c-55/0321334876/ch03.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">3. Resource Management</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><h2 id="ch02">2. Constructors, Destructors, and Assignment Operators</h2>
<p class="noindent"><a id="page_34"></a>Almost every class you write will have one or more constructors, a destructor, and a copy assignment operator. Little wonder. These are your bread-and-butter functions, the ones that control the fundamental operations of bringing a new object into existence and making sure it's initialized, getting rid of an object and making sure it's properly cleaned up, and giving an object a new value. Making mistakes in these functions will lead to far-reaching — and unpleasant — repercussions throughout your classes, so it's vital that you get them right. In this chapter, I offer guidance on putting together the functions that comprise the backbone of well-formed classes.</p>
<h3 id="ch02lev1sec1">Item 5: Know what functions C++ silently writes and calls</h3>
<p class="noindent">When is an empty class not an empty class? When C++ gets through with it. If you don't declare them yourself, compilers will declare their own versions of a copy constructor, a copy assignment operator, and a destructor. Furthermore, if you declare no constructors at all, compilers will also declare a default constructor for you. All these functions will be both <code>public</code> and <code>inline</code> (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec5">Item 30</a>). As a result, if you write</p>
<p class="programlisting"><br>class Empty{};<br></p>
<p class="noindent">it's essentially the same as if you'd written this:</p>
<p class="codelink"><a id="procode42"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode42">Click here to view code image</a></p>
<p class="programlisting"><br>class Empty {<br>public:<br>&nbsp;&nbsp;<span class="courierb">Empty() { ... }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// default constructor<br>&nbsp;&nbsp;<span class="courierb">Empty(const Empty&amp; rhs) { ... }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy constructor<br><br>&nbsp;&nbsp;<span class="courierb">~Empty() { ... }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destructor — see below<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for whether it's virtual<br><br>&nbsp;&nbsp;<span class="courierb">Empty&amp; operator=(const Empty&amp; rhs) { ... }</span> // copy assignment operator<br>};<br></p>
<p class="noindent"><a id="page_35"></a>These functions are generated only if they are needed, but it doesn't take much to need them. The following code will cause each function to be generated:</p>
<p class="codelink"><a id="procode43"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode43">Click here to view code image</a></p>
<p class="programlisting"><br>Empty e1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// default constructor;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destructor<br><br>Empty e2(e1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy constructor<br><br>e2 = e1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy assignment operator<br></p>
<p class="noindent">Given that compilers are writing functions for you, what do the functions do? Well, the default constructor and the destructor primarily give compilers a place to put “behind the scenes” code such as invocation of constructors and destructors of base classes and non-static data members. Note that the generated destructor is non-virtual (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec3">Item 7</a>) unless it's for a class inheriting from a base class that itself declares a virtual destructor (in which case the function's virtualness comes from the base class).</p>
<p class="noindent">As for the copy constructor and the copy assignment operator, the compiler-generated versions simply copy each non-static data member of the source object over to the target object. For example, consider a <code>NamedObject</code> template that allows you to associate names with objects of type <code>T</code>:</p>
<p class="codelink"><a id="procode44"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode44">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;<br>class NamedObject {<br>public:<br>&nbsp;&nbsp;NamedObject(const char *name, const T&amp; value);<br>&nbsp;&nbsp;NamedObject(const std::string&amp; name, const T&amp; value);<br><br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;std::string nameValue;<br>&nbsp;&nbsp;T objectValue;<br>};<br></p>
<p class="noindent">Because a constructor is declared in <code>NamedObject</code>, compilers won't generate a default constructor. This is important. It means that if you've carefully engineered a class to require constructor arguments, you don't have to worry about compilers overriding your decision by blithely adding a constructor that takes no arguments.</p>
<p class="noindent"><code>NamedObject</code> declares neither copy constructor nor copy assignment operator, so compilers will generate those functions (if they are needed). Look, then, at this use of the copy constructor:</p>
<p class="codelink"><a id="procode45"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode45">Click here to view code image</a></p>
<p class="programlisting"><br>NamedObject&lt;int&gt; no1("Smallest Prime Number", 2);<br><br><span class="courierb">NamedObject&lt;int&gt; no2(no1);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// calls copy constructor<br></p>
<p class="noindent"><a id="page_36"></a>The copy constructor generated by compilers must initialize <code>no2.nameValue</code> and <code>no2.objectValue</code> using <code>no1.nameValue</code> and <code>no1.objectValue</code>, respectively. The type of <code>nameValue</code> is <code>string</code>, and the standard <code>string</code> type has a copy constructor, so <code>no2.nameValue</code> will be initialized by calling the <code>string</code> copy constructor with <code>no1.nameValue</code> as its argument. On the other hand, the type of <code>NamedObject&lt;int&gt;::objectValue</code> is <code>int</code> (because <code>T</code> is <code>int</code> for this template instantiation), and <code>int</code> is a built-in type, so <code>no2.objectValue</code> will be initialized by copying the bits in <code>no1.objectValue</code>.</p>
<p class="noindent">The compiler-generated copy assignment operator for <code>NamedObject&lt;int&gt;</code> would behave essentially the same way, but in general, compiler-generated copy assignment operators behave as I've described only when the resulting code is both legal and has a reasonable chance of making sense. If either of these tests fails, compilers will refuse to generate an <code>operator=</code> for your class.</p>
<p class="noindent">For example, suppose <code>NamedObject</code> were defined like this, where <code>nameValue</code> is a <em>reference</em> to a string and <code>objectValue</code> is a <em><code>const</code></em> <code>T</code>:</p>
<p class="codelink"><a id="procode46"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode46">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;class T&gt;<br>class NamedObject {<br>public:<br>&nbsp;&nbsp;// this ctor no longer takes a const name, because nameValue<br>&nbsp;&nbsp;// is now a reference-to-non-const string. The char* constructor<br>&nbsp;&nbsp;// is gone, because we must have a string to refer to.<br>&nbsp;&nbsp;NamedObject(std::string&amp; name, const T&amp; value);<br><br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// as above, assume no<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// operator= is declared<br>private:<br>&nbsp;&nbsp;std::string<span class="courierb">&amp;</span> nameValue;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this is now a reference<br>&nbsp;&nbsp;<span class="courierb">const</span> T objectValue;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this is now const<br>};<br></p>
<p class="noindent">Now consider what should happen here:</p>
<p class="codelink"><a id="procode47"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode47">Click here to view code image</a></p>
<p class="programlisting"><br>std::string newDog("Persephone");<br>std::string oldDog("Satch");<br><br>NamedObject&lt;int&gt; p(newDog, 2);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// when I originally wrote this, our<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// dog Persephone was about to<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// have her second birthday<br><br>NamedObject&lt;int&gt; s(oldDog, 36);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the family dog Satch (from my<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// childhood) would be 36 if she<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// were still alive<br><br><span class="courierb">p = s;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// what should happen to<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the data members in p?<br></p>
<p class="noindent">Before the assignment, both <code>p.nameValue</code> and <code>s.nameValue</code> refer to <code>string</code> objects, though not the same ones. How should the assignment affect <code>p.nameValue</code>? After the assignment, should <code>p.nameValue</code> refer to the <a id="page_37"></a><code>string</code> referred to by <code>s.nameValue</code>, i.e., should the reference itself be modified? If so, that breaks new ground, because C++ doesn't provide a way to make a reference refer to a different object. Alternatively, should the <code>string</code> object to which <code>p.nameValue</code> refers be modified, thus affecting other objects that hold pointers or references to that <code>string</code>, i.e., objects not directly involved in the assignment? Is that what the compiler-generated copy assignment operator should do?</p>
<p class="noindent">Faced with this conundrum, C++ refuses to compile the code. If you want to support assignment in a class containing a reference member, you must define the copy assignment operator yourself. Compilers behave similarly for classes containing <code>const</code> members (such as <code>objectValue</code> in the modified class above). It's not legal to modify <code>const</code> members, so compilers are unsure how to treat them during an implicitly generated assignment function. Finally, compilers reject implicit copy assignment operators in derived classes that inherit from base classes declaring the copy assignment operator <code>private</code>. After all, compiler-generated copy assignment operators for derived classes are supposed to handle base class parts, too (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec8">Item 12</a>), but in doing so, they certainly can't invoke member functions the derived class has no right to call.</p>
<div class="note">
<h3 id="ch02note01">Things to Remember</h3>
<p class="indenthanding">• Compilers may implicitly generate a class's default constructor, copy constructor, copy assignment operator, and destructor.</p>
</div>
<h3 id="ch02lev1sec2">Item 6: Explicitly disallow the use of compiler-generated functions you do not want</h3>
<p class="noindent">Real estate agents sell houses, and a software system supporting such agents would naturally have a class representing homes for sale:</p>
<p class="programlisting"><br>class HomeForSale { ... };<br></p>
<p class="noindent">As every real estate agent will be quick to point out, every property is unique — no two are exactly alike. That being the case, the idea of making a <em>copy</em> of a <code>HomeForSale</code> object makes little sense. How can you copy something that's inherently unique? You'd thus like attempts to copy <code>HomeForSale</code> objects to not compile:</p>
<p class="codelink"><a id="procode48"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode48">Click here to view code image</a></p>
<p class="programlisting"><br>HomeForSale h1;<br>HomeForSale h2;<br><br><span class="courierb">HomeForSale h3(h1);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// attempt to copy h1 — should<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// not compile!<br><br><span class="courierb">h1 = h2;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// attempt to copy h2 — should<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// not compile!<br></p>
<p class="noindent"><a id="page_38"></a>Alas, preventing such compilation isn't completely straightforward. Usually, if you don't want a class to support a particular kind of functionality, you simply don't declare the function that would provide it. This strategy doesn't work for the copy constructor and copy assignment operator, because, as <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec1">Item 5</a> points out, if you don't declare them and somebody tries to call them, compilers declare them for you.</p>
<p class="noindent">This puts you in a bind. If you don't declare a copy constructor or a copy assignment operator, compilers may generate them for you. Your class thus supports copying. If, on the other hand, you do declare these functions, your class still supports copying. But the goal here is to <em>prevent</em> copying!</p>
<p class="noindent">The key to the solution is that all the compiler generated functions are public. To prevent these functions from being generated, you must declare them yourself, but there is nothing that requires that <em>you</em> declare them public. Instead, declare the copy constructor and the copy assignment operator <em>private</em>. By declaring a member function explicitly, you prevent compilers from generating their own version, and by making the function <code>private</code>, you keep people from calling it.</p>
<p class="noindent">Mostly. The scheme isn't foolproof, because member and friend functions can still call your private functions. <em>Unless</em>, that is, you are clever enough not to <em>define</em> them. Then if somebody inadvertently calls one, they'll get an error at link-time. This trick — declaring member functions <code>private</code> and deliberately not implementing them — is so well established, it's used to prevent copying in several classes in C++'s iostreams library. Take a look, for example, at the definitions of <code>ios_base</code>, <code>basic_ios</code>, and <code>sentry</code> in your standard library implementation. You'll find that in each case, both the copy constructor and the copy assignment operator are declared <code>private</code> and are not defined.</p>
<p class="noindent">Applying the trick to <code>HomeForSale</code> is easy:</p>
<p class="codelink"><a id="procode49"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode49">Click here to view code image</a></p>
<p class="programlisting"><br>class HomeForSale {<br>public:<br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;<span class="courierb">HomeForSale(const HomeForSale&amp;);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// declarations only<br>&nbsp;&nbsp;<span class="courierb">HomeForSale&amp; operator=(const HomeForSale&amp;);</span><br>};<br></p>
<p class="noindent">You'll note that I've omitted the names of the functions' parameters. This isn't required, it's just a common convention. After all, the functions will never be implemented, much less used, so what's the point in specifying parameter names?</p>
<p class="noindent">With the above class definition, compilers will thwart client attempts to copy <code>HomeForSale</code> objects, and if you inadvertently try to do it in a <a id="page_39"></a>member or a friend function, the linker will complain.</p>
<p class="noindent">It's possible to move the link-time error up to compile time (always a good thing — earlier error detection is better than later) by declaring the copy constructor and copy assignment operator <code>private</code> not in <code>HomeForSale</code> itself, but in a base class specifically designed to prevent copying. The base class is simplicity itself:</p>
<p class="codelink"><a id="procode50"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode50">Click here to view code image</a></p>
<p class="programlisting"><br>class Uncopyable {<br>protected:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// allow construction<br>&nbsp;&nbsp;Uncopyable() {}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// and destruction of<br>&nbsp;&nbsp;~Uncopyable() {}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// derived objects...<br><br>private:<br>&nbsp;&nbsp;Uncopyable(const Uncopyable&amp;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ...but prevent copying<br>&nbsp;&nbsp;Uncopyable&amp; operator=(const Uncopyable&amp;);<br>};<br></p>
<p class="noindent">To keep <code>HomeForSale</code> objects from being copied, all we have to do now is inherit from <code>Uncopyable</code>:</p>
<p class="codelink"><a id="procode51"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode51">Click here to view code image</a></p>
<p class="programlisting"><br>class HomeForSale: <span class="courierb">private Uncopyable</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// class no longer<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// declares copy ctor or<br>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy assign. operator<br></p>
<p class="noindent">This works, because compilers will try to generate a copy constructor and a copy assignment operator if anybody — even a member or friend function — tries to copy a <code>HomeForSale</code> object. As <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec8">Item 12</a> explains, the compiler-generated versions of these functions will try to call their base class counterparts, and those calls will be rejected, because the copying operations are private in the base class.</p>
<p class="noindent">The implementation and use of <code>Uncopyable</code> include some subtleties, such as the fact that inheritance from <code>Uncopyable</code> needn't be public (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec1">Items 32</a> and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec8">39</a>) and that <code>Uncopyable</code>'s destructor need not be virtual (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec3">Item 7</a>). Because <code>Uncopyable</code> contains no data, it's eligible for the empty base class optimization described in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec8">Item 39</a>, but because it's a base class, use of this technique could lead to multiple inheritance (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec9">Item 40</a>). Multiple inheritance, in turn, can sometimes disable the empty base class optimization (again, see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec8">Item 39</a>). In general, you can ignore these subtleties and just use <code>Uncopyable</code> as shown, because it works precisely as advertised. You can also use the version available at Boost (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec3">Item 55</a>). That class is named <code>noncopyable</code>. It's a fine class, I just find the name a bit un-, er, <em>non</em>natural.</p>
<div class="note">
<h3 id="ch02note02">Things to Remember</h3>
<p class="indenthanding">• To disallow functionality automatically provided by compilers, declare the corresponding member functions <code>private</code> and give no implementations. Using a base class like <code>Uncopyable</code> is one way to do this.</p>
</div>
<h3 id="ch02lev1sec3">Item 7: Declare destructors virtual in polymorphic base classes</h3>
<p class="noindent"><a id="page_40"></a>There are lots of ways to keep track of time, so it would be reasonable to create a <code>TimeKeeper</code> base class along with derived classes for different approaches to timekeeping:</p>
<p class="codelink"><a id="procode52"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode52">Click here to view code image</a></p>
<p class="programlisting"><br>class TimeKeeper {<br>public:<br>&nbsp;&nbsp;TimeKeeper();<br>&nbsp;&nbsp;~TimeKeeper();<br>&nbsp;&nbsp;...<br>};<br><br>class AtomicClock: public TimeKeeper { ... };<br><br>class WaterClock: public TimeKeeper { ... };<br><br>class WristWatch: public TimeKeeper { ... };<br></p>
<p class="noindent">Many clients will want access to the time without worrying about the details of how it's calculated, so a <em>factory function</em> — a function that returns a base class pointer to a newly-created derived class object — can be used to return a pointer to a timekeeping object:</p>
<p class="codelink"><a id="procode53"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode53">Click here to view code image</a></p>
<p class="programlisting"><br>TimeKeeper* getTimeKeeper();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// returns a pointer to a dynamic-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ally allocated object of a class<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// derived from TimeKeeper<br></p>
<p class="noindent">In keeping with the conventions of factory functions, the objects returned by <code>getTimeKeeper</code> are on the heap, so to avoid leaking memory and other resources, it's important that each returned object be properly <code>delete</code>d:</p>
<p class="codelink"><a id="procode54"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode54">Click here to view code image</a></p>
<p class="programlisting"><br>TimeKeeper *ptk = getTimeKeeper();&nbsp;&nbsp;// get dynamically allocated object<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// from TimeKeeper hierarchy<br><br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use it<br><br>delete ptk;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// release it to avoid resource leak<br></p>
<p class="noindent"><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a> explains that relying on clients to perform the deletion is error-prone, and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec1">Item 18</a> explains how the interface to the factory function can be modified to prevent common client errors, but such concerns are secondary here, because in this Item we address a more fundamental weakness of the code above: even if clients do everything right, there is no way to know how the program will behave.</p>
<p class="noindent">The problem is that <code>getTimeKeeper</code> returns a pointer to a derived class object (e.g., <code>AtomicClock</code>), that object is being deleted via a base class pointer (i.e., a <code>TimeKeeper*</code> pointer), and the base class (<code>TimeKeeper</code>) has a <em>non-virtual destructor</em>. This is a recipe for disaster, because C++ <a id="page_41"></a>specifies that when a derived class object is deleted through a pointer to a base class with a non-virtual destructor, results are undefined. What typically happens at runtime is that the derived part of the object is never destroyed. If a call to <code>getTimeKeeper</code> happened to return a pointer to an <code>AtomicClock</code> object, the <code>AtomicClock</code> part of the object (i.e., the data members declared in the <code>AtomicClock</code> class) would probably not be destroyed, nor would the <code>AtomicClock</code> destructor run. However, the base class part (i.e., the <code>TimeKeeper</code> part) typically would be destroyed, thus leading to a curious “partially destroyed” object. This is an excellent way to leak resources, corrupt data structures, and spend a lot of time with a debugger.</p>
<p class="noindent">Eliminating the problem is simple: give the base class a virtual destructor. Then deleting a derived class object will do exactly what you want. It will destroy the entire object, including all its derived class parts:</p>
<p class="codelink"><a id="procode55"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode55">Click here to view code image</a></p>
<p class="programlisting"><br>class TimeKeeper {<br>public:<br>&nbsp;&nbsp;TimeKeeper();<br>&nbsp;&nbsp;<span class="courierb">virtual</span> ~TimeKeeper();<br>&nbsp;&nbsp;...<br>};<br>TimeKeeper *ptk = getTimeKeeper();<br><br>...<br><br>delete ptk;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// now behaves correctly<br></p>
<p class="noindent">Base classes like <code>TimeKeeper</code> generally contain virtual functions other than the destructor, because the purpose of virtual functions is to allow customization of derived class implementations (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec3">Item 34</a>). For example, <code>TimeKeeper</code> might have a virtual function, <code>getCurrentTime</code>, which would be implemented differently in the various derived classes. Any class with virtual functions should almost certainly have a virtual destructor.</p>
<p class="noindent">If a class does <em>not</em> contain virtual functions, that often indicates it is not meant to be used as a base class. When a class is not intended to be a base class, making the destructor virtual is usually a bad idea. Consider a class for representing points in two-dimensional space:</p>
<p class="codelink"><a id="procode56"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode56">Click here to view code image</a></p>
<p class="programlisting"><br>class Point {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// a 2D point<br>public:<br>&nbsp;&nbsp;Point(int xCoord, int yCoord);<br>&nbsp;&nbsp;~Point();<br><br>private:<br>&nbsp;&nbsp;int x, y;<br>};<br></p>
<p class="noindent"><a id="page_42"></a>If an <code>int</code> occupies 32 bits, a <code>Point</code> object can typically fit into a 64-bit register. Furthermore, such a <code>Point</code> object can be passed as a 64-bit quantity to functions written in other languages, such as C or FORTRAN. If <code>Point</code>'s destructor is made virtual, however, the situation changes.</p>
<p class="noindent">The implementation of virtual functions requires that objects carry information that can be used at runtime to determine which virtual functions should be invoked on the object. This information typically takes the form of a pointer called a <code>vptr</code> (“virtual table pointer”). The <code>vptr</code> points to an array of function pointers called a <code>vtbl</code> (“virtual table”); each class with virtual functions has an associated <code>vtbl</code>. When a virtual function is invoked on an object, the actual function called is determined by following the object's <code>vptr</code> to a <code>vtbl</code> and then looking up the appropriate function pointer in the <code>vtbl</code>.</p>
<p class="noindent">The details of how virtual functions are implemented are unimportant. What <em>is</em> important is that if the <code>Point</code> class contains a virtual function, objects of that type will increase in size. On a 32-bit architecture, they'll go from 64 bits (for the two <code>int</code>s) to 96 bits (for the <code>int</code>s plus the <code>vptr</code>); on a 64-bit architecture, they may go from 64 to 128 bits, because pointers on such architectures are 64 bits in size. Addition of a <code>vptr</code> to <code>Point</code> will thus increase its size by 50–100%! No longer can <code>Point</code> objects fit in a 64-bit register. Furthermore, <code>Point</code> objects in C++ can no longer look like the same structure declared in another language such as C, because their foreign language counterparts will lack the <code>vptr</code>. As a result, it is no longer possible to pass <code>Point</code>s to and from functions written in other languages unless you explicitly compensate for the <code>vptr</code>, which is itself an implementation detail and hence unportable.</p>
<p class="noindent">The bottom line is that gratuitously declaring all destructors virtual is just as wrong as never declaring them virtual. In fact, many people summarize the situation this way: declare a virtual destructor in a class if and only if that class contains at least one virtual function.</p>
<p class="noindent">It is possible to get bitten by the non-virtual destructor problem even in the complete absence of virtual functions. For example, the standard <code>string</code> type contains no virtual functions, but misguided programmers sometimes use it as a base class anyway:</p>
<p class="codelink"><a id="procode57"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode57">Click here to view code image</a></p>
<p class="programlisting"><br>class SpecialString: <span class="courierb">public std::string</span> {&nbsp;&nbsp;&nbsp;// bad idea! std::string has a<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// non-virtual destructor<br>};<br></p>
<p class="noindent">At first glance, this may look innocuous, but if anywhere in an application you somehow convert a pointer-to-<code>SpecialString</code> into a pointer-to- <code>string</code> <a id="page_43"></a>and you then use <code>delete</code> on the <code>string</code> pointer, you are instantly transported to the realm of undefined behavior:</p>
<p class="codelink"><a id="procode58"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode58">Click here to view code image</a></p>
<p class="programlisting"><br>SpecialString *pss =&nbsp;&nbsp;&nbsp;new SpecialString("Impending Doom");<br><br>std::string *ps;<br><br>...<br><br>ps = pss;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// SpecialString* ⇒std::string*<br><br>...<br><br>delete ps;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// undefined! In practice,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// *ps's SpecialString resources<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// will be leaked, because the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// SpecialString destructor won't<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// be called.<br></p>
<p class="noindent">The same analysis applies to any class lacking a virtual destructor, including all the STL container types (e.g., <code>vector</code>, <code>list</code>, <code>set</code>, <code>tr1::unordered_map</code> (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>), etc.). If you're ever tempted to inherit from a standard container or any other class with a non-virtual destructor, resist the temptation! (Unfortunately, C++ offers no derivation-prevention mechanism akin to Java's <code>final</code> classes or C#'s <code>sealed</code> classes.)</p>
<p class="noindent">Occasionally it can be convenient to give a class a pure virtual destructor. Recall that pure virtual functions result in <em>abstract</em> classes — classes that can't be instantiated (i.e., you can't create objects of that type). Sometimes, however, you have a class that you'd like to be abstract, but you don't have any pure virtual functions. What to do? Well, because an abstract class is intended to be used as a base class, and because a base class should have a virtual destructor, and because a pure virtual function yields an abstract class, the solution is simple: declare a pure virtual destructor in the class you want to be abstract. Here's an example:</p>
<p class="codelink"><a id="procode59"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode59">Click here to view code image</a></p>
<p class="programlisting"><br>class AWOV {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// AWOV = "Abstract w/o Virtuals"<br>public:<br>&nbsp;&nbsp;virtual ~AWOV() = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// declare pure virtual destructor<br>};<br></p>
<p class="noindent">This class has a pure virtual function, so it's abstract, and it has a virtual destructor, so you won't have to worry about the destructor problem. There is one twist, however: you must provide a <em>definition</em> for the pure virtual destructor:</p>
<p class="codelink"><a id="procode60"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode60">Click here to view code image</a></p>
<p class="programlisting"><br>AWOV::~AWOV() {}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// definition of pure virtual&nbsp;&nbsp;&nbsp;&nbsp;dtor<br></p>
<p class="noindent">The way destructors work is that the most derived class's destructor is called first, then the destructor of each base class is called. Compilers <a id="page_44"></a>will generate a call to <code>~AWOV</code> from its derived classes' destructors, so you have to be sure to provide a body for the function. If you don't, the linker will complain.</p>
<p class="noindent">The rule for giving base classes virtual destructors applies only to <em>polymorphic</em> base classes — to base classes designed to allow the manipulation of derived class types through base class interfaces. <code>TimeKeeper</code> is a polymorphic base class, because we expect to be able to manipulate <code>AtomicClock</code> and <code>WaterClock</code> objects, even if we have only <code>TimeKeeper</code> pointers to them.</p>
<p class="noindent">Not all base classes are designed to be used polymorphically. Neither the standard <code>string</code> type, for example, nor the STL container types are designed to be base classes at all, much less polymorphic ones. Some classes are designed to be used as base classes, yet are not designed to be used polymorphically. Such classes — examples include <code>Uncopyable</code> from <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec2">Item 6</a> and <code>input_iterator_tag</code> from the standard library (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec7">Item 47</a>) — are not designed to allow the manipulation of derived class objects via base class interfaces. As a result, they don't need virtual destructors.</p>
<div class="note">
<h3 id="ch02note03">Things to Remember</h3>
<p class="indenthanding">• Polymorphic base classes should declare virtual destructors. If a class has any virtual functions, it should have a virtual destructor.</p>
<p class="indenthanding">• Classes not designed to be base classes or not designed to be used polymorphically should not declare virtual destructors.</p>
</div>
<h3 id="ch02lev1sec4">Item 8: Prevent exceptions from leaving destructors</h3>
<p class="noindent">C++ doesn't prohibit destructors from emitting exceptions, but it certainly discourages the practice. With good reason. Consider:</p>
<p class="codelink"><a id="procode61"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode61">Click here to view code image</a></p>
<p class="programlisting"><br>class Widget {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;~Widget() { ... }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// assume this might emit an exception<br>};<br><br>void doSomething()<br>{<br>&nbsp;&nbsp;std::vector&lt;Widget&gt; v;<br>&nbsp;&nbsp;...<br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// v is automatically destroyed here<br></p>
<p class="noindent">When the <code>vector v</code> is destroyed, it is responsible for destroying all the <code>Widget</code>s it contains. Suppose <code>v</code> has ten <code>Widget</code>s in it, and during destruction of the first one, an exception is thrown. The other nine <a id="page_45"></a><code>Widget</code>s still have to be destroyed (otherwise any resources they hold would be leaked), so <code>v</code> should invoke their destructors. But suppose that during those calls, a second <code>Widget</code> destructor throws an exception. Now there are two simultaneously active exceptions, and that's one too many for C++. Depending on the precise conditions under which such pairs of simultaneously active exceptions arise, program execution either terminates or yields undefined behavior. In this example, it yields undefined behavior. It would yield equally undefined behavior using any other standard library container (e.g., <code>list</code>, <code>set</code>), any container in TR1 (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>), or even an array. Not that containers or arrays are required to get into trouble. Premature program termination or undefined behavior can result from destructors emitting exceptions even without using containers and arrays. C++ does <em>not</em> like destructors that emit exceptions!</p>
<p class="noindent">That's easy enough to understand, but what should you do if your destructor needs to perform an operation that may fail by throwing an exception? For example, suppose you're working with a class for database connections:</p>
<p class="codelink"><a id="procode62"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode62">Click here to view code image</a></p>
<p class="programlisting"><br>class DBConnection {<br>public:<br>&nbsp;&nbsp;...<br><br>&nbsp;&nbsp;static DBConnection create();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// function to return<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// DBConnection objects; params<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// omitted for simplicity<br><br>&nbsp;&nbsp;void close();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// close connection; throw an<br>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// exception if closing fails<br></p>
<p class="noindent">To ensure that clients don't forget to call <code>close</code> on <code>DBConnection</code> objects, a reasonable idea would be to create a resource-managing class for <code>DBConnection</code> that calls <code>close</code> in its destructor. Such resource-managing classes are explored in detail in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html">Chapter 3</a>, but here, it's enough to consider what the destructor for such a class would look like:</p>
<p class="codelink"><a id="procode63"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode63">Click here to view code image</a></p>
<p class="programlisting"><br>class DBConn {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// class to manage DBConnection<br>public:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// objects<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;<span class="courierb">~DBConn()</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// make sure database connections<br>&nbsp;&nbsp;<span class="courierb">{</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// are always closed<br>&nbsp;&nbsp;&nbsp;<span class="courierb">db.close();</span><br>&nbsp;&nbsp;&nbsp;<span class="courierb">}</span><br>private:<br>&nbsp;&nbsp;DBConnection db;<br>};<br></p>
<p class="noindent">That allows clients to program like this:</p>
<p class="codelink"><a id="procode64"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode64">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_46"></a>{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// open a block<br><br>&nbsp;&nbsp;&nbsp;DBConn dbc(DBConnection::create());&nbsp;&nbsp;// create DBConnection object<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// and turn it over to a DBConn<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object to manage<br><br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use the DBConnection object<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// via the DBConn interface<br><br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// at end of block, the DBConn<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object is destroyed, thus<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// automatically calling close on<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the DBConnection object<br></p>
<p class="noindent">This is fine as long as the call to <code>close</code> succeeds, but if the call yields an exception, <code>DBConn</code>'s destructor will propagate that exception, i.e., allow it to leave the destructor. That's a problem, because destructors that throw mean trouble.</p>
<p class="noindent">There are two primary ways to avoid the trouble. <code>DBConn</code>'s destructor could:</p>
<p class="indenthanding">• <strong>Terminate the program</strong> if <code>close</code> throws, typically by calling <code>abort</code>:</p>
<p class="codelink"><a id="procode65"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode65">Click here to view code image</a></p>
<p class="programlisting"><br>DBConn::~DBConn()<br>{<br><span class="courierb">try { db.close(); }</span><br><span class="courierb">catch (...) {</span><br>&nbsp;&nbsp;&nbsp;<span class="courierb"><span class="courieri">make log entry that the call to close failed;</span></span><br>&nbsp;&nbsp;&nbsp;<span class="courierb">std::abort();</span><br>}<br>}<br></p>
<p class="noindent">This is a reasonable option if the program cannot continue to run after an error is encountered during destruction. It has the advantage that if allowing the exception to propagate from the destructor would lead to undefined behavior, this prevents that from happening. That is, calling <code>abort</code> may forestall undefined behavior.</p>
<p class="indenthanding">• <strong>Swallow the exception</strong> arising from the call to <code>close</code>:</p>
<p class="codelink"><a id="procode66"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode66">Click here to view code image</a></p>
<p class="programlisting"><br>DBConn::~DBConn()<br>{<br><span class="courierb">try { db.close(); }</span><br><span class="courierb">catch (...) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb"><span class="courieri">make log entry that the call to close failed;</span></span><br><span class="courierb">}</span><br>}<br></p>
<p class="noindent">In general, swallowing exceptions is a bad idea, because it suppresses important information — <em>something failed!</em> Sometimes, however, swallowing exceptions is preferable to running the risk of <a id="page_47"></a>premature program termination or undefined behavior. For this to be a viable option, the program must be able to reliably continue execution even after an error has been encountered and ignored.</p>
<p class="noindent">Neither of these approaches is especially appealing. The problem with both is that the program has no way to react to the condition that led to <code>close</code> throwing an exception in the first place.</p>
<p class="noindent">A better strategy is to design <code>DBConn</code>'s interface so that its clients have an opportunity to react to problems that may arise. For example, <code>DBConn</code> could offer a <code>close</code> function itself, thus giving clients a chance to handle exceptions arising from that operation. It could also keep track of whether its <code>DBConnection</code> had been <code>close</code>d, closing it itself in the destructor if not. That would prevent a connection from leaking. If the call to <code>close</code> were to fail in the <code>DBConnection</code> destructor, however, we'd be back to terminating or swallowing:</p>
<p class="codelink"><a id="procode67"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode67">Click here to view code image</a></p>
<p class="programlisting"><br>class DBConn {<br>public:<br>&nbsp;&nbsp;...<br><br>&nbsp;&nbsp;<span class="courierb">void close()</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// new function for<br>&nbsp;&nbsp;<span class="courierb">{</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// client use<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">db.close();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">closed = true;</span><br>&nbsp;&nbsp;<span class="courierb">}</span><br><br>&nbsp;&nbsp;~DBConn()<br>&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;<span class="courierb">if (!closed) {</span><br>&nbsp;&nbsp;&nbsp;<span class="courierb">try {</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// close the connection<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">db.close();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if the client didn't<br>&nbsp;&nbsp;&nbsp;<span class="courierb">}</span><br>&nbsp;&nbsp;&nbsp;<span class="courierb">catch (...) {</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if closing fails,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb"><span class="courieri">make log entry that call to close failed;</span></span>&nbsp;&nbsp;&nbsp;// note that and<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">...</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// terminate or swallow<br>&nbsp;&nbsp;&nbsp;<span class="courierb">}</span><br>&nbsp;&nbsp;}<br><br>private:<br>&nbsp;&nbsp;DBConnection db;<br>&nbsp;&nbsp;<span class="courierb">bool closed;</span><br>};<br></p>
<p class="noindent">Moving the responsibility for calling <code>close</code> from <code>DBConn</code>'s destructor to <code>DBConn</code>'s client (with <code>DBConn</code>'s destructor containing a “backup” call) may strike you as an unscrupulous shift of burden. You might even view it as a violation of <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec1">Item 18</a>'s advice to make interfaces easy to use correctly. In fact, it's neither. If an operation may fail by throwing an exception and there may be a need to handle that exception, the exception <em>has to come from some non-destructor function</em>. That's <a id="page_48"></a>because destructors that emit exceptions are dangerous, always running the risk of premature program termination or undefined behavior. In this example, telling clients to call <code>close</code> themselves doesn't impose a burden on them; it gives them an opportunity to deal with errors they would otherwise have no chance to react to. If they don't find that opportunity useful (perhaps because they believe that no error will really occur), they can ignore it, relying on <code>DBConn</code>'s destructor to call <code>close</code> for them. If an error occurs at that point — if <code>close</code> <em>does</em> throw — they're in no position to complain if <code>DBConn</code> swallows the exception or terminates the program. After all, they had first crack at dealing with the problem, and they chose not to use it.</p>
<div class="note">
<h3 id="ch02note04">Things to Remember</h3>
<p class="indenthanding">• Destructors should never emit exceptions. If functions called in a destructor may throw, the destructor should catch any exceptions, then swallow them or terminate the program.</p>
<p class="indenthanding">• If class clients need to be able to react to exceptions thrown during an operation, the class should provide a regular (i.e., non-destructor) function that performs the operation.</p>
</div>
<h3 id="ch02lev1sec5">Item 9: Never call virtual functions during construction or destruction</h3>
<p class="noindent">I'll begin with the recap: you shouldn't call virtual functions during construction or destruction, because the calls won't do what you think, and if they did, you'd still be unhappy. If you're a recovering Java or C# programmer, pay close attention to this Item, because this is a place where those languages zig, while C++ zags.</p>
<p class="noindent">Suppose you've got a class hierarchy for modeling stock transactions, e.g., buy orders, sell orders, etc. It's important that such transactions be auditable, so each time a transaction object is created, an appropriate entry needs to be created in an audit log. This seems like a reasonable way to approach the problem:</p>
<p class="codelink"><a id="procode68"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode68">Click here to view code image</a></p>
<p class="programlisting"><br>class Transaction {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// base class for all<br>public:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// transactions<br>&nbsp;&nbsp;Transaction();<br><br>&nbsp;&nbsp;<span class="courierb">virtual</span> void logTransaction() const = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// make type-dependent<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// log entry<br>&nbsp;&nbsp;...<br>};<br><br><a id="page_49"></a>Transaction::Transaction()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// implementation of<br>{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// base class ctor<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;logTransaction();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// as final action, log this<br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// transaction<br>class BuyTransaction: public Transaction {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// derived class<br>public:<br>&nbsp;&nbsp;virtual void logTransaction() const;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// how to log trans-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// actions of this type<br>&nbsp;&nbsp;...<br>};<br>class SellTransaction: public Transaction {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// derived class<br>public:<br>virtual void logTransaction() const;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// how to log trans-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// actions of this type<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">Consider what happens when this code is executed:</p>
<p class="programlisting"><br>BuyTransaction b;<br></p>
<p class="noindent">Clearly a <code>BuyTransaction</code> constructor will be called, but first, a <code>Transaction</code> constructor must be called; base class parts of derived class objects are constructed before derived class parts are. The last line of the <code>Transaction</code> constructor calls the virtual function <code>logTransaction</code>, but this is where the surprise comes in. The version of <code>logTransaction</code> that's called is the one in <code>Transaction</code>, <em>not</em> the one in <code>BuyTransaction</code> — even though the type of object being created is <code>BuyTransaction</code>. During base class construction, virtual functions never go down into derived classes. Instead, the object behaves as if it were of the base type. Informally speaking, during base class construction, virtual functions aren't.</p>
<p class="noindent">There's a good reason for this seemingly counterintuitive behavior. Because base class constructors execute before derived class constructors, derived class data members have not been initialized when base class constructors run. If virtual functions called during base class construction went down to derived classes, the derived class functions would almost certainly refer to local data members, but those data members would not yet have been initialized. That would be a non-stop ticket to undefined behavior and late-night debugging sessions. Calling down to parts of an object that have not yet been initialized is inherently dangerous, so C++ gives you no way to do it.</p>
<p class="noindent">It's actually more fundamental than that. During base class construction of a derived class object, the type of the object <em>is</em> that of the base <a id="page_50"></a>class. Not only do virtual functions resolve to the base class, but the parts of the language using runtime type information (e.g., <code>dynamic_cast</code> (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec2">Item 27</a>) and <code>typeid</code>) treat the object as a base class type. In our example, while the <code>Transaction</code> constructor is running to initialize the base class part of a <code>BuyTransaction</code> object, the object is of type <code>Transaction</code>. That's how every part of C++ will treat it, and the treatment makes sense: the <code>BuyTransaction</code>-specific parts of the object haven't been initialized yet, so it's safest to treat them as if they didn't exist. An object doesn't become a derived class object until execution of a derived class constructor begins.</p>
<p class="noindent">The same reasoning applies during destruction. Once a derived class destructor has run, the object's derived class data members assume undefined values, so C++ treats them as if they no longer exist. Upon entry to the base class destructor, the object becomes a base class object, and all parts of C++ — virtual functions, <code>dynamic_cast</code>s, etc., — treat it that way.</p>
<p class="noindent">In the example code above, the <code>Transaction</code> constructor made a direct call to a virtual function, a clear and easy-to-see violation of this Item's guidance. The violation is so easy to see, some compilers issue a warning about it. (Others don't. See <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec1">Item 53</a> for a discussion of warnings.) Even without such a warning, the problem would almost certainly become apparent before runtime, because the <code>logTransaction</code> function is pure virtual in <code>Transaction.</code> Unless it had been defined (unlikely, but possible — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec3">Item 34</a>), the program wouldn't link: the linker would be unable to find the necessary implementation of <code>Transaction::logTransaction</code>.</p>
<p class="noindent">It's not always so easy to detect calls to virtual functions during construction or destruction. If <code>Transaction</code> had multiple constructors, each of which had to perform some of the same work, it would be good software engineering to avoid code replication by putting the common initialization code, including the call to <code>logTransaction</code>, into a private non-virtual initialization function, say, <code>init</code>:</p>
<p class="codelink"><a id="procode69"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode69">Click here to view code image</a></p>
<p class="programlisting"><br>class Transaction {<br>public:<br>&nbsp;&nbsp;Transaction()<br>&nbsp;&nbsp;<span class="courierb">{ init(); }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call to non-virtual...<br><br>&nbsp;&nbsp;virtual void logTransaction() const = 0;<br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;<span class="courierb">void init()</span><br>&nbsp;&nbsp;<span class="courierb">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">logTransaction();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ...that calls a virtual!<br>&nbsp;&nbsp;<span class="courierb">}</span><br>};<br></p>
<p class="noindent"><a id="page_51"></a>This code is conceptually the same as the earlier version, but it's more insidious, because it will typically compile and link without complaint. In this case, because <code>logTransaction</code> is pure virtual in <code>Transaction</code>, most runtime systems will abort the program when the pure virtual is called (typically issuing a message to that effect). However, if <code>logTransaction</code> were a “normal” virtual function (i.e., not pure virtual) with an implementation in <code>Transaction</code>, that version would be called, and the program would merrily trot along, leaving you to figure out why the wrong version of <code>logTransaction</code> was called when a derived class object was created. The only way to avoid this problem is to make sure that none of your constructors or destructors call virtual functions on the object being created or destroyed and that all the functions they call obey the same constraint.</p>
<p class="noindent">But how <em>do</em> you ensure that the proper version of <code>logTransaction</code> is called each time an object in the <code>Transaction</code> hierarchy is created? Clearly, calling a virtual function on the object from the <code>Transaction</code> constructor(s) is the wrong way to do it.</p>
<p class="noindent">There are different ways to approach this problem. One is to turn <code>logTransaction</code> into a non-virtual function in <code>Transaction</code>, then require that derived class constructors pass the necessary log information to the <code>Transaction</code> constructor. That function can then safely call the non-virtual <code>logTransaction</code>. Like this:</p>
<p class="codelink"><a id="procode70"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode70">Click here to view code image</a></p>
<p class="programlisting"><br>class Transaction {<br>public:<br>&nbsp;&nbsp;explicit Transaction(<span class="courierb">const std::string&amp; logInfo</span>);<br><br>&nbsp;&nbsp;void logTransaction(<span class="courierb">const std::string&amp; logInfo</span>) const;&nbsp;&nbsp;&nbsp;// now a non-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// virtual func<br>&nbsp;&nbsp;...<br>};<br><br>Transaction::Transaction(<span class="courierb">const std::string&amp; logInfo</span>)<br>{<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;logTransaction(<span class="courierb">logInfo</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// now a non-<br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// virtual call<br><br>class BuyTransaction: public Transaction {<br>public:<br>BuyTransaction( <span class="courieri">parameters</span> )<br>: <span class="courierb">Transaction(createLogString(<span class="courieri">parameters</span></span> <span class="courierb">))</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// pass log info<br>&nbsp;&nbsp;{ ... }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// to base class<br>&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// constructor<br><br>private:<br>&nbsp;&nbsp;static std::string createLogString( <span class="courieri">parameters</span> );<br>};<br></p>
<p class="noindent"><a id="page_52"></a>In other words, since you can't use virtual functions to call down from base classes during construction, you can compensate by having derived classes pass necessary construction information up to base class constructors instead.</p>
<p class="noindent">In this example, note the use of the (private) static function <code>createLogString</code> in <code>BuyTransaction</code>. Using a helper function to create a value to pass to a base class constructor is often more convenient (and more readable) that going through contortions in the member initialization list to give the base class what it needs. By making the function static, there's no danger of accidentally referring to the nascent <code>BuyTransaction</code> object's as-yet-uninitialized data members. That's important, because the fact that those data members will be in an undefined state is why calling virtual functions during base class construction and destruction doesn't go down into derived classes in the first place.</p>
<div class="note">
<h3 id="ch02note05">Things to Remember</h3>
<p class="indenthanding">• Don't call virtual functions during construction or destruction, because such calls will never go to a more derived class than that of the currently executing constructor or destructor.</p>
</div>
<h3 id="ch02lev1sec6">Item 10: Have assignment operators return a reference to <code>*this</code></h3>
<p class="noindent">One of the interesting things about assignments is that you can chain them together:</p>
<p class="codelink"><a id="procode71"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode71">Click here to view code image</a></p>
<p class="programlisting"><br>int x, y, z;<br><br><span class="courierb">x = y = z = 15;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// chain of assignments<br></p>
<p class="noindent">Also interesting is that assignment is right-associative, so the above assignment chain is parsed like this:</p>
<p class="programlisting"><br>x = (y = (z = 15));<br></p>
<p class="noindent">Here, 15 is assigned to <code>z</code>, then the result of that assignment (the updated <code>z</code>) is assigned to <code>y</code>, then the result of that assignment (the updated <code>y</code>) is assigned to <code>x</code>.</p>
<p class="noindent">The way this is implemented is that assignment returns a reference to its left-hand argument, and that's the convention you should follow when you implement assignment operators for your classes:</p>
<p class="codelink"><a id="procode72"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode72">Click here to view code image</a></p>
<p class="programlisting"><br>class Widget {<br>public:<br>&nbsp;&nbsp;...<br><br><a id="page_53"></a><span class="courierb">Widget&amp;</span> operator=(const Widget&amp; rhs)&nbsp;&nbsp;&nbsp;// return type is a reference to<br>{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the current class<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;<span class="courierb">return *this;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// return the left-hand object<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">This convention applies to all assignment operators, not just the standard form shown above. Hence:</p>
<p class="codelink"><a id="procode73"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode73">Click here to view code image</a></p>
<p class="programlisting"><br>class Widget {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;Widget&amp; <span class="courierb">operator</span>+=(const Widget&amp; rhs&nbsp;&nbsp;&nbsp;// the convention applies to<br>&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// +=, -=, *=, etc.<br>&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;&nbsp;return *this;<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;Widget&amp; operator=(<span class="courierb">int</span> rhs)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// it applies even if the<br>&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// operator's parameter type<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// is unconventional<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return *this;<br>&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">This is only a convention; code that doesn't follow it will compile. However, the convention is followed by all the built-in types as well as by all the types in (or soon to be in — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>) the standard library (e.g., <code>string</code>, <code>vector</code>, <code>complex</code>, <code>tr1::shared_ptr</code>, etc.). Unless you have a good reason for doing things differently, don't.</p>
<div class="note">
<h3 id="ch02note06">Things to Remember</h3>
<p class="indenthanding">• Have assignment operators return a reference to <code>*this</code>.</p>
</div>
<h3 id="ch02lev1sec7">Item 11: Handle assignment to self in <code>operator=</code></h3>
<p class="noindent">An assignment to self occurs when an object is assigned to itself:</p>
<p class="codelink"><a id="procode74"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode74">Click here to view code image</a></p>
<p class="programlisting"><br>class Widget { ... };<br><br>Widget w;<br>...<br><br>w = w;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// assignment to self<br></p>
<p class="noindent">This looks silly, but it's legal, so rest assured that clients will do it. Besides, assignment isn't always so recognizable. For example,</p>
<p class="codelink"><a id="procode75"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode75">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_54"></a>a[i] = a[j];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// potential assignment to self<br></p>
<p class="noindent">is an assignment to self if <code>i</code> and <code>j</code> have the same value, and</p>
<p class="codelink"><a id="procode76"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode76">Click here to view code image</a></p>
<p class="programlisting"><br>*px = *py;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// potential assignment to self<br></p>
<p class="noindent">is an assignment to self if <code>px</code> and <code>py</code> happen to point to the same thing. These less obvious assignments to self are the result of <em>aliasing</em>: having more than one way to refer to an object. In general, code that operates on references or pointers to multiple objects of the same type needs to consider that the objects might be the same. In fact, the two objects need not even be declared to be of the same type if they're from the same hierarchy, because a base class reference or pointer can refer or point to an object of a derived class type:</p>
<p class="codelink"><a id="procode77"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode77">Click here to view code image</a></p>
<p class="programlisting"><br>class Base { ... };<br><br>class Derived: public Base { ... };<br><br>void doSomething(const <span class="courierb">Base&amp;</span> rb,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// rb and *pd might actually be<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">Derived*</span> pd);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the same object<br></p>
<p class="noindent">If you follow the advice of <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Items 13</a> and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec2">14</a>, you'll always use objects to manage resources, and you'll make sure that the resource-managing objects behave well when copied. When that's the case, your assignment operators will probably be self-assignment-safe without your having to think about it. If you try to manage resources yourself, however (which you'd certainly have to do if you were writing a resource-managing class), you can fall into the trap of accidentally releasing a resource before you're done using it. For example, suppose you create a class that holds a raw pointer to a dynamically allocated bitmap:</p>
<p class="codelink"><a id="procode78"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode78">Click here to view code image</a></p>
<p class="programlisting"><br>class Bitmap { ... };<br><br>class Widget {<br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;Bitmap *pb;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ptr to a heap-allocated object<br>};<br></p>
<p class="noindent">Here's an implementation of <code>operator=</code> that looks reasonable on the surface but is unsafe in the presence of assignment to self. (It's also not exception-safe, but we'll deal with that in a moment.)</p>
<p class="codelink"><a id="procode79"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode79">Click here to view code image</a></p>
<p class="programlisting"><br>Widget&amp;<br>Widget::operator=(const Widget&amp; rhs)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// <span class="courierb">unsafe impl. of operator=</span><br>{<br>&nbsp;&nbsp;delete pb;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// stop using current bitmap<br>&nbsp;&nbsp;pb = new Bitmap(*rhs.pb);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// start using a copy of rhs's bitmap<br><br>&nbsp;&nbsp;return *this;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 10<br>}<br></p>
<p class="noindent"><a id="page_55"></a>The self-assignment problem here is that inside <code>operator=</code>, <code>*this</code> (the target of the assignment) and <code>rhs</code> could be the same object. When they are, the <code>delete</code> not only destroys the bitmap for the current object, it destroys the bitmap for <code>rhs</code>, too. At the end of the function, the <code>Widget</code> — which should not have been changed by the assignment to self — finds itself holding a pointer to a deleted object!<sup><a id="ch02fn00" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/footnotes.html#ftn.ch02fn00" class="totri-footnote">†</a></sup></p>
<p class="noindent">The traditional way to prevent this error is to check for assignment to self via an <em>identity test</em> at the top of <code>operator=</code>:</p>
<p class="codelink"><a id="procode80"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode80">Click here to view code image</a></p>
<p class="programlisting"><br>Widget&amp; Widget::operator=(const Widget&amp; rhs)<br>{<br>&nbsp;&nbsp;<span class="courierb">if (this == &amp;rhs) return *this;</span>&nbsp;&nbsp;&nbsp;// identity test: if a self-assignment,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do nothing<br>&nbsp;&nbsp;delete pb;<br>&nbsp;&nbsp;pb = new Bitmap(*rhs.pb);<br><br>&nbsp;&nbsp;return *this;<br>}<br></p>
<p class="noindent">This works, but I mentioned above that the previous version of <code>operator=</code> wasn't just self-assignment-unsafe, it was also exception-unsafe, and this version continues to have exception trouble. In particular, if the “<code>new Bitmap</code>” expression yields an exception (either because there is insufficient memory for the allocation or because <code>Bitmap</code>'s copy constructor throws one), the <code>Widget</code> will end up holding a pointer to a deleted <code>Bitmap</code>.<sup>[<a class="nounder totri-footnote" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/footnotes.html#ftn.ch02fn00">†</a></sup> Such pointers are toxic. You can't safely delete them. You can't even safely read them. About the only safe thing you can do with them is spend lots of debugging energy figuring out where they came from.</p>
<p class="noindent">Happily, making <code>operator=</code> exception-safe typically renders it self-assignment-safe, too. As a result, it's increasingly common to deal with issues of self-assignment by ignoring them, focusing instead on achieving exception safety. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec4">Item 29</a> explores exception safety in depth, but in this Item, it suffices to observe that in many cases, a careful ordering of statements can yield exception-safe (and self-assignment-safe) code. Here, for example, we just have to be careful not to delete <code>pb</code> until after we've copied what it points to:</p>
<p class="codelink"><a id="procode81"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode81">Click here to view code image</a></p>
<p class="programlisting"><br>Widget&amp; Widget::operator=(const Widget&amp; rhs)<br>{<br>&nbsp;&nbsp;<span class="courierb">Bitmap *pOrig = pb;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// remember original pb<br>&nbsp;&nbsp;<span class="courierb">pb = new Bitmap(*rhs.pb);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// point pb to a copy of rhs's bitmap<br>&nbsp;&nbsp;<span class="courierb">delete pOrig;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// delete the original pb<br><br>&nbsp;&nbsp;return *this;<br>}<br></p>
<p class="noindent"><a id="page_56"></a>Now, if “<code>new Bitmap</code>” throws an exception, <code>pb</code> (and the <code>Widget</code> it's inside of) remains unchanged. Even without the identity test, this code handles assignment to self, because we make a copy of the original bitmap, point to the copy we made, then delete the original bitmap. It may not be the most efficient way to handle self-assignment, but it does work.</p>
<p class="noindent">If you're concerned about efficiency, you could put the identity test back at the top of the function. Before doing that, however, ask yourself how often you expect self-assignments to occur, because the test isn't free. It makes the code (both source and object) a bit bigger, and it introduces a branch into the flow of control, both of which can decrease runtime speed. The effectiveness of instruction prefetching, caching, and pipelining can be reduced, for example.</p>
<p class="noindent">An alternative to manually ordering statements in <code>operator=</code> to make sure the implementation is both exception- and self-assignment-safe is to use the technique known as “copy and swap.” This technique is closely associated with exception safety, so it's described in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec4">Item 29</a>. However, it's a common enough way to write <code>operator=</code> that it's worth seeing what such an implementation often looks like:</p>
<p class="codelink"><a id="procode82"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode82">Click here to view code image</a></p>
<p class="programlisting"><br>class Widget {<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void swap(Widget&amp; rhs);&nbsp;&nbsp;&nbsp;// exchange *this's and rhs's data;<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 29 for details<br>};<br><br>Widget&amp; Widget::operator=(const Widget&amp; rhs)<br>{<br>&nbsp;&nbsp;<span class="courierb">Widget temp(rhs);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// make a copy of rhs's data<br><br>&nbsp;&nbsp;<span class="courierb">swap(temp);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// swap *this's data with the copy's<br>&nbsp;&nbsp;return *this;<br>}<br></p>
<p class="noindent">A variation on this theme takes advantage of the facts that (1) a class's copy assignment operator may be declared to take its argument by value and (2) passing something by value makes a <em>copy</em> of it (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec3">Item 20</a>):</p>
<p class="codelink"><a id="procode83"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode83">Click here to view code image</a></p>
<p class="programlisting"><br>Widget&amp; Widget::operator=(<span class="courierb">Widget</span> rhs)&nbsp;&nbsp;&nbsp;// rhs is a <span class="courieri">copy</span> of the object<br>{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// passed in — note pass by val<br><br>&nbsp;&nbsp;swap(rhs);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// swap *this's data with<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the copy's<br><br>&nbsp;&nbsp;return *this;<br>}<br></p>
<p class="noindent"><a id="page_57"></a>Personally, I worry that this approach sacrifices clarity at the altar of cleverness, but by moving the copying operation from the body of the function to construction of the parameter, it's a fact that compilers can sometimes generate more efficient code.</p>
<div class="note">
<h3 id="ch02note07">Things to Remember</h3>
<p class="indenthanding">• Make sure <code>operator=</code> is well-behaved when an object is assigned to itself. Techniques include comparing addresses of source and target objects, careful statement ordering, and copy-and-<code>swap</code>.</p>
<p class="indenthanding">• Make sure that any function operating on more than one object behaves correctly if two or more of the objects are the same.</p>
</div>
<h3 id="ch02lev1sec8">Item 12: Copy all parts of an object</h3>
<p class="noindent">In well-designed object-oriented systems that encapsulate the internal parts of objects, only two functions copy objects: the aptly named copy constructor and copy assignment operator. We'll call these the <em>copying functions</em>. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec1">Item 5</a> observes that compilers will generate the copying functions, if needed, and it explains that the compiler-generated versions do precisely what you'd expect: they copy all the data of the object being copied.</p>
<p class="noindent">When you declare your own copying functions, you are indicating to compilers that there is something about the default implementations you don't like. Compilers seem to take offense at this, and they retaliate in a curious fashion: they don't tell you when your implementations are almost certainly wrong.</p>
<p class="noindent">Consider a class representing customers, where the copying functions have been manually written so that calls to them are logged:</p>
<p class="codelink"><a id="procode84"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode84">Click here to view code image</a></p>
<p class="programlisting"><br>void logCall(const std::string&amp; funcName);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// make a log entry<br><br>class Customer {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;Customer(const Customer&amp; rhs);<br>&nbsp;&nbsp;Customer&amp; operator=(const Customer&amp; rhs);<br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;std::string name;<br>};<br><br><a id="page_58"></a>Customer::Customer(const Customer&amp; rhs)<br>: name(rhs.name)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy rhs's data<br>{<br>&nbsp;&nbsp;logCall("Customer copy constructor");<br>}<br><br>Customer&amp; Customer::operator=(const Customer&amp; rhs)<br>{<br>&nbsp;&nbsp;logCall("Customer copy assignment operator");<br><br>&nbsp;&nbsp;name = rhs.name;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy rhs's data<br><br>&nbsp;&nbsp;return *this;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 10<br>}<br></p>
<p class="noindent">Everything here looks fine, and in fact everything is fine — until another data member is added to <code>Customer</code>:</p>
<p class="codelink"><a id="procode85"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode85">Click here to view code image</a></p>
<p class="programlisting"><br>class Date { ... };&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for dates in time<br><br>class Customer {<br>public:<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// as before<br><br>private:<br>&nbsp;&nbsp;std::string name;<br>&nbsp;&nbsp;<span class="courierb">Date lastTransaction;</span><br>};<br></p>
<p class="noindent">At this point, the existing copying functions are performing a <em>partial copy</em>: they're copying the customer's <code>name</code>, but not its <code>lastTransaction</code>. Yet most compilers say nothing about this, not even at maximal warning level (see also <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec1">Item 53</a>). That's their revenge for your writing the copying functions yourself. You reject the copying functions they'd write, so they don't tell you if your code is incomplete. The conclusion is obvious: if you add a data member to a class, you need to make sure that you update the copying functions, too. (You'll also need to update all the constructors (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec4">Items 4</a> and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec5">45</a>) as well as any non-standard forms of <code>operator=</code> in the class (<a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec6">Item 10</a> gives an example). If you forget, compilers are unlikely to remind you.)</p>
<p class="noindent">One of the most insidious ways this issue can arise is through inheritance. Consider:</p>
<p class="codelink"><a id="procode86"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode86">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">class PriorityCustomer: public Customer</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// a derived class<br>public:<br>&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;&nbsp;PriorityCustomer(const PriorityCustomer&amp; rhs);<br>&nbsp;&nbsp;&nbsp;PriorityCustomer&amp; operator=(const PriorityCustomer&amp; rhs);<br>&nbsp;&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;&nbsp;int priority;<br>};<br><br><a id="page_59"></a>PriorityCustomer::PriorityCustomer(const PriorityCustomer&amp; rhs)<br>: priority(rhs.priority)<br>{<br>&nbsp;&nbsp;logCall("PriorityCustomer copy constructor");<br>}<br><br>PriorityCustomer&amp;<br>PriorityCustomer::operator=(const PriorityCustomer&amp; rhs)<br>{<br>&nbsp;&nbsp;logCall("PriorityCustomer copy assignment operator");<br><br>&nbsp;&nbsp;priority = rhs.priority;<br><br>&nbsp;&nbsp;return *this;<br>}<br></p>
<p class="noindent"><code>PriorityCustomer</code>'s copying functions look like they're copying everything in <code>PriorityCustomer</code>, but look again. Yes, they copy the data member that <code>PriorityCustomer</code> declares, but every <code>PriorityCustomer</code> also contains a copy of the data members it inherits from <code>Customer</code>, and those data members are not being copied at all! <code>PriorityCustomer</code>'s copy constructor specifies no arguments to be passed to its base class constructor (i.e., it makes no mention of <code>Customer</code> on its member initialization list), so the <code>Customer</code> part of the <code>PriorityCustomer</code> object will be initialized by the <code>Customer</code> constructor taking no arguments — by the default constructor. (Assuming it has one. If not, the code won't compile.) That constructor will perform a <em>default</em> initialization for <code>name</code> and <code>lastTransaction</code>.</p>
<p class="noindent">The situation is only slightly different for <code>PriorityCustomer</code>'s copy assignment operator. It makes no attempt to modify its base class data members in any way, so they'll remain unchanged.</p>
<p class="noindent">Any time you take it upon yourself to write copying functions for a derived class, you must take care to also copy the base class parts. Those parts are typically private, of course (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec5">Item 22</a>), so you can't access them directly. Instead, derived class copying functions must invoke their corresponding base class functions:</p>
<p class="codelink"><a id="procode87"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode87">Click here to view code image</a></p>
<p class="programlisting"><br>PriorityCustomer::PriorityCustomer(const PriorityCustomer&amp; rhs)<br>:&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">Customer(rhs),</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// invoke base class copy ctor<br>&nbsp;&nbsp;priority(rhs.priority)<br>{<br>&nbsp;&nbsp;logCall("PriorityCustomer copy constructor");<br>}<br><br>PriorityCustomer&amp;<br>PriorityCustomer::operator=(const PriorityCustomer&amp; rhs)<br>{<br>&nbsp;&nbsp;logCall("PriorityCustomer copy assignment operator");<br><br>&nbsp;&nbsp;<span class="courierb">Customer::operator=(rhs);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// assign base class parts<br>&nbsp;&nbsp;priority = rhs.priority;<br><br>&nbsp;&nbsp;return *this;<br>}<br></p>
<p class="noindent"><a id="page_60"></a>The meaning of “copy all parts” in this Item's title should now be clear. When you're writing a copying function, be sure to (1) copy all local data members and (2) invoke the appropriate copying function in all base classes, too.</p>
<p class="noindent">In practice, the two copying functions will often have similar bodies, and this may tempt you to try to avoid code duplication by having one function call the other. Your desire to avoid code duplication is laudable, but having one copying function call the other is the wrong way to achieve it.</p>
<p class="noindent">It makes no sense to have the copy assignment operator call the copy constructor, because you'd be trying to construct an object that already exists. This is so nonsensical, there's not even a syntax for it. There are syntaxes that <em>look</em> like you're doing it, but you're not; and there are syntaxes that <em>do</em> do it in a backwards kind of way, but they corrupt your object under some conditions. So I'm not going to show you any of those syntaxes. Simply accept that having the copy assignment operator call the copy constructor is something you don't want to do.</p>
<p class="noindent">Trying things the other way around — having the copy constructor call the copy assignment operator — is equally nonsensical. A constructor initializes new objects, but an assignment operator applies only to objects that have already been initialized. Performing an assignment on an object under construction would mean doing something to a not-yet-initialized object that makes sense only for an initialized object. Nonsense! Don't try it.</p>
<p class="noindent">Instead, if you find that your copy constructor and copy assignment operator have similar code bodies, eliminate the duplication by creating a third member function that both call. Such a function is typically private and is often named <code>init</code>. This strategy is a safe, proven way to eliminate code duplication in copy constructors and copy assignment operators.</p>
<div class="note">
<h3 id="ch02note08">Things to Remember</h3>
<p class="indenthanding">• Copying functions should be sure to copy all of an object's data members and all of its base class parts.</p>
<p class="indenthanding">• Don't try to implement one of the copying functions in terms of the other. Instead, put common functionality in a third function that both call.</p>
</div>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/Library/view/effective-c-55/0321334876/ch01.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">1. Accustoming Yourself to C++</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/Library/view/effective-c-55/0321334876/ch03.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">3. Resource Management</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/0321334876/chapter/ch02.html" data-for-analytics="0321334876:ch02.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>
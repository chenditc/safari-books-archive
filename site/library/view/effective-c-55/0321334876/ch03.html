<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/effective-c-55/0321334876/ch03.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="0321334876"
  data-publishers="Addison-Wesley Professional"



  data-htmlfile-name="ch03.html"
  data-epub-title="Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/effective-c-55/0321334876/ch03.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="0321334876" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch03.html" data-epub-title="Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://0321334876"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>3. Resource Management - Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content div{margin-top:5pt;margin-bottom:5pt;margin-right:15pt}#sbo-rt-content .cover{margin-top:2pt;margin-bottom:2pt;text-align:center}#sbo-rt-content h1{page-break-before:right;margin-top:5pt;text-align:center;margin-bottom:12pt;font-weight:bold}#sbo-rt-content .subtitle{font-size:large;margin-top:30pt;margin-bottom:55pt;font-weight:bold;text-align:center}#sbo-rt-content .publisher{text-align:center;margin-top:64pt;margin-bottom:4pt}#sbo-rt-content .copyright{margin-top:5pt;margin-bottom:5pt;text-indent:.12pt}#sbo-rt-content h2{page-break-before:right;margin-top:7pt;margin-bottom:25pt;font-weight:bold}#sbo-rt-content h3{margin-top:9pt;margin-bottom:8pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content h4{margin-top:9pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content h5{margin-top:9pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content h6{margin-top:8pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content .author{text-align:center;font-weight:bold;margin-top:66pt;margin-bottom:24pt}#sbo-rt-content .bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content .toc-chapter{margin-top:12pt;margin-bottom:5pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .emphasis{font-style:italic}#sbo-rt-content .mediaobject{margin-top:12pt;margin-bottom:12pt;text-align:center}#sbo-rt-content .tabimage{margin-top:12pt;margin-bottom:12pt;text-align:center}#sbo-rt-content .smaller{font-size:small}#sbo-rt-content .center{margin-top:50pt;margin-bottom:5pt;text-align:center}#sbo-rt-content .note{margin-top:6pt;margin-bottom:12pt;margin-left:.12pt;text-indent:.12pt;margin-right:24pt}#sbo-rt-content .toc-preface{margin-top:5pt;margin-bottom:5pt;margin-left:1pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .programlisting{font-family:"Courier New";font-size:small;margin-top:8pt;margin-bottom:8pt;text-indent:.12pt}#sbo-rt-content .programlisting1{font-family:"Courier New";font-size:small;margin-top:5pt;margin-bottom:4pt;margin-left:36pt;text-indent:.12pt}#sbo-rt-content code{font-size:x-small}#sbo-rt-content .toc-section{margin-top:4pt;margin-bottom:4pt;margin-left:12pt;text-indent:.12pt}#sbo-rt-content .toc-index{margin-top:12pt;margin-bottom:4pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .toc-appendix{margin-top:12pt;margin-bottom:4pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .strong{font-weight:bold}#sbo-rt-content .italic{font-style:italic}#sbo-rt-content .title{margin-top:12pt;margin-bottom:6pt;font-size:medium;font-weight:bold;text-align:center}#sbo-rt-content .attribution{margin-top:4pt;margin-bottom:12pt;margin-right:15pt;text-align:right}#sbo-rt-content .indexmain{margin-top:2pt;margin-bottom:2pt;text-indent:.12pt}#sbo-rt-content .indexsub{margin-top:2pt;margin-bottom:2pt;margin-left:24pt;text-indent:.12pt}#sbo-rt-content .indexsubsub{margin-top:2pt;margin-bottom:2pt;margin-left:40pt;text-indent:.12pt}#sbo-rt-content .paraindent{margin-top:4pt;margin-bottom:4pt;margin-left:25pt;text-indent:.12pt}#sbo-rt-content .indenthanding{margin-top:4pt;margin-bottom:4pt;padding-left:25pt;text-indent:-15pt}#sbo-rt-content .indenthanding1{margin-top:4pt;margin-bottom:4pt;padding-left:48pt;text-indent:-8pt}#sbo-rt-content .underline{text-decoration:underline}#sbo-rt-content .footnotes{font-size:small;margin-top:5pt;margin-bottom:4pt;padding-left:20pt;text-indent:-8pt}#sbo-rt-content .courierb{font-family:"Courier New Bold"}#sbo-rt-content .courieri{font-family:"Courier New Italic"}#sbo-rt-content .center1{margin-top:4pt;margin-bottom:4pt;margin-left:80pt;text-align:center}#sbo-rt-content .noindent{margin-top:6pt;margin-bottom:5pt;text-indent:.12pt}#sbo-rt-content .noindent1{margin-top:12pt;margin-bottom:2pt;text-indent:.12pt}#sbo-rt-content .edition{font-size:1.2em;margin-top:2pt;margin-bottom:2pt;text-align:center}#sbo-rt-content .image1{page-break-before:always;page-break-after:always}#sbo-rt-content .codelink{margin-top:6pt;margin-bottom:6pt;text-indent:.12pt;font-weight:bold;page-break-after:avoid;font-size:small}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch03.html"><meta name="description" content="3. Resource Management A resource is something that, once you're done using it, you need to return to the system. If you don't, bad things happen. In C ... "><meta property="og:title" content="3. Resource Management"><meta itemprop="isPartOf" content="/library/view/effective-c-55/0321334876/"><meta itemprop="name" content="3. Resource Management"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch03.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/0321334876/"><meta property="og:description" itemprop="description" content="3. Resource Management A resource is something that, once you're done using it, you need to return to the system. If you don't, bad things happen. In C ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="0321334876"><meta property="og:book:author" itemprop="author" content="Scott Meyers"><meta property="og:book:tag" itemprop="about" content="C++"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/0321334876/chapter/ch03.html" data-for-analytics="0321334876:ch03.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch03.html&amp;text=Effective%20C%2B%2B%3A%2055%20Specific%20Ways%20to%20Improve%20Your%20Programs%20and%20Designs%2C%20Third%20Edition&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch03.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch03.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%203.%20Resource%20Management&amp;body=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch03.html%0D%0Afrom%20Effective%20C%2B%2B%3A%2055%20Specific%20Ways%20to%20Improve%20Your%20Programs%20and%20Designs%2C%20Third%20Edition%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch02.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">2. Constructors, Destructors, and Assignment Operators</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch04.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">4. Designs and Declarations</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><h2 id="ch03">3. Resource Management</h2>
<p class="noindent"><a id="page_61"></a>A resource is something that, once you're done using it, you need to return to the system. If you don't, bad things happen. In C++ programs, the most commonly used resource is dynamically allocated memory (if you allocate memory and never deallocate it, you've got a memory leak), but memory is only one of many resources you must manage. Other common resources include file descriptors, mutex locks, fonts and brushes in graphical user interfaces (GUIs), database connections, and network sockets. Regardless of the resource, it's important that it be released when you're finished with it.</p>
<p class="noindent">Trying to ensure this by hand is difficult under any conditions, but when you consider exceptions, functions with multiple return paths, and maintenance programmers modifying software without fully comprehending the impact of their changes, it becomes clear that ad hoc ways of dealing with resource management aren't sufficient.</p>
<p class="noindent">This chapter begins with a straightforward object-based approach to resource management built on C++'s support for constructors, destructors, and copying operations. Experience has shown that disciplined adherence to this approach can all but eliminate resource management problems. The chapter then moves on to Items dedicated specifically to memory management. These latter Items complement the more general Items that come earlier, because objects that manage memory have to know how to do it properly.</p>
<h3 id="ch03lev1sec1">Item 13: Use objects to manage resources.</h3>
<p class="noindent">Suppose we're working with a library for modeling investments (e.g., stocks, bonds, etc.), where the various investment types inherit from a root class <code>Investment</code>:</p>
<p class="codelink"><a id="procode88"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode88">Click here to view code image</a></p>
<p class="programlisting"><br>class Investment { ... };&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// root class of hierarchy of<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// investment types<br></p>
<p class="noindent"><a id="page_62"></a>Further suppose that the way the library provides us with specific <code>Investment</code> objects is through a factory function (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec3">Item 7</a>):</p>
<p class="codelink"><a id="procode89"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode89">Click here to view code image</a></p>
<p class="programlisting"><br>Investment* createInvestment();&nbsp;&nbsp;// return ptr to dynamically allocated<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object in the Investment hierarchy;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the caller must delete it<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// (parameters omitted for simplicity)<br></p>
<p class="noindent">As the comment indicates, callers of <code>createInvestment</code> are responsible for deleting the object that function returns when they are done with it. Consider, then, a function <code>f</code> written to fulfill this obligation:</p>
<p class="codelink"><a id="procode90"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode90">Click here to view code image</a></p>
<p class="programlisting"><br>void f()<br>{<br>&nbsp;&nbsp;Investment *pInv = createInvestment();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call factory function<br><br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use pInv<br><br>&nbsp;&nbsp;delete pInv;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// release object<br>}<br></p>
<p class="noindent">This looks okay, but there are several ways <code>f</code> could fail to delete the investment object it gets from <code>createInvestment</code>. There might be a premature <code>return</code> statement somewhere inside the “...” part of the function. If such a <code>return</code> were executed, control would never reach the <code>delete</code> statement. A similar situation would arise if the uses of <code>createInvestment</code> and <code>delete</code> were in a loop, and the loop was prematurely exited by a <code>continue</code> or <code>goto</code> statement. Finally, some statement inside the “...” might throw an exception. If so, control would again not get to the <code>delete</code>. Regardless of how the <code>delete</code> were skipped, we'd leak not only the memory containing the investment object but also any resources held by that object.</p>
<p class="noindent">Of course, careful programming could prevent these kinds of errors, but think about how the code might change over time. As the software gets maintained, somebody might add a <code>return</code> or <code>continue</code> statement without fully grasping the repercussions on the rest of the function's resource management strategy. Even worse, the “...” part of <code>f</code> might call a function that never used to throw an exception but suddenly starts doing so after it has been “improved.” Relying on <code>f</code> always getting to its <code>delete</code> statement simply isn't viable.</p>
<p class="noindent">To make sure that the resource returned by <code>createInvestment</code> is always released, we need to put that resource inside an object whose destructor will automatically release the resource when control leaves <code>f</code>. In fact, that's half the idea behind this Item: by putting resources inside objects, we can rely on C++'s automatic destructor invocation to make sure that the resources are released. (We'll discuss the other half of the idea in a moment.)</p>
<p class="noindent"><a id="page_63"></a>Many resources are dynamically allocated on the heap, are used only within a single block or function, and should be released when control leaves that block or function. The standard library's <code>auto_ptr</code> is tailor-made for this kind of situation. <code>auto_ptr</code> is a pointer-like object (a <em>smart pointer</em>) whose destructor automatically calls <code>delete</code> on what it points to. Here's how to use <code>auto_ptr</code> to prevent <code>f</code>'s potential resource leak:</p>
<p class="codelink"><a id="procode91"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode91">Click here to view code image</a></p>
<p class="programlisting"><br>void f()<br>{<br>&nbsp;&nbsp;<span class="courierb">std::auto_ptr&lt;Investment&gt;</span> pInv(createInvestment());&nbsp;&nbsp;// call factory<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// function<br><br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use pInv as<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// before<br><br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// automatically<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// delete pInv via<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// auto_ptr's dtor<br></p>
<p class="noindent">This simple example demonstrates the two critical aspects of using objects to manage resources:</p>
<p class="indenthanding">• <strong>Resources are acquired and immediately turned over to resource-managing objects.</strong> Above, the resource returned by <code>createInvestment</code> is used to initialize the <code>auto_ptr</code> that will manage it. In fact, the idea of using objects to manage resources is often called <em>Resource Acquisition Is Initialization</em> (RAII), because it's so common to acquire a resource and initialize a resource-managing object in the same statement. Sometimes acquired resources are <em>assigned</em> to resource-managing objects instead of initializing them, but either way, every resource is immediately turned over to a resource-managing object at the time the resource is acquired.</p>
<p class="indenthanding">• <strong>Resource-managing objects use their destructors to ensure that resources are released.</strong> Because destructors are called automatically when an object is destroyed (e.g., when an object goes out of scope), resources are correctly released, regardless of how control leaves a block. Things can get tricky when the act of releasing resources can lead to exceptions being thrown, but that's a matter addressed by <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec4">Item 8</a>, so we'll not worry about it here.</p>
<p class="noindent">Because an <code>auto_ptr</code> automatically deletes what it points to when the <code>auto_ptr</code> is destroyed, it's important that there never be more than one <code>auto_ptr</code> pointing to an object. If there were, the object would be deleted more than once, and that would put your program on the fast track to undefined behavior. To prevent such problems, <code>auto_ptr</code>s have an unusual characteristic: copying them (via copy constructor or copy <a id="page_64"></a>assignment operator) sets them to null, and the copying pointer assumes sole ownership of the resource!</p>
<p class="codelink"><a id="procode92"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode92">Click here to view code image</a></p>
<p class="programlisting"><br>std::auto_ptr&lt;Investment&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// pInv1 points to the<br>&nbsp;&nbsp;pInv1(createInvestment());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object returned from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// createInvestment<br><br>std::auto_ptr&lt;Investment&gt; pInv2(pInv1);&nbsp;&nbsp;&nbsp;// pInv2 now points to the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object; pInv1 is now null<br><br>pInv1 = pInv2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// now pInv1 points to the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object, and pInv2 is null<br></p>
<p class="noindent">This odd copying behavior, plus the underlying requirement that resources managed by <code>auto_ptr</code>s must never have more than one <code>auto_ptr</code> pointing to them, means that <code>auto_ptr</code>s aren't the best way to manage all dynamically allocated resources. For example, STL containers require that their contents exhibit “normal” copying behavior, so containers of <code>auto_ptr</code> aren't allowed.</p>
<p class="noindent">An alternative to <code>auto_ptr</code> is a <em>reference-counting smart pointer</em> (RCSP). An RCSP is a smart pointer that keeps track of how many objects point to a particular resource and automatically deletes the resource when nobody is pointing to it any longer. As such, RCSPs offer behavior that is similar to that of garbage collection. Unlike garbage collection, however, RCSPs can't break cycles of references (e.g., two otherwise unused objects that point to one another).</p>
<p class="noindent">TR1's <code>tr1::shared_ptr</code> (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>) is an RCSP, so you could write <code>f</code> this way:</p>
<p class="codelink"><a id="procode93"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode93">Click here to view code image</a></p>
<p class="programlisting"><br>void f()<br>{<br>&nbsp;&nbsp;...<br><br>&nbsp;&nbsp;<span class="courierb">std::tr1::shared_ptr&lt;Investment&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;pInv(createInvestment());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call factory function<br><br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use pInv as before<br><br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// automatically delete<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// pInv via shared_ptr's dtor<br></p>
<p class="noindent">This code looks almost the same as that employing <code>auto_ptr</code>, but copying <code>shared_ptr</code>s behaves much more naturally:</p>
<p class="codelink"><a id="procode94"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode94">Click here to view code image</a></p>
<p class="programlisting"><br>void f()<br>{<br>&nbsp;&nbsp;...<br><br>&nbsp;&nbsp;<span class="courierb">std::tr1::shared_ptr</span>&lt;Investment&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// pInv1 points to the<br>&nbsp;&nbsp;&nbsp;&nbsp;pInv1(createInvestment());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object returned from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// createInvestment<br><br><br><a id="page_65"></a>&nbsp;&nbsp;<span class="courierb">std::tr1::shared_ptr</span>&lt;Investment&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// both<br>pInv1 and pInv2 now<br>&nbsp;&nbsp;&nbsp;&nbsp;pInv2(pInv1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// point to the object<br><br>&nbsp;&nbsp;pInv1 = pInv2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ditto — nothing has<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// changed<br>&nbsp;&nbsp;...<br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// pInv1 and pInv2 are<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destroyed, and the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object they point to is<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// automatically deleted<br></p>
<p class="noindent">Because copying <code>tr1::shared_ptr</code>s works “as expected,” they can be used in STL containers and other contexts where <code>auto_ptr</code>'s unorthodox copying behavior is inappropriate.</p>
<p class="noindent">Don't be misled, though. This Item isn't about <code>auto_ptr</code>, <code>tr1::shared_ptr</code>, or any other kind of smart pointer. It's about the importance of using objects to manage resources. <code>auto_ptr</code> and <code>tr1::shared_ptr</code> are just examples of objects that do that. (For more information on <code>tr1:shared_ptr</code>, consult <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec2">Items 14</a>, <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec1">18</a>, and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">54</a>.)</p>
<p class="noindent">Both <code>auto_ptr</code> and <code>tr1::shared_ptr</code> use <code>delete</code> in their destructors, not <code>delete []</code>. (<a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec4">Item 16</a> describes the difference.) That means that using <code>auto_ptr</code> or <code>tr1::shared_ptr</code> with dynamically allocated arrays is a bad idea, though, regrettably, one that will compile:</p>
<p class="codelink"><a id="procode95"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode95">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">std::auto_ptr</span>&lt;std::string&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// bad idea! the wrong<br>&nbsp;&nbsp;aps(<span class="courierb">new</span> std::string<span class="courierb">[</span>10<span class="courierb">]</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// delete form will be used<br><br><span class="courierb">std::tr1::shared_ptr</span>&lt;int&gt; spi(<span class="courierb">new</span> int<span class="courierb">[</span>1024<span class="courierb">]</span>);&nbsp;&nbsp;&nbsp;&nbsp;// same problem<br></p>
<p class="noindent">You may be surprised to discover that there is nothing like <code>auto_ptr</code> or <code>tr1::shared_ptr</code> for dynamically allocated arrays in C++, not even in TR1. That's because <code>vector</code> and <code>string</code> can almost always replace dynamically allocated arrays. If you still think it would be nice to have <code>auto_ptr</code>- and <code>tr1::shared_ptr</code>-like classes for arrays, look to Boost (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec3">Item 55</a>). There you'll be pleased to find the <code>boost::scoped_array</code> and <code>boost::shared_array</code> classes that offer the behavior you're looking for.</p>
<p class="noindent">This Item's guidance to use objects to manage resources suggests that if you're releasing resources manually (e.g., using <code>delete</code> other than in a resource-managing class), you're doing something wrong. Pre-canned resource-managing classes like <code>auto_ptr and tr1::shared_ptr</code> often make following this Item's advice easy, but sometimes you're using a resource where these pre-fab classes don't do what you need. When that's the case, you'll need to craft your own resource-managing classes. That's not terribly difficult to do, but it does involve some subtleties you'll need to consider. Those considerations are the topic of <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec2">Items 14</a> and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec3">15</a>.</p>
<p class="noindent"><a id="page_66"></a>As a final comment, I have to point out that <code>createInvestment</code>'s raw pointer return type is an invitation to a resource leak, because it's so easy for callers to forget to call <code>delete</code> on the pointer they get back. (Even if they use an <code>auto_ptr</code> or <code>tr1::shared_ptr</code> to perform the <code>delete</code>, they still have to remember to store <code>createInvestment</code>'s return value in a smart pointer object.) Combatting that problem calls for an interface modification to <code>createInvestment</code>, a topic I address in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec1">Item 18</a>.</p>
<div class="note">
<h3 id="ch03note01">Things to Remember</h3>
<p class="indenthanding">• To prevent resource leaks, use RAII objects that acquire resources in their constructors and release them in their destructors.</p>
<p class="indenthanding">• Two commonly useful RAII classes are <code>tr1::shared_ptr</code> and <code>auto_ptr</code>. <code>tr1::shared_ptr</code> is usually the better choice, because its behavior when copied is intuitive. Copying an <code>auto_ptr</code> sets it to null.</p>
</div>
<h3 id="ch03lev1sec2">Item 14: Think carefully about copying behavior in resource-managing classes.</h3>
<p class="noindent"><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a> introduces the idea of <em>Resource Acquisition Is Initialization</em> (RAII) as the backbone of resource-managing classes, and it describes how <code>auto_ptr</code> and <code>tr1::shared_ptr</code> are manifestations of this idea for heap-based resources. Not all resources are heap-based, however, and for such resources, smart pointers like <code>auto_ptr</code> and <code>tr1::shared_ptr</code> are generally inappropriate as resource handlers. That being the case, you're likely to find yourself needing to create your own resource-managing classes from time to time.</p>
<p class="noindent">For example, suppose you're using a C API to manipulate mutex objects of type <code>Mutex</code> offering functions <code>lock</code> and <code>unlock</code>:</p>
<p class="codelink"><a id="procode96"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode96">Click here to view code image</a></p>
<p class="programlisting"><br>void lock(Mutex *pm);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// lock mutex pointed to by pm<br><br>void unlock(Mutex *pm);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// unlock the mutex<br></p>
<p class="noindent">To make sure that you never forget to unlock a <code>Mutex</code> you've locked, you'd like to create a class to manage locks. The basic structure of such a class is dictated by the RAII principle that resources are acquired during construction and released during destruction:</p>
<p class="codelink"><a id="procode97"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode97">Click here to view code image</a></p>
<p class="programlisting"><br>class Lock {<br>public:<br>&nbsp;&nbsp;explicit Lock(Mutex *pm)<br>&nbsp;&nbsp;: mutexPtr(pm)<br>&nbsp;&nbsp;{ lock(mutexPtr); }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// acquire resource<br><br>&nbsp;&nbsp;~Lock() { unlock(mutexPtr); }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// release resource<br><br>private:<br>&nbsp;&nbsp;Mutex *mutexPtr;<br>};<br></p>
<p class="noindent"><a id="page_67"></a>Clients use <code>Lock</code> in the conventional RAII fashion:</p>
<p class="codelink"><a id="procode98"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode98">Click here to view code image</a></p>
<p class="programlisting"><br>Mutex m;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// define the mutex you need to use<br><br>...<br><br>{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// create block to define critical section<br><span class="courierb">Lock</span> ml(&amp;m);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// lock the mutex<br><br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// perform critical section operations<br><br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// automatically unlock mutex at end<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// of block<br></p>
<p class="noindent">This is fine, but what should happen if a <code>Lock</code> object is copied?</p>
<p class="codelink"><a id="procode99"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode99">Click here to view code image</a></p>
<p class="programlisting"><br>Lock ml1(&amp;m);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// lock m<br><br><span class="courierb">Lock ml2(ml1);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// copy ml1 to ml2—what should<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// happen here?<br></p>
<p class="noindent">This is a specific example of a more general question, one that every RAII class author must confront: what should happen when an RAII object is copied? Most of the time, you'll want to choose one of the following possibilities:</p>
<p class="indenthanding">• <strong>Prohibit copying.</strong> In many cases, it makes no sense to allow RAII objects to be copied. This is likely to be true for a class like <code>Lock</code>, because it rarely makes sense to have “copies” of synchronization primitives. When copying makes no sense for an RAII class, you should prohibit it. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec2">Item 6</a> explains how to do that: declare the copying operations private. For <code>Lock</code>, that could look like this:</p>
<p class="codelink"><a id="procode100"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode100">Click here to view code image</a></p>
<p class="programlisting1"><br>class Lock: <span class="courierb">private Uncopyable</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// prohibit copying — see<br>public:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Item 6<br><br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// as before<br><br>};<br></p>
<p class="indenthanding">• <strong>Reference-count the underlying resource.</strong> Sometimes it's desirable to hold on to a resource until the last object using it has been destroyed. When that's the case, copying an RAII object should increment the count of the number of objects referring to the resource. This is the meaning of “copy” used by <code>tr1::shared_ptr</code>.</p>
<p class="paraindent">Often, RAII classes can implement reference-counting copying behavior by containing a <code>tr1::shared_ptr</code> data member. For example, if <code>Lock</code> wanted to employ reference counting, it could change the type of <code>mutexPtr</code> from <code>Mutex*</code> to <code>tr1::shared_ptr&lt;Mutex&gt;</code>. Unfortunately, <code>tr1::shared_ptr</code>'s default behavior is to delete what it points to when the reference count goes to zero, and that's not what we want. When we're done with a <code>Mutex</code>, we want to unlock it, not delete it.</p>
<p class="paraindent"><a id="page_68"></a>Fortunately, <code>tr1::shared_ptr</code> allows specification of a “deleter” — a function or function object to be called when the reference count goes to zero. (This functionality does not exist for <code>auto_ptr</code>, which <em>always</em> deletes its pointer.) The deleter is an optional second parameter to the <code>tr1::shared_ptr</code> constructor, so the code would look like this:</p>
<p class="codelink"><a id="procode101"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode101">Click here to view code image</a></p>
<p class="programlisting"><br>class Lock {<br>public:<br>&nbsp;&nbsp;explicit Lock(Mutex *pm)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// init shared_ptr with the Mutex<br>&nbsp;&nbsp;: mutexPtr(pm<span class="courierb">, unlock</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// to point to and the unlock func<br>&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// as the deleter<br><br>&nbsp;&nbsp;&nbsp;&nbsp;lock(mutexPtr<span class="courierb">.get()</span>);&nbsp;&nbsp;&nbsp;// see Item 15 for info on "get"<br>&nbsp;&nbsp;}<br>private:<br>&nbsp;&nbsp;<span class="courierb">std::tr1::shared_ptr&lt;Mutex&gt;</span> mutexPtr;&nbsp;&nbsp;&nbsp;&nbsp;// use shared_ptr<br>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// instead of raw pointer<br></p>
<p class="paraindent">In this example, notice how the <code>Lock</code> class no longer declares a destructor. That's because there's no need to. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec1">Item 5</a> explains that a class's destructor (regardless of whether it is compiler-generated or user-defined) automatically invokes the destructors of the class's non-static data members. In this example, that's <code>mutexPtr</code>. But <code>mutexPtr</code>'s destructor will automatically call the <code>tr1::shared_ptr</code>'s deleter — <code>unlock</code>, in this case — when the mutex's reference count goes to zero. (People looking at the class's source code would probably appreciate a comment indicating that you didn't forget about destruction, you're just relying on the default compiler-generated behavior.)</p>
<p class="indenthanding">• <strong>Copy the underlying resource.</strong> Sometimes you can have as many copies of a resource as you like, and the only reason you need a resource-managing class is to make sure that each copy is released when you're done with it. In that case, copying the resource-managing object should also copy the resource it wraps. That is, copying a resource-managing object performs a “deep copy.”</p>
<p class="paraindent">Some implementations of the standard <code>string</code> type consist of pointers to heap memory, where the characters making up the string are stored. Objects of such <code>string</code>s contain a pointer to the heap memory. When a <code>string</code> object is copied, a copy is made of both the pointer and the memory it points to. Such <code>string</code>s exhibit deep copying.</p>
<p class="indenthanding">• <strong>Transfer ownership of the underlying resource.</strong> On rare occasion, you may wish to make sure that only one RAII object refers <a id="page_69"></a>to a raw resource and that when the RAII object is copied, ownership of the resource is transferred from the copied object to the copying object. As explained in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>, this is the meaning of “copy” used by <code>auto_ptr</code>.</p>
<p class="noindent">The copying functions (copy constructor and copy assignment operator) may be generated by compilers, so unless the compiler-generated versions will do what you want (<a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec1">Item 5</a> explains the default behavior), you'll need to write them yourself. In some cases, you'll also want to support generalized versions of these functions. Such versions are described in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec5">Item 45</a>.</p>
<div class="note">
<h3 id="ch03note02">Things to Remember</h3>
<p class="indenthanding">• Copying an RAII object entails copying the resource it manages, so the copying behavior of the resource determines the copying behavior of the RAII object.</p>
<p class="indenthanding">• Common RAII class copying behaviors are disallowing copying and performing reference counting, but other behaviors are possible.</p>
</div>
<h3 id="ch03lev1sec3">Item 15: Provide access to raw resources in resource-managing classes.</h3>
<p class="noindent">Resource-managing classes are wonderful. They're your bulwark against resource leaks, the absence of such leaks being a fundamental characteristic of well-designed systems. In a perfect world, you'd rely on such classes for all your interactions with resources, never sullying your hands with direct access to raw resources. But the world is not perfect. Many APIs refer to resources directly, so unless you plan to foreswear use of such APIs (something that's rarely practical), you'll have to bypass resource-managing objects and deal with raw resources from time to time.</p>
<p class="noindent">For example, <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a> introduces the idea of using smart pointers like <code>auto_ptr</code> or <code>tr1::shared_ptr</code> to hold the result of a call to a factory function like <code>createInvestment</code>:</p>
<p class="codelink"><a id="procode102"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode102">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">std::tr1::shared_ptr&lt;Investment&gt;</span> pInv(createInvestment());&nbsp;&nbsp;// from Item 13<br></p>
<p class="noindent">Suppose that a function you'd like to use when working with <code>Investment</code> objects is this:</p>
<p class="codelink"><a id="procode103"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode103">Click here to view code image</a></p>
<p class="programlisting"><br>int daysHeld(const Investment *pi);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// return number of days<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// investment has been held<br></p>
<p class="noindent"><a id="page_70"></a>You'd like to call it like this,</p>
<p class="codelink"><a id="procode104"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode104">Click here to view code image</a></p>
<p class="programlisting"><br>int days = daysHeld(pInv);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// error!<br></p>
<p class="noindent">but the code won't compile: <code>daysHeld</code> wants a raw <code>Investment*</code> pointer, but you're passing an object of type <code>tr1::shared_ptr&lt;Investment&gt;</code>.</p>
<p class="noindent">You need a way to convert an object of the RAII class (in this case, <code>tr1::shared_ptr</code>) into the raw resource it contains (e.g., the underlying <code>Investment*</code>). There are two general ways to do it: explicit conversion and implicit conversion.</p>
<p class="noindent"><code>tr1::shared_ptr</code> and <code>auto_ptr</code> both offer a <code>get</code> member function to perform an explicit conversion, i.e., to return (a copy of) the raw pointer inside the smart pointer object:</p>
<p class="codelink"><a id="procode105"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode105">Click here to view code image</a></p>
<p class="programlisting"><br>int days = daysHeld(pInv<span class="courierb">.get()</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// fine, passes the raw pointer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// in pInv to daysHeld<br></p>
<p class="noindent">Like virtually all smart pointer classes, <code>tr1::shared_ptr</code> and <code>auto_ptr</code> also overload the pointer dereferencing operators (<code>operator-&gt;</code> and <code>operator*</code>), and this allows implicit conversion to the underlying raw pointers:</p>
<p class="codelink"><a id="procode106"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode106">Click here to view code image</a></p>
<p class="programlisting"><br>class Investment {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// root class for a hierarchy<br>public:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// of investment types<br>&nbsp;&nbsp;bool isTaxFree() const;<br>&nbsp;&nbsp;...<br>};<br>Investment* createInvestment();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// factory function<br><br>std::tr1::shared_ptr&lt;Investment&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// have tr1::shared_ptr<br>&nbsp;&nbsp;pi1(createInvestment());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// manage a resource<br><br>bool taxable1 = !(pi1<span class="courierb">-&gt;</span>isTaxFree());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// access resource<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// via operator-&gt;<br>...<br>std::auto_ptr&lt;Investment&gt; pi2(createInvestment()); // have auto_ptr<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// manage a<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// resource<br><br>bool taxable2 = !((<span class="courierb">*</span>pi2).isTaxFree());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// access resource<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// via operator*<br>...<br></p>
<p class="noindent">Because it is sometimes necessary to get at the raw resource inside an RAII object, some RAII class designers grease the skids by offering an implicit conversion function. For example, consider this RAII class for fonts that are native to a C API:</p>
<p class="codelink"><a id="procode107"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode107">Click here to view code image</a></p>
<p class="programlisting"><br>FontHandle getFont();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// from C API—params omitted<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for simplicity<br><br>void releaseFont(FontHandle fh);&nbsp;&nbsp;&nbsp;&nbsp;// from the same C API<br><br><a id="page_71"></a>class Font {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// RAII class<br>public:<br>&nbsp;&nbsp;explicit Font(FontHandle fh)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// acquire resource;<br>&nbsp;&nbsp;: f(fh)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use pass-by-value, because the<br>&nbsp;&nbsp;{}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// C API does<br><br>&nbsp;&nbsp;~Font() { releaseFont(f); }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// release resource<br><br>private:<br>&nbsp;&nbsp;FontHandle f;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the raw font resource<br>};<br></p>
<p class="noindent">Assuming there's a large font-related C API that deals entirely with <code>FontHandle</code>s, there will be a frequent need to convert from <code>Font</code> objects to <code>FontHandle</code>s. The <code>Font</code> class could offer an explicit conversion function such as <code>get</code>:</p>
<p class="codelink"><a id="procode108"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode108">Click here to view code image</a></p>
<p class="programlisting"><br>class Font {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;<span class="courierb">FontHandle get() const { return f; }</span>&nbsp;&nbsp;// explicit conversion function<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">Unfortunately, this would require that clients call <code>get</code> every time they want to communicate with the API:</p>
<p class="codelink"><a id="procode109"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode109">Click here to view code image</a></p>
<p class="programlisting"><br>void changeFontSize(FontHandle f, int newSize);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// from the C API<br><br>Font f(getFont());<br>int newFontSize;<br><br>...<br><br>changeFontSize(f<span class="courierb">.get()</span>, newFontSize);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// explicitly convert<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Font to FontHandle<br></p>
<p class="noindent">Some programmers might find the need to explicitly request such conversions off-putting enough to avoid using the class. That, in turn, would increase the chances of leaking fonts, the very thing the <code>Font</code> class is designed to prevent.</p>
<p class="noindent">The alternative is to have <code>Font</code> offer an implicit conversion function to its <code>FontHandle</code>:</p>
<p class="codelink"><a id="procode110"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode110">Click here to view code image</a></p>
<p class="programlisting"><br>class Font {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;<span class="courierb">operator FontHandle() const { return f; }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// implicit conversion function<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">That makes calling into the C API easy and natural:</p>
<p class="codelink"><a id="procode111"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode111">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_72"></a>Font f(getFont());<br>int newFontSize;<br><br>...<br><br>changeFontSize(<span class="courierb">f</span>, newFontSize);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// implicitly convert Font<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// to FontHandle<br></p>
<p class="noindent">The downside is that implicit conversions increase the chance of errors. For example, a client might accidently create a <code>FontHandle</code> when a <code>Font</code> was intended:</p>
<p class="codelink"><a id="procode112"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode112">Click here to view code image</a></p>
<p class="programlisting"><br>Font f1(getFont());<br><br>...<br><br><span class="courierb">FontHandle</span> f2 = f1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// oops! meant to copy a Font<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// object, but instead implicitly<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// converted f1 into its underlying<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// FontHandle, then copied that<br></p>
<p class="noindent">Now the program has a <code>FontHandle</code> being managed by the <code>Font</code> object <code>f1</code>, but the <code>FontHandle</code> is also available for direct use as <code>f2</code>. That's almost never good. For example, when <code>f1</code> is destroyed, the font will be released, and <code>f2</code> will dangle.</p>
<p class="noindent">The decision about whether to offer explicit conversion from an RAII class to its underlying resource (e.g., via a <code>get</code> member function) or whether to allow implicit conversion is one that depends on the specific task the RAII class is designed to perform and the circumstances in which it is intended to be used. The best design is likely to be the one that adheres to <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec1">Item 18</a>'s advice to make interfaces easy to use correctly and hard to use incorrectly. Often, an explicit conversion function like <code>get</code> is the preferable path, because it minimizes the chances of unintended type conversions. Sometimes, however, the naturalness of use arising from implicit type conversions will tip the scales in that direction.</p>
<p class="noindent">It may have occurred to you that functions returning the raw resource inside an RAII class are contrary to encapsulation. That's true, but it's not the design disaster it may at first appear. RAII classes don't exist to encapsulate something; they exist to ensure that a particular action—resource release—takes place. If desired, encapsulation of the resource can be layered on top of this primary functionality, but it's not necessary. Furthermore, some RAII classes combine true encapsulation of implementation with very loose encapsulation of the underlying resource. For example, <code>tr1::shared_ptr</code> encapsulates all its reference-counting machinery, but it still offers easy access to the raw pointer it contains. Like most well-designed classes, it hides what clients <a id="page_73"></a>don't need to see, but it makes available those things that clients honestly need to access.</p>
<div class="note">
<h3 id="ch03note03">Things to Remember</h3>
<p class="indenthanding">• APIs often require access to raw resources, so each RAII class should offer a way to get at the resource it manages.</p>
<p class="indenthanding">• Access may be via explicit conversion or implicit conversion. In general, explicit conversion is safer, but implicit conversion is more convenient for clients.</p>
</div>
<h3 id="ch03lev1sec4">Item 16: Use the same form in corresponding uses of <code>new</code> and <code>delete</code>.</h3>
<p class="noindent">What's wrong with this picture?</p>
<p class="codelink"><a id="procode113"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode113">Click here to view code image</a></p>
<p class="programlisting"><br>std::string *stringArray = new std::string[100];<br><br>...<br><br>delete stringArray;<br></p>
<p class="noindent">Everything appears to be in order. The <code>new</code> is matched with a <code>delete</code>. Still, something is quite wrong. The program's behavior is undefined. At the very least, 99 of the 100 <code>string</code> objects pointed to by <code>stringArray</code> are unlikely to be properly destroyed, because their destructors will probably never be called.</p>
<p class="noindent">When you employ a <em><code>new</code> expression</em> (i.e., dynamic creation of an object via a use of <code>new</code>), two things happen. First, memory is allocated (via a function named <code>operator new</code>—see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch08.html#ch08lev1sec1">Items 49</a> and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch08.html#ch08lev1sec3">51</a>). Second, one or more constructors are called for that memory. When you employ a <em><code>delete</code> expression</em> (i.e., use <code>delete</code>), two other things happen: one or more destructors are called for the memory, then the memory is deallocated (via a function named <code>operator delete</code>—see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch08.html#ch08lev1sec3">Item 51</a>). The big question for <code>delete</code> is this: <em>how many</em> objects reside in the memory being deleted? The answer to that determines how many destructors must be called.</p>
<p class="noindent">Actually, the question is simpler: does the pointer being deleted point to a single object or to an array of objects? It's a critical question, because the memory layout for single objects is generally different from the memory layout for arrays. In particular, the memory for an array usually includes the size of the array, thus making it easy for <code>delete</code> to know how many destructors to call. The memory for a single <a id="page_74"></a>object lacks this information. You can think of the different layouts as looking like this, where <code>n</code> is the size of the array:</p>
<p class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/graphics/03inf01.jpg" alt="images" width="350" height="65" data-mfp-src="/library/view/effective-c-55/0321334876/graphics/03inf01.jpg"></p>
<p class="noindent">This is just an example, of course. Compilers aren't required to implement things this way, though many do.</p>
<p class="noindent">When you use <code>delete</code> on a pointer, the only way for <code>delete</code> to know whether the array size information is there is for you to tell it. If you use brackets in your use of <code>delete</code>, <code>delete</code> assumes an array is pointed to. Otherwise, it assumes that a single object is pointed to:</p>
<p class="codelink"><a id="procode114"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode114">Click here to view code image</a></p>
<p class="programlisting"><br>std::string *stringPtr1 = new std::string;<br><br>std::string *stringPtr2 = new std::string[100];<br>...<br><br><span class="courierb">delete</span> stringPtr1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// delete an object<br><br><span class="courierb">delete []</span> stringPtr2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// delete an array of objects<br></p>
<p class="noindent">What would happen if you used the “<code>[]</code>” form on <code>stringPtr1</code>? The result is undefined, but it's unlikely to be pretty. Assuming the layout above, <code>delete</code> would read some memory and interpret what it read as an array size, then start invoking that many destructors, oblivious to the fact that the memory it's working on not only isn't in the array, it's also probably not holding objects of the type it's busy destructing.</p>
<p class="noindent">What would happen if you didn't use the “<code>[]</code>” form on <code>stringPtr2</code>? Well, that's undefined too, but you can see how it would lead to too few destructors being called. Furthermore, it's undefined (and sometimes harmful) for built-in types like <code>int</code>s, too, even though such types lack destructors.</p>
<p class="noindent">The rule is simple: if you use <code>[]</code> in a <code>new</code> expression, you must use <code>[]</code> in the corresponding <code>delete</code> expression. If you don't use <code>[]</code> in a <code>new</code> expression, don't use <code>[]</code> in the matching <code>delete</code> expression.</p>
<p class="noindent">This is a particularly important rule to bear in mind when you are writing a class containing a pointer to dynamically allocated memory and also offering multiple constructors, because then you must be careful to use the <em>same form</em> of <code>new</code> in all the constructors to initialize the pointer member. If you don't, how will you know what form of <code>delete</code> to use in your destructor?</p>
<p class="noindent"><a id="page_75"></a>This rule is also noteworthy for the <code>typedef</code>-inclined, because it means that a <code>typedef</code>'s author must document which form of <code>delete</code> should be employed when <code>new</code> is used to conjure up objects of the <code>typedef</code> type. For example, consider this <code>typedef</code>:</p>
<p class="codelink"><a id="procode115"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode115">Click here to view code image</a></p>
<p class="programlisting"><br>typedef std::string AddressLines[4];&nbsp;&nbsp;&nbsp;// a person's address has 4 lines,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// each of which is a string<br></p>
<p class="noindent">Because <code>AddressLines</code> is an array, this use of <code>new</code>,</p>
<p class="codelink"><a id="procode116"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode116">Click here to view code image</a></p>
<p class="programlisting"><br>std::string *pal = new AddressLines;&nbsp;&nbsp;&nbsp;// note that "new AddressLines"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// returns a string*, just like<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// "new string[4]" would<br></p>
<p class="noindent">must be matched with the <em>array</em> form of <code>delete</code>:</p>
<p class="codelink"><a id="procode117"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode117">Click here to view code image</a></p>
<p class="programlisting"><br>delete pal;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// undefined!<br><br>delete [] pal;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// fine<br></p>
<p class="noindent">To avoid such confusion, abstain from <code>typedef</code>s for array types. That's easy, because the standard C++ library (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>) includes <code>string</code> and <code>vector</code>, and those templates reduce the need for dynamically allocated arrays to nearly zero. Here, for example, <code>AddressLines</code> could be defined to be a <code>vector</code> of <code>string</code>s, i.e., the type <code>vector&lt;string&gt;</code>.</p>
<div class="note">
<h3 id="ch03note04">Things to Remember</h3>
<p class="indenthanding">• If you use <code>[]</code> in a <code>new</code> expression, you must use <code>[]</code> in the corresponding <code>delete</code> expression. If you don't use <code>[]</code> in a <code>new</code> expression, you mustn't use <code>[]</code> in the corresponding <code>delete</code> expression.</p>
</div>
<h3 id="ch03lev1sec5">Item 17: Store <code>new</code>ed objects in smart pointers in standalone statements.</h3>
<p class="noindent">Suppose we have a function to reveal our processing priority and a second function to do some processing on a dynamically allocated <code>Widget</code> in accord with a priority:</p>
<p class="codelink"><a id="procode118"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode118">Click here to view code image</a></p>
<p class="programlisting"><br>int priority();<br>void processWidget(std::tr1::shared_ptr&lt;Widget&gt; pw, int priority);<br></p>
<p class="noindent">Mindful of the wisdom of using objects to manage resources (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>), <code>processWidget</code> uses a smart pointer (here, a <code>tr1::shared_ptr</code>) for the dynamically allocated <code>Widget</code> it processes.</p>
<p class="noindent">Consider now a call to <code>processWidget</code>:</p>
<p class="programlisting"><br>processWidget(new Widget, priority());<br></p>
<p class="noindent"><a id="page_76"></a>Wait, don't consider that call. It won't compile. <code>tr1::shared_ptr</code>'s constructor taking a raw pointer is <code>explicit</code>, so there's no implicit conversion from the raw pointer returned by the expression “<code>new Widget</code>” to the <code>tr1::shared_ptr</code> required by <code>processWidget</code>. The following code, however, will compile:</p>
<p class="codelink"><a id="procode119"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode119">Click here to view code image</a></p>
<p class="programlisting"><br>processWidget(<span class="courierb">std::tr1::shared_ptr&lt;Widget&gt;(</span>new Widget<span class="courierb">)</span>, priority());<br></p>
<p class="noindent">Surprisingly, although we're using object-managing resources everywhere here, this call may leak resources. It's illuminating to see how.</p>
<p class="noindent">Before compilers can generate a call to <code>processWidget</code>, they have to evaluate the arguments being passed as its parameters. The second argument is just a call to the function <code>priority</code>, but the first argument, (“<code>std::tr1::shared_ptr&lt;Widget&gt;(new Widget)</code>”) consists of two parts:</p>
<p class="indenthanding">• Execution of the expression “<code>new Widget</code>”.</p>
<p class="indenthanding">• A call to the <code>tr1::shared_ptr</code> constructor.</p>
<p class="noindent">Before <code>processWidget</code> can be called, then, compilers must generate code to do these three things:</p>
<p class="indenthanding">• Call <code>priority</code>.</p>
<p class="indenthanding">• Execute “<code>new Widget</code>”.</p>
<p class="indenthanding">• Call the <code>tr1::shared_ptr</code> constructor.</p>
<p class="noindent">C++ compilers are granted considerable latitude in determining the order in which these things are to be done. (This is different from the way languages like Java and C# work, where function parameters are always evaluated in a particular order.) The “<code>new Widget</code>” expression must be executed before the <code>tr1::shared_ptr</code> constructor can be called, because the result of the expression is passed as an argument to the <code>tr1::shared_ptr</code> constructor, but the call to <code>priority</code> can be performed first, second, or third. If compilers choose to perform it second (something that may allow them to generate more efficient code), we end up with this sequence of operations:</p>
<ol>
<li>Execute “<code>new Widget</code>”.</li>
<li>Call <code>priority</code>.</li>
<li>Call the <code>tr1::shared_ptr</code> constructor.</li>
</ol>
<p class="noindent">But consider what will happen if the call to <code>priority</code> yields an exception. In that case, the pointer returned from “<code>new Widget</code>” will be lost, because it won't have been stored in the <code>tr1::shared_ptr</code> we were expecting would guard against resource leaks. A leak in the call to <code>processWidget</code> can arise because an exception can intervene between the time <a id="page_77"></a>a resource is created (via “<code>new Widget</code>”) and the time that resource is turned over to a resource-managing object.</p>
<p class="noindent">The way to avoid problems like this is simple: use a separate statement to create the <code>Widget</code> and store it in a smart pointer, then pass the smart pointer to <code>processWidget</code>:</p>
<p class="codelink"><a id="procode120"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode120">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">std::tr1::shared_ptr&lt;Widget&gt; pw(new Widget);</span>&nbsp;&nbsp;// store newed object<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// in a smart pointer in a<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// standalone statement<br><br>processWidget(<span class="courierb">pw</span>, priority());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this call won't leak<br></p>
<p class="noindent">This works because compilers are given less leeway in reordering operations <em>across</em> statements than <em>within</em> them. In this revised code, the “<code>new Widget</code>” expression and the call to the <code>tr1::shared_ptr</code> constructor are in a different statement from the one calling <code>priority</code>, so compilers are not allowed to move the call to <code>priority</code> between them.</p>
<div class="note">
<h3 id="ch03note05">Things to Remember</h3>
<p class="indenthanding">• Store <code>new</code>ed objects in smart pointers in standalone statements. Failure to do this can lead to subtle resource leaks when exceptions are thrown.</p>
</div>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch02.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">2. Constructors, Destructors, and Assignment Operators</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/effective-c-55/0321334876/ch04.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">4. Designs and Declarations</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/0321334876/chapter/ch03.html" data-for-analytics="0321334876:ch03.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>
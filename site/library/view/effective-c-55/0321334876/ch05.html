<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/effective-c-55/0321334876/ch05.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="0321334876"
  data-publishers="Addison-Wesley Professional"



  data-htmlfile-name="ch05.html"
  data-epub-title="Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/effective-c-55/0321334876/ch05.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="0321334876" data-publishers="Addison-Wesley Professional" data-htmlfile-name="ch05.html" data-epub-title="Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://0321334876"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>5. Implementations - Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content div{margin-top:5pt;margin-bottom:5pt;margin-right:15pt}#sbo-rt-content .cover{margin-top:2pt;margin-bottom:2pt;text-align:center}#sbo-rt-content h1{page-break-before:right;margin-top:5pt;text-align:center;margin-bottom:12pt;font-weight:bold}#sbo-rt-content .subtitle{font-size:large;margin-top:30pt;margin-bottom:55pt;font-weight:bold;text-align:center}#sbo-rt-content .publisher{text-align:center;margin-top:64pt;margin-bottom:4pt}#sbo-rt-content .copyright{margin-top:5pt;margin-bottom:5pt;text-indent:.12pt}#sbo-rt-content h2{page-break-before:right;margin-top:7pt;margin-bottom:25pt;font-weight:bold}#sbo-rt-content h3{margin-top:9pt;margin-bottom:8pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content h4{margin-top:9pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content h5{margin-top:9pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content h6{margin-top:8pt;margin-bottom:6pt;font-weight:bold}#sbo-rt-content .author{text-align:center;font-weight:bold;margin-top:66pt;margin-bottom:24pt}#sbo-rt-content .bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content .toc-chapter{margin-top:12pt;margin-bottom:5pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .emphasis{font-style:italic}#sbo-rt-content .mediaobject{margin-top:12pt;margin-bottom:12pt;text-align:center}#sbo-rt-content .tabimage{margin-top:12pt;margin-bottom:12pt;text-align:center}#sbo-rt-content .smaller{font-size:small}#sbo-rt-content .center{margin-top:50pt;margin-bottom:5pt;text-align:center}#sbo-rt-content .note{margin-top:6pt;margin-bottom:12pt;margin-left:.12pt;text-indent:.12pt;margin-right:24pt}#sbo-rt-content .toc-preface{margin-top:5pt;margin-bottom:5pt;margin-left:1pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .programlisting{font-family:"Courier New";font-size:small;margin-top:8pt;margin-bottom:8pt;text-indent:.12pt}#sbo-rt-content .programlisting1{font-family:"Courier New";font-size:small;margin-top:5pt;margin-bottom:4pt;margin-left:36pt;text-indent:.12pt}#sbo-rt-content code{font-size:x-small}#sbo-rt-content .toc-section{margin-top:4pt;margin-bottom:4pt;margin-left:12pt;text-indent:.12pt}#sbo-rt-content .toc-index{margin-top:12pt;margin-bottom:4pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .toc-appendix{margin-top:12pt;margin-bottom:4pt;text-indent:.12pt;font-weight:bold}#sbo-rt-content .strong{font-weight:bold}#sbo-rt-content .italic{font-style:italic}#sbo-rt-content .title{margin-top:12pt;margin-bottom:6pt;font-size:medium;font-weight:bold;text-align:center}#sbo-rt-content .attribution{margin-top:4pt;margin-bottom:12pt;margin-right:15pt;text-align:right}#sbo-rt-content .indexmain{margin-top:2pt;margin-bottom:2pt;text-indent:.12pt}#sbo-rt-content .indexsub{margin-top:2pt;margin-bottom:2pt;margin-left:24pt;text-indent:.12pt}#sbo-rt-content .indexsubsub{margin-top:2pt;margin-bottom:2pt;margin-left:40pt;text-indent:.12pt}#sbo-rt-content .paraindent{margin-top:4pt;margin-bottom:4pt;margin-left:25pt;text-indent:.12pt}#sbo-rt-content .indenthanding{margin-top:4pt;margin-bottom:4pt;padding-left:25pt;text-indent:-15pt}#sbo-rt-content .indenthanding1{margin-top:4pt;margin-bottom:4pt;padding-left:48pt;text-indent:-8pt}#sbo-rt-content .underline{text-decoration:underline}#sbo-rt-content .footnotes{font-size:small;margin-top:5pt;margin-bottom:4pt;padding-left:20pt;text-indent:-8pt}#sbo-rt-content .courierb{font-family:"Courier New Bold"}#sbo-rt-content .courieri{font-family:"Courier New Italic"}#sbo-rt-content .center1{margin-top:4pt;margin-bottom:4pt;margin-left:80pt;text-align:center}#sbo-rt-content .noindent{margin-top:6pt;margin-bottom:5pt;text-indent:.12pt}#sbo-rt-content .noindent1{margin-top:12pt;margin-bottom:2pt;text-indent:.12pt}#sbo-rt-content .edition{font-size:1.2em;margin-top:2pt;margin-bottom:2pt;text-align:center}#sbo-rt-content .image1{page-break-before:always;page-break-after:always}#sbo-rt-content .codelink{margin-top:6pt;margin-bottom:6pt;text-indent:.12pt;font-weight:bold;page-break-after:avoid;font-size:small}
    </style><link rel="canonical" href="/site/library/view/effective-c-55/0321334876/ch05.html"><meta name="description" content="5. Implementations For the most part, coming up with appropriate definitions for your classes (and class templates) and appropriate declarations for your functions (and function templates) is the lion's ... "><meta property="og:title" content="5. Implementations"><meta itemprop="isPartOf" content="/library/view/effective-c-55/0321334876/"><meta itemprop="name" content="5. Implementations"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch05.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/0321334876/"><meta property="og:description" itemprop="description" content="5. Implementations For the most part, coming up with appropriate definitions for your classes (and class templates) and appropriate declarations for your functions (and function templates) is the lion's ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Addison-Wesley Professional"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="0321334876"><meta property="og:book:author" itemprop="author" content="Scott Meyers"><meta property="og:book:tag" itemprop="about" content="C++"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Effective C++: 55 Specific Ways to Improve Your Programs and Designs, Third Edition
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/0321334876/chapter/ch05.html" data-for-analytics="0321334876:ch05.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch05.html&amp;text=Effective%20C%2B%2B%3A%2055%20Specific%20Ways%20to%20Improve%20Your%20Programs%20and%20Designs%2C%20Third%20Edition&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch05.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch05.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%205.%20Implementations&amp;body=https://www.safaribooksonline.com/library/view/effective-c-55/0321334876/ch05.html%0D%0Afrom%20Effective%20C%2B%2B%3A%2055%20Specific%20Ways%20to%20Improve%20Your%20Programs%20and%20Designs%2C%20Third%20Edition%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/site/library/view/effective-c-55/0321334876/ch04.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">4. Designs and Declarations</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/site/library/view/effective-c-55/0321334876/ch06.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">6. Inheritance and Object-Oriented Design</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><h2 id="ch05">5. Implementations</h2>
<p class="noindent"><a id="page_113"></a>For the most part, coming up with appropriate definitions for your classes (and class templates) and appropriate declarations for your functions (and function templates) is the lion's share of the battle. Once you've got those right, the corresponding implementations are largely straightforward. Still, there are things to watch out for. Defining variables too soon can cause a drag on performance. Overuse of casts can lead to code that's slow, hard to maintain, and infected with subtle bugs. Returning handles to an object's internals can defeat encapsulation and leave clients with dangling handles. Failure to consider the impact of exceptions can lead to leaked resources and corrupted data structures. Overzealous inlining can cause code bloat. Excessive coupling can result in unacceptably long build times.</p>
<p class="noindent">All of these problems can be avoided. This chapter explains how.</p>
<h3 id="ch05lev1sec1">Item 26: Postpone variable definitions as long as possible.</h3>
<p class="noindent">Whenever you define a variable of a type with a constructor or destructor, you incur the cost of construction when control reaches the variable's definition, and you incur the cost of destruction when the variable goes out of scope. There's a cost associated with unused variables, so you want to avoid them whenever you can.</p>
<p class="noindent">You're probably thinking that you never define unused variables, but you may need to think again. Consider the following function, which returns an encrypted version of a password, provided the password is long enough. If the password is too short, the function throws an exception of type <code>logic_error</code>, which is defined in the standard C++ library (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>):</p>
<p class="codelink"><a id="procode172"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode172">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_114"></a>// this function defines the variable "encrypted" too soon<br>std::string encryptPassword(const std::string&amp; password)<br>{<br>&nbsp;&nbsp;using namespace std;<br><br>&nbsp;&nbsp;<span class="courierb">string encrypted;</span><br><br>&nbsp;&nbsp;if (password.length() &lt; MinimumPasswordLength) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw logic_error("Password is too short");<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do whatever is necessary to place an<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// encrypted version of password in encrypted<br>&nbsp;&nbsp;return encrypted;<br>}<br></p>
<p class="noindent">The object <code>encrypted</code> isn't <em>completely</em> unused in this function, but it's unused if an exception is thrown. That is, you'll pay for the construction and destruction of <code>encrypted</code> even if <code>encryptPassword</code> throws an exception. As a result, you're better off postponing <code>encrypted</code>'s definition until you <em>know</em> you'll need it:</p>
<p class="codelink"><a id="procode173"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode173">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_115"></a>// this function postpones encrypted's definition until it's truly necessary<br>std::string encryptPassword(const std::string&amp; password)<br>{<br>&nbsp;&nbsp;using namespace std;<br><br>&nbsp;&nbsp;if (password.length() &lt; MinimumPasswordLength) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw logic_error("Password is too short");<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span class="courierb">string encrypted;</span><br><br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do whatever is necessary to place an<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// encrypted version of password in encrypted<br>&nbsp;&nbsp;return encrypted;<br>}<br></p>
<p class="noindent">This code still isn't as tight as it might be, because <code>encrypted</code> is defined without any initialization arguments. That means its default constructor will be used. In many cases, the first thing you'll do to an object is give it some value, often via an assignment. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec4">Item 4</a> explains why default-constructing an object and then assigning to it is less efficient than initializing it with the value you really want it to have. That analysis applies here, too. For example, suppose the hard part of <code>encryptPassword</code> is performed in this function:</p>
<p class="codelink"><a id="procode174"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode174">Click here to view code image</a></p>
<p class="programlisting"><br>void encrypt(std::string&amp; s);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// encrypts s in place<br></p>
<p class="noindent">Then <code>encryptPassword</code> could be implemented like this, though it wouldn't be the best way to do it:</p>
<p class="codelink"><a id="procode175"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode175">Click here to view code image</a></p>
<p class="programlisting"><br>// this function postpones encrypted's definition until<br>// it's necessary, but it's still needlessly inefficient<br>std::string encryptPassword(const std::string&amp; password)<br>{<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// check length as above<br><br>&nbsp;&nbsp;<span class="courierb">std::string encrypted;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// default-construct encrypted<br>&nbsp;&nbsp;<span class="courierb">encrypted = password;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// assign to encrypted<br><br>&nbsp;&nbsp;encrypt(encrypted);<br>&nbsp;&nbsp;return encrypted;<br>}<br></p>
<p class="noindent">A preferable approach is to initialize <code>encrypted</code> with <code>password</code>, thus skipping the pointless and potentially expensive default construction:</p>
<p class="codelink"><a id="procode176"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode176">Click here to view code image</a></p>
<p class="programlisting"><br>// finally, the best way to define and initialize encrypted<br>std::string encryptPassword(const std::string&amp; password)<br>{<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// check length<br><br>&nbsp;&nbsp;<span class="courierb">std::string encrypted(password);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// define and initialize<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// via copy constructor<br><br>&nbsp;&nbsp;encrypt(encrypted);<br>&nbsp;&nbsp;return encrypted;<br>}<br></p>
<p class="noindent">This suggests the real meaning of “as long as possible” in this Item's title. Not only should you postpone a variable's definition until right before you have to use the variable, you should also try to postpone the definition until you have initialization arguments for it. By doing so, you avoid constructing and destructing unneeded objects, and you avoid unnecessary default constructions. Further, you help document the purpose of variables by initializing them in contexts in which their meaning is clear.</p>
<p class="noindent">“But what about loops?” you may wonder. If a variable is used only inside a loop, is it better to define it outside the loop and make an assignment to it on each loop iteration, or is it be better to define the variable inside the loop? That is, which of these general structures is better?</p>
<p class="codelink"><a id="procode177"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode177">Click here to view code image</a></p>
<p class="programlisting"><br>// <span class="courierb">Approach A</span>: define outside loop&nbsp;&nbsp;&nbsp;// <span class="courierb">Approach B</span>: define inside loop<br><br><span class="courierb">Widget w;</span><br>for (int i = 0; i &lt; n; ++i){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; n; ++i) {<br>&nbsp;&nbsp;<span class="courierb">w =</span> <span class="courieri">some value dependent on i;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">Widget w(</span><span class="courieri">some value dependent on i</span><span class="courierb">);</span><br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br></p>
<p class="noindent"><a id="page_116"></a>Here I've switched from an object of type <code>string</code> to an object of type <code>Widget</code> to avoid any preconceptions about the cost of performing a construction, destruction, or assignment for the object.</p>
<p class="noindent">In terms of <code>Widget</code> operations, the costs of these two approaches are as follows:</p>
<p class="indenthanding">• Approach A: 1 constructor + 1 destructor + <code>n</code> assignments.</p>
<p class="indenthanding">• Approach B: <code>n</code> constructors + <code>n</code> destructors.</p>
<p class="noindent">For classes where an assignment costs less than a constructor-destructor pair, Approach A is generally more efficient. This is especially the case as <code>n</code> gets large. Otherwise, Approach B is probably better. Furthermore, Approach A makes the name <code>w</code> visible in a larger scope (the one containing the loop) than Approach B, something that's contrary to program comprehensibility and maintainability. As a result, unless you know that (1) assignment is less expensive than a constructor-destructor pair and (2) you're dealing with a performance-sensitive part of your code, you should default to using Approach B.</p>
<div class="note">
<h3 id="ch05note01">Things to Remember</h3>
<p class="indenthanding">• Postpone variable definitions as long as possible. It increases program clarity and improves program efficiency.</p>
</div>
<h3 id="ch05lev1sec2">Item 27: Minimize casting.</h3>
<p class="noindent">The rules of C++ are designed to guarantee that type errors are impossible. In theory, if your program compiles cleanly, it's not trying to perform any unsafe or nonsensical operations on any objects. This is a valuable guarantee. You don't want to forgo it lightly.</p>
<p class="noindent">Unfortunately, casts subvert the type system. That can lead to all kinds of trouble, some easy to recognize, some extraordinarily subtle. If you're coming to C++ from C, Java, or C#, take note, because casting in those languages is more necessary and less dangerous than in C++. But C++ is not C. It's not Java. It's not C#. In this language, casting is a feature you want to approach with great respect.</p>
<p class="noindent">Let's begin with a review of casting syntax, because there are usually three different ways to write the same cast. C-style casts look like this:</p>
<p class="codelink"><a id="procode178"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode178">Click here to view code image</a></p>
<p class="programlisting"><br>(T) <span class="courieri">expression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// cast <span class="courieri">expression</span> to be of type T<br></p>
<p class="noindent">Function-style casts use this syntax:</p>
<p class="codelink"><a id="procode179"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode179">Click here to view code image</a></p>
<p class="programlisting"><br>T(<span class="courieri">expression</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// cast <span class="courieri">expression</span> to be of type T<br></p>
<p class="noindent"><a id="page_117"></a>There is no difference in meaning between these forms; it's purely a matter of where you put the parentheses. I call these two forms <em>old-style casts</em>.</p>
<p class="noindent">C++ also offers four new cast forms (often called <em>new-style</em> or <em>C++-style casts</em>):</p>
<p class="programlisting"><br><span class="courierb">const_cast&lt;</span>T<span class="courierb">&gt;(</span><span class="courieri">expression</span><span class="courierb">)</span><br><span class="courierb">dynamic_cast&lt;</span>T<span class="courierb">&gt;(</span><span class="courieri">expression</span><span class="courierb">)</span><br><span class="courierb">reinterpret_cast&lt;</span>T<span class="courierb">&gt;(</span><span class="courieri">expression</span><span class="courierb">)</span><br><span class="courierb">static_cast&lt;</span>T<span class="courierb">&gt;(</span><span class="courieri">expression</span><span class="courierb">)</span><br></p>
<p class="noindent">Each serves a distinct purpose:</p>
<p class="indenthanding">• <code>const_cast</code> is typically used to cast away the constness of objects. It is the only C++-style cast that can do this.</p>
<p class="indenthanding">• <code>dynamic_cast</code> is primarily used to perform “safe downcasting,” i.e., to determine whether an object is of a particular type in an inheritance hierarchy. It is the only cast that cannot be performed using the old-style syntax. It is also the only cast that may have a significant runtime cost. (I'll provide details on this a bit later.)</p>
<p class="indenthanding">• <code>reinterpret_cast</code> is intended for low-level casts that yield implementation-dependent (i.e., unportable) results, e.g., casting a pointer to an <code>int</code>. Such casts should be rare outside low-level code. I use it only once in this book, and that's only when discussing how you might write a debugging allocator for raw memory (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch08.html#ch08lev1sec2">Item 50</a>).</p>
<p class="indenthanding">• <code>static_cast</code> can be used to force implicit conversions (e.g., non-<code>const</code> object to <code>const</code> object (as in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec3">Item 3</a>), <code>int</code> to <code>double</code>, etc.). It can also be used to perform the reverse of many such conversions (e.g., <code>void*</code> pointers to typed pointers, pointer-to-base to pointer-to-derived), though it cannot cast from <code>const</code> to non-<code>const</code> objects. (Only <code>const_cast</code> can do that.)</p>
<p class="noindent">The old-style casts continue to be legal, but the new forms are preferable. First, they're much easier to identify in code (both for humans and for tools like <code>grep</code>), thus simplifying the process of finding places in the code where the type system is being subverted. Second, the more narrowly specified purpose of each cast makes it possible for compilers to diagnose usage errors. For example, if you try to cast away constness using a new-style cast other than <code>const_cast</code>, your code won't compile.</p>
<p class="noindent">About the only time I use an old-style cast is when I want to call an <code>explicit</code> constructor to pass an object to a function. For example:</p>
<p class="codelink"><a id="procode180"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode180">Click here to view code image</a></p>
<p class="programlisting"><br><br><a id="page_118"></a>class Widget {<br>public:<br>&nbsp;&nbsp;explicit Widget(int size);<br>&nbsp;&nbsp;...<br>};<br><br>void doSomeWork(const Widget&amp; w);<br><br>doSomeWork(<span class="courierb">Widget(15)</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// create Widget from int<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// with function-style cast<br><br>doSomeWork(<span class="courierb">static_cast&lt;Widget&gt;(15)</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// create Widget from int<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// with C++-style cast<br></p>
<p class="noindent">Somehow, deliberate object creation doesn't “feel” like a cast, so I'd probably use the function-style cast instead of the <code>static_cast</code> in this case. Then again, code that leads to a core dump usually feels pretty reasonable when you write it, so perhaps you'd best ignore feelings and use new-style casts all the time.</p>
<p class="noindent">Many programmers believe that casts do nothing but tell compilers to treat one type as another, but this is mistaken. Type conversions of any kind (either explicit via casts or implicit by compilers) often lead to code that is executed at runtime. For example, in this code fragment,</p>
<p class="codelink"><a id="procode181"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode181">Click here to view code image</a></p>
<p class="programlisting"><br>int x, y;<br>...<br>double d = static_cast&lt;double&gt;(x)/y;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// divide x by y, but use<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// floating point division<br></p>
<p class="noindent">the cast of the <code>int x</code> to a <code>double</code> almost certainly generates code, because on most architectures, the underlying representation for an <code>int</code> is different from that for a <code>double</code>. That's perhaps not so surprising, but this example may widen your eyes a bit:</p>
<p class="codelink"><a id="procode182"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode182">Click here to view code image</a></p>
<p class="programlisting"><br>class Base { ... };<br><br>class Derived: public Base { ... };<br><br>Derived d;<br><br>Base *pb = &amp;d;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// implicitly convert Derived* ⇒ Base*<br></p>
<p class="noindent">Here we're just creating a base class pointer to a derived class object, but sometimes, the two pointer values will not be the same. When that's the case, an offset is applied <em>at runtime</em> to the <code>Derived*</code> pointer to get the correct <code>Base*</code> pointer value.</p>
<p class="noindent">This last example demonstrates that a single object (e.g., an object of type <code>Derived</code>) might have more than one address (e.g., its address when pointed to by a <code>Base*</code> pointer and its address when pointed to by a <code>Derived*</code> pointer). That can't happen in C. It can't happen in Java. It can't happen in C#. It <em>does</em> happen in C++. In fact, when multiple <a id="page_119"></a>inheritance is in use, it happens virtually all the time, but it can happen under single inheritance, too. Among other things, that means you should generally avoid making assumptions about how things are laid out in C++, and you should certainly not perform casts based on such assumptions. For example, casting object addresses to <code>char*</code> pointers and then using pointer arithmetic on them almost always yields undefined behavior.</p>
<p class="noindent">But note that I said that an offset is “sometimes” required. The way objects are laid out and the way their addresses are calculated varies from compiler to compiler. That means that just because your “I know how things are laid out” casts work on one platform doesn't mean they'll work on others. The world is filled with woeful programmers who've learned this lesson the hard way.</p>
<p class="noindent">An interesting thing about casts is that it's easy to write something that looks right (and might be right in other languages) but is wrong. Many application frameworks, for example, require that virtual member function implementations in derived classes call their base class counterparts first. Suppose we have a <code>Window</code> base class and a <code>SpecialWindow</code> derived class, both of which define the virtual function <code>onResize</code>. Further suppose that <code>SpecialWindow</code>'s <code>onResize</code> is expected to invoke <code>Window</code>'s <code>onResize</code> first. Here's a way to implement this that looks like it does the right thing, but doesn't:</p>
<p class="codelink"><a id="procode183"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode183">Click here to view code image</a></p>
<p class="programlisting"><br>class Window {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// base class<br>public:<br>&nbsp;&nbsp;virtual void onResize() { ... }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// base onResize impl<br>&nbsp;&nbsp;...<br>};<br><br>class SpecialWindow: public Window {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// derived class<br>public:<br>&nbsp;&nbsp;virtual void onResize() {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// derived onResize impl;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">static_cast&lt;Window&gt;(*this)</span>.onResize();&nbsp;&nbsp;&nbsp;&nbsp;// cast *this to Window,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// then call its onResize;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// <span class="courieri">this doesn't work!</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do SpecialWindow-<br>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// specific stuff<br><br>&nbsp;&nbsp;...<br><br>};<br></p>
<p class="noindent">I've highlighted the cast in the code. (It's a new-style cast, but using an old-style cast wouldn't change anything.) As you would expect, the code casts <code>*this</code> to a <code>Window</code>. The resulting call to <code>onResize</code> therefore invokes <code>Window::onResize</code>. What you might not expect is that it does not invoke that function on the current object! Instead, the cast creates <a id="page_120"></a>a new, temporary <em>copy</em> of the base class part of <code>*this</code>, then invokes <code>onResize</code> on the copy! The above code doesn't call <code>Window::onResize</code> on the current object and then perform the <code>SpecialWindow</code>-specific actions on that object — it calls <code>Window::onResize</code> on a <em>copy of the base class part</em> of the current object before performing <code>SpecialWindow</code>-specific actions on the current object. If <code>Window::onResize</code> modifies the current object (hardly a remote possibility, since <code>onResize</code> is a non-<code>const</code> member function), the current object won't be modified. Instead, a <em>copy</em> of that object will be modified. If <code>SpecialWindow::onResize</code> modifies the current object, however, the current object <em>will</em> be modified, leading to the prospect that the code will leave the current object in an invalid state, one where base class modifications have not been made, but derived class ones have been.</p>
<p class="noindent">The solution is to eliminate the cast, replacing it with what you really want to say. You don't want to trick compilers into treating <code>*this</code> as a base class object; you want to call the base class version of <code>onResize</code> on the current object. So say that:</p>
<p class="codelink"><a id="procode184"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode184">Click here to view code image</a></p>
<p class="programlisting"><br>class SpecialWindow: public Window {<br>public:<br>&nbsp;&nbsp;virtual void onResize() {<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">Window::onResize();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// call Window::onResize<br>&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// on *this<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;...<br><br>};<br></p>
<p class="noindent">This example also demonstrates that if you find yourself wanting to cast, it's a sign that you could be approaching things the wrong way. This is especially the case if your want is for <code>dynamic_cast</code>.</p>
<p class="noindent">Before delving into the design implications of <code>dynamic_cast</code>, it's worth observing that many implementations of <code>dynamic_cast</code> can be quite slow. For example, at least one common implementation is based in part on string comparisons of class names. If you're performing a <code>dynamic_cast</code> on an object in a single-inheritance hierarchy four levels deep, each <code>dynamic_cast</code> under such an implementation could cost you up to four calls to <code>strcmp</code> to compare class names. A deeper hierarchy or one using multiple inheritance would be more expensive. There are reasons that some implementations work this way (they have to do with support for dynamic linking). Nonetheless, in addition to being leery of casts in general, you should be especially leery of <code>dynamic_cast</code>s in performance-sensitive code.</p>
<p class="noindent">The need for <code>dynamic_cast</code> generally arises because you want to perform derived class operations on what you believe to be a derived class <a id="page_121"></a>object, but you have only a pointer- or reference-to-base through which to manipulate the object. There are two general ways to avoid this problem.</p>
<p class="noindent">First, use containers that store pointers (often smart pointers — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>) to derived class objects directly, thus eliminating the need to manipulate such objects through base class interfaces. For example, if, in our <code>Window</code>/<code>SpecialWindow</code> hierarchy, only <code>SpecialWindow</code>s support blinking, instead of doing this:</p>
<p class="codelink"><a id="procode185"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode185">Click here to view code image</a></p>
<p class="programlisting"><br>class Window { ... };<br><br>class SpecialWindow: public Window {<br>public:<br>&nbsp;&nbsp;void blink();<br>&nbsp;&nbsp;...<br>};<br>typedef&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 13 for info<br>&nbsp;&nbsp;std::vector&lt;std::tr1::shared_ptr&lt;Window&gt; &gt; VPW;&nbsp;&nbsp;// on tr1::shared_ptr<br><br>VPW winPtrs;<br><br>...<br><br>for (VPW::iterator iter = winPtrs.begin();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// undesirable code:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter != winPtrs.end();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// uses dynamic_cast<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++iter) {<br>&nbsp;&nbsp;if (SpecialWindow *psw = <span class="courierb">dynamic_cast</span>&lt;SpecialWindow*&gt;(iter-&gt;get()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;psw-&gt;blink();<br>}<br></p>
<p class="noindent">try to do this instead:</p>
<p class="codelink"><a id="procode186"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode186">Click here to view code image</a></p>
<p class="programlisting"><br>typedef std::vector&lt;std::tr1::shared_ptr&lt;<span class="courierb">SpecialWindow&gt;</span> &gt; <span class="courierb">VPSW</span>;<br><br><span class="courierb">VPSW</span> winPtrs;<br><br>...<br><br>for (<span class="courierb">VPSW</span>::iterator iter = winPtrs.begin();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// better code: uses<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter != winPtrs.end();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// no dynamic_cast<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++iter)<br>&nbsp;&nbsp;<span class="courierb">(*</span>iter<span class="courierb">)</span>-&gt;blink();<br></p>
<p class="noindent">Of course, this approach won't allow you to store pointers to all possible <code>Window</code> derivatives in the same container. To work with different window types, you might need multiple type-safe containers.</p>
<p class="noindent">An alternative that will let you manipulate all possible <code>Window</code> derivatives through a base class interface is to provide virtual functions in the base class that let you do what you need. For example, though only <code>SpecialWindow</code>s can blink, maybe it makes sense to declare the <a id="page_122"></a>function in the base class, offering a default implementation that does nothing:</p>
<p class="codelink"><a id="procode187"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode187">Click here to view code image</a></p>
<p class="programlisting"><br>class Window {<br>public:<br>&nbsp;&nbsp;<span class="courierb">virtual void blink() {}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// default impl is no-op;<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 34 for why<br>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// a default impl may be<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// a bad idea<br><br>class SpecialWindow: public Window {<br>public:<br>&nbsp;&nbsp;<span class="courierb">virtual void blink() { ... };</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// in this class, blink<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// does something<br>};<br><br>typedef std::vector&lt;std::tr1::shared_ptr&lt;Window&gt; &gt; VPW;<br><br>VPW winPtrs;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// container holds<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// (ptrs to) all possible<br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Window types<br><br>for (VPW::iterator iter = winPtrs.begin();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter != winPtrs.end();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++iter)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// note lack of<br>&nbsp;&nbsp;(*iter)-&gt;blink();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// dynamic_cast<br></p>
<p class="noindent">Neither of these approaches — using type-safe containers or moving virtual functions up the hierarchy — is universally applicable, but in many cases, they provide a viable alternative to <code>dynamic_cast</code>ing. When they do, you should embrace them.</p>
<p class="noindent">One thing you definitely want to avoid is designs that involve cascading <code>dynamic_cast</code>s, i.e., anything that looks like this:</p>
<p class="codelink"><a id="procode188"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode188">Click here to view code image</a></p>
<p class="programlisting"><br>class Window { ... };<br><br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// derived classes are defined here<br><br>typedef std::vector&lt;std::tr1::shared_ptr&lt;Window&gt; &gt; VPW;<br><br>VPW winPtrs;<br><br>...<br><br>for (VPW::iterator iter = winPtrs.begin(); iter != winPtrs.end(); ++iter)<br>{<br>&nbsp;&nbsp;if (SpecialWindow1 *psw1 =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">dynamic_cast</span>&lt;SpecialWindow1*&gt;(iter-&gt;get())) { ... }<br><br>&nbsp;&nbsp;else if (SpecialWindow2 *psw2 =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">dynamic_cast</span>&lt;SpecialWindow2*&gt;(iter-&gt;get())) { ... }<br><br>&nbsp;&nbsp;else if (SpecialWindow3 *psw3 =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">dynamic_cast</span>&lt;SpecialWindow3*&gt;(iter-&gt;get())) { ... }<br><br>&nbsp;&nbsp;...<br>}<br></p>
<p class="noindent"><a id="page_123"></a>Such C++ generates code that's big and slow, plus it's brittle, because every time the <code>Window</code> class hierarchy changes, all such code has to be examined to see if it needs to be updated. (For example, if a new derived class gets added, a new conditional branch probably needs to be added to the above cascade.) Code that looks like this should almost always be replaced with something based on virtual function calls.</p>
<p class="noindent">Good C++ uses very few casts, but it's generally not practical to get rid of all of them. The cast from <code>int</code> to <code>double</code> on page <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#page_118">118</a>, for example, is a reasonable use of a cast, though it's not strictly necessary. (The code could be rewritten to declare a new variable of type <code>double</code> that's initialized with <code>x</code>'s value.) Like most suspicious constructs, casts should be isolated as much as possible, typically hidden inside functions whose interfaces shield callers from the grubby work being done inside.</p>
<div class="note">
<h3 id="ch05note02">Things to Remember</h3>
<p class="indenthanding">• Avoid casts whenever practical, especially <code>dynamic_cast</code>s in performance-sensitive code. If a design requires casting, try to develop a cast-free alternative.</p>
<p class="indenthanding">• When casting is necessary, try to hide it inside a function. Clients can then call the function instead of putting casts in their own code.</p>
<p class="indenthanding">• Prefer C++-style casts to old-style casts. They are easier to see, and they are more specific about what they do.</p>
</div>
<h3 id="ch05lev1sec3">Item 28: Avoid returning “handles” to object internals.</h3>
<p class="noindent">Suppose you're working on an application involving rectangles. Each rectangle can be represented by its upper left corner and its lower right corner. To keep a <code>Rectangle</code> object small, you might decide that the points defining its extent shouldn't be stored in the <code>Rectangle</code> itself, but rather in an auxiliary struct that the <code>Rectangle</code> points to:</p>
<p class="codelink"><a id="procode189"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode189">Click here to view code image</a></p>
<p class="programlisting"><br>class Point {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// class for representing points<br>public:<br>&nbsp;&nbsp;Point(int x, int y);<br>&nbsp;&nbsp;...<br><br>&nbsp;&nbsp;void setX(int newVal);<br>&nbsp;&nbsp;void setY(int newVal);<br>&nbsp;&nbsp;...<br>};<br><br><a id="page_124"></a>struct RectData {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Point data for a Rectangle<br>&nbsp;&nbsp;Point ulhc;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ulhc = " upper left-hand corner"<br>&nbsp;&nbsp;Point lrhc;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// lrhc = " lower right-hand corner"<br>};<br><br>class Rectangle {<br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;std::tr1::shared_ptr&lt;RectData&gt; pData;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 13 for info on<br>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// tr1::shared_ptr<br></p>
<p class="noindent">Because <code>Rectangle</code> clients will need to be able to determine the extent of a <code>Rectangle</code>, the class provides the <code>upperLeft</code> and <code>lowerRight</code> functions. However, <code>Point</code> is a user-defined type, so, mindful of <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec3">Item 20</a>'s observation that passing user-defined types by reference is typically more efficient than passing them by value, these functions return references to the underlying <code>Point</code> objects:</p>
<p class="codelink"><a id="procode190"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode190">Click here to view code image</a></p>
<p class="programlisting"><br>class Rectangle {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;<span class="courierb">Point&amp;</span> upperLeft() const { return pData-&gt;ulhc; }<br>&nbsp;&nbsp;<span class="courierb">Point&amp;</span> lowerRight() const { return pData-&gt;lrhc; }<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">This design will compile, but it's wrong. In fact, it's self-contradictory. On the one hand, <code>upperLeft</code> and <code>lowerRight</code> are declared to be <code>const</code> member functions, because they are designed only to offer clients a way to learn what the <code>Rectangle</code>'s points are, not to let clients modify the <code>Rectangle</code> (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec3">Item 3</a>). On the other hand, both functions return references to private internal data — references that callers can use to modify that internal data! For example:</p>
<p class="codelink"><a id="procode191"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode191">Click here to view code image</a></p>
<p class="programlisting"><br>Point coord1(0, 0);<br>Point coord2(100, 100);<br><br><span class="courierb">const</span> Rectangle rec(coord1, coord2);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// rec is a const rectangle from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// (0, 0) to (100, 100)<br><br><span class="courierb">rec.upperLeft().setX(50);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// now rec goes from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// (<span class="courierb">50</span>, 0) to (100, 100)!<br></p>
<p class="noindent">Here, notice how the caller of <code>upperLeft</code> is able to use the returned reference to one of <code>rec</code>'s internal <code>Point</code> data members to modify that member. But <code>rec</code> is supposed to be <code>const</code>!</p>
<p class="noindent">This immediately leads to two lessons. First, a data member is only as encapsulated as the most accessible function returning a reference to it. In this case, though <code>ulhc</code> and <code>lrhc</code> are declared <code>private</code>, they're effectively public, because the public functions <code>upperLeft</code> and <code>lowerRight</code> <a id="page_125"></a>return references to them. Second, if a <code>const</code> member function returns a reference to data associated with an object that is stored outside the object itself, the caller of the function can modify that data, (This is just a fallout of the limitations of bitwise constness — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec3">Item 3</a>.)</p>
<p class="noindent">Everything we've done has involved member functions returning references, but if they returned pointers or iterators, the same problems would exist for the same reasons. References, pointers, and iterators are all <em>handles</em> (ways to get at other objects), and returning a handle to an object's internals always runs the risk of compromising an object's encapsulation. As we've seen, it can also lead to <code>const</code> member functions that allow an object's state to be modified.</p>
<p class="noindent">We generally think of an object's “internals” as its data members, but member functions not accessible to the general public (i.e., that are protected or private) are part of an object's internals, too. As such, it's important not to return handles to them. This means you should never have a member function return a pointer to a less accessible member function. If you do, the effective access level will be that of the more accessible function, because clients will be able to get a pointer to the less accessible function, then call that function through the pointer.</p>
<p class="noindent">Functions that return pointers to member functions are uncommon, however, so let's turn our attention back to the <code>Rectangle</code> class and its <code>upperLeft</code> and <code>lowerRight</code> member functions. Both of the problems we've identified for those functions can be eliminated by simply applying <code>const</code> to their return types:</p>
<p class="codelink"><a id="procode192"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode192">Click here to view code image</a></p>
<p class="programlisting"><br>class Rectangle {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;<span class="courierb">const</span> Point&amp; upperLeft() const { return pData-&gt;ulhc; }<br>&nbsp;&nbsp;<span class="courierb">const</span> Point&amp; lowerRight() const { return pData-&gt;lrhc; }<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">With this altered design, clients can read the <code>Point</code>s defining a rectangle, but they can't write them. This means that declaring <code>upperLeft</code> and <code>upperRight</code> as <code>const</code> is no longer a lie, because they no longer allow callers to modify the state of the object. As for the encapsulation problem, we always intended to let clients see the <code>Point</code>s making up a <code>Rectangle</code>, so this is a deliberate relaxation of encapsulation. More importantly, it's a <em>limited</em> relaxation: only read access is being granted by these functions. Write access is still prohibited.</p>
<p class="noindent">Even so, <code>upperLeft</code> and <code>lowerRight</code> are still returning handles to an object's internals, and that can be problematic in other ways. In particular, <a id="page_126"></a>it can lead to <em>dangling handles</em>: handles that refer to parts of objects that don't exist any longer. The most common source of such disappearing objects are function return values. For example, consider a function that returns the bounding box for a GUI object in the form of a rectangle:</p>
<p class="codelink"><a id="procode193"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode193">Click here to view code image</a></p>
<p class="programlisting"><br>class GUIObject { ... };<br><br><span class="courierb">const Rectangle</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// returns a rectangle by<br>&nbsp;&nbsp;boundingBox(const GUIObject&amp; obj);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// value; see Item 3 for why<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// return type is const<br></p>
<p class="noindent">Now consider how a client might use this function:</p>
<p class="codelink"><a id="procode194"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode194">Click here to view code image</a></p>
<p class="programlisting"><br>GUIObject *pgo;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// make pgo point to<br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// some GUIObject<br><br>const Point *pUpperLeft =&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// get a ptr to the upper<br>&nbsp;&nbsp;&amp;(<span class="courierb">boundingBox(*pgo)</span>.upperLeft());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// left point of its<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// bounding box<br></p>
<p class="noindent">The call to <code>boundingBox</code> will return a new, temporary <code>Rectangle</code> object. That object doesn't have a name, so let's call it <em>temp</em>. <code>upperLeft</code> will then be called on <em>temp</em>, and that call will return a reference to an internal part of <em>temp</em>, in particular, to one of the <code>Point</code>s making it up. <code>pUpperLeft</code> will then point to that <code>Point</code> object. So far, so good, but we're not done yet, because at the end of the statement, <code>boundingBox</code>'s return value — <em>temp</em> — will be destroyed, and that will indirectly lead to the destruction of <em>temp</em>'s <code>Point</code>s. That, in turn, will leave <code>pUpperLeft</code> pointing to an object that no longer exists; <code>pUpperLeft</code> will dangle by the end of the statement that created it!</p>
<p class="noindent">This is why any function that returns a handle to an internal part of the object is dangerous. It doesn't matter whether the handle is a pointer, a reference, or an iterator. It doesn't matter whether it's qualified with <code>const</code>. It doesn't matter whether the member function returning the handle is itself <code>const</code>. All that matters is that a handle is being returned, because once that's being done, you run the risk that the handle will outlive the object it refers to.</p>
<p class="noindent">This doesn't mean that you should <em>never</em> have a member function that returns a handle. Sometimes you have to. For example, <code>operator[]</code> allows you to pluck individual elements out of <code>string</code>s and <code>vector</code>s, and these <code>operator[]</code>s work by returning references to the data in the containers (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec3">Item 3</a>) — data that is destroyed when the containers themselves are. Still, such functions are the exception, not the rule.</p>
<div class="note">
<h3 id="ch05note03">Things to Remember</h3>
<p class="indenthanding">• Avoid returning handles (references, pointers, or iterators) to object internals. It increases encapsulation, helps <code>const</code> member functions act <code>const</code>, and minimizes the creation of dangling handles.</p>
</div>
<h3 id="ch05lev1sec4">Item 29: Strive for exception-safe code.</h3>
<p class="noindent"><a id="page_127"></a>Exception safety is sort of like pregnancy...but hold that thought for a moment. We can't really talk reproduction until we've worked our way through courtship.</p>
<p class="noindent">Suppose we have a class for representing GUI menus with background images. The class is designed to be used in a threaded environment, so it has a mutex for concurrency control:</p>
<p class="codelink"><a id="procode195"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode195">Click here to view code image</a></p>
<p class="programlisting"><br>class PrettyMenu {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;void changeBackground(std::istream&amp; imgSrc);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// change background<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// image<br><br>private:<br><br>&nbsp;&nbsp;Mutex mutex;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// mutex for this object<br><br>&nbsp;&nbsp;Image *bgImage;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// current background image<br>&nbsp;&nbsp;int imageChanges;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// # of times image has been changed<br>};<br></p>
<p class="noindent">Consider this possible implementation of <code>PrettyMenu</code>'s <code>changeBackground</code> function:</p>
<p class="codelink"><a id="procode196"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode196">Click here to view code image</a></p>
<p class="programlisting"><br>void PrettyMenu::changeBackground(std::istream&amp; imgSrc)<br>{<br>&nbsp;&nbsp;lock(&amp;mutex);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// acquire mutex (as in Item 14)<br><br>&nbsp;&nbsp;delete bgImage;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// get rid of old background<br>&nbsp;&nbsp;++imageChanges;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// update image change count<br>&nbsp;&nbsp;bgImage = new Image(imgSrc);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// install new background<br><br>&nbsp;&nbsp;unlock(&amp;mutex);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// release mutex<br>}<br></p>
<p class="noindent">From the perspective of exception safety, this function is about as bad as it gets. There are two requirements for exception safety, and this satisfies neither.</p>
<p class="noindent">When an exception is thrown, exception-safe functions:</p>
<p class="indenthanding">• <strong>Leak no resources.</strong> The code above fails this test, because if the “<code>new Image(imgSrc)</code>” expression yields an exception, the call to <code>unlock</code> never gets executed, and the mutex is held forever.</p>
<p class="indenthanding">• <strong>Don't allow data structures to become corrupted.</strong> If “<code>new Image(imgSrc)</code>” throws, <code>bgImage</code> is left pointing to a deleted object. In addition, <code>imageChanges</code> has been incremented, even though it's not true that a new image has been installed. (On the other hand, the old image has definitely been eliminated, so I suppose you could argue that the image has been “changed.”)</p>
<p class="noindent"><a id="page_128"></a>Addressing the resource leak issue is easy, because <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a> explains how to use objects to manage resources, and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec2">Item 14</a> introduces the <code>Lock</code> class as a way to ensure that mutexes are released in a timely fashion:</p>
<p class="codelink"><a id="procode197"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode197">Click here to view code image</a></p>
<p class="programlisting"><br>void PrettyMenu::changeBackground(std::istream&amp; imgSrc)<br>{<br>&nbsp;&nbsp;<span class="courierb">Lock ml(&amp;mutex);</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// from Item 14: acquire mutex and<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ensure its later release<br>&nbsp;&nbsp;delete bgImage;<br>&nbsp;&nbsp;++imageChanges;<br>&nbsp;&nbsp;bgImage = new Image(imgSrc);<br>}<br></p>
<p class="noindent">One of the best things about resource management classes like <code>Lock</code> is that they usually make functions shorter. See how the call to <code>unlock</code> is no longer needed? As a general rule, less code is better code, because there's less to go wrong and less to misunderstand when making changes.</p>
<p class="noindent">With the resource leak behind us, we can turn our attention to the issue of data structure corruption. Here we have a choice, but before we can choose, we have to confront the terminology that defines our choices.</p>
<p class="noindent">Exception-safe functions offer one of three guarantees:</p>
<p class="indenthanding">• Functions offering <strong>the basic guarantee</strong> promise that if an exception is thrown, everything in the program remains in a valid state. No objects or data structures become corrupted, and all objects are in an internally consistent state (e.g., all class invariants are satisfied). However, the exact state of the program may not be predictable. For example, we could write <code>changeBackground</code> so that if an exception were thrown, the <code>PrettyMenu</code> object might continue to have the old background image, or it might have some default background image, but clients wouldn't be able to predict which. (To find out, they'd presumably have to call some member function that would tell them what the current background image was.)</p>
<p class="indenthanding">• Functions offering <strong>the strong guarantee</strong> promise that if an exception is thrown, the state of the program is unchanged. Calls to such functions are <em>atomic</em> in the sense that if they succeed, they succeed completely, and if they fail, the program state is as if they'd never been called.</p>
<p class="paraindent"><a id="page_129"></a>Working with functions offering the strong guarantee is easier than working with functions offering only the basic guarantee, because after calling a function offering the strong guarantee, there are only two possible program states: as expected following successful execution of the function, or the state that existed at the time the function was called. In contrast, if a call to a function offering only the basic guarantee yields an exception, the program could be in <em>any</em> valid state.</p>
<p class="indenthanding">• Functions offering <strong>the nothrow guarantee</strong> promise never to throw exceptions, because they always do what they promise to do. All operations on built-in types (e.g., <code>int</code>s, pointers, etc.) are nothrow (i.e., offer the nothrow guarantee). This is a critical building block of exception-safe code.</p>
<p class="paraindent">It might seem reasonable to assume that functions with an empty exception specification are nothrow, but this isn't necessarily true. For example, consider this function:</p>
<p class="codelink"><a id="procode198"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode198">Click here to view code image</a></p>
<p class="programlisting1"><br>int doSomething() <span class="courierb">throw()</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// note empty exception spec.<br></p>
<p class="paraindent">This doesn't say that <code>doSomething</code> will never throw an exception; it says that <em>if</em> <code>doSomething</code> throws an exception, it's a serious error, and the <code>unexpected</code> function should be called.<sup><a id="ch05fn01" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/footnotes.html#ftn.ch05fn01" class="totri-footnote">1</a></sup> In fact, <code>doSomething</code> may not offer any exception guarantee at all. The declaration of a function (including its exception specification, if it has one) doesn't tell you whether a function is correct or portable or efficient, and it doesn't tell you which, if any, exception safety guarantee it offers, either. All those characteristics are determined by the function's implementation, not its declaration.</p>
<p class="noindent">Exception-safe code must offer one of the three guarantees above. If it doesn't, it's not exception-safe. The choice, then, is to determine which guarantee to offer for each of the functions you write. Other than when dealing with exception-unsafe legacy code (which we'll discuss later in this Item), offering no exception safety guarantee should be an option only if your crack team of requirements analysts has identified a need for your application to leak resources and run with corrupt data structures.</p>
<p class="noindent">As a general rule, you want to offer the strongest guarantee that's practical. From an exception safety point of view, nothrow functions are wonderful, but it's hard to climb out of the C part of C++ without <a id="page_130"></a>calling functions that might throw. Anything using dynamically allocated memory (e.g., all STL containers) typically throws a <code>bad_alloc</code> exception if it can't find enough memory to satisfy a request (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch08.html#ch08lev1sec1">Item 49</a>). Offer the nothrow guarantee when you can, but for most functions, the choice is between the basic and strong guarantees.</p>
<p class="noindent">In the case of <code>changeBackground</code>, <em>almost</em> offering the strong guarantee is not difficult. First, we change the type of <code>PrettyMenu</code>'s <code>bgImage</code> data member from a built-in <code>Image*</code> pointer to one of the smart resource-managing pointers described in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>. Frankly, this is a good idea purely on the basis of preventing resource leaks. The fact that it helps us offer the strong exception safety guarantee simply reinforces <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>'s argument that using objects (such as smart pointers) to manage resources is fundamental to good design. In the code below, I show use of <code>tr1::shared_ptr</code>, because its more intuitive behavior when copied generally makes it preferable to <code>auto_ptr</code>.</p>
<p class="noindent">Second, we reorder the statements in <code>changeBackground</code> so that we don't increment <code>imageChanges</code> until the image has been changed. As a general rule, it's a good policy not to change the status of an object to indicate that something has happened until something actually has.</p>
<p class="noindent">Here's the resulting code:</p>
<p class="codelink"><a id="procode199"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode199">Click here to view code image</a></p>
<p class="programlisting"><br>class PrettyMenu {<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;<span class="courierb">std::tr1::shared_ptr&lt;Image&gt;</span> bgImage;<br>&nbsp;&nbsp;...<br>};<br><br>void PrettyMenu::changeBackground(std::istream&amp; imgSrc)<br>{<br>&nbsp;&nbsp;Lock ml(&amp;mutex);<br><br>&nbsp;&nbsp;<span class="courierb">bgImage.reset(new Image(imgSrc));</span>&nbsp;&nbsp;// replace bgImage's internal<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// pointer with the result of the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// "new Image" expression<br>&nbsp;&nbsp;<span class="courierb">++imageChanges;</span><br>}<br></p>
<p class="noindent">Note that there's no longer a need to manually delete the old image, because that's handled internally by the smart pointer. Furthermore, the deletion takes place only if the new image is successfully created. More precisely, the <code>tr1::shared_ptr::reset</code> function will be called only if its parameter (the result of “<code>new Image(imgSrc)</code>”) is successfully created. <code>delete</code> is used only inside the call to <code>reset</code>, so if the function is never entered, <code>delete</code> is never used. Note also that the use of an object (the <code>tr1::shared_ptr</code>) to manage a resource (the dynamically allocated <code>Image</code>) has again pared the length of <code>changeBackground</code>.</p>
<p class="noindent">As I said, those two changes <em>almost</em> suffice to allow <code>changeBackground</code> to offer the strong exception safety guarantee. What's the fly in the ointment? <a id="page_131"></a>The parameter <code>imgSrc</code>. If the <code>Image</code> constructor throws an exception, it's possible that the read marker for the input stream has been moved, and such movement would be a change in state visible to the rest of the program. Until <code>changeBackground</code> addresses that issue, it offers only the basic exception safety guarantee.</p>
<p class="noindent">Let's set that aside, however, and pretend that <code>changeBackground</code> does offer the strong guarantee. (I'm confident you could come up with a way for it to do so, perhaps by changing its parameter type from an <code>istream</code> to the name of the file containing the image data.) There is a general design strategy that typically leads to the strong guarantee, and it's important to be familiar with it. The strategy is known as “copy and swap.” In principle, it's very simple. Make a copy of the object you want to modify, then make all needed changes to the copy. If any of the modifying operations throws an exception, the original object remains unchanged. After all the changes have been successfully completed, swap the modified object with the original in a non-throwing operation (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec8">Item 25</a>.</p>
<p class="noindent">This is usually implemented by putting all the per-object data from the “real” object into a separate implementation object, then giving the real object a pointer to its implementation object. This is often known as the “pimpl idiom,” and <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec6">Item 31</a> describes it in some detail. For <code>PrettyMenu</code>, it would typically look something like this:</p>
<p class="codelink"><a id="procode200"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode200">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">struct PMImpl</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// PMImpl = "PrettyMenu<br>&nbsp;&nbsp;std::tr1::shared_ptr&lt;Image&gt; bgImage;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Impl."; see below for<br>&nbsp;&nbsp;int imageChanges;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// why it's a struct<br>};<br><br>class PrettyMenu {<br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;Mutex mutex;<br>&nbsp;&nbsp;<span class="courierb">std::tr1::shared_ptr&lt;PMImpl&gt; pImpl;</span><br>};<br><br>void PrettyMenu::changeBackground(std::istream&amp; imgSrc)<br>{<br>&nbsp;&nbsp;using std::swap;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see Item 25<br><br>&nbsp;&nbsp;Lock ml(&amp;mutex);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// acquire the mutex<br><br>&nbsp;&nbsp;std::tr1::shared_ptr&lt;PMImpl&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// <span class="courierb">copy</span> obj. data<br>&nbsp;&nbsp;&nbsp;&nbsp;pNew(new PMImpl(*pImpl));<br><br>&nbsp;&nbsp;pNew-&gt;bgImage.reset(new Image(imgSrc));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// modify the copy<br>&nbsp;&nbsp;++pNew-&gt;imageChanges;<br><br>&nbsp;&nbsp;swap(pImpl, pNew);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// <span class="courierb">swap</span> the new<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// data into place<br><br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// release the mutex<br></p>
<p class="noindent"><a id="page_132"></a>In this example, I've chosen to make <code>PMImpl</code> a struct instead of a class, because the encapsulation of <code>PrettyMenu</code> data is assured by <code>pImpl</code> being private. Making <code>PMImpl</code> a class would be at least as good, though somewhat less convenient. (It would also keep the object-oriented purists at bay.) If desired, <code>PMImpl</code> could be nested inside <code>PrettyMenu</code>, but packaging issues such as that are independent of writing exception-safe code, which is our concern here.</p>
<p class="noindent">The copy-and-<code>swap</code> strategy is an excellent way to make all-or-nothing changes to an object's state, but, in general, it doesn't guarantee that the overall function is strongly exception-safe. To see why, consider an abstraction of <code>changeBackground</code>, <code>someFunc</code>, that uses copy-and-<code>swap</code>, but that includes calls to two other functions, <code>f1</code> and <code>f2</code>:</p>
<p class="codelink"><a id="procode201"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode201">Click here to view code image</a></p>
<p class="programlisting"><br>void someFunc()<br>{<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// make copy of local state<br>&nbsp;&nbsp;<span class="courierb">f1();</span><br>&nbsp;&nbsp;<span class="courierb">f2();</span><br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// swap modified state into place<br>}<br></p>
<p class="noindent">It should be clear that if <code>f1</code> or <code>f2</code> is less than strongly exception-safe, it will be hard for <code>someFunc</code> to be strongly exception-safe. For example, suppose that <code>f1</code> offers only the basic guarantee. For <code>someFunc</code> to offer the strong guarantee, it would have to write code to determine the state of the entire program prior to calling <code>f1</code>, catch all exceptions from <code>f1</code>, then restore the original state.</p>
<p class="noindent">Things aren't really any better if both <code>f1</code> and <code>f2</code> <em>are</em> strongly exception safe. After all, if <code>f1</code> runs to completion, the state of the program may have changed in arbitrary ways, so if <code>f2</code> then throws an exception, the state of the program is not the same as it was when <code>someFunc</code> was called, even though <code>f2</code> didn't change anything.</p>
<p class="noindent">The problem is side effects. As long as functions operate only on local state (e.g., <code>someFunc</code> affects only the state of the object on which it's invoked), it's relatively easy to offer the strong guarantee. When functions have side effects on non-local data, it's much harder. If a side effect of calling <code>f1</code>, for example, is that a database is modified, it will be hard to make <code>someFunc</code> strongly exception-safe. There is, in general, no way to undo a database modification that has already been committed; other database clients may have already seen the new state of the database.</p>
<p class="noindent">Issues such as these can prevent you from offering the strong guarantee for a function, even though you'd like to. Another issue is efficiency. The crux of copy-and-<code>swap</code> is the idea of modifying a copy of an <a id="page_133"></a>object's data, then swapping the modified data for the original in a non-throwing operation. This requires making a copy of each object to be modified, which takes time and space you may be unable or unwilling to make available. The strong guarantee is highly desirable, and you should offer it when it's practical, but it's not practical 100% of the time.</p>
<p class="noindent">When it's not, you'll have to offer the basic guarantee. In practice, you'll probably find that you can offer the strong guarantee for some functions, but the cost in efficiency or complexity will make it untenable for many others. As long as you've made a reasonable effort to offer the strong guarantee whenever it's practical, no one should be in a position to criticize you when you offer only the basic guarantee. For many functions, the basic guarantee is a perfectly reasonable choice.</p>
<p class="noindent">Things are different if you write a function offering no exception-safety guarantee at all, because in this respect it's reasonable to assume that you're guilty until proven innocent. You <em>should</em> be writing exception-safe code. But you may have a compelling defense. Consider again the implementation of <code>someFunc</code> that calls the functions <code>f1</code> and <code>f2</code>. Suppose <code>f2</code> offers no exception safety guarantee at all, not even the basic guarantee. That means that if <code>f2</code> emits an exception, the program may have leaked resources inside <code>f2</code>. It means that <code>f2</code> may have corrupted data structures, e.g., sorted arrays might not be sorted any longer, objects being transferred from one data structure to another might have been lost, etc. There's no way that <code>someFunc</code> can compensate for those problems. If the functions <code>someFunc</code> calls offer no exception-safety guarantees, <code>someFunc</code> itself can't offer any guarantees.</p>
<p class="noindent">Which brings me back to pregnancy. A female is either pregnant or she's not. It's not possible to be partially pregnant. Similarly, a software system is either exception-safe or it's not. There's no such thing as a partially exception-safe system. If a system has even a single function that's not exception-safe, the system as a whole is not exception-safe, because calls to that one function could lead to leaked resources and corrupted data structures. Unfortunately, much C++ legacy code was written without exception safety in mind, so many systems today are not exception-safe. They incorporate code that was written in an exception-unsafe manner.</p>
<p class="noindent">There's no reason to perpetuate this state of affairs. When writing new code or modifying existing code, think carefully about how to make it exception-safe. Begin by using objects to manage resources. (Again, see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>.) That will prevent resource leaks. Follow that by determining which of the three exception safety guarantees is the strongest you can practically offer for each function you write, settling for no <a id="page_134"></a>guarantee only if calls to legacy code leave you no choice. Document your decisions, both for clients of your functions and for future maintainers. A function's exception-safety guarantee is a visible part of its interface, so you should choose it as deliberately as you choose all other aspects of a function's interface.</p>
<p class="noindent">Forty years ago, <code>goto</code>-laden code was considered perfectly good practice. Now we strive to write structured control flows. Twenty years ago, globally accessible data was considered perfectly good practice. Now we strive to encapsulate data. Ten years ago, writing functions without thinking about the impact of exceptions was considered perfectly good practice. Now we strive to write exception-safe code.</p>
<p class="noindent">Time goes on. We live. We learn.</p>
<div class="note">
<h3 id="ch05note04">Things to Remember</h3>
<p class="indenthanding">• Exception-safe functions leak no resources and allow no data structures to become corrupted, even when exceptions are thrown. Such functions offer the basic, strong, or nothrow guarantees.</p>
<p class="indenthanding">• The strong guarantee can often be implemented via copy-and-<code>swap</code>, but the strong guarantee is not practical for all functions.</p>
<p class="indenthanding">• A function can usually offer a guarantee no stronger than the weakest guarantee of the functions it calls.</p>
</div>
<h3 id="ch05lev1sec5">Item 30: Understand the ins and outs of inlining.</h3>
<p class="noindent">Inline functions — what a <em>wonderful</em> idea! They look like functions, they act like functions, they're ever so much better than macros (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch01.html#ch01lev1sec2">Item 2</a>), and you can call them without having to incur the overhead of a function call. What more could you ask for?</p>
<p class="noindent">You actually get more than you might think, because avoiding the cost of a function call is only part of the story. Compiler optimizations are typically designed for stretches of code that lack function calls, so when you inline a function, you may enable compilers to perform context-specific optimizations on the body of the function. Most compilers never perform such optimizations on “outlined” function calls.</p>
<p class="noindent">In programming, however, as in life, there is no free lunch, and inline functions are no exception. The idea behind an inline function is to replace each call of that function with its code body, and it doesn't take a Ph.D. in statistics to see that this is likely to increase the size of your object code. On machines with limited memory, overzealous inlining can give rise to programs that are too big for the available <a id="page_135"></a>space. Even with virtual memory, inline-induced code bloat can lead to additional paging, a reduced instruction cache hit rate, and the performance penalties that accompany these things.</p>
<p class="noindent">On the other hand, if an inline function body is <em>very</em> short, the code generated for the function body may be smaller than the code generated for a function call. If that is the case, inlining the function may actually lead to <em>smaller</em> object code and a higher instruction cache hit rate!</p>
<p class="noindent">Bear in mind that <code>inline</code> is a <em>request</em> to compilers, not a command. The request can be given implicitly or explicitly. The implicit way is to define a function inside a class definition:</p>
<p class="codelink"><a id="procode202"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode202">Click here to view code image</a></p>
<p class="programlisting"><br>class Person {<br>public:<br>&nbsp;&nbsp;...<br>&nbsp;&nbsp;int age() const <span class="courierb">{ return theAge; }</span>&nbsp;&nbsp;&nbsp;&nbsp;// an implicit inline request: age is<br>&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// defined in a class definition<br><br>private:<br>&nbsp;&nbsp;int theAge;<br>};<br></p>
<p class="noindent">Such functions are usually member functions, but <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec6">Item 46</a> explains that friend functions can also be defined inside classes. When they are, they're also implicitly declared inline.</p>
<p class="noindent">The explicit way to declare an inline function is to precede its definition with the <code>inline</code> keyword. For example, this is how the standard <code>max</code> template (from <code>&lt;algorithm&gt;</code>) is often implemented:</p>
<p class="codelink"><a id="procode203"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode203">Click here to view code image</a></p>
<p class="programlisting"><br>template&lt;typename T&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// an explicit inline<br><span class="courierb">inline</span> const T&amp; std::max(const T&amp; a, const T&amp; b)&nbsp;&nbsp;&nbsp;// request: std::max is<br>{ return a &lt; b ? b : a; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// preceded by "inline"<br></p>
<p class="noindent">The fact that <code>max</code> is a template brings up the observation that both inline functions and templates are typically defined in header files. This leads some programmers to conclude that function templates must be inline. This conclusion is both invalid and potentially harmful, so it's worth looking into it a bit.</p>
<p class="noindent">Inline functions must typically be in header files, because most build environments do inlining during compilation. In order to replace a function call with the body of the called function, compilers must know what the function looks like. (Some build environments can inline during linking, and a few — e.g., managed environments based on the .NET Common Language Infrastructure (CLI) — can actually inline at runtime. Such environments are the exception, however, not the rule. Inlining in most C++ programs is a compile-time activity.)</p>
<p class="noindent"><a id="page_136"></a>Templates are typically in header files, because compilers need to know what a template looks like in order to instantiate it when it's used. (Again, this is not universal. Some build environments perform template instantiation during linking. However, compile-time instantiation is more common.)</p>
<p class="noindent">Template instantiation is independent of inlining. If you're writing a template and you believe that all the functions instantiated from the template should be inlined, declare the template <code>inline</code>; that's what's done with the <code>std::max</code> implementation above. But if you're writing a template for functions that you have no reason to want inlined, avoid declaring the template inline (either explicitly or implicitly). Inlining has costs, and you don't want to incur them without forethought. We've already mentioned how inlining can cause code bloat (a particularly important consideration for template authors — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec4">Item 44</a>), but there are other costs, too, which we'll discuss in a moment.</p>
<p class="noindent">Before we do that, let's finish the observation that <code>inline</code> is a request that compilers may ignore. Most compilers refuse to inline functions they deem too complicated (e.g., those that contain loops or are recursive), and all but the most trivial calls to virtual functions defy inlining. This latter observation shouldn't be a surprise. <code>virtual</code> means “wait until runtime to figure out which function to call,” and <code>inline</code> means “before execution, replace the call site with the called function.” If compilers don't know which function will be called, you can hardly blame them for refusing to inline the function's body.</p>
<p class="noindent">It all adds up to this: whether a given inline function is actually inlined depends on the build environment you're using — primarily on the compiler. Fortunately, most compilers have a diagnostic level that will result in a warning (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec1">Item 53</a>) if they fail to inline a function you've asked them to.</p>
<p class="noindent">Sometimes compilers generate a function body for an inline function even when they are perfectly willing to inline the function. For example, if your program takes the address of an inline function, compilers must typically generate an outlined function body for it. How can they come up with a pointer to a function that doesn't exist? Coupled with the fact that compilers typically don't perform inlining across calls through function pointers, this means that calls to an inline function may or may not be inlined, depending on how the calls are made:</p>
<p class="codelink"><a id="procode204"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode204">Click here to view code image</a></p>
<p class="programlisting"><br>inline void f() {...}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// assume compilers are willing to inline calls to f<br><br>void (*pf)() = f;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// pf points to f<br><br>...<br><br>f();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this call will be inlined, because it's a "normal" call<br><br><a id="page_137"></a>pf();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// this call probably won't be, because it's through<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// a function pointer<br></p>
<p class="noindent">The specter of un-inlined inline functions can haunt you even if you never use function pointers, because programmers aren't necessarily the only ones asking for pointers to functions. Sometimes compilers generate out-of-line copies of constructors and destructors so that they can get pointers to those functions for use during construction and destruction of objects in arrays.</p>
<p class="noindent">In fact, constructors and destructors are often worse candidates for inlining than a casual examination would indicate. For example, consider the constructor for class <code>Derived</code> below:</p>
<p class="codelink"><a id="procode205"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode205">Click here to view code image</a></p>
<p class="programlisting"><br>class Base {<br>public:<br>...<br><br>private:<br>&nbsp;&nbsp;&nbsp;std::string bm1, bm2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// base members 1 and 2<br>};<br><br>class Derived: public Base {<br>public:<br>&nbsp;&nbsp;<span class="courierb">Derived() {}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Derived's ctor is empty — or is it?<br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;std::string dm1, dm2, dm3;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// derived members 1–3<br>};<br></p>
<p class="noindent">This constructor looks like an excellent candidate for inlining, since it contains no code. But looks can be deceiving.</p>
<p class="noindent">C++ makes various guarantees about things that happen when objects are created and destroyed. When you use <code>new</code>, for example, your dynamically created objects are automatically initialized by their constructors, and when you use <code>delete</code>, the corresponding destructors are invoked. When you create an object, each base class of and each data member in that object is automatically constructed, and the reverse process regarding destruction automatically occurs when an object is destroyed. If an exception is thrown during construction of an object, any parts of the object that have already been fully constructed are automatically destroyed. In all these scenarios, C++ says <em>what</em> must happen, but it doesn't say <em>how</em>. That's up to compiler implementers, but it should be clear that those things don't happen by themselves. There has to be some code in your program to make those things happen, and that code — the code written by compilers and inserted into your program during compilation — has to go somewhere. Sometimes it ends up in constructors and destructors, so we <a id="page_138"></a>can imagine implementations generating code equivalent to the following for the allegedly empty <code>Derived</code> constructor above:</p>
<p class="codelink"><a id="procode206"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode206">Click here to view code image</a></p>
<p class="programlisting"><br>Derived::Derived()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// conceptual implementation of<br>{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// "empty" Derived ctor<br><br><span class="courierb">Base::Base();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// initialize Base part<br><br><span class="courierb">try { dm1.std::string::string(); }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// try to construct dm1<br><span class="courierb">catch (...) {</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if it throws,<br>&nbsp;&nbsp;&nbsp;<span class="courierb">Base::~Base();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destroy base class part and<br>&nbsp;&nbsp;&nbsp;<span class="courierb">throw;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// propagate the exception<br><span class="courierb">}</span><br><br><span class="courierb">try { dm2.std::string::string(); }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// try to construct dm2<br><span class="courierb">catch(...) {</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if it throws,<br>&nbsp;&nbsp;&nbsp;<span class="courierb">dm1.std::string::~string();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destroy dm1,<br>&nbsp;&nbsp;&nbsp;<span class="courierb">Base::~Base();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destroy base class part, and<br>&nbsp;&nbsp;&nbsp;<span class="courierb">throw;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// propagate the exception<br><span class="courierb">}</span><br><br><span class="courierb">try { dm3.std::string::string(); }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// construct dm3<br><span class="courierb">catch(...) {</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if it throws,<br>&nbsp;&nbsp;&nbsp;<span class="courierb">dm2.std::string::~string();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destroy dm2,<br>&nbsp;&nbsp;&nbsp;<span class="courierb">dm1.std::string::~string();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destroy dm1,<br>&nbsp;&nbsp;&nbsp;<span class="courierb">Base::~Base();</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// destroy base class part, and<br>&nbsp;&nbsp;&nbsp;<span class="courierb">throw;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// propagate the exception<br><span class="courierb">}</span><br>}<br></p>
<p class="noindent">This code is unrepresentative of what real compilers emit, because real compilers deal with exceptions in more sophisticated ways. Still, this accurately reflects the behavior that <code>Derived</code>'s “empty” constructor must offer. No matter how sophisticated a compiler's exception implementation, <code>Derived</code>'s constructor must at least call constructors for its data members and base class, and those calls (which might themselves be inlined) could affect its attractiveness for inlining.</p>
<p class="noindent">The same reasoning applies to the <code>Base</code> constructor, so if it's inlined, all the code inserted into it is also inserted into the <code>Derived</code> constructor (via the <code>Derived</code> constructor's call to the <code>Base</code> constructor). And if the <code>string</code> constructor also happens to be inlined, the <code>Derived</code> constructor will gain <em>five copies</em> of that function's code, one for each of the five strings in a <code>Derived</code> object (the two it inherits plus the three it declares itself). Perhaps now it's clear why it's not a no-brain decision whether to inline <code>Derived</code>'s constructor. Similar considerations apply to <code>Derived</code>'s destructor, which, one way or another, must see to it that all the objects initialized by <code>Derived</code>'s constructor are properly destroyed.</p>
<p class="noindent">Library designers must evaluate the impact of declaring functions <code>inline</code>, because it's impossible to provide binary upgrades to the client <a id="page_139"></a>visible inline functions in a library. In other words, if <code>f</code> is an inline function in a library, clients of the library compile the body of <code>f</code> into their applications. If a library implementer later decides to change <code>f</code>, all clients who've used <code>f</code> must recompile. This is often undesirable. On the other hand, if <code>f</code> is a non-inline function, a modification to <code>f</code> requires only that clients relink. This is a substantially less onerous burden than recompiling and, if the library containing the function is dynamically linked, one that may be absorbed in a way that's completely transparent to clients.</p>
<p class="noindent">For purposes of program development, it is important to keep all these considerations in mind, but from a practical point of view during coding, one fact dominates all others: most debuggers have trouble with inline functions. This should be no great revelation. How do you set a breakpoint in a function that isn't there? Although some build environments manage to support debugging of inlined functions, many environments simply disable inlining for debug builds.</p>
<p class="noindent">This leads to a logical strategy for determining which functions should be declared inline and which should not. Initially, don't inline anything, or at least limit your inlining to those functions that must be inline (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch07.html#ch07lev1sec6">Item 46</a>) or are truly trivial (such as <code>Person::age</code> on page <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#page_135">135</a>). By employing inlines cautiously, you facilitate your use of a debugger, but you also put inlining in its proper place: as a hand-applied optimization. Don't forget the empirically determined rule of 80-20, which states that a typical program spends 80% of its time executing only 20% of its code. It's an important rule, because it reminds you that your goal as a software developer is to identify the 20% of your code that can increase your program's overall performance. You can inline and otherwise tweak your functions until the cows come home, but it's wasted effort unless you're focusing on the <em>right</em> functions.</p>
<div class="note">
<h3 id="ch05note05">Things to Remember</h3>
<p class="indenthanding">• Limit most inlining to small, frequently called functions. This facilitates debugging and binary upgradability, minimizes potential code bloat, and maximizes the chances of greater program speed.</p>
<p class="indenthanding">• Don't declare function templates <code>inline</code> just because they appear in header files.</p>
</div>
<h3 id="ch05lev1sec6">Item 31: Minimize compilation dependencies between files</h3>
<p class="noindent"><a id="page_140"></a>So you go into your C++ program and make a minor change to the implementation of a class. Not the class interface, mind you, just the implementation; only the private stuff. Then you rebuild the program, figuring that the exercise should take only a few seconds. After all, only one class has been modified. You click on Build or type <code>make</code> (or some equivalent), and you are astonished, then mortified, as you realize that the whole <em>world</em> is being recompiled and relinked! Don't you just <em>hate</em> it when that happens?</p>
<p class="noindent">The problem is that C++ doesn't do a very good job of separating interfaces from implementations. A class definition specifies not only a class interface but also a fair number of implementation details. For example:</p>
<p class="codelink"><a id="procode207"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode207">Click here to view code image</a></p>
<p class="programlisting"><br>class Person {<br>public:<br>&nbsp;&nbsp;Person(const std::string&amp; name, const Date&amp; birthday,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Address&amp; addr);<br>&nbsp;&nbsp;std::string name() const;<br>&nbsp;&nbsp;std::string birthDate() const;<br>&nbsp;&nbsp;std::string address() const;<br>&nbsp;&nbsp;...<br><br>private:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">std::string theName;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// implementation detail<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">Date theBirthDate;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// implementation detail<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="courierb">Address theAddress;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// implementation detail<br>};<br></p>
<p class="noindent">Here, class <code>Person</code> can't be compiled without access to definitions for the classes the <code>Person</code> implementation uses, namely, <code>string</code>, <code>Date</code>, and <code>Address</code>. Such definitions are typically provided through <code>#include</code> directives, so in the file defining the <code>Person</code> class, you are likely to find something like this:</p>
<p class="programlisting"><br>#include &lt;string&gt;<br>#include "date.h"<br>#include "address.h"<br></p>
<p class="noindent">Unfortunately, this sets up a compilation dependency between the file defining <code>Person</code> and these header files. If any of these header files is changed, or if any of the header files <em>they</em> depend on changes, the file containing the <code>Person</code> class must be recompiled, as must any files that use <code>Person</code>. Such cascading compilation dependencies have caused many a project untold grief.</p>
<p class="noindent"><a id="page_141"></a>You might wonder why C++ insists on putting the implementation details of a class in the class definition. For example, why can't you define <code>Person</code> this way, specifying the implementation details of the class separately?</p>
<p class="codelink"><a id="procode208"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode208">Click here to view code image</a></p>
<p class="programlisting"><br>namespace std {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class string;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// forward declaration (an incorrect<br>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// one — see below)<br><br>class Date;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// forward declaration<br>class Address;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// forward declaration<br><br>class Person {<br>public:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Person(const std::string&amp; name, const Date&amp; birthday,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Address&amp; addr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::string name() const;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::string birthDate() const;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::string address() const;<br>&nbsp;&nbsp;&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent">If that were possible, clients of <code>Person</code> would have to recompile only if the interface to the class changed.</p>
<p class="noindent">There are two problems with this idea. First, <code>string</code> is not a class, it's a typedef (for <code>basic_string&lt;char&gt;</code>). As a result, the forward declaration for <code>string</code> is incorrect. The proper forward declaration is substantially more complex, because it involves additional templates. That doesn't matter, however, because you shouldn't try to manually declare parts of the standard library. Instead, simply use the proper <code>#include</code>s and be done with it. Standard headers are unlikely to be a compilation bottleneck, especially if your build environment allows you to take advantage of precompiled headers. If parsing standard headers really is a problem, you may need to change your interface design to avoid using the parts of the standard library that give rise to the undesirable <code>#include</code>s.</p>
<p class="noindent">The second (and more significant) difficulty with forward-declaring everything has to do with the need for compilers to know the size of objects during compilation. Consider:</p>
<p class="codelink"><a id="procode209"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode209">Click here to view code image</a></p>
<p class="programlisting"><br>int main()<br>{<br><span class="courierb">int x;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// define an int<br><br><span class="courierb">Person p(</span> <span class="courierb"><span class="courieri">params</span></span> <span class="courierb">);</span>&nbsp;&nbsp;&nbsp;// define a Person<br>&nbsp;&nbsp;&nbsp;...<br>}<br></p>
<p class="noindent">When compilers see the definition for <code>x</code>, they know they must allocate enough space (typically on the stack) to hold an <code>int</code>. No problem. Each <a id="page_142"></a>compiler knows how big an <code>int</code> is. When compilers see the definition for <code>p</code>, they know they have to allocate enough space for a <code>Person</code>, but how are they supposed to know how big a <code>Person</code> object is? The only way they can get that information is to consult the class definition, but if it were legal for a class definition to omit the implementation details, how would compilers know how much space to allocate?</p>
<p class="noindent">This question fails to arise in languages like Smalltalk and Java, because, when an object is defined in such languages, compilers allocate only enough space for a <em>pointer</em> to an object. That is, they handle the code above as if it had been written like this:</p>
<p class="codelink"><a id="procode210"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode210">Click here to view code image</a></p>
<p class="programlisting"><br>int main()<br>{<br>&nbsp;&nbsp;int x;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// define an int<br><br>&nbsp;&nbsp;Person *p;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// define a pointer to a Person<br>&nbsp;&nbsp;...<br>}<br></p>
<p class="noindent">This, of course, is legal C++, so you can play the “hide the object implementation behind a pointer” game yourself. One way to do that for <code>Person</code> is to separate it into two classes, one offering only an interface, the other implementing that interface. If the implementation class is named <code>PersonImpl</code>, <code>Person</code> would be defined like this:</p>
<p class="codelink"><a id="procode211"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode211">Click here to view code image</a></p>
<p class="programlisting"><br>#include &lt;string&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// standard library components<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// shouldn't be forward-declared<br><br>#include &lt;memory&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for tr1::shared_ptr; see below<br><br>class PersonImpl;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// forward decl of Person impl. class<br>class Date;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// forward decls of classes used in<br><br>class Address;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Person interface<br>class Person {<br>public:<br>Person(const std::string&amp; name, const Date&amp; birthday,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Address&amp; addr);<br>std::string name() const;<br>std::string birthDate() const;<br>std::string address() const;<br>...<br><br>private:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ptr to implementation;<br>&nbsp;&nbsp;std::tr1::shared_ptr&lt;PersonImpl&gt; pImpl;&nbsp;&nbsp;// see Item 13 for info on<br>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// std::tr1::shared_ptr<br></p>
<p class="noindent">Here, the main class (<code>Person</code>) contains as a data member nothing but a pointer (here, a <code>tr1::shared_ptr</code> — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>) to its implementation class (<code>PersonImpl</code>). Such a design is often said to be using the <em>pimpl idiom</em> <a id="page_143"></a>(“pointer to implementation”). Within such classes, the name of the pointer is often <code>pImpl</code>, as it is above.</p>
<p class="noindent">With this design, clients of <code>Person</code> are divorced from the details of dates, addresses, and persons. The implementations of those classes can be modified at will, but <code>Person</code> clients need not recompile. In addition, because they're unable to see the details of <code>Person</code>'s implementation, clients are unlikely to write code that somehow depends on those details. This is a true separation of interface and implementation.</p>
<p class="noindent">The key to this separation is replacement of dependencies on <em>definitions</em> with dependencies on <em>declarations</em>. That's the essence of minimizing compilation dependencies: make your header files self-sufficient whenever it's practical, and when it's not, depend on declarations in other files, not definitions. Everything else flows from this simple design strategy. Hence:</p>
<p class="indenthanding">• <strong>Avoid using objects when object references and pointers will do.</strong> You may define references and pointers to a type with only a declaration for the type. Defining <em>objects</em> of a type necessitates the presence of the type's definition.</p>
<p class="indenthanding">• <strong>Depend on class declarations instead of class definitions whenever you can.</strong> Note that you <em>never</em> need a class definition to declare a function using that class, not even if the function passes or returns the class type by value:</p>
<p class="codelink"><a id="procode212"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode212">Click here to view code image</a></p>
<p class="programlisting"><br>class Date;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// class declaration<br><br>Date today();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// fine — no definition<br>void clearAppointments(Date d);&nbsp;&nbsp;&nbsp;&nbsp;// of Date is needed<br></p>
<p class="noindent">Of course, pass-by-value is generally a bad idea (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec3">Item 20</a>), but if you find yourself using it for some reason, there's still no justification for introducing unnecessary compilation dependencies.</p>
<p class="noindent">The ability to declare <code>today</code> and <code>clearAppointments</code> without defining <code>Date</code> may surprise you, but it's not as curious as it seems. If anybody <em>calls</em> those functions, <code>Date</code>'s definition must have been seen prior to the call. Why bother to declare functions that nobody calls, you wonder? Simple. It's not that <em>nobody</em> calls them, it's that <em>not everybody</em> calls them. If you have a library containing dozens of function declarations, it's unlikely that every client calls every function. By moving the onus of providing class definitions from your header file of function <em>declarations</em> to clients' files containing function <em>calls</em>, you eliminate artificial client dependencies on type definitions they don't really need.</p>
<p class="indenthanding">• <a id="page_144"></a><strong>Provide separate header files for declarations and definitions.</strong> In order to facilitate adherence to the above guidelines, header files need to come in pairs: one for declarations, the other for definitions. These files must be kept consistent, of course. If a declaration is changed in one place, it must be changed in both. As a result, library clients should always <code>#include</code> a declaration file instead of forward-declaring something themselves, and library authors should provide both header files. For example, the <code>Date</code> client wishing to declare <code>today</code> and <code>clearAppointments</code> shouldn't manually forward-declare <code>Date</code> as shown above. Rather, it should <code>#include</code> the appropriate header of declarations:</p>
<p class="codelink"><a id="procode213"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode213">Click here to view code image</a></p>
<p class="programlisting"><br><span class="courierb">#include "datefwd.h"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// header file declaring (but not<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// defining) class Date<br><br>Date today();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// as before<br>void clearAppointments(Date d);<br></p>
<p class="noindent">The name of the declaration-only header file “<code>datefwd.h</code>” is based on the header <code>&lt;iosfwd&gt;</code> from the standard C++ library (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch09.html#ch09lev1sec2">Item 54</a>). <code>&lt;iosfwd&gt;</code> contains declarations of iostream components whose corresponding definitions are in several different headers, including <code>&lt;sstream&gt;</code>, <code>&lt;streambuf&gt;</code>, <code>&lt;fstream&gt;</code>, and <code>&lt;iostream&gt;</code>.</p>
<p class="noindent"><code>&lt;iosfwd&gt;</code> is instructive for another reason, and that's to make clear that the advice in this Item applies as well to templates as to non-templates. Although <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec5">Item 30</a> explains that in many build environments, template definitions are typically found in header files, some build environments allow template definitions to be in non-header files, so it still makes sense to provide declaration-only headers for templates. <code>&lt;iosfwd&gt;</code> is one such header.</p>
<p class="noindent">C++ also offers the <code>export</code> keyword to allow the separation of template declarations from template definitions. Unfortunately, compiler support for <code>export</code> is scanty, and real-world experience with <code>export</code> is scantier still. As a result, it's too early to say what role <code>export</code> will play in effective C++ programming.</p>
<p class="noindent">Classes like <code>Person</code> that employ the pimpl idiom are often called <em>Handle classes</em>. Lest you wonder how such classes actually do anything, one way is to forward all their function calls to the corresponding implementation classes and have those classes do the real work. For example, here's how two of <code>Person</code>'s member functions could be implemented:</p>
<p class="codelink"><a id="procode214"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode214">Click here to view code image</a></p>
<p class="programlisting"><br>&nbsp;&nbsp;&nbsp;#include "Person.h"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// we're implementing the Person class,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// so we must #include its class definition<br><br><br><a id="page_145"></a>#include "PersonImpl.h"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// we must also #include PersonImpl's class<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// definition, otherwise we couldn't call<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// its member functions; note that<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// PersonImpl has <span class="courieri">exactly</span> the same<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// member functions as Person — their<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// interfaces are identical<br><br>Person::Person(const std::string&amp; name, const Date&amp; birthday,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Address&amp; addr)<br>: pImpl(new PersonImpl(name, birthday, addr))<br>{}<br><br>std::string Person::name() const<br>{<br>&nbsp;&nbsp;return pImpl-&gt;name();<br>}<br></p>
<p class="noindent">Note how the <code>Person</code> constructor calls the <code>PersonImpl</code> constructor (by using <code>new</code> — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec4">Item 16</a>) and how <code>Person::name</code> calls <code>PersonImpl::name</code>. This is important. Making <code>Person</code> a Handle class doesn't change what <code>Person</code> does, it just changes the way it does it.</p>
<p class="noindent">An alternative to the Handle class approach is to make <code>Person</code> a special kind of abstract base class called an <em>Interface class</em>. The purpose of such a class is to specify an interface for derived classes (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec3">Item 34</a>). As a result, it typically has no data members, no constructors, a virtual destructor (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec3">Item 7</a>), and a set of pure virtual functions that specify the interface.</p>
<p class="noindent">Interface classes are akin to Java's and .NET's Interfaces, but C++ doesn't impose the restrictions on Interface classes that Java and .NET impose on Interfaces. Neither Java nor .NET allow data members or function implementations in Interfaces, for example, but C++ forbids neither of these things. C++'s greater flexibility can be useful. As <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec5">Item 36</a> explains, the implementation of non-virtual functions should be the same for all classes in a hierarchy, so it makes sense to implement such functions as part of the Interface class that declares them.</p>
<p class="noindent">An Interface class for <code>Person</code> could look like this:</p>
<p class="codelink"><a id="procode215"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode215">Click here to view code image</a></p>
<p class="programlisting"><br>class Person {<br>public:<br>&nbsp;&nbsp;virtual ~Person();<br><br>&nbsp;&nbsp;virtual std::string name() const = 0;<br>&nbsp;&nbsp;virtual std::string birthDate() const = 0;<br>&nbsp;&nbsp;virtual std::string address() const = 0;<br>&nbsp;&nbsp;...<br>};<br></p>
<p class="noindent"><a id="page_146"></a>Clients of this class must program in terms of <code>Person</code> pointers and references, because it's not possible to instantiate classes containing pure virtual functions. (It is, however, possible to instantiate classes <em>derived</em> from <code>Person</code> — see below.) Like clients of Handle classes, clients of Interface classes need not recompile unless the Interface class's interface is modified.</p>
<p class="noindent">Clients of an Interface class must have a way to create new objects. They typically do it by calling a function that plays the role of the constructor for the derived classes that are actually instantiated. Such functions are typically called factory functions (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch03.html#ch03lev1sec1">Item 13</a>) or <em>virtual constructors</em>. They return pointers (preferably smart pointers — see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch04.html#ch04lev1sec1">Item 18</a>) to dynamically allocated objects that support the Interface class's interface. Such functions are often declared <code>static</code> inside the Interface class:</p>
<p class="codelink"><a id="procode216"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode216">Click here to view code image</a></p>
<p class="programlisting"><br>class Person {<br>public:<br>...<br><br><span class="courierb">static</span> std::tr1::shared_ptr&lt;Person&gt;&nbsp;&nbsp;&nbsp;&nbsp;// return a tr1::shared_ptr to a new<br>&nbsp;&nbsp;&nbsp;<span class="courierb">create</span>(const std::string&amp; name,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Person initialized with the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Date&amp; birthday,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// given params; see Item 18 for<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Address&amp; addr);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// why a tr1::shared_ptr is returned<br>...<br>};<br></p>
<p class="noindent">Clients use them like this:</p>
<p class="codelink"><a id="procode217"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode217">Click here to view code image</a></p>
<p class="programlisting"><br>std::string name;<br>Date dateOfBirth;<br>Address address;<br>...<br><br>// create an object supporting the Person interface<br>std::tr1::shared_ptr&lt;Person&gt; pp(<span class="courierb">Person::create(name, dateOfBirth, address)</span>);<br><br>...<br><br>std::cout &lt;&lt; pp-&gt;name()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use the object via the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt; " was born on "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Person interface<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt; pp-&gt;birthDate()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt; " and now lives at "<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt; pp-&gt;address();<br>...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// the object is automatically<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// deleted when pp goes out of<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// scope — see Item 13<br></p>
<p class="noindent">At some point, of course, concrete classes supporting the Interface class's interface must be defined and real constructors must be called. That all happens behind the scenes inside the files containing <a id="page_147"></a>the implementations of the virtual constructors. For example, the Interface class <code>Person</code> might have a concrete derived class <code>RealPerson</code> that provides implementations for the virtual functions it inherits:</p>
<p class="codelink"><a id="procode218"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode218">Click here to view code image</a></p>
<p class="programlisting"><br>class RealPerson: public Person {<br>public:<br>&nbsp;&nbsp;RealPerson(const std::string&amp; name, const Date&amp; birthday,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Address&amp; addr)<br>&nbsp;&nbsp;: theName(name), theBirthDate(birthday), theAddress(addr)<br>&nbsp;&nbsp;{}<br><br>&nbsp;&nbsp;virtual ~RealPerson() {}<br><br>&nbsp;&nbsp;std::string name() const;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// implementations of these<br>&nbsp;&nbsp;std::string birthDate() const;&nbsp;&nbsp;&nbsp;// functions are not shown, but<br>&nbsp;&nbsp;std::string address() const;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// they are easy to imagine<br><br>private:<br>&nbsp;&nbsp;std::string theName;<br>&nbsp;&nbsp;Date theBirthDate;<br>&nbsp;&nbsp;Address theAddress;<br>};<br></p>
<p class="noindent">Given <code>RealPerson</code>, it is truly trivial to write <code>Person::create</code>:</p>
<p class="codelink"><a id="procode219"></a><a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/images.html#iprocode219">Click here to view code image</a></p>
<p class="programlisting"><br>std::tr1::shared_ptr&lt;Person&gt; Person::create(const std::string&amp; name,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Date&amp; birthday,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const Address&amp; addr)<br>{<br>&nbsp;&nbsp;return std::tr1::shared_ptr&lt;Person&gt;(new RealPerson(name, birthday,addr));<br>}<br></p>
<p class="noindent">A more realistic implementation of <code>Person::create</code> would create different types of derived class objects, depending on e.g., the values of additional function parameters, data read from a file or database, environment variables, etc.</p>
<p class="noindent"><code>RealPerson</code> demonstrates one of the two most common mechanisms for implementing an Interface class: it inherits its interface specification from the Interface class (<code>Person</code>), then it implements the functions in the interface. A second way to implement an Interface class involves multiple inheritance, a topic explored in <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch06.html#ch06lev1sec9">Item 40</a>.</p>
<p class="noindent">Handle classes and Interface classes decouple interfaces from implementations, thereby reducing compilation dependencies between files. Cynic that you are, I know you're waiting for the fine print. “What does all this hocus-pocus cost me?” you mutter. The answer is the usual one in computer science: it costs you some speed at runtime, plus some additional memory per object.</p>
<p class="noindent"><a id="page_148"></a>In the case of Handle classes, member functions have to go through the implementation pointer to get to the object's data. That adds one level of indirection per access. And you must add the size of this implementation pointer to the amount of memory required to store each object. Finally, the implementation pointer has to be initialized (in the Handle class's constructors) to point to a dynamically allocated implementation object, so you incur the overhead inherent in dynamic memory allocation (and subsequent deallocation) and the possibility of encountering <code>bad_alloc</code> (out-of-memory) exceptions.</p>
<p class="noindent">For Interface classes, every function call is virtual, so you pay the cost of an indirect jump each time you make a function call (see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec3">Item 7</a>). Also, objects derived from the Interface class must contain a virtual table pointer (again, see <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch02.html#ch02lev1sec3">Item 7</a>). This pointer may increase the amount of memory needed to store an object, depending on whether the Interface class is the exclusive source of virtual functions for the object.</p>
<p class="noindent">Finally, neither Handle classes nor Interface classes can get much use out of inline functions. <a class="nounder" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#ch05lev1sec5">Item 30</a> explains why function bodies must typically be in header files in order to be inlined, but Handle and Interface classes are specifically designed to hide implementation details like function bodies.</p>
<p class="noindent">It would be a serious mistake, however, to dismiss Handle classes and Interface classes simply because they have a cost associated with them. So do virtual functions, and you wouldn't want to forgo those, would you? (If so, you're reading the wrong book.) Instead, consider using these techniques in an evolutionary manner. Use Handle classes and Interface classes during development to minimize the impact on clients when implementations change. Replace Handle classes and Interface classes with concrete classes for production use when it can be shown that the difference in speed and/or size is significant enough to justify the increased coupling between classes.</p>
<div class="note">
<h3 id="ch05note06">Things to Remember</h3>
<p class="indenthanding">• The general idea behind minimizing compilation dependencies is to depend on declarations instead of definitions. Two approaches based on this idea are Handle classes and Interface classes.</p>
<p class="indenthanding">• Library header files should exist in full and declaration-only forms. This applies regardless of whether templates are involved.</p>
</div>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/effective-c-55/0321334876/ch04.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">4. Designs and Declarations</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/effective-c-55/0321334876/ch06.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">6. Inheritance and Object-Oriented Design</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/0321334876/chapter/ch05.html" data-for-analytics="0321334876:ch05.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/effective-c-55/0321334876/ch05.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>
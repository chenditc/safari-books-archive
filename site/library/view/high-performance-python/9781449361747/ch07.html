<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch07.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch07.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch07.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch07.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>7. Compiling to C - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch07.html"><meta name="description" content="Chapter&nbsp;7.&nbsp;Compiling to C Questions you’ll be able to answer after this chapter How can I have my python code run as lower level code? What is the ... "><meta property="og:title" content="7. Compiling to C"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="7. Compiling to C"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;7.&nbsp;Compiling to C Questions you’ll be able to answer after this chapter How can I have my python code run as lower level code? What is the ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch07.html" data-for-analytics="9781449361747:ch07.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%207.%20Compiling%20to%20C&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch07.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch06.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">6. Matrix and Vector Computation</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch08.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">8. Concurrency</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-compiling"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;7.&nbsp;Compiling to C</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
How can I have my python code run as lower level code?
</li><li class="listitem">
What is the difference between a JIT and a compiler?
</li><li class="listitem">
What tasks are compiled python code faster at than native python?
</li><li class="listitem">
Why do type annotations speed up compiled python code?
</li><li class="listitem">
How can I write modules for python using C or Fortran?
</li><li class="listitem">
How can I use libraries from C or Fortran in python?
</li></ul></div></div><p>The easiest way to get your code to run faster is to make it do less work.
Assuming you’ve already chosen good algorithms and you’ve reduced the amount of
data you’re processing the easiest way to execute fewer instructions is to
compile your code down to machine code.</p><p>Python offers a number of options including pure C-based compiling approaches
like Cython, ShedSkin and Pythran, LLVM-based compiling via Numba and the
replacement virtual machine PyPy which includes a built-in Just In Time
compiler. You need to balance the requirements of code adaptability and team
velocity when deciding which route to take.</p><p>Each of these tools add a new dependency to your tool-chain and additionally Cython requires you to write in a new language type (a hybrid of Python with C) which means you need a new skill. Cython’s new language may hurt your team’s velocity as team members without knowledge of C may have trouble supporting this code, in practice this is probably a small concern as you’ll only use Cython in well-chosen small regions of your code.</p><p>It it worth noting that by performing CPU and memory profiling on your code you’ll probably start thinking about higher-level algorithmic optimizations that you might apply. These algorithmic changes could help avoid doing unnecessary work (e.g. additional logic to avoid computations or caching to avoid re-calculation) - Python’s expressivity helps you to spot these algorithmic opportunities. Radim Řehůřek discusses how a Python implementation can beat a pure C implementation in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-radim">Making deep learning fly with RadimRehurek.com</a>.</p><p>In this chapter we’ll review:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Cython - this is the most commonly used tool for compiling to C covering both <code class="literal">numpy</code> and normal Python code, it requires some knowledge of C
</li><li class="listitem">
Shed Skin - an automatic Python to C converter for non-<code class="literal">numpy</code> code
</li><li class="listitem">
Numba - a new compiler specialized to <code class="literal">numpy</code> code
</li><li class="listitem">
Pythran - a new compiler for both <code class="literal">numpy</code> and non-<code class="literal">numpy</code> code
</li><li class="listitem">
PyPy - a stable Just in Time compiler for non-<code class="literal">numpy</code> code that is a replacement for the normal Python executable
</li></ul></div><p>Later in this chapter Micha looks at Foreign Function Interfaces allowing C code to be compiled into extension modules for Python. Python’s native API is used along with <code class="literal">ctypes</code> and <code class="literal">CFFI</code> (from the authors of PyPy), along with the <code class="literal">f2py</code> Fortran-to-Python converter.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_what_sort_of_speed_gains_are_possible">What sort of speed gains are possible?</h2></div></div></div><p>Gains of an order or magnitude or more are quite possible if your problem yields
to a compiled approach. Here we look at various ways to achieve 1-2 orders of
magnitude speed-up on a single core along with using multiple cores through
OpenMP.</p><p>Python code that tends to run faster after compiling is probably mathematical
and it probably has lots of loops that repeat the same operations many times. Inside these loops you’re probably making lots of temporary objects.</p><p>Code that calls out to external libraries (e.g. regular expressions, string
operations, calls to database libraries) is unlikely to show any speed-up after
compiling. Programs that are I/O bound are also unlikely to show significant speed-ups.</p><p>If your Python code focuses on calling vectorized <code class="literal">numpy</code> routines then it may not run any faster after compilation - it’ll only run faster if the code being compiled is mainly Python (and probably if it is mainly looping). In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a> we look at <code class="literal">numpy</code> operations, there aren’t many intermediate objects so compiling wouldn’t help.</p><p>Overall it is very unlikely that your compiled code will run any faster than a hand-crafted C routine but it is also unlikely to run much slower. It is quite possible that the generated C code from your Python will run as fast as a hand-written C routine unless the C coder has particularly good knowledge of ways to tune the C code to the target machine’s architecture.</p><p>For math-focused code it is possible that a hand-coded Fortran routine will beat an equivalent C routine but again this probably requires expert-level knowledge. Overall a compiled result (probably using Cython, Pythran or Shed Skin) will be as close to a hand-coded-in-C result as most programmers will need.</p><p>Keep the diagram in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-diminishing-returns">Figure&nbsp;7-1</a> in mind when you profile and work on your algorithm. A small amount of work understanding your code through profiling should enable you to make smarter choices at an algorithmic level. After this some focused work with a compiler or JIT should buy you an additional speed-up. After this it is probably possible to keep tweaking your algorithm but don’t be surprised to see increasingly small improvements coming from increasingly large amounts of work on your part. Know when additional effort probably isn’t useful.</p><div class="figure"><a id="FIG-04b-diminishing-returns"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 432; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_diminishing_returns.png" alt="" width="1000" height="730" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_diminishing_returns.png"></div></div><div class="figure-title">Figure&nbsp;7-1.&nbsp;Some effort profiling and compiling brings a lot of reward, continued effort tends to pay increasingly less.</div></div><p>If you’re dealing with Python code and the batteries included libraries, without
<code class="literal">numpy</code>, then Cython, ShedSkin and PyPy are your main choices. If you’re working
with <code class="literal">numpy</code> then Cython, Numba and Pythran are the right choices. These tools
all support Python 2.7, some support Python 3.2+.</p><p>Some of the following examples require a little understanding of C compilers and
C code. If you lack this knowledge then you should learn a little C and compile
a working C program before diving in too deeply.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="jit_vs_compiler">JITs vs Compilers</h2></div></div></div><p>The tools we’ll look at roughly split into two sets - compiling ahead of time
(Cython, ShedSkin, Pythran) and compiling Just In Time (Numba, PyPy).</p><p>By compiling ahead of time you create a static library that’s specialized to
your machine. If you download <code class="literal">numpy</code>, <code class="literal">scipy</code> or <code class="literal">scikit-learn</code> then it’ll
either compile parts of the library using Cython on your machine (or you’ll use
a pre-built compiled library if you’re using a distribution like Continuum’s
Anaconda). By compiling ahead of use you’ll have a library that can instantly be
used to work on solving your problem.</p><p>By compiling Just In Time you don’t have to do much (if any) work up-front, you
let the compiler step in to compile just the right parts of the code at the time
of use. This means you have a “cold start” problem - if most of your program
could be compiled and currently none of it is, as soon as you start running your
code it’ll run very slowly whilst it compiles. If this happens every time you
run a script and you run the script many times, this cost can become
significant. PyPy suffers from this so you may not want to use it for short but
frequently running scripts.</p><p>The current state of affairs shows us that compiling ahead of time buys us the
best speed-ups and often this requires the most manual effort. Just In Time
compiling offers some impressive speed-ups with very little manual intervention.
You’ll have to consider these trade-offs when choosing the right technology for
your problem.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_why_does_type_information_help_the_code_run_faster">Why does type information help the code run faster?</h2></div></div></div><p>Python is dynamically typed - a variable could refer to an object of any type,
and any line of code could change the type of the object that is referred to.
This makes it difficult for the virtual machine to opimize how the code is
executed at the machine code level as it doesn’t know which fundamental datatype
will be used for future operations. By keeping the code generic it will run more
slowly.</p><p>In the following example <code class="literal">v</code> is either a floating point number or a pair of
floating point numbers that represent a <code class="literal">complex</code> number, this could occur in
the same loop at different points of time or in related serial sections of code:</p><pre class="programlisting"><code class="n">v</code> <code class="o">=</code> <code class="o">-</code><code class="mf">1.0</code>
<code class="k">print</code> <code class="nb">type</code><code class="p">(</code><code class="n">v</code><code class="p">),</code> <code class="nb">abs</code><code class="p">(</code><code class="n">v</code><code class="p">)</code></pre><pre class="screen">&lt;type 'float'&gt; 1.0</pre><pre class="programlisting"><code class="n">v</code> <code class="o">=</code> <code class="mi">1</code><code class="o">-</code><code class="mi">1j</code>
<code class="k">print</code> <code class="nb">type</code><code class="p">(</code><code class="n">v</code><code class="p">),</code> <code class="nb">abs</code><code class="p">(</code><code class="n">v</code><code class="p">)</code></pre><pre class="screen">&lt;type 'complex'&gt; 1.41421356237</pre><p>The <code class="literal">abs</code> function works differently depending on the underlying datatype. <code class="literal">abs</code>
for an integer or a floating point number simply results in turning a negative
    value into a positive value. <code class="literal">abs</code> for a complex number involves taking the
    square root of the sum of the squared components:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0701.png" alt="" width="264" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0701.png"></span></p><p>The machine code for the <code class="literal">complex</code> example involves more instructions and will
take longer to run. Before calling <code class="literal">abs</code> on a variable Python first has to
lookup the type of the variable and then decide which version of a function to
call - this overhead adds up when you make a lot of repeated calls.</p><p>Inside Python every fundamental object like an integer will be wrapped up in a
higher level Python object (e.g. an <code class="literal">int</code> for an integer). The higher level
object has extra functions like <code class="literal">__hash__</code> to assist with storage and <code class="literal">__str__</code>
for printing.</p><p>Inside a section of code that is CPU bound it is often the case that the types
of variables do not change. This gives us an opportunity for static compilation
and faster code execution.</p><p>If all we want are a lot of intermediate mathematical operations then we don’t
need the higher level functions, we may not need the machinery for reference
counting either. We can drop down to the machine code level and do our
calculations quickly using machine code and bytes, rather than manipulating the
higher level Python objects which involves greater overhead. To do this we
determine the types of our objects ahead of time so we can generate the correct
C code.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_using_a_c_compiler">Using a C compiler</h2></div></div></div><p>In the following examples I’ll use <code class="literal">gcc</code> and <code class="literal">g++</code> from the GNU C Compiler
toolset. You could use an alternative compiler (e.g. Intel’s <code class="literal">icc</code> or
Microsoft’s <code class="literal">cl</code>) if you configure your environment correctly. Cython uses
<code class="literal">gcc</code>, Shed Skin uses <code class="literal">g++</code>.</p><p><code class="literal">gcc</code> is a very good choice for most platforms, it is well supported and quite
advanced. It is often possible to squeeze out more performance using a tuned
compiler (e.g. Intel’s <code class="literal">icc</code> may produce faster code than <code class="literal">gcc</code> on Intel
devices), the cost is that you have to gain some more domain knowledge and learn
how to tune the flags on the alternative compiler.</p><p>C and C++ are often used for static compilation rather than other languages like
Fortran due to their ubiquity and the wide range of supporting libraries. The
compiler and the converter (Cython etc. are the converters in this case) have an
opportunity to study the annotated code to determine if static optimization
steps (like inlining functions and unrolling loops) can be applied. Aggressive
analysis of the intermediate abstract syntax tree (performed by Pythran, Numba
and PyPy) provides opportunities for combining knowledge of Python’s way of
expressing things to inform the underlying compiler how best to take advantage
of the patterns that have been seen.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_reviewing_the_julia_set_example">Reviewing the Julia Set example</h2></div></div></div><p>Back in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html">Chapter&nbsp;2</a> we profiled the Julia set generator.
This code uses integers and complex numbers to produce an output image. The
calculation of the image is CPU-bound.</p><p>The main cost in the code was the CPU-bound nature of the inner loop which
calculates the <code class="literal">output</code> list, this list can be drawn as a square pixel array
where each value represents the cost to generate that pixel.</p><p>The code for the inner function is shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-review-julia">Example&nbsp;7-1</a>:</p><div class="example"><a id="compiling-review-julia"></a><div class="example-title">Example&nbsp;7-1.&nbsp;Reviewing the Julia function’s CPU-bound code</div><div class="example-contents"><pre class="screen">def calculate_z_serial_purepython(maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and abs(z) &lt; 2:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>On Ian’s laptop the original Julia set calculation on a <code class="literal">1000*1000</code> grid with
<code class="literal">maxiter=300</code> takes approximately 11 seconds using a pure Python implemention
running on CPython 2.7.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="compiling-cython">Cython</h2></div></div></div><p>Cython <sup>[<a id="id620693" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id620693" class="footnote">17</a>]</sup> is a compiler that converts type-annotated
Python into a compiled extension module, the type annotations are C-like. This
extension can be imported as a regular Python module using <code class="literal">import</code>. Getting
started is simple, it does have a learning curve that must be climbed with each
additional level of complexity and optimization. For Ian this is the tool of
choice for turning calculation-bound functions into faster code - due to its
wide usage, its maturity and because of its OpenMP support.</p><p>With the OpenMP standard it is possible to convert parallel problems into
multiprocessing-aware modules which run on multiple CPUs on one machine. The
threads are hidden from your Python code, they operate via the generated C code.</p><p>Cython (announed 2007) is a fork of Pyrex (announced 2002) which expands the
capabilities beyond the original aims of Pyrex. Libraries that use Cython
include scipy, scikit-learn, lxml and zmq.</p><p>Cython can be used via a <code class="literal">setup.py</code> script to compile a module, it can also be
used interactively in IPython via a <span class="emphasis"><em>magic</em></span> command. Typically the types are
annotated by the developer although some automated annotation is possible.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_compiling_a_pure_python_version_using_cython">Compiling a pure-Python version using Cython</h3></div></div></div><p>The easy way to begin writing a compiled extension module involves three files.
Using our Julia set as an example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
the calling Python code (the bulk of our Julia code from before)
</li><li class="listitem">
the function to be compiled in a new <code class="literal">.pyx</code> file
</li><li class="listitem">
a <code class="literal">setup.py</code> file which contains the instructions for calling Cython to make
  the extension module
</li></ul></div><p>Using the above approach the <code class="literal">setup.py</code> script is called to use Cython to
compile the <code class="literal">.pyx</code> file into a compiled module. One Unix-like systems the
compiled module will probably be a <code class="literal">.so</code> file, on Windows it should be a <code class="literal">.pyd</code>
(DLL-like Python library).</p><p>For the Julia example we’ll use:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">julia1.py</code> to build the input lists and call the calculation function
</li><li class="listitem">
<code class="literal">cythonfn.pyx</code> containing the CPU-bound function which we can annotate
</li><li class="listitem">
<code class="literal">setup.py</code> containing the build instructions
</li></ul></div><p>The result of running <code class="literal">setup.py</code> is a module which can be imported. In  our
<code class="literal">julia1.py</code> script in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-import">Example&nbsp;7-2</a>  we only need to make some tiny changes to <code class="literal">import</code> the new
module and call our function.</p><div class="example"><a id="compiling-cython-import"></a><div class="example-title">Example&nbsp;7-2.&nbsp;Importing the newly compiled module into our main code</div><div class="example-contents"><pre class="screen">...
import calculate  # as defined in setup.py
...
def calc_pure_python(desired_width, max_iterations):
    #...
    start_time = time.time()
    output = calculate.calculate_z(max_iterations, zs, cs)
    end_time = time.time()
    secs = end_time - start_time
    print "Took", secs, "seconds"
...</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-pure-python">Example&nbsp;7-3</a> we will start with a pure Python version without type annotations.</p><div class="example"><a id="compiling-cython-pure-python"></a><div class="example-title">Example&nbsp;7-3.&nbsp;Unmodified pure-Python code in cythonfn.pyx (renamed from .py) for Cython’s setup.py</div><div class="example-contents"><pre class="screen"># cythonfn.pyx
def calculate_z(maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and abs(z) &lt; 2:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>The <code class="literal">setup.py</code> script shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-setup">Example&nbsp;7-4</a> is short, it defines how to convert <code class="literal">cythonfn.pyx</code> into
<code class="literal">calculate.so</code>.</p><div class="example"><a id="compiling-cython-setup"></a><div class="example-title">Example&nbsp;7-4.&nbsp;setup.py which converts cythonfn.pyx into C code for compilation by Cython</div><div class="example-contents"><pre class="screen">from distutils.core import setup
from distutils.extension import Extension
from Cython.Distutils import build_ext

setup(
        cmdclass = {'build_ext': build_ext},
        ext_modules = [Extension("calculate", ["cythonfn.pyx"])]
        )</pre></div></div><p>When we run the <code class="literal">setup.py</code> script in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-setup-build">Example&nbsp;7-5</a> with the argument <code class="literal">build_ext</code> Cython will look
for <code class="literal">cythonfn.pyx</code> and build <code class="literal">calculate.so</code>.</p><div class="note"><h3 class="title">Note</h3><p>Remember that this is a manual step - if you update your <code class="literal">.pyx</code> or <code class="literal">setup.py</code> and forget to re-run the build command, you won’t have an updated <code class="literal">.so</code> module to import. If you’re unsure whether you compiled the code then check the timestamp for the <code class="literal">.so</code> file. If in doubt - delete the generated C files and the <code class="literal">.so</code> file and build them again.</p></div><div class="example"><a id="compiling-cython-setup-build"></a><div class="example-title">Example&nbsp;7-5.&nbsp;Running setup.py to build a new compiled module</div><div class="example-contents"><pre class="screen">$ python setup.py build_ext --inplace
running build_ext
cythoning cythonfn.pyx to cythonfn.c
building 'calculate' extension
gcc -pthread -fno-strict-aliasing -DNDEBUG -g -fwrapv -O2 -Wall
    -Wstrict-prototypes -fPIC -I/usr/include/python2.7 -c cythonfn.c
    -o build/temp.linux-x86_64-2.7/cythonfn.o
gcc -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,
    -Bsymbolic-functions -Wl,-z,
    relro build/temp.linux-x86_64-2.7/cythonfn.o -o calculate.so</pre></div></div><p>The <code class="literal">--inplace</code> argument tells Cython to build the compiled module into the
current directory rather than into a separate <code class="literal">build</code> directory. After the build
has completed we’ll have the intermediate <code class="literal">cythonfn.c</code> which is rather hard to
read along with <code class="literal">calculate.so</code>.</p><p>Now when the <code class="literal">julia1.py</code> code is run the compiled module is imported and the
Julia set is calculated on Ian’s laptop in 8.9 seconds rather than the more
usual 11 seconds. This is a small improvement for very little effort.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_cython_annotations_to_analyse_a_block_of_code">Cython annotations to analyse a block of code</h3></div></div></div><p>The above example shows that we can quickly build a compiled module. For tight
loops and mathematical operations this alone often leads to a speed-up.
Obviously we should not opimize blindly - we need to know what is slow so we can
decide where to focus our efforts.</p><p>Cython has an annotation option that will output an HTML file which we can view
in a browser. To generate the annotation we use <code class="literal">$ cython -a cythonfn.pyx</code> and
the output file <code class="literal">cythonfn.html</code> is generated. Viewed in a browser we see
something like the following in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-1">Figure&nbsp;7-2</a>.</p><div class="figure"><a id="FIG-04b-cython-lists-1"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_1.png" alt="" width="558" height="266" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_1.png"></div></div><div class="figure-title">Figure&nbsp;7-2.&nbsp;Colored Cython output of unannotated function.</div></div><p>Each line can be expanded with a double click to show the generated C code. More yellow
means “more calls into the Python virtual machine” whilst more white means “more non-Python C code”.
The goal is to remove as many of the yellow lines as possible and to end up with
as much white as possible.</p><p>Although “more yellow lines” means more calls into the virtual machine, this won’t necessarily cause your code to run slower. Each call into the VM has a cost, the cost will only be significant if the calls occur inside large loops. Calls outside of large loops (e.g. the line used to create <code class="literal">output</code> at the start of the function) are not expensive relative to the cost of the inner calculation loop. Don’t waste your time on the lines that don’t cause a slow-down.</p><p>The lines with the most calls back into the Python virtual machine (the “most yellow”) are lines 4 and 8. From our previous profiling work we know that line 8 is likely to be called over 30 million times so that’s a great candidate to focus on.</p><p>Lines 9, 10 and 11 are almost as yellow, we also know they’re inside the tight inner loop. In total they’ll be responsible for the bulk of the execution time of this function - we need to focus on these first. Refer back to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-line-profiler">line_profiler for line-by-line measurements</a> if you need to remind yourself of how much time is spent in this section.</p><p>Lines 6 and 7 are less yellow, since they’re called 1 million times they’ll have a much smaller effect on the final speed so we can focus on them later. Since they are <code class="literal">list</code> objects there’s actually nothing we can do to speed up their access except in a future section (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-and-numpy">Cython and numpy</a>) replace the <code class="literal">list</code> objects with <code class="literal">numpy</code> arrays which will buy a small speed advantage.</p><p>To understand the yellow regions you can expand each line with a double-click.
In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-1-expanded">Figure&nbsp;7-3</a> we can see that to create the <code class="literal">output</code> list we iterate over
the length of <code class="literal">zs</code> building new Python objects which are reference-counted by
the Python virtual machine. Even those these calls are expensive they won’t really affect the execution time of this function.</p><div class="figure"><a id="FIG-04b-cython-lists-1-expanded"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_1_expanded.png" alt="" width="1000" height="440" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_1_expanded.png"></div></div><div class="figure-title">Figure&nbsp;7-3.&nbsp;C code behind a line of Python code.</div></div><p>To improve the execution time of our function we need to start declaring the types of objects that are involved in the expensive inner-loops. These loops can then make fewer of the relatively expensive calls back into the Python virtual machine, saving us time.</p><p>In general the lines that probably cost the most CPU time are those:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Inside tight inner-loops
</li><li class="listitem">
Dereferencing <code class="literal">list</code>, <code class="literal">array</code> or <code class="literal">np.array</code> items
</li><li class="listitem">
Performing mathematical operations
</li></ul></div><div class="note"><h3 class="title">Note</h3><p>If you don’t know which lines are most frequently executed then use a profiling tool - <code class="literal">line_profiler</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#profiling-line-profiler">line_profiler for line-by-line measurements</a> would be the most appropriate. You’ll learn which lines are exectuted most frequencly and which lines cost the most inside the Python virtual machine so you’ll have clear evidence of which lines you need to focus on to get the best speed gain.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_adding_some_type_annotations">Adding some type annotations</h3></div></div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-1">Figure&nbsp;7-2</a> showed that almost every line of our function is calling back into the
Python virtual machine. All of our numeric work is also calling back into Python
as we are using the higher level Python objects. We need to convert these into
local C objects and then after doing our numerical coding we need to convert the
result back to a Python object.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-primitive-types">Example&nbsp;7-6</a> we can add some primitive types using the <code class="literal">cdef</code> syntax.</p><div class="note"><h3 class="title">Note</h3><p>It is important to note that these types will only be understood by Cython and
<span class="emphasis"><em>not</em></span> by Python. Cython uses these types to convert the Python code to C objects
which do not have to call back into the Python stack, so the operations run at a
faster speed but with a loss of flexibility and a loss of development speed.</p></div><p>The types we add are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">int</code> for a signed integer
</li><li class="listitem">
<code class="literal">unsigned int</code> for an integer that can only be positive
</li><li class="listitem">
<code class="literal">double complex</code> for double-precision complex numbers
</li></ul></div><p>The <code class="literal">cdef</code> keyword lets us declare variables inside the function body, these must be
declared at the top of the function as that’s a requirement from the C language specification.</p><div class="example"><a id="compiling-cython-primitive-types"></a><div class="example-title">Example&nbsp;7-6.&nbsp;Adding primitive C types to start making our compiled function run faster by doing more work in C and less via the Python virtual machine</div><div class="example-contents"><pre class="screen">def calculate_z(int maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    cdef unsigned int i, n
    cdef double complex z, c
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and abs(z) &lt; 2:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><div class="note"><h3 class="title">Note</h3><p>When adding Cython annotations you’re adding non-Python code to the <code class="literal">.pyx</code> file, this means you lose the interactive nature of developing Python in the interpreter. For those of you familiar with coding in C we go back to the code-compile-run-debug cycle.</p></div><p>You might wonder if we could add a type annotation to the lists that we pass in.
We can use the <code class="literal">list</code> keyword but practically this has no effect for this
example. The <code class="literal">list</code> objects still have to be interrogated at the Python level to
pull out their contents and this is very slow.</p><p>The act of giving types to some of the primitive objects is reflected in the
following annotated output in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-2">Figure&nbsp;7-4</a>. Critically lines 11 and 12 - two of our most frequently called lines - have now turned from yellow to white indicating that they no longer call back to the Python virtual machine. We can anticipate a great speed-up compared to the previous version.</p><p>Line 10 is called over 30 million times so we’ll still want to focus on it.</p><div class="figure"><a id="FIG-04b-cython-lists-2"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_2.png" alt="" width="552" height="293" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_2.png"></div></div><div class="figure-title">Figure&nbsp;7-4.&nbsp;Our first type annotations.</div></div><p>After compiling this version takes 4.3 seconds to complete. With only a few
changes to the function we are running at twice the speed of the original Python
version.</p><p>It is important to note that the reason we are gaining speed is because more of
the frequently-performed operations are being pushed down to the C level - in
this case the updates to <code class="literal">z</code> and <code class="literal">n</code>. This means that the C compiler can
optimize how the lower level functions are operating on the bytes that represent
these variables, without calling into the relatively slow Python virtual
machine.</p><p>We can see in the previous Cython figure that the <code class="literal">while</code> loop is still somewhat
expensive (it is yellow). The expensive call is in to Python for the <code class="literal">abs</code>
function for the complex <code class="literal">z</code>. Cython does not provide a native <code class="literal">abs</code> for complex
numbers, instead we can provide our own local expansion.</p><p>As noted before <code class="literal">abs</code> for a complex number involves taking the square root of
the sum of the squares of the real and imaginary components. In our test we want
to see if the square root of the result is less than 2. Rather than take the
square root we can instead square the other side of the comparison, so we turn
<code class="literal">&lt; 2</code> into <code class="literal">&lt; 4</code>. This avoids us having to calculate the square root as the
final part of the <code class="literal">abs</code> function.</p><p>In essence we started with:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0702.png" alt="" width="232" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0702.png"></span></p><p>and we have simplified the operation to:</p><p><span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_0703.png" alt="" width="213" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_0703.png"></span></p><p>If we retained the <code class="literal">sqrt</code> operation in the following code we still see an
improvement in execution speed. One of the secrets to optimizing code is to make
it do as little work as possible. Removing a relatively expensive operation by
considering the ultimate aim of a function means that the C compiler can focus
on what it is good at, rather than trying to intuit the programmer’s ultimate
needs.</p><p>Writing equivalent but more specialized code to solve the same problem is known as <span class="emphasis"><em>strength reduction</em></span>. You trade worse flexibility (and possibly worse readability) for faster execution.</p><p>This mathematical unwinding leads to the next example in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-expanding-abs">Example&nbsp;7-7</a> where we have replaced the
relatively expensive <code class="literal">abs</code> function with a simplified line of expanded
mathematics.</p><div class="example"><a id="augmentingwithtypes-cython-expanding-abs"></a><div class="example-title">Example&nbsp;7-7.&nbsp;Expanding the abs function using Cython</div><div class="example-contents"><pre class="screen">def calculate_z(int maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    cdef unsigned int i, n
    cdef double complex z, c
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and (z.real * z.real + z.imag * z.imag) &lt; 4:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>By annotating the code we see a small improvement in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-04b-cython-lists-4">Figure&nbsp;7-5</a>
for the cost of the <code class="literal">while</code> statement on line 10. Now it involves fewer calls into the Python virtual machine. It isn’t immediately obvious how much of a speed gain we’ll get but we know that this line is called over 30 million times so we anticipate a good improvement.</p><div class="figure"><a id="FIG-04b-cython-lists-4"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 270; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_4.png" alt="" width="553" height="293" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/04b_cython_lists_4.png"></div></div><div class="figure-title">Figure&nbsp;7-5.&nbsp;Expanded math to get a final win.</div></div><p>This change has a dramatic effect - by reducing the number of Python calls in
the innermost loop we greatly reduce the calculation time of the function. This new version completes in just 0.25 seconds,
an amazing speed-up on the original version by approximately 40 times.</p><p>For a final possible improvement on this piece of code we can disable bounds
checking for each dereference in the list. The goal of the bounds checking is to
ensure that the program does not access data outside of the allocated array - in
C it is easy to access out of the bounds of an arrray and this will give
unexpected results (and probably a Segmentation Fault!).</p><p>By default Cython protects the developer from accidentally addressing outside of
the list’s limits. This protection costs a little bit of CPU time, it occurs in
the outer loop of our function so in total in won’t account for much time. It is
normally safe to disable bounds checking unless you are performing your own
calculations for array addressing in which case you will have to be careful to
stay within the bounds of the list.</p><p>Cython has a set of flags that can be expressed in various ways, the easiest is
to add them as single line comments at the start of the <code class="literal">.pyx</code> file. It is also
possible to use a decorator or compile-time flag to change these settings. To
disable bounds checking we add a directive for Cython inside as comment at the
start of the <code class="literal">.pyx</code> file:</p><pre class="programlisting"><code class="c">#cython: boundscheck=False</code>
<code class="k">def</code> <code class="nf">calculate_z</code><code class="p">(</code><code class="nb">int</code> <code class="n">maxiter</code><code class="p">,</code> <code class="n">zs</code><code class="p">,</code> <code class="n">cs</code><code class="p">):</code></pre><p>As noted above the bounds checking will only save a little bit of time as it
occurs in the outer loop, not in the inner loop which is more expensive. For
this example it doesn’t save us any more time.</p><div class="note"><h3 class="title">Note</h3><p>Try disabling bounds checking and wrap-around checking if your CPU-bound code is in a loop that is dereferencing items frequently.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_shed_skin">Shed Skin</h2></div></div></div><p>Shed Skin <sup>[<a id="id645371" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id645371" class="footnote">18</a>]</sup> is an experimental
Python to C++ compiler that works with Python 2.4-2.7. It uses type inference to
<span class="emphasis"><em>automatically</em></span> inspect a Python program to annotate the types used for each
variable, this annotated code is then translated into C code for compilation
with a standard compiler like <code class="literal">g++</code>. The automatic introspection is a very
interesting feature of Shed Skin, the user only has to provide an example of how
to call the function with the right kind of data and Shed Skin will figure the
rest out.</p><p>The benefit of type inference is that the programmer does not need to explicitly
specify types by hand. The cost is that the analyzer has to be able to infer
types for every variable in the program, in the current version up to thousands
of lines of Python can be automatically converted into C. It uses the Boehm
mark-sweep garbage collector to dynamically manage memory. The Boehm GC is also
used in Mono and GNU Compiler for Java. One negative for Shed Skin is that it
uses external implementations for the standard libraries. Anything that has not
been implemented (which includes <code class="literal">numpy</code>) will not be supported.</p><p>The project has over 75 examples including many math-focused pure Python modules
and even a fully working Commodore 64 emulator. Each run significantly faster
after being compiled with Shed Skin compared to running them natively in
CPython.</p><p>Shed Skin can build stand-alone executables that don’t depend on an installed
Python installation or extension modules for use with <code class="literal">import</code> in regular Python
code.</p><p>Compiled modules manage their own memory. This means that memory from a Python
process is copied in and results are copied back - there is no explicit sharing
of memory. For large blocks of memory (e.g. a large matrix) the cost of
performing the copy may be significant, we look at this briefly towards the end
of this section.</p><p>Shed Skin provides a similar set of benefits to PyPy (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-pypy">PyPy</a>). As such PyPy might be easier to use as it doesn’t require any compilation steps. The way that Shed Skin automatically adds type annotations might be interesting to some users and the generated C may be easier to read than Cython’s generated C if you intend to modify the resulting C code. I strongly suspect that the automatic type introspection code will be of interest to other compiler writers in the community.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_building_an_extension_module">Building an extension module</h3></div></div></div><p>For this example we will build an extension module, we can <code class="literal">import</code> the
generated module just as we did with the Cython examples. We could also compile
this module into a stand-alone executable.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-shedskin-external-module">Example&nbsp;7-8</a> we have a code example in a separate module, it contains normal Python
code - note that it is not annotated in any way. Also note that we have added a
<code class="literal">__main__</code> test, this makes this module self-contained for type analysis. Shed
Skin can use this <code class="literal">__main__</code> block to infer the types that are passed into
<code class="literal">calculate_z</code> and from there infer the types used inside the CPU-bound function.</p><div class="example"><a id="compiling-shedskin-external-module"></a><div class="example-title">Example&nbsp;7-8.&nbsp;Moving our CPU-bound function to a separate module (as we did with Cython) to allow Shed Skin’s automatic type inference system to run. Note the addition of a <span class="emphasis"><em>main</em></span> block which provides example arguments that the type inferencer will use.</div><div class="example-contents"><pre class="screen"># shedskinfn.py
def calculate_z(maxiter, zs, cs):
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and abs(z) &lt; 2:
            z = z * z + c
            n += 1
        output[i] = n
    return output


if __name__ == "__main__":
    # make a trivial example using the correct types to enable type inference
    # call the function so ShedSkin can analyze the types
    output = calculate_z(1, [0j], [0j])</pre></div></div><p>We can import this module in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-shedskin-import">Example&nbsp;7-9</a> both before it has been compiled and after in the usual way. Since the code isn’t modified (unlike with Cython) we can call the original Python module before compilation. You won’t get a speed improvement if you haven’t compiled your code but you can debug in a lightweight way using the normal Python tools.</p><div class="example"><a id="compiling-shedskin-import"></a><div class="example-title">Example&nbsp;7-9.&nbsp;Importing the external module to allow Shed Skin to compile just that module</div><div class="example-contents"><pre class="screen">...
import shedskinfn
...
def calc_pure_python(desired_width, max_iterations):
    #...
    start_time = time.time()
    output = shedskinfn.calculate_z(max_iterations, zs, cs)
    end_time = time.time()
    secs = end_time - start_time
    print "Took", secs, "seconds"
...</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-shedskin-annotations">Example&nbsp;7-10</a> we can ask Shed Skin to provide an annotated output of its analysis using
<code class="literal">shedskin -ann shedskinfn.py</code> and it generates <code class="literal">shedskinfn.ss.py</code>. We only need
to “seed” the analysis with the dummy <code class="literal">__main__</code> function if we’re compiling an
extension module:</p><div class="example"><a id="compiling-shedskin-annotations"></a><div class="example-title">Example&nbsp;7-10.&nbsp;Examining the annotated output from Shed Skin to see which types it has inferred</div><div class="example-contents"><pre class="screen"># shedskinfn.ss.py
def calculate_z(maxiter, zs, cs):        # maxiter: [int],
                                         # zs: [list(complex)],
                                         # cs: [list(complex)]
    """Calculate output list using Julia update rule"""
    output = [0] * len(zs)               # [list(int)]
    for i in range(len(zs)):             # [__iter(int)]
        n = 0                            # [int]
        z = zs[i]                        # [complex]
        c = cs[i]                        # [complex]
        while n &lt; maxiter and abs(z) &lt; 2: # [complex]
            z = z * z + c                # [complex]
            n += 1                       # [int]
        output[i] = n                    # [int]
    return output                        # [list(int)]


if __name__ == "__main__":               # []
    # make a trivial example using the correct types to enable type inference
    # call the function so ShedSkin can analyze the types
    output = calculate_z(1, [0j], [0j])  # [list(int)]</pre></div></div><p>The <code class="literal">__main__</code> types are analysed and then inside
<code class="literal">calculate_z</code> variables like <code class="literal">z</code> and <code class="literal">c</code> can be inferred from the objects they
interact with.</p><p>We compile this module using <code class="literal">shedskin --extmod shedskinfn.py</code>. The following
are generated:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
<code class="literal">shedskinfn.hpp</code> C++ header file
</li><li class="listitem">
<code class="literal">shedskinfn.cpp</code> C++ source file
</li><li class="listitem">
<code class="literal">Makefile</code>
</li></ul></div><p>By running <code class="literal">make</code> we generate <code class="literal">shedskinfn.so</code>. We can use this in Python with
<code class="literal">import shedskinfn</code>. The execution time for <code class="literal">julia1.py</code> using <code class="literal">shedskinfn.so</code> is
0.4s - this is a huge win compared to the uncompiled version for doing very
little work.</p><p>We can also expand the <code class="literal">abs</code> function as we did with Cython in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-expanding-abs">Example&nbsp;7-7</a>. After running this version (with
just the one <code class="literal">abs</code> line being modified) and using some additional flags
<code class="literal">--nobounds --nowrap</code> we get a final execution time of 0.3 seconds. This is
slightly slower (by 0.05 seconds) than the Cython version but <span class="emphasis"><em>we didn’t have to
specify all that type information</em></span>. This makes experimenting with Shed Skin very
easy. PyPy runs the same version of the code at a similar speed.</p><p>Just because Cython, PyPy and Shed Skin share similar run-times on this example does not mean that this is a general result. To get the best speed-ups for your project you must investigate these different tools and run your own experiments.</p><p>Shed Skin allows you to specify extra compile-time flags like <code class="literal">-ffast-math</code> or
<code class="literal">-O3</code> and you can add Profile Guided Optimization in two passes (one to gather
execution statistics, a second to optimize the generated code in light of those
statistics) to try to make additional speed improvements. Profile Guided
Optimization didn’t make the Julia example run any faster, in practice I never
use PGO as the gains seem to be rare.</p><p>You should note that by default integers are 32 bits, if you want larger ranges
with a 64 bit integer then specify the <code class="literal">--long</code> flag. You should also avoid
allocating small objects (e.g. new tuples) inside tight inner loops as the
garbage collector doesn’t handle these as efficiently as it could.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_the_cost_of_the_memory_copies">The cost of the memory copies</h3></div></div></div><p>In our example Shed Skin copies Python <code class="literal">list</code> objects into the Shed Skin
environment by flattening the data into basic C types, it then converts the
result from the C function back into a Python <code class="literal">list</code> at the end of executing the
function. These conversions and copies take time. Might this account for the
missing 0.05 seconds that we noted in the previous result?</p><p>We can modify our <code class="literal">shedskinfn.py</code> file to remove the actual work, just so we can
calculate the cost of copying data into and out of the function via Shed Skin.
The variant of <code class="literal">calculate_z</code> below is all we need.</p><pre class="programlisting"><code class="k">def</code> <code class="nf">calculate_z</code><code class="p">(</code><code class="n">maxiter</code><code class="p">,</code> <code class="n">zs</code><code class="p">,</code> <code class="n">cs</code><code class="p">):</code>
    <code class="sd">"""Calculate output list using Julia update rule"""</code>
    <code class="n">output</code> <code class="o">=</code> <code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="nb">len</code><code class="p">(</code><code class="n">zs</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">output</code></pre><p>When we execute <code class="literal">julia1.py</code> using the above skeleton function the execution time
is approximately 0.05s (and obviously it does not calculate the correct
result!). This time is the cost of copying 2,000,000 complex numbers into
<code class="literal">calculate_z</code> and the cost of copying 1,000,000 integers out again. In essence
Shed Skin and Cython are generating the same machine code, the execution speed
difference comes down to Shed Skin running in a separate memory space which
requiress and overhead for copying data across. On the flip side - with Shed
Skin you don’t have to do the up-front annotation work which offers quite a time
saving.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_cython_and_numpy">Cython and numpy</h2></div></div></div><p><a id="compiling-cython-and-numpy"></a>List objects (for background see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch03.html">Chapter&nbsp;3</a>) have an overhead for each dereference as the objects they reference
can occur anywhere in memory, rather than in contiguous blocks of RAM. Array
objects store primitive types in contiguous blocks of RAM which enables faster
addressing.</p><p>Python has the <code class="literal">array</code> module which offers 1D storage for basic primitives
(including integers, floating point numbers, characters and unicode strings).
Numpy’s <code class="literal">numpy.array</code> module allows multidimensional storage and a wider range
of primitive types including complex numbers.</p><p>When iterating over an array object in a predictable fashion the compiler can be
instructed to avoid asking Python to calculate the appropriate address and
instead to move to the next primitive item in sequence directly by its memory
address. Since the data is laid out in a contiguous block it is trivial to
calculate the address of the next item in C using an offset, rather than asking
CPython to calculate the same result which would involve a slow call back into
the virtual machine.</p><p>You should note that if you run the followin <code class="literal">numpy</code> version <span class="emphasis"><em>without</em></span> any
Cython annotations (i.e. just run it as a plain Python script) it’ll take about
71 seconds to run - far in excess of the plain Python <code class="literal">list</code> version which costs
around 11 seconds. The slowdown is because of the overhead of dereferencing
individual elements in the <code class="literal">numpy</code> lists - it was never designed to be used this
way, even though to a beginer this might feel like the intuitive way of handling
operations. By compiling the code this overhead is removed.</p><p>Cython has two special syntax forms for this. Older version of Cython had a
special access type for Numpy arrays, more recently the generalised buffer
interface protocol has been introduced through the <code class="literal">memoryview</code> - this allows
the same low level access to any object that implements the buffer interface
including Numpy arrays and Python arrays.</p><p>An added bonus of the buffer interface is that blocks of memory can easily be
shared with other C libraries, without any need to convert them from Python
objects into another form.</p><p>The following code block in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-numpy">Example&nbsp;7-11</a> looks a little
like the original implemenation except that we have added <code class="literal">memoryview</code>
annotations. The function’s second argument is <code class="literal">double complex[:] zs</code> which
means we have a double precision complex object using the buffer protocol
(specified using <code class="literal">[]</code>), which contains a 1 dimensional data block (specified by
the single colon <code class="literal">:</code>).</p><div class="example"><a id="augmentingwithtypes-cython-numpy"></a><div class="example-title">Example&nbsp;7-11.&nbsp;Annotated numpy version of the Julia calculation function</div><div class="example-contents"><pre class="screen"># cython_np.pyx
import numpy as np
cimport numpy as np

def calculate_z(int maxiter, double complex[:] zs, double complex[:] cs):
    """Calculate output list using Julia update rule"""
    cdef unsigned int i, n
    cdef double complex z, c
    cdef int[:] output = np.empty(len(zs), dtype=np.int32)
    for i in range(len(zs)):
        n = 0
        z = zs[i]
        c = cs[i]
        while n &lt; maxiter and (z.real * z.real + z.imag * z.imag) &lt; 4:
            z = z * z + c
            n += 1
        output[i] = n
    return output</pre></div></div><p>In addition to specifying the input arguments using the buffer annotation syntax
we also annotate the <code class="literal">output</code> variable, assigning a 1D numpy <code class="literal">array</code> to it via
<code class="literal">empty</code>. The call to <code class="literal">empty</code> will allocate a block of memory but will not
initialize the memory with sane values, so it could contain anything. We will
overwrite the contents of this array in the inner loop so we don’t need to
re-assign it with a default value. This is slightly faster than allocating and
setting the contents of the array with a default value.</p><p>I’ve also expanded the call to <code class="literal">abs</code> using the faster, more explicit math
version. This version runs in 0.23 seconds, this is a slightly faster result
than the original Cythonized version of the pure Python Julia example in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-expanding-abs">Example&nbsp;7-7</a>. The pure Python version has an
overhead every time it dereferences a Python <code class="literal">complex</code> object - but these
dereferences occur in the outer loop and so don’t account for much of the
execution time. After the outer loop we make native versions of these variables
and they operate at “C speed”. The inner loop for both this <code class="literal">numpy</code> example and
the former pure Python example are doing the same work on the same data - so the
time difference is accounted for by the outer loop dereferences and the creation
of the <code class="literal">output</code> arrays.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="compiling-cython-omp">Parallelizing the solution with OpenMP on One Machine</h3></div></div></div><p>As a final step in the evolution of this version of the code let us look at the
use of the OpenMP C++ extensions to parallelize our embarrassingly parallel
problem. If your problem fits this pattern then you can quickly take advantage
of multiple cores in your computer.</p><p>OpenMP (Open Multi-Processing) is a well defined cross platform API that
supports parallel execution and memory sharing for C, C++ and Fortran. It is
built into most modern C compilers and if the C code is written appropriately
then the parallelization occurs at the compiler level, so it comes with
relatively little effort to the developer through Cython.</p><p>With Cython OpenMP can be added using the <code class="literal">prange</code> (parallel range) operator and
adding the <code class="literal">-fopenmp</code> compiler directive to <code class="literal">setup.py</code>. Work in a <code class="literal">prange</code> loop
can be performed in parallel because we disable the Global Interpreter Lock
(GIL).</p><p>A modified version of the code with <code class="literal">prange</code> support is shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-omp1">Example&nbsp;7-12</a>.
<code class="literal">with nogil:</code> specifies the block where the GIL is disabled, inside this block we use <code class="literal">prange</code> to enable an OpenMP parallel <code class="literal">for</code> loop to independently calculate each <code class="literal">i</code>.</p><p>When disabling the GIL we must <span class="emphasis"><em>not</em></span> operate on regular Python objects (e.g.
lists), we must only operate on primitive objects and objects that support the
memoryview interface. If we operated on normal Python objects in parallel then
we would have to solve the associated memory management problems that the GIL
deliberately avoids. Cython does not prevent us from manipulating Python objects
and only pain and confusion can result if you do this!</p><div class="example"><a id="augmentingwithtypes-cython-omp1"></a><div class="example-title">Example&nbsp;7-12.&nbsp;Adding prange to enable parallelization using OpenMP</div><div class="example-contents"><pre class="screen"># cython_np.pyx
from cython.parallel import prange
import numpy as np
cimport numpy as np

def calculate_z(int maxiter, double complex[:] zs, double complex[:] cs):
    """Calculate output list using Julia update rule"""
    cdef unsigned int i, length
    cdef double complex z, c
    cdef int[:] output = np.empty(len(zs), dtype=np.int32)
    length = len(zs)
    with nogil:
        for i in prange(length, schedule="guided"):
            z = zs[i]
            c = cs[i]
            output[i] = 0
            while output[i] &lt; maxiter and (z.real * z.real + z.imag * z.imag) &lt; 4:
                z = z * z + c
                output[i] += 1
    return output</pre></div></div><p>To compile <code class="literal">cython_np.pyx</code> we have to modify the <code class="literal">setup.py</code> script as shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-cython-openmp-setup">Example&nbsp;7-13</a>. We tell it
to inform the C compiler to use <code class="literal">-fopenmp</code> as an argument during compilation to
enable OpenMP and to link with the OpenMP libraries.</p><div class="example"><a id="compiling-cython-openmp-setup"></a><div class="example-title">Example&nbsp;7-13.&nbsp;Adding OpenMP compiler and linker flags to setup.py for Cython</div><div class="example-contents"><pre class="screen">#setup.py
from distutils.core import setup
from distutils.extension import Extension
from Cython.Distutils import build_ext

setup(
        cmdclass = {'build_ext': build_ext},
        ext_modules = [Extension("calculate",
                                 ["cython_np.pyx"],
                                  extra_compile_args=['-fopenmp'],
                                  extra_link_args=['-fopenmp'])]
        )</pre></div></div><p>With Cython’s <code class="literal">prange</code> we can choose different scheduling approaches. With
<code class="literal">static</code> the workload is distributed evenly across the available CPUs. Some of
our calculation regions are expensive in time, some are cheap.  If we ask Cython
to schedule the work chunks equally using <code class="literal">static</code> across the CPUs then the
results for some regions will complete faster than others and that thread will
then sit idle.</p><p>Both the <code class="literal">dynamic</code> and <code class="literal">guided</code> schedule options attempt to mitigate this
problem by allocating work in smaller chunks dynamically during run-time so that
the CPUs are more evenly distributed when the workload’s calculation time is
variable. For your code the correct choice will vary depending on the nature of
your workload.</p><p>By introducing OpenMPand using <code class="literal">schedule="guided"</code> our execution time drops to
approximately 0.07s - the <code class="literal">guided</code> schedule will dynamically assign work so
fewer threads will wait for new work.</p><p>We could also have disabled the bounds checking for this example using <code class="literal">#cython:
boundscheck=False</code> but it doesn’t improve our run-time.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_numba">Numba</h2></div></div></div><p>Numba <sup>[<a id="id351851" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id351851" class="footnote">19</a>]</sup> from Continuum Analytics is a Just In
Time compiler that specializes <code class="literal">numpy</code> code via the LLVM compiler (<span class="emphasis"><em>not</em></span> via
<code class="literal">g++</code> as used by our other examples) at <span class="emphasis"><em>run time</em></span>. It doesn’t require a
pre-compilation pass so when you run it against new code it compiles each annotated function
for your hardware. The beauty is that you provide a
    decorator telling it which functions to focus on and then you let the JIT
    take over, it aims to run on all standard <code class="literal">numpy</code> code.</p><p>It is a younger project (I’m using v0.13) and the API can change a little with
each release, so consider it to be more useful in a research environment at
present. If you use <code class="literal">numpy</code> arrays and have non-vectorized code that iterates
over many items then Numba should give you a quick and very painless win.</p><p>One pain that is involved when using Numba is the tool-chain - it uses LLVM and
this has many dependencies. I recommend that you use Continuum’s Anaconda
distribution as everything is provided, getting Numba installed in a fresh
environment can otherwise be a very time-consuming task.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-numba1">Example&nbsp;7-14</a> shows the addition of the <code class="literal">@jit()</code> decorator to
the core Julia function. This is all that’s required, the fact that <code class="literal">numba</code> has
been imported means that the LLVM machinery kicks in at execution time to
compile this function behind the scenes.</p><p>If the <code class="literal">@jit()</code> decorator is removed then this is just the <code class="literal">numpy</code> version of
the Julia demo running with Python 2.7 and it takes 71 seconds. By adding the
<code class="literal">@jit()</code> decorator the execution time drops to 0.3 seconds. This is very close
to the result we achieved with Cython but without all of the annotation effort.</p><p>If I run the same function a second time in the same Python session then it runs even faster - there’s no need to compile the target function on the second pass if the argument types are the same so the overall execution speed is faster. On the second run the Numba result is equivalent to the Cython with <code class="literal">numpy</code> result we obtained before (so it came out as fast as Cython for very little work!). PyPy has the same warm-up requirement.</p><div class="example"><a id="augmentingwithtypes-numba1"></a><div class="example-title">Example&nbsp;7-14.&nbsp;Applying the jit decorator to a function</div><div class="example-contents"><pre class="screen">from numba import jit
...
@jit()
def calculate_z_serial_purepython(maxiter, zs, cs, output):</pre></div></div><p>When debugging with Numba it is useful to note that you can ask Numba to show
the type of the variable that it is dealing with inside a compiled function, in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-numba2">Example&nbsp;7-15</a> we can see that <code class="literal">zs</code> is recognised by the JIT as
a complex array.</p><div class="example"><a id="augmentingwithtypes-numba2"></a><div class="example-title">Example&nbsp;7-15.&nbsp;Debugging inferred types</div><div class="example-contents"><pre class="screen">print("zs has type:", numba.typeof(zs))
# array(complex128, 1d, C))</pre></div></div><p>Numba supports other forms of introspection such as <code class="literal">inspect_types</code> which lets you review the compiled code to see where type information has been inferred. If types have been missed then you can refine how the function is expressed to help Numba spot more type inference opportunities.</p><p>Numba’s premium version NumbaPro <sup>[<a id="id351999" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id351999" class="footnote">20</a>]</sup>
has experimental support of a <code class="literal">prange</code>
parallelization operator using OpenMP. Experimental GPU support is also available. This project aims to make it trivial to
convert slower looping Python code using <code class="literal">numpy</code> into very fast code that could
run on a CPU or a GPU, it is one to watch.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_pythran">Pythran</h2></div></div></div><p>Pythran <sup>[<a id="id352019" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352019" class="footnote">21</a>]</sup> is a Python to C++ compiler
for a subset of Python which includes partial <code class="literal">numpy</code> support. It acts a little
like Numba and Cython - you annotate a function’s arguments and then it takes
over with further type annotation and code specialization. It takes advantage of
vectorization possibilities and of OpenMP based parallelization possibilities.
It runs using Python 2.7 only.</p><p>One very interesting feature of Pythran is that it will attempt to automatically
spot parallelization opportunities, e.g. if you’re using a <code class="literal">map</code>, and to turn
this into parallel code without requiring extra effort from you. You can also
specify parallel sections using <code class="literal">pragma omp</code> directives, in this respect it
feels very similar to Cython’s OpenMP support.</p><p>Behind the scenes Pythran will take both normal Python and <code class="literal">numpy</code> code and
attempt to aggressively compile them into very fast C++ - even faster than the
results of Cython. You should note that this project is young and you may
encounter bugs, you should also note that the development team are very friendly
and tend to fix bugs in a matter of hours.</p><p>Remind yourself about the diffusion equation in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_naive">Example&nbsp;6-9</a>. I’ve extracted the calculation part of the
routine to a separate module so it can be compiled into a binary library. A nice
feature of Pythran is that we <span class="emphasis"><em>do not make Python-incompatible code</em></span>, think back
to Cython and how we had to create <code class="literal">.pyx</code> files with annotated Python that
couldn’t be run by Python directly. With Pythran we add 1 line comments that the
Pythran compiler can spot. This means that if we delete the generated <code class="literal">.so</code>
compiled module we can just run our code using Python alone - this is great for
debugging.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-pythran">Example&nbsp;7-16</a> you can see Micha’s heat equation example.
The <code class="literal">evolve</code> function has a 1 line comment (since it is a comment if you run
this without Pythran then Python will just ignore the comment), the comment
annotates the type information for the function. When Pythran runs it sees that
comment and propagates the type information (much as we saw with Shed Skin)
through each related function.</p><div class="example"><a id="augmentingwithtypes-pythran"></a><div class="example-title">Example&nbsp;7-16.&nbsp;Adding a 1 line comment to annotate the entry point to evolve()</div><div class="example-contents"><pre class="screen">import numpy as np
def laplacian(grid):
    return np.roll(grid, +1, 0) +
                   np.roll(grid, -1, 0) +
                   np.roll(grid, +1, 1) +
                   np.roll(grid, -1, 1) - 4 * grid

#pythran export evolve(float64[][], float)
def evolve(grid, dt, D=1):
    return grid + dt * D * laplacian(grid)</pre></div></div><p>We can compile this module using <code class="literal">pythran diffusion_numpy.py</code> and it will output
<code class="literal">diffusion_numpy.so</code>. From a test function we can import this new module and
call <code class="literal">evolve</code>. On my laptop <span class="emphasis"><em>without</em></span> Pythran this function executes on a
<code class="literal">(8192, 8192)</code> grid in 3.8 seconds. With Pythran this drops to 1.5 seconds. If
Pythran supports the functions that you need then it can offer some very
impressive performance gains for very little work.</p><p>The reason for the speed-up
is that Pythran has its own version of the <code class="literal">roll</code> function which has less
functionality - it therefore compiles to less complex code which might run faster. This also means it is less
flexible that the <code class="literal">numpy</code> version (Pythran’s authors note that it only
implements parts of <code class="literal">numpy</code>), but when it works it can outperform the results of the other tools we’ve seen.</p><p>By applying the same technique to the Julia expanded-math example, just by
adding the 1 line annotation to <code class="literal">calculate_z</code> the execution time drops to 0.29
seconds, this is a little slower than the Cython output. By adding a 1 line
OpenMP declaration in front of the outer loop the execution time drops to 0.1
seconds which is not far off of Cython’s best OpenMP output. The annotated code
can be seen in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-pythran2">Example&nbsp;7-17</a>.</p><div class="example"><a id="augmentingwithtypes-pythran2"></a><div class="example-title">Example&nbsp;7-17.&nbsp;Annotating calculate_z for Pythran with OpenMP support</div><div class="example-contents"><pre class="screen">#pythran export calculate_z(int, complex[], complex[], int[])
def calculate_z(maxiter, zs, cs, output):
    #omp parallel for schedule(guided)
    for i in range(len(zs)):</pre></div></div><p>The technologies so far all involve using a compiler in addition to the normal
CPython interpreter. Let’s now look at PyPy which provides an entirely new
interpreter.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="compiling-pypy">PyPy</h2></div></div></div><p>PyPy <sup>[<a id="id352187" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352187" class="footnote">22</a>]</sup> is an alternative implementation of the Python
language which includes a tracing Just In Time compiler, it is compatible with Python
2.7 and an experimental Python 3.2 version is available.</p><p>PyPy is a drop-in
replacement for CPython and offers all the built-in modules. The project
comprises the RPython Translation Toolchain which is used to build PyPy (and
could be used to build other interpreters). The Just In Time compiler in PyPy is
very effective and good speed-ups can occur for little or no work on your part. See
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-marko">PyPy for successful web and data processing systems</a> for a large PyPy deployment success story.</p><p>PyPy runs my pure-Python Julia demo without any modifications, with CPython it
takes 11 seconds and with PyPy it takes 0.3 seconds. This means that PyPy
achieves a result that’s very close to the Cython example in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#augmentingwithtypes-cython-expanding-abs">Example&nbsp;7-7</a> without <span class="emphasis"><em>any effort at all</em></span> -
that’s pretty impressive! As noted in the Numba section if the calculations are run again <span class="emphasis"><em>in the same session</em></span> then the second (and subsequent) runs are faster than the first as they are already compiled.</p><p>The fact that PyPy supports all the built-in modules is interesting - this means
that <code class="literal">multiprocessing</code> works as it does in CPython. If you have a problem that
runs with the batteries included modules and can run in parallel with
<code class="literal">multiprocessing</code> then expect that all the speed gains you might hope to get will be
available.</p><p>PyPy’s speed has evolved over time, the following chart in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#FIG-speed-pypy-org">Figure&nbsp;7-6</a> from <code class="literal">speed.pypy.org</code> will give you an idea about its maturity. These speed tests reflect a wide range of use cases, not just mathematical operations. It is clear that PyPy offers a faster experience than CPython.</p><div class="figure"><a id="FIG-speed-pypy-org"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 432; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/compiling_speed_pypy_org.png" alt="" width="1000" height="665" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/compiling_speed_pypy_org.png"></div></div><div class="figure-title">Figure&nbsp;7-6.&nbsp;Each new version of PyPy offers speed improvements</div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_garbage_collection_differences">Garbage Collection differences</h3></div></div></div><p>PyPy uses a different type of garbage collector to CPython and this can cause some non-obvious behavior changes to your code. CPython uses Reference Counting, PyPy using a modified Mark and Sweep approach, the Mark and Sweep approach may clean up an unused object much later. Both are correct implementations of the Python specification, you just have to be aware that some code modifications might be required.</p><p>Some coding approaches seen in CPython depend on the behavior of the Reference Counter - particularly the flushing of files if they’re opened and written to without an explicit file close. With PyPy the same code will run but the updates to the file might get flushed to disk later when the garbage collector next runs. An alternative form that works in both PyPy and Python is to use a context manager using <code class="literal">with</code> to open and automatically close files. The CPython Differences <sup>[<a id="id352373" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352373" class="footnote">23</a>]</sup> pages lists the details and implementation details for the Garbage Collector <sup>[<a id="id352311" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352311" class="footnote">24</a>]</sup> are also available.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_running_pypy_and_installing_modules">Running PyPy and installing modules</h3></div></div></div><p>If you’ve never run an alternative Python interpreter you might benefit from a
short example. I’ll assume you’ve downloaded and extracted PyPy, you’ll now have
a folder structure containing a <code class="literal">bin</code> directory. Run it as shown in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-pypy-run">Example&nbsp;7-18</a> to start PyPy:</p><div class="example"><a id="compiling-pypy-run"></a><div class="example-title">Example&nbsp;7-18.&nbsp;Running PyPy to see that it implements Python 2.7.3</div><div class="example-contents"><pre class="screen">$ ./bin/pypy
Python 2.7.3 (84efb3ba05f1, Feb 18 2014, 23:00:21)
[PyPy 2.3.0-alpha0 with GCC 4.6.3] on linux2
Type "help", "copyright", "credits" or "license" for more information.
And now for something completely different: ``&lt;arigato&gt; (not thread-safe, but
well, nothing is)''</pre></div></div><p>Note that PyPy 2.3 runs as Python 2.7.3 (build number 84efb3ba05f1), I’m using a
nightly build. Now we need to setup <code class="literal">pip</code> and we’ll want to install <code class="literal">ipython</code>
(note that IPython starts with the same Python 2.7.3 build as we’ve just seen). The steps shown in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling-pypy-pip">Example&nbsp;7-19</a> are the same as you might have performed with CPython if you’ve installed <code class="literal">pip</code> without the help
of an existing distribution or package manager.</p><div class="example"><a id="compiling-pypy-pip"></a><div class="example-title">Example&nbsp;7-19.&nbsp;Installing pip for PyPy to install third party modules like IPython</div><div class="example-contents"><pre class="screen">$ mkdir sources  # make a local download directory
$ cd sources
# fetch distribute and pip
$ curl -O http://python-distribute.org/distribute_setup.py
$ curl -O https://raw.github.com/pypa/pip/master/contrib/get-pip.py
# now run the setup files for these using pypy
$ ../bin/pypy ./distribute_setup.py
...
$ ../bin/pypy get-pip.py
...
$ ../bin/pip install ipython
...
$ ../bin/ipython
Python 2.7.3 (84efb3ba05f1, Feb 18 2014, 23:00:21)
Type "copyright", "credits" or "license" for more information.

IPython 2.0.0 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython's features.
%quickref -&gt; Quick reference.
help      -&gt; Python's own help system.
object?   -&gt; Details about 'object', use 'object??' for extra details.</pre></div></div><p>Note that PyPy does <span class="emphasis"><em>not</em></span> support projects like <code class="literal">numpy</code> in a usable way (there
is a bridge layer via <code class="literal">cpyext</code>
<sup>[<a id="id352430" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352430" class="footnote">25</a>]</sup> but it is too
slow to be useful with <code class="literal">numpy</code>), so don’t go looking for strong <code class="literal">numpy</code> support
with PyPy. PyPy does have an experimental port of <code class="literal">numpy</code> known as “numpypy”
(I’ve noted some installation instructions
<sup>[<a id="id352450" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352450" class="footnote">26</a>]</sup>)
but it doesn’t offer any useful speed advantages at present (during 2014
this may change
<sup>[<a id="id352476" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352476" class="footnote">27</a>]</sup>).</p><p>If you need other packages then anything that is pure-Python will <span class="emphasis"><em>probably</em></span>
install, anything that relies on C extension libraries <span class="emphasis"><em>probably</em></span> won’t work in
a useful way. PyPy doesn’t have a reference counting garbage collector and
anything that is compiled for CPython will use library calls that support
CPython’s garbage collector. PyPy has a workaround but it adds a lot of
overhead, in practice it isn’t useful to try to force older extension libraries
to work with PyPy directly. The PyPy advice is to try to remove any C extension
code if possible (it might just be there to make the Python code go fast - and
that’s now PyPy’s job). The PyPy wiki maintains a list of compatible modules
<sup>[<a id="id352470" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352470" class="footnote">28</a>]</sup>.</p><p>Another downside of PyPy is that it can use a lot of RAM - each release is
better in this repsect but in practice it may use more RAM than CPython. RAM is
fairly cheap - it makes sense to try to trade it for enhanced performance. Some
users have also reported <span class="emphasis"><em>lower</em></span> RAM usage when using PyPy. As ever - perform an
experiment using representative data if this is important to you.</p><p>PyPy is bound by the Global Interpreter Lock but the team are working on a
project called Software Transactional Memory
<sup>[<a id="id352506" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352506" class="footnote">29</a>]</sup> to attempt
to remove the need for the GIL. STM is a little like database transactions, it
is a concurrency control mechanism that applies to memory access - it can roll
back changes if conflicting operations occur to the same memory space. The goal
of STM integration is to enable highly concurrent systems to have a form on
concurrency control, losing some efficiency on operations but gaining programmer
productivity by not forcing the user to handle all aspects of concurrent access
control.</p><p>For profiling the recommended tools are <code class="literal">jitviewer</code>
<sup>[<a id="id352520" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352520" class="footnote">30</a>]</sup> and <code class="literal">logparser</code>
<sup>[<a id="id352492" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id352492" class="footnote">31</a>]</sup>.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_when_to_use_each_technology">When to use each technology</h2></div></div></div><p>If you’re working on a numeric project then each of these technologies
could be useful to you. The table in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#table_compiler_summary">Table&nbsp;7-1</a> summarises the main options.</p><div class="table"><a id="table_compiler_summary"></a><div class="table-title">Table&nbsp;7-1.&nbsp;Summary of Compiler and JIT options</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">                          </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Cython</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">PyPy</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Numba</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Shed Skin</td><td style="border-bottom: 0.5pt solid ; ">Pythran</td></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Mature</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Widespread</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>numpy support</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p>Y</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Non-breaking code changes</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-bottom: 0.5pt solid ; "><p>Y</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Needs C knowledge</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p></p></td><td style="border-bottom: 0.5pt solid ; "><p></p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p>Supports OpenMP</p></td><td style="border-right: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; "><p>Y</p></td><td style="border-right: 0.5pt solid ; "><p></p></td><td><p>Y</p></td></tr></tbody></table></div></div><p>Pythran probably offers the best gains on <code class="literal">numpy</code> problems for the least effort if your problem fits into the restricted scope of the supported functions. It also offers some easy OpenMP parallelization options. It is a relatively young project.</p><p>Numba may offer quick wins for little effort but it too has limitations that might stop it working well on your code. It is a relatively young project.</p><p>Cython probably offers the best results for the widest set of problems but it does require more effort and has
an additional “support tax” due to its use of the mix of Python with C annotations.</p><p>PyPy is a strong option if you’re not using <code class="literal">numpy</code> or other hard-to-port C extensions.</p><p>Shed Skin may be useful if you want to compile to C and you’re not using <code class="literal">numpy</code> or other external libraries.</p><p>If you’re deploying a production tool then you probably want to stick with well understood tools - Cython should be your main choice, you may want to see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-radim">Making deep learning fly with RadimRehurek.com</a>. PyPy is also being used in production settings, see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-marko">PyPy for successful web and data processing systems</a>.</p><p>If you’re working with light numeric requirements then note that Cython’s buffer
interface accepts <code class="literal">array.array</code> matrices - this is an easy way to pass a block
of data to Cython for fast numeric processing without having to add <code class="literal">numpy</code> as a
project dependency.</p><p>Overall Pythran and Numba are young but very promising projects, Cython is very
mature. PyPy is regarded as being fairly mature now and should definitely be
evaluated for long running processes.</p><p>In a class run by Ian in 2014 a capable student implemented a C version of the Julia algorithm and was disappointed to see it execute more slowly than their Cython version. It transpired that they were using 32 bit floats on a 64 bit machine, these run more slowly than 64 bit doubles on a 64 bit machine. The student, despite being a good C programmer, didn’t know that this could involve a speed cost. The student changed their code and the C version, despite being significantly shorter than the auto-generated Cython version, ran at roughly the same speed. The act of writing the raw C version, comparing its speed and figuring out how to fix it took longer than using Cython in the first place.</p><p>This is just an anecdote, I’m not suggesting that Cython will generate the best code and a competent C programmer can probably figure out how to make their code run faster than the version generated by Cython. It is worth noting that the assumption that hand-written C will be faster than converted Python is not a safe assumption. You must always benchmark and make decisions using evidence. C compilers are pretty good at converting code into fairly efficient machine code and Python is pretty good at letting you express your problem in an easy to understand language - combine these two powers sensibly.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_other_upcoming_projects">Other upcoming projects</h3></div></div></div><p>The PyData compilers <sup>[<a id="id354259" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354259" class="footnote">32</a>]</sup> page lists a set of
high performance and compiler tools. Theano
<sup>[<a id="id354270" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354270" class="footnote">33</a>]</sup> is a higher level language
allowing the expression of mathematical operators on multi-dimensional arrays,
it has tight integration with <code class="literal">numpy</code> and can export compiled code for CPUs and
GPUs. Interestingly it has found favour with the deep-learning AI community.
Parakeet <sup>[<a id="id354351" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354351" class="footnote">34</a>]</sup> focuses on compiling
operations involving dense <code class="literal">numpy</code> arrays using a subset of Python, it too
supports GPUs.</p><p>PyViennaCL <sup>[<a id="id354325" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354325" class="footnote">35</a>]</sup> is a
Python binding to the ViennaCL numerical computation and linear algebra library,
it supports GPUs and CPUs using <code class="literal">numpy</code>. ViennaCL is written in C++ and
generates code for CUDA, OpenCL and OpenMP. It supports dense and sparse linear
algebra operations, BLAS and solvers.</p><p>Nuitka <sup>[<a id="id354292" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354292" class="footnote">36</a>]</sup> is a Python compiler
that aims to be an alternative to the usual CPython interpreter with the option
of creating compiled executables. It supports all of Python 2.7 though in my
testing didn’t produce any noticeable speed gains for my plain Python numerical
tests.</p><p>Pyston <sup>[<a id="id354368" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354368" class="footnote">37</a>]</sup> is the latest entrant to the
field, it uses the LLVM compiler and is being supported by Dropbox. It may
suffer from the same issue that PyPy faces with a lack of support for extension
modules but there are project plans to try to address this. Without addressing
this issue it is unlikely that <code class="literal">numpy</code> support would be practical.</p><p>In our community we’re rather blessed with a wide array of compilation options.
Whilst they all have trade-offs they also offer a lot of power so that complex
projects can take advantage of the full power of CPUs and multi-core
architectures.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_a_note_on_graphics_processing_units_gpus">A note on Graphics Processing Units (GPUs)</h3></div></div></div><p>GPUs are a sexy technology at the moment and we’re choosing to delay covering them until at least the next edition. The field is rapidly changing, it is quite likely that anything we say now will have changed by the time you read it. Critically it isn’t just that the lines of code you write might have to change but you might have to substantially change how you go about solving your problem as architectures evolve.</p><p>Ian worked on a physics problem using the NVIDIA GTX 480 GPU for a year using Python and PyCUDA. By the end of a year the full power of the GPU was harnessed and the system ran fully 25* faster than the same function on a quad-core machine. The quad-core variant was written in C with a parallel library, the GPU variant was mostly expressed in CUDA’s C wrapped in pyCUDA for data handling. Shortly after this the GTX 5xx series of GPUs were launched and many of the optimizations that applied to the 4xx series changed. Roughly a year’s worth of work ultimately was abandoned in favor of an easier to maintain C solution running on CPUs.</p><p>This is an isolated example but it highlights the danger of writing low-level CUDA (or OpenCL) code. Libraries that sit on top of GPUs and offer a higher-level functionality are far more likely to be generally usable (e.g. libraries that offer image analysis or video transcoding interfaces) and we’d urge you to consider these rather than looking at coding for GPUs directly.</p><p>Projects that aim to manage GPUs for you include Numba, Parakeet and Theano.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_a_wish_for_a_future_compiler_project">A wish for a future compiler project</h3></div></div></div><p>Amongst the current compiler options we have some strong technology components.
Personally I’d like to see Shed Skin’s annotation engine become generalized so
that it could work with other tools - for example making an output that’s Cython
compatible to smooth the learning curve to starting with Cython
(particularly when using <code class="literal">numpy</code>). Cython is mature and integrates tightly into
Python and <code class="literal">numpy</code> and more people would use it if the learning curve and
support requirement wasn’t quite so tricky.</p><p>A longer-term wish would be to see some sort of Numba and PyPy-like solution which offers JIT behavior on both regular Python code and <code class="literal">numpy</code> code. No one solution offers this at present, a tool that solves this problem would be a strong contender to replace the regular CPython interpreter that we all currently use, without requiring the developer to modify their code.</p><p>Friendly competition and a large marketplace for new ideas make our ecosystem a
rich place indeed.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_foreign_function_interfaces">Foreign function interfaces</h2></div></div></div><p>Sometimes the automatic solutions just don’t cut it and you need to write some
custom C or FORTRAN code yourself.  This could be because the compilation
methods don’t find some potential optimizations or because you can take
advantage of libraries or language features that aren’t availible in python.  In
all of these cases, you’ll need to use foreign function interfaces which give
you access to code writen and compiled in another language.</p><p>For the rest of this chapter, we will attempt to use an external library to
solve the 2D diffusion equation in the same way we did in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a> <sup>[<a id="id354465" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id354465" epub:type="noteref" class="footnote">38</a>]</sup>.  The code for this library, <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#c_diffusion_2d">Example&nbsp;7-20</a>, could be
representative of a library you installed, or some code that you have written.
In this way, these methods serve as great ways to take small parts of your code
and move them to another language in order to do very targeted language-based
optimizations.</p><div class="example"><a id="c_diffusion_2d"></a><div class="example-title">Example&nbsp;7-20.&nbsp;Sample C code for solving the 2D diffusion problem</div><div class="example-contents"><pre class="programlisting"><code class="kt">void</code> <code class="nf">evolve</code><code class="p">(</code><code class="kt">double</code> <code class="n">in</code><code class="p">[][</code><code class="mi">512</code><code class="p">],</code> <code class="kt">double</code> <code class="n">out</code><code class="p">[][</code><code class="mi">512</code><code class="p">],</code> <code class="kt">double</code> <code class="n">D</code><code class="p">,</code> <code class="kt">double</code> <code class="n">dt</code><code class="p">)</code> <code class="p">{</code>
    <code class="kt">int</code> <code class="n">i</code><code class="p">,</code> <code class="n">j</code><code class="p">;</code>
    <code class="kt">double</code> <code class="n">laplacian</code><code class="p">;</code>
    <code class="k">for</code> <code class="p">(</code><code class="n">i</code><code class="o">=</code><code class="mi">1</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">511</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">for</code> <code class="p">(</code><code class="n">j</code><code class="o">=</code><code class="mi">1</code><code class="p">;</code> <code class="n">j</code><code class="o">&lt;</code><code class="mi">511</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
            <code class="n">laplacian</code> <code class="o">=</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="o">+</code><code class="mi">1</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="o">-</code><code class="mi">1</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="o">+</code><code class="mi">1</code><code class="p">]</code> <code class="o">+</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code> <code class="o">-</code> <code class="mi">4</code> <code class="o">*</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">];</code>
            <code class="n">out</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">=</code> <code class="n">in</code><code class="p">[</code><code class="n">i</code><code class="p">][</code><code class="n">j</code><code class="p">]</code> <code class="o">+</code> <code class="n">D</code> <code class="o">*</code> <code class="n">dt</code> <code class="o">*</code> <code class="n">laplacian</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div></div><p>In order to use the above code, we must compile it into a shared module which
creates a <code class="literal">.so</code> file.  This can be done using <code class="literal">gcc</code> (or any other C compiler) by
following the steps below.  We can place this final shared library file anywhere
that is accessible to our python code, however standard *NIX orginazion stores
shared libraries in <code class="literal">/usr/lib</code> and <code class="literal">/usr/local/lib</code>.</p><pre class="programlisting"><code class="nv">$ </code>gcc -O3 -std<code class="o">=</code>gnu99 -c diffusion.c
<code class="nv">$ </code>gcc -shared -o diffusion.so diffusion.o</pre><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_ctypes">ctypes</h3></div></div></div><p>The most basic foreign function interface in cpython <sup>[<a id="id355197" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id355197" epub:type="noteref" class="footnote">39</a>]</sup> is through the <code class="literal">ctypes</code> module.  The simplicity
of this module can be quite inhibitive at times—you are in charge of doing
everything and it can take quite a while to make sure that you have everything in
order.</p><div class="example"><a id="id355230"></a><div class="example-title">Example&nbsp;7-21.&nbsp;ctypes 2D Diffusion code</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">ctypes</code>

<code class="n">grid_shape</code> <code class="o">=</code> <code class="p">(</code><code class="mi">512</code><code class="p">,</code> <code class="mi">512</code><code class="p">)</code>
<code class="n">_diffusion</code> <code class="o">=</code> <code class="n">ctypes</code><code class="o">.</code><code class="n">CDLL</code><code class="p">(</code><code class="s">"../diffusion.so"</code><code class="p">)</code> <code class="c"># </code><a id="CO11-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">

<code class="c"># Create references to the C types that we will need to simplify future code</code>
<code class="n">TYPE_INT</code> <code class="o">=</code> <code class="n">ctypes</code><code class="o">.</code><code class="n">c_int</code>
<code class="n">TYPE_DOUBLE</code> <code class="o">=</code> <code class="n">ctypes</code><code class="o">.</code><code class="n">c_double</code>
<code class="n">TYPE_DOUBLE_SS</code> <code class="o">=</code> <code class="n">ctypes</code><code class="o">.</code><code class="n">POINTER</code><code class="p">(</code><code class="n">ctypes</code><code class="o">.</code><code class="n">POINTER</code><code class="p">(</code><code class="n">ctypes</code><code class="o">.</code><code class="n">c_double</code><code class="p">))</code>

<code class="c"># Initialize the signature of the evolve function to:</code>
<code class="c"># void evolve(int, int, double**, double**, double, double)</code>
<code class="n">_diffusion</code><code class="o">.</code><code class="n">evolve</code><code class="o">.</code><code class="n">argtypes</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">TYPE_INT</code><code class="p">,</code>
    <code class="n">TYPE_INT</code><code class="p">,</code>
    <code class="n">TYPE_DOUBLE_SS</code><code class="p">,</code>
    <code class="n">TYPE_DOUBLE_SS</code><code class="p">,</code>
    <code class="n">TYPE_DOUBLE</code><code class="p">,</code>
    <code class="n">TYPE_DOUBLE</code><code class="p">,</code>
<code class="p">]</code>
<code class="n">_diffusion</code><code class="o">.</code><code class="n">evolve</code><code class="o">.</code><code class="n">restype</code> <code class="o">=</code> <code class="bp">None</code>

<code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">out</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mf">1.0</code><code class="p">):</code>
    <code class="c"># First we convert the python types into the relevant C types</code>
    <code class="n">cX</code> <code class="o">=</code> <code class="n">TYPE_INT</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code>
    <code class="n">cY</code> <code class="o">=</code> <code class="n">TYPE_INT</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>
    <code class="n">cdt</code> <code class="o">=</code> <code class="n">TYPE_DOUBLE</code><code class="p">(</code><code class="n">dt</code><code class="p">)</code>
    <code class="n">cD</code> <code class="o">=</code> <code class="n">TYPE_DOUBLE</code><code class="p">(</code><code class="n">D</code><code class="p">)</code>
    <code class="n">pointer_grid</code> <code class="o">=</code> <code class="n">grid</code><code class="o">.</code><code class="n">ctypes</code><code class="o">.</code><code class="n">data_as</code><code class="p">(</code><code class="n">TYPE_DOUBLE_SS</code><code class="p">)</code> <code class="c"># </code><a id="CO11-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">pointer_out</code> <code class="o">=</code> <code class="n">out</code><code class="o">.</code><code class="n">ctypes</code><code class="o">.</code><code class="n">data_as</code><code class="p">(</code><code class="n">TYPE_DOUBLE_SS</code><code class="p">)</code>

    <code class="c"># Now we can call the function</code>
    <code class="n">_diffusion</code><code class="o">.</code><code class="n">evolve</code><code class="p">(</code><code class="n">cX</code><code class="p">,</code> <code class="n">cY</code><code class="p">,</code> <code class="n">pointer_grid</code><code class="p">,</code> <code class="n">pointer_out</code><code class="p">,</code> <code class="n">cD</code><code class="p">,</code> <code class="n">cdt</code><code class="p">)</code> <code class="c"># </code><a id="CO11-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO11-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
This is similar to importing the <code class="literal">diffusion.so</code> library
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO11-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
<code class="literal">grid</code> and <code class="literal">out</code> are both numpy arrays
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO11-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
We finally have all the setup necessary and can call the C function directly
</p></dd></dl></div></div></div><p>This first thing that we do is “import” our shared library.  This is done with
the <code class="literal">ctypes.CDLL</code> call.  In this line we can specify any shared library that
python can access (for example, the <code class="literal">ctypes-opencv</code> module loads the <code class="literal">libcv.so</code>
library).  From this, we get a <code class="literal">_diffusion</code> object that contains all the members
that the shared library contains.  In this example, <code class="literal">diffusion.so</code> only contains
one function, <code class="literal">evolve</code>, which is not a property of the object.  If
<code class="literal">diffusion.so</code> had many functions and properties, we could access them all
through the <code class="literal">_diffusion</code> object.</p><p>However, even thought the <code class="literal">_diffusion</code> object has the evolve function available
within it, it doesn’t know how to use it.  C is statically typed and the
function has a very specific signature.  In order to properly work with the
<code class="literal">evolve</code> function, we must explicitly set the input argument types and the
return type.  This can become quite tedious when developing libraries in tandem
with the python interface, or when dealing with a quickly changing library.
Furthermore, since <code class="literal">ctypes</code> can’t check if you have given it the correct types,
if you make a mistake then your code may silently fail or segfault!</p><p>Furthermore, in addition to setting the arguments and return type of the
function object, we also need to convert any data we care to use with it (which
is called “casting”).  Every argument we send to the function must be carefully
casted into a native C type.  Sometimes this can get quite tricky since
python is very relaxed about it’s variable types.  For example, if I had <code class="literal">num1 =
1e5</code> I would have to know that this is a python <code class="literal">float</code> and thus I should use a
<code class="literal">ctype.c_float</code>.  On the other hand, for <code class="literal">num2 = 1e300</code> I would have to use
<code class="literal">ctype.c_double</code> because it would overflow a standard C <code class="literal">float</code>.</p><p>That being said, <code class="literal">numpy</code> provides a <code class="literal">.ctypes</code> property to it’s arrays which
makes it easily compatible with <code class="literal">ctypes</code>.  If <code class="literal">numpy</code> wouldn’t provide this
functionality, we would have had to initialize a ctypes array of the correct
time and then find the location of our original data and have our new ctypes
object point there.</p><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>Unless the object you are turning into a <code class="literal">ctype</code> object implements a buffer
(such as the <code class="literal">array</code> module, <code class="literal">numpy</code> arrays, <code class="literal">cStringIO</code>, etc), your data will
be copied into the new object.  In the case of casting an <code class="literal">int</code> of <code class="literal">float</code>, this
doesn’t mean much for the performance of your code.  However, if you are casting
a very long python list, this can incur quite a penalty!  These are cases where
using the <code class="literal">array</code> module, a <code class="literal">numpy</code> array or even building up your own buffered
object using the <code class="literal">struct</code> module would help!  This does, however, hurt
readability of your code since these objects are generally less flexible than
their native python counterparts.</p></div><p>This can get even more complicated if you have to send the library a complicated
data structure.  For example, if your library expect a C stype structure
representing a point in space with the properties <code class="literal">x</code> and <code class="literal">y</code>, you would have to
define,</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">ctypes</code> <code class="kn">import</code> <code class="n">Structure</code>
<code class="k">class</code> <code class="nc">cPoint</code><code class="p">(</code><code class="n">Structure</code><code class="p">):</code>
    <code class="n">_fields_</code> <code class="o">=</code> <code class="p">(</code><code class="s">"x"</code><code class="p">,</code> <code class="n">c_int</code><code class="p">),</code> <code class="p">(</code><code class="s">"y"</code><code class="p">,</code> <code class="n">c_int</code><code class="p">)</code></pre><p>At which point you could start creating C-compatible object by initializing a
cPoint object (ie: <code class="literal">point = cPoint(10, 5)</code>).  This isn’t a terrible amount of
work but it can become tedious and results in some fragile code.  What happens
if a new version of the library is released that slightly changes the structure?
This will make your quite very hard to maintain and generally results in very
stagnant code where the developers simply decide never to upgrade the underlying
libraries that are being used.</p><p>For these reason, using the <code class="literal">ctypes</code> module is great if you already have a good
understanding of C and want to be able to tune every aspect of the interface.
It has great portability since it is part of the standard library and if your
task is simple then it provides simple solutions.  Just be careful since the
complexity of ctype-like solutions quickly becomes unmanageable.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_cffi">CFFI</h3></div></div></div><p>Realizing that <code class="literal">ctypes</code> can be quite cumbersome to use at times, <code class="literal">cffi</code> attempts
to simplify many of the standard operations that programmers use.  It does this
by having an internal C parser which can understand function and structure
definitions.</p><p>As a result, we can simply write the C code which defines the structure of the
library we wish to use, and then <code class="literal">cffi</code> will do all the heavy work for us:
import in the module and make sure we specify the correct types to the resulting
functions.  In fact, this work can be almost trivial if the source for the
library is available since the header files (the files ending in <code class="literal">.h</code>) will
include all the relevant definitions we need.</p><div class="example"><a id="id633217"></a><div class="example-title">Example&nbsp;7-22.&nbsp;cffi 2D Diffusion code</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">cffi</code> <code class="kn">import</code> <code class="n">FFI</code>

<code class="n">ffi</code> <code class="o">=</code> <code class="n">FFI</code><code class="p">()</code>
<code class="n">ffi</code><code class="o">.</code><code class="n">cdef</code><code class="p">(</code><code class="s">r''' void evolve(int Nx, int Ny, double **in, double **out, double D, double dt); '''</code><code class="p">)</code> <code class="c">#</code><a id="CO12-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
<code class="n">lib</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">dlopen</code><code class="p">(</code><code class="s">"../diffusion.so"</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">dt</code><code class="p">,</code> <code class="n">out</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mf">1.0</code><code class="p">):</code>
    <code class="n">X</code><code class="p">,</code> <code class="n">Y</code> <code class="o">=</code> <code class="n">grid_shape</code>
    <code class="n">pointer_grid</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="s">'double**'</code><code class="p">,</code> <code class="n">grid</code><code class="o">.</code><code class="n">ctypes</code><code class="o">.</code><code class="n">data</code><code class="p">)</code> <code class="c">#</code><a id="CO12-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">pointer_out</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="s">'double**'</code><code class="p">,</code> <code class="n">out</code><code class="o">.</code><code class="n">ctypes</code><code class="o">.</code><code class="n">data</code><code class="p">)</code>
    <code class="n">lib</code><code class="o">.</code><code class="n">evolve</code><code class="p">(</code><code class="n">X</code><code class="p">,</code> <code class="n">Y</code><code class="p">,</code> <code class="n">pointer_grid</code><code class="p">,</code> <code class="n">pointer_out</code><code class="p">,</code> <code class="n">D</code><code class="p">,</code> <code class="n">dt</code><code class="p">)</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO12-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
The contents of this definition can normally be acquired from the manual of the library that you are using or by looking at the libraries header files.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO12-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
While we still need to cast non-native python objects for use with our C module, the syntax is very familiar to those with experience in C
</p></dd></dl></div></div></div><p>In the above code we can think of the <code class="literal">cffi</code> initialization as being two
stepped.  First, we create a <code class="literal">FFI</code> object and give it all the global C
declarations we need.  This can include data types in addition to function
signatures.  Then, we can import a shared library using <code class="literal">dlopen</code> into it’s own
name space that is a child name space of <code class="literal">FFI</code>.  As a result, we could have
loaded up two libraries with the same <code class="literal">evolve</code> function into variables <code class="literal">lib1</code>
and <code class="literal">lib2</code> and use them independently (which is fantastic for debugging and
profiling!).</p><p>In addition to simply importing a shared C library, <code class="literal">cffi</code> allows you to simply
write C code and have it be just-in-time compiled using the <code class="literal">verify</code> function.
This has many immediate benefits—you can easily re-write small portions of
your code to be in C without invoking the large machinery of a separate C
library.  Alternatively, if there is a library you wish to use, however it
requires some glue code in C to have the interface work perfectly, you can
simply in line it into your <code class="literal">cffi</code> code to have everything be in a centralized
location.  In addition, since the code is being just-in-time compiled, you can
specify specific compile instructions to every chunk of code you need to
compile.  Note however that this compilation has a one-time penalty every time
the <code class="literal">verify</code> function is run to actually perform the compilation.</p><div class="example"><a id="id647926"></a><div class="example-title">Example&nbsp;7-23.&nbsp;cffi with inline 2D Diffusion code</div><div class="example-contents"><pre class="programlisting"><code class="n">ffi</code> <code class="o">=</code> <code class="n">FFI</code><code class="p">()</code>
<code class="n">ffi</code><code class="o">.</code><code class="n">cdef</code><code class="p">(</code><code class="s">r'''void evolve(int Nx, int Ny, double **in, double **out, double D, double dt);'''</code><code class="p">)</code>
<code class="n">lib</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">verify</code><code class="p">(</code><code class="s">r'''</code>
<code class="s">void evolve(int Nx, int Ny, double in[][Ny], double out[][Ny], double D, double dt) {</code>
<code class="s">    int i, j;</code>
<code class="s">    double laplacian;</code>
<code class="s">    for (i=1; i&lt;Nx-1; i++) {</code>
<code class="s">        for (j=1; j&lt;Ny-1; j++) {</code>
<code class="s">            laplacian = in[i+1][j] + in[i-1][j] + in[i][j+1] + in[i][j-1] - 4 * in[i][j];</code>
<code class="s">            out[i][j] = in[i][j] + D * dt * laplacian;</code>
<code class="s">        }</code>
<code class="s">    }</code>
<code class="s">}</code>
<code class="s">'''</code><code class="p">,</code> <code class="n">extra_compile_args</code><code class="o">=</code><code class="p">[</code><code class="s">"-O3"</code><code class="p">,])</code> <code class="c"># </code><a id="CO13-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO13-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Since we are just-in-time compiling this code, we can also provide relevant compilation flags
</p></dd></dl></div></div></div><p>Another benefit of the <code class="literal">verify</code> functionality is how it plays very nicely with
complicated <code class="literal">cdef</code> statements.  For example, if we were using a library with a
very complicated structure, but only wanted to use a part of it we could use
the partial struct definition.  This happens when you add a <code class="literal">...</code> in the struct
definition in <code class="literal">ffi.cdef</code> and the <code class="literal">#include</code> the relevant header file in a later
<code class="literal">verify</code>.</p><p>For example, if we were working with a library with header <code class="literal">complicated.h</code> which
included a structure that looked like,</p><pre class="programlisting"><code class="k">struct</code> <code class="n">Point</code> <code class="p">{</code>
    <code class="kt">double</code> <code class="n">x</code><code class="p">;</code>
    <code class="kt">double</code> <code class="n">y</code><code class="p">;</code>
    <code class="kt">bool</code> <code class="n">isActive</code><code class="p">;</code>
    <code class="kt">char</code> <code class="o">*</code><code class="n">id</code><code class="p">;</code>
    <code class="kt">int</code> <code class="n">num_times_visited</code><code class="p">;</code>
<code class="p">}</code></pre><p>If we only cared about the <code class="literal">x</code> and <code class="literal">y</code> properties, we could write some simple
<code class="literal">cffi</code> code that only ares about those values,</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">cffi</code> <code class="kn">import</code> <code class="n">FFI</code>

<code class="n">ffi</code> <code class="o">=</code> <code class="n">FFI</code><code class="p">()</code>
<code class="n">ffi</code><code class="o">.</code><code class="n">cdef</code><code class="p">(</code><code class="s">r"""</code>
<code class="s">    struct Point {</code>
<code class="s">        double x;</code>
<code class="s">        double y;</code>
<code class="s">        ...;</code>
<code class="s">    };</code>
<code class="s">    struct Point do_calculation();</code>
<code class="s">"""</code><code class="p">)</code>
<code class="n">lib</code> <code class="o">=</code> <code class="n">ffi</code><code class="o">.</code><code class="n">verify</code><code class="p">(</code><code class="s">r"""</code>
<code class="s">    #include &lt;complicated.h&gt;</code>
<code class="s">"""</code><code class="p">)</code></pre><p>We can now run the <code class="literal">do_calculation</code> function from the <code class="literal">complicated.h</code> library
and get returned to us a <code class="literal">Point</code> object with it’s <code class="literal">x</code> and <code class="literal">y</code> properties
accessible.  This is amazing for portability since this code will run just fine
on systems with a different implementation of <code class="literal">Point</code> or when new versions of
<code class="literal">complicated.h</code> comes out, as long as they all have the <code class="literal">x</code> and <code class="literal">y</code> properties.</p><p>All of these niceties really make <code class="literal">cffi</code> an amazing tool to have when working
with C code in python.  It is much simpler than <code class="literal">ctypes</code> while still giving you
the same amount of fine grained control you may want when working directly with
a foreign function interface.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_f2py">f2py</h3></div></div></div><p>For many scientific applications, Fortran is still the golden standard. While
it’s days of being a general purpose language are over it still has many
niceties which make vector operations easy to write and quite quick!  In
addition, there are many performance math libraries written in Fortran ( LAPACK
<sup>[<a id="id648494" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id648494" class="footnote">40</a>]</sup>, BLAS
<sup>[<a id="id648537" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id648537" class="footnote">41</a>]</sup>, etc.) and being able to still use them
in your performance python code may be critical.</p><p>For such situations, <code class="literal">f2py</code> <sup>[<a id="id648511" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id648511" class="footnote">42</a>]</sup>
provides a dead simple way of importing Fortran code into python.  This module
is able to be so simple because of the explicitness of types in Fortran.  Since
the types can be easily parsed and understood, <code class="literal">f2py</code> can easily make a CPython
module that uses the native foreign function support within C to use the Fortran
code.  This means that when you are using <code class="literal">f2py</code>, you are actually
auto-generating a C module which knows how to use the Fortran code!  As a
result, a lot of the confusion which is inherent in the <code class="literal">ctypes</code> and <code class="literal">cffi</code>
solutions simply don’t exist.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#f2py_diffusion">Example&nbsp;7-24</a> we can see some simple <code class="literal">f2py</code> compatible code for solving
the diffusion equation.  In fact, all native Fortran code is <code class="literal">f2py</code> compatible,
however the annotations to the function arguments (the statements prefaced by
<code class="literal">!f2py</code>) simplify the resulting python module and make for a more easy to use
interface.  The annotations implicitly tell <code class="literal">f2py</code> whether we intend for an argument
to be only an output, only an input, to be something we want to modify inplace
or hidden completely.  The hidden type is particularly useful for the sizes of
vectors: while Fortran may need those numbers explicitly, our python code
already has this information on hand.  When we set the type as “hidden”, <code class="literal">f2py</code>
can automatically fill those values for us, essentially keeping them hidden from
us in the final python interface.</p><div class="example"><a id="f2py_diffusion"></a><div class="example-title">Example&nbsp;7-24.&nbsp;Fortran 2D Diffusion code with <code class="literal">f2py</code> annotations</div><div class="example-contents"><pre class="programlisting"><code class="k">SUBROUTINE </code><code class="nv">evolve</code><code class="p">(</code><code class="nv">grid</code><code class="p">,</code> <code class="nv">scratch</code><code class="p">,</code> <code class="nv">D</code><code class="p">,</code> <code class="nv">dt</code><code class="p">,</code> <code class="nv">N</code><code class="p">,</code> <code class="nv">M</code><code class="p">)</code>
    <code class="c">!f2py threadsafe</code>
    <code class="c">!f2py intent(in) grid</code>
    <code class="c">!f2py intent(inplace) scratch</code>
    <code class="c">!f2py intent(in) D</code>
    <code class="c">!f2py intent(in) dt</code>
    <code class="c">!f2py intent(hide) N</code>
    <code class="c">!f2py intent(hide) M</code>
    <code class="kt">INTEGER</code> <code class="kd">::</code> <code class="nv">N</code><code class="p">,</code> <code class="nv">M</code>
    <code class="kt">DOUBLE PRECISION</code><code class="p">,</code> <code class="k">DIMENSION</code><code class="p">(</code><code class="nv">N</code><code class="p">,</code><code class="nv">M</code><code class="p">)</code> <code class="kd">::</code> <code class="nv">grid</code><code class="p">,</code> <code class="nv">scratch</code>
    <code class="kt">DOUBLE PRECISION</code><code class="p">,</code> <code class="k">DIMENSION</code><code class="p">(</code><code class="nv">N</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code> <code class="nv">M</code><code class="o">-</code><code class="mi">2</code><code class="p">)</code> <code class="kd">::</code> <code class="nv">laplacian</code>
    <code class="kt">DOUBLE PRECISION</code> <code class="kd">::</code> <code class="nv">D</code><code class="p">,</code> <code class="nv">dt</code>

    <code class="nv">laplacian</code> <code class="o">=</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">3</code><code class="p">:</code><code class="nv">N</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">+</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">1</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">+</code> <code class="p">&amp;</code>
                <code class="nv">grid</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">3</code><code class="p">:</code><code class="nv">M</code><code class="p">)</code> <code class="o">+</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">2</code><code class="p">)</code> <code class="o">-</code> <code class="mi">4</code> <code class="o">*</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code>
    <code class="nv">scratch</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">=</code> <code class="nv">grid</code><code class="p">(</code><code class="mi">2</code><code class="p">:</code><code class="nv">N</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">:</code><code class="nv">M</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">+</code> <code class="nv">D</code> <code class="o">*</code> <code class="nv">dt</code> <code class="o">*</code> <code class="nv">laplacian</code>
<code class="k">END SUBROUTINE </code><code class="nv">evolve</code></pre></div></div><p>In order to build the code into a python module we run the following
command.  This will create a <code class="literal">diffusion.so</code> file which can be imported directly
into python.</p><pre class="programlisting"><code class="nv">$ </code>f2py -c -m diffusion --fcompiler<code class="o">=</code>gfortran --opt<code class="o">=</code><code class="s1">'-O3'</code> diffusion.f90</pre><p>If we play around with the resulting module interactively, we can see the
niceties which <code class="literal">f2py</code> has given us thanks to our annotations and its ability to
parse the Fortran code.</p><pre class="programlisting"><code class="go">In [1]: import diffusion</code>

<code class="go">In [2]: diffusion?</code>
<code class="go">Type:        module</code>
<code class="go">String form: &lt;module 'diffusion' from 'diffusion.so'&gt;</code>
<code class="go">File:        /Users/micha/projects/high_performance_python/notebooks/examples/compilation/f2py/diffusion.so</code>
<code class="go">Docstring:</code>
<code class="go">This module 'diffusion' is auto-generated with f2py (version:2).</code>
<code class="go">Functions:</code>
<code class="go">  evolve(grid,scratch,d,dt)</code>
<code class="go">.</code>

<code class="go">In [3]: diffusion.evolve?</code>
<code class="go">Type:        fortran</code>
<code class="go">String form: &lt;fortran object&gt;</code>
<code class="go">Docstring:</code>
<code class="go">evolve(grid,scratch,d,dt)</code>

<code class="go">Wrapper for ``evolve``.</code>

<code class="go">Parameters</code>
<code class="go">grid : input rank-2 array('d') with bounds (n,m)</code>
<code class="go">scratch :  rank-2 array('d') with bounds (n,m)</code>
<code class="go">d : input float</code>
<code class="go">dt : input float</code></pre><p>The code above shows that the result from the <code class="literal">f2py</code> generation is automatically
documented and the interface is quite simplified.  For example, instead of us
having to extract the sizes of the vectors, <code class="literal">f2py</code> has figured out how to
automatically find this information and simply hides it in the resulting
interface.  Infact, the resulting <code class="literal">evolve</code> function looks exactly the same in
its signature as the pure python version we wrote in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a>.</p><p>The only thing we must be careful of is the ordering of the numpy arrays in
memory.  Since most of what we do with numpy and python focuses on code derived
from C, we always use the C convention for ordering data in memory (called
row-major ordering).  Fortran uses a different convention (column-major
ordering) which we must make sure our vectors abide by.  These orderings simply
state whether, for a 2D array, columns or rows are contiguous in memory.
<sup>[<a id="id649677" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#ftn.id649677" class="footnote">43</a>]</sup>.  Luckily, this simply means we
specify the <code class="literal">order='F'</code> parameter to numpy when declaring our vectors.</p><div class="note"><h3 class="title">Note</h3><p>The difference between row-major ordering and column-major ordering means that
the matrix <code class="literal">[[1, 2], [3, 4]]</code> gets stored in memory as <code class="literal">[1, 2, 3, 4]' for
row-major ordering and `[1, 3, 2, 4]</code> for column-major ordering.  The difference
is simply convention and doesn’t have any real implications to performance when
used
properly.</p></div><p>This results in the following code to use our Fortran subroutine.  This code
looks exactly the same as what we used in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_numpy_memory1">Example&nbsp;6-14</a> except for
the import from the <code class="literal">f2py</code> derived library and the explicit Fortran ordering of
our data.</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">diffusion</code> <code class="kn">import</code> <code class="n">evolve</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="n">scratch</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">double</code><code class="p">,</code> <code class="n">order</code><code class="o">=</code><code class="s">'F'</code><code class="p">)</code> <code class="c">#</code><a id="CO14-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">grid</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">double</code><code class="p">,</code> <code class="n">order</code><code class="o">=</code><code class="s">'F'</code><code class="p">)</code>

    <code class="o">...</code> <code class="n">standard</code> <code class="n">initialization</code> <code class="o">...</code>

    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mf">0.1</code><code class="p">)</code>
        <code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code> <code class="o">=</code> <code class="n">scratch</code><code class="p">,</code> <code class="n">grid</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#CO14-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
FORTRAN orders numbers differently in memory so we must remember to set our numpy arrays to use that standard
</p></dd></dl></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_cpython_module">cpython module</h3></div></div></div><p>Finally, we can always go right down to the cpython API level and write a
cpython module.  This requires us to write code in the same way that cpython is
developed and take care of all of the interactions between our code and
implementation of cpython.</p><p>This has the advantage that it is incredibly portable given the python version.
We don’t require any external modules or libraries, just a C compiler and
python!  However, this doesn’t necessarily scale well to new versions of python.
For example, cpython modules written for python 2.7 will take some work to work
with python 3.</p><p>However, that portability comes at a big cost—you are responsible for every
aspect of the interface between your python code and the module.  This can make
even the simplest tasks take dozens of lines of code simply.  For example, to
interface the diffusion library from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#c_diffusion_2d">Example&nbsp;7-20</a>, we must write 28 lines
of code simply to read the arguments to a function and parse them
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling_cpython_module">Example&nbsp;7-25</a>).</p><p>This does mean that you have incredible fine grained control over what is
happening.  This goes all the way down to being able to manually change the
reference counts for python’s garbage collection (which can be the cause of a
lot of pain when creating cpython modules that deal with native python types).
Because of this, the resulting code tends to be minutely faster than other
interface methods.</p><p>All in all, this method should be left as a last resort.  While it is quite
informative to write a cpython module, the resulting code is not as reusable or
maintainable than other potential methods.  Making subtle changes in the module
can often requite completely reworking the module.  In fact, we include the
module code and the required <code class="literal">setup.py</code> to compile it
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#compiling_cpython_module_setup">Example&nbsp;7-26</a>) as a cautionary tale.</p><div class="example"><a id="compiling_cpython_module"></a><div class="example-title">Example&nbsp;7-25.&nbsp;CPython module to interface to the 2D diffusion library</div><div class="example-contents"><pre class="programlisting"><code class="c1">// python_interface.c</code>
<code class="c1">// - cpython module interface for diffusion.c</code>
<code class="cp">#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION</code>

<code class="cp">#include &lt;Python.h&gt;</code>
<code class="cp">#include &lt;numpy/arrayobject.h&gt;</code>
<code class="cp">#include "diffusion.h"</code>

<code class="cm">/* Docstrings */</code>
<code class="k">static</code> <code class="kt">char</code> <code class="n">module_docstring</code><code class="p">[]</code> <code class="o">=</code>
    <code class="s">"Provides optimized method to solve the diffusion equation"</code><code class="p">;</code>
<code class="k">static</code> <code class="kt">char</code> <code class="n">cdiffusion_evolve_docstring</code><code class="p">[]</code> <code class="o">=</code>
    <code class="s">"Evolve a 2D grid using the diffusion equation"</code><code class="p">;</code>

<code class="n">PyArrayObject</code><code class="o">*</code> <code class="nf">py_evolve</code><code class="p">(</code><code class="n">PyObject</code><code class="o">*</code> <code class="n">self</code><code class="p">,</code> <code class="n">PyObject</code><code class="o">*</code> <code class="n">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">PyArrayObject</code><code class="o">*</code> <code class="n">data</code><code class="p">;</code>
    <code class="n">PyArrayObject</code><code class="o">*</code> <code class="n">scratch</code><code class="p">;</code>
    <code class="kt">double</code> <code class="n">dt</code><code class="p">,</code> <code class="n">D</code><code class="o">=</code><code class="mf">1.0</code><code class="p">;</code>

    <code class="cm">/* The "evolve" function will have the signature:</code>
<code class="cm">     *     evolve(data, scratch, dt, D=1)</code>
<code class="cm">     */</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">PyArg_ParseTuple</code><code class="p">(</code><code class="n">args</code><code class="p">,</code> <code class="s">"OOd|d"</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">data</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">scratch</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">dt</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">D</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code> <code class="s">"Invalid arguments"</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="cm">/* Make sure that the numpy arrays are contiguous in memory */</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">PyArray_Check</code><code class="p">(</code><code class="n">data</code><code class="p">)</code> <code class="o">||</code> <code class="o">!</code><code class="n">PyArray_ISCONTIGUOUS</code><code class="p">(</code><code class="n">data</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"data is not a contiguous array."</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">PyArray_Check</code><code class="p">(</code><code class="n">scratch</code><code class="p">)</code> <code class="o">||</code> <code class="o">!</code><code class="n">PyArray_ISCONTIGUOUS</code><code class="p">(</code><code class="n">scratch</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"scratch is not a contiguous array."</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="cm">/* Make sure that grid and scratch are of the same type and have the same</code>
<code class="cm">     * dimensions</code>
<code class="cm">     */</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">PyArray_TYPE</code><code class="p">(</code><code class="n">data</code><code class="p">)</code> <code class="o">!=</code> <code class="n">PyArray_TYPE</code><code class="p">(</code><code class="n">scratch</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"scratch and data should have same type."</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">PyArray_NDIM</code><code class="p">(</code><code class="n">data</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"data should be two dimensional"</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">PyArray_NDIM</code><code class="p">(</code><code class="n">scratch</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"scratch should be two dimensional"</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">((</code><code class="n">PyArray_DIM</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code class="mi">0</code><code class="p">)</code> <code class="o">!=</code> <code class="n">PyArrayDim</code><code class="p">(</code><code class="n">scratch</code><code class="p">,</code><code class="mi">0</code><code class="p">))</code> <code class="o">||</code>
        <code class="p">(</code><code class="n">PyArray_DIM</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code> <code class="o">!=</code> <code class="n">PyArrayDim</code><code class="p">(</code><code class="n">scratch</code><code class="p">,</code><code class="mi">1</code><code class="p">)))</code> <code class="p">{</code>
        <code class="n">PyErr_SetString</code><code class="p">(</code><code class="n">PyExc_RuntimeError</code><code class="p">,</code><code class="s">"data and scratch must have the same dimensions"</code><code class="p">);</code>
        <code class="k">return</code> <code class="nb">NULL</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="cm">/* Fetch the size of the grid we are working with */</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">N</code> <code class="o">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="n">PyArray_DIM</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">M</code> <code class="o">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="n">PyArray_DIM</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

    <code class="n">evolve</code><code class="p">(</code>
        <code class="n">N</code><code class="p">,</code>
        <code class="n">M</code><code class="p">,</code>
        <code class="n">PyArray_DATA</code><code class="p">(</code><code class="n">data</code><code class="p">),</code>
        <code class="n">PyArray_DATA</code><code class="p">(</code><code class="n">scratch</code><code class="p">),</code>
        <code class="n">D</code><code class="p">,</code>
        <code class="n">dt</code>
    <code class="p">);</code>

    <code class="n">Py_XINCREF</code><code class="p">(</code><code class="n">scratch</code><code class="p">);</code>
    <code class="k">return</code> <code class="n">scratch</code><code class="p">;</code>
<code class="p">}</code>

<code class="cm">/* Module specification */</code>
<code class="k">static</code> <code class="n">PyMethodDef</code> <code class="n">module_methods</code><code class="p">[]</code> <code class="o">=</code> <code class="p">{</code>
<code class="cm">/* { python method name , C function , argument types , docstring                   } */</code>
   <code class="p">{</code> <code class="s">"evolve"</code>           <code class="p">,</code> <code class="n">py_evolve</code>  <code class="p">,</code> <code class="n">METH_VARARGS</code>   <code class="p">,</code> <code class="n">cdiffusion_evolve_docstring</code> <code class="p">}</code>    <code class="p">,</code>
   <code class="p">{</code> <code class="nb">NULL</code>               <code class="p">,</code> <code class="nb">NULL</code>       <code class="p">,</code> <code class="mi">0</code>              <code class="p">,</code> <code class="nb">NULL</code>                        <code class="p">}</code>
<code class="p">};</code>

<code class="cm">/* Initialize the module */</code>
<code class="n">PyMODINIT_FUNC</code> <code class="nf">initcdiffusion</code><code class="p">(</code><code class="kt">void</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">PyObject</code> <code class="o">*</code><code class="n">m</code> <code class="o">=</code> <code class="n">Py_InitModule3</code><code class="p">(</code><code class="s">"cdiffusion"</code><code class="p">,</code> <code class="n">module_methods</code><code class="p">,</code> <code class="n">module_docstring</code><code class="p">);</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">m</code> <code class="o">==</code> <code class="nb">NULL</code><code class="p">)</code>
        <code class="k">return</code><code class="p">;</code>

    <code class="cm">/* Load `numpy` functionality. */</code>
    <code class="n">import_array</code><code class="p">();</code>
<code class="p">}</code></pre></div></div><p>In order to build the above code, we need to create a <code class="literal">setup.py</code> script which
uses the <code class="literal">distutils</code> module to figure out how to build the code such that it is
python compatible.  In addition to the standard <code class="literal">distutils</code> module, <code class="literal">numpy</code>
provides it’s own module to help with adding <code class="literal">numpy</code> integration in your cpython
modules.</p><div class="example"><a id="compiling_cpython_module_setup"></a><div class="example-title">Example&nbsp;7-26.&nbsp;Setup file for the cpython module diffusion interface</div><div class="example-contents"><pre class="programlisting"><code class="sd">"""</code>
<code class="sd">setup.py for cpython diffusion module.  The extention can be built by running</code>

<code class="sd">    $ python setup.py build_ext --inplace</code>

<code class="sd">which will create the "cdiffusion.so" file which can be directly imported into</code>
<code class="sd">python</code>
<code class="sd">"""</code>

<code class="kn">from</code> <code class="nn">distutils.core</code> <code class="kn">import</code> <code class="n">setup</code><code class="p">,</code> <code class="n">Extension</code>
<code class="kn">import</code> <code class="nn">numpy.distutils.misc_util</code>

<code class="n">__version__</code> <code class="o">=</code> <code class="s">"0.1"</code>

<code class="n">cdiffusion</code> <code class="o">=</code> <code class="n">Extension</code><code class="p">(</code>
    <code class="s">'cdiffusion'</code><code class="p">,</code>
    <code class="n">sources</code> <code class="o">=</code> <code class="p">[</code><code class="s">'cdiffusion/cdiffusion.c'</code><code class="p">,</code> <code class="s">'cdiffusion/python_interface.c'</code><code class="p">],</code>
    <code class="n">extra_compile_args</code> <code class="o">=</code> <code class="p">[</code><code class="s">"-O3"</code><code class="p">,</code> <code class="s">"-std=c99"</code><code class="p">,</code> <code class="s">"-Wall"</code><code class="p">,</code> <code class="s">"-p"</code><code class="p">,</code> <code class="s">"-pg"</code><code class="p">,</code> <code class="p">],</code>
    <code class="n">extra_link_args</code> <code class="o">=</code> <code class="p">[</code><code class="s">"-lc"</code><code class="p">],</code>
<code class="p">)</code>

<code class="n">setup</code> <code class="p">(</code>
    <code class="n">name</code> <code class="o">=</code> <code class="s">'diffusion'</code><code class="p">,</code>
    <code class="n">version</code> <code class="o">=</code> <code class="n">__version__</code><code class="p">,</code>
    <code class="n">ext_modules</code> <code class="o">=</code> <code class="p">[</code><code class="n">cdiffusion</code><code class="p">,],</code>
    <code class="n">packages</code> <code class="o">=</code> <code class="p">[</code><code class="s">"diffusion"</code><code class="p">,</code> <code class="p">],</code>
    <code class="n">include_dirs</code> <code class="o">=</code> <code class="n">numpy</code><code class="o">.</code><code class="n">distutils</code><code class="o">.</code><code class="n">misc_util</code><code class="o">.</code><code class="n">get_numpy_include_dirs</code><code class="p">(),</code>
<code class="p">)</code></pre></div></div><p>The result from this is a <code class="literal">cdiffusion.so</code> file which can be imported directly
from python and used quite easily.  Since we had complete control over the
signature of the resulting function and exactly how our C code interacted with
the library, we were able to (with some hard work) create an module which is
easy to use.</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">cdiffusion</code> <code class="kn">import</code> <code class="n">evolve</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
    <code class="n">scratch</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">double</code><code class="p">)</code>
    <code class="n">grid</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="n">grid_shape</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">double</code><code class="p">)</code>

    <code class="o">...</code> <code class="n">standard</code> <code class="n">initialization</code> <code class="o">...</code>

    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_iterations</code><code class="p">):</code>
        <code class="n">evolve</code><code class="p">(</code><code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mf">0.1</code><code class="p">)</code>
        <code class="n">grid</code><code class="p">,</code> <code class="n">scratch</code> <code class="o">=</code> <code class="n">scratch</code><code class="p">,</code> <code class="n">grid</code></pre></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_wrap_up_5">Wrap Up</h2></div></div></div><p>The various strategies introduced in this chapter allow you to specialize your
code to different amounts in order to reduce the number of instructions the CPU
must execute and increase the efficiency of our programs.  Sometimes this can be
done algorithmically, however many times it must be done manually
(<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#jit_vs_compiler">JITs vs Compilers</a>).  Furthermore, sometimes these methods must be employed
simply to use libraries that have already been written in other languages.
Regardless of the motivation, Python allows us to benefit from the speedups that
other languages can offer on some problems, while still maintaining the
verbosity and flexibility for other problems.</p><p>It is important to note though that these optimizations are done in order to
optimize the efficiency of CPU instructions only.  Sometimes, if you have IO
bound processes coupled to a CPU bound problem, simply compiling your code will
not provide any reasonable speedups.  For these problems, we must rethink how we
are solving the problem and potentially use parallelism to run different tasks
at the same time.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id620693"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id620693" class="simpara">17</a>] </sup><a class="ulink" href="http://cython.org/" target="_top">http://cython.org/</a></p></div><div class="footnote" id="ftn.id645371"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id645371" class="simpara">18</a>] </sup><a class="ulink" href="http://code.google.com/p/shedskin/" target="_top">http://code.google.com/p/shedskin/</a></p></div><div class="footnote" id="ftn.id351851"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id351851" class="simpara">19</a>] </sup><a class="ulink" href="http://numba.pydata.org/" target="_top">http://numba.pydata.org/</a></p></div><div class="footnote" id="ftn.id351999"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id351999" class="simpara">20</a>] </sup><a class="ulink" href="http://docs.continuum.io/numbapro/" target="_top">http://docs.continuum.io/numbapro/</a></p></div><div class="footnote" id="ftn.id352019"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352019" class="simpara">21</a>] </sup><a class="ulink" href="http://pythonhosted.org/pythran/" target="_top">http://pythonhosted.org/pythran/</a></p></div><div class="footnote" id="ftn.id352187"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352187" class="simpara">22</a>] </sup><a class="ulink" href="http://pypy.org/" target="_top">http://pypy.org/</a></p></div><div class="footnote" id="ftn.id352373"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352373" class="simpara">23</a>] </sup><a class="ulink" href="http://pypy.readthedocs.org/en/latest/cpython_differences.html" target="_top">http://pypy.readthedocs.org/en/latest/cpython_differences.html</a></p></div><div class="footnote" id="ftn.id352311"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352311" class="simpara">24</a>] </sup><a class="ulink" href="http://pypy.readthedocs.org/en/latest/garbage_collection.html" target="_top">http://pypy.readthedocs.org/en/latest/garbage_collection.html</a></p></div><div class="footnote" id="ftn.id352430"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352430" class="simpara">25</a>] </sup><a class="ulink" href="https://bitbucket.org/pypy/compatibility/wiki/c-api" target="_top">https://bitbucket.org/pypy/compatibility/wiki/c-api</a></p></div><div class="footnote" id="ftn.id352450"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352450" class="simpara">26</a>] </sup><a class="ulink" href="http://ianozsvald.com/2014/01/14/installing-the-numpy-module-in-pypy/" target="_top">http://ianozsvald.com/2014/01/14/installing-the-numpy-module-in-pypy/</a></p></div><div class="footnote" id="ftn.id352476"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352476" class="simpara">27</a>] </sup><a class="ulink" href="https://mail.python.org/pipermail/pypy-dev/2014-February/012232.html" target="_top">https://mail.python.org/pipermail/pypy-dev/2014-February/012232.html</a></p></div><div class="footnote" id="ftn.id352470"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352470" class="simpara">28</a>] </sup><a class="ulink" href="https://bitbucket.org/pypy/compatibility/wiki/Home" target="_top">https://bitbucket.org/pypy/compatibility/wiki/Home</a></p></div><div class="footnote" id="ftn.id352506"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352506" class="simpara">29</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Software_transactional_memory" target="_top">http://en.wikipedia.org/wiki/Software_transactional_memory</a></p></div><div class="footnote" id="ftn.id352520"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352520" class="simpara">30</a>] </sup><a class="ulink" href="https://bitbucket.org/pypy/jitviewer" target="_top">https://bitbucket.org/pypy/jitviewer</a></p></div><div class="footnote" id="ftn.id352492"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id352492" class="simpara">31</a>] </sup><a class="ulink" href="http://morepypy.blogspot.co.uk/2009/11/hi-all-this-week-i-worked-on-improving.html" target="_top">http://morepypy.blogspot.co.uk/2009/11/hi-all-this-week-i-worked-on-improving.html</a></p></div><div class="footnote" id="ftn.id354259"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354259" class="simpara">32</a>] </sup><a class="ulink" href="http://compilers.pydata.org/" target="_top">http://compilers.pydata.org/</a></p></div><div class="footnote" id="ftn.id354270"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354270" class="simpara">33</a>] </sup><a class="ulink" href="http://deeplearning.net/software/theano/" target="_top">http://deeplearning.net/software/theano/</a></p></div><div class="footnote" id="ftn.id354351"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354351" class="simpara">34</a>] </sup><a class="ulink" href="http://www.parakeetpython.com/" target="_top">http://www.parakeetpython.com/</a></p></div><div class="footnote" id="ftn.id354325"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354325" class="simpara">35</a>] </sup><a class="ulink" href="http://viennacl.sourceforge.net/pyviennacl.html" target="_top">http://viennacl.sourceforge.net/pyviennacl.html</a></p></div><div class="footnote" id="ftn.id354292"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354292" class="simpara">36</a>] </sup><a class="ulink" href="http://nuitka.net/pages/overview.html" target="_top">http://nuitka.net/pages/overview.html</a></p></div><div class="footnote" id="ftn.id354368"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354368" class="simpara">37</a>] </sup><a class="ulink" href="https://github.com/dropbox/pyston" target="_top">https://github.com/dropbox/pyston</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id354465"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id354465" class="simpara">38</a>] </sup>For simplicity we will not implement the
boundary conditions</p></div><div class="footnote" epub:type="footnote" id="ftn.id355197"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id355197" class="simpara">39</a>] </sup>This is very
cpython dependant.  Other version of python may have their own version of ctypes
which may work very differently</p></div><div class="footnote" id="ftn.id648494"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id648494" class="simpara">40</a>] </sup><a class="ulink" href="http://www.netlib.org/lapack/" target="_top">http://www.netlib.org/lapack/</a></p></div><div class="footnote" id="ftn.id648537"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id648537" class="simpara">41</a>] </sup><a class="ulink" href="http://www.netlib.org/blas/" target="_top">http://www.netlib.org/blas/</a></p></div><div class="footnote" id="ftn.id648511"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id648511" class="simpara">42</a>] </sup><a class="ulink" href="http://docs.scipy.org/doc/numpy-dev/f2py/" target="_top">http://docs.scipy.org/doc/numpy-dev/f2py/</a></p></div><div class="footnote" id="ftn.id649677"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#id649677" class="simpara">43</a>] </sup>For more information, see
<a class="ulink" href="http://en.wikipedia.org/wiki/Row-major_order" target="_top">http://en.wikipedia.org/wiki/Row-major_order</a></p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch06.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">6. Matrix and Vector Computation</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/safari-books-archive/site/library/view/high-performance-python/9781449361747/ch08.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">8. Concurrency</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch07.html" data-for-analytics="9781449361747:ch07.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch07.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>
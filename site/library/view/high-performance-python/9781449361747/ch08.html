<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch08.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch08.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch08.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch08.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>8. Concurrency - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/site/library/view/high-performance-python/9781449361747/ch08.html"><meta name="description" content="Chapter&nbsp;8.&nbsp;Concurrency Questions you’ll be able to answer after this chapter What is concurrency and how is it helpful? What is the difference between concurrency and parallelism? Which ... "><meta property="og:title" content="8. Concurrency"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="8. Concurrency"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;8.&nbsp;Concurrency Questions you’ll be able to answer after this chapter What is concurrency and how is it helpful? What is the difference between concurrency and parallelism? Which ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch08.html" data-for-analytics="9781449361747:ch08.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%208.%20Concurrency&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch08.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/site/library/view/high-performance-python/9781449361747/ch07.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">7. Compiling to C</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/site/library/view/high-performance-python/9781449361747/ch09.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">9. The multiprocessing module</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-concurrency"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;8.&nbsp;Concurrency</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
What is concurrency and how is it helpful?
</li><li class="listitem">
What is the difference between concurrency and parallelism?
</li><li class="listitem">
Which tasks can be done concurrently and which can’t?
</li><li class="listitem">
What are the various paradigms for concurrency?
</li><li class="listitem">
When is the right time to take advantage of concurrency?
</li><li class="listitem">
How can concurrency speed up my programs?
</li></ul></div></div><p>IO can be quite burdensome to the flow of a program.  Every time your code reads
from a file or writes to a network socket, your code pauses contacts the kernel,
requests the operation to happen, and then wait for it to complete.  This may
not seem like the end of the world, especially after realizing that a similar
operation happens every time memory is allocated, however if we look back to
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch01.html#FIG-performant-connection-speed">Figure&nbsp;1-3</a> we see that most of the IO operations we
perform are on devices that are orders of magnitude slower than the CPU.</p><p>For example, in the time it takes to write to a network socket, an operation
that typically takes about 1ms, we could have done 2,400,000 instructions while
waiting (on a 2.4GHz computer).  Worst of all, our program is halted for much of
this 1ms time—our execution is paused and we are waiting for a signal that
the write operation has completed.  This time you spend in a paused state is
called “IO wait”.</p><p>Concurrency helps us utilize this wasted time by allow us to perform other
operations while waiting for an IO operation to complete.  For example, in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_vs_concurrent">Figure&nbsp;8-1</a> we see a depiction of a program that must run 3
tasks, all of which have periods of IO wait within them.  If we run them
serially then we suffer the IO wait penalty 3 times.  However, if we run these
tasks concurrently we can essentially hide the wait time by running another task
in the meantime.  It is important to note that this is all still happening on a
single thread and still only uses 1 CPU at a time!</p><p>While concurrency isn’t simply limited to IO, this is the time when it really
performs the best.  What happens in a concurrent program is that instead of
having your code run serially, that is from one line to the next, your code is
written to handle events and different parts of your code run when different
events happen.</p><p>By modeling a program in this way, we are able to deal with the particular event
that we are concerned with: IO wait.</p><div class="figure"><a id="conn_serial_vs_concurrent"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 432; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/serial_vs_concurrent.png.jpg" alt="Comparison between serial and concurrent programs" width="781" height="376" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/serial_vs_concurrent.png.jpg"></div></div><div class="figure-title">Figure&nbsp;8-1.&nbsp;Comparison between serial and concurrent programs</div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_introduction_to_async">Introduction to Async</h2></div></div></div><p>When a program enters IO wait, the execution is exchanged to the kernel (called
a context switch) and is not resumed until the IO operation is completed.
Context switches are quite a heavy operation.  It requires us to save the state
of our program (losing any sort of caching we had at the CPU level) and give up
the use of the CPU.  Later, when we are allowed to run again, we must spend the
time re-initializing our program on the motherboard and getting ready to resume
(of course, all this happens behind the scenes).</p><p>With concurrency, on the other hand, we typically have a thing called an “event
loop” running which manages what gets to run in our program, and when.  In it’s
essence, an event loop  is simply a list of functions that need to get run.  The
function at the top of the list gets run, then the next, etc.</p><div class="example"><a id="conn_toy_eventloop"></a><div class="example-title">Example&nbsp;8-1.&nbsp;Toy Eventloop</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">Queue</code> <code class="kn">import</code> <code class="n">Queue</code>
<code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>

<code class="n">eventloop</code> <code class="o">=</code> <code class="bp">None</code>

<code class="k">class</code> <code class="nc">EventLoop</code><code class="p">(</code><code class="n">Queue</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">start</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>
            <code class="n">function</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get</code><code class="p">()</code>
            <code class="n">function</code><code class="p">()</code>

<code class="k">def</code> <code class="nf">do_hello</code><code class="p">():</code>
    <code class="k">global</code> <code class="n">eventloop</code>
    <code class="k">print</code> <code class="s">"Hello"</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">do_world</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">do_world</code><code class="p">():</code>
    <code class="k">global</code> <code class="n">eventloop</code>
    <code class="k">print</code> <code class="s">"world"</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">do_hello</code><code class="p">)</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="n">eventloop</code> <code class="o">=</code> <code class="n">EventLoop</code><code class="p">()</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">do_hello</code><code class="p">)</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">start</code><code class="p">()</code></pre></div></div><p>This may seem like the same as before, however we can couple it to asynchronous
IO operations.  These operations are non-blocking, meaning if we do a network
write with an async function, it will return right away even though the write
has not happened yet.  When the write has completed, however, an event fires and
our program can know about it.</p><p>Putting these two concepts together, we can have a program that, when an IO
operation is requested, runs other functions while we wait for the original IO
operation to complete.  This essentially allows us to still do meaningful
calculation while we would otherwise have been in IO wait.</p><div class="note"><h3 class="title">Note</h3><p>Switching from function to function does have a cost.  We must set up the
function in memory to be called and we probably won’t have the cache that may
have set up before.  It is because of this that concurrency is best when your
program has a lot of IO wait—while this switching does have a cost to it it
can be much less than what is gained by making IO wait useful.</p></div><p>Programming using event loops can take on two forms: callbacks or futures.  In
the callback paradigm, functions are called with an argument which is generally
called the “callback”.  Instead of the function returning it’s value, it calls
the callback function with the value instead.  This sets up long chains of
functions which are called, each getting the result of the previous function in
the chain.</p><div class="example"><a id="id805646"></a><div class="example-title">Example&nbsp;8-2.&nbsp;Example with Callbacks</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>
<code class="k">def</code> <code class="nf">save_value</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="n">callback</code><code class="p">):</code>
    <code class="k">print</code> <code class="s">"Saving {} to database"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">save_result_to_db</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="c"># </code><a id="CO15-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">

<code class="k">def</code> <code class="nf">print_response</code><code class="p">(</code><code class="n">db_response</code><code class="p">):</code>
    <code class="k">print</code> <code class="s">"Response from database: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">db_response</code><code class="p">)</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code>
        <code class="n">partial</code><code class="p">(</code><code class="n">save_value</code><code class="p">,</code> <code class="s">"Hello World"</code><code class="p">,</code> <code class="n">print_response</code><code class="p">)</code>
    <code class="p">)</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO15-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
<code class="literal">save_result_to_db</code> is an asynchronous function and will return immediately and the function will end and allow other code to run.  However, once the data is ready, <code class="literal">print_response</code> will be called.
</p></dd></dl></div></div></div><p>With futures, on the other hand, an asynchronous function returns a promise of a
future result instead of the actual result.  Because of this, we must wait for
the future that is returned by this sort of asynchronous function to complete
and be filled with the value we desire (either by doing a <code class="literal">yield</code> on it or by
running a function that explicitly waits for a value to be ready).  This allows
us to do other calculations while waiting for the future object to be filled
with the data we requested.  If we couple this with the concept of generators,
functions that can be paused and whose execution can later be resumed, we can
write asynchronous code that looks very close to serial code in form.</p><pre class="programlisting"><code class="nd">@coroutine</code>
<code class="k">def</code> <code class="nf">save_value</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="n">callback</code><code class="p">):</code>
    <code class="k">print</code> <code class="s">"Saving {} to database"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">db_response</code> <code class="o">=</code> <code class="k">yield</code> <code class="n">save_result_to_db</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="c"># </code><a id="CO16-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="k">print</code> <code class="s">"Response from database: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">db_response</code><code class="p">)</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="n">eventloop</code><code class="o">.</code><code class="n">put</code><code class="p">(</code>
        <code class="n">partial</code><code class="p">(</code><code class="n">save_value</code><code class="p">,</code> <code class="s">"Hello World"</code><code class="p">)</code>
    <code class="p">)</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO16-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
In this case, <code class="literal">save_result_to_db</code> returns a <code class="literal">Future</code> type.  By yielding from it, <code class="literal">save_value</code> gets paused until the value is ready and then the function results.
</p></dd></dl></div><p>In python, coroutines are implemented as generators.  This is convenient because
generators already have the machinery to pause their execution and resume later.
So, what happens, is our coroutine will yield a future and the event loop will
wait until that future has it’s value ready.  Once this happens, the event loop
will resume execution of that function, sending back to it the value of the
future.  For python 2.7 implementations of future-based concurrency, things can
get a bit strange when trying to use coroutines as actual functions. Remember
that generators cannot return values, so there are various ways libraries deal
with this issue.  In python 3.4 however, new machinery has been introduced in
order to easily create coroutines and have them still return values.</p><p>In this chapter we will analyze a web crawler which fetches data from an HTTP
server that has latency built into it.  This represents the general response
time latency that will occur whenever dealing with IO.  We will first create a
serial crawler that looks like the naive python solution to this problem.  Then
we will go through two solutions in python 2.7—<code class="literal">gevent</code> and <code class="literal">tornado</code>.
Finally, we will look at the <code class="literal">asyncio</code> library in python 3.4 and see what the
future of asynchronous programming in python looks like.</p><div class="note"><h3 class="title">Note</h3><p>The web server we implemented can support multiple connections at a time.  This
will be true for most services that you will be performing IO with—most
databases can support multiple requests at a time and most web servers support
10K+ simultaneous connections.  However, when interacting with a service that
cannot do multiple connections at a time <sup>[<a id="id806261" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id806261" epub:type="noteref" class="footnote">44</a>]</sup>, we will
always have the same performance as the serial case.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_serial_crawler">Serial Crawler</h2></div></div></div><p>For the control in our experiment with concurrency we will write a serial web
scraper that takes a list of URL’s, fetches them, and sums the total length of
the content from the pages.  We will use a custom HTTP server that takes two
parameters, <code class="literal">name</code> and <code class="literal">delay</code>.  The <code class="literal">delay</code> field will tell the server how
long, in milliseconds, to pause before responding.  The <code class="literal">name</code> field is simply
for logging purposes.</p><p>By controlling the <code class="literal">delay</code> parameter, we can simulate the time it takes a server
to respond to our query.  In the real world, this could correspond to a slow web
server, a strenuous database call or any IO call which takes a long time to
perform.  For the serial case, this simply represents more time that our program
will be stuck in IO wait, but in the concurrent examples later it will represent
more time the program can spend doing other things.</p><p>In addition, we chose to use the <code class="literal">requests</code> module to perform the HTTP call.
This choice is simply because of the simplicity of the module.  We use HTTP in
general for this section because it is a simple example of IO and can be
performed quite easily.  In general, any call to a HTTP library can be replaced
with any IO.</p><div class="example"><a id="conn_serial_http"></a><div class="example-title">Example&nbsp;8-3.&nbsp;Serial HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">requests</code>
<code class="kn">import</code> <code class="nn">string</code>
<code class="kn">import</code> <code class="nn">random</code>

<code class="k">def</code> <code class="nf">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_urls</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    We add random characters to the end of the URL to break any caching</code>
<code class="sd">    mechanisms in the requests library or the server</code>
<code class="sd">    """</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">num_urls</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">base_url</code> <code class="o">+</code> <code class="s">""</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">response_size</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">url</code> <code class="ow">in</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>
        <code class="n">response_size</code> <code class="o">+=</code> <code class="nb">len</code><code class="p">(</code><code class="n">response</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">response_size</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="kn">import</code> <code class="nn">time</code>
    <code class="n">delay</code> <code class="o">=</code> <code class="mi">100</code>
    <code class="n">num_iter</code> <code class="o">=</code> <code class="mi">500</code>
    <code class="n">base_url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?name=serial&amp;delay={}&amp;"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">delay</code><code class="p">)</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="n">result</code> <code class="o">=</code> <code class="n">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">end</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">print</code><code class="p">(</code><code class="s">"Result: {}, Time: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">end</code> <code class="o">-</code> <code class="n">start</code><code class="p">))</code></pre></div></div><p>When running this code, an interesting metric to look at is the start and stop
time of each request as seen by the HTTP server.  This tells us how efficient
our code was during IO wait—since our task is simply to launch HTTP requests
and then sum the number of characters that were returned we should be able to
launch more HTTP requests, and process any responses, while waiting for other
requests to complete.</p><div class="figure"><a id="conn_serial_request_time"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/serial.png" alt="Request times for serial scraper" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/serial.png"></div></div><div class="figure-title">Figure&nbsp;8-2.&nbsp;Request Time for <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_http">Example&nbsp;8-3</a></div></div><p>We can see from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_request_time">Figure&nbsp;8-2</a> that, as expected, there is no
interleaving of our requests.  We do one request at a time and wait for the
previous request to happen before we move to the next request.  In fact, the
total run-time of the serial process makes perfect sense knowing this.  Since
each request takes 0.1s (because of our <code class="literal">delay</code> parameter) and we are doing 500
requests, we expect this runtime to be about 50s.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_gevent">Gevent</h2></div></div></div><p>One of the simplest asynchronous libraries is <code class="literal">gevent</code>.  It follows the paradigm
of having asynchronous functions return futures which means most of the logic in
your code can stay the same.  In addition, gevent monkey patches the standard IO
functions to be asynchronous, so most of the time you can simply use the
standard IO packages and benefit from asynchronous behaviour.</p><p>Gevent provides two mechanisms to enable asynchronous programming—as
mentioned before, it patches the standard library with asynchronous IO
functions, and it has a <code class="literal">Greenlets</code> object which can be used for concurrent
execution.  A greenlet is a type of coroutine and can be thought of as a thread
(see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch09.html">Chapter&nbsp;9</a> for a discussion on threads), however all greenlets run
on the same physical thread.  Instead of using multiple CPU’s to run all the
greenlets, they are switched between during IO wait by use of an event loop.
For the most part, <code class="literal">gevent</code> tries to make the handling of the event loop as
transparent as possible through the use of <code class="literal">wait</code> functions.  The <code class="literal">wait</code>
function will start an event loop and run it as long as it needs for all
greenlets to finish.  Because of this, most of your gevent code will run
serially, then at some point you will set up many greenlets to do some
concurrent task and the start the event loop with the <code class="literal">wait</code> function.  While
the <code class="literal">wait</code> function is executing, all of the concurrent tasks you have queued up
will run until completion (or some stopping condition), and then your code will
go back to being serial again.</p><p>The futures are created with <code class="literal">gevent.spawn</code>, which takes a function and the
arguments to that function and launches a greenlet which is responsible for
running that function.  The greenlet can be though of as a future since, once
the function we specified completes, it’s value will be contained within the
greenlet’s <code class="literal">value</code> field.  However, we have launched as many greenlets as we
have URL’s, we need a mechanism to limit how many HTTP requests we make at a
time.</p><p>This patching of python standard modules can make it harder to control the
subtleties of what is going on.  For example, one thing we want to make sure
when doing async IO is that we don’t open too many files or connections at one
time.  If we do this, we can overload the remote server or slow down our process
by having to context switch between too many operations.</p><p>In order to do this manually, we use a Semaphore to only do HTTP gets from 100
greenlets at a time.  A semaphore works by making sure that only a certain
number of coroutines can enter the context block at a time.  As a result, we
launch all the greenelts that we need in order to fetch the URL’s right away,
however only 100 of them can make HTTP calls at a time.  Semaphore’s are one
type of locking mechanism used a lot in various parallel code flows.  By
restricting the progression of your code based on various rules, locks can help
you make sure that the various components of your program don’t interfere with
eachother.</p><div class="figure"><a id="conn_num_concurrent_requests"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/parallel_requests.png" alt="Experimenting with different numbers of concurrent requests for various request times" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/parallel_requests.png"></div></div><div class="figure-title">Figure&nbsp;8-3.&nbsp;Finding the right number of concurrent requests</div></div><p>Now that we have all the futures set up and have put in a locking mechanism to
control the flow of the greenlets, we can wait until we start having results by
using the the <code class="literal">gevent.iwait</code> function which will take a sequence of futures and
iterate over the ready items.  Conversely, we could have used <code class="literal">gevent.wait</code>
which would block execution of our program until all requests are done.</p><p>We go through the trouble of chunking our requests instead of sending them all
at once because overloading the eventloop can cause performnce decreases (and
this is true for all asynchronous programming).  From experimentation, we
generally see that 100 or so open connections at a time is optimal.  If we were
to use less, we would still have wasted time during IO wait.  With more, then we
are switching contexts too often in the event loop and adding unecissary
overhead to our program.  That being said, this value of 100 depends on many
things—the computer the code is being run on, the implemintation of the event
loop, the properties of the remote host, the expect time to respond of the
remote server, etc.  I recommend doing some experimentation before settling on a
choice.</p><div class="example"><a id="conn_grequest_http"></a><div class="example-title">Example&nbsp;8-4.&nbsp;GEvent HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">gevent</code> <code class="kn">import</code> <code class="n">monkey</code>
<code class="n">monkey</code><code class="o">.</code><code class="n">patch_socket</code><code class="p">()</code>

<code class="kn">import</code> <code class="nn">gevent</code>
<code class="kn">from</code> <code class="nn">gevent.coros</code> <code class="kn">import</code> <code class="n">Semaphore</code>
<code class="kn">import</code> <code class="nn">urllib2</code>
<code class="kn">import</code> <code class="nn">string</code>
<code class="kn">import</code> <code class="nn">random</code>

<code class="k">def</code> <code class="nf">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_urls</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">num_urls</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">base_url</code> <code class="o">+</code> <code class="s">""</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>

<code class="k">def</code> <code class="nf">chunked_requests</code><code class="p">(</code><code class="n">urls</code><code class="p">,</code> <code class="n">chunk_size</code><code class="o">=</code><code class="mi">100</code><code class="p">):</code>
    <code class="n">semaphore</code> <code class="o">=</code> <code class="n">Semaphore</code><code class="p">(</code><code class="n">chunk_size</code><code class="p">)</code> <code class="c"># </code><a id="CO17-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">requests</code> <code class="o">=</code> <code class="p">[</code><code class="n">gevent</code><code class="o">.</code><code class="n">spawn</code><code class="p">(</code><code class="n">download</code><code class="p">,</code> <code class="n">u</code><code class="p">,</code> <code class="n">semaphore</code><code class="p">)</code> <code class="k">for</code> <code class="n">u</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">]</code> <code class="c"># </code><a id="CO17-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="k">for</code> <code class="n">response</code> <code class="ow">in</code> <code class="n">gevent</code><code class="o">.</code><code class="n">iwait</code><code class="p">(</code><code class="n">requests</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">response</code>

<code class="k">def</code> <code class="nf">download</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">semaphore</code><code class="p">):</code>
    <code class="k">with</code> <code class="n">semaphore</code><code class="p">:</code> <code class="c"># </code><a id="CO17-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">
        <code class="n">data</code> <code class="o">=</code> <code class="n">urllib2</code><code class="o">.</code><code class="n">urlopen</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">response_futures</code> <code class="o">=</code> <code class="n">chunked_requests</code><code class="p">(</code><code class="n">urls</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code> <code class="c"># </code><a id="CO17-4"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png">
    <code class="n">response_size</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">value</code><code class="p">)</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">response_futures</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">response_size</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="kn">import</code> <code class="nn">time</code>
    <code class="n">delay</code> <code class="o">=</code> <code class="mi">100</code>
    <code class="n">num_iter</code> <code class="o">=</code> <code class="mi">500</code>
    <code class="n">base_url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?name=gevent&amp;delay={}&amp;"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">delay</code><code class="p">)</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="n">result</code> <code class="o">=</code> <code class="n">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">end</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">print</code><code class="p">(</code><code class="s">"Result: {}, Time: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">end</code> <code class="o">-</code> <code class="n">start</code><code class="p">))</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO17-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Here we generate a semaphore that lets <code class="literal">chunk_size</code> downloads happen.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO17-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
By using the semaphore as a context manager, we insure that only <code class="literal">chunk_size</code> greenlets can run the body of the context at a time.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO17-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
We can queue up as many Greenlets as we need, knowing that none of them will run until we start an event loop with <code class="literal">wait</code> or <code class="literal">iwait</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO17-4"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></a> </dt><dd><p>
<code class="literal">response_futures</code> now holds a generator over completed futures, all of which have our desired data in the <code class="literal">.value</code> property.
</p></dd></dl></div></div></div><p>Alternitively, we can use grequests to greatly simplify our <code class="literal">gevent</code> code.
While <code class="literal">gevent</code> provides all sorts of lower level concurrent socket operations,
<code class="literal">grequests</code> is a combination of the <code class="literal">requests</code> http library and gevent to make a
very simple API for making concurrent HTTP requests (it even handles the
semaphore logic for us).  In the end, our code becomes a lot more simple, more
understandable and maintainable while still getting comparable speedups to the
lower level <code class="literal">gevent</code> code (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_gevent_http">Example&nbsp;8-5</a>).</p><div class="example"><a id="conn_gevent_http"></a><div class="example-title">Example&nbsp;8-5.&nbsp;GRequests HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">grequests</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">response_futures</code> <code class="o">=</code> <code class="p">(</code><code class="n">grequests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">u</code><code class="p">)</code> <code class="k">for</code> <code class="n">u</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">)</code> <code class="c"># </code><a id="CO18-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">responses</code> <code class="o">=</code> <code class="n">grequests</code><code class="o">.</code><code class="n">imap</code><code class="p">(</code><code class="n">response_futures</code><code class="p">,</code> <code class="n">size</code> <code class="o">=</code> <code class="mi">100</code><code class="p">)</code> <code class="c"># </code><a id="CO18-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">response_size</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">text</code><code class="p">)</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">responses</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">response_size</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO18-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
First we create the requests and get futures back.  We chose to do this as a generator so that later we only need to evaluate as many requests as we are ready to issue.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO18-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
Now we can take the future objects and map then into real response objects.  The <code class="literal">.imap</code> function gives us a generator which yields response objects for which we have retrieved data for.
</p></dd></dl></div></div></div><p>An important thing to note is that we have used gevent to make our IO requests
asynchronous, but we are not doing any non-io computations while in IO wait.
However, in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_gevent_request_time">Figure&nbsp;8-4</a> we can see the massive speedup we get.
By launching more requests while waiting for previous requests to finish we are
able to achieve a 69x speedup!  We can explicitly see how requests are being
sent out before previous requests finish by how the horizontal lines
representing the requests stack on each other.  This is in sharp contrast to the
case of the serial crawler (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_request_time">Figure&nbsp;8-2</a>) where a line only
starts when the previous line finishes.</p><p>Furthermore, we can see more interesting effects going on with the shape that
the gevent request timeline.  For example, at around the first 100th request we
see a pause where new requests are not launched.  This is because it is the
first time that our semaphore is hit and we are able to lock the semaphore
before any previous requests finish.  After this, the semaphore goes into an
equilibrium where it locks just as another request finishes and unlocks it.</p><div class="figure"><a id="conn_gevent_request_time"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/gevent.png" alt="Request times for gevent scraper" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/gevent.png"></div></div><div class="figure-title">Figure&nbsp;8-4.&nbsp;Request Time for <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_http">Example&nbsp;8-3</a></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_tornado">Tornado</h2></div></div></div><p>Another very frequently used package for asynchronous IO in python is <code class="literal">tornado</code>,
a package developed by facebook primarily for HTTP clients and servers.  In
contrast to <code class="literal">gevent</code>, <code class="literal">tornado</code> choses to use the callback method for async
behaviour.  However, in the 3.x release coroutine like behaviour was added in in
a way that is compatible with old code.</p><p>In the following example, we implement the same web crawler as we did for
<code class="literal">gevent</code>, however we use the tornado IO loop (their version of an event loop)
and their HTTP client.  This saves us the trouble of having to batch our
requests and deal with other more low level aspects of our code.</p><div class="example"><a id="conn_tornado_http"></a><div class="example-title">Example&nbsp;8-6.&nbsp;Tornado HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">tornado</code> <code class="kn">import</code> <code class="n">ioloop</code>
<code class="kn">from</code> <code class="nn">tornado.httpclient</code> <code class="kn">import</code> <code class="n">AsyncHTTPClient</code>
<code class="kn">from</code> <code class="nn">tornado</code> <code class="kn">import</code> <code class="n">gen</code>

<code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>
<code class="kn">import</code> <code class="nn">string</code>
<code class="kn">import</code> <code class="nn">random</code>

<code class="n">AsyncHTTPClient</code><code class="o">.</code><code class="n">configure</code><code class="p">(</code><code class="s">"tornado.curl_httpclient.CurlAsyncHTTPClient"</code><code class="p">,</code>
<code class="n">max_clients</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code> <code class="c">#</code><a id="CO19-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">

<code class="k">def</code> <code class="nf">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_urls</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">num_urls</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">base_url</code> <code class="o">+</code> <code class="s">""</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>

<code class="nd">@gen.coroutine</code>
<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">http_client</code> <code class="o">=</code> <code class="n">AsyncHTTPClient</code><code class="p">()</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">responses</code> <code class="o">=</code> <code class="k">yield</code> <code class="p">[</code><code class="n">http_client</code><code class="o">.</code><code class="n">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">)</code> <code class="k">for</code> <code class="n">url</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">]</code> <code class="c"># </code><a id="CO19-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">response_sum</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">body</code><code class="p">)</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">responses</code><code class="p">)</code>
    <code class="k">raise</code> <code class="n">gen</code><code class="o">.</code><code class="n">Return</code><code class="p">(</code><code class="n">value</code><code class="o">=</code><code class="n">response_sum</code><code class="p">)</code> <code class="c"># </code><a id="CO19-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="c">#... initialization ...</code>

    <code class="n">_ioloop</code> <code class="o">=</code> <code class="n">ioloop</code><code class="o">.</code><code class="n">IOLoop</code><code class="o">.</code><code class="n">instance</code><code class="p">()</code>
    <code class="n">run_func</code> <code class="o">=</code> <code class="n">partial</code><code class="p">(</code><code class="n">run_experiment</code><code class="p">,</code> <code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">result</code> <code class="o">=</code> <code class="n">_ioloop</code><code class="o">.</code><code class="n">run_sync</code><code class="p">(</code><code class="n">run_func</code><code class="p">)</code> <code class="c"># </code><a id="CO19-4"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO19-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
We can configure our HTTP client and pick what backend library we wish to use and how many requests we would like to batch together
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO19-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
We generate many futures and then yield back to the IO loop.  This function will resume and the future’s results set into the <code class="literal">responses</code> variable once all futures are filled.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO19-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
coroutines in tornado are backed by python generators.  In order to return a value from them, we must raise a special exception that <code class="literal">gen.coroutine</code> turns into a return value.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO19-4"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></a> </dt><dd><p>
<code class="literal">ioloop.run_sync</code> will start the IOLoop just for the duration of the runtime of the specified function.  ioloop.start(), on the otherhand, starts an IOLoop that must be terminated manually.
</p></dd></dl></div></div></div><p>An important difference between the tornado code from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_http">Example&nbsp;8-6</a> and
the gevent code from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_gevent_http">Example&nbsp;8-5</a> is when the event loop is running.
For gevent, the event loop is only running while the <code class="literal">iwait</code> function is
running.  On the other hand, in tornado the event loop is running the entire time
and controls the complete execution flow of the program, not just the
asynchronous IO parts.</p><p>This makes tornado ideal for applications that are mostly IO bound and where
most, if not all, of the application should be asynchronous.  This is where
tornado makes it’s biggest claim to fame, as a performant web server.  In fact,
this author has on many occasions written tornado backed databases and data
structures that require a lot of IO <sup>[<a id="id809708" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id809708" class="footnote">45</a>]</sup>.  On the other hand, since
gevent makes no requirements to your program as a whole, it is an ideal solution
for a mainly CPU based tasked that must sometimes do heavy IO.  For example, a
program which does a lot of computations over a dataset and then must send the
results back to the database for storage.  This becomes even simpler with the
fact that most databases have simple HTTP API’s which means you can even use
grequests.</p><p>This fact becomes even more explicit if we look at the more old-style tornado
code that utilizes callbacks in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_callback_http">Example&nbsp;8-7</a>.  We explicitly
see that in order to start the code we must add the entry point for our program
into the IO loop and then start it.  Then, in order for the program to
terminate, we must carefully carry around the <code class="literal">stop</code> function for our ioloop and
call it when appropriate.  As a result, programs that must explicitly carry
callbacks become incredibly burdensome and quickly unmaintainable.  One reason
this happens is that tracebacks can no longer hold valuable information about
what function called what and how we got into an exception to begin with.  Even
simply knowing which functions are called at all can become hard since we are
constantly making partial functions to fill in parameters.  It is no surprise
this if often called “callback hell”.</p><div class="example"><a id="conn_tornado_callback_http"></a><div class="example-title">Example&nbsp;8-7.&nbsp;Tornado crawler with callbacks</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">tornado</code> <code class="kn">import</code> <code class="n">ioloop</code>
<code class="kn">from</code> <code class="nn">tornado.httpclient</code> <code class="kn">import</code> <code class="n">AsyncHTTPClient</code>

<code class="kn">from</code> <code class="nn">functools</code> <code class="kn">import</code> <code class="n">partial</code>

<code class="n">AsyncHTTPClient</code><code class="o">.</code><code class="n">configure</code><code class="p">(</code><code class="s">"tornado.curl_httpclient.CurlAsyncHTTPClient"</code><code class="p">,</code> <code class="n">max_clients</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">fetch_urls</code><code class="p">(</code><code class="n">urls</code><code class="p">,</code> <code class="n">callback</code><code class="p">):</code>
    <code class="n">http_client</code> <code class="o">=</code> <code class="n">AsyncHTTPClient</code><code class="p">()</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="n">urls</code><code class="p">)</code>
    <code class="n">responses</code> <code class="o">=</code> <code class="p">[]</code>
    <code class="k">def</code> <code class="nf">_finish_fetch_urls</code><code class="p">(</code><code class="n">result</code><code class="p">):</code> <code class="c"># </code><a id="CO20-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
        <code class="n">responses</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="n">responses</code><code class="p">)</code> <code class="o">==</code> <code class="nb">len</code><code class="p">(</code><code class="n">urls</code><code class="p">):</code>
            <code class="n">callback</code><code class="p">(</code><code class="n">responses</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">url</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">:</code>
        <code class="n">http_client</code><code class="o">.</code><code class="n">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">callback</code><code class="o">=</code><code class="n">_finish_fetch_urls</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">,</code> <code class="n">callback</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">callback_passthrou</code> <code class="o">=</code> <code class="n">partial</code><code class="p">(</code><code class="n">_finish_run_experiment</code><code class="p">,</code>
            <code class="n">callback</code><code class="o">=</code><code class="n">callback</code><code class="p">)</code> <code class="c"># </code><a id="CO20-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">fetch_urls</code><code class="p">(</code><code class="n">urls</code><code class="p">,</code> <code class="n">callback_passthrou</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">_finish_run_experiment</code><code class="p">(</code><code class="n">responses</code><code class="p">,</code> <code class="n">callback</code><code class="p">):</code>
    <code class="n">response_sum</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">body</code><code class="p">)</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">responses</code><code class="p">)</code>
    <code class="k">print</code> <code class="n">response_sum</code>
    <code class="n">callback</code><code class="p">()</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="c">#... initialization ...</code>

    <code class="n">_ioloop</code> <code class="o">=</code> <code class="n">ioloop</code><code class="o">.</code><code class="n">IOLoop</code><code class="o">.</code><code class="n">instance</code><code class="p">()</code>
    <code class="n">_ioloop</code><code class="o">.</code><code class="n">add_callback</code><code class="p">(</code><code class="n">run_experiment</code><code class="p">,</code> <code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">,</code> <code class="n">_ioloop</code><code class="o">.</code><code class="n">stop</code><code class="p">)</code> <code class="c"># </code><a id="CO20-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">

    <code class="n">_ioloop</code><code class="o">.</code><code class="n">start</code><code class="p">()</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO20-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
We send <code class="literal">_ioloop.stop</code> as the callback to <code class="literal">run_experiment</code> so that once the experiment is done, it shuts off the ioloop for us.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO20-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
Callback-type async code has a lot of partial function creation.  This is because we often need to preserve the original callback we were sent even though we currently need to transfer the runtime to another function.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO20-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Sometimes games with scope are a necissary evil in order to preserve state while not cluttering the global namespace.
</p></dd></dl></div></div></div><p>Another interesting difference between gevent and tornado are the way the
internals change the request call graphs (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_request_time">Figure&nbsp;8-5</a> and
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_gevent_request_time">Figure&nbsp;8-4</a>).  For the gevent call graph we see some areas
where the diagonal line seems to get thinner, and others where it seems to get
much thicker.  The thinner regions show times when we are waiting for old
requests to finish before launching new ones.  On the other hand, the thicker
regions represent areas where we are too busy to read the responses from
requests that should have already finished.  Both these types of regions
represent times when the event loop isn’t doing its job optimally: times when we
are either under-utilizing our over-utilizing our resources.</p><p>On the other hand, the call graph for tornado is much more uniform.  This shows
that tornado is better able to optimize our resource use.  This can be
attributed to many things.  Firstly, since the semaphore logic limiting only 100
requests from being in the air at a time is internal to tornado it can better
allocate resources.  This includes pre-allocating and re-using connections in a
smarter way.</p><div class="figure"><a id="conn_tornado_request_time"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/tornado.png" alt="Request times for tornado scraper" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/tornado.png"></div></div><div class="figure-title">Figure&nbsp;8-5.&nbsp;Request Time for <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_http">Example&nbsp;8-6</a></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_asyncio">AsyncIO</h2></div></div></div><p>Drawing from the popularity of async functionality to deal with heavy IO
systems, Python 3.4+ introduced a revamping of the old <code class="literal">asyncio</code> standard
library module.  This module draws much of it’s influence from the <code class="literal">gevent</code> and
<code class="literal">tornado.gen</code> method of concurrency where coroutines are defined and yielded
from in order to halt the execution of the current function and allow other
coroutines to run.  Similar to <code class="literal">tornado</code>, the event loop is explicitly started
in order to start the execution of the coroutines.  In addition, python 3
introduced a new keyword, <code class="literal">yield from</code> which greatly simplifies dealing with
these coroutines (we no longer have to raise an exception to return a value from
a coroutine as we did in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_tornado_http">Example&nbsp;8-6</a>.</p><p>It is important to note that the <code class="literal">asyncio</code> library is very low level and does
not provide much higher level functionality to the user.  For example, while
there is a very full socket API, there is no easy way to do HTTP requests.  As a
result, we chose to use the <code class="literal">aiohttp</code> library in the following example.
However, the adoption of the <code class="literal">asyncio</code> library is just starting to ramp up and
the landscape of helper modules is probably going to be changing very quickly.</p><div class="example"><a id="conn_asyncio_http"></a><div class="example-title">Example&nbsp;8-8.&nbsp;AsyncIO HTTP Scraper</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">asyncio</code>
<code class="kn">import</code> <code class="nn">aiohttp</code>
<code class="kn">import</code> <code class="nn">random</code>
<code class="kn">import</code> <code class="nn">string</code>

<code class="k">def</code> <code class="nf">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_urls</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_urls</code><code class="p">):</code>
        <code class="k">yield</code> <code class="n">base_url</code> <code class="o">+</code> <code class="s">""</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_lowercase</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>

<code class="k">def</code> <code class="nf">chunked_http_client</code><code class="p">(</code><code class="n">num_chunks</code><code class="p">):</code>
    <code class="n">semaphore</code> <code class="o">=</code> <code class="n">asyncio</code><code class="o">.</code><code class="n">Semaphore</code><code class="p">(</code><code class="n">num_chunks</code><code class="p">)</code> <code class="c"># </code><a id="CO21-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="nd">@asyncio.coroutine</code>
    <code class="k">def</code> <code class="nf">http_get</code><code class="p">(</code><code class="n">url</code><code class="p">):</code> <code class="c"># </code><a id="CO21-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
        <code class="n">nonlocal</code> <code class="n">semaphore</code>
        <code class="k">with</code> <code class="p">(</code><code class="k">yield from</code> <code class="n">semaphore</code><code class="p">):</code>
            <code class="n">response</code> <code class="o">=</code> <code class="k">yield from</code> <code class="n">aiohttp</code><code class="o">.</code><code class="n">request</code><code class="p">(</code><code class="s">'GET'</code><code class="p">,</code> <code class="n">url</code><code class="p">)</code>
            <code class="n">body</code> <code class="o">=</code> <code class="k">yield from</code> <code class="n">response</code><code class="o">.</code><code class="n">content</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>
            <code class="k">yield from</code> <code class="n">response</code><code class="o">.</code><code class="n">wait_for_close</code><code class="p">()</code>
        <code class="k">return</code> <code class="n">body</code>
    <code class="k">return</code> <code class="n">http_get</code>

<code class="k">def</code> <code class="nf">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="o">=</code><code class="mi">500</code><code class="p">):</code>
    <code class="n">urls</code> <code class="o">=</code> <code class="n">generate_urls</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">)</code>
    <code class="n">http_client</code> <code class="o">=</code> <code class="n">chunked_http_client</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
    <code class="n">tasks</code> <code class="o">=</code> <code class="p">[</code><code class="n">http_client</code><code class="p">(</code><code class="n">url</code><code class="p">)</code> <code class="k">for</code> <code class="n">url</code> <code class="ow">in</code> <code class="n">urls</code><code class="p">]</code> <code class="c"># </code><a id="CO21-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">
    <code class="n">responses_sum</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">for</code> <code class="n">future</code> <code class="ow">in</code> <code class="n">asyncio</code><code class="o">.</code><code class="n">as_completed</code><code class="p">(</code><code class="n">tasks</code><code class="p">):</code> <code class="c"># </code><a id="CO21-4"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png">
        <code class="n">data</code> <code class="o">=</code> <code class="k">yield from</code> <code class="n">future</code>
        <code class="n">responses_sum</code> <code class="o">+=</code> <code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">responses_sum</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="kn">import</code> <code class="nn">time</code>
    <code class="n">delay</code> <code class="o">=</code> <code class="mi">100</code>
    <code class="n">num_iter</code> <code class="o">=</code> <code class="mi">500</code>
    <code class="n">base_url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?name=asyncio&amp;delay={}&amp;"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">delay</code><code class="p">)</code>
    <code class="n">loop</code> <code class="o">=</code> <code class="n">asyncio</code><code class="o">.</code><code class="n">get_event_loop</code><code class="p">()</code>

    <code class="n">start</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="n">result</code> <code class="o">=</code> <code class="n">loop</code><code class="o">.</code><code class="n">run_until_complete</code><code class="p">(</code><code class="n">run_experiment</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">num_iter</code><code class="p">))</code>
    <code class="n">end</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>
    <code class="k">print</code><code class="p">(</code><code class="s">"{} {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">end</code><code class="o">-</code><code class="n">start</code><code class="p">))</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO21-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
Similar to the <code class="literal">gevent</code> example, we must use a semaphore to limit the number of requests.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO21-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
We return a new coroutine that will asynchronously download files and respect the locking of the semaphore.
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO21-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
The <code class="literal">http_client</code> function returns futures.  To keep track of progress, we save the futures into a list
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO21-4"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/4.png" alt="4" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/4.png"></a> </dt><dd><p>
Similar to <code class="literal">gevent</code>, we can wait for futures to become ready and iterate over them.
</p></dd></dl></div></div></div><p>One of the fantastic benefits of the <code class="literal">asyncio</code> module is the compromise between
low level and high level functionality.  We are able to get the same sort of
results as we would with <code class="literal">tornado</code> or <code class="literal">gevent</code>, however if we wanted we could
dive deeper into the stack and make our own async protocols using a wide array
of supported structures.  In addition, being a standard library module, we are
assured that this module will always be PEP compliant and reasonably maintained.</p><p>Even though this support only comes with python 3.4 and higher <sup>[<a id="id812203" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id812203" epub:type="noteref" class="footnote">46</a>]</sup>,
this module at the very least is a great sign of more work in the future being
put into asynchronous IO.  As python starts dominating more and more processing
pipelines (from data processing to web request processing), this shift makes
perfect sense.</p><div class="figure"><a id="conn_asyncio_request_time"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/asyncio.png" alt="Request times for AsyncIO scraper" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/cralwer/images/asyncio.png"></div></div><div class="figure-title">Figure&nbsp;8-6.&nbsp;Request Time for <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_asyncio_http">Example&nbsp;8-8</a></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_database_example">Database Example</h2></div></div></div><p>To make the above examples more concrete, we will create another toy problem
that is mostly CPU bound but contains a potentially limiting IO component.  We
will be calculating primes and saving the found primes into a database.  This
amorphous database could be anything and relates to a much more relevant problem
in which your program has heavy calculation it must do, but solutions to these
calculations must be communicated to a database and maybe incure a heavy IO
penalty.  The only restrictions we are putting on our database are,</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
It has an HTTP API so that we can use similar code from above <sup>[<a id="id812332" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id812332" epub:type="noteref" class="footnote">47</a>]</sup>
</li><li class="listitem">
Response times are on the order of 50ms
</li><li class="listitem">
The database can satisfy many requests at a time <sup>[<a id="id812269" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#ftn.id812269" epub:type="noteref" class="footnote">48</a>]</sup>
</li></ul></div><p>We start with a simple code that calculates primes and makes a request to the
databases’s HTTP API every time a prime is found.</p><pre class="programlisting"><code class="kn">from</code> <code class="nn">tornado.httpclient</code> <code class="kn">import</code> <code class="n">HTTPClient</code>
<code class="kn">import</code> <code class="nn">math</code>

<code class="n">httpclient</code> <code class="o">=</code> <code class="n">HTTPClient</code><code class="p">()</code>
<code class="k">def</code> <code class="nf">save_prime_serial</code><code class="p">(</code><code class="n">prime</code><code class="p">):</code>
    <code class="n">url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?prime={}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">prime</code><code class="p">)</code>
    <code class="n">response</code> <code class="o">=</code> <code class="n">httpclient</code><code class="o">.</code><code class="n">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>
    <code class="n">finish_save_prime</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="n">prime</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">finish_save_prime</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="n">prime</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">response</code><code class="o">.</code><code class="n">code</code> <code class="o">!=</code> <code class="mi">200</code><code class="p">:</code>
        <code class="k">print</code> <code class="s">"Error saving prime: {}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">prime</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">check_prime</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">number</code> <code class="o">%</code> <code class="mi">2</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
        <code class="k">return</code> <code class="bp">False</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="nb">int</code><code class="p">(</code><code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">number</code><code class="p">))</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">number</code> <code class="o">%</code> <code class="n">i</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">return</code> <code class="bp">False</code>
    <code class="k">return</code> <code class="bp">True</code>

<code class="k">def</code> <code class="nf">calculate_primes_serial</code><code class="p">(</code><code class="n">max_number</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">number</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">max_number</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">check_prime</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
            <code class="n">save_prime_serial</code><code class="p">(</code><code class="n">number</code><code class="p">)</code>
    <code class="k">return</code></pre><p>Just as in our <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_serial_http">Example&nbsp;8-3</a>, the request time for each database save
(50ms) does no stack and just we must pay this penalty for each prime we find.
As a result, searching up to <code class="literal">max_number = 8,192</code> (which results in 1028 primes)
takes 55.2s.  We know, however, that because of the way our serial requests
work, we are spending 51.4s at minimum doing IO!  So, simply because we are
pausing our program while doing IO we are wasting 93% of our time!</p><p>What we want to do instead is to find a way to change our request scheme so that
we can issue many requests asynchronously at a time so that we don’t have such a
burdensome IO wait.  In order to do this, we create an <code class="literal">AsyncBatcher</code> class
which takes care of batching requests for us and making the requests when
necissary.</p><pre class="programlisting"><code class="kn">import</code> <code class="nn">grequests</code>
<code class="kn">from</code> <code class="nn">itertools</code> <code class="kn">import</code> <code class="n">izip</code>

<code class="k">class</code> <code class="nc">AsyncBatcher</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="n">__slots__</code> <code class="o">=</code> <code class="p">[</code><code class="s">"batch"</code><code class="p">,</code> <code class="s">"batch_size"</code><code class="p">,</code> <code class="s">"save"</code><code class="p">,</code> <code class="s">"flush"</code><code class="p">]</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">batch_size</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch_size</code> <code class="o">=</code> <code class="n">batch_size</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch</code> <code class="o">=</code> <code class="p">[]</code>

    <code class="k">def</code> <code class="nf">save</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">prime</code><code class="p">):</code>
        <code class="n">url</code> <code class="o">=</code> <code class="s">"http://127.0.0.1:8080/add?prime={}"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">prime</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch</code><code class="o">.</code><code class="n">append</code><code class="p">((</code><code class="n">url</code><code class="p">,</code><code class="n">prime</code><code class="p">))</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">batch</code><code class="p">)</code> <code class="o">==</code> <code class="bp">self</code><code class="o">.</code><code class="n">batch_size</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">flush</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">flush</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">responses_futures</code> <code class="o">=</code> <code class="p">(</code><code class="n">grequests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">url</code><code class="p">)</code> <code class="k">for</code> <code class="n">url</code><code class="p">,</code> <code class="n">_</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">batch</code><code class="p">)</code>
        <code class="n">responses</code> <code class="o">=</code> <code class="n">grequests</code><code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="n">responses_futures</code><code class="p">)</code>
        <code class="k">for</code> <code class="n">response</code><code class="p">,</code> <code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">prime</code><code class="p">)</code> <code class="ow">in</code> <code class="n">izip</code><code class="p">(</code><code class="n">responses</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">batch</code><code class="p">):</code>
            <code class="n">finish_save_prime</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="n">prime</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch</code> <code class="o">=</code> <code class="p">[]</code></pre><p>Now, we can proceed almost in the same way as we did before.  The only main
differences is that we add our new primes to our <code class="literal">AsyncBatcher</code> and let it take
care of when to send the requests.  In addition, since we are batching we must
make sure to send the last batch even if it is not full yet (which means making
a call to <code class="literal">AsyncBatcher.flush()</code>).</p><pre class="programlisting"><code class="k">def</code> <code class="nf">calculate_primes_async</code><code class="p">(</code><code class="n">max_number</code><code class="p">):</code>
    <code class="n">batcher</code> <code class="o">=</code> <code class="n">AsyncBatcher</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code> <code class="c"># </code><a id="CO22-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="k">for</code> <code class="n">number</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="n">max_number</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">check_prime</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
            <code class="n">batcher</code><code class="o">.</code><code class="n">save</code><code class="p">(</code><code class="n">number</code><code class="p">)</code>
    <code class="n">batcher</code><code class="o">.</code><code class="n">flush</code><code class="p">()</code>
    <code class="k">return</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#CO22-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
We choose to batch at 100 requests for similar reasons as from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_num_concurrent_requests">Figure&nbsp;8-3</a>
</p></dd></dl></div><p>With this change, we are able to bring our runtime for <code class="literal">max_number = 8,192</code> down
to 4.09s.  This represents a 13.5x speedup without having to do much work.  In a
constrained environment such as a realtime data pipeline, this extra speed could
mean the difference between a system being able to keep up with demand and
simply not keeping up.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#conn_primes">Figure&nbsp;8-7</a> we can see a summary of how these changes effect the runtime
of our code for different number of of workloads.  The speedups are quite great
between the serial and the async code, although we are still a ways away from
the raw CPU problem.  For this to be completely remedied, we would need to use
modules like <code class="literal">multiprocessing</code> to have a completely separate process that can
deal with the IO burden of our program without slowing down the CPU portion of
the problem.</p><div class="figure"><a id="conn_primes"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 378; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/examples/concurrency/primes/images/primes.png" alt="Processing time difference between serial IO, async IO and IO disabled" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/examples/concurrency/primes/images/primes.png"></div></div><div class="figure-title">Figure&nbsp;8-7.&nbsp;Processing times for different number of primes</div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_wrap_up_6">Wrap Up</h2></div></div></div><p>When solving problems in real world and production systems, it is often
necessary to communicate to some outside source.  This outside source could be a
database running on another server, another worker computer or a data service
that is providing the raw data that must be processed.  Whenever this is the
case, your problem can quickly become IO bound meaning that most of the runtime
is dominated by dealing with input/output.</p><p>Concurrency helps IO bound problems by allowing you to interleave computation
with potentially multiple IO operations.  This allows you to exploit the
fundamental difference between IO and CPU operations in order to speed up
overall runtime.</p><p>As we saw, <code class="literal">gevent</code> provides the highest level interface for asynchronous IO.
On the other hand, <code class="literal">tornado</code> lets you manually control how the event loop is
running, allowing you to use the event loop to schedule any sort of task you
want.  Finally, <code class="literal">asyncio</code> in Python3.4+ allows full control of an asynchronous
IO stack.  In addition to the various levels of abstraction, every library uses
a different paradigm for it’s syntax (namely from the lack of native support for
concurrency before Python 3 and the introduction of the <code class="literal">yield from</code> statement).
We recommend gaining some experience in a range of methods and picking one based
on how much low-level control is necessary.</p><p>Finally, there are small speed differenes between the three libraries we
approached.  Many of these speed differences are based on how coroutines are
scheduled: <code class="literal">tornado</code> does an incredible job at launching asynchronous operations
and resuming the coutine quickly.  On the otherhand, even though <code class="literal">asyncio</code> seems
to perform slightly worse, it allows much lower access into the API and can be
tuned dramatically.</p><p>In the next chapter, we will take this concept of interleaving computation from
IO bound problems to CPU bound problems.  Adding this new ability will allows us
to not only perform multiple IO operations at once but also many computational
operations.  By doing this, we start to be able to make fully scalable programs
where more speed can be achieved by simply adding more computer resources which
can take a chunk of the problem.</p></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" epub:type="footnote" id="ftn.id806261"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id806261" class="simpara">44</a>] </sup>Some databases, such as
redis, do this specifically to maintain atomicity in it’s operations</p></div><div class="footnote" id="ftn.id809708"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id809708" class="simpara">45</a>] </sup>For example, fuggetaboutit is a
special type of probabilistic datastructure (<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_prob_ds">Probabilistic data structures</a>) that uses the
tornado ioloop to schedule time-based tasks.
<a class="ulink" href="https://github.com/mynameisfiber/fuggetaboutit" target="_top">https://github.com/mynameisfiber/fuggetaboutit</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id812203"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id812203" class="simpara">46</a>] </sup>Most
performance applications and moduels are still in the python 2.7 ecosystem</p></div><div class="footnote" epub:type="footnote" id="ftn.id812332"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id812332" class="simpara">47</a>] </sup>This is not necissary, it just serves to simplify our code</p></div><div class="footnote" epub:type="footnote" id="ftn.id812269"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#id812269" class="simpara">48</a>] </sup>This is true for all distributed databases and other popular databases such as postgres, mongodb, riak, etc.</p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/high-performance-python/9781449361747/ch07.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">7. Compiling to C</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/high-performance-python/9781449361747/ch09.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">9. The multiprocessing module</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch08.html" data-for-analytics="9781449361747:ch08.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch08.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>
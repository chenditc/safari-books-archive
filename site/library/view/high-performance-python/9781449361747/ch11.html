<!--[if IE]><![endif]--><!DOCTYPE html><!--[if IE 8]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

    
        itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage"" data-login-url="/accounts/login/"
data-offline-url="/"
data-url="/library/view/high-performance-python/9781449361747/ch11.html"
data-csrf-cookie="csrfsafari"
data-highlight-privacy=""


  data-user-id="859452"
  data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36"
  data-username="dchen267"
  data-account-type="B2B"
  
  data-activated-trial-date="04/25/2016"


  data-archive="9781449361747"
  data-publishers="O&#39;Reilly Media, Inc."



  data-htmlfile-name="ch11.html"
  data-epub-title="High Performance Python" data-debug=0 data-testing=0><![endif]--><!--[if gt IE 8]><!--><html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom gr__safaribooksonline_com" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/high-performance-python/9781449361747/ch11.html" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="859452" data-user-uuid="4d373bec-fada-4717-9823-769db3ed3a36" data-username="dchen267" data-account-type="B2B" data-activated-trial-date="04/25/2016" data-archive="9781449361747" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch11.html" data-epub-title="High Performance Python" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781449361747"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900,200italic,300italic,400italic,600italic,700italic,900italic" rel="stylesheet" type="text/css"><title>11. Using Less RAM - High Performance Python</title><link rel="stylesheet" href="https://www.safaribooksonline.com/static/CACHE/css/e4b0fef39b55.css" type="text/css"><link rel="stylesheet" type="text/css" href="https://www.safaribooksonline.com/static/css/annotator.min.fd58f69f4908.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style><link rel="canonical" href="/site/library/view/high-performance-python/9781449361747/ch11.html"><meta name="description" content="Chapter&nbsp;11.&nbsp;Using Less RAM Questions you’ll be able to answer after this chapter Why should we use less RAM? Why are numpy and array better for storing lots ... "><meta property="og:title" content="11. Using Less RAM"><meta itemprop="isPartOf" content="/library/view/high-performance-python/9781449361747/"><meta itemprop="name" content="11. Using Less RAM"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449361747/"><meta property="og:description" itemprop="description" content="Chapter&nbsp;11.&nbsp;Using Less RAM Questions you’ll be able to answer after this chapter Why should we use less RAM? Why are numpy and array better for storing lots ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="O'Reilly Media, Inc."><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781449361594"><meta property="og:book:author" itemprop="author" content="Ian Ozsvald"><meta property="og:book:author" itemprop="author" content="Micha Gorelick"><meta property="og:book:tag" itemprop="about" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: <%= font_size %> !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: <%= font_family %> !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: <%= column_width %>% !important; margin: 0 auto !important; }"></style><!--[if lt IE 9]><script src="/static/js/src/respond.min.cf5c9b7980e5.js"></script><![endif]--><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library" data-gr-c-s-loaded="true">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        




<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#container" class="skip">Skip to content</a><header class="topbar t-topbar" style="display:None"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z" fill="currentColor"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z" fill="currentColor"></path></g></svg><span>Queue</span></a></li><li class="search"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z" fill="currentColor"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z" fill="currentColor"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z" fill="currentColor"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z" fill="currentColor"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" version="1.1" fill="#4A3C31"><desc>offers icon</desc><path d="M10.8 43.7L0 39 0 10.2 13.6 4.6 23.3 8.7 11.5 13.5C11 13.6 10.8 13.9 10.8 14.3L10.8 43.7 10.8 43.7Z"></path><polygon points="12.3 44.4 25 50 38 44.3 38 14.7 25.2 9.4 12.3 14.7 12.3 44.4"></polygon><path d="M36.6 4.7L50 10.2 50 39 39.5 43.6 39.5 14.3C39.5 13.8 39.2 13.6 38.8 13.5L27 8.7 36.6 4.7 36.6 4.7Z"></path><polygon points="34.8 4 25 0 15.4 3.9 25.2 7.9 34.8 4"></polygon></svg><span>Offers</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-conferences/" class="l2 nav-icn"><span>Conferences</span></a></li><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletter</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/003o000000t5q9fAAA/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z" fill="currentColor"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l1 no-icon">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z" fill="currentColor"></path></g></svg><span>Settings</span></a></li><li><a href="https://community.safaribooksonline.com/" class="l2">Feedback</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      High Performance Python
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch11.html" data-for-analytics="9781449361747:ch11.html"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html&amp;text=High%20Performance%20Python&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%2011.%20Using%20Less%20RAM&amp;body=https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/ch11.html%0D%0Afrom%20High%20Performance%20Python%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
      
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="/site/library/view/high-performance-python/9781449361747/ch10.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">10. Clusters and Job Queues</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="/site/library/view/high-performance-python/9781449361747/ch12.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">12. Lessons from the Field</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><section class="chapter" epub:type="chapter" id="chapter-lessram"><div class="titlepage"><div><div><h2 class="title">Chapter&nbsp;11.&nbsp;Using Less RAM</h2></div></div></div><div class="sidebar"><div class="sidebar-title">Questions you’ll be able to answer after this chapter</div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Why should we use less RAM?
</li><li class="listitem">
Why are numpy and array better for storing lots of numbers?
</li><li class="listitem">
How can lots of text be efficiently stored in RAM?
</li><li class="listitem">
How could we count (approximately!) to 1e77 using just 1 byte?
</li><li class="listitem">
What are Bloom Filters and why might we need them?
</li></ul></div></div><p>You rarely think about how much RAM you’re using until you run out of it. If you run out whilst scaling your code it can become a sudden blocker. Fitting more into a machine’s RAM means fewer machines to manage and it gives you a route to planning capacity for larger projects. Knowing why RAM gets eaten up and considering more efficient ways to use this scarce resource will help you deal with scaling issues.</p><p>Another route to saving RAM is to use containers that utilize features in your data for compression. We’ll look at Tries and a DAWG that can compress a 1.1GB set of strings down to just 254MB with little change in performance. A third approach is to trade storage for accuracy. For this we’ll look at approximate counting and approximate set membership which use dramatically less RAM than their exact counterparts.</p><p>A consideration with RAM usage is the notion that “data has mass” - the more there is of it, the slower it moves around. If you can be parsimonious in your use of RAM then your data will probably get consumed faster as it’ll move around buses faster and more of it will fit into constrained caches. If you need to store it in off-line storage (e.g. a hard-drive or a remote data cluster) then it’ll move far more slowly to your machine. Try to choose appropriate data structures so it can fit onto one machine.</p><p>Counting the amount of RAM used by Python objects is surprisingly tricky. Behind the
scenes we don’t necessarily know how an object is represented and if we ask the
Operating System for a count of bytes used it will tell us about the total
amount allocated to the process. In both cases we can’t see exactly how each
individual Python object adds to the total.</p><p>As some objects and libraries
don’t report their full internal allocation of bytes (or they wrap external
libraries which do not report their allocation at all), this has to be a case of
best-guessing. The following approaches help us to decide on the best way to
represent our data so we use less RAM overall.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_objects_for_primitives_are_emphasis_expensive_emphasis">Objects for primitives are <span class="emphasis"><em>expensive</em></span></h2></div></div></div><p>Typically we work with containers like the <code class="literal">list</code> and we store hundreds or thousands of items. As soon as you store a large number, RAM usage becomes an issue.</p><p>A <code class="literal">list</code> with 100,000,000 items consumes approximately 760MB <span class="emphasis"><em>if the items are
the same object</em></span>. If we store 100,000,000 <span class="emphasis"><em>different</em></span> items (e.g. unique integers) then we can expect to use gigabytes of RAM! Each unique object has a memory cost.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-1e8-same-items">Example&nbsp;11-1</a> we’ll store many <code class="literal">0</code> integers in a <code class="literal">list</code>. Roughly the same memory cost will occur if we store 100,000,000 of the same item as each item in the list is just a reference to the same underlying object. Refer back to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch02.html#memory_profiler">memory_profiler for diagnosing memory usage</a> for a reminder on how to use <code class="literal">memory_profiler</code>, here we load it as a new magic function in IPython using <code class="literal">%load_ext memory_profiler</code>.</p><div class="example"><a id="lessram-memory-profiler-1e8-same-items"></a><div class="example-title">Example&nbsp;11-1.&nbsp;Measuring memory usage of 100,000,000 of the same integer in a list</div><div class="example-contents"><pre class="screen">In [1]: %load_ext memory_profiler  # load the %memit magic function
In [2]: %memit [0]*int(1e8)
peak memory: 790.64 MiB, increment: 762.91 MiB</pre></div></div><div class="warning" epub:type="warning"><h3 class="title">Warning</h3><p>Memory can be cached in the running process, it is always safer to exit and
restart the Python shell when using <code class="literal">memit</code> for profiling.</p></div><p>A fresh IPython shell consumes approximately 20MB of RAM. We can create a
temporary list of 100,000,000 <span class="emphasis"><em>unique</em></span> numbers and in total this consumes
approximately 3.1GB.</p><p>After the <code class="literal">memit</code> command finishes in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-1e8-different-items">Example&nbsp;11-2</a> the temporary list is
deallocated and the second call to <code class="literal">memit</code> shows that the memory usage stays at
approximately 2.3GB.</p><div class="tip"><h3 class="title">Tip</h3><p>Before reading the answer - why might the Python process still hold 2.3GB of RAM? What’s left behind even though the <code class="literal">list</code> has gone to the garbage collector?</p></div><div class="example"><a id="lessram-memory-profiler-1e8-different-items"></a><div class="example-title">Example&nbsp;11-2.&nbsp;Measuring memory usage of 100,000,000 different integers in a list</div><div class="example-contents"><pre class="screen"># we use a new IPython shell so we have a clean memory
In [1]: %load_ext memory_profiler
In [2]: %memit  # show how much RAM this process is consuming right now
peak memory: 20.05 MiB, increment: 0.03 MiB
In [3]: %memit [n for n in xrange(int(1e8))]
peak memory: 3127.53 MiB, increment: 3106.96 MiB
In [4]: %memit
peak memory: 2364.81 MiB, increment: 0.00 MiB</pre></div></div><p>The 100,000,000 integer objects occupy the majority of the 2.3GB even though they’re no longer being used. Python caches primitive objects like integers for later use, on a system with constrained RAM this can cause problems so you should be aware that these primitives may build up in the cache.</p><p>A subsequent <code class="literal">memit</code> in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-1e8-different-items2">Example&nbsp;11-3</a> to create a second 100,000,000 item list consumes
approximately 760MB, this takes the overall allocation during this call back up
to approximately 3.1GB. The 760MB is for the container alone and as the underlying
Python integer objects already exist - they’re in the cache so they get reused.</p><div class="example"><a id="lessram-memory-profiler-1e8-different-items2"></a><div class="example-title">Example&nbsp;11-3.&nbsp;Measuring memory usage again for 100,000,000 different integers in a list</div><div class="example-contents"><pre class="screen">In [5]: %memit [n for n in xrange(int(1e8))]
peak memory: 3127.52 MiB, increment: 762.71 MiB</pre></div></div><p>Next we’ll see that we can use the <code class="literal">array</code> module to store 100,000,000 integers far more cheaply.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_the_literal_array_literal_module_stores_many_primitive_objects_cheaply">The <code class="literal">array</code> module stores many primitive objects cheaply</h3></div></div></div><p>The <code class="literal">array</code> module efficiently stores primitive types like integers, floats and
characters but <span class="emphasis"><em>not</em></span> complex numbers or classes. It creates a contiguous block of RAM to hold the underlying data.</p><p>Below we allocate 100,000,000
integers (8 bytes each) into a contiguous chunk of memory, in total
approximately 760MiB is consumed by the process. The difference between this
approach and the previous list-of-unique-integers approach is <code class="literal">2300MiB - 760MiB
== 1.5GiB</code>. This is a huge saving in RAM.</p><p>The unique numbers in the <code class="literal">array</code> are <span class="emphasis"><em>not</em></span> Python objects, they are
bytes in the <code class="literal">array</code>, if we were to dereference any of them then a new Python
<code class="literal">int</code> object would be constructed. If you’re going to compute on them then no overall saving will occur but if instead you’re going to pass the array to an external process or use only some of data, you should see a good saving in RAM compared to using a list of integers.</p><div class="example"><a id="lessram-array1"></a><div class="example-title">Example&nbsp;11-4.&nbsp;Building an array of 100,000,000 integers with 760MB of RAM</div><div class="example-contents"><pre class="screen">In [1]: %load_ext memory_profiler
In [2]: import array
In [3]: %memit array.array('l', xrange(int(1e8)))
peak memory: 781.03 MiB, increment: 760.98 MiB
In [4]: arr = array.array('l')
In [5]: arr.itemsize
Out[5]: 8</pre></div></div><div class="note"><h3 class="title">Note</h3><p>If you’re working with a large array or matrix of numbers with Cython and you don’t want an external dependency on <code class="literal">numpy</code>, be aware that you can store your data in an <code class="literal">array</code> and pass it into Cython for processing without any addition memory overhead.</p></div><p>The <code class="literal">array</code> module works with a limited set of datatypes with varying precisions.
Choose the smallest precision that you need so you allocate just as much RAM as
needed and no more. Be aware that the byte-size is platform dependent, the sizes
here refer to a 32 bit platform (it states <span class="emphasis"><em>minimum</em></span> size) whilst I’m running on
a 64 bit laptop.</p><div class="example"><a id="lessram-array2"></a><div class="example-title">Example&nbsp;11-5.&nbsp;The basic types provided by the array module</div><div class="example-contents"><pre class="screen">In [5]: array?  # IPython magic, similar to help(array)
Type:       module
String Form:&lt;module 'array' (built-in)&gt;
Docstring:
This module defines an object type which can efficiently represent
an array of basic values: characters, integers, floating point
numbers.  Arrays are sequence types and behave very much like lists,
except that the type of objects stored in them is constrained.  The
type is specified at object creation time by using a type code, which
is a single character.  The following type codes are defined:

    Type code   C Type             Minimum size in bytes
    'c'         character          1
    'b'         signed integer     1
    'B'         unsigned integer   1
    'u'         Unicode character  2
    'h'         signed integer     2
    'H'         unsigned integer   2
    'i'         signed integer     2
    'I'         unsigned integer   2
    'l'         signed integer     4
    'L'         unsigned integer   4
    'f'         floating point     4
    'd'         floating point     8

The constructor is:

array(typecode [, initializer]) -- create a new array</pre></div></div><p><code class="literal">numpy</code> has arrays that can hold a wider range of datatypes - you have more
control over the number of bytes per item and you can use complex numbers and
datetime objects.  A <code class="literal">complex128</code> object takes 16 bytes per item, each item is a
pair of 8 byte floating point numbers. You can’t store <code class="literal">complex</code> objects in a Python array but they come for free with <code class="literal">numpy</code>. If you’d like a refresher on <code class="literal">numpy</code> then look back to <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html">Chapter&nbsp;6</a>.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-numpy1">Example&nbsp;11-6</a> you can see an additional feature of <code class="literal">numpy</code> arrays - you can query for the number of items, the size of each primitive and the combined total storage of the underlying block of RAM. Note that this doesn’t include the overhead of the Python object (typically this is tiny in comparison to the data you store in the arrays).</p><div class="example"><a id="lessram-numpy1"></a><div class="example-title">Example&nbsp;11-6.&nbsp;Storing more complex types in a numpy array</div><div class="example-contents"><pre class="screen">In [1]: %load_ext memory_profiler
In [2]: import numpy as np
In [3]: %memit arr=np.zeros(1e8, np.complex128)
peak memory: 1552.48 MiB, increment: 1525.75 MiB
In [4]: arr.size  # same as len(arr)
Out[4]: 100000000
In [5]: arr.nbytes
Out[5]: 1600000000
In [6]: arr.nbytes/arr.size  # bytes per item
Out[6]: 16
In [7]: arr.itemsize  # another way of checking
Out[7]: 16</pre></div></div><p>Using a regular <code class="literal">list</code> to store many numbers is much less efficient in RAM than
using an <code class="literal">array</code> object. This means more memory allocations have to occur which
each take time, calculations occur on larger objects which will be less cache
friendly and that more RAM is used overall so less RAM is available to other
programs.</p><p>However - if you do any work on the contents of the <code class="literal">array</code> in Python then the primitives are likely to be converted into temporary objects, negating their benefit. Using them as a data store when communicating with other processes is a strong benefit of the <code class="literal">array</code>.</p><p><code class="literal">numpy</code> arrays are almost certainly a better choice if you are doing anything
heavily numeric as you get more datatype options and many specialised and fast
functions. You might choose to avoid <code class="literal">numpy</code> if you want fewer dependencies for
your project. Cython and Pythran work equally well with <code class="literal">array</code> and <code class="literal">numpy</code>
arrays, Numba works with <code class="literal">numpy</code> arrays only.</p><p>Python provides a few other tools to understand memory usage.</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_understanding_the_ram_used_in_a_collection">Understanding the RAM used in a collection</h2></div></div></div><p>You may wonder if you can ask Python about the RAM that’s used by each object. Python’s <code class="literal">sys.getsizeof(obj)</code> call will tell us <span class="emphasis"><em>something</em></span> about the memory used by an object (most
but not all objects provide this). If you haven’t seen it before then be warned
that it won’t give you the answer you’d expect for a container!</p><p>Let’s start by looking at some primitive types. An <code class="literal">int</code> in Python is a variable
sized object, it starts as a regular integer and turns into a Long integer if
you count above <code class="literal">sys.maxint</code> (on my 64 bit laptop this is
9,223,372,036,854,775,807).</p><p>As a regular integer it takes 24 bytes (the object has a lot of
overhead), as a Long integer it consumes 36 bytes.</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="nb">int</code><code class="p">())</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="mi">24</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="mi">24</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">n</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">maxint</code><code class="o">+</code><code class="mi">1</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">n</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="mi">36</code></pre><p>We can do the same check for byte strings. An empty string costs 37 bytes, each
additional byte adds one byte to the cost.</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">b</code><code class="s">""</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="mi">37</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">b</code><code class="s">"a"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="mi">38</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">23</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">b</code><code class="s">"ab"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">23</code><code class="p">]:</code> <code class="mi">39</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">(</code><code class="n">b</code><code class="s">"cde"</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="mi">40</code></pre><p>When we use a list we see different behavior. It isn’t counting the cost of the
contents of the list, just the cost of the list itself. An empty list costs 72
bytes, each item in the list takes another 8 bytes on my 64 bit laptop.</p><pre class="programlisting"><code class="c"># goes up in 8 byte steps rather than the 24 we might expect!</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">36</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">36</code><code class="p">]:</code> <code class="mi">72</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">37</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="mi">1</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">37</code><code class="p">]:</code> <code class="mi">80</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">38</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">38</code><code class="p">]:</code> <code class="mi">88</code></pre><p>This is more obvious if we use byte strings - we’d expect to see much larger
costs than <code class="literal">getsizeof</code> is reporting.</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">40</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="n">b</code><code class="s">""</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">40</code><code class="p">]:</code> <code class="mi">80</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">41</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="n">b</code><code class="s">"abcdefghijklm"</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">41</code><code class="p">]:</code> <code class="mi">80</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">42</code><code class="p">]:</code> <code class="n">sys</code><code class="o">.</code><code class="n">getsizeof</code><code class="p">([</code><code class="n">b</code><code class="s">"a"</code><code class="p">,</code> <code class="n">b</code><code class="s">"b"</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">42</code><code class="p">]:</code> <code class="mi">88</code></pre><p><code class="literal">getsizeof</code> only reports some of the cost and often just for the parent object. As noted before it isn’t always implemented, so it can have limited usefulness.</p><p>A slightly better tool is <code class="literal">asizeof</code> <sup>[<a id="id825207" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id825207" class="footnote">113</a>]</sup> which will walk a
container’s hierarchy and attempt to get the best guess of the size of each
object it finds, adding them to a total. Be warned that it is quite slow.</p><p>It makes some guesses and assumptions, it also cannot count memory allocated
<span class="emphasis"><em>behind the scenes</em></span> (e.g. a module that wraps a C library may not report the
bytes allocated in the C library). It is best to use this as a guide. I prefer
to use <code class="literal">memit</code> as I get an accurate count of memory usage on the machine in
question.</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="o">%</code><code class="n">run</code> <code class="n">asizeof</code><code class="o">.</code><code class="n">py</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">asizeof</code><code class="p">([</code><code class="n">b</code><code class="s">"abcdefghijklm"</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="mi">136</code></pre><p>We can check the estimate for a large list - here we’ll use 10,000,000 integers.</p><pre class="programlisting"><code class="c"># this takes 30 seconds to run!</code>
<code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="n">asizeof</code><code class="p">([</code><code class="n">x</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">10000000</code><code class="p">)])</code>  <code class="c"># 1e7 integers</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="mi">321528064</code></pre><p>We can validate this estimate by using <code class="literal">memit</code> to see how the process grew, in
this case the numbers are very similar:</p><pre class="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="o">%</code><code class="n">memit</code><code class="p">([</code><code class="n">x</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">10000000</code><code class="p">)])</code>
<code class="n">peak</code> <code class="n">memory</code><code class="p">:</code> <code class="mf">330.64</code> <code class="n">MiB</code><code class="p">,</code> <code class="n">increment</code><code class="p">:</code> <code class="mf">310.62</code> <code class="n">MiB</code></pre><p>Generally the <code class="literal">asizeof</code> process is slower than using <code class="literal">memit</code> but <code class="literal">asizeof</code> can
be useful when analysing small objects. <code class="literal">memit</code> is probably more useful for
real-world applications as the actual memory usage of the process is measured
rather than inferred.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_bytes_vs_unicode">Bytes vs Unicode</h2></div></div></div><p>One of the compelling reasons to switch to Python 3.3+ is that Unicode object storage is significantly cheaper than it is in Python 2.7. If you mainly handle lots of strings and they eat a lot of RAM, definitely consider a move to Python 3.3+. You get this RAM saving absolutely for free.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-stringvsunicode1">Example&nbsp;11-7</a> we can see a 100,000,000 character sequence being built as a collection of bytes (this is the same as a regular <code class="literal">str</code> in Python 2.7) and a Unicode object. The Unicode variant takes four times as much RAM. Every Unicode character costs the same higher price regardless of the number bytes required to represent the underlying data.</p><div class="example"><a id="lessram-memory-profiler-stringvsunicode1"></a><div class="example-title">Example&nbsp;11-7.&nbsp;Unicode objects are expensive in Python 2.7</div><div class="example-contents"><pre class="screen">In [1]: %load_ext memory_profiler
In [2]: %memit b"a" * int(1e8)
peak memory: 100.98 MiB, increment: 80.97 MiB
In [3]: %memit u"a" * int(1e8)
peak memory: 380.98 MiB, increment: 360.92 MiB</pre></div></div><p>The UTF-8 encoding of a Unicode object uses 1 byte per ASCII character and more bytes for less frequently seen characters. Python 2.7 uses an equal number of bytes for a Unicode character regardless of the character’s prevalence. If you’re not sure about Unicode encodings versus Unicode objects then go and watch Net Batchelder’s “Pragmatic Unicode - Or How Do I Stop The Pain?” <sup>[<a id="id825696" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id825696" class="footnote">114</a>]</sup>.</p><p>From Python 3.3 we have a flexible Unicode representation thanks to PEP 393
<sup>[<a id="id825718" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id825718" class="footnote">115</a>]</sup>. It works by observing the range of characters in the string and using a smaller number of bytes to represent the lower order characters if possible.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#lessram-memory-profiler-stringvsunicode2">Example&nbsp;11-8</a> you can see that the cost of the byte and Unicode versions of an ASCII character are the same and that using a non-ASCII character (sigma) the memory usage only doubles - this is still better than the Python 2.7 situation.</p><div class="example"><a id="lessram-memory-profiler-stringvsunicode2"></a><div class="example-title">Example&nbsp;11-8.&nbsp;Unicode objects are far cheaper in Python 3.3+</div><div class="example-contents"><pre class="screen">Python 3.3.2+ (default, Oct  9 2013, 14:50:09)
IPython 1.2.0 -- An enhanced Interactive Python.
...
In [1]: %load_ext memory_profiler
In [2]: %memit b"a" * int(1e8)
peak memory: 91.77 MiB, increment: 71.41 MiB
In [3]: %memit u"a" * int(1e8)
peak memory: 91.54 MiB, increment: 70.98 MiB
In [4]: %memit u"Σ" * int(1e8)
peak memory: 174.72 MiB, increment: 153.76 MiB</pre></div></div><p>Given that Unicode objects are default in Python 3.3+, if you work with lots of string data then you’ll almost certainly benefit from the upgrade. The lack of cheap string storage was a hindrance for some in the early Python 3.1+ days, now with PEP 393 this is absolutely not an issue.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_efficiently_storing_lots_of_text_in_ram">Efficiently storing lots of text in RAM</h2></div></div></div><p>A common problem with text is that it occupies a lot of RAM, if we want to test
if we have seen strings before or count their frequency then it is convenient to
have them in RAM rather than paging them to and from a disk. Storing the strings
naively is expensive but Tries and Directed Acyclic Word Graphs (DAWGs) can be
used to compress their representation and still allow fast operations.</p><p>These more advanced algorithms can save you a significant amount of RAM which means that you might not need to expand to more servers - for production systems the savings can be huge. In this section we’ll look at compressing a <code class="literal">set</code> of strings costing 1.1GB down to 254MB using a Trie, with only a small change in performance.</p><p>For the following section we’ll use a text set built from a partial dump of
WikiPedia. This set contains 8,545,076 unique tokens from a portion of the English WikiPedia and is 111,707,546 (111MB) on disk.</p><p>The tokens are split on whitespace from their original articles, they have
variable length and contain unicode characters and numbers. They look like:</p><pre class="screen">faddishness
'melanesians'
Kharálampos
PizzaInACup™
url="http://en.wikipedia.org/wiki?curid=363886"
VIIIa),
Superbagnères.</pre><p>We’ll use this text sample to test how quickly we can build a data
structure holding one instance of each unique word and then we’ll see how
quickly we can query for a known word (we’ll use the uncommon “Zwiebel” from the painter Alfred Zwiebel). This
lets us ask “have we seen Zwiebel before?”. Token look-up is a common problem,
being able to do it quickly is important.</p><div class="informalexample"><a id="NOTEa"></a><p>When you try these containers on your own problems be aware that you will
probably see different behaviors. Each container builds its internal structures
in different ways, passing in different types of token is likely to affect the
build time of the structure and different lengths of token will affect the query
time. Always test in a methodical way.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_trying_these_approaches_on_8_million_tokens">Trying these approaches on 8 million tokens</h3></div></div></div><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-less-ram-8mil_tokens">Figure&nbsp;11-1</a> shows the 8 million token text file (111MB raw data) stored using a number of containers which we’ll discuss in this section. The x-axis shows RAM usage for each container, the y-axis track the query time and the size of each point relates to the time taken to build the structure (larger means it took longer).</p><p>As we can see in this diagram the <code class="literal">set</code> and <code class="literal">DAWG</code> examples use a lot of RAM.
The <code class="literal">list</code> example is expensive on RAM and slow. The Marisa Trie and HAT Trie
examples are the most efficient for this data set - they use a <span class="emphasis"><em>quarter</em></span> of the
RAM of the other approaches with little change in look-up speed.</p><div class="figure"><a id="FIG-less-ram-8mil_tokens"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/less_ram_tries_dawg_text_8545076_tokens.png" alt="DAWG and Tries versus built-in containers for 8 million tokens" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/less_ram_tries_dawg_text_8545076_tokens.png"></div></div><div class="figure-title">Figure&nbsp;11-1.&nbsp;DAWG and Tries versus built-in containers.</div></div><p>The figure doesn’t show the look-up time for the naive <code class="literal">list</code> without sort approach which I’ll introduce shortly as it takes far too long. The <code class="literal">datrie</code>
example is not included in the plot because it raised a Segmentation Fault (I’ve had
problems with it on other problems in the past) - when it works it is fast and
compact but it can exhibit pathological build times that make it hard to justify. It is worth including <span class="emphasis"><em>because</em></span> it can be faster than the other methods but obviously you’ll want to test it thoroughly on your data.</p><p>Do be aware that you must test your problem with a variety of containers, each
offers different trade-offs such as construction time and API flexibility.</p><p>Next we’ll build up a process to test the behavior of each container.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_list">list</h3></div></div></div><p>Let’s start with the simplest approach. We’ll load our tokens into a <code class="literal">list</code> and then query then using an O(n) linear search. We <span class="emphasis"><em>can’t</em></span> do this on the large example that I’ve already mentioned - the search takes far too long. I’ll demonstrate the technique with a much smaller (499,048 token) example.</p><p>In each of the following examples we use a generator <code class="literal">text_example.readers</code>
that extracts one unicode token at a time from the input file, this means that only a tiny amount of RAM
is used by the read process.</p><div class="informalexample"><pre class="screen">    t1 = time.time()
    words = [w for w in text_example.readers]
    print "Loading {} words".format(len(words))
    t2 = time.time()
    print "RAM after creating list {:0.1f}MiB, took {:0.1f}s".
        format(memory_profiler.memory_usage()[0], t2 - t1)</pre></div><p>We’re interested in how quickly we can query this list, ideally we want to find
a container that will store our text and allow us to query it and modify it
without penalty. To query it we look for a known word a number of times using
<code class="literal">timeit</code>:</p><div class="informalexample"><pre class="screen">    assert u'Zwiebel' in words
    time_cost = sum(timeit.repeat(stmt="u'Zwiebel' in words",
                                  setup="from __main__ import words",
                                  number=1,
                                  repeat=10000))
    print "Summed time to lookup word {:0.4f}s".format(time_cost)</pre></div><p>Our test script reports that approximately 59MB was used to store the original
5MB file as a list and that the lookup time was 86 seconds:</p><pre class="screen">RAM at start 10.3MiB
Loading 499048 words
RAM after creating list 59.4MiB, took 1.7s
Summed time to lookup word 86.1757s</pre><p>Storing text in an unsorted <code class="literal">list</code> is obviously a poor idea, the O(n) look-up
time is expensive and the memory usage is expensive. This is the worst of all
worlds!</p><p>We can improve the look-up time by sorting the <code class="literal">list</code> and using a binary search
via the <code class="literal">bisect</code> module <sup>[<a id="id826005" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826005" class="footnote">116</a>]</sup>, this gives us a sensible lower-bound for future
queries. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_list_sorted_code">Example&nbsp;11-9</a> we time how long it takes to <code class="literal">sort</code>
the list. Now we’ll switch to the large 8,545,076 token set.</p><div class="example"><a id="less_ram_list_sorted_code"></a><div class="example-title">Example&nbsp;11-9.&nbsp;bisect to allow efficient searches on a sorted list</div><div class="example-contents"><pre class="screen">    t1 = time.time()
    words = [w for w in text_example.readers]
    print "Loading {} words".format(len(words))
    t2 = time.time()
    print "RAM after creating list {:0.1f}MiB, took {:0.1f}s".
        format(memory_profiler.memory_usage()[0], t2 - t1)
    print "The list contains {} words".format(len(words))
    words.sort()
    t3 = time.time()
    print "Sorting list took {:0.1f}s".format(t3 - t2)</pre></div></div><p>Next we do the same look-up as before but with the addition of the <code class="literal">index</code>
method which uses <code class="literal">bisect</code>:</p><div class="informalexample"><pre class="screen">import bisect
...
def index(a, x):
    'Locate the leftmost value exactly equal to x'
    i = bisect.bisect_left(a, x)
    if i != len(a) and a[i] == x:
        return i
    raise ValueError
...
    time_cost = sum(timeit.repeat(stmt="index(words, u'Zwiebel')",
                                  setup="from __main__ import words, index",
                                  number=1,
                                  repeat=10000))</pre></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_bisect_list_output">Example&nbsp;11-10</a> we see that the RAM usage is much larger than before as we’re loading significantly more data. The sort takes a further 16 seconds and the cumulative look-up time is 0.02 seconds.</p><div class="example"><a id="less_ram_bisect_list_output"></a><div class="example-title">Example&nbsp;11-10.&nbsp;Timings for using bisect on a sorted list</div><div class="example-contents"><pre class="screen">$ python text_example_list_bisect.py
RAM at start 10.3MiB
Loading 8545076 words
RAM after creating list 932.1MiB, took 31.0s
The list contains 8545076 words
Sorting list took 16.9s
Summed time to lookup word 0.0201s</pre></div></div><p>We now have a sensible baseline for timing string look-ups - RAM usage must get better than 932MB and the total look-up time should be better than 0.02 seconds.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_set">set</h3></div></div></div><p>Using the built-in <code class="literal">set</code> might seem to be the most obvious way to tackle our
task. In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_set_code">Example&nbsp;11-11</a> the <code class="literal">set</code> stores each string in a hashed structure (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html">Chapter&nbsp;4</a> if you need a refresher) - it is quick to check for membership but each string must be stored separately which is expensive on RAM.</p><div class="example"><a id="less_ram_set_code"></a><div class="example-title">Example&nbsp;11-11.&nbsp;Using a set to store the data</div><div class="example-contents"><pre class="screen">    words_set = set(text_example.readers)</pre></div></div><p>The <code class="literal">set</code> uses more RAM than the <code class="literal">list</code> but it gives us a very fast look-up time
without needing an additional <code class="literal">index</code> function and without requiring an intermediate sorting operation.</p><pre class="screen">$ python text_example_set.py
RAM at start 10.3MiB
RAM after creating set 1122.9MiB, took 31.6s
The set contains 8545076 words
Summed time to lookup word 0.0033s</pre><p>If RAM isn’t at a premium then this might be the most sensible first approach.</p><p>We have now lost the <span class="emphasis"><em>ordering</em></span> of the original data. If that’s important to you then note that you could store the strings as keys in a dictionary, with each value being an index connected to the original read order. This way you could ask the dictionary if the key is present and for its index.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_more_efficient_tree_structures">More Efficient Tree Structures</h3></div></div></div><p>Let’s introduce a set of algorithms that use RAM more efficiently to represent our strings.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-less-ram-trie-dawg-picture">Figure&nbsp;11-2</a> (attribution: WikiMedia <sup>[<a id="id826195" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826195" class="footnote">117</a>]</sup>) shows the difference in representation of four words “tap”, “taps”, “top”, and “tops” between a Trie and a DAWG. With a <code class="literal">list</code> or a <code class="literal">set</code> each of these words would be stored as separate strings. Both the DAWG and Trie share parts of the strings so that less RAM is used. WikiPedia <sup>[<a id="id826211" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826211" class="footnote">118</a>]</sup> has some more background.</p><p>The main difference between these is that a DAWG shares common prefixes and suffixes, on words (like English) where there are many common prefixes and suffixes this can save a lot of repetition. A Trie shares just a common prefix. Exact memory behavior will depend on your data’s structure. Typically a DAWG cannot assign a value to a key due to the multiple paths from the start to the end of the string but the version I show here can accept a value mapping. Tries can accept a value mapping.</p><p>Some structures have to be constructed in a pass at the start, others can be updated at any time.</p><div class="figure"><a id="FIG-less-ram-trie-dawg-picture"></a><div class="figure-contents"><div class="mediaobject"><img style="width: 270; " src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/lessram-trie-vs-minimal-acyclic-fa.svg.png.jpg" alt="DAWG and Trie data structures" width="877" height="1000" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/lessram-trie-vs-minimal-acyclic-fa.svg.png.jpg"></div></div><div class="figure-title">Figure&nbsp;11-2.&nbsp;Trie and DAWG Structures</div></div><p>A big strength of some of these structures is that they provide a <span class="emphasis"><em>common prefix search</em></span> - you can ask for all words that share the prefix you provide. With the four words above the result when searching for “ta” would be “tap” and “taps” - since these are discovered through the graph structure the retrieval of these results is very fast. If you’re working with DNA then compressing millions of short strings using a Trie can be an efficient way to reduce RAM usage.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_directed_acyclic_word_graph_dawg">Directed Acyclic Word Graph (DAWG)</h3></div></div></div><p>The Directed Acyclic Word Graph <sup>[<a id="id826283" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826283" class="footnote">119</a>]</sup> (MIT
license) attempts to efficiently represent strings that share common prefixes and suffixes.</p><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_dawg_code">Example&nbsp;11-12</a> you’ll see the very simple setup for the DAWG. For this implementation the DAWG cannot be
modified after construction, it reads an iterator to construct itself once. The lack of post-construction updates might be a deal-breaker for your use-case.</p><div class="example"><a id="less_ram_dawg_code"></a><div class="example-title">Example&nbsp;11-12.&nbsp;Using a DAWG to store the data</div><div class="example-contents"><pre class="screen">import dawg
...
    words_dawg = dawg.DAWG(text_example.readers)</pre></div></div><p>It does support rich queries including prefix look-ups, it allows persistence and supports storing integer indexes as a value
along with byte and record values.</p><p>On this set of strings in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less-ram-dawg-example">Example&nbsp;11-13</a> it uses only slightly less RAM than the earlier <code class="literal">set</code> example. More similar input text will cause stronger compression.</p><div class="example"><a id="less-ram-dawg-example"></a><div class="example-title">Example&nbsp;11-13.&nbsp;Running the DAWG example</div><div class="example-contents"><pre class="screen">$ python text_example_dawg.py
RAM at start 10.3MiB
RAM after creating dawg 968.8MiB, took 63.1s
Summed time to lookup word 0.0049s</pre></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_marisa_trie">Marisa trie</h3></div></div></div><p>The Marisa Trie <sup>[<a id="id826372" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826372" class="footnote">120</a>]</sup> (dual-licensed
LGPL and BSD) is a static Trie <sup>[<a id="id826390" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826390" class="footnote">121</a>]</sup>
using Cython bindings to an external library. As it is static it cannot be modified after construction.</p><p>Each of the Tries available in
this package are static. Like the DAWG it supports storing integer indexes as
values, byte values and record values.</p><p>A key can be used to look-up a value and vice-versa. All keys sharing the same
prefix can be found efficiently. The Trie’s contents can be persisted.</p><div class="example"><a id="less_ram_marisa_trie_code"></a><div class="example-title">Example&nbsp;11-14.&nbsp;Using a Marisa trie to store the data</div><div class="example-contents"><pre class="screen">import marisa_trie
...
    words_trie = marisa_trie.Trie(text_example.readers)</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less-ram-marisa-trie-example">Example&nbsp;11-15</a> we see a marked improvement in RAM storage compared to the DAWG example but the overall search time is a little slower.</p><div class="example"><a id="less-ram-marisa-trie-example"></a><div class="example-title">Example&nbsp;11-15.&nbsp;Running the Marisa trie example</div><div class="example-contents"><pre class="screen">$ python text_example_trie.py
RAM at start 11.0MiB
RAM after creating trie 304.7MiB, took 55.3s
The trie contains 8545076 words
Summed time to lookup word 0.0101s</pre></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="memory_datrie">datrie</h3></div></div></div><p>The Double-Array Trie <sup>[<a id="id826451" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826451" class="footnote">122</a>]</sup> (licensed LGPL)
uses a pre-built alphabet to efficiently store keys. This Trie can be modified
after creation but only with the same alphabet. It can also find all keys that share the prefix of the provided
key and it supports persistence.</p><p>Along with the HAT Trie it offers one of the fastest look-up times.</p><p>I’ll note that when using the datrie on the WikiPedia example and for
past work on DNA representations the datrie had a pathological build-time, it
could take minutes or hours to represent my DNA strings compared to other data structures.</p><p>The datrie needs an alphabet to be presented to the constructor, only keys using
this alphabet are allowed. In our WikiPedia example this means we need two passes on the raw data, you can see this in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_datrie_code">Example&nbsp;11-16</a>.</p><p>The first pass builds an alphabet of characters into a <code class="literal">set</code> and a second  will build the Trie. This slower build process allows for faster look-up times.</p><div class="example"><a id="less_ram_datrie_code"></a><div class="example-title">Example&nbsp;11-16.&nbsp;Using a double-array trie to store the data</div><div class="example-contents"><pre class="screen">import datrie
...
    chars = set()
    for word in text_example.readers:
        chars.update(word)
    trie = datrie.BaseTrie(chars)
...
    # having consumed our generator in the first chars pass we need to make a new one
    readers = text_example.read_words(text_example.SUMMARISED_FILE)  # new generator
    for word in readers:
        trie[word] = 0</pre></div></div><p>Sadly on this example dataset the <code class="literal">datrie</code> threw a Segmentation Fault so I can’t show you timing information. I chose to include it because in other tests it tended to be slightly faster (but less RAM efficient) than the following HAT Trie. I have used it with success for DNA searching so if you have a static problem and it works, you can be confident that it’ll work well. If you have a problem with varying input text then this might not be a suitable choice.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_hat_trie">HAT Trie</h3></div></div></div><p>The HAT Trie <sup>[<a id="id826522" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826522" class="footnote">123</a>]</sup> (licensed MIT) uses a
cache-friendly representation to achieve very fast look-ups on modern CPUs. It can be modified
after construction but otherwise has a very limited API.</p><p>For simple use cases it has great performance, the API limitations (e.g. lack of prefix look-ups) might
make it less useful for your application.</p><div class="example"><a id="less_ram_hatrie_code"></a><div class="example-title">Example&nbsp;11-17.&nbsp;Using a Hat trie to store the data</div><div class="example-contents"><pre class="screen">import hat_trie
...
    words_trie = hat_trie.Trie()
    for word in text_example.readers:
        words_trie[word] = 0</pre></div></div><p>As you can see in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#less_ram_hatrie_example">Example&nbsp;11-18</a> the HAT Trie offers the fastest lookup times of our new data structures along with superb RAM usage. The limitations in its API mean that its use is limited, but if you just need fast look-up in a large number of string then this might be your solution.</p><div class="example"><a id="less_ram_hatrie_example"></a><div class="example-title">Example&nbsp;11-18.&nbsp;Running the HAT Trie example</div><div class="example-contents"><pre class="screen">$ python text_example_hattrie.py
RAM at start 9.7MiB
RAM after creating trie 254.2MiB, took 44.7s
The trie contains 8545076 words
Summed time to lookup word 0.0051s</pre></div></div><p>The Trie and DAWG data structures offer good benefits but you must still benchmark them on your problem rather than blindly adopting them. If you have overlapping sequences in your strings then it is likely that you’ll see a RAM improvement.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_using_tries_in_production_systems">Using Tries in production systems</h3></div></div></div><p>Tries and DAWGs are less well known but can provide strong benefits in production systems. We have an impressive success story in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch12.html#lessons-from-field-alex">Large Scale Social Media Analysis at Sme.sh</a>. Jamie Matthews at DapApps (a Python software house based in the UK) also has a story, they use them in client systems to enable more efficient and cheaper deployments for their customers:</p><div class="blockquote"><blockquote class="blockquote"><p>At DabApps, we often try to tackle complex technical architecture problems by dividing them up into small, self-contained components, usually communicating over the network using HTTP. This approach (referred to as a “service-oriented” or “microservice” architecture) has all sorts of benefits, including the possibility of reusing or sharing the functionality of a single component between multiple projects.</p><p>One such task that is often a requirement in our consumer-facing client projects is postcode geocoding. This is the task of converting a full UK postcode (for example: “BN1 1AG”) into a latitude and longitude co-ordinate pair, to enable the application to perform geospatial calculations such as distance measurement.</p><p>At its most basic, a geocoding database is a simple mapping between strings, and can conceptually be represented as a dictionary. The dictionary keys are the postcodes, stored in a normalised form (“BN11AG”), and the values are some representation of the co-ordinates (we used a geohash encoding, but for simplicity imagine a comma-separated pair such as: “50.822921,-0.142871”).</p><p>There are approximately 1.7 million postcodes in the UK. Naïvely loading the full dataset into a Python dictionary, as described above, uses several hundred megabytes of memory. Persisting this data structure to disk using Python’s native pickle format requires an unacceptably large amount of storage space. We knew we could do better.</p><p>We experimented with several different in-memory and on-disk storage and serialisation formats, including storing the data externally in databases such as Redis and LevelDB, and compressing the key/values pairs. Eventually, we hit on the idea of using a trie. Tries are extremely efficient at representing large numbers of strings in memory, and the available open-source libraries (we chose “marisa-trie”) make them very simple to use.</p><p>The resulting application, including a tiny web API built with the Flask framework, uses only 30MB of memory to represent the entire UK postcode database, and can comfortably handle a high volume of postcode lookup requests. The code is simple, the service is very lightweight and painless to deploy and run on a free hosting platform such as Heroku, with no external requirements or dependencies on databases. Our implementation is open-source, available at <a class="ulink" href="https://github.com/j4mie/postcodeserver/" target="_top">https://github.com/j4mie/postcodeserver/</a>.</p><div class="attribution"><p>—<span class="attribution">
Jamie Matthews
<em class="citetitle">Technical Director of DabApps.com (UK)</em>
</span></p></div></blockquote></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="_tips_for_using_less_ram">Tips for using less RAM</h2></div></div></div><p>Generally if you can avoid putting it into RAM, avoid doing so. Everything you load costs you RAM. You might be able to load just a part of your data (e.g. using a memory mapped file <sup>[<a id="id826713" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826713" class="footnote">124</a>]</sup>), alternatively you might be able to use generators to load only the part of the data that you need for partial computations rather than loading it all at once.</p><p>If you are working with numeric data then you’ll almost certainly want to switch to using <code class="literal">numpy</code> arrays - the package offers many fast algorithms that work directly on the underlying primitive objects. The RAM savings compared to using lists of numbers can be huge, the time savings can be similarly amazing.</p><p>You’ll have noticed in this book that we generally use <code class="literal">xrange</code> rather than <code class="literal">range</code> simply because (in Python 2.x) <code class="literal">xrange</code> is a generator whilst <code class="literal">range</code> builds an entire list. Building a list of 100,000,000 integers just to iterate the right number of times is excessive - the RAM cost is large and entirely unnecessary. Python 3.x turns <code class="literal">range</code> into a generator so you no longer need to make this change.</p><p>If you’re working with strings and you’re in Python 2.x then try to stick to <code class="literal">str</code> rather than <code class="literal">unicode</code> if you want to save RAM. You will probably be better served by simply upgrading to Python 3.3+ if you need lots of unicode objects throughout your program. If you’re storing a large number of Unicode objects in a static structure then you probably want to investigate the DAWG and Trie structures that we’ve just discussed.</p><p>If you’re working with lots of bit strings then investigate <code class="literal">numpy</code> and the <code class="literal">bitarray</code> <sup>[<a id="id826754" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826754" class="footnote">125</a>]</sup> package, they both have efficient representations of bits packed into bytes. You might also benefit from looking at Redis, it has efficient storage of bit patterns.</p><p>Be aware that the PyPy project is experimenting with more efficient representations of homogenous data structures so long lists of the same primitive type (e.g. integers) might cost much less than the equivalent structure in CPython. The micropython <sup>[<a id="id826795" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826795" class="footnote">126</a>]</sup> project will be interesting to anyone working with embedded systems, it is a tiny-memory-footprint implementation of Python that’s aiming for Python 3 compatibility.</p><p>It goes (almost!) without saying that you know you have to benchmark when you’re trying to optimize on RAM usage and that it pays handsomly to have a unit-test suite in place before you make algorithmic changes.</p><p>Having reviewed ways of compressing strings and storing numbers efficiently we’ll now look at trading accuracy for storage space.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="less_ram_prob_ds">Probabilistic data structures</h2></div></div></div><p>Probabilistic data structures allow you to make trade-offs in accuracy for immense
decreases in memory usage.  In addition, the number of operations you can do on
them is much more restricted than a <code class="literal">set</code> or a <code class="literal">trie</code>.  For example, with a
single HyperLogLog++ structure using 2.56kB can count the number of unique items
up to approximately 7,900,000,000 items with 1.625% error.</p><p>This means that if we are trying
to count the number of unique license plate numbers for cars, if our
HyperLogLog++ counter said there were 654,192,028 the we would be confident that
the actual number lies between 664,822,648 and 643,561,407.  Furthermore, if
this accuracy is not sufficient, you can simply add more memory to the structure
and it will perform better.  Giving it 40.96kB of resources will decrease the
error from 1.625% to 0.4%.  However, storing this in a <code class="literal">set</code> would take 3.925GB
assuming no overhead!</p><p>On the other hand, the HyperLogLog++ structure would only be able to count a <code class="literal">set</code>
of licence plates and merge with another <code class="literal">set</code>.  So, for example, we could have
one structure for every state, find how many unique license plates are in those
states, then merge them all to get a count for the whole country.  If we were
given a license plate we couldn’t tell you if we’ve seen it before with very
good accuracy and we couldn’t give you a sample of license plates we have already
seen.</p><p>Probabilistic data structures are fantastic when you have spent the time to
understand the problem and then need to put something into production that can
answer a very small set of questions over a very large set of data.  Each
different structure has different questions it can answer at different accuracies
so finding the right one is just a matter of understanding your requirements.</p><p>In almost all cases, probabilistic data structures work by finding an alternative
representation for the data that is more compact and contains the relevant
information for answering a certain set of questions.  This can be thought of as
a type of lossy compression where we may lose some aspects of the data but we
retain the necessary components.  Since we are allowing the loss of data that
isn’t necessarily relevant for the particular set of questions we care about,
this sort of lossy compression can be much more efficient than the lossless
compression we looked at before with tries.  It is because of this that the
choice of which probabilistic data structure you will use is quite important—you want to pick one that retains the right information for your use case!</p><p>Before we dive in, it should be made clear that all the “error rates” here are
defined in terms of standard deviations.  This term comes from describing
Gaussian distributions and says how spread out the function is around a center
value.  When the standard deviation grows so do the values further away from the
center point.  Error from probabilistic data structres are framed this way
because all the anaysis around them are probabilistic.  So, for example, when we
say that the HyperLogLog algorithm has an error of
<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1101.png" alt="" width="85" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1101.png"></span> we mean that 66% of the time the error
will be smaller than err, 95% of the time it will be below 2*err and 99.7% of
the time it will be below 3*err <sup>[<a id="id826919" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id826919" class="footnote">127</a>]</sup>.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_very_approximate_counting_with_a_1_byte_morris_counter">Very approximate counting with a 1 byte Morris Counter</h3></div></div></div><p>We’ll introduce the topic of probabilistic counting with one of the earliest
probabilistic counters, the Morris Counter (by Robert Morris of the NSA and Bell
Labs). Applications include counting millions of objects in a restricted RAM
environment (e.g. on an embedded computer), understanding large data streams and
problems in AI like image and speech recognition.</p><p>The Morris Counter keeps track of an exponent and models the counted state as
<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1102.png" alt="" width="83" height="23" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1102.png"></span> (rather than a correct count) - it provides an
<span class="emphasis"><em>order of magnitude</em></span> estimate. This estimate is updated using a probabilistic
rule.</p><p>We start with the exponent set to 0, if we ask for the <span class="emphasis"><em>value</em></span> of the Counter
we’ll be given <code class="literal">pow(2,exponent)=1</code> (the keen reader will note that this is
off-by-one - we did say this was an <span class="emphasis"><em>approximate</em></span> counter!). If we ask the
Counter to increment itself it will generate a random number (using the uniform
distribution) and it will test if <code class="literal">random(0, 1) &lt;= 1/pow(2,exponent)</code> which will
always be true (<code class="literal">pow(2,0) == 1</code>). The Counter increments and the exponent is set
to 1.</p><p>The second time we ask the Counter to increment itself it will test if
<code class="literal">random(0, 1) &lt;= 1/pow(2,1)</code>, this will be true 50% of the time. If the test
passes then the exponent is incremented. If False then the exponent is not
incremented for this increment request.</p><p><a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#table_morris_counter">Table&nbsp;11-1</a> shows the likelihoods of an increment occurring for each
of the first exponents.</p><div class="table"><a id="table_morris_counter"></a><div class="table-title">Table&nbsp;11-1.&nbsp;Morris Counter Details</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">exponent</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">pow(2,exponent)  </td><td style="border-bottom: 0.5pt solid ; ">P(increment)</td></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1</p></td><td style="border-bottom: 0.5pt solid ; "><p>1</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2</p></td><td style="border-bottom: 0.5pt solid ; "><p>0.5</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4</p></td><td style="border-bottom: 0.5pt solid ; "><p>0.25</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>8</p></td><td style="border-bottom: 0.5pt solid ; "><p>0.125</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>16</p></td><td style="border-bottom: 0.5pt solid ; "><p>0.0625</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>…</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>…</p></td><td style="border-bottom: 0.5pt solid ; "><p>…</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p>254</p></td><td style="border-right: 0.5pt solid ; "><p>2.894802e+76</p></td><td><p>3.454467e-77</p></td></tr></tbody></table></div></div><p>The maximum we could approximately count where we use a single unsigned byte for
the exponent is <code class="literal">math.pow(2,255) == 5e76</code>. The error relative to the actual
count will be fairly large as the counts increase, but the RAM saving is
tremendous as we only use 1 byte rather than the 32 unsigned bytes we’d
otherwise have to use.</p><div class="example"><a id="memory_morris_example_code"></a><div class="example-title">Example&nbsp;11-19.&nbsp;Simple Morris Counter Implemintation</div><div class="example-contents"><pre class="screen">from random import random

class MorrisCounter(object):
    counter = 0
    def add(self, *args):
        if random() &lt; 1.0 / (2 ** self.counter):
            self.counter += 1

    def __len__(self):
        return 2**self.counter</pre></div></div><p>In addition to the example implemintation in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_morris_example_code">Example&nbsp;11-19</a>, . In
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#morris_counter_example">Example&nbsp;11-20</a> we can see that the first request to increment the
Counter succeeds and the second fails.</p><p>Using the example implemintaiton in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_morris_example_code">Example&nbsp;11-19</a>, we can see
that the first request to increment the Counter succeeds and the second fails.
<sup>[<a id="id827216" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id827216" class="footnote">128</a>]</sup></p><div class="example"><a id="morris_counter_example"></a><div class="example-title">Example&nbsp;11-20.&nbsp;Morris Counter library example</div><div class="example-contents"><pre class="screen">In [2]: mc = MorrisCounter()
In [3]: print len(mc)
1.0
In [4]: mc.add()  # P(1) of doing an add
In [5]: print len(mc)
2.0
In [6]: mc.add()  # P(0.5) of doing an add
In [7]: print len(mc)  # the add does not occur on this attempt
2.0</pre></div></div><p>In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-morris-counter">Figure&nbsp;11-3</a> the thick black line shows a normal integer
incrementing on each iteration, on my 64 bit laptop this is an 8 byte integer.
The evolution of three 1 byte Morris Counters are shown as dotted lines, the y
axis shows their value which approximately represents the true count for each
iteration. Three Counters are shown to give you an idea about their different
trajectories and the overall trend, the three Counters are entirely independent
of each other.</p><div class="figure"><a id="FIG-morris-counter"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/12_show_morris_counter.png" alt="Three 1-byte Morris Counters" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/12_show_morris_counter.png"></div></div><div class="figure-title">Figure&nbsp;11-3.&nbsp;Three 1-byte Morris Counters vs an 8 byte Integer.</div></div><p>This diagram gives you some idea about the error to expect when using a Morris
Counter. Further details about the error behavior are available
<sup>[<a id="id827315" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id827315" class="footnote">129</a>]</sup>
online.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_k_min_values">K-Min Values</h3></div></div></div><p>In the Morris Counter, we loose any sort of information about the items we
insert.  That is to say, the counter’s internal state is the same whether we did
<code class="literal">.add("micha")</code> or <code class="literal">.add("ian")</code>.  This extra information is useful and, if use
properlly, could help us have our counters only counting unique items.  In this
way, calling <code class="literal">.add("micha")</code> thousands of times would only increase the counter
once.</p><p>In order to do this, we will exploit properties of hashing functions (see
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch04.html#SEC-dict-set-hash-and-entropy">Hash functions and Entropy</a> for a more in depth discussion of hash
functions).  The main property we would like to take advantage of is the fact
that the hash function takes input and <span class="emphasis"><em>uniformly</em></span> distributes it.  For example,
let’s assume I have a hash function that takes in a string and outputs number
between 0 and 1.  For that function to be uniform means that when i feed it in a
string I am equally likely to get a value of 0.5 as I am to get a value of 0.2
or any other value.  This also means that if I feed it in many string values, I
would expect the values to be relatively evenly spaced.  Remember, this is a
probabilistic argument: they won’t always be evenly spaced, but in the limit
that I have many strings and try this experiment many times, it will tend to be
evenly spaced.</p><p>Let’s say I took 100 items and stored the hash of them (the number from 0-1).
Knowing the spacing is even means that instead of saying “I have 100 items”, I
could similarly say “I have a distance of 0.01 between every item”.  This is
where the K-Min Values algorithm <sup>[<a id="id827328" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id827328" epub:type="noteref" class="footnote">130</a>]</sup>
finally comes in—if we keep the <code class="literal">k</code> smallest, unique, hash values we have
seen, we can approximate the overall spacing between hash values and infer what
the total number of items is.  In <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-kmv-hash-density">Figure&nbsp;11-4</a> we can see the state
of a K-Min Values structure (also called a KMV) as more and more items are
added.  At first, since we don’t have many hash values, the largest hash we have
kept is quite large.  As we add more and more, the largest of the <code class="literal">k</code> hash
values we have kept gets smaller and smaller.  Using this method, we can
get error rates of <span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1103.png" alt="" width="94" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1103.png"></span>.</p><div class="figure"><a id="FIG-kmv-hash-density"></a><div class="figure-contents"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/kmv.png" alt="Density of hash space for K-Min Value structures" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/kmv.png"></div></div><div class="figure-title">Figure&nbsp;11-4.&nbsp;The values stores in a K-Min Value structure as more elements are added</div></div><p>The larger <code class="literal">k</code> is, the more we can account for the hashing function we are using
not being completely uniform for our particular input and for unfortunate hash
values.  An example of unfortunate hash values would be hashing  “A”,"B”,"C” and
getting the values 0.01, 0.02, 0.03.  If we start hashing more and more values,
it is less and less probable that they will clump up.</p><p>Furthermore, since we are only keeping the smallest <span class="emphasis"><em>unique</em></span> hash values the data
structure only considers unique inputs.  We can see this easily because if we
are in a state where we only store the smallest 3 hashes and currently have
<code class="literal">[0.1, 0.2, 0.3]</code> are the smallest hash values, if we keep adding in something
with the hash value of <code class="literal">0.4</code> our state will not change.  Similarly, if we keep
adding <code class="literal">0.3</code> our state will also not change.  This is a property called
idempotents and means that if we do the same operation, with the same inputs, on
this structure multiple times the state will not be changed.  This is in
contrast to, for example, an append on a list which will always change it’s
value.  This concept of idempotents carries on to all of the data structures in
this section except for the Morris Counter.</p><div class="example"><a id="memory_simple_kmv"></a><div class="example-title">Example&nbsp;11-21.&nbsp;Simple K-Min Values Implementation</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">mmh3</code>
<code class="kn">from</code> <code class="nn">blist</code> <code class="kn">import</code> <code class="n">sortedset</code>

<code class="k">class</code> <code class="nc">KMinValues</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">num_hashes</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code> <code class="o">=</code> <code class="n">num_hashes</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">sortedset</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">item</code><code class="p">):</code>
        <code class="n">item_hash</code> <code class="o">=</code> <code class="n">mmh3</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="n">item</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">item_hash</code><code class="p">)</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">pop</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">2</code><code class="p">:</code>
            <code class="k">return</code> <code class="mi">0</code>
        <code class="k">return</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="p">(</code><code class="mi">2</code><code class="o">**</code><code class="mi">32</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="o">-</code><code class="mi">2</code><code class="p">]</code> <code class="o">+</code> <code class="mi">2</code><code class="o">**</code><code class="mi">31</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code></pre></div></div><p>Using the KMin Values implementation in the python package CountMeMaybe
<sup>[<a id="id828118" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828118" class="footnote">131</a>]</sup> we can begin to see the
utility of this data structure.  This implemintation is very similar to the one
above in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_simple_kmv">Example&nbsp;11-21</a>, however it fully implements the other set
operations such as union and intersection.  Also note that “size” and
“cardinality” are used interchangeably (the word “cardinality” is from set
theory and is used more in the analysis of probabilistic data structures).</p><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="kn">from</code> <code class="nn">countmemaybe</code> <code class="kn">import</code> <code class="n">KMinValues</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">kmv1</code> <code class="o">=</code> <code class="n">KMinValues</code><code class="p">(</code><code class="n">k</code><code class="o">=</code><code class="mi">1024</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">kmv2</code> <code class="o">=</code> <code class="n">KMinValues</code><code class="p">(</code><code class="n">k</code><code class="o">=</code><code class="mi">1024</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">50000</code><code class="p">):</code> <code class="c"># </code><a id="CO24-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
    <code class="n">kmv1</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">...</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">25000</code><code class="p">,</code> <code class="mi">75000</code><code class="p">):</code> <code class="c"># </code><a id="CO24-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
    <code class="n">kmv2</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">...</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">print</code> <code class="nb">len</code><code class="p">(</code><code class="n">kmv1</code><code class="p">)</code>
<code class="mi">50416</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">print</code> <code class="nb">len</code><code class="p">(</code><code class="n">kmv2</code><code class="p">)</code>
<code class="mi">52439</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">print</code> <code class="n">kmv1</code><code class="o">.</code><code class="n">cardinality_intersection</code><code class="p">(</code><code class="n">kmv2</code><code class="p">)</code>
<code class="mf">25900.2862992</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">print</code> <code class="n">kmv1</code><code class="o">.</code><code class="n">cardinality_union</code><code class="p">(</code><code class="n">kmv2</code><code class="p">)</code>
<code class="mf">75346.2874158</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO24-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
We put 50,000 elements into <code class="literal">kmv1</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO24-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
<code class="literal">kmv2</code> also gets 50,000 elements, 25,000 of which are the same as <code class="literal">kmv1</code>
</p></dd></dl></div><div class="note"><h3 class="title">Note</h3><p>With these sorts of algorithms, the choice of hash function can have a drastic
effect on the quality of the estimates.  We’ve chosen <code class="literal">mmh3</code>, a python
implementation of mumurhash3 which has nice properties for hashing strings.
However, different hash functions could be used if they are more convenient for
your particular dataset.</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_bloom_filter">Bloom Filter</h3></div></div></div><p>Sometimes we need to be able to do other types of set operations and for this we
need to introduce new types of probabilistic data structures.  Bloom filters
<sup>[<a id="id828152" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828152" epub:type="noteref" class="footnote">132</a>]</sup> were
created to ask the question of whether we’ve seen an item before.</p><p>Bloom filters work by having multiple hash values in order to represent a value
as multiple integers.  If we later see something with the same set of integers,
we can be reasonably confident that it is the same value.</p><p>In order to do this in a way which efficiently utilizes available resources, we
implicitly encode the integers as the indexes of a list.  This could be thought
of as a list of <code class="literal">bool</code> values that are initially set to <code class="literal">False</code>. If we are asked
to add an object with hash values <code class="literal">[10, 4, 7]</code>, then we set the 10th, 4th and
7th indexes of the list to <code class="literal">True</code>.  In the future, if we are asked if we have
seen a particular item before, we simply find it’s hash values and check if all
the corresponding spots in the bool list are set to <code class="literal">True</code>.</p><p>This method gives us no false negatives and a controllable rate of false
positives.  What this means is that if the bloom filter says we have not seen an
item before then we can be 100% sure that we haven’t seen the item before.  On
the other-hand, if the bloom filter states we <span class="emphasis"><em>have</em></span> seen an item before, then
there is a probability that we actually have not and we are simply seeing an
erroneous result.  This erroneous result comes from the fact that we will have
hash collisions and sometimes the hash values for two objects will be the same
even if the objects themselves are not the same.  However, in practice bloom
filters are set to have error rates below 0.5% so this error can be acceptable.</p><div class="note"><h3 class="title">Note</h3><p>We can simulate having as many hash functions we want simply by having 2 hash
functions that are independent of each-other.  This method is called “double
hashing”. If  we have a hash function that gives us 2 independent hashes, we can
do:</p><pre class="screen">def multi_hash(key, num_hashes):
    hash1, hash2 = hashfunction(key)
    for i in xrange(num_hashes):
        yield (hash1 + i * hash2) % (2^32 - 1)</pre><p>The modulo insures that the resulting hash values are 32 bit (we would modulo by
<code class="literal">2^64 - 1</code> for 64bit hash functions).</p></div><p>The exact length of the <code class="literal">bool</code> list and the number of hash values per item we
need will be fixed based on the capacity and the error rate we require.  With
some reasonably simple statistical arguments <sup>[<a id="id828747" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828747" class="footnote">133</a>]</sup> we see
that the ideal values are,</p><div class="informalequation"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/eq_1104.png" alt="Bloom Filter" width="1634" height="140" data-mfp-src="/library/view/high-performance-python/9781449361747/eq_1104.png"></div></div><p>That is to say, if we wish to store 50,000 objects (no matter how big the
objects themselves are) at a false positive rate of 0.05% (that is to say, 0.05%
of the times we say we have seen an object before, we actually have not), it
would require 791,015 bits of storage and 11 hash functions.</p><p>In order to further improve our efficiency with memory, we can use single bits
to represent the <code class="literal">bool</code> value (since a native <code class="literal">bool</code> actually takes 4 bits).  We
can do this easily by using the <code class="literal">bitarray</code> module.</p><div class="example"><a id="id828840"></a><div class="example-title">Example&nbsp;11-22.&nbsp;Simple Bloom Filter Implemintation</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">bitarray</code>
<code class="kn">import</code> <code class="nn">math</code>
<code class="kn">import</code> <code class="nn">mmh3</code>

<code class="k">class</code> <code class="nc">BloomFilter</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">capacity</code><code class="p">,</code> <code class="n">error</code><code class="o">=</code><code class="mf">0.005</code><code class="p">):</code>
        <code class="sd">"""</code>
<code class="sd">        Initialize a bloom filter with given capacity and false positive rate</code>
<code class="sd">        """</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">capacity</code> <code class="o">=</code> <code class="n">capacity</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">error</code> <code class="o">=</code> <code class="n">error</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="o">-</code><code class="n">capacity</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">error</code><code class="p">)</code> <code class="o">/</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code class="o">**</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="mi">1</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="n">capacity</code><code class="p">))</code> <code class="o">+</code> <code class="mi">1</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">bitarray</code><code class="o">.</code><code class="n">bitarray</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">_indexes</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="n">h1</code><code class="p">,</code> <code class="n">h2</code> <code class="o">=</code> <code class="n">mmh3</code><code class="o">.</code><code class="n">hash64</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>
        <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code><code class="p">):</code>
            <code class="k">yield</code> <code class="p">(</code><code class="n">h1</code> <code class="o">+</code> <code class="n">i</code> <code class="o">*</code> <code class="n">h2</code><code class="p">)</code> <code class="o">%</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code>

    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="k">for</code> <code class="n">index</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">_indexes</code><code class="p">(</code><code class="n">key</code><code class="p">):</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="o">=</code> <code class="bp">True</code>

    <code class="k">def</code> <code class="nf">__contains__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="k">return</code> <code class="nb">all</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="k">for</code> <code class="n">index</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">_indexes</code><code class="p">(</code><code class="n">key</code><code class="p">))</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">num_bits_on</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="bp">True</code><code class="p">)</code>
        <code class="k">return</code> <code class="o">-</code><code class="mf">1.0</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="mf">1.0</code> <code class="o">-</code> <code class="n">num_bits_on</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_bits</code><code class="p">))</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_hashes</code><code class="p">)</code>

    <code class="nd">@staticmethod</code>
    <code class="k">def</code> <code class="nf">union</code><code class="p">(</code><code class="n">bloom_a</code><code class="p">,</code> <code class="n">bloom_b</code><code class="p">):</code>
        <code class="k">assert</code> <code class="n">bloom_a</code><code class="o">.</code><code class="n">capacity</code> <code class="o">==</code> <code class="n">bloom_b</code><code class="o">.</code><code class="n">capacity</code><code class="p">,</code> <code class="s">"Capacities must be equal"</code>
        <code class="k">assert</code> <code class="n">bloom_a</code><code class="o">.</code><code class="n">error</code> <code class="o">==</code> <code class="n">bloom_b</code><code class="o">.</code><code class="n">error</code><code class="p">,</code> <code class="s">"Error rates must be equal"</code>

        <code class="n">bloom_union</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="n">bloom_a</code><code class="o">.</code><code class="n">capacity</code><code class="p">,</code> <code class="n">bloom_a</code><code class="o">.</code><code class="n">error</code><code class="p">)</code>
        <code class="n">bloom_union</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">bloom_a</code><code class="o">.</code><code class="n">data</code> <code class="o">|</code> <code class="n">bloom_b</code><code class="o">.</code><code class="n">data</code>
        <code class="k">return</code> <code class="n">bloom_union</code></pre></div></div><p>What happens if we insert more items than we specified for the capacity of the
bloom filter?  At the extreme end, the <code class="literal">bool</code> list will be all set to <code class="literal">True</code> in
which case we say that we have seen every item.  This means that bloom filters
are very sensitive to what their initial capacity was set to, which can be quite
aggravating if we are dealing with a set of data whose size is unknown (for
example a stream of data).</p><p>One way of dealing with this is to use a variant of bloom filters called Scaling
Bloom Filters <sup>[<a id="id828930" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828930" epub:type="noteref" class="footnote">134</a>]</sup>.  They work by chaining together multiple bloom
filters whose error rate varies in a specific way <sup>[<a id="id828944" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id828944" epub:type="noteref" class="footnote">135</a>]</sup>.  By doing
this, we can guarantee an overall error rate and simply add a new bloom filter
when we need more capacity.  In order to check if we’ve seen an item before, we
simply iterate over all of the sub-blooms until either we find the object or we
exhaust the list.  A sample implementation of this structure can be seen in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_scaling_bloom">Example&nbsp;11-23</a> where we use the previous bloom filter implementation
for the underlying functionality and have a counter to simplify knowing when to
    add a new bloom.</p><p>Another way of dealing with this is using a method called Timing Bloom Filters.
This variant allows elements to be expired out of the data structure, thus
freeing up space for more elements.  This is especially nice for dealing with
streams since we can have elements expire after, say, an hour and have the
capacity large enough to deal with the amount of data we see per hour.  Using a
bloom filter this way would give us a nice view into what has been happening in
the last hour.</p><div class="example"><a id="memory_scaling_bloom"></a><div class="example-title">Example&nbsp;11-23.&nbsp;Simple Scaling Bloom Filter Implementation</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">bloomfilter</code> <code class="kn">import</code> <code class="n">BloomFilter</code>

<code class="k">class</code> <code class="nc">ScalingBloomFilter</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">capacity</code><code class="p">,</code> <code class="n">error</code><code class="o">=</code><code class="mf">0.005</code><code class="p">,</code> <code class="n">max_fill</code><code class="o">=</code><code class="mf">0.8</code><code class="p">,</code> <code class="n">error_tightening_ratio</code><code class="o">=</code><code class="mf">0.5</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">capacity</code> <code class="o">=</code> <code class="n">capacity</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">base_error</code> <code class="o">=</code> <code class="n">error</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">max_fill</code> <code class="o">=</code> <code class="n">max_fill</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">capacity</code> <code class="o">*</code> <code class="n">max_fill</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">error_tightening_ratio</code> <code class="o">=</code> <code class="n">error_tightening_ratio</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code> <code class="o">=</code> <code class="p">[]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code> <code class="o">=</code> <code class="bp">None</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">_add_bloom</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">_add_bloom</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">new_error</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">base_error</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">error_tightening_ratio</code> <code class="o">**</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code><code class="p">)</code>
        <code class="n">new_bloom</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">capacity</code><code class="p">,</code> <code class="n">new_error</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">new_bloom</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code> <code class="o">=</code> <code class="n">new_bloom</code>
        <code class="k">return</code> <code class="n">new_bloom</code>

    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="k">if</code> <code class="n">key</code> <code class="ow">in</code> <code class="bp">self</code><code class="p">:</code>
            <code class="k">return</code> <code class="bp">True</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">-=</code> <code class="mi">1</code>
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
            <code class="n">bloom_size</code> <code class="o">=</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code><code class="p">)</code>
            <code class="n">bloom_max_capacity</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">current_bloom</code><code class="o">.</code><code class="n">capacity</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">max_fill</code><code class="p">)</code>

            <code class="c"># We may have been adding many duplicate values into the bloom, so</code>
            <code class="c"># we need to check if we actually need to scale or if we still have</code>
            <code class="c"># space</code>
            <code class="k">if</code> <code class="n">bloom_size</code> <code class="o">&gt;=</code> <code class="n">bloom_max_capacity</code><code class="p">:</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">_add_bloom</code><code class="p">()</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">=</code> <code class="n">bloom_max_capacity</code>
            <code class="k">else</code><code class="p">:</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">items_until_scale</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">bloom_max_capacity</code> <code class="o">-</code> <code class="n">bloom_size</code><code class="p">)</code>
        <code class="k">return</code> <code class="bp">False</code>

    <code class="k">def</code> <code class="nf">__contains__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">):</code>
        <code class="k">return</code> <code class="nb">any</code><code class="p">(</code><code class="n">key</code> <code class="ow">in</code> <code class="n">bloom</code> <code class="k">for</code> <code class="n">bloom</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="nb">sum</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">bloom</code><code class="p">)</code> <code class="k">for</code> <code class="n">bloom</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">bloom_filters</code><code class="p">)</code></pre></div></div><p>Using this data structure will feel much like using a <code class="literal">set</code> object.  Below we
will use the scaling bloom filter to add many objects, test if we’ve seen them
before, and then try to experimentally find the false positive rate,</p><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="n">bloom</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">50</code><code class="p">):</code>
   <code class="o">....</code><code class="p">:</code>     <code class="n">bloom</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">....</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"20"</code> <code class="ow">in</code> <code class="n">bloom</code>
<code class="bp">True</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"25"</code> <code class="ow">in</code> <code class="n">bloom</code>
<code class="bp">True</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"51"</code> <code class="ow">in</code> <code class="n">bloom</code>
<code class="bp">False</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">num_false_positives</code> <code class="o">=</code> <code class="mi">0</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">num_true_negatives</code> <code class="o">=</code> <code class="mi">0</code>

<code class="o">&gt;&gt;&gt;</code> <code class="c"># None of the following numbers should be in the bloom.</code>
<code class="o">&gt;&gt;&gt;</code> <code class="c"># If one is found in the bloom, it is a false positive.</code>
<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">51</code><code class="p">,</code><code class="mi">10000</code><code class="p">):</code>
   <code class="o">....</code><code class="p">:</code>     <code class="k">if</code> <code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="ow">in</code> <code class="n">bloom</code><code class="p">:</code>
   <code class="o">....</code><code class="p">:</code>         <code class="n">num_false_positives</code> <code class="o">+=</code> <code class="mi">1</code>
   <code class="o">....</code><code class="p">:</code>     <code class="k">else</code><code class="p">:</code>
   <code class="o">....</code><code class="p">:</code>         <code class="n">num_true_negatives</code> <code class="o">+=</code> <code class="mi">1</code>
   <code class="o">....</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">num_false_positives</code>
<code class="mi">54</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">num_true_negatives</code>
<code class="mi">9895</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">false_positive_rate</code> <code class="o">=</code> <code class="n">num_false_positives</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="mi">10000</code> <code class="o">-</code> <code class="mi">51</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">false_positive_rate</code>
<code class="mf">0.005427681173987335</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">bloom</code><code class="o">.</code><code class="n">error</code>
<code class="mf">0.005</code></pre><p>We can also do unions with bloom filters in order to join multiple sets of
items.  One caveat with this is that you can only take the union of two blooms
with the same capacity and error rate.  Furthermore, the final blooms used
capacity can be as high as the sum of the used capacity of the two blooms
unioned to make this.  What this means is you could start with two bloom filters
that are a little more than half full and when you union them together you will
get a new bloom that is over capacity and not reliable!</p><pre class="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="n">bloom_a</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">bloom_b</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">50</code><code class="p">):</code>
   <code class="o">...</code><code class="p">:</code>     <code class="n">bloom_a</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">...</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code><code class="mi">75</code><code class="p">):</code>
   <code class="o">...</code><code class="p">:</code>     <code class="n">bloom_b</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>
   <code class="o">...</code><code class="p">:</code>

<code class="o">&gt;&gt;&gt;</code> <code class="n">bloom</code> <code class="o">=</code> <code class="n">BloomFilter</code><code class="o">.</code><code class="n">union</code><code class="p">(</code><code class="n">bloom_a</code><code class="p">,</code> <code class="n">bloom_b</code><code class="p">)</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"51"</code> <code class="ow">in</code> <code class="n">bloom_a</code> <code class="c"># </code><a id="CO25-1"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png">
<code class="n">Out</code><code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="bp">False</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"24"</code> <code class="ow">in</code> <code class="n">bloom_b</code> <code class="c"># </code><a id="CO25-2"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png">
<code class="n">Out</code><code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="bp">False</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"55"</code> <code class="ow">in</code> <code class="n">bloom</code> <code class="c"># </code><a id="CO25-3"></a><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png">
<code class="n">Out</code><code class="p">[</code><code class="mi">11</code><code class="p">]:</code> <code class="bp">True</code>

<code class="o">&gt;&gt;&gt;</code> <code class="s">"25"</code> <code class="ow">in</code> <code class="n">bloom</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="bp">True</code></pre><div class="calloutlist"><dl><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO25-1"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/1.png" alt="1" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/1.png"></a> </dt><dd><p>
The value of “51” is not in <code class="literal">bloom_a</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO25-2"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/2.png" alt="2" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/2.png"></a> </dt><dd><p>
Similarly, the value of “25” is not in <code class="literal">bloom_b</code>
</p></dd><dt><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#CO25-3"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/callouts/3.png" alt="3" width="12" height="12" data-mfp-src="/library/view/high-performance-python/9781449361747/callouts/3.png"></a> </dt><dd><p>
However, the <code class="literal">bloom</code> object contains all the objects that both <code class="literal">bloom_a</code> and <code class="literal">bloom_b</code> has!
</p></dd></dl></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_loglog_counter">LogLog Counter</h3></div></div></div><p>Loglog <sup>[<a id="id833007" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id833007" class="footnote">136</a>]</sup>
type counters are based on the realization that the individual bits of a hash
function are can also be considered to be random.  That is to say, the
probability of the first bit of a hash being <code class="literal">1</code> is 50%, the probability of the
first two bits being <code class="literal">01</code> is 25% and <code class="literal">001</code> is 12.5%.  Knowing these
probabilities and the hash we’ve seen so far with the most amount of <code class="literal">0</code> ’s at
the beginning (ie: the least probable hash value), we can come up with an
estimate of how many items we’ve seen so far.</p><p>A good analogy for this method is flipping coins.  Imagine we would like to flip
a coin 32 times and get heads every time.  The number 32 comes from the fact that
we are using 32bit hash functions.  If I flip the coin once and it comes
up with tails, then I will store the number <code class="literal">0</code> since my best attempt yielded 0
heads in a row.  Since I know the probabilities behind this coin-flip, I can also
tell you that my longest series was <code class="literal">0</code> long and you can estimate that I’ve
tried this experiment <code class="literal">2^0 = 1</code> time.  If I keep flipping my coin and I’m able
to get 10 heads before getting a tail, then I would store the number 10.  Using
the same logic, you can estimate that I’ve tried the experiment <code class="literal">2^10 = 1024</code>
times.  With this system, the highest we can count would be the maximum number
of flips we consider (for 32 flips, this is <code class="literal">2^32 = 4,294,967,296</code>).</p><p>In order to encode this logic with loglog type counters we take the binary
representation of the hash value of our input and see how many zeros there are
before we see our first 1.  The hash value can be thought of as a series of 32
coin flips where 0 means a flip for heads and 1 means a flip for tails (ie:
<code class="literal">000010101101</code> means we flipped 4 heads before our first tails and <code class="literal">010101101</code>
means we flipped 1 head before flipping our first tail).  This gives us an idea
how many tries happened before this hash value was gotten.  The mathematics
behind this system is almost equivalent to that of the Morris counter with one
major exception: the “random” values are aquired by looking at the actual input
instead of a random number generator.  This means that if I keep adding the same
value to a loglog counter it’s internal state will not change.</p><div class="example"><a id="id833082"></a><div class="example-title">Example&nbsp;11-24.&nbsp;Simple Implementation of LogLog Register</div><div class="example-contents"><pre class="programlisting"><code class="kn">import</code> <code class="nn">mmh3</code>

<code class="k">def</code> <code class="nf">trailing_zeros</code><code class="p">(</code><code class="n">number</code><code class="p">):</code>
    <code class="sd">"""</code>
<code class="sd">    Returns the index of the first bit set to 1 from the right side of a 32bit</code>
<code class="sd">    integer</code>
<code class="sd">    &gt;&gt;&gt; trailing_zeros(0)</code>
<code class="sd">    32</code>
<code class="sd">    &gt;&gt;&gt; trailing_zeros(0b1000)</code>
<code class="sd">    3</code>
<code class="sd">    &gt;&gt;&gt; trailing_zeros(0b10000000)</code>
<code class="sd">    7</code>
<code class="sd">    """</code>
    <code class="k">if</code> <code class="ow">not</code> <code class="n">number</code><code class="p">:</code>
        <code class="k">return</code> <code class="mi">32</code>
    <code class="n">index</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">while</code> <code class="p">(</code><code class="n">number</code> <code class="o">&gt;&gt;</code> <code class="n">index</code><code class="p">)</code> <code class="o">&amp;</code> <code class="mi">1</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
        <code class="n">index</code> <code class="o">+=</code> <code class="mi">1</code>
    <code class="k">return</code> <code class="n">index</code>

<code class="k">class</code> <code class="nc">LogLogRegister</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="n">counter</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">item</code><code class="p">):</code>
        <code class="n">item_hash</code> <code class="o">=</code> <code class="n">mmh3</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">item</code><code class="p">))</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">_add</code><code class="p">(</code><code class="n">item_hash</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">_add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">item_hash</code><code class="p">):</code>
        <code class="n">bit_index</code> <code class="o">=</code> <code class="n">trailing_zeros</code><code class="p">(</code><code class="n">item_hash</code><code class="p">)</code>
        <code class="k">if</code> <code class="n">bit_index</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">counter</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">counter</code> <code class="o">=</code> <code class="n">bit_index</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="mi">2</code><code class="o">**</code><code class="bp">self</code><code class="o">.</code><code class="n">counter</code></pre></div></div><p>The biggest drawback of this method is that we may get a hash value that
increases the counter right at the beginning and skew our estimates.  This would
be similar to flipping all 32 tails on the first try.  In order to remedy this,
we should have many people flipping coins at the same time and combine their
results.  The law of large numbers tells us that as we add more and more
flippers the total statistics become less effected by anomalous samples from
individual flipper.  The exact way that we combine the results is the root of
the difference between loglog type methods (classic loglog, superloglog,
hyperloglog, hyperloglog++, etc.).</p><p>This “multiple flipper” method can be accomplished by taking the first couple
bits of a hash value and using that to designate which of our flippers had that
particular result.  If we take the first 4 bits of the hash, this means we have
<code class="literal">2^4 = 16</code> flippers.  Since we used the first 4 bits for this selection, we only
have 28bits left (corresponding to 28 individual coin flips per coin flipper)
meaning each counter can only count up to <code class="literal">2^28 = 268,435,456</code>.  In addition,
there is a constant (alpha) which depends on the number of flippers there are
which normalizes the estimation. <sup>[<a id="id833712" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id833712" class="footnote">137</a>]</sup>  All of this together
gives us an algorithm with <span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1105.png" alt="" width="104" height="29" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1105.png"></span> accuracy where <code class="literal">m</code> is the
number of registers (or flippers) used.</p><div class="example"><a id="id833102"></a><div class="example-title">Example&nbsp;11-25.&nbsp;Simple Implementation of LogLog</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">llregister</code> <code class="kn">import</code> <code class="n">LLRegister</code>
<code class="kn">import</code> <code class="nn">mmh3</code>

<code class="k">class</code> <code class="nc">LL</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">p</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">p</code> <code class="o">=</code> <code class="n">p</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">=</code> <code class="mi">2</code><code class="o">**</code><code class="n">p</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">registers</code> <code class="o">=</code> <code class="p">[</code><code class="n">LLRegister</code><code class="p">()</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="nb">int</code><code class="p">(</code><code class="mi">2</code><code class="o">**</code><code class="n">p</code><code class="p">))]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">alpha</code> <code class="o">=</code> <code class="mf">0.7213</code> <code class="o">/</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">+</code> <code class="mf">1.079</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">add</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">item</code><code class="p">):</code>
        <code class="n">item_hash</code> <code class="o">=</code> <code class="n">mmh3</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">item</code><code class="p">))</code>
        <code class="n">register_index</code> <code class="o">=</code> <code class="n">item_hash</code> <code class="o">&amp;</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code>
        <code class="n">register_hash</code> <code class="o">=</code> <code class="n">item_hash</code> <code class="o">&gt;&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">p</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">registers</code><code class="p">[</code><code class="n">register_index</code><code class="p">]</code><code class="o">.</code><code class="n">_add</code><code class="p">(</code><code class="n">register_hash</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">register_sum</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="n">h</code><code class="o">.</code><code class="n">counter</code> <code class="k">for</code> <code class="n">h</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">registers</code><code class="p">)</code>
        <code class="k">return</code> <code class="mi">2</code> <code class="o">**</code> <code class="p">(</code><code class="nb">float</code><code class="p">(</code><code class="n">register_sum</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code><code class="p">)</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">alpha</code></pre></div></div><p>In addition to this algorithm de-duplicating similar items by using the hash
value as an indicator, it has a tunable parameter which can be used to dial what
sort of accuracy vs storage compromise you are willing to make.</p><p>We can see in the <code class="literal">__len__</code> method, we are averaging the estimates from all of
the individual LogLog registers.  This, however, is not the most efficient way
do combine the data!  This is because we may get some unfortunate hash values
that make one particular register spike up while the others are still at low
values.  Because of this, we are only able to and error rate of
<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1106.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1106.png"></span> where m is the number of registers used.</p><p>A fix to this problem was called SuperLogLog <sup>[<a id="id834589" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id834589" epub:type="noteref" class="footnote">138</a>]</sup>.  With this algorithm, only the lowest 70% of
the registers were used for the size estimate and their value was limited by a
maximum value given by a restriction rule.  This addition decreased the error
rate to <span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1107.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1107.png"></span>.  This is counter intuitive since
we got a better estimate by disregarding information!</p><p>Finally, HyperLogLog <sup>[<a id="id834592" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id834592" epub:type="noteref" class="footnote">139</a>]</sup> came out in 2007 and gave us further accuracy
gains.  This was done simply by changing the method of averaging the individual
registers: instead of simply averaging we use a spherical averaging scheme which
also has special considerations for different edge cases the structure could be
in.  This brings us to the current best error rate of
<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1108.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1108.png"></span>.  In addition, this formulation removes a
sorting operation which is necissary with SuperLogLog.  This can greatly speed
up the performance of the data structure when trying to insert items at a high
volume.</p><div class="example"><a id="id834638"></a><div class="example-title">Example&nbsp;11-26.&nbsp;Simple Implementation of HyperLogLog</div><div class="example-contents"><pre class="programlisting"><code class="kn">from</code> <code class="nn">ll</code> <code class="kn">import</code> <code class="n">LL</code>
<code class="kn">import</code> <code class="nn">math</code>

<code class="k">class</code> <code class="nc">HyperLogLog</code><code class="p">(</code><code class="n">LL</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">__len__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">indicator</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="mi">2</code><code class="o">**-</code><code class="n">m</code><code class="o">.</code><code class="n">counter</code> <code class="k">for</code> <code class="n">m</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">registers</code><code class="p">)</code>
        <code class="n">E</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">alpha</code> <code class="o">*</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code><code class="o">**</code><code class="mi">2</code><code class="p">)</code> <code class="o">/</code> <code class="nb">float</code><code class="p">(</code><code class="n">indicator</code><code class="p">)</code>

        <code class="k">if</code> <code class="n">E</code> <code class="o">&lt;=</code> <code class="mf">5.0</code> <code class="o">/</code> <code class="mf">2.0</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code><code class="p">:</code>
            <code class="n">V</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="mi">1</code> <code class="k">for</code> <code class="n">m</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">registers</code> <code class="k">if</code> <code class="n">m</code><code class="o">.</code><code class="n">counter</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code>
            <code class="k">if</code> <code class="n">V</code> <code class="o">!=</code> <code class="mi">0</code><code class="p">:</code>
                <code class="n">Estar</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">num_registers</code> <code class="o">/</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">*</code> <code class="n">V</code><code class="p">),</code> <code class="mi">2</code><code class="p">)</code>
            <code class="k">else</code><code class="p">:</code>
                <code class="n">Estar</code> <code class="o">=</code> <code class="n">E</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">if</code> <code class="n">E</code> <code class="o">&lt;=</code> <code class="mi">2</code><code class="o">**</code><code class="mi">32</code> <code class="o">/</code> <code class="mf">30.0</code><code class="p">:</code>
                <code class="n">Estar</code> <code class="o">=</code> <code class="n">E</code>
            <code class="k">else</code><code class="p">:</code>
                <code class="n">Estar</code> <code class="o">=</code> <code class="o">-</code><code class="mi">2</code><code class="o">**</code><code class="mi">32</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="n">E</code> <code class="o">/</code> <code class="mi">2</code><code class="o">**</code><code class="mi">32</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">Estar</code>

<code class="k">if</code> <code class="n">__name__</code> <code class="o">==</code> <code class="s">"__main__"</code><code class="p">:</code>
    <code class="kn">import</code> <code class="nn">mmh3</code>
    <code class="n">hll</code> <code class="o">=</code> <code class="n">HyperLogLog</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">xrange</code><code class="p">(</code><code class="mi">100000</code><code class="p">):</code>
        <code class="n">hll</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">mmh3</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">)))</code>
    <code class="k">print</code> <code class="nb">len</code><code class="p">(</code><code class="n">hll</code><code class="p">)</code></pre></div></div><p>The only further increase in accuracy was given by the HyperLogLog++ algorithm
which increased accuracy of the data structure while it is relatively empty.
When more items are inserted, this scheme reverts to standard HyperLogLog.  This
is actually quite a useful thing to have since the statistics of the LogLog type
counters requires a lot of data to be accurate—having a scheme for allowing
better accuracy with less number of items greatly improves the usability of this
method.  This extra accuracy is achieved by having a smaller but more accurate
HyperLogLog structure that can be later converted into the larger structure that
was originally requested.  Also, there are some imperially derived constants
that are used in the size estimates which remove biases.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title" id="_real_world_example">Real World Example</h3></div></div></div><p>For a better understanding of the data structures, we first created a dataset
with many unique keys and then one that has duplicate entries.
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#FIG-prob-ds-comparison">Example&nbsp;11-27</a> shows the results when we feed these keys into the
data structures above and periodically query “How many unique entries have there
been?”.  We can see that the data structures that contain more stateful variables
(such as HyperLogLog and KMin Values) do better since they more robustly handle
bad statistics.  On the other hand, the Morris Counter and the single LogLog
register can quickly have very high error if one unfortunate random number or
hash value occurs.  For most of the algorithms, however, we know that the number
of stateful variables is directly correlated with the error guarantees, so this
makes sense.</p><div class="example"><a id="FIG-prob-ds-comparison"></a><div class="example-title">Example&nbsp;11-27.&nbsp;Comparison between various probabilistic data structures for unique (above) and repeating data (below)</div><div class="example-contents"><div class="informalfigure"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/prod_ds_unique.png" alt="PDS with unique data" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/prod_ds_unique.png"></div></div><div class="informalfigure"><div class="mediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/figures/prod_ds_dup.png" alt="PDS with repeating data" width="1000" height="727" data-mfp-src="/library/view/high-performance-python/9781449361747/figures/prod_ds_dup.png"></div></div></div></div><p>Looking just at the probabilistic data structures that have the best performance
(and really the ones you will probably use), we can summarize their utility and
their approximate memory usage (see <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_pd_comparison">Example&nbsp;11-28</a>).  We can see a
huge change in memory usage depending on the questions we care to ask.  This
simply highlights the fact that when using a probabilistic data structure, you
must first consider what questions you really need to answer about the dataset
before proceeding.  Also note that only the Bloom Filter’s size depends on the
number of elements.  The HyperLogLog and KMin Values’s size is <span class="emphasis"><em>only</em></span> dependant
on the error rate.</p><div class="example"><a id="memory_pd_comparison"></a><div class="example-title">Example&nbsp;11-28.&nbsp;Comparison of major probabilistic data structures</div><div class="example-contents"><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">              </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Size </td><td style="border-bottom: 0.5pt solid ; "> Union <sup>[<a id="id835832" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id835832" class="footnote totri-footnote">a</a>]</sup> </td></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Intersection</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Contains</p></td><td style="border-bottom: 0.5pt solid ; "><p>Size <sup>[<a id="id835859" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id835859" class="footnote totri-footnote">b</a>]</sup></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HyperLogLog</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Yes (<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1109.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1109.png"></span>)</p></td><td style="border-bottom: 0.5pt solid ; "><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>No <sup>[<a id="memory_caveat" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.memory_caveat" class="footnote totri-footnote">c</a>]</sup></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>No</p></td><td style="border-bottom: 0.5pt solid ; "><p>2.704 MB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>KMinValues</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Yes (<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1110.png" alt="" width="98" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1110.png"></span>)</p></td><td style="border-bottom: 0.5pt solid ; "><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Yes</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>No</p></td><td style="border-bottom: 0.5pt solid ; "><p>20.372 MB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Bloom Filter</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Yes (<span class="inlinemediaobject"><img src="https://www.safaribooksonline.com/library/view/high-performance-python/9781449361747/inleq_1111.png" alt="" width="63" height="30" data-mfp-src="/library/view/high-performance-python/9781449361747/inleq_1111.png"></span>)</p></td><td style="border-bottom: 0.5pt solid ; "><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p>No <sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.memory_caveat" class="footnoteref totri-footnote">c</a>]</sup></p></td><td style="border-right: 0.5pt solid ; "><p>Yes</p></td><td><p>197.8 MB</p></td></tr></tbody><tbody class="footnotes"><tr><td colspan="3"><div class="footnote" id="ftn.id835832"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id835832" class="simpara totri-footnote">a</a>] </sup>Union operations occur without a penalty
to error</p></div><div class="footnote" id="ftn.id835859"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id835859" class="simpara totri-footnote">b</a>] </sup>Size of data structure with 0.05% error rate, 100,000,000 unique elements and using a 64 bit hashing function</p></div><div class="footnote" id="ftn.memory_caveat"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_caveat" class="simpara totri-footnote">c</a>] </sup>These operations <span class="emphasis"><em>can</em></span> be done however at a considerable penalty in accuracy</p></div></td></tr></tbody></table></div></div></div><p>As another, more realistic test, we chose to use a dataset derived from the text
of wikipedia.  We ran a very simple script in order to extract all single word
tokens with 5 or more characters from all articles and store them in a newline
separated file.  The question then was, “How many unique tokens are there?” and
the results can be seen in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_pd_wiki_comparison">Example&nbsp;11-29</a>.  In addition, we attempted
to answer the same question using the datrie from <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_datrie">datrie</a> (this trie
was chosen as opposed to the others because it offers good compression while
still being robust enough to deal with the entire dataset).</p><div class="example"><a id="memory_pd_wiki_comparison"></a><div class="example-title">Example&nbsp;11-29.&nbsp;Size estimates for the number of unique words in wikipedia</div><div class="example-contents"><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"></colgroup><thead><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">                  </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Elements   </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Relative Error </td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Processing Time <sup>[<a id="id836122" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836122" class="footnote totri-footnote">a</a>]</sup> </td><td style="border-bottom: 0.5pt solid ; "> Structure Size <sup>[<a id="id836131" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836131" class="footnote totri-footnote">b</a>]</sup>
 </td></tr></thead><tfoot><tr><td style="border-right: 0.5pt solid ; "><p>True Value</p></td><td style="border-right: 0.5pt solid ; "><p>4,956,262</p></td><td style="border-right: 0.5pt solid ; "><p>0.00%</p></td><td style="border-right: 0.5pt solid ; "><p>-----</p></td><td><p>49,558 KB <sup>[<a id="id836172" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836172" class="footnote totri-footnote">c</a>]</sup></p></td></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Morris Counter <sup>[<a id="id836189" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836189" class="footnote totri-footnote">d</a>]</sup></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1,073,741,824</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>6.52%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>751s</p></td><td style="border-bottom: 0.5pt solid ; "><p>5 bits</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Log Log Register</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1,048,576</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>78.84%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>1690 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>5 bits</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>LogLog</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,522,232</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>8.76%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2112 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>5 bits</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HyperLogLog</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,983,171</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>-0.54%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>2907 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>40 KB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>KMinValues</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,912,818</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.88%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>3503 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>256 KB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>ScalingBloom</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,949,358</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.14%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>10392 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>11,509 KB</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Datrie</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>4,505,514 <sup>[<a id="id836363" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#ftn.id836363" class="footnote totri-footnote">e</a>]</sup></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>0.00%</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>14620 s</p></td><td style="border-bottom: 0.5pt solid ; "><p>114,068 KB</p></td></tr></tbody><tbody class="footnotes"><tr><td colspan="5"><div class="footnote" id="ftn.id836122"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836122" class="simpara totri-footnote">a</a>] </sup>Processing time has been adjusted to remove the time to read the dataset from disk. We also use the simple implemintations provided above for testing</p></div><div class="footnote" id="ftn.id836131"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836131" class="simpara totri-footnote">b</a>] </sup>Structure size is theoretical given the amount of data since the implementations used were not optimized</p></div><div class="footnote" id="ftn.id836172"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836172" class="simpara totri-footnote">c</a>] </sup>The dataset is 49,558 KB only considering unique tokens with 8.742GB total tokens</p></div><div class="footnote" id="ftn.id836189"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836189" class="simpara totri-footnote">d</a>] </sup>Since the Morris counter doesn’t de-duplicate input the size and relative error are given with regards to the total number of values</p></div><div class="footnote" id="ftn.id836363"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id836363" class="simpara totri-footnote">e</a>] </sup>Because of some encoding problems, Datrie could not load all the keys.</p></div></td></tr></tbody></table></div></div></div><p>The major take-away from this experiment is that if you are able to specialize
your code then you can get amazing speed and memory gains.  This has been true
throughout the entire book: when we specialized our code in
<a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch06.html#matrix_selective_optimizations">Selective optimizations: finding what needs to be fixed</a> we were able to similarly get speed
increases.</p><p>Probabilistic data structures are an algorithmic way of specializing your code.
We store only the data we need in order to answer specific questions with given
error bounds.  By only having to deal with a subset of the information given,
not only can the memory footprint be much smaller but we can also perform most
operations over the structure faster (as can be seen with the insertion time
into the datrie in <a class="xref" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#memory_pd_wiki_comparison">Example&nbsp;11-29</a> being larger than any of the
probabilistic data structures).</p><p>As a result, whether or not you use probabilistic data structures, you should
always keep in mind what questions you are going to be asking of your data and
how you can most effectively store that data in order to ask those specialized
questions.  This may come down to using one particular type of list over
another, one particular type of database index over another, or maybe even using
a probabilistic data structure to throw out all but the relevant data!</p></div></div><div class="footnotes" epub:type="footnotes"><br><hr style="width: 100; align: left;"><div class="footnote" id="ftn.id825207"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id825207" class="simpara">113</a>] </sup><a class="ulink" href="http://code.activestate.com/recipes/546530/" target="_top">http://code.activestate.com/recipes/546530/</a></p></div><div class="footnote" id="ftn.id825696"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id825696" class="simpara">114</a>] </sup><a class="ulink" href="http://nedbatchelder.com/text/unipain.html" target="_top">http://nedbatchelder.com/text/unipain.html</a></p></div><div class="footnote" id="ftn.id825718"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id825718" class="simpara">115</a>] </sup><a class="ulink" href="http://www.python.org/dev/peps/pep-0393/" target="_top">http://www.python.org/dev/peps/pep-0393/</a></p></div><div class="footnote" id="ftn.id826005"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826005" class="simpara">116</a>] </sup><a class="ulink" href="https://docs.python.org/2/library/bisect.html#searching-sorted-lists" target="_top">https://docs.python.org/2/library/bisect.html#searching-sorted-lists</a></p></div><div class="footnote" id="ftn.id826195"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826195" class="simpara">117</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/File:Trie-vs-minimal-acyclic-fa.svg" target="_top">http://en.wikipedia.org/wiki/File:Trie-vs-minimal-acyclic-fa.svg</a></p></div><div class="footnote" id="ftn.id826211"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826211" class="simpara">118</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Deterministic_acyclic_finite_state_automaton" target="_top">http://en.wikipedia.org/wiki/Deterministic_acyclic_finite_state_automaton</a></p></div><div class="footnote" id="ftn.id826283"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826283" class="simpara">119</a>] </sup><a class="ulink" href="https://github.com/kmike/DAWG" target="_top">https://github.com/kmike/DAWG</a></p></div><div class="footnote" id="ftn.id826372"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826372" class="simpara">120</a>] </sup><a class="ulink" href="https://github.com/kmike/marisa-trie" target="_top">https://github.com/kmike/marisa-trie</a></p></div><div class="footnote" id="ftn.id826390"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826390" class="simpara">121</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Trie" target="_top">http://en.wikipedia.org/wiki/Trie</a></p></div><div class="footnote" id="ftn.id826451"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826451" class="simpara">122</a>] </sup><a class="ulink" href="https://github.com/kmike/datrie" target="_top">https://github.com/kmike/datrie</a></p></div><div class="footnote" id="ftn.id826522"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826522" class="simpara">123</a>] </sup><a class="ulink" href="https://github.com/kmike/hat-trie" target="_top">https://github.com/kmike/hat-trie</a></p></div><div class="footnote" id="ftn.id826713"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826713" class="simpara">124</a>] </sup><a class="ulink" href="https://docs.python.org/2/library/mmap.html" target="_top">https://docs.python.org/2/library/mmap.html</a></p></div><div class="footnote" id="ftn.id826754"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826754" class="simpara">125</a>] </sup><a class="ulink" href="https://pypi.python.org/pypi/bitarray/0.8.1" target="_top">https://pypi.python.org/pypi/bitarray/0.8.1</a></p></div><div class="footnote" id="ftn.id826795"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826795" class="simpara">126</a>] </sup><a class="ulink" href="http://micropython.org/" target="_top">http://micropython.org/</a></p></div><div class="footnote" id="ftn.id826919"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id826919" class="simpara">127</a>] </sup>These numbers come from the 66-95-99
rule of Gaussian distributions.  More information can be found at
<a class="ulink" href="http://en.wikipedia.org/wiki/68%E2%80%9395%E2%80%9399.7_rule" target="_top">http://en.wikipedia.org/wiki/68%E2%80%9395%E2%80%9399.7_rule</a></p></div><div class="footnote" id="ftn.id827216"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id827216" class="simpara">128</a>] </sup>A more fully fleshed out implementation which uses an <code class="literal">array</code> of bytes
to make many counters is available at
<a class="ulink" href="https://github.com/ianozsvald/morris_counter" target="_top">https://github.com/ianozsvald/morris_counter</a></p></div><div class="footnote" id="ftn.id827315"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id827315" class="simpara">129</a>] </sup><a class="ulink" href="http://geomblog.blogspot.co.uk/2011/06/bob-morris-and-stream-algorithms.html" target="_top">http://geomblog.blogspot.co.uk/2011/06/bob-morris-and-stream-algorithms.html</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id827328"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id827328" class="simpara">130</a>] </sup>Beyer, K., Haas, P. J., Reinwald, B.,
Sismanis, Y., &amp; Gemulla, R. (2007). On synopses for distinct-value estimation
under multiset operations. Proceedings of the 2007 ACM SIGMOD International
Conference on Management of Data - SIGMOD ’07, 199. doi:10.1145/1247480.1247504</p></div><div class="footnote" id="ftn.id828118"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828118" class="simpara">131</a>] </sup><a class="ulink" href="https://github.com/mynameisfiber/countmemaybe" target="_top">https://github.com/mynameisfiber/countmemaybe</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id828152"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828152" class="simpara">132</a>] </sup>Bloom, B. H. (1970). Space/time trade-offs in hash coding with
allowable errors. Communications of the ACM. doi:10.1145/362686.362692</p></div><div class="footnote" id="ftn.id828747"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828747" class="simpara">133</a>] </sup>The wikipedia page on
bloom filters has a very simple proof for the properties of a bloom filter,
<a class="ulink" href="http://en.wikipedia.org/wiki/Bloom_filter#Probability_of_false_positives" target="_top">http://en.wikipedia.org/wiki/Bloom_filter#Probability_of_false_positives</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id828930"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828930" class="simpara">134</a>] </sup>Almeida, P. S., Baquero, C., Preguiça, N., &amp; Hutchison,
D. (2007). Scalable Bloom Filters. Information Processing Letters, 101, 255–261.
doi:10.1016/j.ipl.2006.10.007</p></div><div class="footnote" epub:type="footnote" id="ftn.id828944"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id828944" class="simpara">135</a>] </sup>The error values
actually decrease like the geometric series.  This way, when you take the
product of all the error rates they approach the desired error rate</p></div><div class="footnote" id="ftn.id833007"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id833007" class="simpara">136</a>] </sup><a class="ulink" href="http://algo.inria.fr/flajolet/Publications/DuFl03-LNCS.pdf" target="_top">http://algo.inria.fr/flajolet/Publications/DuFl03-LNCS.pdf</a></p></div><div class="footnote" id="ftn.id833712"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id833712" class="simpara">137</a>] </sup>“A full description of the basic
LogLog and SuperLogLog algorithms can be found at
<a class="ulink" href="http://algo.inria.fr/flajolet/Publications/DuFl03.pdf" target="_top">http://algo.inria.fr/flajolet/Publications/DuFl03.pdf</a></p></div><div class="footnote" epub:type="footnote" id="ftn.id834589"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id834589" class="simpara">138</a>] </sup>Durand, M., &amp; Flajolet,
P. (2003). LogLog Counting of Large Cardinalities. In ESA’2003.
doi:10.1007/978-3-540-39658-1_55</p></div><div class="footnote" epub:type="footnote" id="ftn.id834592"><p><sup>[<a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#id834592" class="simpara">139</a>] </sup>Flajolet, P., &amp; Fusy, É. (2007). HyperLogLog: the
analysis of a near-optimal cardinality estimation algorithm. 2007 Conference on
Analysis of Algorithms, 127–146.</p></div></div></section><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#">
			
				Add Note
			
		</a></li>
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/high-performance-python/9781449361747/ch10.html" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">10. Clusters and Job Queues</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="/site/library/view/high-performance-python/9781449361747/ch12.html" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">12. Lessons from the Field</div>
        </a>
    
  
  </div>


      
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781449361747/chapter/ch11.html" data-for-analytics="9781449361747:ch11.html">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    



        
      </div>
      



  <footer class="pagefoot t-pagefoot">
    <a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" class="icon-up"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://community.safaribooksonline.com/">Feedback</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2016 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>




    

    
    
  

<div class="annotator-notice"></div><div class="font-flyout"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com//library/view/high-performance-python/9781449361747/ch11.html#">Reset</a>
</div>
</div></body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>